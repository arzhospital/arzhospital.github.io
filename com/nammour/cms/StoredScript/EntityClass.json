{
	"Id": "4ce51972e95eaedbf96e0ed08c849bab4dffba47",
	"name": "EntityClass",
	"script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCh0eXBlb2YoJHtzfS5zdWJzdHJpbmcpIT09J3VuZGVmaW5lZCc/JHtzfS5zdWJzdHJpbmcoMCwgMTAwMCk6JHtzfSlgOw0KDQpsZXQgX2RlZiA9IChzLCB2KSA9PiAlPjwlPXMlPiA9IHR5cGVvZig8JT1zJT4pIT09J3VuZGVmaW5lZCc/PCU9cyU+OjwlPXYlPjs8JQ0KDQpsZXQgX2RlZmF1bHRzID0gKG9iaj0ndGhpcycsIF9jPWMpID0+IF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRGVmYXVsdCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKCE8JT1vYmolPi5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JT1vYmolPi48JT1uTmFtZShlYSklPig8JXZhbHVlT2YoZWEuRGVmYXVsdCklPik7DQogICAgICAgICAgICB9DQo8JSB9KTsNCg0KbGV0IGxvZyA9IChuLCBfdGhpcz0ndGhpcycpID0+IGAke190aGlzfS5sb2cobnVsbCwgdW5kZWZpbmVkLCAnJHtuIHx8IG1OYW1lfScsICdFbnRpdHlPYmplY3QnLCAwLCBgOw0KbGV0IHdhcm4gPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMSwgYDsNCmxldCBlcnJvciA9IChuLCBfdGhpcz0ndGhpcycpID0+IGAke190aGlzfS5sb2cobnVsbCwgdW5kZWZpbmVkLCAnJHtuIHx8IG1OYW1lfScsICdFbnRpdHlPYmplY3QnLCAyLCBgOw0KDQpsZXQgcWxUeXBlID0gKGVhLCBiSW5wdXQpID0+IHsNCiAgICBpZihlYS5Jc0Jvb2wpIHJldHVybiAnQm9vbGVhbic7DQogICAgLy9pZihlYS5Jc0RhdGUpIHJldHVybiAnRGF0ZVRpbWUnOw0KICAgIGlmKGVhLklzSW50IHx8IGVhLklzRmxvYXQpIHJldHVybiAnSW50JzsNCiAgICBpZihlYS5FbnRpdHlUeXBlKSByZXR1cm4gbk5hbWUoZWEuRW50aXR5VHlwZSkrKGJJbnB1dD8iSW5wdXQiOiIiKTsNCiAgICByZXR1cm4gJ1N0cmluZyc7DQp9Ow0KDQovLyB3aHkgaGFyZCBjb2RlZD8/Pw0KbGV0IF9yZXN0VG9vbHMgPSBbJ1NlcnZpY2VOb3cnLCAnU2FsZXNGb3JjZScsICdSZXN0REJJTycsICdHaXRIdWInLCAnRmlsZVN5c3RlbSddOw0KbGV0IF9zcWxUb29scyA9IFsnU3FsREInLCAnU2FsZXNGb3JjZScsICdTbm93Rmxha2UnXTsNCmxldCBfZmlsZVRvb2xzID0gWydHaXRIdWInLCAnRmlsZVN5c3RlbSddOw0KDQpsZXQgY2xzVG9vbHMgPSBfYyA9PiBfYy5Ub29scy5tYXAodCA9PiB0LnR5cGU/dC50eXBlLm5hbWU6KHQubmFtZSB8fCB0KSk7DQpsZXQgbWFpbkNsYXNzID0gKF9hclRvb2xzLCBfYz1jKSA9PiBhckNsYXNzZXMuZmluZChfX2MgPT4gKF9hclRvb2xzIHx8IGNsc1Rvb2xzKF9jKSkuZmluZCh0ID0+IGNsc1Rvb2xzKF9fYykuaW5jbHVkZXModCkpKSB8fCAoIShfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmxlbmd0aCAmJiBhckNsYXNzZXNbMF0pOw0KDQpsZXQgX2VhVHlwZXMgPSAoX2M9YywgYkFsbCkgPT4gX0ZyRU1ELl90b0pTKE9iamVjdC5hc3NpZ24oe30sIC4uLl9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgYkFsbD90cnVlOmVhLkVudGl0eVR5cGUpLm1hcChlYSA9PiAoe1tuTmFtZShlYSldOiBuTmFtZShlYS5FbnRpdHlUeXBlKSB8fCBfRnJFTUQuX2F0dHIoZWEpfSkpKSk7DQoNCmxldCBfY0ZpZWxkID0gKGVhLCBfYz1lYS5FbnRpdHlDbGFzcykgPT4gKChlYS5FbnRpdHlUeXBlPyhlYS5FbnRpdHlUeXBlLlR5cGVkQXR0cmlidXRlcy5maW5kKHRhID0+IHRhLkVudGl0eUNsYXNzPT1fYykgfHwgZWEuRW50aXR5Q2xhc3MuRW50aXR5QXR0cmlidXRlcy5maW5kKF9lYSA9PiBfZWEuRW50aXR5VHlwZT09X2MpKTpudWxsKSB8fCB7TmFtZTogIiJ9KS5OYW1lOw0KDQpsZXQgX2NOYW1lID0gKGNuPWMuTmFtZSwgYkFsaWFzKSA9PiB7DQogICAgaWYoY24uTmFtZSkgY24gPSBjbi5OYW1lOw0KICAgIGxldCBfYyA9IGFyQ2xhc3Nlcy5maW5kKGVjID0+IGVjLk5hbWU9PWNuKTsNCiAgICBpZighX2MpIHJldHVybiAnJzsNCiAgICByZXR1cm4gbk5hbWUoX2MsIGJBbGlhcyk7DQp9Ow0KDQpsZXQgYWxpYXMgPSAoY24sIGo9Jy4nKSA9PiAoc2NvcGUgKyAnLicgKyBfY05hbWUoY24sIHRydWUpLnJlcGxhY2UoX2NOYW1lKGNuKSwgJycpKS5zcGxpdCgnLicpLmZpbHRlcihuID0+IG4pLmpvaW4oaik7DQpsZXQgbnNjb3BlID0gYWxpYXMoJ05vZGUnKTsNCg0KbGV0IF92Q29kZSA9IGsgPT4geyU+KDwldmFsdWVPZihrLkNvZGUpJT4gfHwgKCI8JT1uQ29kZShrKSU+IikpPCV9Ow0KbGV0IF9uQ29kZSA9IChlYSwgYlR5cGVkKSA9PiBlYT8oInRoaXMuX25Db2RlKCciICsgbkNvZGUoZWEpICsgKGJUeXBlZD8oJ18nICsgZWEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSk6IiIpICArICInLCAiICsgKGJUeXBlZD9udWxsOl9GckVNRC5fdG9KUyhlYS5Db2RlKSkgKyAiKSIpOiJ0aGlzLl9uQ29kZSgpIjsNCmxldCBtUm91dGluZyA9IChjLCBtKSA9PiB7DQogICAgaWYgKCFjICYmIG0pIGMgPSBtLkVudGl0eUNsYXNzOw0KICAgIGlmICghbSAmJiAhYykgcmV0dXJuICIiOw0KICAgIGlmICghbSkgbSA9IGM7DQogICAgaWYgKCFtLlJvdXRpbmcgJiYgIWMuUm91dGluZykgcmV0dXJuICIiOw0KDQolPihfbm9kZSwgbWV0aG9kKSA9PiB7DQogICAgCWxldCBsb2cgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAwLCAuLi5tc2cpOw0KICAgIAlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JW0/bS5OYW1lOicnJT4iIHx8IG1ldGhvZCwgIlJvdXRlciIsIDEsIC4uLm1zZyk7DQogICAgCWxldCBlcnJvciA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JW0/bS5OYW1lOicnJT4iIHx8IG1ldGhvZCwgIlJvdXRlciIsIDIsIC4uLm1zZyk7DQogICAgCWxldCBvU2NvcGUgPSA8JT1hbGlhcygpJT47DQogICAgCWxldCBwU2NvcGUgPSA8JT1zY29wZSU+Ow0KICAgIAlsZXQgblNjb3BlID0gPCU9bnNjb3BlJT47DQoNCiAgICAgICAgdHJ5ew0KICAgICAgICA8JWZ1bmN0aW9uT2YobS5Sb3V0aW5nKSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICB3YXJuKGV4KTsNCiAgICAgICAgfQ0KfQ0KPCV9Ow0KDQpsZXQgbU5hbWUgPSAnJzsNCg0KbGV0IGZ1bmN0aW9uT2YgPSAoZnVuLCBfdGhpcz0ndGhpcycpID0+IHslPg0KICAgICAgICBsZXQgX19yZXQgPSB1bmRlZmluZWQ7DQogICAgPCUgaWYoZnVuKXslPg0KICAgICAgICA8JSBpZih0eXBlb2YoZnVuKT09PSdvYmplY3QnKXslPg0KICAgICAgICAgICAgPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZig8JT1fdGhpcyU+LlRvb2wgJiYgPCU9X3RoaXMlPi5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgICAgICAgICAgICAgIDwlIGlmKHR5cGVvZihmdW5bdF0pPT09J2Z1bmN0aW9uJyl7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuW3RdJT47DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9KEpTT04uc3RyaW5naWZ5KGZ1blt0XSkgfHwgJyIiJyklPjsNCiAgICAgICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgX19yZXQgPSA8JT1mdW4lPjsNCiAgICAgICAgPCUgfSU+DQogICAgPCUgfSU+DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0nc3RyaW5nJyAmJiBfX3JldC5zdGFydHNXaXRoKCJzKCIpICYmIF9fcmV0LmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgX19yZXQgPSB0aGlzLnJ1blNjcmlwdChfX3JldC5zbGljZSgyLC0xKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYodHlwZW9mKF9fcmV0KT09PSJmdW5jdGlvbiIpew0KICAgICAgICAgICAgX19yZXQgPSBfX3JldCg8JT1fdGhpcyU+KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX19yZXQ7DQo8JX07DQoNCmxldCB2YWx1ZU9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4oKA0KKG9TY29wZSkgPT4gew0KICAgIHRyeXsNCjwlZnVuY3Rpb25PZihmdW4sIF90aGlzKSU+DQogICAgfWNhdGNoKF92T2ZFeCl7DQogICAgICAgIDwlPXdhcm4oKSU+J3ZhbHVlT2YnLCBfdk9mRXgsIDwlPV9GckVNRC5fdG9KUyhmdW4pJT4pOw0KICAgIH0NCn0NCikoPCU9YWxpYXMoKSU+KSk8JX07DQoNCmxldCB1blJlY3Vyc2UgPSAob2JqLCBmdW4sIGZBcmdzPSdhcmd1bWVudHMnLCBzUmV0LCB2YWxpZGl0eT1gdGhpcy5fX2NvbmZpZygndW5SZWN1cnNlLnZhbGlkaXR5JywgMC41KWAsIGlkZikgPT4gew0KICAgIGlkZiA9IGlkZiB8fCBgKHRoaXM/dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpOidJZCcpYDsNCiAgICBmdW4gPSBmdW4gfHwgYCIke21OYW1lfSJgOw0KICAgIHNSZXQgPSBgDQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgIHYuZGF0ZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOw0KICAgICAgICAgICAgICAgIHYucmV1c2VkKys7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgICR7c1JldH0NCiAgICAgICAgfWNhdGNoKHNSZXRfZXgpew0KICAgICAgICAgICAgdGhpcy5sb2cobnVsbCwgdW5kZWZpbmVkLCAke2Z1bn0sICcke21OYW1lfS51blJlY3Vyc2UnLCAxLCAnc1JldCcsIHNSZXRfZXgpOw0KICAgICAgICB9ZmluYWxseXsNCiAgICAgICAgICAgIGlmKHYgJiYgdi5yZXVzZWQ+MSkgcmV0dXJuIHY/di5vYmo6djsNCiAgICAgICAgfQ0KICAgIGA7DQogICAgbGV0IGJEYW5nZXIgPSAoKSA9PiAlPihbIl90b0hhc2giXS5pbmRleE9mKDwlPWZ1biU+KT49MCk8JTsNCiU+DQogICAgICAgIGxldCB2ID0gdW5kZWZpbmVkOw0KICAgICAgICB0cnl7DQogICAgICAgICAgICA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0ID0gPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCB8fCB7fTsNCiAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+YEFib3J0aW5nIGFzIHBlciA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0LiR7PCU9ZnVuJT59YCk7DQogICAgICAgICAgICAgICAgPCU9c1JldCU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGxldCBfaWQgPSBudWxsOw0KICAgICAgICAgICAgaWYodHlwZW9mKDwlPW9iaiU+KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Ik51bGwgaW5wdXQiLCA8JT1vYmolPiwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgICAgIHJldHVybiA8JT1vYmolPjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZig8JT1vYmolPik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICAgICAgX2lkID0gdGhpcy5oYXNoQ29kZSg8JT1vYmolPik7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPls8JT1pZGYlPl07DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihfaWQpPT09J3VuZGVmaW5lZCcgfHwgIV9pZCl7DQogICAgICAgICAgICAgICAgaWYoPCU9b2JqJT4uSWQgJiYgPCU9b2JqJT4uSWQ9PTwlPW9iaiU+LklkKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT4uSWQ7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5JZD09dGhpcy5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5TZXRfT24pew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJ0aGlzLmhhc2hlZF9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKDwlPW9iaiU+LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT4uRW50aXR5Q2xhc3MuSWQgfHwgPCU9b2JqJT4uRW50aXR5Q2xhc3MuTmFtZSB8fCB0aGlzLl90b0hhc2goPCU9ZkFyZ3MlPiwge2RlcHRoOiA8JWJEYW5nZXIoKSU+PzM6dW5kZWZpbmVkfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI8JT1jLklkJT4iIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPikgfHwgIk5VTEwiOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gaWYoIjwlPW5OYW1lKGMpJT4iPT0iVXNlciIgJiYgPCU9ZnVuJT49PSJfdG9TTkZsb3ciKSA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Il9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgDQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UgfHwge307DQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+IHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSB8fCB7fTsNCiAgICAgICAgCQ0KICAgICAgICAgICAgdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdOw0KDQogICAgICAgICAgICBpZih2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwKjwlPXZhbGlkaXR5JT4pKXsNCiAgICAgICAgICAgICAgICBpZigoPCViRGFuZ2VyKCklPj9uZXcgRGF0ZSgwKToodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKS5nZXRUaW1lKCkgPiB2LmRhdGUpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT5gU3Bhd25pbmcgaW4gJHs8JT1mdW4lPn1gLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iU2VsZWN0ZWQgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+LCB2LnJldXNlZCwgPCU9dmFsaWRpdHklPik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iUHVzaGluZyBoYXNoIiwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4pOw0KICAgICAgICAJdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gew0KICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLA0KICAgICAgICAgICAgICAgIGFyZ3M6IEpTT04uc3RyaW5naWZ5KDwlPWZBcmdzJT4pLA0KICAgICAgICAgICAgICAgIG9iajogPCU9b2JqJT4sDQogICAgICAgICAgICAgICAgcmV1c2VkOiAwLA0KICAgICAgICAgICAgICAgIHBhdGg6ICcnLA0KICAgICAgICAgICAgICAgIF9pZCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlLypleHBlcmltZW50YWw6IHJlbW92ZSB0aGlzIGlmIGFsbCBnb2VzIHdyb25nKi8lPg0KICAgICAgICAgICAgPCU9c1JldCU+DQogICAgCX1jYXRjaCh1blJlY0V4KXsNCiAgICAJICAgIGlmKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpew0KICAgIAkgICAgICAgIDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dID0gdHJ1ZTsNCiAgICAJICAgIH0NCiAgICAJICAgIDwlPWVycm9yKGAke21OYW1lfS51blJlY3Vyc2VgKSU+PCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+LCB1blJlY0V4LnRvU3RyaW5nKCkpOw0KICAgIAkgICAgPCU9c1JldCU+DQogICAgCX0NCjwlDQp9Ow0KDQpsZXQgaW52b2tlUnVsZSA9IHIgPT4gew0KJT4NCmF3YWl0IChhc3luYyAoYXV0aE9iaikgPT4gew0KICAgIGxldCBfcnVsZSA9IDwlPV9GckVNRC5fdG9KUyhyKSU+Ow0KICAgIGRlbGV0ZSBfcnVsZS5TY3JpcHQ7DQogICAgLy8gcnVsZVJ1bnMucHVzaChfcnVsZSk7DQogICAgdHJ5ew0KICAgICAgICA8JT1yLlNjcmlwdCU+DQogICAgfWNhdGNoKGV4KXsNCiAgICAgICAgX3J1bGUuRXhjZXB0aW9uID0gZXg7DQogICAgfQ0KfSkoYXV0aE9iaik7DQo8JQ0KfQ0KJT4NCg0KY2xhc3MgPCU9bk5hbWUoYyklPiB7DQogICAgPCU9bU5hbWU9J2NvbnN0cnVjdG9yJyU+KGlkLCB0b29sKSB7DQogICAgICAgIC8vc3VwZXIoaWQsIHRvb2wpOw0KDQogICAgICAgIHRoaXMuU2NvcGUgPSAiPCU9c2NvcGUlPiI7DQogICAgICAgIHRoaXMuRGVidWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5EZWJ1ZyklPjsNCiAgICAgICAgdGhpcy5Db25maWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db25maWcpJT47DQogICAgICAgIHRoaXMuVGVzdCA9IDwlPV9GckVNRC5fdG9KUyhjLlRlc3QpJT47DQogICAgICAgIHRoaXMuVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoYy5Ub29scyklPjsNCiAgICAgICAgdGhpcy5NYXBwaW5ncyA9IDwlPV9GckVNRC5fdG9KUyhjLk1hcHBpbmdzKSU+Ow0KDQogICAgICAgIC8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQ0KICAgICAgICB0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307DQogICAgICAgIHRoaXMuVG9vbCA9IHRvb2w7DQogICAgICAgIHRoaXMuSWQgPSBpZDsNCg0KICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsNCg0KICAgICAgICB0aGlzLkRhdGUgPSBudWxsOw0KDQogICAgICAgIHRoaXMuY2xlYXJfVEhJUygpOw0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcyA9IFtdOw0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KPCUgaWYoTnVtYmVyKGVhLklkKSl7JT4NCiAgICAgICAgICAgICAgICBJZDogIjwlPWVhLklkJT4iLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7TmFtZTogIj0ifSwNCiAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBPUEVSQVRPUlM6IHt9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KTsgJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KCk7DQo8JSB9KTsgJT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZWZhdWx0cyclPigpew0KPCVfZGVmYXVsdHMoKSU+DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IEVudGl0eUNsYXNzJyU+KCl7DQogICAgICAgIGxldCBlYyA9IHsNCjwlIGlmKE51bWJlcihjLklkKSl7JT4NCiAgICAgICAgICAgIElkOiAiPCU9Yy5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgTmFtZTogIjwlPWMuTmFtZSU+IiwNCiAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgIH07DQoNCjwlIGlmKGMuRW50aXR5TW9kdWxlaWQpeyAlPg0KICAgICAgICBlYy5FbnRpdHlNb2R1bGUgPSB7DQogICAgICAgICAgICBJZDogPCU9Yy5FbnRpdHlNb2R1bGVpZCU+DQogICAgICAgIH07DQo8JSB9JT4NCg0KICAgICAgICAvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXINCiAgICAgICAgaWYoIU51bWJlcihlYy5JZCkgJiYgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzKXsNCiAgICAgICAgICAgIGxldCBjaWQgPSA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWU9PWVjLk5hbWUpOw0KICAgICAgICAgICAgaWYoY2lkKSBlYy5JZCA9IGNpZC5JZDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZWM7DQogICAgfQ0KDQoJPCU9bU5hbWU9J2dldCBJZCclPigpIHsNCgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOw0KCX0NCg0KCTwlPW1OYW1lPSdzZXQgSWQnJT4oaWQpIHsNCgkJaWYgKCF0aGlzLlRvb2wpIHsNCgkJCTwlPWxvZygpJT4iRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYodGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXT09aWQpIHJldHVybjsNCgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOw0KCX0NCg0KICAgIDwlPW1OYW1lPSdnZXQgVG9vbCclPigpIHsNCiAgICAgICAgaWYodHlwZW9mKHRoaXMuX19Ub29sKSE9PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7DQogICAgICAgIGxldCBub1Rvb2wgPSB7DQogICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgIHR5cGU6IHtuYW1lOiAnJ30sDQogICAgICAgIH07DQogICAgICAgIGlmKHR5cGVvZig8JT1zY29wZSU+LlRvb2xzKSE9PSJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KDwlPXNjb3BlJT4uVG9vbHMpKXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPiI8JT1zY29wZSU+LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm4gbm9Ub29sOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gKDwlPXNjb3BlJT4uX19sYXN0VG9vbD9bPCU9c2NvcGUlPi5fX2xhc3RUb29sXTpbXSkuY29uY2F0KHRoaXMuVG9vbHMpLmZpbmQodCA9PiAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lPT1fdC5uYW1lKSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpIT09J3VuZGVmaW5lZCcpIHJldCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1yZXQgfHwgdC5uYW1lPT1yZXQubmFtZSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgaWYodGhpcy5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXSwNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH1lbHNlIHJldCA9IG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdzZXQgVG9vbCclPih0b29sKSB7DQogICAgICAgIGlmICh0eXBlb2YodG9vbCk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICBpZih0eXBlb2YodG9vbCk9PT0ic3RyaW5nIil7DQogICAgICAgICAgICB0b29sID0ge25hbWU6IHRvb2x9Ow0KICAgICAgICB9DQogICAgICAgIGlmKHRvb2wuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0eXBlb2YodG9vbC5uYW1lKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICB0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwge25hbWU6IHRvb2wubmFtZX07DQogICAgICAgIA0KICAgICAgICBpZighdG9vbC50eXBlICYmICF0b29sLm5hbWUpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iRW1wdHkgVG9vbCBvYmplY3QiKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCB0ID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7DQogICAgICAgIGlmICghdCkgew0KICAgICAgICAgICAgPCU9bG9nKCklPiJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPXNjb3BlJT4uX19sYXN0VG9vbCA9IHRoaXMuX19Ub29sID0gdDsNCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdUSElTJyU+KHYsIGNvKXsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOw0KICAgICAgICBpZighdikgcmV0dXJuIHRoaXM7DQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICB0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KT09PSdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWU9PXRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZT09dGhpcy5TY29wZSk7DQogICAgICAgIGlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nY2xlYXJfVEhJUyclPigpIHsNCiAgICAgICAgdGhpcy5fVEhJUyA9IFtdOw0KICAgICAgICB0aGlzLl9USElTX2Nvb3AgPSAnJzsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKGVhKSU+KHYsIGNvLCBpZCkgew0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICB2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCI8JT1lYS5OYW1lJT4iKTsNCiAgICAgICAgaWYgKCFldil7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpZCkgZXYuSWQgPSBpZDsNCg0KICAgICAgICBpZiAodHlwZW9mKHYpIT09J3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIC8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXINCg0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgICAgIHYgPSB2Lm1hcChfdiA9PiB7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHYgPSAoX3YgPT4gew0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIF92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nP192OihuZXcgRGF0ZShfdikpOw0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsNCiAgICA8JSB9JT4NCiAgICA8JSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgaWYoaXNOYU4oX3YpKSBfdiA9IDA7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihfdik9PT0nb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7DQogICAgPCUgfSU+DQoNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKF92ICYmICFfdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4idXNpbmcgX3RvRG9jdW1lbnQgZm9yIGludmFsaWQgc2V0dGVyIHZhbHVlIiwgX3YpOw0KICAgICAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoX3YgJiYgX3YuRW50aXR5Q2xhc3MuSWQhPT0nPCU9ZWEuRW50aXR5VHlwZS5JZCU+JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgU2V0dGVyIHZhbHVlIiwgX3YsICI8JT1lYS5FbnRpdHlUeXBlLklkJT4iLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiPCU9ZWEuRW50aXR5VHlwZS5OYW1lJT4iKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSAoKF92ICYmICF0aGlzLklkKSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgfSkodik7DQogICAgPCUgfSU+DQogICAgDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOw0KICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSB2Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgPCUgfSU+DQoNCiAgICAgICAgICAgIGlmKHRydWUgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT4hPXYpew0KICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IDwlPVNldF9PbiU+OyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQ0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJTZXQgYWZ0ZXIiLCB0aGlzLl88JT1uTmFtZShlYSklPj90aGlzLl88JT1uTmFtZShlYSklPi5TZXRfT246bnVsbCwgdj92LlNldF9PbjpudWxsKTsNCiAgICAgICAgICAgICAgICAvKmlmKHYpIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IHYuU2V0X09uOyovDQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gdjsNCiAgICAgICAgICAgIGlmIChjbykgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gY287DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2NsZWFyXycrbk5hbWUoZWEpJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPjsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT4gPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gIiI7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQogICAgLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KPCUgfSk7ICU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT10YS5OYW1lJT5fPCU9dGFOYW1lJT4gKiovDQogICAgPCU9bU5hbWU9bk5hbWUodGEpKydfJyt0YU5hbWUlPih2LCBjbywgYkNsZWFyKSB7DQogICAgICAgIGlmKHR5cGVvZih2KT09PSJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT47DQogICAgICAgIA0KICAgICAgICBpZih2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCE9PSc8JT10YS5FbnRpdHlDbGFzcy5JZCU+JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUhPT0nPCU9dGEuRW50aXR5Q2xhc3MuTmFtZSU+JykgcmV0dXJuIHRoaXM7DQogICAgICAgIA0KICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgDQogICAgICAgIHYgPSB2LmZpbHRlcihfdiA9PiAhdiB8fCBfdi5fPCU9bk5hbWUodGEpJT5fc2V0KS5jb25jYXQodi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll88JT1uTmFtZSh0YSklPl9zZXQpLm1hcChfdiA9PiB7DQogICAgICAgICAgICBpZighX3YuY29uc3RydWN0b3Ipew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5OYW1lKHRhKSU+IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsNCiAgICAgICAgICAgIH1lbHNlIGlmKF92LmNvbnN0cnVjdG9yLm5hbWU9PSJPYmplY3QiKXsNCiAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdikNCiAgICAgICAgICAgICAgICBfdi48JT1uTmFtZSh0YSklPih0aGlzKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gX3Y7DQogICAgICAgICAgICB9ZWxzZSBpZihfdi5jb25zdHJ1Y3Rvci5uYW1lIT0iPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4iKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uTmFtZSh0YSklPiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+Iik7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBfdi48JT1uTmFtZSh0YSklPih0aGlzKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gX3Y7DQogICAgICAgICAgICB9DQogICAgICAgIH0pLmZpbHRlcihfdiA9PiBfdikpOw0KICAgICAgICANCiAgICAgICAgaWYoYkNsZWFyKSB0aGlzLmNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+KCk7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+LnB1c2goLi4udik7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X3NldCA9IDwlPVNldF9PbiU+Ow0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjsNCg0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9zZXQgPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPiA9IG5ldyBBcnJheSgpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9jb29wID0gbnVsbDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4gKiovDQoNCjwlIH0pICU+DQoNCiAgICA8JT1tTmFtZT0nbG9nJyU+KGNsYXNzTmFtZSwgb2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCiAgICAgICAgdHlwZSA9IHR5cGUgfHwgIkVudGl0eU9iamVjdCI7DQogICAgICAgIA0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgb2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCgkJCWxldCBkZWJ1ZyA9IHRoaXMuRGVidWc7DQoJCQlsZXQgbGV2ZWxzID0gWyJpbmZvIiwgIndhcm4iLCAiZXJyb3IiLCAiY3JpdGljYWwiXTsNCg0KCQkJZGVidWcgPSBkZWJ1ZyB8fCBPYmplY3QuZnJvbUVudHJpZXMobmV3IE1hcChsZXZlbHMubWFwKGwgPT4gW2wsICcqJ10pKSk7DQoNCgkJCWxldCBmdW5jdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5sZXZlbHMubWFwKGwgPT4gKHsNCgkJCQlbbF06IGRlYnVnW2xdID8gZGVidWdbbF0uc3BsaXQoJywnKSA6IFtdDQoJCQl9KSkpOw0KDQoJCQlsZXQgY3NzID0gJ2JhY2tncm91bmQ6ICMwMGZmOTk7IGNvbG9yOiAjMDA4MDAwJzsNCgkJCWxldCBmZyA9ICdceDFiWzMybSc7DQoJCQlzd2l0Y2ggKE51bWJlcihsZXZlbCkpIHsNCgkJCQljYXNlIDE6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjZmZmZjAwOyBjb2xvcjogIzAwMDA4MCc7DQoJCQkJCWZnID0gJ1x4MWJbMzNtJzsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAyOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOw0KCQkJCQlmZyA9ICdceDFiWzMxbSc7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2UgMzoNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsNCgkJCQkJZmcgPSAnXHgxYlszMW1bQ1JJVElDQUxdJzsNCgkJCQkJYnJlYWs7DQoJCQl9DQoNCgkJCWlmIChmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLmV2ZXJ5KGYgPT4gIVsnKi4qJywgJyouJyArIG0sICcqJywgbSwgY2xhc3NOYW1lICsgJy4nICsgbSwgY2xhc3NOYW1lICsgJy4qJ10uaW5jbHVkZXMoZikpKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7DQoJCQkJY29uc29sZS5sb2coZmcgKyAiJXNceDFiWzBtIiwgYCR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHtjbGFzc05hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsNCgkJCX0gZWxzZSB7DQoJCQkJY29uc29sZS5sb2coYCVjICR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHtjbGFzc05hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgY3NzLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOw0KCQkJfQ0KCQl9IGNhdGNoIChleCkgew0KCQkJY29uc29sZS5sb2coZXgpOw0KCQl9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nc2V0SW50ZXJ2YWwnJT4oY2xhc3NOYW1lLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3Mpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsNCjwlIH1lbHNleyU+DQoJCXRyeSB7DQogICAgCQlsZXQgZk5hbWUgPSBmdW4udG9TdHJpbmcoKS5zcGxpdCgnKScpWzBdICsgJyknOw0KICAgIAkJdHJ5IHsNCiAgICAJCQkvLyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApOw0KICAgIA0KICAgIAkJCXRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCk7DQogICAgCQkJbGV0IHJldCA9IGF3YWl0IGZ1biguLi5hcmdzLmNvbmNhdChbbmV3IERhdGUoKV0pKTsNCiAgICANCiAgICAJCQk8JT1sb2coKSU+YHtDYWxsOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKSArIGAsIExvb3A6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApICsgJ30nKTsNCiAgICAJCQlpZiAoIXJldCkgew0KICAgIAkJCQk8JT1sb2coKSU+YGRpZCBub3QgcmV0dXJuIHRydWUsIGV4aXRpbmcgbG9vcGVyICgke3RoaXMuX190aW1lKGZOYW1lKX0pYCk7DQogICAgCQkJCXJldHVybjsNCiAgICAJCQl9DQogICAgCQl9IGNhdGNoIChleCkgew0KICAgIAkJCTwlPWVycm9yKCklPnRoaXMuX190aW1lKGZOYW1lKSwgZXgpOw0KICAgIAkJCWNvbnNvbGUudHJhY2UoKTsNCiAgICAJCX0NCiAgICAJCWlmICghTnVtYmVyKG1pbnV0ZXMpKSB7DQogICAgCQkJPCU9bG9nKCklPnRoaXMuX190aW1lKGZOYW1lKSwgIk5vdCByZXBlYXRpbmcuIE1pbnV0ZXMgaXMgIiArIG1pbnV0ZXMpOw0KICAgIAkJCXJldHVybjsNCiAgICAJCX0NCiAgICAJCWF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtaW51dGVzICogNjAgKiAxMDAwKSk7DQogICAgCQlhd2FpdCB0aGlzLjwlPW1OYW1lJT4obnVsbCwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsNCgkJfSBjYXRjaCAoZXgpIHsNCgkJCTwlPWVycm9yKCklPmV4KTsNCgkJfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19leGVjdXRlJyU+KGNsYXNzTmFtZSwgc2NvcGUsIG0sIGZSb3V0ZXIsIGZTY3JpcHQsIG9QYXJhbXMgPSB7fSwgc291cmNlKXsNCgkJdGhpcy5fX3RpbWUoYDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+LiR7bX1gKTsNCgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCgkJc2NvcGUgPSBzY29wZSB8fCA8JT1zY29wZSU+Ow0KCQlzb3VyY2UgPSBzb3VyY2UgfHwgdGhpczsNCg0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgc2NvcGUsIG0sIGZSb3V0ZXIsIGZTY3JpcHQsIG9QYXJhbXMsIHRoaXMpOw0KPCUgfWVsc2V7JT4NCgkJZGVsZXRlIDwlPXNjb3BlJT4uX3VuUmVjdXJzZTsgLy8gZXhwZXJpbWVudGFsDQoJCQ0KICAgIAlsZXQgX19iZWZvcmVSdWxlcyA9IG9QYXJhbXMuX19iZWZvcmVSdWxlcyB8fCBbXTsNCiAgICAJbGV0IF9fYWZ0ZXJSdWxlcyA9IG9QYXJhbXMuX19hZnRlclJ1bGVzIHx8IFtdOw0KICAgIAlkZWxldGUgb1BhcmFtcy5fX2JlZm9yZVJ1bGVzOw0KICAgIAlkZWxldGUgb1BhcmFtcy5fX2FmdGVyUnVsZXM7DQoNCiAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICBsZXQgZXJyb3IgPSAoLi4ucykgPT4gPCU9ZXJyb3IoKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgICAgIA0KICAgICAgICB0cnl7DQogICAgCQlsZXQgbFBhcmFtcyA9IE9iamVjdC5lbnRyaWVzKG9QYXJhbXMpLm1hcCh4ID0+IHhbMV0pOw0KICAgIAkJbGV0IHJlc3VsdHMgPSBbXTsNCiAgICANCiAgICAJCWxldCBub2RlcyA9IFtdOw0KICAgIAkJDQogICAgCQlpZiAoPCU9bnNjb3BlJT4uX25vZGUgJiYgYXdhaXQgZlJvdXRlcig8JT1uc2NvcGUlPi5fbm9kZSwgbSkpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlKTsNCiAgICAJCX0NCiAgICANCiAgICAJCWlmICg8JT1uc2NvcGUlPi5fbm9kZSAmJiA8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50ICYmIGF3YWl0IGZSb3V0ZXIoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCksIG0pKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSk7DQogICAgCQl9DQogICAgDQogICAgCQlmb3IgYXdhaXQgKGNvbnN0IGNuIG9mICg8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnRfTm9kZXMoKTpbXSkpIHsNCiAgICAgICAgICAgICAgICBpZiAoYXdhaXQgZlJvdXRlcihjbiwgbSkpIHsNCiAgICAgICAgICAgICAgICAJbG9nKCdhZGRpbmcgY2hpbGQgbm9kZScsIGNuKTsNCiAgICAgICAgICAgICAgICAJbm9kZXMucHVzaChjbik7DQogICAgICAgICAgICAgICAgfQ0KICAgIAkJfQ0KICAgIA0KICAgIAkJLy8gcmVtb3ZlIGFueSBudWxscw0KICAgIAkJbm9kZXMgPSBub2Rlcy5mbGF0KCkuZmlsdGVyKG4gPT4gbik7DQogICAgCQkNCiAgICAJCWlmICghbm9kZXMubGVuZ3RoKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZSk7DQogICAgCQl9DQogICAgCQkNCiAgICAJCW5vZGVzID0gdGhpcy5fdW5pcXVlKG5vZGVzLCAnX2NvZGUnKTsNCiAgICAJCWxvZygnbm9kZXMubGVuZ3RoJywgbm9kZXMubGVuZ3RoKTsNCg0KICAgIAkJZm9yIGF3YWl0IChjb25zdCBuIG9mIG5vZGVzKSB7DQogICAgCQkJbGV0IG5SZXQgPSBudWxsOw0KICAgIAkJCWxvZyhgJHttfSBAICR7bj8uY29kZSgpIHx8ICdMT0NBTCd9YCk7DQogICAgCQkJaWYgKCFuIHx8IHRoaXMuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUsIG4pKSB7DQogICAgCQkJCS8vIGxvY2FsIHNjcmlwdA0KICAgIAkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19iZWZvcmVSdWxlcykgew0KICAgICAgICAgICAgICAgICAgICAgICAgPCV2YWx1ZU9mKCJyLlNjcmlwdCIpJT4NCiAgICAJCQkJCS8vYXdhaXQgdGhpcy5fU2NyaXB0KGNsYXNzTmFtZSwgci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQmVmb3JlUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsNCiAgICAJCQkJfQ0KDQogICAgCQkJCW5SZXQgPSBhd2FpdCBmU2NyaXB0KCk7DQoNCiAgICAJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYWZ0ZXJSdWxlcykgew0KICAgICAgICAgICAgICAgICAgICAgICAgPCV2YWx1ZU9mKCJyLlNjcmlwdCIpJT4NCiAgICAJCQkJCS8vYXdhaXQgdGhpcy5fU2NyaXB0KGNsYXNzTmFtZSwgci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQWZ0ZXJSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOw0KICAgIAkJCQl9DQogICAgCQkJfSBlbHNlIHsNCiAgICAJCQkJblJldCA9IGF3YWl0IHNvdXJjZS5faW52b2tlTm9kZShuLCBtLCBvUGFyYW1zKTsNCiAgICAJCQl9DQogICAgDQogICAgCQkJcmVzdWx0cy5wdXNoKHsNCiAgICAJCQkJbm9kZTogbiwNCiAgICAJCQkJcmV0OiBuUmV0DQogICAgCQkJfSk7DQogICAgCQl9DQogICAgCQlsb2cocmVzdWx0cywgIl9leGVjdXRlIiwgJ1Jlc3VsdHMnKTsNCiAgICANCiAgICAJCWxldCBlcnJvcnMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIucmV0ICYmIHIucmV0Ll9fZXhjZXB0aW9uKS5tYXAociA9PiAoew0KICAgIAkJCW5vZGU6IHIubm9kZSA/IHsNCiAgICAJCQkJY29kZTogci5ub2RlLmNvZGUoKSwNCiAgICAJCQkJYWRkcmVzczogci5ub2RlLmFkZHJlc3MoKQ0KICAgIAkJCX0gOiBudWxsLA0KICAgIAkJCV9fZXhjZXB0aW9uOiByLnJldC5fX2V4Y2VwdGlvbg0KICAgIAkJfSkpOw0KDQogICAgCQlpZiAoZXJyb3JzLmxlbmd0aCkgew0KICAgIAkJCXdhcm4oImVycm9ycyIsIGVycm9ycyk7DQogICAgCQl9DQogICAgDQogICAgCQlyZXR1cm4gcmVzdWx0czsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIGVycm9yKGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19TY3JpcHQnJT4oY2xhc3NOYW1lLCBzY3JpcHQsIG0sIHR5cGUsIHNjb3BlLCBfbm9kZSwgLi4uc2ZBcmdzKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCiAgICAgICAgc2NvcGUgPSBzY29wZSB8fCA8JT1zY29wZSU+Ow0KICAgICAgICANCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIF9ub2RlLCAuLi5zZkFyZ3MpOw0KPCUgfWVsc2V7JT4NCiAgICAJaWYgKHR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgIAkNCiAgICAgICAgdHJ5ew0KICAgIAkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnc3RyaW5nJykgc2NyaXB0ID0gdGhpcy5ydW5TY3JpcHQoYCgpID0+IHske3NjcmlwdH19YCk7DQogICAgDQogICAgCQlsZXQgcmV0ID0gbnVsbDsNCiAgICAJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgew0KICAgIAkJCXJldCA9IGF3YWl0IHNjcmlwdCgpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBtLCB0eXBlLCBzY3JpcHQsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KDQogICAgPCU9bU5hbWU9J19zYW1lRW50aXR5JyU+KC4uLmFyRW50aXRpZXMpew0KICAgICAgICBpZihhckVudGl0aWVzLmxlbmd0aD09MCkgcmV0dXJuIGZhbHNlOw0KICAgICAgICBpZihhckVudGl0aWVzLmxlbmd0aD09MSkgYXJFbnRpdGllcy5wdXNoKHRoaXMpOw0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KC4uLmFyRW50aXRpZXMpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIGFyRW50aXRpZXMuc2xpY2UoMSkuZXZlcnkoZSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IHYgPSBhckVudGl0aWVzWzBdOw0KICAgICAgICAgICAgICAgIGxldCBuZWdUZXN0ID0gew0KICAgICAgICAgICAgICAgICAgICB2TnVsbDogdj09bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgZU51bGw6IGU9PW51bGwsDQogICAgICAgICAgICAgICAgICAgIHZPYmplY3Q6IHR5cGVvZih2KSE9PSdvYmplY3QnLA0KICAgICAgICAgICAgICAgICAgICBlT2JqZWN0OiB0eXBlb2YoZSkhPT0nb2JqZWN0JywNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4xLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICBpZihPYmplY3Qua2V5cyhPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3Qua2V5cyhuZWdUZXN0KS5maWx0ZXIoayA9PiBuZWdUZXN0W2tdKS5tYXAoayA9PiAoe3YsIGUsIFtrXTogdHJ1ZX0pKSkpLmxlbmd0aCkgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIC8vIHBhc3NlZCBpbml0aWFsIGNvbnNpc3RlbmN5IGNoZWNrDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodj09ZSkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbmVnVGVzdCA9IHsNCiAgICAgICAgICAgICAgICAgICAgZXZDb25zdHI6IHYuY29uc3RydWN0b3IubmFtZSE9ZS5jb25zdHJ1Y3Rvci5uYW1lLA0KICAgICAgICAgICAgICAgICAgICBlRW50aXR5OiAhZS5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgICAgICAgICAgdkVudGl0eTogIXYuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICAgICAgICAgIGV2RW50aXR5TmFtZXM6IHR5cGVvZihlLkVudGl0eUNsYXNzLk5hbWUpIT09J3VuZGVmaW5lZCcgJiYgZS5FbnRpdHlDbGFzcy5OYW1lIT12LkVudGl0eUNsYXNzLk5hbWUsDQogICAgICAgICAgICAgICAgICAgIGV2RW50aXR5SWRzOiB0eXBlb2YoZS5FbnRpdHlDbGFzcy5JZCkhPT0ndW5kZWZpbmVkJyAmJiBlLkVudGl0eUNsYXNzLklkIT12LkVudGl0eUNsYXNzLklkLA0KICAgICAgICAgICAgICAgICAgICBldklEczogdi5JZD09di5JZCAmJiBlLklkPT1lLklkICYmIHYuSWQhPWUuSWQsDQogICAgICAgICAgICAgICAgICAgIGV2SGFzaDogdi5fdG9IYXNoKG51bGwsIHtvbmx5VW5pcXVlOiB0cnVlfSwgJzwlPW1OYW1lJT4nKSE9ZS5fdG9IYXNoKG51bGwsIHtvbmx5VW5pcXVlOiB0cnVlfSwgJzwlPW1OYW1lJT4nKSwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4yLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICBuZWdUZXN0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmtleXMobmVnVGVzdCkuZmlsdGVyKGsgPT4gbmVnVGVzdFtrXSkubWFwKGsgPT4gKHt2LCBlLCBba106IHRydWV9KSkpOw0KICAgICAgICAgICAgICAgIGlmKCFPYmplY3Qua2V5cyhuZWdUZXN0KS5sZW5ndGgpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4zLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2dldCBTZXRfT24nJT4oKSB7DQogICAgICAgIGxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0LA0KPCUgfSklPg0KICAgICAgICApKTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBTZXRfQ291bnQnJT4oKSB7DQogICAgICAgIHJldHVybiBbDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCwNCjwlIH0pJT4NCiAgICAgICAgXS5maWx0ZXIocyA9PiBzKS5sZW5ndGg7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmxhdHRlbiclPihkZXB0aCl7DQogICAgICAgIDwlPXdhcm4oKSU+IkRFUFJFQ0FURUQiKTsNCiAgICAgICAgbGV0IHJldCA9IHt9Ow0KICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICByZXQuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXQuPCU9bk5hbWUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGRlcHRoLTEpPCV9JT46dGhpcy48JT1uTmFtZShlYSklPigpOw0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgIHJldC48JT10YU5hbWUlPiA9IHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodCA9PiB0P3QuPCU9bU5hbWUlPihkZXB0aC0xKTp0KTsNCjwlIH0pJT4NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0hhc2gnJT4oYXJncywgb3B0aW9ucywgZlNvdXJjZSl7DQogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgICAgICANCiAgICAgICAgbGV0IG9IYXNoID0gew0KICAgICAgICAgICAgY2xhc3M6ICI8JT1uTmFtZShjKSU+IiwNCiAgICAgICAgICAgIHNvdXJjZTogZlNvdXJjZSwNCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MsDQogICAgICAgICAgICBfdGhpczoge30NCiAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgIGlmKCFvcHRpb25zLm5vVGhpcyAmJiBmU291cmNlIT0iPCU9bU5hbWUlPiIgJiYgKHR5cGVvZihvcHRpb25zLmRlcHRoKT09PSd1bmRlZmluZWQnIHx8IC0tb3B0aW9ucy5kZXB0aD4wKSl7DQogICAgICAgICAgICB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7DQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiAhb3B0aW9ucy5ub09wZXJhdG9ycywNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLl9tYXAsDQogICAgICAgICAgICAgICAgVW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWUsDQogICAgICAgICAgICAgICAgTnVsbDogIW9wdGlvbnMub25seVVuaXF1ZSwgLy8/Pw0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+aWYob3B0aW9ucy5ub1R5cGVzKSByZXR1cm47PCV9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSA8JSBpZihlYS5FbnRpdHlUeXBlKXslPnY/di48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpOjwlfSU+djsNCiAgICAgICAgICAgICAgICB9LA0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IF92LjwlPW1OYW1lJT4obnVsbCwgb3B0aW9ucywgZlNvdXJjZSkpLA0KPCUgfSklPg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmpbZWZDb2RlXSA9IHYsDQo8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZihvcHRpb25zLm5vQXJncykgb0hhc2ggPSBvSGFzaC5fdGhpczsNCiAgICAgICAgcmV0dXJuIG9wdGlvbnMubm9Db2RlP29IYXNoOnRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2F1dGhvcml6ZSclPih1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpew0KPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgITwlPXNjb3BlJT4uX190b2tlbiAmJiB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udXNlcm5hbWUnXSl7DQogICAgICAgICAgICB1c2VybmFtZSA9IHRoaXMuVGVzdFsnPCU9bU5hbWUlPi51c2VybmFtZSddOw0KICAgICAgICAgICAgcGFzc3dvcmQgPSB0aGlzLlRlc3RbJzwlPW1OYW1lJT4ucGFzc3dvcmQnXTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmKGJTZXJ2ZXIpew0KICAgICAgICAgICAgaWYodXNlcm5hbWUgJiYgITwlPXNjb3BlJT4uX3Rlc3RVc2VyICYmIHRoaXMuVGVzdFsnPCU9bU5hbWUlPi50ZXN0VXNlciddKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll90ZXN0VXNlciA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHRoaXMuVGVzdFsnPCU9bU5hbWUlPi50ZXN0VXNlciddKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLnN0b3JlKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy51c2VybmFtZSh1c2VybmFtZSwgJz0nKS5wYXNzd29yZChwYXNzd29yZCwgJz0nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5maW5kKCk7DQogICAgICAgICAgICA8JT1sb2coKSU+IlNlcnZlcjogIiArIGJTZXJ2ZXIrIiwgT2JqOiIsIHJldCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHJldCl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGpzb253ZWJ0b2tlbikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IGpzb253ZWJ0b2tlbi5zaWduKHJldC5fdG9Eb2N1bWVudCgpLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgeyBleHBpcmVzSW46ICcxODAwcycgfSk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkocmV0Ll90b0RvY3VtZW50KCkpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBhY2Nlc3NfdG9rZW46IHJldCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICA8JT1sb2coKSU+IlNlcnZlcjogIiArIGJTZXJ2ZXIrIiwgdG9rZW46ICIsIHJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGxldCBjbGllbnRfaWQgPSB0aGlzLl9fY29uZmlnKCdjbGllbnRfaWQnKTsNCiAgICAgICAgICAgIGxldCBjbGllbnRfc2VjcmV0ID0gdGhpcy5fX2NvbmZpZygnc2VjcmV0Jyk7DQogICAgDQogICAgICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIDwlPXNjb3BlJT4uX190b2tlbil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJObyB1c2VybmFtZS9wYXNzd29yZCBhbmQgdG9rZW4gYWxyZWFkeSBleGlzdHMiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICA8JWlmKF9jTmFtZSgnb0F1dGggVG9rZW4nKSl7JT4NCiAgICAgICAgICAgIGxldCBkYXRhID0gew0KICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICdwYXNzd29yZCcsDQogICAgICAgICAgICAgICAgdXNlcm5hbWUsDQogICAgICAgICAgICAgICAgcGFzc3dvcmQsDQogICAgICAgICAgICAgICAgY2xpZW50X2lkLA0KICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgY29uZmlnID0gew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgPCU9c2NvcGUlPi5fX3Rva2VuICYmIDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuKXsNCiAgICAgICAgICAgICAgICBkYXRhID0gew0KICAgICAgICAgICAgICAgICAgICBncmFudF90eXBlOiAicmVmcmVzaF90b2tlbiIsDQogICAgICAgICAgICAgICAgICAgIHJlZnJlc2hfdG9rZW46IDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuLA0KICAgICAgICAgICAgICAgICAgICBjbGllbnRfaWQsDQogICAgICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQsDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7PCU9c2NvcGUlPi5fX3Rva2VuLnRva2VuX3R5cGV9ICR7PCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuc2VjdXJlKCk/J3MnOicnfTovLyR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuYWRkcmVzcygpfTokezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLnBvcnQoKSB8fCAzMDAwfS9vYXV0aC90b2tlbmAsIE9iamVjdC5rZXlzKGRhdGEpLm1hcChrZXkgPT4ga2V5ICsgJz0nICsgZGF0YVtrZXldKS5qb2luKCcmJyksIGNvbmZpZyk7DQogICAgICAgICAgICBpZihyZXQuZGF0YS5hY2Nlc3NfdG9rZW4pew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190b2tlbiA9IHJldC5kYXRhOw0KDQogICAgICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4pew0KICAgICAgICAgICAgICAgICAgICBpZihheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UuY2xlYXIpIGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS5jbGVhcigpOw0KICAgICAgICAgICAgICAgICAgICBheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UudXNlKHJlc3BvbnNlID0+IHJlc3BvbnNlLCBhc3luYyBlcnJvciA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSBlcnJvci5jb25maWc7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgJiYgIW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgJiYgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbi5pbmRleE9mKDwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW4pPjApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9hdXRob3JpemUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgPCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbjsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXhpb3Mob3JpZ2luYWxSZXF1ZXN0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICA8JSB9ZWxzZSBpZihhdXRoQ2xhc3MpeyU+DQogICAgCTwlPXNjb3BlJT4uX190b2tlbiA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuPCU9bU5hbWUucmVwbGFjZSgnXycsICcnKSU+KCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgPCU9d2FybigpJT4iTm8gYXV0aG9yaXphdGlvbiBkZWZpbmVkIik7DQogICAgPCUgfSU+DQogICAgICAgIH0NCjwlIH1lbHNleyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoKSklPigpLjwlPW1OYW1lJT4odXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsNCjwlfSU+DQogICAgfQ0KICAgIA0KPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19zZXJ2ZXInJT4ob3B0aW9ucz17fSkgew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmNsZWFyQ29uc29sZSkgY29uc29sZS5jbGVhcigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fVG9vbHMpIDwlPXNjb3BlJT4uVG9vbHMgPSA8JT1zY29wZSU+Ll9fVG9vbHM7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpPT09J3VuZGVmaW5lZCcgJiYgdHlwZW9mKDwlPXNjb3BlJT4uaHJlZnMpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAJCWZvciBhd2FpdCAoY29uc3QgbCBvZiA8JT1zY29wZSU+LmhyZWZzKSB7DQogICAgICAgIAkJCWF3YWl0IHRoaXMucmVxdWlyZShsLmxpYiwgPCU9c2NvcGUlPi5ocmVmcywgYXN5bmMgX2wgPT4gew0KICAgIDwlIGlmKF9jTmFtZSgnU3RvcmVkU2NyaXB0JykpeyU+DQogICAgICAgIAkJCWlmKF9sLnNjcmlwdCAmJiA8JT1zY29wZSU+LlRvb2xzKSByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTdG9yZWRTY3JpcHQnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfbC5zY3JpcHQpLmxvYWRTY3JpcHQoKTsNCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgbGV0IHNlY3VyZSA9IHRoaXMuX19jb25maWcoJ3NlY3VyZScpOw0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgLy8gZ2xvYmFscw0KICAgICAgICAgICAgICAgIHZhciBnbG9iYWxNb2R1bGVzID0gew0KICAgICAgICAgICAgICAgICAgICBleHByZXNzOiAnZXhwcmVzcycsDQogICAgICAgICAgICAgICAgICAgIGh0dHBzOiAnaHR0cHMnLA0KICAgICAgICAgICAgICAgICAgICBodHRwOiAnaHR0cCcsDQogICAgICAgICAgICAgICAgICAgIHNlbGZzaWduZWQ6ICdzZWxmc2lnbmVkJywNCiAgICAgICAgICAgICAgICAgICAgdXRpbDogJ3V0aWwnLA0KICAgICAgICAgICAgICAgICAgICBjb3JzOiAnY29ycycsDQogICAgICAgICAgICAgICAgICAgIGJvZHlQYXJzZXI6ICdib2R5LXBhcnNlcicsDQogICAgICAgICAgICAgICAgICAgIGF4aW9zOiAnYXhpb3MnLA0KICAgICAgICAgICAgICAgICAgICAvL2NyeXB0bzogJ2NyeXB0bycsDQogICAgICAgICAgICAgICAgICAgIG9zOiAnb3MnLA0KICAgICAgICAgICAgICAgICAgICAvL2ptZXNwYXRoOiAnam1lc3BhdGgnLA0KICAgICAgICAgICAgICAgICAgICBqc29ucGF0aDogJ2pzb25wYXRoJywNCiAgICAgICAgICAgICAgICAgICAganNvbmF0YTogJ2pzb25hdGEnLA0KICAgICAgICAgICAgICAgICAgICBEb3RPYmplY3Q6ICdkb3Qtb2JqZWN0JywNCiAgICAgICAgICAgICAgICAgICAgbWFjaGluZWlkOiAnbm9kZS1tYWNoaW5lLWlkJywNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIG1pbmltaXN0OiAnbWluaW1pc3QnLA0KICAgICAgICAgICAgICAgIA0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ2dyYXBocWwnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZ3JhcGhxbEhUVFA6ICdleHByZXNzLWdyYXBocWwnLA0KICAgICAgICAgICAgICAgICAgICBncmFwaHFsOiAnZ3JhcGhxbCcsDQogICAgICAgICAgICAgICAgICAgIHBsYXlncm91bmQ6ICdncmFwaHFsLXBsYXlncm91bmQtbWlkZGxld2FyZS1leHByZXNzJywNCjwlIH0lPg0KDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZW1haWwuaG9zdCddKXslPg0KICAgICAgICAgICAgICAgICAgICBub2RlbWFpbGVyOiAnbm9kZW1haWxlcicsDQo8JSB9JT4NCg0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ3RvdHAuc2VjcmV0J10peyU+DQogICAgICAgICAgICAgICAgICAgIG90cGF1dGg6ICdvdHBhdXRoJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgY2hpbGRfcHJvY2VzczogJ2NoaWxkX3Byb2Nlc3MnLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiAnZXZlbnRzJywNCiAgICAgICAgICAgICAgICAgICAgc29ja2V0aW86ICdzb2NrZXQuaW8nLA0KICAgICAgICAgICAgICAgICAgICBtcXR0OiAnbXF0dCcsDQogICAgICAgICAgICAgICAgICAgIGFtcXBsaWI6ICdhbXFwbGliJywNCiAgICAgICAgICAgICAgICAgICAgcHJvdG9idWZqczogJ3Byb3RvYnVmanMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIGZzOiAnZnMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0thZmthJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBrYWZrYWpzOiAna2Fma2FqcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnTmVvNGonXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIG5lbzRqOiAnbmVvNGotZHJpdmVyJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgICAgIE9BdXRoU2VydmVyOiAnZXhwcmVzcy1vYXV0aC1zZXJ2ZXInLA0KPCUgfWVsc2UgaWYoYXV0aENsYXNzKXslPg0KICAgICAgICAgICAgICAgICAgICBqc29ud2VidG9rZW46ICdqc29ud2VidG9rZW4nLA0KPCUgfSU+DQoNCg0KPCUgaWYobWFpbkNsYXNzKFsnU3FsREInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIHNxbGl0ZTogJ3NxbGl0ZTMnLA0KICAgICAgICAgICAgICAgICAgICBteXNxbDogJ215c3FsJywNCiAgICAgICAgICAgICAgICAgICAgcG9zdGdyZXM6ICdwZycsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ1Nub3dGbGFrZSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgc25vd2ZsYWtlOiAnc25vd2ZsYWtlLXNkaycsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ01vbmdvREInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIG1vbmdvZGI6ICdtb25nb2RiJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnUnhEQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgUnhEQjogJ3J4ZGInLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydFeGNlbCddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgWExTWDogJ3hsc3gnLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBtaXNzaW5nR2xvYmFsTW9kdWxlcyA9IE9iamVjdC5lbnRyaWVzKGdsb2JhbE1vZHVsZXMpLm1hcChlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsW2VbMF1dID0gcmVxdWlyZShlWzFdKTsNCiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ZXgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbMV07DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KS5maWx0ZXIoZSA9PiBlKTsNCiAgICAgICAgICAgICAgICBpZihtaXNzaW5nR2xvYmFsTW9kdWxlcy5sZW5ndGgpIDwlPXdhcm4oKSU+Im5wbSBpbnN0YWxsICIgKyBtaXNzaW5nR2xvYmFsTW9kdWxlcy5qb2luKCcgJykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgCQk8JT1sb2coKSU+YFN0YXJ0aW5nIFskezwlPW5zY29wZSU+Ll9ub2RlPzwlPW5zY29wZSU+Ll9ub2RlLmNvZGUoKTonJ31dLi4uYCk7DQoNCgkJCWlmIChvcHRpb25zLmxvYWRUb29scykgYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSkgfHwgX2NOYW1lKCklPigpLl9sb2FkVG9vbHMob3B0aW9ucy5zYXZlVG9vbHMpOw0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7ICAvKiBUb29scyBmaXJzdCBvciBOb2RlcyBmaXJzdD8/PyAqLyU+DQogICAgICAgICAgICBpZihvcHRpb25zLmluaXROb2RlKXsNCiAgICAgICAgICAgICAgICA8JT1uc2NvcGUlPi5fbm9kZSA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5zZWN1cmUoc2VjdXJlKS5pbml0KHRoaXMuX19jb25maWcoJ2luaXQubG9vcCcsIDAuNSkpOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZig8JT1uc2NvcGUlPi5fbm9kZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuIDwlPWVycm9yKCklPiI8JT1uc2NvcGUlPi5fbm9kZSBpcyB1bmRlZmluZWQhIik7DQogICAgICAgICAgICB9DQo8JSB9JT4NCg0KICAgIAkJaWYgKHR5cGVvZih0aGlzLmluaXQpPT09J2Z1bmN0aW9uJyAmJiBvcHRpb25zLmluaXRTZWxmKSB7DQogICAgCQkJYXdhaXQgdGhpcy5pbml0KCk7DQogICAgDQogICAgCQkJbGV0IHNxbFRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQuX19kbWxTdGF0ZW1lbnRzKTsNCiAgICAJCQlpZiAob3B0aW9ucy5jb3B5RE1MICYmIHNxbFRvb2wpIHsNCiAgICAJCQkJbGV0IGRtbHMgPSBzcWxUb29sLl9fZG1sU3RhdGVtZW50czsNCiAgICAJCQkJaWYgKHNxbFRvb2wudHlwZS5uYW1lID09ICdTcWxEQicpIGRtbHMgPSBbIC8qIkN1c3RvbWVycyIsICJPcmRlcnMiLCAiU2hpcHBpbmdzIiwgKi8gImRlbW8iXS5tYXAodCA9PiBgZHJvcCB0YWJsZSBpZiBleGlzdHMgJHt0fWApLmNvbmNhdChkbWxzKTsNCiAgICAJCQkJX0ZyRU1ELl9jb3B5VGV4dFRvQ2xpcGJvYXJkKGRtbHMuam9pbignO1xuJykpOw0KICAgIAkJCX0NCiAgICAJCX0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlIFR5cGUnKSl7JT4NCiAgICAgICAgICAgIC8vIHJlZnJlc2ggc2NyaXB0DQogICAgICAgICAgICB0aGlzLnNldEludGVydmFsKG51bGwsIGFzeW5jICgvKnZlcnNpb24qLykgPT4gew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuc3IoKS5iTG9jYWwpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc2N0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlIFR5cGUnLCB0cnVlKSU+KG51bGwsICdGaWxlU3lzdGVtJykuX2Zyb21Eb2N1bWVudCg8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+IHx8IHtuYW1lOiAnTm9kZUpTJ30pOw0KICAgICAgICAgICAgICAgIGxldCBjdCA9IGF3YWl0IHNjdC5maW5kKCk7DQogICAgICAgICAgICAgICAgaWYoIWN0IHx8ICFjdC5hY3RpdmUoKSB8fCAhY3QuZW5hYmxlZCgpKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYoICFzY3QuZGF0ZSgpIHx8ICgoY3QuZGF0ZSgpLmdldFRpbWUoKSAtIHNjdC5kYXRlKCkuZ2V0VGltZSgpKS8xMDAwKSA+IDUgKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBOZXdlciB2ZXJzaW9uIGZvdW5kOiBbZGF0ZTogJHtjdC5kYXRlKCkudG9JU09TdHJpbmcoKX0sIHRvb2w6ICR7Y3QuVG9vbC5uYW1lfV0sIHN0b3JpbmcuLi5gKTsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB3YW50IHRvIHN0b3JlIHRoZSBjb250ZW50IGRpcmVjdGx5IHRvIHRoZSBub2RlanMuanMgZmlsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY3QuX2ZpbGVzeXN0ZW0oY3QuY29kZSgpICsgJy5qcycsIHRoaXMuX2F0b2IoY3QucmVtYXJrKCkpKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LnNlbGYgIT09IHdpbmRvdy50b3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ImlGcmFtZSBzaG91bGQgYmUgcmVzdGFydGVkLi4uIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4id2luZG93IGxvY2F0aW9uIHJlbG9hZGluZy4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3dpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJmcmFtZSBjaGVjayIsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+ID0gc2N0LmRhdGUoY3QuZGF0ZSgpKS5uYW1lKGN0Lm5hbWUoKSkuY29kZShjdC5jb2RlKCkpLl90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9LCAwLjUpOw0KPCUgfSU+DQogICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5sb2FkQ29udGVudCAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSB3aW5kb3cub25oYXNoY2hhbmdlID0gYXN5bmMgKCkgPT4gZG9jdW1lbnQuYm9keSA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7dG1wOiBsb2NhdGlvbi5oYXNoLnBhZ2V9KTsNCiAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGNvcnMoKSk7DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZSwgbGltaXQ6ICc1MG1iJ30pKTsNCiAgICAgICAgICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7DQogICAgICAgICAgICAgICAgICAgIHZlcmlmeTogKHJlcSwgcmVzLCBidWYpID0+IHJlcS5yYXdCb2R5ID0gYnVmDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddOw0KICAgICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuLnZlcmlmeSh0b2tlbiwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIChlcnIsIG9iaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoID0gbmV3IE9BdXRoU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgZGVidWc6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIHVzZUVycm9ySGFuZGxlcjogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWVNaWRkbGV3YXJlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyByZXF1aXJlQ2xpZW50QXV0aGVudGljYXRpb246IHsgcGFzc3dvcmQ6IGZhbHNlIH0sDQogICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtb2RlbDogKCgpID0+ICh7DQogICAgICAgICAgICAgICAgCQlnZXRBY2Nlc3NUb2tlbjogYmVhcmVyVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5hY2Nlc3NUb2tlbihiZWFyZXJUb2tlbikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0QWNjZXNzVG9rZW4nKSkudGhlbih0ID0+IHt0LmFjY2Vzc1Rva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5hY2Nlc3NUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICBnZXRDbGllbnQ6IChjbGllbnRJZCwgY2xpZW50U2VjcmV0KSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pbml0KCkuZmluYWxseSgoKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZChjbGllbnRJZCkuc2VjcmV0KGNsaWVudFNlY3JldCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldENsaWVudCcpKSwNCiAgICAgICAgICAgICAgICAJICAgIGdldFVzZXI6ICh1c2VybmFtZSwgcGFzc3dvcmQpID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLmF1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0VXNlcicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHNhdmVUb2tlbjogKHRva2VuLCBjbGllbnQsIHVzZXIpID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuX2Zyb21Eb2N1bWVudCh0b2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLl9mcm9tRG9jdW1lbnQoY2xpZW50KSkudXNlcih1c2VyKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdG9yZSgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnc2F2ZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgcmV2b2tlVG9rZW46IHRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkucmVmcmVzaFRva2VuKHRva2VuLnJlZnJlc2hUb2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLmlkKHRva2VuLmNsaWVudC5pZCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkpLmZpbmQoKS50aGVuKHQgPT4gdC5lbmFibGVkKGZhbHNlKS5hY3RpdmUoZmFsc2UpLnN0b3JlKCkpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAncmV2b2tlVG9rZW4nKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRSZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoMi8qd2h5Ki8pLnRoZW4odCA9PiB0Ll90b0RvY3VtZW50KCkpLnRoZW4odCA9PiB7dC5yZWZyZXNoVG9rZW5FeHBpcmVzQXQgPSBuZXcgRGF0ZSh0LnJlZnJlc2hUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgIAkgICAgICAgIH0pKSgpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoLmhhbmRsZXIgPSAodCwgbSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtKSA8JT1sb2coKSU+bSwgdC5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Ll90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPm0sIGV4LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9vYXV0aC90b2tlbicsIGFwcC5vYXV0aC50b2tlbigpKTsNCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXBwLm9hdXRoLmF1dGhlbnRpY2F0ZSgpOw0KPCUgfSU+DQoNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gbS5Jc1B1YmxpYykuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCjwlIH0pKSU+DQoNCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOw0KICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgYXBwLnVzZSgnL2dyYXBocWwnLCBncmFwaHFsSFRUUC5ncmFwaHFsSFRUUCh7DQogICAgICAgICAgICAgICAgICAgIHNjaGVtYTogZ3JhcGhxbC5idWlsZFNjaGVtYSh0aGlzLl90b0dRTFNjaGVtYSgpKSwNCiAgICAgICAgICAgICAgICAgICAgcm9vdFZhbHVlOiB0aGlzLl9xbFJlc29sdmVyKCksDQogICAgICAgICAgICAgICAgICAgIGdyYXBoaXFsOiB0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIiksDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoInBsYXlncm91bmQiKSAmJiB0eXBlb2YocGxheWdyb3VuZCkhPT0idW5kZWZpbmVkIikgYXBwLmdldCgnL3BsYXlncm91bmQnLCBwbGF5Z3JvdW5kLmRlZmF1bHQoeyBlbmRwb2ludDogJy9ncmFwaHFsJyB9KSkNCjwlIH0lPg0KDQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKT97DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksDQogICAgICAgICAgICAgICAgICAgICAgICB9OnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAgICBhd2FpdCA8JT1zY29wZSU+LnRyYW5zcG9ydGVyLnNlbmRNYWlsKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdG8sDQogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwb3J0ID0gPCU9bnNjb3BlJT4uX25vZGU/KDwlPW5zY29wZSU+Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKTozMDAwOw0KICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gIjAuMC4wLjAiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiA8JT1sb2coKSU+YDwlPXNjb3BlJT5bJHt0aGlzLmlwQWRkcmVzcygpfV0gbGlzdGVuaW5nIGF0IGh0dHAke3NlY3VyZT8ncyc6Jyd9Oi8vJHthZGRyZXNzfToke3BvcnR9YCk7DQogICAgICAgICAgICAgICAgaWYoc2VjdXJlKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNlcnQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZTogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gc2VsZnNpZ25lZC5nZW5lcmF0ZShbeyBuYW1lOiAnY29tbW9uTmFtZScsIHZhbHVlOiAnbmFtbW91ci5jb20nIH1dLCB7IGRheXM6IDM2NSB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwcy5jcmVhdGVTZXJ2ZXIoew0KICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBjZXJ0LnByaXZhdGUsDQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiBjZXJ0LmNlcnQNCiAgICAgICAgICAgICAgICAgICAgfSwgYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2luYm91bmRDYWxsJyU+KHJlcSwgcmVzLCBjTmFtZSwgbU5hbWUpew0KICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG5ldyA8JT1zY29wZSU+W3JlcS5wYXJhbXMuY2xhc3MgfHwgY05hbWVdKCkuX2ludm9rZShyZXEucGFyYW1zLm1ldGhvZCB8fCBtTmFtZSwgcmVxLmJvZHksIHJlcS5xdWVyeSwgcmVxLl9fYXV0aG9yaXphdGlvbik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgRXhjZXB0aW9uOiAiRXhjZXB0aW9uOiAiICsgZXgsDQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYocmV0ICYmIHR5cGVvZihyZXQpPT09Im51bWJlciIpIHJldCA9IHJldC50b1N0cmluZygpOw0KICAgICAgICByZXMuc2VuZChyZXQpOw0KICAgIH0NCg0KPCUgaWYoYy5Db25maWdbJ2dyYXBocWwnXSl7JT4NCiAgICA8JT1tTmFtZT0nX3FsU2VsZWN0aW9ucyclPihzU2V0KXsNCiAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICBpZighc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0Ow0KICAgICAgICANCiAgICAgICAgc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gew0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZihzLm5hbWUudmFsdWU9PSI8JT1uTmFtZShlYSklPiIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4nUmVmZXJlbmNlIGZvciA8JT1uTmFtZShlYSklPicsIHMpOw0KICAgICAgICAgICAgICAgIGxldCBzT2JqID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKHNPYmopOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOw0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfcWxSZXNvbHZlciclPigpew0KICAgICAgICByZXR1cm4gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShfYyklPjogYXN5bmMgKHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbykgPT4gew0KICAgICAgICAgICAgICAgIGlmKCFwYXJlbnQuZGF0YSkgcGFyZW50LnF1ZXJ5ID0gcGFyZW50LnF1ZXJ5IHx8IHt9Ow0KICAgICAgICAgICAgICAgIGxldCBvYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLl9mcm9tRG9jdW1lbnQocGFyZW50LnF1ZXJ5IHx8IHBhcmVudC5kYXRhKTsNCiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICBpZihwYXJlbnQucXVlcnkpew0KICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGRzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLmZpbmRBbGwobnVsbCwgb2JqLl9xbFNlbGVjdGlvbnMoY29udGV4dC5maWVsZE5vZGVzWzBdLnNlbGVjdGlvblNldCksIG51bGwsIG51bGwsIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLmNvbmNhdChjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMubWFwKHMgPT4gcy5uYW1lLnZhbHVlKSkpOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmVudC5kYXRhKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLnN0b3JlKCk7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5fX2Fzc2VydEVycm9yKSB0aHJvdyBvYmouX19hc3NlcnRFcnJvcjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldC5tYXAociA9PiByLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0P3JldC5fdG9Eb2N1bWVudCgpOnJldDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAgICAgICAgIC8vIDwlPW5OYW1lKF9tKSU+OiAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLjwlPW5OYW1lKF9tKSU+KCI8JT1uTmFtZShfbSklPiIsIHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbyksDQogICAgPCUgfSklPg0KPCUgfSklPg0KICAgICAgICB9Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvR1FMU2NoZW1hJyU+KCl7DQogICAgICAgIGxldCByZXQgPSBgDQp0eXBlIFF1ZXJ5IHsNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IHslPg0KICAgICIiIg0KICAgIEZpbmQgYWxsIG1hdGNoZXMgZm9yIDwlPW5OYW1lKF9jKSU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4ocXVlcnk6IDwlPW5OYW1lKF9jKSU+SW5wdXQpOiBbPCU9bk5hbWUoX2MpJT5dDQo8JSB9KSU+DQp9DQoNCnR5cGUgTXV0YXRpb24gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgU3RvcmUgYSBzaW5nbGUgPCU9bk5hbWUoX2MpJT4gb2JqZWN0DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4oZGF0YTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IDwlPW5OYW1lKF9jKSU+DQo8JSB9KSU+DQp9DQogICAgDQogICAgPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQoiIiINCklucHV0IHR5cGUgZm9yIDwlPW5OYW1lKF9jKSU+DQoiIiINCmlucHV0IDwlPW5OYW1lKF9jKSU+SW5wdXR7DQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPklucHV0XQ0KICAgIDwlIH0pJT4NCiAgICBPUEVSQVRPUlM6IDwlPW5OYW1lKF9jKSU+T3BlcmF0b3INCn0NCg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5PcGVyYXRvcnsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiBTdHJpbmcNCiAgICA8JSB9KSU+DQp9DQoNCiIiIg0KPCU9X2MuUmVtYXJrJT4NCiIiIg0KdHlwZSA8JT1uTmFtZShfYyklPnsNCiAgICBfaWQ6IElEIQ0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgIiIiDQogICAgPCU9ZWEuUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhKSU+PCU9ZWEuSXNSZXF1aXJlZD8nISc6JyclPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QgJiYgdGEuRW50aXR5VHlwZSkuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+OiBbPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT5dDQogICAgPCUgfSklPg0KDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5maWx0ZXIoX20gPT4gIV9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT46IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSwgdHJ1ZSklPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiBfbS5NZXRob2RQYXJhbWV0ZXJzLmxlbmd0aCkuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1fbS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKF9tKSU+KDwlPV9tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gbk5hbWUocCkgKyAnOiAnICsgcWxUeXBlKHAsIHRydWUpKS5qb2luKCcsICcpJT4pOiA8JT1xbFR5cGUoX20uUmVzcG9uc2VBdHRyaWJ1dGUpJT4NCiAgICA8JSB9KSU+DQp9DQogICAgPCUgfSklPg0KICAgICAgICBgOw0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9IC8vIGdyYXBoJT4NCg0KPCUgfSAvLyBJc01haW4gJT4NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW52b2tlTm9kZSclPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7DQogICAgICAgIC8vIGlmKCFuKSByZXR1cm4gbnVsbDsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZig8JT1uc2NvcGUlPi5fbm9kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uc2NvcGUlPi5fbm9kZSBub3QgZGVmaW5lZCIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKGV2ZW50KXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpIT0nPCU9bk5hbWUoYyklPicpew0KICAgICAgICAgICAgICAgIGxldCBvQ2xhc3MgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKGZhbHNlKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKycuJyttZXRob2QrJyAuLi4uJyk7DQogICAgPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHslPg0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKFsiPCU9ZW0udmFsdWVzLm1hcChtYyA9PiBuTmFtZShtYykpLmpvaW4oJyIsICInKSU+Il0uaW5kZXhPZihldmVudC5jbGFzc05hbWUoKSk+PTApew0KICAgICAgICAgICAgICAgICAgICBvQ2xhc3MgPSBuZXcgPCU9c2NvcGUlPjwlPWVtLmtleT8oJy4nK2VtLmtleS5BbGlhcyk6JyclPltldmVudC5jbGFzc05hbWUoKV0oKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBvQ2xhc3MuPCU9bU5hbWUlPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsNCiAgICAgICAgICAgIH0NCjwlIH1lbHNleyU+DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsNCiAgICAgICAgICAgIHJldHVybiBudWxsOw0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGRhdGEgPSBkYXRhIHx8IHt9Ow0KDQogICAgICAgIGlmKHR5cGVvZihkYXRhKT09PSJvYmplY3QiKXsNCiAgICAgICAgICAgIGRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9KU09OKHtwYXJzZTogMX0pOw0KICAgICAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KICAgICAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBkYXRhLjwlPW5OYW1lKHApJT4gPSBkYXRhLjwlPW5OYW1lKHApJT4/ZGF0YS48JT1uTmFtZShwKSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4ubWFwKF9wID0+IF9wPCV9JT4NCiAgICAgICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSl7JT4uX3RvRG9jdW1lbnQoKQ0KICAgICAgICAgICAgPCUgfWVsc2UgaWYocC5Jc0RhdGUpeyU+LnRvSVNPU3RyaW5nKCkNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgPCVpZihwLklzQXJyYXkpeyU+KTwlfSU+OnVuZGVmaW5lZDsNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgICAgICBpZih0eXBlb2Yobik9PT0nc3RyaW5nJykgbiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKG4pOw0KPCUgfSU+DQoNCiAgICAgICAgaWYoIW4gfHwgPCU9bnNjb3BlJT4uX25vZGUuX3NhbWVFbnRpdHkobikpew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7DQogICAgICAgICAgICA8JT1sb2coKSU+IkxvY2FsIG5vZGUiLCByZXQpOw0KDQogICAgICAgIH1lbHNlIGlmKG4uYWRkcmVzcygpKXsNCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+bi5hZGRyZXNzKCksIG4ucG9ydCgpLCBtZXRob2QpOw0KICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBkYXRhLCBudWxsLCBudWxsLCB7cGF0aDogYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kLzwlPW5OYW1lKGMpJT4vJHttZXRob2R9YCwgaGVhZGVyczoge319KTsNCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9ZWxzZXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSAmJiBjLk5hbWUhPT0nRXZlbnQnKXslPg0KICAgICAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsNCiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8NCiAgICAgICAgICAgIDwlIC8qdW5SZWN1cnNlKCdkYXRhJywgJ21ldGhvZCcsICd7fScsICcnLCA1LCAnX190aGlzLmNvZGUnKSovICU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRXZlbnQnLCB0cnVlKSU+KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnPCU9c2NvcGUlPi5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJzwlPW5OYW1lKGMpJT4nKS5zZW5kZXIoPCU9bnNjb3BlJT4uX25vZGUpLmNhcnJpZXIoPCU9bnNjb3BlJT4uX25vZGUpLnBheWxvYWQodGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShkYXRhKSkpOw0KICAgICAgICAgICAgaWYoZXZlbnQpew0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YocmV0KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlIGlmKHJldCAmJiB0eXBlb2YocmV0LnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgLy8gcmV0IGlzIGFuIGV2ZW50DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0LnBheWxvYWQoKTsNCiAgICAgICAgICAgIH1lbHNlIGlmKEFycmF5LmlzQXJyYXkocmV0KSAmJiByZXRbMF0gJiYgdHlwZW9mKHJldFswXS5wYXlsb2FkKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgIHJldCA9IHJldC5tYXAociA9PiByLnBheWxvYWQoKSk7DQogICAgICAgICAgICAgICAgaWYocmV0Lmxlbmd0aD09MSkgcmV0ID0gcmV0WzBdOw0KICAgICAgICAgICAgfQ0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpIHJldHVybiBudWxsOw0KICAgICAgICByZXQgPSByZXQuZGF0YSB8fCByZXQ7DQoNCiAgICAgICAgaWYocmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIC8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyDQogICAgICAgICAgICA8JT1lcnJvcigpJT5gRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfQ0KDQogICAgICAgIHN3aXRjaChtZXRob2Qpew0KPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBpZighYlJhdykgcmV0ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgIDwlIH0gJT4NCiAgICA8JSBpZihtLk5hbWU9PSdhdXRob3JpemUnKXslPg0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190b2tlbiA9IHt0b2tlbl90eXBlOiAiQmVhcmVyIiwgYWNjZXNzX3Rva2VuOiByZXR9Ow0KICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyAlPg0KDQogICAgICAgICAgICBjYXNlICJpbnNlcnQiOg0KICAgICAgICAgICAgY2FzZSAidXBkYXRlIjoNCiAgICAgICAgICAgIGNhc2UgInN0b3JlIjoNCiAgICAgICAgICAgIGNhc2UgImRlbGV0ZSI6DQogICAgICAgICAgICBjYXNlICJmaW5kIjogDQogICAgICAgICAgICBjYXNlICJmaW5kQWxsIjogew0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KPCUgaWYobWFpbkNsYXNzKCkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2UnJT4obWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iail7DQogICAgICAgIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMpJT4uJyArIG1ldGhvZCk7DQogICAgICAgIDwlPWxvZygpJT5tZXRob2QsIHF1ZXJ5LCBib2R5KTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihib2R5KT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdib2R5JyklPil7IC8vIGJhc2U2ND8NCiAgICAgICAgICAgICAgICBib2R5ID0gdGhpcy5fYXRvYihib2R5KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoL1teLDp7fVxbXF0wLTkuXC0rRWFlZmxuci11IFxuXHJcdF0vLnRlc3QoYm9keSkpeyAvLyBqc29uDQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IF9wYXJhbXMgPSBxdWVyeT9PYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KTpib2R5Ow0KICAgICAgICBpZih0eXBlb2YoX3BhcmFtcyk9PT0nc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7DQogICAgICAgIA0KICAgICAgICBpZihfcGFyYW1zKXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSB7fTsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPWxvZygpJT4iX3BhcmFtcyIsIF9wYXJhbXMpOw0KDQogICAgPCUgaWYoX2NOYW1lKCdOb2RlJykgJiYgYy5OYW1lIT0nTm9kZScpeyU+DQogICAgICAgIGlmKF9wYXJhbXMuX19ub2RlKXsNCiAgICAgICAgICAgIC8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/DQogICAgICAgICAgICBsZXQgdG4gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkvKi5fZGVSZWZlcmVuY2UoKSovOw0KICAgICAgICAgICAgZGVsZXRlIF9wYXJhbXMuX19ub2RlOw0KICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCg0KICAgICAgICBpZihfcGFyYW1zLl9fdGhpcykgew0KICAgICAgICAgICAgX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsNCiAgICAgICAgICAgIGxldCBfX3RoaXMgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLyouX2RlUmVmZXJlbmNlKCkqLzsNCiAgICAgICAgICAgIGRlbGV0ZSBfcGFyYW1zLl9fdGhpczsNCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBfX3RoaXMuPCU9bU5hbWUlPihtZXRob2QsIF9wYXJhbXMsIG51bGwsIGF1dGhPYmopOw0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IGFyQXJncyA9IFtdOw0KICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KPCUgaWYoX2NOYW1lKCdUcmFuc2FjdGlvbicpICYmIF9jTmFtZSgnQ29udGVudCcpICYmIGMuTmFtZSE9J1RyYW5zYWN0aW9uJyAmJiAhbS5Jc1N5bmMpeyU+DQogICAgICAgIGlmKCFfcGFyYW1zLlN5bmMpew0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zY29wZSgiPCU9c2NvcGUlPiIpLmNsYXNzKCI8JT1jLk5hbWUlPiIpLm1ldGhvZChtZXRob2QpLmF1dGhvcml6YXRpb24oYXV0aE9iaikuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucGF5bG9hZCh0aGlzLl9idG9hKF9wYXJhbXMpKS50cmFuc2FjdGlvbl9UcmFuc2FjdGlvbkxvZ3MoW25ldyA8JT1zY29wZSU+LlRyYW5zYWN0aW9uTG9nKCkuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkuc3RhdGUobmV3IDwlPXNjb3BlJT4uVHJhbnNhY3Rpb25TdGF0ZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoImxvYWRlZCIpKV0pLnN0b3JlKCkpLklkKS5fdG9Eb2N1bWVudCgpOw0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSAmJiBwLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgX3BhcmFtcy48JT1uQ29kZShwKSU+ID0gX3BhcmFtcy48JT1uQ29kZShwKSU+Lm1hcChwID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQocCkuX2RlUmVmZXJlbmNlKCkpOw0KICAgICAgICA8JSB9ZWxzZSBpZihwLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIF9wYXJhbXMuPCU9bkNvZGUocCklPiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy48JT1uQ29kZShwKSU+KS5fZGVSZWZlcmVuY2UoKTsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuPCU9bkNvZGUocCklPik7DQogICAgPCUgfSk7JT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyU+DQoNCiAgICAgICAgICAgIGNhc2UgImZpbmRBbGwiOnsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgImZpbmQiOiB7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IG9iaiA9IHRoaXM7DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgaWYoIW9iail7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgJy0xJzogYDwlPW5OYW1lKGMpJT4uPCU9bU5hbWUlPjogb2JqIGlzIHVuZGVmaW5lZGANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZSBpZighb2JqW21ldGhvZF0pew0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICctMic6IGA8JT1uTmFtZShjKSU+LjwlPW1OYW1lJT46IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsDQogICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7DQogICAgICAgIH0NCiAgICAgICAgDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgIGlmKGZhbHNlICYmIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiAmJiAhPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCl7DQogICAgICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAgICAgJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIGlmKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZSA9IHt9Ow0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICBsZXQgX3JldCA9IFtdOw0KICAgICAgICAgICAgICAgIGZvciBhd2FpdChjb25zdCByIG9mIHJldCl7DQogICAgICAgICAgICAgICAgICAgIGlmKHIgJiYgci5fdG9Eb2N1bWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPikgZGVsZXRlIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+Ll90b0RvY3VtZW50Ow0KICAgICAgICAgICAgICAgICAgICAgICAgX3JldC5wdXNoKGF3YWl0IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIF9yZXQucHVzaChyKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0ID0gX3JldDsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KT9hd2FpdCByZXQuX3RvRG9jdW1lbnQoKTpyZXQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT4ncmV0JywgcmV0KTsNCiAgICAgICAgPCU9bG9nKCklPmAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYyklPi4nICsgbWV0aG9kKX1gKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgIDwlPW1OYW1lPSdfcGFyc2VDb2RlU3RhdGUnJT4odCl7DQogICAgPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuX19jb25maWcodGhpcy5fX2NvbmZpZygnb2F1dGgucmVkaXJlY3Quc3RhdGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgbGV0IGNvZGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgaWYoIXN0YXRlIHx8ICFjb2RlKSByZXR1cm47DQogICAgICAgIHN0YXRlID0gSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHN0YXRlKSk7DQogICAgICAgIGlmKHN0YXRlLnRvb2whPT10Lm5hbWUpIHJldHVybjsNCg0KICAgICAgICA8JT1sb2coKSU+IkdPVCBDT0RFICIgKyBjb2RlICsgIiBmb3Igbm9kZSAiICsgc3RhdGUubmNvZGUgKyAiIHdpdGggdG9vbCAiICsgc3RhdGUudG9vbCk7DQogICAgICAgIGlmKCE8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSB8fCAhPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudC5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSkpew0KICAgICAgICAgICAgPCU9bG9nKCklPiduZXcgcGFyZW50Jywgc3RhdGUubmNvZGUpOw0KICAgICAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKHN0YXRlLm5jb2RlKSk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUuYXV0aENvZGUoY29kZSwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUoc3RhdGUudG9vbCkpOw0KICAgICAgICB3aW5kb3cuY2xvc2UoKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHQpOw0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19sb2FkVG9vbHMnJT4oYlN0b3JlKXsNCiAgICAgICAgaWYoPCU9c2NvcGUlPi5Ub29scyAmJiA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFscmVhZHkgbG9hZGVkYCk7DQogICAgICAgICAgICByZXR1cm4gPCU9c2NvcGUlPi5Ub29sczsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmBMb2FkaW5nIHRvb2xzLi4uYCk7DQogICAgICAgIA0KICAgICAgICBsZXQgdG9vbHMgPSBbXTsNCiAgICAgICAgdG9vbHMgPSA8JT1zY29wZSU+Ll9fVG9vbHMgfHwgdG9vbHM7DQogICAgICAgIGRlbGV0ZSA8JT1zY29wZSU+Ll9fVG9vbHM7DQoNCiAgICAgICAgbGV0IGFyVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoWy4uLm5ldyBTZXQoYXJDbGFzc2VzLm1hcChfYyA9PiBfYy5Ub29scykuZmxhdCgpKV0pJT47DQogICAgICAgIGxldCB0b29sTmFtZXMgPSBhclRvb2xzLm1hcCh0ID0+IHQubmFtZSB8fCAodC50eXBlP3QudHlwZS5uYW1lOnQpKTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodG9vbHMubGVuZ3RoIT09dG9vbE5hbWVzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgLy8gY2Fubm90IHVzZSByZXF1aXJlIHlldCwgbm8gdG9vbHMgcHJvcGVybHkgbG9hZGVkIHRvIHVzZSBhIGxvYWRlciBmdW5jdGlvbg0KICAgICAgICAgICAgICAgIHRvb2xzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHtOYW1lOiAnQVBJU0VSVkVSXzwlPW1OYW1lJT4nLCBBY3RpdmU6IHRydWUsIEVuYWJsZWQ6IHRydWV9KSB8fCB0b29sczsNCiAgICAgICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgICAgICBpZighdG9vbHMubGVuZ3RoKSB0b29scyA9IChhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuVEhJUyh0b29sTmFtZXMubWFwKHQgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUodCkpKS5maW5kQWxsKDIpKS5tYXAodCA9PiB0Ll90b0pTT04oe3BhcnNlOiAxfSkpIHx8IHRvb2xzOw0KPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IGZpeFRvb2xzID0gdG9vbHMgPT4gew0KICAgICAgICAgICAgdG9vbHMuZmlsdGVyKHQgPT4gdHlwZW9mKHQpPT09J29iamVjdCcgJiYgdCkuZm9yRWFjaCh0ID0+IHsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5uYW1lJywgJ3QudHlwZS5uYW1lJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuYWN0aXZlJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLmVuYWJsZWQnLCB0cnVlKSU+DQoNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudG9vbF9Db25maWdzJywgJ1tdJyklPjsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS50eXBlX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX01hcHBpbmdzJywgJ1tdJyklPjsNCiAgICANCiAgICAgICAgICAgICAgICBbXS5jb25jYXQodC50b29sX0NvbmZpZ3MsIHQudHlwZS50eXBlX0NvbmZpZ3MsIHQudHlwZS50eXBlX01hcHBpbmdzLCB0LnRvb2xfTWFwcGluZ3MpLmZvckVhY2goYyA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5lbmFibGVkJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgICAgICA8JV9kZWYoJ2MuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gWyd0b29sX0NvbmZpZ3MnLCAndHlwZS50eXBlX0NvbmZpZ3MnXS5mb3JFYWNoKHNDb25maWcgPT4gew0KICAgICAgICAgICAgICAgICAgICBEb3RPYmplY3Quc2V0KHNDb25maWcsIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSE9PSJvYmplY3QiKS5jb25jYXQoRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpPT09Im9iamVjdCIgJiYgYy52YWx1ZSkubWFwKGMgPT4gT2JqZWN0LmtleXMoYy52YWx1ZSkubWFwKG5jb2RlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfYyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBjLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGMudmFsdWVbbmNvZGVdLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5jb2RlIT0iZGVmYXVsdCIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jLm5vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IG5jb2RlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLCA8JS8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMlPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiTm9kZUpTIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2M7DQogICAgICAgICAgICAgICAgICAgIH0pLmZsYXQoKSkuZmxhdCgpKSwgdCk7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZvckVhY2goYyA9PiBjLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoYy52YWx1ZSkpOw0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICApOw0KICAgICAgICB9Ow0KDQoNCiAgICAgICAgZml4VG9vbHModG9vbHMpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHQuYWN0aXZlKTsNCiAgICAgICAgdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiB0b29sTmFtZXMuZmluZChfdCA9PiAodHlwZW9mKF90KT09PSdzdHJpbmcnP190Ol90Lm5hbWUpPT10Lm5hbWUpKTsNCg0KICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFyZSAke3Rvb2xzLmxlbmd0aH1gKTsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzID0gdG9vbHM7DQoNCiAgICAgICAgPCU9c2NvcGUlPi5Ub29scy5maWx0ZXIodCA9PiAhdC5heGlvcyAmJiA8JT1KU09OLnN0cmluZ2lmeShfcmVzdFRvb2xzKSU+LmluZGV4T2YodC50eXBlLm5hbWUpPj0wKS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgdC5heGlvcyA9IHR5cGVvZihheGlvcy5jcmVhdGUpPT09J2Z1bmN0aW9uJz9heGlvcy5jcmVhdGUoKTpheGlvczsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKHJlcXVlc3QgPT4gdGhpcy5fcmVxdWVzdEludGVyY2VwdG9yKHJlcXVlc3QsIHQpLCBlcnJvciA9PiB7fSk7DQogICAgICAgICAgICB0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gcmVzcG9uc2UsIGVycm9yID0+IHRoaXMuX3Jlc3BvbnNlSW50ZXJjZXB0b3IoZXJyb3IsIHQpKTsNCiAgICAgICAgfSk7DQogICAgICAgIA0KICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBsb2FkZWQgdG9vbHMhISENCiAgICAgICAgbGV0IHRvb2wgPSB0aGlzLlRvb2w7DQogICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+LlRvb2xzKXsNCjwlIHNyLmdyb3VwQnkoYXJDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykuZm9yRWFjaChlbSA9PiB7ZW0udmFsdWVzID0gZW0udmFsdWVzLnNvcnQoKGEsIGIpID0+IGIuUmFuayAtIGEuUmFuayk7ICU+DQogICAgICAgICAgICBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZW0udmFsdWVzWzBdLCB0cnVlKSU+KHVuZGVmaW5lZCwgdCkuX3N0b3JlRW50aXR5Q2xhc3MoPCU9ZW0udmFsdWVzWzBdLlJhbmslPik7DQo8JSB9KSU+DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5Ub29sID0gdG9vbDsNCiAgICAgICAgDQogICAgICAgIGFyVG9vbHMgPSBhclRvb2xzLmZpbHRlcihfdCA9PiAhdG9vbHMuZmluZCh0ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KICAgICAgICBmaXhUb29scyhhclRvb2xzKTsNCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgIDwlPXNjb3BlJT4ub1Rvb2xzID0gPCU9c2NvcGUlPi5Ub29scy5jb25jYXQoYXJUb29scykuZmlsdGVyKHQgPT4gdC5hY3RpdmUpLm1hcCh0ID0+IHsNCiAgICAgICAgICAgIHQudG9vbF9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udG9vbCk7DQogICAgICAgICAgICB0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udHlwZSk7DQogICAgDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodCk7DQogICAgICAgIH0pOw0KICAgICAgICBpZihiU3RvcmUpew0KICAgICAgICAgICAgPCU9bG9nKCklPmBTYXZpbmcgdG9vbHMuLi5gKTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+Lm9Ub29scyl7DQogICAgICAgICAgICAgICAgYXdhaXQgdC5zdG9yZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgICAgICA8JT1sb2coKSU+YEV4aXRpbmdgKTsNCiAgICAgICAgcmV0dXJuIHRvb2xzOw0KICAgIH0NCiAgICANCjwlIH0gLy8gbWFpbkNsYXNzICU+DQoNCgk8JT1tTmFtZT0nX3BhcmFtZXRyaXplJyU+KHN0ciwgZnVuLCBvcHRpb25zPXt9LCBwcmVmaXg9J3t7JywgcG9zdGZpeD0nfX0nKSB7DQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKHN0cikhPT0nc3RyaW5nJykgcmV0dXJuIHN0cjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJleCA9IGAke3ByZWZpeH0oW14ke3Bvc3RmaXh9XSspJHtwb3N0Zml4fWA7DQogICAgICAgICAgICAoc3RyLm1hdGNoKG5ldyBSZWdFeHAocmV4LCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHN0ciA9IHN0ci5yZXBsYWNlKG0sIG0gPT4gZnVuKG0ucmVwbGFjZShwcmVmaXgsICcnKS5yZXBsYWNlKHBvc3RmaXgsICcnKSkpKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHN0cjsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPihzdHIsIGZ1biwgb3B0aW9ucywgcHJlZml4LCBwb3N0Zml4KTsNCjwlIH0lPg0KCX0NCg0KICAgIDwlPW1OYW1lPSdfX3N5bmNfb24nJT4oZCl7DQogICAgICAgIHRoaXMuXzwlPW1OYW1lJT4gPSB0aGlzLl88JT1tTmFtZSU+IHx8IHt9Ow0KICAgIA0KICAgICAgICBpZihkKXsgLy8gc2V0IHRoZSB2YWx1ZQ0KICAgICAgICAgICAgdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV0gPSBkOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydCh0aGlzLCB7DQogICAgICAgICAgICAgICAgQ3ljbGljOiB0cnVlLA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gdGhpcy48JT1uTmFtZShlYSklPigpP3RoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOnVuZGVmaW5lZCwNCjwlIH0pJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgLy88JT10YU5hbWUlPjogdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpLA0KPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBkKTsNCg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiB0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOw0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIC8vIHRoaXMuPCU9dGFOYW1lJT4oKS5mb3JFYWNoKHQgPT4gdC48JT1tTmFtZSU+KGQpKTsNCjwlIH0pJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHRoaXMuXzwlPW1OYW1lJT5bdGhpcy5Ub29sLm5hbWVdOyAvLyBnZXQgdGhlIHZhbHVlDQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfY2xvbmUnJT4oYlR5cGVBdHRyaWJ1dGVzKXsNCiAgICAgICAgPCU9d2FybigpJT4iREVQUkVDQVRFRDogdXNlIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLk5hbWUsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHRoaXMuX3RvSlNPTigpKSIpOw0KDQogICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLCB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KHY8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKTwlfSU+KSwNCjwlIH0pOyU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBiVHlwZUF0dHJpYnV0ZXM/b2JqLjwlPXRhTmFtZSU+KHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKSkpOm51bGwsDQo8JSB9KTslPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWFwJyU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSl7DQogICAgICAgIF90aGlzID0gX3RoaXMgfHwgdGhpczsNCiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgIHRvb2wgPSB0b29sIHx8IF90aGlzLlRvb2w7DQogICAgICAgIGNvZGVUeXBlID0gY29kZVR5cGUgfHwgPCU9X2VhVHlwZXMoKSU+W2NvZGVdOw0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZSB8fCAiPCU9Yy5FbnRpdHlNb2R1bGU/Yy5FbnRpdHlNb2R1bGUuTmFtZTonJyU+IjsNCg0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgX2xvZyA9IGAke21vZHVsZU5hbWV9LiR7Y2xhc3NOYW1lfS4ke2NvbnRleHR9JHtiUmV2ZXJzZT8nPD0nOic9Pid9JHtjb2RlfWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoQXJyYXkuaXNBcnJheShvYmpGcm9tKSkgcmV0dXJuIG9iakZyb20ubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSkpOw0KICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHRlbXB0ZWQgdG8gdXNlIGpzb25hdGEgaW4gUXVlcnkgZmllbGRzLCBkb2VzIG5vdCB3b3JrIGJlY2F1c2UganNvbmF0YS5ldmFsdWF0ZSByZXR1cm4gYSBwcm9taXNlISEhICovJT4NCiAgICAgICAgICAgIGxldCBzRmllbGQgPSBiUmV2ZXJzZT8ndGFyZ2V0Jzonc291cmNlJzsNCiAgICAgICAgICAgIGxldCBzU2NyaXB0ID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHNDb25kID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgbGV0IHNQYXRoID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0RmllbGQgPSBiUmV2ZXJzZT8nc291cmNlJzondGFyZ2V0JzsNCiAgICAgICAgICAgIGxldCB0U2NyaXB0ID0gKGJSZXZlcnNlPydpbic6J291dCcpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHRQYXRoID0gKGJSZXZlcnNlPydpbic6J291dCcpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0Q29uZCA9IChiUmV2ZXJzZT8naW4nOidvdXQnKSsnQ29uZGl0aW9uJzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb3B0aW9ucyA9IHtfY2xhc3M6IGNsYXNzTmFtZSwgX3RoaXM6IF90aGlzLCB0b29sOiB0b29sfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9zY3JpcHQgPSAocywgbSkgPT4gew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVuU2NyaXB0KGAob1Njb3BlLCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpID0+ICR7c31gKSg8JT1zY29wZSU+LCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIHdhcm4obS50ZXN0cy5sb2csIGV4KTsgDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9tYXRjaCA9IChzLCByKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHMpPT09J3VuZGVmaW5lZCcgfHwgcz09PW51bGwgfHwgdHlwZW9mKHMubWF0Y2gpIT09J2Z1bmN0aW9uJykgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSBzLm1hdGNoKG5ldyBSZWdFeHAociwgJ2cnKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHM9PXIgfHwgKChhbnN3ZXIgJiYgYW5zd2VyLmxlbmd0aCk/dHJ1ZTpmYWxzZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGNvbnN0IGNsb25lID0gaXRlbXMgPT4gaXRlbXMubWFwKGl0ZW0gPT4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGNsb25lKGl0ZW0pIDogaXRlbSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtcyA9IGNsb25lKCBbLi4uKHRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKV0gKTsgLy8gZG8gbm90IHRhbXBlciB3aXRoIHRoZSBtYXBwaW5ncywgZGVlcCBjbG9uZQ0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IE9iamVjdC5rZXlzKG0pLmZvckVhY2goayA9PiBtW2tdID0gdGhpcy5fcGFyYW1ldHJpemUobVtrXSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKSkpOw0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IG0udGVzdHMgPSB7DQogICAgICAgICAgICAgICAgYWN0aXZlOiA8JXZhbHVlT2YoIm0uYWN0aXZlIiklPiwgLy9fc2NyaXB0KG0uYWN0aXZlLCBtKSwNCiAgICAgICAgICAgICAgICBlbmFibGVkOiA8JXZhbHVlT2YoIm0uZW5hYmxlZCIpJT4sIC8vX3NjcmlwdChtLmVuYWJsZWQsIG0pLA0KICAgICAgICAgICAgICAgIGNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLA0KICAgICAgICAgICAgICAgIGNsYXNzOiBfbWF0Y2goY2xhc3NOYW1lLCBtLmNsYXNzTmFtZSksDQogICAgICAgICAgICAgICAgbW9kdWxlOiBfbWF0Y2gobW9kdWxlTmFtZSwgbS5tb2R1bGVOYW1lKSwNCiAgICAgICAgICAgICAgICBzRmllbGQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pLA0KICAgICAgICAgICAgICAgIHNTY3JpcHQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IHR5cGVvZihtW3NTY3JpcHRdKSE9PSd1bmRlZmluZWQnLA0KICAgICAgICAgICAgICAgIHNQYXRoOiB0eXBlb2YobVtzUGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGFyZ2V0OiB0eXBlb2YobVt0RmllbGRdIHx8IG1bdFNjcmlwdF0gfHwgbVt0UGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGV4dDogYCR7Y29kZX06JHtzRmllbGR9PT0+JHt0RmllbGR9YCwNCiAgICAgICAgICAgICAgICBsb2c6IGAke19sb2d9WyR7bS5jb250ZXh0fS8ke20uY2xhc3NOYW1lfV1gLA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBtcyA9IG1zLmZpbHRlcihtID0+IG0udGVzdHMuYWN0aXZlICYmIG0udGVzdHMuZW5hYmxlZCAmJiBtLnRlc3RzLmNvbnRleHQgJiYgbS50ZXN0cy5jbGFzcyAmJiBtLnRlc3RzLm1vZHVsZSAmJiAobS50ZXN0cy5zRmllbGQgfHwgbS50ZXN0cy5zU2NyaXB0IHx8IG0udGVzdHMuc1BhdGgpICYmIG0udGVzdHMudGFyZ2V0KS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHdlIG1pZ2h0IG5vdCB3b3JrIHdpdGggYWxsIG1zIGVudHJpZXMuIGxvZyBoZXJlIGlzIG9ubHkgYSBwcmV2aWV3IG9mIHdoYXQgbWlnaHQgd29yayEgKi8gJT4NCiAgICAgICAgICAgIC8vaWYobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZykubGVuZ3RoKSBsb2codGhpcy5fYmVhdXRpZnkobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZyksICdqYXZhc2NyaXB0JykpOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gew0KICAgICAgICAgICAgICAgIGlmKG1bdFNjcmlwdF0pew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0Q29uZF0pPT09J3VuZGVmaW5lZCcgfHwgPCV2YWx1ZU9mKCJtW3RDb25kXSIsICdfdGhpcycpJT4pew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZykgbG9nKG0udGVzdHMubG9nICsgJzogJyArIHRTY3JpcHQsICc8JT1tTmFtZSU+JywgbVt0U2NyaXB0XSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gPCV2YWx1ZU9mKCJtW3RTY3JpcHRdIiwgJ190aGlzJyklPg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bc1BhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJykgY29kZSA9IGptZXNwYXRoLnNlYXJjaChvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0ganNvbnBhdGgucXVlcnkob2JqRnJvbSwgbVtzUGF0aF0pOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdEZpZWxkXSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBkUGF0aCA9ICcnOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0RmllbGRdKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYCR7Y29kZX0ucmVwbGFjZWA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKG1bc0ZpZWxkXSwgJ2cnKSwgbVt0RmllbGRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29kZSA9IERvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5jb2RlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IG1bdEZpZWxkXTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGBkb3Rjb3B5YDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZyAmJiBkUGF0aCkgbG9nKGAke20udGVzdHMubG9nfS8ke2RQYXRofVtjb2RlPSR7Y29kZX1dOiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0Q29uZF0pKSkgb2JqVG9bbVt0RmllbGRdXSA9IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqc29ucGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGpzb25wYXRoLnF1ZXJ5KG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0ganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdFBhdGhdKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udGVzdHMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoY29kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0dXJuIG9ialRvOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL2lmKGNvbnRleHQ9PSdFbnRpdHlDbGFzcycgJiYgY2xhc3NOYW1lPT0nVXNlcicpIDwlPXdhcm4oKSU+IkdPVCBIRVJFIiwgY29kZSwgY29udGV4dCwgb3B0aW9ucyk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyYW1ldHJpemUoY29kZSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfbkNvZGUnJT4oY29kZSwgb0NvZGUpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOw0KICAgICAgICAgICAgaWYoIWNvZGUgJiYgIW9Db2RlKXsNCiAgICAgICAgICAgICAgICBjb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsNCiAgICAgICAgICAgICAgICBjb2RlID0gIjwlPW5Db2RlKGMpJT4iOw0KICAgICAgICAgICAgICAgIG9Db2RlID0gPCU9X0ZyRU1ELl90b0pTKGMuQ29kZSklPjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgbGV0IHJldCA9IGNvZGU7DQogICAgICAgICAgICBpZihvQ29kZSAmJiB0eXBlb2Yob0NvZGUpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCBvQ29kZVt0aGlzLlRvb2wudHlwZS5uYW1lXSB8fCByZXQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tYXAocmV0LCBmYWxzZSwgY29udGV4dCkgfHwgcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5leCk7DQogICAgICAgICAgICByZXR1cm4gY29kZTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX19jb25maWcnJT4obiwgbnVsbFZhbHVlLCBvcHRpb25zKXsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQogICAgICAgIG9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJzwlPW5OYW1lKGMpJT4nOw0KICAgICAgICBvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwgb3B0aW9ucy5fdGhpcy5Ub29sIHx8IHRoaXMuVG9vbDsNCiAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCk9PT0nb2JqZWN0JyAmJiBvcHRpb25zLnRvb2wuY29uc3RydWN0b3IubmFtZT09J1Rvb2wnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sLm5hbWUoKSk7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdzdHJpbmcnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sIHx8IHQudHlwZS5uYW1lPT1vcHRpb25zLnRvb2wpOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4obiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHtfdGhpczogdGhpcywgdG9vbDogdGhpcy5Ub29sLCBfY2xhc3M6ICc8JT1uTmFtZShjKSU+J30sIG9wdGlvbnMgfHwge30pKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpIT09J29iamVjdCcpIDwlPXdhcm4oKSU+b3B0aW9ucy50b29sKTsNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLnRvb2wpIDwlPXdhcm4oKSU+InRvb2wgbm90IGRlZmluZWQiLCBvcHRpb25zLl90aGlzLlRvb2wsIDwlPXNjb3BlJT4uVG9vbHMsIG9wdGlvbnMuX3RoaXMuVG9vbHMpOw0KICAgICAgICAgICAgLy9vcHRpb25zLm5vQ2FjaGUgPSB0cnVlOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+ID0gPCU9c2NvcGUlPi48JT1tTmFtZSU+IHx8IHt9Ow0KDQogICAgICAgICAgICBsZXQgbklEID0gPCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUuY29kZSgpOidkZWZhdWx0JzsNCg0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnNbbl0pIT09J3VuZGVmaW5lZCcpIG51bGxWYWx1ZSA9IG51bGxWYWx1ZSB8fCBvcHRpb25zW25dOw0KICAgICAgICAgICAgbGV0IHJldCA9IG51bGxWYWx1ZTsNCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG51bGw7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy8gdXNlIHNjb3BlIGNhY2hlIChpbXByb3ZlcyBwZXJmb3JtYW5jZT8/PykNCiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlICYmIE9iamVjdC5oYXNPd24oPCU9c2NvcGUlPi48JT1tTmFtZSU+LCBgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gKSkgcmV0dXJuIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gdG9vbF9Db25maWdzLCB0eXBlX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQ0KICAgICAgICAgICAgbGV0IHRjb25mID0gW10uY29uY2F0KG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncyB8fCBbXSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYyAmJiBjLm5hbWU9PW4gJiYgKCFjLm5vZGUgfHwgYy5ub2RlLmNvZGU9PW5JRCkpLnNvcnQoYyA9PiBjLm5vZGU/KGMubm9kZS5jb2RlPT0nZGVmYXVsdCc/MDotMSk6MSk7DQogICAgICAgICAgICBpZih0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgIGlmKHRjb25mWzBdLnNjcmlwdCl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnNjcmlwdDsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBfc2MgPSB0aGlzLl9wYXJhbWV0cml6ZSh0Y29uZlswXS5zY3JpcHQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJfc2MiKSU+Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXQgPSB0Y29uZlswXS52YWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgWzEsMiwzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsNCiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGpleCl7fQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmKG9wdGlvbnMubmV3VmFsdWUpew0KICAgICAgICAgICAgICAgIGxldCB0YyA9IHRjb25mLmxlbmd0aD90Y29uZlswXTp7fTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLm5vZGUpIHRjLm5vZGUgPSB7Y29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKX07DQogICAgICAgICAgICAgICAgdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgICAgIHRjLm5hbWUgPSBuOw0KICAgICAgICAgICAgICAgIGlmKCF0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MpLnB1c2godGMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nDQogICAgICAgICAgICBsZXQgbWNvbmYgPSBvcHRpb25zLl90aGlzLkNvbmZpZz9vcHRpb25zLl90aGlzLkNvbmZpZ1tuXTp1bmRlZmluZWQ7DQogICAgICAgICAgICBtY29uZiA9IHRoaXMuX3BhcmFtZXRyaXplKG1jb25mLCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICBtY29uZiA9IDwldmFsdWVPZigibWNvbmYiKSU+Ow0KICAgICAgICAgICAgaWYodHlwZW9mKG1jb25mKSE9PSJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsNCg0KICAgICAgICAgICAgLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KXsNCiAgICAgICAgICAgICAgICByZXQgPSBEb3RPYmplY3QucGljayhuLCBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKSkgfHwgcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHRoaXMuJF9SRVFVRVNUKSByZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIGNvbmZpZyByZXBsYWNlbWVudA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fcGFyYW1ldHJpemUocmV0LCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUpIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXSA9IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJyZXQiKSU+Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5uLCBudWxsVmFsdWUsIG9wdGlvbnMuX2NsYXNzLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KDQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgIC8qKg0KICAgICAqIFN1bW1hcnkuIDwlPW0uTmFtZSU+Lg0KICAgICAqDQogICAgICogRGVzY3JpcHRpb24uIDwlPW0uUmVtYXJrJT4uDQogICAgICoNCiAgICAgKiBAc2luY2UgICAgICB4LngueA0KICAgICAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuDQogICAgICogQGFjY2VzcyAgICAgcHVibGljDQogICAgICoNCiAgICAgKiBAY2xhc3MNCiAgICAgKiBAYXVnbWVudHMgcGFyZW50DQogICAgICogQG1peGVzICAgIG1peGluDQogICAgICoNCiAgICAgKiBAYWxpYXMgICAgcmVhbE5hbWUNCiAgICAgKiBAbWVtYmVyb2YgbmFtZXNwYWNlDQogICAgICoNCiAgICAgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24NCiAgICAgKiBAbGluayBVUkwNCiAgICAgKiBAZ2xvYmFsDQogICAgICoNCiAgICAgKiBAZmlyZXMgICBldmVudE5hbWUNCiAgICAgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQ0KICAgICAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4NCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4NCiAgICAgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4NCiAgICAgKg0KICAgICAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKg0KICAgICAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKi8NCiAgICA8JSBpZighbS5Jc1N5bmMpeyU+YXN5bmMgPCV9JT48JT1tTmFtZT1uQ29kZShtKSU+KDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBwLk5hbWUpLmpvaW4oJywgJyklPil7DQoNCiAgICAJbGV0IGxvZyA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JT1uQ29kZShtKSU+IiwgbnVsbCwgMCwgLi4ubXNnKTsNCiAgICAJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCU9bkNvZGUobSklPiIsIG51bGwsIDEsIC4uLm1zZyk7DQogICAgCWxldCBlcnJvciA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JT1uQ29kZShtKSU+IiwgbnVsbCwgMiwgLi4ubXNnKTsNCiAgICAJbGV0IG9TY29wZSA9IDwlPWFsaWFzKCklPjsNCiAgICAJbGV0IHBTY29wZSA9IDwlPXNjb3BlJT47DQogICAgICAgIA0KICAgIA0KPCUgaWYoIW0uSXNTeW5jKXslPg0KICAgIDwlIGlmKCFtLlJlc3BvbnNlQXR0cmlidXRlKXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IG51bGw7DQogICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUsIHRydWUpJT4oKTsNCiAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLklzQm9vbCl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBmYWxzZTsNCiAgICA8JSB9ZWxzZSBpZihtLklzQXJyYXkpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gW107DQogICAgPCUgfWVsc2V7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBudWxsOw0KICAgIDwlIH0gJT4NCiAgICANCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW5Db2RlKG0pJT4iLCA8JW1Sb3V0aW5nKGMsIG0pJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgDQo8JSB9JT4NCjwlIG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkRlZmF1bHQpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgaWYodHlwZW9mKDwlPW5OYW1lKHApJT4pPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgPCU9bk5hbWUocCklPiA9IDwldmFsdWVPZihwLkRlZmF1bHQpJT47DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICB2YXIgZXJyb3JzID0gew0KICAgICAgICA8JSAgW10uY29uY2F0KG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLlJlcXVpcmVkKS5tYXAocCA9PiAoew0KICAgICAgICAgICAgICAgIENvZGU6IGAke25OYW1lKHApfS1yZXF1aXJlZGAsDQogICAgICAgICAgICAgICAgRXJyb3I6IGAke25OYW1lKHApfSBpcyBhIHJlcXVpcmVkIFBhcmFtZXRlcmAsDQogICAgICAgICAgICAgICAgU2NyaXB0OiBgdHlwZW9mKCR7bk5hbWUocCl9KT09PSd1bmRlZmluZWQnYCwNCiAgICAgICAgICAgIH0pKSkuY29uY2F0KG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUpLm1hcChwID0+ICh7DQogICAgICAgICAgICAgICAgQ29kZTogYCR7bk5hbWUocCl9YCwNCiAgICAgICAgICAgICAgICBFcnJvcjogYCR7bk5hbWUocCl9IGlzIG5vdCBvZiB0eXBlICR7bk5hbWUocC5FbnRpdHlUeXBlKX1gLA0KICAgICAgICAgICAgICAgIFNjcmlwdDogYCghJHtuTmFtZShwKX0gJiYgJHtwLlJlcXVpcmVkPyd0cnVlJzonZmFsc2UnfSkgfHwgKCR7bk5hbWUocCl9ICYmICgke25OYW1lKHApfS5jb25zdHJ1Y3Rvci5uYW1lIT0nJHtuTmFtZShwLkVudGl0eVR5cGUpfScgfHwgJHtuTmFtZShwKX0uRW50aXR5Q2xhc3MuTmFtZSE9JyR7bk5hbWUocC5FbnRpdHlUeXBlKX0nKSlgLA0KICAgICAgICAgICAgfSkpKS5jb25jYXQobS5WYWxpZGF0b3JzIHx8IFtdKS5maWx0ZXIodiA9PiAhdi5JZ25vcmUpLmZvckVhY2godiA9PiB7ICU+DQogICAgICAgICAgICAiPCU9di5Db2RlJT4iOiAoKDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBwLk5hbWUpLmpvaW4oJywgJyklPikgPT4gew0KICAgICAgICAgICAgICAgIHRyeXsNCg0KICAgICAgICAgICAgICAgIDwlIGlmKHYuU2NyaXB0LmluZGV4T2YoJ3JldHVybiAnKTwwKXslPg0KICAgICAgICAgICAgICAgICAgICBsZXQgYW5zd2VyID0gDQogICAgICAgICAgICAgICAgPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgPCU9di5TY3JpcHQlPg0KICAgICAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT4iYW5zd2VyIiwgIjwlPXYuQ29kZSU+IiwgYW5zd2VyKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuc3dlcjsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJ2YWxpZGF0b3IiLCAiPCU9di5Db2RlJT4iLCBleCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSkoPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IHAuTmFtZSkuam9pbignLCAnKSU+KT8oJzwlPXYuRXJyb3IlPicgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKTonJywNCiAgICAgICAgPCUgfSkgJT4NCiAgICAgICAgfTsNCiAgICAgICAgT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7DQogICAgICAgIGlmKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKXsNCiAgICAgICAgICAgIE9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPntba106IGVycm9yc1trXX0pOw0KICAgICAgICAgICAgICAgIGRlbGV0ZSBlcnJvcnNba107DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIGlmKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiBlcnJvcnMsDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPW0uU2NyaXB0JT4NCiAgICAgICAgDQo8JSBpZighbS5Jc1N5bmMpeyU+DQogICAgICAgIH0sIHtfX2JlZm9yZVJ1bGVzOiBbPCUobS5NZXRob2RSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gci5CZWZvcmUpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgX19hZnRlclJ1bGVzOiBbPCUobS5NZXRob2RSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gci5BZnRlcikubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCA8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lICsgIjogIiArIHAuTmFtZSkuam9pbignLCAnKSU+fSk7DQogICAgICAgIA0KICAgICAgICANCiAgICAgICAgLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzDQogICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOw0KDQogICAgICAgIC8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8NCiAgICAgICAgbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgIGlmKF9fZXgpIHJldHVybiBfX2V4LnJldDsNCg0KICAgICAgICA8JT1tLlJlZHVjZSU+DQoNCiAgICAgICAgPCUgaWYobS5Jc0FycmF5IHx8IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheSl7JT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKHIgPT4gci5yZXQpLmZsYXQoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoP3Jlc3VsdHNbMF0ucmV0Om51bGw7DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfSU+DQo8JSB9JT4NCiAgICB9DQo8JSB9KTslPg0KDQo8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXNwb25zZUludGVyY2VwdG9yJyU+KGVycm9yLCB0KXsNCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KCkuPCU9bU5hbWUlPihlcnJvciwgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOw0KICAgICAgICAgICAgaWYgKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkgJiYgZXJyb3IucmVzcG9uc2UgJiYgZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgJiYgIW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgJiYgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbi5pbmRleE9mKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkpPjApIHsNCiAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAvLyBhd2FpdCAoZ2V0IHRoZSB0b2tlbiBvciByZWZyZXNoIGl0KQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pICsgIiAiICsgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdC5heGlvcyhvcmlnaW5hbFJlcXVlc3QpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3JlcXVlc3RJbnRlcmNlcHRvciclPihjb25maWcsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGNvbmZpZywgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHtoZWFkZXJzOiB7fX07DQogICAgICAgICAgICBjb25maWcubWV0YSA9IGNvbmZpZy5tZXRhIHx8IHt9Ow0KICAgICAgICAgICAgY29uZmlnLm1ldGEuY291bnRlciA9IDQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgcmVmcmVzaFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnJlZnJlc2gudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgYXV0aFR5cGUgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRoX3R5cGUiLCAiQmVhcmVyIiwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbi4iK2NvbmZpZy5tZXRob2QsIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgIGlmKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKTwwKXsNCiAgICAgICAgICAgICAgICBpZighdG9rZW4pew0KICAgICAgICAgICAgICAgICAgICBsZXQgYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoTWV0aG9kID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLm1ldGhvZCcsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZighdG9rZW5VcmkgJiYgIWF1dGhDb2RlICYmICFhdXRoTWV0aG9kICYmIHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFR5cGUgPSAnQmFzaWMnOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9idG9hKHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCjwlaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwlPW5zY29wZSU+Ll9ub2RlICYmICFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0iZ2V0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgb3IgbG9hZCBhIG5ldyBvYXV0aCBzdGF0ZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnN0YXRlIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeSh7dG9vbDogdC5uYW1lLCBuY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpfSkpfSk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBhdXRob3JpemUgYW5kIGdldCB0aGUgYXV0aCBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7YXV0aFVyaX1gKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGF1dGhVcmkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChudWxsLCB0b29sID0+IDwlPW5zY29wZSU+Ll9ub2RlICYmIGNvbmZpZy5tZXRhLmNvdW50ZXItLSAmJiAhKGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKSwgMC4xLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gRG9uZSBMb29waW5nOiAke2F1dGhDb2RlfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWF1dGhDb2RlKSBhdXRoTWV0aG9kPXVuZGVmaW5lZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KPCV9JT4NCg0KICAgICAgICAgICAgICAgICAgICBpZihhdXRoTWV0aG9kKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmbG93ID0gKCFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0ncG9zdCcpPydhdXRob3JpemUnOid0b2tlbic7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIHRva2VuDQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdG9rZW5VcmkgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5VcmkgPSB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LnVyaWAsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHRva2VuVXJpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5tZXRob2RgLCAncG9zdCcsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb250ZW50LVR5cGUiOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmNvbnRlbnRfdHlwZWAsICJ0ZXh0L2pzb24iLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQXV0aG9yaXphdGlvbiI6ICJCYXNpYyAiK3RoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7dG9vbDogdH0pICsgIjoiICsgdGhpcy5fX2NvbmZpZygib2F1dGgucGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmhlYWRlcnNgLCAie30iLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0cmVzID0gYXdhaXQgdC5heGlvcyh0Y29uZmlnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gVG9rZW4gZmV0Y2hlZCAtICR7Zmxvd31gLCB0Y29uZmlnLCB0cmVzLmRhdGEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgWydhY2Nlc3NfdG9rZW4nLCAndG9rZW5fdHlwZScsICdleHBpcmVzX2luJywgJ3JlZnJlc2hfdG9rZW4nXS5mb3JFYWNoKHRhID0+IHRoaXMuX19jb25maWcoYG9hdXRoLiR7dGF9YCwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdHJlcy5kYXRhW3RoaXMuX19jb25maWcoYG9hdXRoLnRva2VuLnJlc3BvbnNlLiR7dGF9YCwgdGEsIHt0b29sOiB0fSldfSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYXV0aFR5cGUgKyAiICIgKyB0b2tlbjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bG9nKCklPmNvbmZpZyk7DQogICAgICAgIHJldHVybiBjb25maWc7DQogICAgPCUgfSU+DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXN0JyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyl7DQogICAgICAgIC8qIHROYW1lIG5vIGxvbmdlciByZXF1aXJlZCEhICovDQogICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge190aGlzOiB0aGlzfTsNCiAgICAgICAgb3B0aW9ucy50TmFtZSA9IG9wdGlvbnMudE5hbWUgfHwgdE5hbWU7DQogICAgICAgIA0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307DQogICAgICAgIG1ldGhvZCA9IG1ldGhvZCB8fCAoZGF0YT8icG9zdCI6ImdldCIpOw0KICAgICAgICANCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KC8qbnVsbCwgdGhpcy5Ub29sKi8pLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmZvcm0pew0KICAgICAgICAgICAgICAgIGxldCBmZCA9IG5ldyBGb3JtRGF0YSgpOw0KICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goayA9PiBmZC5hcHBlbmQoaywgZGF0YVtrXSkpOw0KICAgICAgICAgICAgICAgIGRhdGEgPSBmZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGxldCBjb25maWcgPSB7DQogICAgICAgICAgICAgICAgdXJsOiB0aGlzLl9fY29uZmlnKG9wdGlvbnMudXJsIHx8IGByZXN0YXBpLnVybC4ke21ldGhvZH1gLCB0aGlzLl9fY29uZmlnKG9wdGlvbnMudXJsIHx8ICdyZXN0YXBpLnVybCcsIG9wdGlvbnMucGF0aCArIG9wdGlvbnMuZmlsZSwgb3B0aW9ucyksIG9wdGlvbnMpLA0KICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLA0KICAgICAgICAgICAgICAgIHBhcmFtczogcGFyYW1zLA0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24odGhpcy5fX2NvbmZpZygncmVzdGFwaS5oZWFkZXJzLicrbWV0aG9kLCB0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMnLCB7fSwgb3B0aW9ucyksIG9wdGlvbnMpLCBvcHRpb25zLmhlYWRlcnMgfHwge30pLA0KICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsDQogICAgICAgICAgICAgICAgdmFsaWRhdGVTdGF0dXM6IHN0YXR1cyA9PiBzdGF0dXM8NDAwLA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgPCU9bG9nKCklPmBbTElWRToke3RoaXMuX19jb25maWcoJ2xpdmUnLCB0cnVlKX1dYCwgY29uZmlnKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpKXsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodGhpcy5Ub29sLmF4aW9zKSE9PSd1bmRlZmluZWQnIHx8IHR5cGVvZihheGlvcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IChhd2FpdCAoKHRoaXMuVG9vbC5heGlvcyB8fCBheGlvcykpKGNvbmZpZykpLmRhdGE7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IChhd2FpdCBmZXRjaChjb25maWcudXJsLCBjb25maWcpKS5qc29uKCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImF4aW9zIG5vdCBkZWZpbmVkISwgdXNpbmcgZmV0Y2giLCByZXQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlPWxvZygpJT5KU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9IC8vIG1haW5DbGFzcyhfcmVzdFRvb2xzKSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU1FMVGFibGUnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCBkZXBzOiB7fSwgc3FsOiBgYCwgZmllbGRzOiBgYH0sIHsNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgX19oZWFkZXI6IG9iaiA9PiBvYmouc3FsID0gYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKCR7b2JqLmZpZWxkc30vKjwlPW5OYW1lKGMpJT4qLyk7XG5gLA0KICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e3NxbDogdi5vYmouc3FsICs9IGAvKjwlPW5OYW1lKGMpJT46IHJldXNlZDogJHt2LnJldXNlZH0qL1xuXG5gLCBJZDogdi5vYmouSWR9LA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLmZpZWxkcyArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAsJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIjwlPV9GckVNRC5fYXR0cihlYSklPiIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQuZGVwcyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldC5kZXBzW2tdKT09PSdzdHJpbmcnKS5tYXAoayA9PiByZXQuZGVwc1trXSkuam9pbignXG5cbicpICsgcmV0LnNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tU1FMVGFibGUnJT4odGFibGUsIGZpZWxkcyl7DQogICAgICAgIC8vIHRhYmxlIGlzIGEganNvbiBhcnJheQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9bk5hbWUoZWEpJT4iKSkgfHwgIWZpZWxkcyl7DQogICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHRhYmxlWyI8JT1uQ29kZShlYSklPiJdKTsNCiAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3NxbCclPihzcWwsIF90aGlzKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgIDwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9zcWxUb29scykpJT4oKS48JT1tTmFtZSU+KHNxbCwgX3RoaXMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+c3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoc3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIHNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGlmKChzcWwubWF0Y2goL1woL2cpIHx8IFtdKS5sZW5ndGghPShzcWwubWF0Y2goL1wpL2cpIHx8IFtdKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJpbmNvcnJlY3Qgc3FsIiwgc3FsKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgICAgIGxldCBfb2sgPSAoX3JldCwgX3NxbCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoX3JldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRiID0gdGhpcy5Ub29sLmRiOw0KICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOw0KICAgIA0KICAgICAgICAgICAgICAgIGxldCBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgICAgIHFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKT49MDsNCg0KICAgICAgICAgICAgICAgIGlmKGJRdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIC8vIHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ2FsbCc7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIERNTA0KICAgICAgICAgICAgICAgICAgICBpZihbJ215c3FsJywgJ3Bvc3RncmVzJ10uaW5kZXhPZih0eXBlKT49MCkgZnVuID0gJ3F1ZXJ5JzsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZT09J3NxbGl0ZScpIGZ1biA9ICdydW4nOw0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfb2soMCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICBpZihmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7dHlwZX0uJHtmdW59YCwgc3FsKTsNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChmdW4pIHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0icG9zdGdyZXMiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsKS50aGVuKHJvd3MgPT4gX29rKHJvd3MsIHNxbCkpLmNhdGNoKHJldEV4ID0+IHJlamVjdChyZXRFeCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3Nub3dmbGFrZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRiLmV4ZWN1dGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgc3FsVGV4dDogc3FsLA0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3NxbGl0ZScpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIHRoZSBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGIuZXhlYyhzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgICAgICAgICBfb2socmV0LCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlPT0ncXVlc3RkYicpew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0KG51bGwsIHtxdWVyeTogc3FsfSkudGhlbihyID0+IF9vayhyLCBzcWwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmANCkVSUk9SOg0KJHtleH0NCg0KV2hpbGUgU2VuZGluZyBRdWVyeSANCiR7c3FsfQ0KYCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgcmV0LnJvd3MpIHJldCA9IHJldC5yb3dzOyAgICAgICAgDQogICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSl7JT4NCjwlDQpsZXQgX3RvVHlwZUFUID0gZWEgPT4gew0KICAgIGxldCByZXQgPSB7bmFtZTogbk5hbWUoZWEpLCBkZXNjcmlwdGlvbjogZWEuTmFtZSwgdHlwZTogInNpbmdsZUxpbmVUZXh0In07DQogICAgaWYoZWEuSXNCb29sKXsNCiAgICAgICAgcmV0LnR5cGUgPSAiY2hlY2tib3giOw0KICAgICAgICByZXQub3B0aW9ucyA9IHsNCiAgICAgICAgICAgIGNvbG9yOiAiZ3JlZW5CcmlnaHQiLA0KICAgICAgICAgICAgaWNvbjogImNoZWNrIg0KICAgICAgICB9Ow0KICAgIH0NCiAgICBpZihlYS5Jc0RhdGUpew0KICAgICAgICByZXQudHlwZSA9ICJkYXRlVGltZSI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgZGF0ZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICdpc28nDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICcyNGhvdXInLA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRpbWVab25lOiAndXRjJywNCiAgICAgICAgfTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJldDsNCn07DQolPg0KICAgIDwlPW1OYW1lPSdfdG9BVFRhYmxlJyU+KGxldmVsKXsNCiAgICAgICAgbGV0IHJldCA9IFt7DQogICAgICAgICAgICBuYW1lOiAnPCU9bk5hbWUoYyklPicsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICBmaWVsZHM6IFsNCiAgICAgICAgICAgICAgICB7bmFtZTogdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCBkZXNjcmlwdGlvbjogJ0lEJywgdHlwZTogJ3NpbmdsZUxpbmVUZXh0J30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPjwlPV9GckVNRC5fdG9KUyhfdG9UeXBlQVQoZWEpKSU+LDwlIH0pJT5dLA0KICAgICAgICB9XTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQucHVzaChuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5zcWwpOw0KICAgICAgICByZXR1cm4gcmV0LnNxbDsNCg0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKCh0YWcsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KHQgPT4gdC5uYW1lID09IHRhZy5uYW1lKSA9PSBpbmRleCk7DQogICAgICAgIDwlPWxvZygpJT5yZXQsIGxldmVsKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0FURnVuY3Rpb24nJT4oKXsNCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0uYDsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2Z1bjogIiJ9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSIsDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgKCR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIgYW5kIC8qPCU9dGFOYW1lJT4qLyAiOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJOT1QgRVhJU1RTIjsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke3RoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgIklOIn1gOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIgKCIgKyAodiB8fCBbXSkubWFwKHQgPT4gKHQgJiYgdC48JT1tTmFtZSU+KT90LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIik6KHQgfHwgJ05VTEwnKSkuam9pbignIFVOSU9OIEFMTC8qTTJNKi8gJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2FpcnRhYmxlJyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQWlyVGFibGUnXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydBaXJUYWJsZSddKSklPigpLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0TmFtZSA9IHROYW1lIHx8IDwlPV9uQ29kZSgpJT47DQogICAgICAgICAgICBsZXQgcmV0ID0gKGF3YWl0IGF4aW9zLnJlcXVlc3Qoew0KICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5fX2NvbmZpZygnZW5kcG9pbnRVcmwnKX0ke3ROYW1lfWAsDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2Q/bWV0aG9kOihkYXRhPyJwb3N0IjoiZ2V0IiksDQogICAgICAgICAgICAgICAgcGFyYW1zOiB7DQogICAgICAgICAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogcGFyYW1zLA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXgucmVzcG9uc2UuZGF0YSwgbnVsbCwgNCkpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19maWxlc3lzdGVtJyU+KGZpbGUsIGNvbnRlbnQsIG9iaj10aGlzKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSksIHRydWUpJT4oKS48JT1tTmFtZSU+KGZpbGUsIGNvbnRlbnQsIG9iaik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIWZpbGUpIHJldHVybiBudWxsOw0KDQogICAgICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgICAgICBsZXQgcGF0aCA9IG9iai5fX2NvbmZpZyhgcGF0aC4ke2NvbnRlbnQ/J3dyaXRlJzoncmVhZCd9YCwgKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCc/Jy4vZGIvJzonaHR0cHM6Ly97e293bmVyfX0uZ2l0aHViLmlvLycpKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYob2JqLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihjb250ZW50KSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgLy8gd3JpdGUNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBmcy5wcm9taXNlcy5ta2RpcigocGF0aCArIGZpbGUpLnJlcGxhY2UoLyguKlwvKS4qL2csICckMScpLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGdsb2JhbC5mcy53cml0ZUZpbGVTeW5jKHBhdGggKyBmaWxlLCB0eXBlb2YoY29udGVudCk9PT0nb2JqZWN0Jz8vKnRoaXMuX2J0b2EoKi9KU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCAnXHQnKS8qKSovOmNvbnRlbnQpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkNhbm5vdCB3cml0ZSB0byBmaWxlIHN5c3RlbSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoZmlsZS5lbmRzV2l0aCgnLycpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4ic2ltdWxhdGVkIGRpcmVjdG9yeSBsaXN0aW5nLi4uLiIsIGZpbGUpOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSBbIkVNUyBXZWIiXTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgLy8gcmVhZA0KICAgICAgICAgICAgICAgICAgICBpZihwYXRoLnN0YXJ0c1dpdGgoJ2h0dHAnKSAmJiBwYXRoLmluZGV4T2YoJzovLycpPjApew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdCh1bmRlZmluZWQsIG51bGwsIG51bGwsIG51bGwsIHt1cmw6ICdwYXRoLnJlYWQnLCBmaWxlLCBwYXRofSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsLmZzLmV4aXN0c1N5bmMocGF0aCArIGZpbGUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGdsb2JhbC5mcy5yZWFkRmlsZVN5bmMocGF0aCArIGZpbGUpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSByZXQ/KHJldC5kYXRhIHx8IHJldCk6cmV0Ow0KICAgICAgICAgICAgPCU9bG9nKCklPmBbJHtvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKT8nJzonTk9UICd9TElWRXwke3R5cGVvZihjb250ZW50KSE9PSd1bmRlZmluZWQnPyd3cml0ZSc6J3JlYWQnfV0ke3BhdGggKyBmaWxlfTogJHsocmV0IHx8ICcnKS5sZW5ndGh9YCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhfZmlsZVRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX2ZpbGVOYW1lJyU+KF9jbGFzcz08JT1fbkNvZGUoKSU+LCBvYmo9dGhpcywgYWxpYXM9IjwlPWFsaWFzKCklPiIpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfZmlsZVRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhfZmlsZVRvb2xzKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oX2NsYXNzLCBvYmosIGFsaWFzPSI8JT1hbGlhcygpJT4iKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICA8JT1sb2coKSU+b2JqLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogdHJ1ZSwgbm9PcGVyYXRvcnM6IHRydWV9LCAnPCU9bU5hbWUlPicpLl90aGlzKTsNCg0KICAgICAgICAgICAgbGV0IGZOYW1lID0gT2JqZWN0LnZhbHVlcyhvYmouX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub09wZXJhdG9yczogdHJ1ZX0sICc8JT1tTmFtZSU+JykuX3RoaXMpLmpvaW4oJ19fJyk7DQogICAgICAgICAgICBpZihmTmFtZSkgZk5hbWUrPScuanNvbic7DQogICAgICAgICAgICByZXR1cm4gKG9iai5fX2NvbmZpZygnc3RvcmUucm9vdCcsICc8JT1zY29wZSU+LycpICsgYCR7YWxpYXMuc3BsaXQoJy4nKS5zbGljZSgxKS5qb2luKCcvJyl9LyR7X2NsYXNzfS8ke2ZOYW1lfWApLnJlcGxhY2UoL1wvXC8vZywgJy8nKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydHaXRIdWInXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19naXRodWInJT4oZmlsZSwgY29udGVudCwgaWQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0dpdEh1YiddKSklPihudWxsLCB0aGlzLlRvb2wpLjwlPW1OYW1lJT4oZmlsZSwgY29udGVudCwgaWQpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFmaWxlKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHNoYTEgPSBhc3luYyBzdHIgPT4gdHlwZW9mKGNyeXB0by5zdWJ0bGUpIT09J3VuZGVmaW5lZCc/QXJyYXkuZnJvbShuZXcgVWludDhBcnJheShhd2FpdCBjcnlwdG8uc3VidGxlLmRpZ2VzdCgnU0hBLTEnLCBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoJ2Jsb2IgJyArIG5ldyBCbG9iKFtzdHJdKS5zaXplICsgJ1x4MDAnICsgc3RyKSkpKS5tYXAodiA9PiB2LnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpKS5qb2luKCcnKTpzdHIuc3Vic3RyaW5nKDAsIDEwKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBudWxsLCBjb250ZW50P0pTT04uc3RyaW5naWZ5KHsNCiAgICAJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgPCU9bU5hbWUlPigpIiwNCiAgICAJCQlzaGE6IGlkIHx8IGNvbnRlbnRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwNCiAgICAJCQljb250ZW50OiB0aGlzLl9idG9hKHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnP0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpOmNvbnRlbnQpLA0KICAgIAkJfSk6bnVsbCwgY29udGVudD8ncHV0JzpudWxsLCB7DQogICAgCQkgICAgZmlsZSwNCiAgICAJCX0pOw0KICAgIAkJDQogICAgCQlpZighcmV0KSByZXR1cm4gcmV0Ow0KICAgIAkJDQogICAgCQlyZXQgPSBjb250ZW50P3JldC5jb250ZW50OnJldDsNCiAgICAJCWlmKGZpbGUuaW5kZXhPZignaW5kZXgubWQnKT49MCkgcmV0dXJuIHJldDsNCiAgICAJCQ0KICAgIAkJaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAJCSAgICAvLyBpbiBjYXNlIHdlIGFyZSBsaXN0aW5nIHRoZSBjb250ZW50cyBvZiBhIGZvbGRlciByZXNvdXJjZQ0KICAgIAkJICAgIHJldHVybiByZXQubWFwKHIgPT4gci5uYW1lLnJlcGxhY2UoJy5qc29uJywgJycpKTsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJbGV0IF90aGlzID0ge307DQogICAgCQlpZihyZXQuc2hhKXsNCiAgICAJCSAgICBfdGhpcyA9IHJldC5jb250ZW50P0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpOnt9Ow0KICAgIAkJICAgIF90aGlzW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0gPSByZXQuc2hhOyAvLz8/DQogICAgCQl9ZWxzZSBpZihyZXRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSl7DQogICAgCQkgICAgLy88JT13YXJuKCklPidzaGExJywgZmlsZSwgYXdhaXQgc2hhMShKU09OLnN0cmluZ2lmeShyZXQpKSk7DQogICAgCQkgICAgX3RoaXMgPSByZXQ7DQogICAgCQl9DQogICAgCQkNCiAgICAJCTwlPWxvZygpJT5maWxlLCBjb250ZW50PydwdXQnOidnZXQnLCBfdGhpcyk7DQogICAgICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2FsZXNGb3JjZSddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU0ZRdWVyeSclPihmaWVsZHMsIG9ianMsIGJTdHJpbmcpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7WzwlPV9uQ29kZSgpJT5dOiB7cGFyYW1zOiB7d2hlcmU6IHthbmQ6IFtdLCBvcjogW119fSwgZWRnZXM6IHtub2RlOiB7fX19fSwgew0KICAgICAgICAgICAgLy9PUEVSQVRPUlM6IHRydWUsDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbPCU9X25Db2RlKCklPl0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHtJZDoge2VxOiB2fX0pLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IG9wID0gJ2VxJzsNCiAgICAgICAgICAgICAgICBsZXQgY29uZCA9IHtbZWFDb2RlXToge1tvcF06IA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnE6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcGlOYW1lOiAnSWQnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFs8JT1fbkNvZGUoZWEuRW50aXR5VHlwZSklPl06IHY/di48JT1tTmFtZSU+KClbPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT5dLnBhcmFtcy53aGVyZS5hbmQ6W10sDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgKHY/di50b0lTT1N0cmluZygpOm51bGwpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIHYNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfX07DQogICAgICAgICAgICAgICAgb2JqWzwlPV9uQ29kZSgpJT5dLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICAvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOw0KICAgICAgICANCiAgICAgICAgaWYoYlN0cmluZyl7DQogICAgICAgICAgICByZXQgPSB7cXVlcnk6IHtbPCU9X25Db2RlKCklPiArICdRdWVyeSddOiB7dWlhcGk6IHtxdWVyeTogcmV0fX19fTsNCiAgICAgICAgICAgIHJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2VydmljZU5vdyddKSl7JT4NCiAgICA8JQ0KICAgIGxldCBfaWQgPSBzID0+IC8qcz9zOiovYHRoaXMuX3V1aWQoJHtzfHx1bmRlZmluZWR9KS5yZXBsYWNlKC8tL2csICcnKWA7DQogICAgbGV0IF90aWQgPSBfYyA9PiBfaWQoIiciK3Njb3BlKyIuIisgKF9jIHx8IGMpLk5hbWUgKyAiJyIpOw0KICAgIGxldCBhcHAgPSAoKSA9PiB7JT5hcHBsaWNhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLmNvZGUodGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpKSk8JX07DQogICAgDQogICAgbGV0IGxhYmVsID0gKHQsIG4sIGMsIHApID0+IHtuPXNyLkVuZ2xpc2hOYW1lKG4pOyAlPi48JT10JT5fRmllbGRfTGFiZWxzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0ZpZWxkIExhYmVsJywgdHJ1ZSklPig8JT1faWQoKSU+KS5yZW1hcmsoJzwlPW4lPicpLm5hbWUoJzwlPW4lPicpLmNvZGUoPCU9YyU+KS5sYW5ndWFnZSgnZW4nKS5wbHVyYWwoJzwlPShwIHx8IChuICsgJ3MnKSklPicpLjwlYXBwKCklPl0pPCV9OyU+DQoNCiAgICA8JT1tTmFtZT0nX3RvU05UYWJsZSclPigpew0KICAgICAgICAvL3RoaXMuX2RlZmF1bHRzKCk7DQoNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVGFibGUnLCB0cnVlKSU+KDwlPV90aWQoKSU+KS5jb2RlKDwlPV9uQ29kZSgpJT4pLjwlYXBwKCklPi5uYW1lKCc8JT1jLk5hbWUlPicpLnJlbWFyayhgPCU9Yy5SZW1hcmslPmApLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLCB7DQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai50YWJsZV9Db2x1bW5zKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29sdW1uJywgdHJ1ZSklPig8JT1faWQoIiciK3Njb3BlKyIuIitjLk5hbWUrIicrZWFDb2RlIiklPikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiIpLmNvZGUoZWFDb2RlKS50eXBlKCc8JT1fRnJFTUQuX2F0dHIoZWEpJT4nKS5yZWZlcmVuY2UoPCVpZihlYS5FbnRpdHlUeXBlKXslPih2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4oKTwlfWVsc2V7JT5udWxsPCV9JT4pLyo8JWxhYmVsKCdjb2x1bW4nLCBlYS5OYW1lLCAnZWFDb2RlJywgZWEuUGx1cmFsKSU+Ki8pLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5yZWZlcmVuY2VfQ29sdW1ucyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbHVtbicsIHRydWUpJT4oKS5hY3RpdmUoZmFsc2UpLmVuYWJsZWQodHJ1ZSkuY29kZShlYUNvZGUpLnR5cGUoJ0xpc3QnKS5uYW1lKCI8JT1uTmFtZSh0YSklPiA8JT10YS5FbnRpdHlDbGFzcy5QbHVyYWwlPiIpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpLyo8JWxhYmVsKCdjb2x1bW4nLCB0YS5OYW1lKycgJyt0YS5FbnRpdHlDbGFzcy5QbHVyYWwsICdlYUNvZGUnLCB0YS5FbnRpdHlDbGFzcy5QbHVyYWwpJT4qLyksDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TTkZsb3cnJT4oYkRyYWZ0LCBiSGVhZGVyKXsNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgPCUgbGV0IGJPcmRlciA9IDE7IGxldCBfZmlkID0gX2MgPT4gX2lkKCInIitzY29wZSsiLicgKyAoYkRyYWZ0PydkJzoncycpICsgJ2wiKyAoX2MgfHwgYykuTmFtZSArICInIik7DQogICAgICAgIGxldCBsb2dpYyA9IChuLCB0LCBtYXA9W10pID0+IHslPg0KICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IExvZ2ljJywgdHJ1ZSklPig8JT1faWQoKSU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSgnPCU9biU+JykucmVtYXJrKCc8JT1uJT4nKQ0KICAgICAgICAgICAgICAgIC5ibG9jayhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgQmxvY2snLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoPCU9X2lkKCklPikubmFtZSgnPCU9biU+JykNCiAgICAgICAgICAgICAgICAgICAgLmJsb2NrX0VsZW1lbnRfTWFwcGluZ3MoWzwlIG1hcC5maWx0ZXIobSA9PiBtKS5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgiPCU9biU+IC0gIiArIDwlPW0uY2QlPikuY29kZSg8JT1tLmNkJT4pLnZhbHVlKDwlPW0udiU+KTwlcENvbXBvdW5kKG0udiwgbS50cm4pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlfSklPl0pDQogICAgICAgICAgICAgICAgKS5kZWZpbml0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTG9naWMgRGVmaW5pdGlvbicsIHRydWUpJT4oJzwlPXQlPiA8JT1uJT4nKS5jb2RlKCc8JT10JT4nKS5uYW1lKCc8JT10JT4nKSkuPCVhcHAoKSU+DQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgYWN0aW9uID0gKGFDb2RlLCBwYXJhbXM9e30pID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIEluc3RhbmNlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKHRoaXMuX3V1aWQoKSkuYWN0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIFR5cGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWFDb2RlJT4nKSkub3JkZXIoPCU9Yk9yZGVyKyslPikuPCVhcHAoKSU+DQogICAgICAgICAgICAuYWN0aW9uX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5hY3Rpb25JbnB1dCgNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBY3Rpb24gSW5wdXQnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykNCiAgICAgICAgICAgICAgICApLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoIiIpKSwNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pDQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgc3ViZmxvdyA9IChmbG93LCBwYXJhbXM9e30sIGJOb1dhaXQpID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnN0YW5jZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSh0aGlzLl91dWlkKCkpLnN1YmZsb3coPCU9ZmxvdyU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS48JWFwcCgpJT4NCiAgICAgICAgICAgIDwlIGlmKCFiTm9XYWl0KXslPg0KICAgICAgICAgICAgLmluc3RhbmNlX0Zsb3dfSW5zdGFuY2VfSW5wdXRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5zdGFuY2UgSW5wdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS5uYW1lKCdXYWl0IGZvciBDb21wbGV0aW9uJykudHlwZSgnQm9vbCcpXSkNCiAgICAgICAgICAgIC5pbnN0YW5jZV9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS52YWx1ZSgnMScpDQogICAgICAgICAgICAgICAgICAgIC5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKSkNCiAgICAgICAgICAgIF0pDQogICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgLmluc3RhbmNlX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5mbG93SW5wdXQoDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKQ0KICAgICAgICAgICAgICAgICkubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikpDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKQ0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IHBDb21wb3VuZCA9ICh2LCB0cm4pID0+IHtpZighdHJuKSByZXR1cm47ICU+LmVsZW1lbnRNYXBwaW5nX1BpbGxfQ29tcG91bmRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1BpbGwgQ29tcG91bmQnLCB0cnVlKSU+KHRoaXMuX3V1aWQoKSkuY29kZSgnJykubmFtZSg8JT12JT4pLm9yZGVyKDApLyoucmVtYXJrKHRoaXMuX2J0b2EoYDwlPUpTT04uc3RyaW5naWZ5KFtdKSU+YCkpKi8uPCVhcHAoKSU+DQogICAgICAgICAgICAucGFyZW50X1BpbGxfQ29tcG91bmRzKFsNCiAgICAgICAgICAgIDwlIE9iamVjdC5rZXlzKHRybikuZm9yRWFjaCgodCwgaSkgPT4geyU+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUGlsbCBDb21wb3VuZCcsIHRydWUpJT4odGhpcy5fdXVpZCgpKS5jb2RlKCI8JT10JT4iKS5vcmRlcig8JT1pKzElPikubmFtZSg8JT12JT4pLnJlbWFyayh0aGlzLl9idG9hKGA8JT1KU09OLnN0cmluZ2lmeSh0cm5bdF0pJT5gKSkuPCVhcHAoKSU+LyoudHJhbnNmb3JtKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVHJhbnNmb3JtJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT10JT4nKS50cmFuc2Zvcm1fVHJhbnNmb3JtX0NvbXBvc2l0aW9ucyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUcmFuc2Zvcm0gQ29tcG9zaXRpb24nLCB0cnVlKSU+KCkuY29kZSgnJyldKSkqLywNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pXSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAqIE9PQiBFbmRwb2ludDogaHR0cHM6Ly9kZXYxNjI1NzAuc2VydmljZS1ub3cuY29tL2FwaS9ub3cvcHJvY2Vzc2Zsb3cvZmxvd29iamVjdC9zdGFydC9zdWJmbG93DQogICAgICAgICAgICAgKiBQYXlsb2FkOiB7Im5hbWUiOiJ4Xzc4NjExX3NjaG9vbF9tYW4uVXNlcl9sb29rdXAiLCJpbnB1dHMiOnsianNvbiI6eyJuYW1lIjoidGVzdCIsImdlbmRlciI6eyJjb2RlIjoiTSIsICJPUEVSQVRPUlMiOiB7ImNvZGUiOiAiIT0ifX0sInVzZXJfU3R1ZGVudHMiOlt7Im5hbWUiOiJTVEEiLCJnZW5kZXIiOnsiY29kZSI6Ik0ifX1dfX19DQogICAgICAgICAgICAqLw0KDQogICAgICAgICAgICBsZXQgZmxvdyA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdycsIHRydWUpJT4oPCU9X2ZpZCgpJT4pLm5hbWUoJzwlPWMuTmFtZSU+IExvb2t1cCcpLmNvZGUoPCU9X25Db2RlKCklPiArICdfbG9va3VwJykuPCVhcHAoKSU+LmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpOw0KICAgICAgICAgICAgaWYoYkhlYWRlcikgcmV0dXJuIGZsb3c7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KGZsb3cvKi5fZGVmYXVsdHMoKSovDQogICAgICAgICAgICAgICAgLmZsb3dfRmxvd19TZXR0aW5ncyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFNldHRpbmcnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ0FDVElPTicpXSkNCiAgICAgICAgICAgICAgICAuZmxvd19GbG93X0lucHV0cyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2pzb24nKS5uYW1lKCdKU09OJykudHlwZSgnSlNPTicpPCVsYWJlbCgnaW5wdXQnLCAnSlNPTicsICInanNvbiciKSU+DQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X091dHB1dHMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgT3V0cHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSg8JT1fbkNvZGUoKSU+ICsgJ19saXN0JykubmFtZSgnPCU9bk5hbWUoYyklPiBMaXN0JykudHlwZSgnTGlzdCcpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RhYmxlJywgdHJ1ZSklPigiPCU9bk5hbWUoYyklPiIpLm5hbWUoJzwlPWMuTmFtZSU+JykuY29kZSg8JT1fbkNvZGUoKSU+KS48JWFwcCgpJT4pDQogICAgICAgICAgICAgICAgICAgIDwlbGFiZWwoJ291dHB1dCcsIGMuTmFtZSArICcgTGlzdCcsIF9uQ29kZSgpICsgIisgJ19saXN0JyIpJT4NCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfVmFyaWFibGVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSgnanNvbicpLm5hbWUoJ0pTT04nKS50eXBlKCdKU09OJyk8JWxhYmVsKCd2YXJpYWJsZScsICdKU09OJywgJyJqc29uIicpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2VxdWVyeScpLm5hbWUoJ0VRdWVyeScpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCAnRVF1ZXJ5JywgJyJlcXVlcnkiJyklPiwNCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnU2V0ICcgKyBjLk5hbWUgKyAnIEpTT04nLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidqc29uJyIsIHY6ICIne3tzdWJmbG93Lmpzb259fScifV0pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlIC8vICwgdHJuOiB7cmVwbGFjZV9zdHJpbmc6IHtyZWdleDogIi8vZyIsIHJlcGxhY2Vfc3RyaW5nOiAiIn19JT4NCiAgICAgICAgICAgICAgICBdKS5zZWN1cml0eUNvbnRyb2wobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBDb250cm9sJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCdzeXNfaHViX2Zsb3cnKS5uYW1lKGBzeXNfc2NvcGUuc2NvcGU9JHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9YCkudHlwZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IFR5cGUnLCB0cnVlKSU+KCkuY29kZSgnY2xpZW50X2NhbGxhYmxlX2Zsb3dfb2JqZWN0JykpLm9wZXJhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IE9wZXJhdGlvbicsIHRydWUpJT4oKS5jb2RlKCdleGVjdXRlJykpLjwlYXBwKCklPiksIHsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvL2V4cG9ydGVyOiB2ID0+IHYub2JqID0gdi5yZXVzZWQ/bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93JywgdHJ1ZSklPih2Lm9iai5JZCk6di5vYmosIC8qaW5mb3JtYXRpb24gbG9zcyovDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgTnVsbDogIWJIZWFkZXIsDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmo8JWlmKDAgfHwgKFsnbmFtZScsICdyZW1hcmsnLCAnZGF0ZScsICdvcmRlcicsICdhY3RpdmUnLCAnZW5hYmxlZCddLmluZGV4T2YoZWEuTmFtZSk8MCkpeyU+LmZsb3dfRmxvd19WYXJpYWJsZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoZWFDb2RlKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+JykudHlwZSg8JSBpZihlYS5FbnRpdHlUeXBlKXslPidKU09OJzwlIH1lbHNleyU+JzwlPV9GckVNRC5fYXR0cihlYSklPic8JX0lPik8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUsICJlYUNvZGUiKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJzwlPW5OYW1lKGMpJT4uPCU9ZWEuTmFtZSU+LlNldCcpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+IFNldCcpLnR5cGUoJ0Jvb2wnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSArICcgU2V0JywgImVhQ29kZSArICdfc2V0JyIpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZShlYUNvZGUgKyAnX29wJykubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiBPcGVyYXRvcicpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lICsgJyBPcGVyYXRvcicsICJlYUNvZGUgKyAnX29wJyIpJT4sDQogICAgICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdTZXQgJytlYS5OYW1lLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgWw0KICAgICAgICAgICAgICAgICAgICAgICAgZWEuRW50aXR5VHlwZT9udWxsOntjZDogImVhQ29kZSIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmpzb259fSciLCB0cm46IE9iamVjdC5hc3NpZ24oe30sIHt2YWx1ZV9tYXA6IHtrZXk6ICIke2VhQ29kZX0iLCBkZWZhdWx0OiAiIn19LCBlYS5fSXNEYXRlP3tzdHJpbmdfdG9fZGF0ZToge2RhdGVfZm9ybWF0OiAieXl5eS1NTS1kZFwnVFwnSEg6bW06c3NcJ1pcJyIsIGN1c3RvbV9mb3JtYXQ6ICIifX06e30pfSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfc2V0JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fX0nIiwgdHJuOiB7aXNfbnVsbDoge319fSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfb3AnIiwgdjogIid7e2Zsb3dfdmFyaWFibGUub3BlcmF0b3JzfX0nIiwgdHJuOiB7dmFsdWVfbWFwOiB7a2V5OiAiJHtlYUNvZGV9In19fSwNCiAgICAgICAgICAgICAgICAgICAgXSklPi5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4nKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUpLnJlbWFyayhgcmV0dXJuIGZkX2RhdGEuZmxvd192YXIuanNvbi4ke2VhQ29kZX07YCksPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4gU2V0JykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5yZW1hcmsoYHJldHVybiB0eXBlb2YoZmRfZGF0YS5mbG93X3Zhci5qc29uLiR7ZWFDb2RlfSkhXHUwMDNkXHUwMDNkXHUwMDI3dW5kZWZpbmVkXHUwMDI3O2ApLA0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnU2V0IDwlPWVhLk5hbWUlPiBPcGVyYXRvcicpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSArICdfb3AnKS5yZW1hcmsoYHJldHVybiAoZmRfZGF0YS5mbG93X3Zhci5qc29uLk9QRVJBVE9SUyB8fCB7fSkuJHtlYUNvZGV9O2ApLA0KICAgICAgICAgICAgICAgICAgICBdKSwNCg0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdJZiAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBTZXQnLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nICsgZWFDb2RlICsgJ19zZXR9fT10cnVlJyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+LnBhcmVudF9GbG93X0luc3RhbmNlcyg8JXN1YmZsb3coJ25ldyAnK3Njb3BlKycuJytfY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSkrJygpLicrbU5hbWUrJyhmYWxzZSwgdHJ1ZSknLCB7anNvbjogIid7e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319JyJ9KSU+KTwlfSU+DQogICAgICAgICAgICAgICAgICAgIC5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQWRkICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fV4nK2VhQ29kZSJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0lmICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIE9wZXJhdG9yIGlzIG5vdCBlbXB0eScsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKydfb3B9fSE9JyJ9XSklPi5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCAnK2VhLk5hbWUrJyBPcGVyYXRvciB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX17e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ19vcH19JyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdFbHNlICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIG5vdCBTZXQnLCAnRWxzZScpJT4ucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgPSB0byAnICsgYy5OYW1lICsgJyBFUXVlcnkgZm9yICcrZWEuTmFtZSwgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19PScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPjwlbG9naWMoJ0ZvciBlYWNoICcrYy5OYW1lKycgJytlYS5OYW1lLCAnRm9yIEVhY2gnLCBbe2NkOiAiJ2l0ZW1zJyIsIHY6ICIne3s8PCoqIyRmW2ludGVybmFsX25hbWU9XFwnIitjLk5hbWUrIl9sb29rdXBcXCcgYW5kICRub3QoJGV4aXN0cyhmbG93X0Zsb3dfU25hcHNob3RzKSldLnNuYXBzaG90X0Zsb3dfTG9naWNzLioqLnBhcmVudF9GbG93X0luc3RhbmNlcyMkZmlbJG51bWJlcihvcmRlcik8PSIrYk9yZGVyKyIgYW5kIHN1YmZsb3cuaW50ZXJuYWxfbmFtZT1cXCciK2VhLkVudGl0eVR5cGUuTmFtZSsiX2xvb2t1cFxcJ10udWlfaWQ+Pi4iK2VhLkVudGl0eVR5cGUuTmFtZSsiX2xpc3R9fScifV0pJT4ucGFyZW50X0Zsb3dfTG9naWNzKFs8JX0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fXt7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX0nIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPl0pPCV9JT4sDQogICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgIF0pPCV9JT4NCiAgICAgICAgICAgICAgICAsDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqPCVpZigwIHx8IFsnVXNlcicsICdHZW5kZXInLCAnX1N0dWRlbnQnLCAnX1RlYWNoZXInXS5pbmRleE9mKHRhLkVudGl0eUNsYXNzLk5hbWUpPj0wKXslPi5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiAnK3RhTmFtZSsnIG5vdCBlbXB0eScsICdJZicpJT4ucGFyZW50X0Zsb3dfSW5zdGFuY2VzKDwlc3ViZmxvdygnbmV3ICcrc2NvcGUrJy4nK19jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSkrJygpLicrbU5hbWUrJyhiRHJhZnQsIHRydWUpJywge2pzb246ICIndGVzdCcifSklPildKTwlfSU+LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX2xvb2t1cDogb2JqID0+IG9iai5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiBFUXVlcnkgbm90IGVtcHR5JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX0hPScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgLnBhcmVudF9BY3Rpb25fSW5zdGFuY2VzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlYWN0aW9uKCdsb29rX3VwX3JlY29yZHMnLCB7dGFibGU6ICciPDwkLnN5c19zY29wZS5zY29wZT4+XyIrKCcrX25Db2RlKCkrJykudG9Mb3dlckNhc2UoKSd9KSU+LA0KICAgICAgICAgICAgICAgICAgICBdKS5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oKS5uYW1lKCdTZXQgQ29uZGl0aW9uJykuYWN0aXZlKHRydWUpLmNvZGUoJ2NvbmRpdGlvbnMnKS5yZW1hcmsoYHJldHVybiBmZF9kYXRhLmZsb3dfdmFyLmVxdWVyeTtgKSwNCiAgICAgICAgICAgICAgICAgICAgXSkNCiAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICBfc25hcHNob3Q6IG9iaiA9PiBiRHJhZnQ/bnVsbDpvYmouZmxvd19GbG93X1NuYXBzaG90cyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgU25hcHNob3QnLCB0cnVlKSU+KDwlPV9maWQoKSU+KS5zbmFwc2hvdF9GbG93X1BsYW5zKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFBsYW4nLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWMuTmFtZSU+X1BsYW4nKS5uYW1lKCc8JT1jLk5hbWUlPiBQbGFuJykNCiAgICAgICAgICAgICAgICAgICAgXSkuZnJvbUZsb3codGhpcy48JT1tTmFtZSU+KHRydWUpKSksDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGJEcmFmdCwgYkhlYWRlcik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3RvU05TY3JpcHQnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgPCUgaWYoX2NOYW1lKCdBcHBsaWNhdGlvbicpKXslPg0KICAgICAgICAgICAgbGV0IGV4cCA9IG9wdGlvbnMucmF3PyJfdG9KU09OIjoiX3RvRG9jdW1lbnQiOw0KICAgICAgICAgICAgbGV0IHJvbGxiYWNrID0gKG9wdGlvbnMuYXBwICYmIG9wdGlvbnMucm9sbGJhY2spP2F3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUm9sbGJhY2sgQ29udGV4dCcsIHRydWUpJT4oKS5jb2RlKCdsYXN0JylbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBkYiA9IG9wdGlvbnMuZGI/YXdhaXQgb3B0aW9ucy5fdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlRhYmxlKClbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBmbG93ID0gb3B0aW9ucy5mbG93P2F3YWl0IG9wdGlvbnMuX3RoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05GbG93KG9wdGlvbnMuZHJhZnQpW2V4cF0oT2JqZWN0LmFzc2lnbih7YkpTT046IHRydWV9LCBvcHRpb25zKSk6IiI7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKG9wdGlvbnMuZ3ppcCl7DQogICAgICAgICAgICAgICAgaWYoZmxvdykgZmxvdyA9IHRoaXMuVXRmOEFycmF5VG9TdHIoYXdhaXQgdGhpcy5fY29tcHJlc3MoZmxvdykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdGVzdCA9IChvcHRpb25zLnRlc3QgJiYgb3B0aW9ucy5mbG93ICYmICFvcHRpb25zLmRyYWZ0KT9gXG4vKmdzLmNhY2hlRmx1c2goKTsgKi9ncy5pbmZvKHNuX2ZkLkZsb3dBUEkuZ2V0UnVubmVyKCkuc3ViZmxvdygnJHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9LlVzZXJfbG9va3VwJykuaW5Gb3JlZ3JvdW5kKCkud2l0aElucHV0cyh7anNvbjoge2NvZGU6InRlc3QiLGRhdGU6JzIwMjQtMDUtMDNUMTg6NDQ6MDMuMTc3WicsZ2VuZGVyOntjb2RlOiJNIiwgT1BFUkFUT1JTOiB7Y29kZTogIiE9In19LHVzZXJfU3R1ZGVudHM6W3tjb2RlOiJTVEEiLGdlbmRlcjp7Y29kZToiTSJ9fV0sIE9QRVJBVE9SUzoge2RhdGU6ICc8J319fSkucnVuKCkuZ2V0T3V0cHV0cygpWyJVc2VyX2xpc3QiXSk7XG5gOicnOw0KICAgICAgICAgICAgbGV0IGFwcCA9IG9wdGlvbnMuYXBwPyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOU2F2ZShvcHRpb25zKSArIGBcbiB2YXIgY29uZmlnID0ge0FwcGxpY2F0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBUYWJsZToge2lkS2V5OiAnbmFtZScsIExvZ1NldDogMH0sIENvbHVtbjoge0xvZ1NldDogMH0sIEVsZW1lbnRfTWFwcGluZzoge0xvZ1NldDogMH0sIEFjdGlvbl9JbnB1dDoge3JlYWRPbmx5OiB0cnVlfSwgQWN0aW9uX1R5cGU6IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICdtYXN0ZXJfc25hcHNob3QnfSwgQWN0aW9uX0luc3RhbmNlOiB7TG9nU2V0OiAwfSwgU2VjdXJpdHlfVHlwZToge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ25hbWUnfSwgU2VjdXJpdHlfT3BlcmF0aW9uOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbmFtZSd9LCBMb2dpY19EZWZpbml0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBGbG93OiB7TG9nU2V0OiAwfSwgVHJhbnNmb3JtOiB7cmVhZE9ubHk6IHRydWV9LCBUcmFuc2Zvcm1fQ29tcG9zaXRpb246IHtyZWFkT25seTogdHJ1ZX0sIFJvbGxiYWNrX0NvbnRleHQ6IHtyZWFkT25seTogdHJ1ZX19OyBcbmAgKyAob3B0aW9ucy5yb2xsYmFjaz8oInZhciBjaWQgPSBzYXZlUm9sbGJhY2tfQ29udGV4dCgiK3JvbGxiYWNrK2ApOyBpZihjaWQpe3ZhciBydyA9IG5ldyBHbGlkZVJvbGxiYWNrV29ya2VyKCk7IHJ3LnNldFJvbGxiYWNrQ29udGV4dElEKGNpZC5zeXNfaWQpOyBydy5zdGFydCgpO30gXG5gKToiIikrIChvcHRpb25zLmRiPygic2F2ZVRhYmxlKCIrZGIrIik7IFxuIik6IiIpICsgKG9wdGlvbnMuZmxvdz8oInNhdmVGbG93KCIrZmxvdysiKTsgXG4iKToiIikgKyB0ZXN0KToocm9sbGJhY2sgKyBkYiArIGZsb3cpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2NyaXB0ID0gdGhpcy5fYmVhdXRpZnkoYXBwLCAnamF2YXNjcmlwdCcpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5kZXBsb3kpIHJldHVybiBzY3JpcHQ7DQogICAgPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TTlNhdmUnJT4ob3B0aW9ucyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIDwlIHZhciBfZlJlZ0V4cCA9IC9fZntbXn1dK30vZ207ICU+DQogICAgICAgICAgICBsZXQgX2YgPSAodiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gdjsNCiAgICAgICAgICAgICAgICAgICAgLy9pZih2LnN0YXJ0c1dpdGgoImYoIikgJiYgdi5lbmRzV2l0aCgiKSIpKSByZXQgPSAnKCcrdi5zbGljZSgyLC0xKSsnKSc7DQogICAgICAgICAgICAgICAgICAgIGlmKHYuc3RhcnRzV2l0aCgicygiKSAmJiB2LmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gYChmdW5jdGlvbiAob2JqLCAke2VhQ29kZX0pe2Ardi5zbGljZSgyLC0xKStgfSkob2JqLCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYocmV0ICYmIHJldC5tYXRjaCAmJiByZXQubWF0Y2goPCU9X2ZSZWdFeHAlPikpIHJldCA9IGAoZnVuY3Rpb24gKG9iaiwgJHtlYUNvZGV9KXske3JldC5pbmRleE9mKCJyZXR1cm4iKTwwPyJyZXR1cm4gIjoiIn0gJ2ArcmV0LnJlcGxhY2UoPCU9X2ZSZWdFeHAlPiwgbSA9PiBgJyArICR7bS5zbGljZSgzLCAtMSl9ICsgJ2ApK2AnO30pKG9iaiwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgICAgIGlmKHJldCAmJiByZXQubWF0Y2ggJiYgcmV0Lm1hdGNoKC88PFtePj5dKz4+L2dtKSkgcmV0ID0gJyIiJzsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAoZnVuY3Rpb24odil7IHRyeXsgcmV0dXJuICh2ICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKDwlPV9mUmVnRXhwJT4sIGZ1bmN0aW9uKG0pe3JldHVybiBldmFsKG0uc2xpY2UoMywgLTEpKTt9KTp2OyAgfWNhdGNoKGV4KXtncy5pbmZvKCdfZntFeGNlcHRpb259OiAke2VhQ29kZX06ICcgKyBleCk7IHJldHVybiB2O30gfSkoJHtyZXR9IHx8ICR7ZWFDb2RlfSlgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gZWFDb2RlOw0KICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiAiPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPiIsIHZhcnM6IGBgLCBjb2RlOiBgYCwgcXVlcnk6IGBgLCBzZXQ6IGBgLCBlc2V0OiBgYCwgZHNldDogYGAsIHRhczogYGAsIGRlcHM6IHt9fSwgew0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHYub2JqID0gKHR5cGVvZihvcHRpb25zLnJldXNlZCk9PT0ndW5kZWZpbmVkJyB8fCBvcHRpb25zLnJldXNlZD49di5yZXVzZWQpP3Yub2JqOntjb2RlOiB2Lm9iai5jb2RlICsgYFxuXG4vKiogcmV1c2VkOiB2Lm9iai5JZCoqL1xuXG5gLCBkZXBzOiAnJywgSWQ6IHYub2JqLklkfSwNCg0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai5JZCA9IGBpZihvYmouJHtpZENvZGV9ICYmIG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykubGVuZ3RoPT0zMil7X3RvU3RyaW5nKz0nXycrb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKTsgZ3IuZ2V0KCdzeXNfaWQnLCBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpKTt9XG5gOw0KICAgICAgICAgICAgICAgICAgICBvYmouaWRUb1N0cmluZyA9IGBfdG9TdHJpbmcgKz0gKG9iaj9vYmouJHtpZENvZGV9OignZ3JfJytnci5zeXNfaWQpKSArICc6ICc7IGA7DQogICAgICAgICAgICAgICAgICAgIG9iai5uZXdVVUlEID0gYGlmKCFvYmouJHtpZENvZGV9IHx8IG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykubGVuZ3RoIT0zMil7b2JqLiR7aWRDb2RlfSA9IGdyLnNldE5ld0d1aWQoKTt9ZWxzZXtnci5zZXROZXdHdWlkVmFsdWUob2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKSk7fX1cbmA7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlIT1jKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouZGVwcy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+ID0gKHYgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPihvcHRpb25zKTsNCiAgICAgICAgPCUgfSU+DQoNCiAgICAgICAgICAgICAgICAgICAgb2JqLnZhcnMgKz0gYHZhciAke2VhQ29kZX0gPSA8JWlmKGVhLkVudGl0eVR5cGUpeyU+KCgocmVmcy48JT1uTmFtZShlYSklPiA9ICh0eXBlb2Yob2JqLiR7ZWFDb2RlfSkhPT0ndW5kZWZpbmVkJz8vKnRoaXMuKi9zYXZlPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPihvYmouJHtlYUNvZGV9LCB7PCU9bk5hbWUoYyklPjogb2JqLCA8JT1uTmFtZShjLyplYSovKSU+UmVmczogcmVmcywgPCU9bk5hbWUoYykudG9Mb3dlckNhc2UoKSU+OiBncn0sICI8JT1uTmFtZShjKSU+IiwgcmVmcy48JT1uTmFtZShlYSklPiB8fCAvKkVYUDogcmVmcy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKS50b0xvd2VyQ2FzZSgpJT4gfHwgKi8oJHtfZig8JXZhbHVlT2YoZWEuRGVmYXVsdCklPiwgZWFDb2RlKX0pKTpyZWZzLjwlPW5OYW1lKGVhKSU+KSkgfHwge3N5c19pZDogJyd9KVsvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPi5pZEtleSB8fCAic3lzX2lkIl0pLnRvU3RyaW5nKCk8JX1lbHNleyU+b2JqLiR7ZWFDb2RlfTwlfSU+O2A7DQogICAgICAgIDwlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucXVlcnkgKz0gYF90b1N0cmluZys9J18nKyR7ZWFDb2RlfTsgX3RvUXVlcnkuJHtlYUNvZGV9ID0gJHtfZih2LCBlYUNvZGUpfTsgYDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIG9iai5zZXQgKz0gYGlmKHR5cGVvZihfdG9TZXQuJHtlYUNvZGV9ID0gJHtfZih2LCBlYUNvZGUpfSkhPT0ndW5kZWZpbmVkJzwlaWYoZWEuRW50aXR5VHlwZSl7JT4mJiBfdG9TZXQuJHtlYUNvZGV9PCV9JT4pIGdyLnNldFZhbHVlKCcke2VhQ29kZX0nLCBfdG9TZXQuJHtlYUNvZGV9KTtgOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqLmVzZXQgKz0gYGlmKHR5cGVvZihfdG9TZXQuJHtlZkNvZGV9ID0gJHtfZihKU09OLnN0cmluZ2lmeSh2KSwgJ29iai4nK2VmQ29kZSl9KSE9PSd1bmRlZmluZWQnKSBnci5zZXRWYWx1ZSgnJHtlZkNvZGV9JywgX3RvU2V0LiR7ZWZDb2RlfSk7YCwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmoudGFzICs9IGByZWZzLjwlPXRhTmFtZSU+ID0gKChvYmo/b2JqLiR7ZWFDb2RlfTpbXSkgfHwgW10pLm1hcChmdW5jdGlvbihvKXtncy5pbmZvKF90b1N0cmluZyArICcgPT4gc2F2ZTwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+KCR7ZWFDb2RlfVtdKScpOyByZXR1cm4gLyp0aGlzLiovc2F2ZTwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+KG8sIHs8JT1uTmFtZShjKSU+OiBvYmosIDwlPW5OYW1lKGMpLnRvTG93ZXJDYXNlKCklPjogZ3IsIG1hbnlSZWZzOiByZWZzfSwgIjwlPW5OYW1lKGMpJT4iKTt9KTtgDQogICAgICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+ID0gKHYgJiYgdi5sZW5ndGgpP3ZbMF06bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFyZXQuZHNldCkgcmV0LmRzZXQgKz0gYFxuaWYodHlwZW9mKG9iaik9PT0ib2JqZWN0IikgT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoZnVuY3Rpb24oayl7cmV0dXJuICFrLnN0YXJ0c1dpdGgoJ19fJykgJiYgWydzeXNfaWQnLCAnSWQnLCAnT1BFUkFUT1JTJ10uaW5kZXhPZihrKTwwICYmIHR5cGVvZihfdG9TZXRba10pPT09J3VuZGVmaW5lZCcgJiYgIUFycmF5LmlzQXJyYXkob2JqW2tdKTt9KS5mb3JFYWNoKGZ1bmN0aW9uKGspe190b1NldFtrXSA9ICR7X2YoIm9ialtrXSIsICJudWxsIil9OyBpZihfdG9TZXRba10gJiYgX3RvU2V0W2tdLl9fY2xhc3Mpe190b1NldFtrXSA9IF90b1NldFtrXVtjb25maWdbX3RvU2V0W2tdLl9fY2xhc3NdLmlkRmllbGQgfHwgJ0lkJ107IH0gZ3Iuc2V0VmFsdWUoaywgX3RvU2V0W2tdICk7IH0pXG5gOw0KDQogICAgICAgICAgICByZXQuY29kZSArPSBgJHtPYmplY3QudmFsdWVzKHJldC5kZXBzKS5qb2luKCdcbicpfWZ1bmN0aW9uIHNhdmU8JT1uTmFtZShjKSU+KG9iaiwgcmVmcywgc291cmNlLCBncil7cmVmcyA9IHJlZnMgfHwge307IC8qdGhpcy4qL2NvbmZpZy5zYXZlXyR7PCU9X25Db2RlKCklPn0gPSBzYXZlPCU9bk5hbWUoYyklPjsgLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4gPSAvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPiB8fCB7fTsgLyp0aGlzLiovY29uZmlnLl9pZE1hcCA9IC8qdGhpcy4qL2NvbmZpZy5faWRNYXAgfHwgW107IHZhciBfdG9TdHJpbmcgPSBzb3VyY2UgKyAnWycgKyAocmVmc1tzb3VyY2VdLnN5c19pZCkgKyAnXT0+IHNhdmU8JT1uTmFtZShjKSU+KCc7IGlmKHR5cGVvZihvYmopPT09J3N0cmluZycgJiYgb2JqLmxlbmd0aD49MzIpe3ZhciByZXQgPSB7fTsgcmV0Wy8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LmlkS2V5IHx8ICJzeXNfaWQiXT1vYmo7IGdzLmluZm8oX3RvU3RyaW5nICsgJyk6IG9iaiBpcyB1dWlkLCByZXR1cm5pbmcgeycrb2JqKyd9Jyk7IHJldHVybiByZXQ7fSBpZighb2JqICYmICFncil7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnKTogb2JqIGlzIG51bGwnKTsgcmV0dXJuIG51bGw7fSAke3JldC5pZFRvU3RyaW5nfSB2YXIgYlNhdmUgPSAhLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4ucmVhZE9ubHk7IGlmKCFncil7IGdyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7XG4ke3JldC5JZH1cbiR7cmV0LnZhcnN9XG5pZighZ3IuaXNWYWxpZFJlY29yZCgpKXtnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpOyB2YXIgX3RvUXVlcnk9e307ICR7cmV0LnF1ZXJ5fSBcbl90b1N0cmluZyArPSAnKTogJzsgaWYob2JqLl9fa2V5cyAmJiAoYlNhdmUgfHwgY29uZmlnLjwlPW5OYW1lKGMpJT4ucmVhZE9ubHkpKXtpZihfdG9RdWVyeS5fX2VuY29kZWRRdWVyeSl7Z3IuYWRkRW5jb2RlZFF1ZXJ5KF90b1F1ZXJ5Ll9fZW5jb2RlZFF1ZXJ5KTt9ZWxzZXtvYmouX19rZXlzLmZvckVhY2goZnVuY3Rpb24oayl7Z3IuYWRkUXVlcnkoaywgX3RvUXVlcnlba10gfHwgb2JqW2tdKTt9KTt9IGdyLnNldExpbWl0KDEpOyBpZighZ3IuZ2V0RW5jb2RlZFF1ZXJ5KCkpIGdyLmFkZFF1ZXJ5KCdzeXNfaWQnLCAnLTEnKTsgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnRW5jb2RlZCBRdWVyeTogJyArIGdyLmdldEVuY29kZWRRdWVyeSgpKTsgZ3IucXVlcnkoKTtpZighZ3IubmV4dCgpKXtncy5pbmZvKF90b1N0cmluZyArICdub3QgZm91bmQnKTt9ZWxzZXtncy5pbmZvKF90b1N0cmluZyArICdmb3VuZCBbJHs8JT1fbkNvZGUoKSU+fS8nICsgZ3Iuc3lzX2lkICsgJ10gLSBpcyB2YWxpZDogJyArIGdyLmlzVmFsaWRSZWNvcmQoKSk7IG9iai5JZCA9IGdyLnN5c19pZC50b1N0cmluZygpOyBpZihvYmouX19yZXVzZWQpey8qZ3MuaW5mbyhfdG9TdHJpbmcgKyAnOiBfX3JldXNlZDogWyR7PCU9X25Db2RlKCklPn0vJyArIGdyLnN5c19pZCArICddIC0gaXMgdmFsaWQ6ICcgKyBnci5pc1ZhbGlkUmVjb3JkKCkpOyAqL3JldHVybiBncjt9IH19fX1lbHNle2JTYXZlPWZhbHNlO30gaWYoYlNhdmUgJiYgIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnaW5zZXJ0aW5nLi4uJyk7IGdyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7IGdyLmluaXRpYWxpemUoKTsgJHtyZXQubmV3VVVJRH0gaWYoYlNhdmUgJiYgb2JqKXt2YXIgX3RvU2V0ID0ge307IC8qc2V0Ki8ke3JldC5zZXR9IC8qZXNldCovJHtyZXQuZXNldH0gICR7cmV0LmRzZXR9IGlmKC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+Lk5vV29ya2Zsb3cpIGdyLnNldFdvcmtmbG93KGZhbHNlKTsgaWYoLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uTG9nU2V0KSBncy5pbmZvKF90b1N0cmluZyArICdfdG9TZXQ6ICcgKyBKU09OLnN0cmluZ2lmeShfdG9TZXQpKTsgfWVsc2UgaWYoIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnW2JTYXZlPScgKyBiU2F2ZSArICddIC0gcmV0dXJuaW5nIG51bGwuJyk7IHJldHVybiBudWxsO31cbmlmKCFiU2F2ZSB8fCBnci51cGRhdGUoKSl7IGlmKGZhbHNlICYmIGJTYXZlKXtjb25maWcuX2lkTWFwLnB1c2goe3RhYmxlOiAnJHs8JT1fbkNvZGUoKSU+fScsIHN5c19pZDogZ3Iuc3lzX2lkLnRvU3RyaW5nKCksIGtleXM6IG9iai5fX2tleXMubWFwKGZ1bmN0aW9uKGspe3JldHVybiB7azogaywgdjogX3RvUXVlcnlba10gfHwgb2JqW2tdfTt9KX0pO30gJHtyZXQudGFzfVxuZ3MuaW5mbyhfdG9TdHJpbmcgKyAnW2JTYXZlPScgKyBiU2F2ZSArICddIC0gcmV0dXJuaW5nICcgKyBnci5zeXNfaWQpOyByZXR1cm4gZ3I7fX1cbmA7DQoNCiAgICAgICAgICAgIC8qcmV0dXJuIE9iamVjdC52YWx1ZXMoT2JqZWN0LmFzc2lnbih7fSwgLi4ucmV0LmNvZGUuc3BsaXQoJ2Z1bmN0aW9uIHNhdmUnKS5maWx0ZXIocyA9PiBzKS5zb3J0KChhLCBiKSA9PiBhLmxlbmd0aCAtIGIubGVuZ3RoKS5tYXAocyA9PiAoe1tzLnNwbGl0KCcob2JqLCByZWZzLCBzb3VyY2UsIGdyKScpWzBdXTogJ2Z1bmN0aW9uIHNhdmUnK3N9KSkpKS5qb2luKCdcbicpOyAqLw0KICAgICAgICAgICAgcmV0dXJuIHJldC5jb2RlOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TTlF1ZXJ5JyU+KGZpZWxkcywgb2JqcywgYlVSTCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBPUEVSQVRPUlM6IHRydWUsDQogICAgICAgICAgICAvL19tYXA6IHRydWUsDQogICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmpbaWRDb2RlXSA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY/di48JT1tTmFtZSU+KCk6bnVsbDsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIGxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7DQogICAgICAgICAgICAgICAgbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsNCiAgICAgICAgICAgICAgICBpZigodi5nZXRIb3VycygpPT0wICYmIHYuZ2V0TWludXRlcygpPT0wICYmIHYuZ2V0U2Vjb25kcygpPT0wKSB8fCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0nPScgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3Apew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AhPT0nQkVUV0VFTicpew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgICAgICBvYmouT1BFUkFUT1JTLjwlPW5OYW1lKGVhKSU+ID0gJz0nOw0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgDQogICAgICAgIE9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pIT09J3VuZGVmaW5lZCcgJiYgdHlwZW9mKHJldFtrXSkhPT0nb2JqZWN0JykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOw0KDQogICAgICAgIGRlbGV0ZSByZXQuT1BFUkFUT1JTOw0KICAgICAgICBPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsNCg0KICAgICAgICByZXQgPSBEb3RPYmplY3QuZG90KHJldCk7DQoNCiAgICAgICAgLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzDQogICAgICAgIE9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCg0KICAgICAgICBpZihiVVJMKSByZXQgPSBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCgk8JT1tTmFtZT0nX19leHBvcnQnJT4ob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7DQoJICAgIHRyeXsNCiAgICAJICAgIGlmKCFvYmopIHJldHVybiB0aGlzOw0KICAgIAkgICAgDQogICAgCSAgICBpZihvcHRpb25zLk9QRVJBVE9SUykgb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307DQogICAgCSAgICANCiAgICAJICAgIDwlIC8qIElNUE9SVEFOVDogdGhpcy5JZD09dGhpcy5JZCBtYWtlcyBzdXJlIHRoZSBJZCBpcyBmaXhlZCBmb3IgdGhlIHRvb2wsIG5vdCBnZXR0aW5nIGdlbmVyYXRlZCBldmVyeSB0aW1lIHdlIGNhbGwgaXQgKi8gJT4NCiAgICAJICAgIA0KICAgIAkgICAgbGV0IGVhQ29kZXMgPSB7DQogICAgCSAgICAgICAgZXhwb3J0ZXI6ICIiLA0KICAgIAkgICAgICAgIElkOiAiIiwNCiAgICAJICAgIH07DQogICAgCSAgICANCiAgICAJCWlmICghb3B0aW9ucy5VbmlxdWUgJiYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpKSB0aGlzLl9fb3B0aW9ucygiSWQiLCBvYmosIGVhQ29kZXMuSWQgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdJZCcpOidJZCcpLCB0aGlzLklkLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KICAgIAkJDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlZi5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCJlZl88JT1uTmFtZShlZiklPiIsIG9iaiwgZWFDb2Rlcy5lZl88JT1uTmFtZShlZiklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVmKSU+OjwlX3ZDb2RlKGVmKSU+KSwgPCV2YWx1ZU9mKGVmLlZhbHVlKSU+LCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KPCUgfSklPg0KDQoJCSAgICA8JSB1blJlY3Vyc2UoJ29iaicsICdmdW4nLCAnZkFyZ3MnLCAnaWYodHlwZW9mKG9wdGlvbnMuZXhwb3J0ZXIpPT09ImZ1bmN0aW9uIikgb3B0aW9ucy5leHBvcnRlcih2KScpJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgIWVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIl9USElTIiwgb2JqLCBlYUNvZGVzLl9USElTID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnX1RISVMnKToiX1RISVMiKSwgdGhpcy5fVEhJUywgdGhpcywgb3B0aW9ucywgZnVuKTsNCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiPCU9dGFOYW1lJT4iLCBvYmosIGVhQ29kZXMuPCU9dGFOYW1lJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZSh0YSwgdHJ1ZSklPjoiPCU9dGFOYW1lJT4iKSwgdGhpcy48JT10YU5hbWUlPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKHRhKSU+Iik7DQo8JSB9KSU+DQoNCiAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKT09PSdmdW5jdGlvbicgJiYgIU9iamVjdC5rZXlzKGVhQ29kZXMpLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gdGhpcy5fX29wdGlvbnMoaywgb2JqLCBrLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bikpOw0KICAgICAgICANCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dIHx8IHt9Ow0KICAgICAgICAgICAgKDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljIHx8IFtdKS5mb3JFYWNoKG4gPT4gbi5fY1tuLmVhRmllbGRdKG4uX2Nbbi5lYUZpZWxkXSgpLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogdHJ1ZSwgbm9BcmdzOiB0cnVlLCBfbWFwOiBvcHRpb25zLl9tYXB9LCBmdW4pKSk7DQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyA9IFtdOyAvLz8/DQogICAgICAgICAgICANCiAgICAJCXJldHVybiBvYmo7DQogICAgCX1jYXRjaChleCl7DQogICAgCSAgICA8JT1lcnJvcigpJT5leCk7DQogICAgCX0NCgl9DQoJDQoJPCU9bU5hbWU9J19fb3B0aW9ucyclPihmaWVsZCwgb2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcz10aGlzLCBvcHRpb25zPXt9LCBmdW4sIGVhRmllbGQpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGZpZWxkLCBvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzLCBvcHRpb25zLCBmdW4sIGVhRmllbGQpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47DQogICAgICAgICAgICBpZighb2JqKSByZXR1cm47DQogICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9uc1tmaWVsZF0pIT09ImZ1bmN0aW9uIil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPmAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodHlwZW9mKGVhT2JqKSE9PSd1bmRlZmluZWQnICYmICFvcHRpb25zLk51bGwpew0KICAgICAgICAgICAgICAgIGlmKGZpZWxkIT0nSWQnICYmIHR5cGVvZihfdGhpc1tmaWVsZF0pPT09J2Z1bmN0aW9uJyAmJiAhX3RoaXNbJ18nK2ZpZWxkKydfc2V0J10pIHJldHVybjsNCiAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSE9PSd1bmRlZmluZWQnKSBlYU9iaiA9IGVhT2JqLmZpbHRlcih2ID0+IHYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5OdWxsICYmIEFycmF5LmlzQXJyYXkoZWFPYmopICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsNCg0KICAgICAgICAgICAgbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzKTsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuT1BFUkFUT1JTICYmIF90aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHtbZmllbGRdOiBfdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddfSk7DQoNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLkN5Y2xpYyAmJiBlYUZpZWxkICYmIG9iaiAmJiBvYmouRW50aXR5Q2xhc3MgJiYgdHlwZW9mKG9ialtmaWVsZF0pPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gfHwge307DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyB8fCBbXTsNCiAgICAgICAgICAgICAgICBsZXQgX2N5Y2xlcyA9IG9ialtmaWVsZF0oKTsNCiAgICAgICAgICAgICAgICBpZighQXJyYXkuaXNBcnJheShfY3ljbGVzKSkgX2N5Y2xlcyA9IFtfY3ljbGVzXTsNCiAgICAgICAgICAgICAgICBfY3ljbGVzID0gX2N5Y2xlcy5maWx0ZXIoX2MgPT4gX2MgJiYgdHlwZW9mKF9jW2VhRmllbGRdKT09PSdmdW5jdGlvbicgJiYgX2NbJ18nICsgZWFGaWVsZCArICdfc2V0J10gJiYgb2JqLl9zYW1lRW50aXR5KF9jW2VhRmllbGRdKCkpKS5tYXAoX2MgPT4gKHsNCiAgICAgICAgICAgICAgICAgICAgLyptYXJrIF9jW2VhRmllbGRdX3NldCB0byBudWxsIGluc3RlYWQqLw0KICAgICAgICAgICAgICAgICAgICBfYywNCiAgICAgICAgICAgICAgICAgICAgZWFGaWVsZCwNCiAgICAgICAgICAgICAgICB9KSk7DQogICAgICAgICAgICAgICAgaWYoX2N5Y2xlcy5sZW5ndGgpIDwlPXdhcm4oKSU+ZnVuICsgIi9fY3ljbGVzIiwgX2N5Y2xlcyk7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMucHVzaCguLi5fY3ljbGVzKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5fbWFwKSBfdGhpcy5fbWFwKGZpZWxkLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcsIGZ1biwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnP29iajplYU9iaiwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnP190aGlzOm9iaiwgZWFDb2RlKTsNCg0KICAgICAgICAgICAgcmV0dXJuIF9yZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5mdW4sIGZpZWxkLCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCgkNCgk8JT1tTmFtZT0nX19pbXBvcnQnJT4ob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7DQogICAgICAgIGlmKHR5cGVvZihvYmopIT09J29iamVjdCcpew0KICAgICAgICAgICAgPCU9d2FybigpJT5gJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KCSAgICANCiAgICAgICAgbGV0IGVhQ29kZXMgPSB7fTsNCg0KCQl0aGlzLl9fb3B0aW9ucygiSWQiLCBvYmosIGVhQ29kZXMuSWQgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdJZCcpOidJZCcpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoJCQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KCQk8JSB1blJlY3Vyc2UoJ3RoaXMnLCAnZnVuJywgJ2ZBcmdzJywgJ2lmKHR5cGVvZihvcHRpb25zLmltcG9ydGVyKT09PSJmdW5jdGlvbiIpIG9wdGlvbnMuaW1wb3J0ZXIodiknKSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmICFlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KCQl0aGlzLl9fb3B0aW9ucygiX1RISVMiLCBvYmosIGVhQ29kZXMuX1RISVMgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdfVEhJUycpOidfVEhJUycpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHsNCiAgICBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsNCiU+DQogICAgICAgIHRoaXMuX19vcHRpb25zKCI8JT10YU5hbWUlPiIsIG9iaiwgZWFDb2Rlcy48JT10YU5hbWUlPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKHRhLCB0cnVlKSU+OiI8JT10YU5hbWUlPiIpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQodGEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICBPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSk9PT0nZnVuY3Rpb24nICYmICFPYmplY3Qua2V5cyhlYUNvZGVzKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IHRoaXMuX19vcHRpb25zKGssIG9iaiwgaywgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pKTsNCg0KCQlyZXR1cm4gdGhpczsNCgl9DQoNCjwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9DeVRhYmxlJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtjcWw6IGANCkNSRUFURSBDT05TVFJBSU5UIElGIE5PVCBFWElTVFMgRk9SIChvOiR7PCU9X25Db2RlKCklPn0pIFJFUVVJUkUgby4ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0gSVMgVU5JUVVFOw0KQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSBJUyBOT1QgTlVMTDsNCiAgICAgICAgYH0sIHsNCiAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9iai5jcWwgKz0gdj92LjwlPW1OYW1lJT4oKTonJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgb2JqLmNxbCArPSBgQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7ZWFDb2RlfSBJUyBVTklRVUU7DQpgDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5jcWwgKz0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKS5qb2luKCdcbicpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0LmNxbCk7DQogICAgICAgIHJldHVybiByZXQuY3FsOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvQ3lNZXJnZSclPihmaWVsZHMsIGJSYXcpew0KICAgICAgICBsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMsIHRydWUpOw0KICAgICAgICBsZXQgdWtleXMgPSBbXTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikgdWtleXMucHVzaCg8JT1fbkNvZGUoZWEpJT4pOw0KICAgIDwlIH0pJT4NCiAgICAgICAgbGV0IGNxbCA9IGA6JHs8JT1fbkNvZGUoKSU+fSB7YCArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdWtleXMuaW5jbHVkZXMoaykpLm1hcChrID0+IGsgKyAiOiAiICsgb2JqW2tdKS5qb2luKCcsICcpICsgYH0pYDsNCiAgICAgICAgDQogICAgICAgIGlmKCFiUmF3KXsNCiAgICAgICAgICAgIGxldCBtYXRjaCA9ICdcbk1BVENIIChvJyArIGNxbDsNCiAgICAgICAgICAgIGNxbCA9ICdNRVJHRSAobycgKyBjcWw7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvblNldCA9IE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gIXVrZXlzLmluY2x1ZGVzKGspKS5tYXAoayA9PiAiby4iICsgayArICI9IiArIG9ialtrXSkuam9pbignLCAnKQ0KICAgICAgICAgICAgY3FsICs9ICdcbk9OIENSRUFURSBTRVQgJyArIG9uU2V0ICsgJ1xuT04gTUFUQ0ggU0VUICcgKyBvblNldDsNCiAgICAgICAgICAgIGNxbCArPSAnXG5SRVRVUk4gbzsnOw0KDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIGNxbCArPSBtYXRjaCArICcsICcgKyB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihudWxsLCB0cnVlKS5yZXBsYWNlKCcoOicsICcoPCU9bk5hbWUoZWEpJT46JykgKyAnIE1FUkdFIChvKS1bOjwlPW5OYW1lKGMpJT5fPCU9bk5hbWUoZWEpJT5dLT4oPCU9bk5hbWUoZWEpJT4pOyc7DQogICAgPCUgfSklPg0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGNxbCA9ICcoJyArIGNxbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgIHJldHVybiBjcWw7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b0N5UXVlcnknJT4oZmllbGRzLCBvYmpzKXsNCiAgICAgICAgbGV0IHNxbCA9ICJNQVRDSCAiOw0KICAgICAgICANCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfWA7DQoNCiAgICAgICAgbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7DQoNCiAgICAgICAgc3FsICs9IGAgKCR7dFByZWZ9OiR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICAgICAgDQogICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgIE9QVElPTkFMIE1BVENIICgke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9OiR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSkgT1BUSU9OQUwgTUFUQ0ggKCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfSktWzoke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfV0tPigke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9KWApOw0KICAgICAgICANCg0KICAgICAgICAvL3NxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsNCiAgICAgICAgLy9PYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBmdW5jdGlvbn0NCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgIH0NCg0KICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KDQogICAgICAgIHNxbCA9IHRoaXMuX19leHBvcnQoe3NxbDogc3FsfSwgew0KICAgICAgICAgICAgX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCk/WydJZCddOnVuZGVmaW5lZCwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPih0Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIElkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCAiOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHtjb29wfSBFWElTVFMgeyR7di48JT1tTmFtZSU+KCl9fWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQgfHwgZWEuSXNJbWFnZSB8fCBlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkNPTlRBSU5TIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi50b0lTT1N0cmluZyl7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAodj8iMSI6IjAiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC48JT1tTmFtZSU+KCI8JT1uTmFtZSh0YSklPi5pZCIpKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgak9QID0gJ1VOSU9OIEFMTCc7DQogICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGA7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgIGluT1AgPSAnTk9UIElOJzsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J0lOJyl7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgIGpPUCA9ICdJTlRFUlNFQ1QnOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBhbmQgLyo8JT10YU5hbWUlPiovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgaWYoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KDQogICAgICAgIGlmKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNxbCArPSAnIHJldHVybiAnICsgW3RQcmVmXS5jb25jYXQoT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5tYXAoayA9PiBgJHt0aGlzLl9RKCl9JHtrfSR7dGhpcy5fUSgpfWApKS5qb2luKCcsICcpOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfbmVvNGonJT4oY3FsKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKT09Yyl7JT4NCiAgICAgICAgbGV0IHNlc3Npb24gPSBudWxsOw0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIWNxbCB8fCAhY3FsLnRyaW0oKSl7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYikgPCU9bG9nKCklPmNxbCwgIiA8PT1TS0lQUEVEPT0+Iik7DQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgaWYoY3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3Qgc3FsUyBvZiBjcWwuc3BsaXQoJztcbicpKXsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy48JT1tTmFtZSU+KHNxbFMudHJpbSgpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYlN0b3JlID0gWyJNRVJHRSIsICJDUkVBVEUiLCAiVVBEQVRFIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCiAgICAgICAgICAgIGxldCBiRE1MID0gWyJDT05TVFJBSU5UIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCg0KICAgICAgICAgICAgaWYoYkRNTCl7DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlID0gdGhpcy5Ub29sLmRtbENhY2hlIHx8IHt9Ow0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKGNxbCldKSByZXR1cm47DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoY3FsKV0gPSBjcWw7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHNlc3Npb24gPSB0aGlzLlRvb2wuZGIuc2Vzc2lvbih7IGRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpIH0pOw0KICAgICAgICAgICAgbGV0IGZ1biA9ICdSZWFkJzsNCiAgICAgICAgICAgIGlmKGJTdG9yZSB8fCBiRE1MKSBmdW4gPSAnV3JpdGUnOw0KICAgICAgICAgICAgaWYoZnVuPT0nV3JpdGUnKSB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goY3FsKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5jcWwpOw0KICAgICAgICAgICAgLy9yZXQgPSAoYXdhaXQgc2Vzc2lvblsnZXhlY3V0ZScrZnVuXSh0eCA9PiB0eC5ydW4oY3FsKSkpLnJlY29yZHM7DQogICAgICAgICAgICAvLzwlPWxvZygpJT5yZXQpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIGlmKHNlc3Npb24pIGF3YWl0IHNlc3Npb24uY2xvc2UoKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnTmVvNGonXSkpJT4oKS48JT1tTmFtZSU+KGNxbCk7DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1J4REInLCAnTW9uZ29EQiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvSlNPTlNjaGVtYSclPigpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgdHlwZSA9IHRoaXMuX19jb25maWcoJ2pzb24udHlwZScsICd0eXBlJyk7DQogICAgICAgICAgICBsZXQgc2NoZW1hID0gew0KICAgICAgICAgICAgICAgICRpZDogJzwlPWMuSWQlPicsDQogICAgICAgICAgICAgICAgJHNjaGVtYTogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LzIwMjAtMTIvc2NoZW1hIiwNCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJzwlPWMuUmVtYXJrJT4nLA0KICAgICAgICAgICAgICAgIHRpdGxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIFt0eXBlXTogJ29iamVjdCcsDQogICAgICAgICAgICAgICAgdmVyc2lvbjogMCwNCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7DQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgWzwlPV9uQ29kZShlYSklPl06IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiPCU9ZWEuUmVtYXJrJT4iLA0KICAgICAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmFycmF5JywgJ2FycmF5JyksDQogICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogew0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgJHJlZjogJzwlPWVhLkVudGl0eUNsYXNzLklkJT4nLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5zdHJpbmcnLCAnc3RyaW5nJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS50ZXh0JywgJ3N0cmluZycpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuYm9vbCcsICdib29sZWFuJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmludCcsICdpbnRlZ2VyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuZmxvYXQnLCAnbnVtYmVyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ltYWdlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuaW1hZ2UnLCAnb2JqZWN0JyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5maWxlJywgJ29iamVjdCcpLA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICByZXF1aXJlZDogWzwlYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLlJlcXVpcmVkKS5tYXAoZWEgPT4geyU+PCU9X25Db2RlKGVhKSU+PCV9KS5qb2luKCcsJyklPl0sDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICA8JT1sb2coKSU+c2NoZW1hKTsNCiAgICAgICAgICAgIHJldHVybiBzY2hlbWE7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnTW9uZ29EQicsICdSeERCJywgJ1phbmdvREInXSkpeyU+DQogICAgPCU9bU5hbWU9J190b1NlbGVjdE1kYiclPigpew0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouX2lkID0geyRpbjogdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgICAgICAgICAgSWQ6IG9iaiA9PiBvYmouX2lkID0gdGhpcy5JZCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZighdi48JT1tTmFtZSU+KSByZXR1cm47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0ge307DQogICAgICAgICAgICAgICAgbGV0IG9wID0gIiRlIjsNCiAgICAgICAgICAgICAgICBzd2l0Y2godGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj4iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI8IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRsdCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPD0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGx0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJG5lIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICJJTiI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkaW4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV1bb3BdID0gdi48JT1tTmFtZSU+KCkudG9JU09TdHJpbmcoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHYuPCU9bU5hbWUlPigpOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0geyRpbjogdi5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKF9zcWxUb29scykpeyU+DQogICAgPCU9bU5hbWU9J190b0RCT2JqZWN0JyU+KGZpZWxkcywgYk5vUmVmKXsNCiAgICAgICAgaWYoIXRoaXMuSWQpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7DQogICAgICAgIH0NCiAgICAgICAgbGV0IHJldCA9IHsNCiAgICAgICAgICAgIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciDQogICAgICAgIH07DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIjwlPWVhLk5hbWUlPiIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgKCFiTm9SZWYgfHwgPCU9ZWEuRW50aXR5VHlwZT8nZmFsc2UnOid0cnVlJyU+KSl7DQogICAgICAgICAgICBsZXQgZlZhbHVlID0gbnVsbDsNCiAgICAgICAgICAgIGxldCB2ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgaWYodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkPT12LklkKSl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdi5JZCArICInIjsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICJOVUxMIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdj8xOjA7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSBmVmFsdWU/J1RydWUnOidGYWxzZSc7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKSBmVmFsdWUgPSAiJyIgKyBmVmFsdWUgKyAiJyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdiB8fCAnMCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyAodj92LnRvSVNPU3RyaW5nKCk6IjE5NzAtMS0xIikgKyAiJyI7DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNPYmplY3QpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyBKU09OLnN0cmluZ2lmeSh2LCBudWxsLCAnXHQnKSArICInIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2PT09bnVsbD8iTlVMTCI6KCInIiArICgoZmFsc2UgJiYgdiAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSgvXFxuL2csICJcXFxcbiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCcvZywgIlxcXFwnIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnXFxcXCInKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwmL2csICJcXFxcJiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXHIvZywgIlxcXFxyIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcdC9nLCAiXFxcXHQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFxiL2csICJcXFxcYiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXGYvZywgIlxcXFxmIikgIDp2KSArICInIik7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgIGlmKHY9PT1udWxsKXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiTlVMTCI7DQogICAgICAgICAgICB9ZWxzZSBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKXsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgRlJPTV9CQVNFNjQoJyR7dGhpcy5fYnRvYSh2KX0nKWA7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBjYXN0KHVuaGV4KCcke3Yuc3BsaXQoIiIpLm1hcCh4ID0+ICgyNTYgKyB4LmNoYXJDb2RlQXQoKSkudG9TdHJpbmcoMTYpLnN1YnN0cigtMikpLmpvaW4oIiIpfScpIGFzIHZhcmNoYXIpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gdjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0WzwlPV9uQ29kZShlYSklPiArICI8JT0oZWEuRW50aXR5VHlwZT8naWQnOicnKSU+Il0gPSBmVmFsdWU7DQogICAgICAgIH0NCiAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdnZXQnJT4obmFtZSkgew0KICAgICAgICBpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOw0KICAgICAgICB2YXIgdCA9IG51bGw7DQogICAgICAgICQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7DQogICAgICAgICAgICB0ID0gew0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdCA/IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbdF0NCiAgICAgICAgICAgICAgICB9IDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIElkOiB0aGlzLklkDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgTmFtZTogZiwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPSINCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7DQogICAgICAgICAgICA8JT1sb2coKSU+ZXYpOw0KICAgICAgICAgICAgaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7DQoNCiAgICAgICAgICAgIGlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOw0KDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT5bJC5ncmVwKDwlPXNjb3BlJT4uRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7DQogICAgICAgIH0pOw0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX1EnJT4oKXsNCiAgICAgICAgbGV0IF9vID0gJyInOw0KICAgICAgICBsZXQgX3EgPSBfbzsNCg0KICAgICAgICBpZihbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpPT0wKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSAiIjsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpew0KICAgICAgICAgICAgX28gPSBfcSA9ICdgJzsNCiAgICAgICAgfWVsc2UgaWYoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKT09MCl7DQogICAgICAgICAgICBfbyA9IF9xID0gYCdgOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxzZXJ2ZXInKXsNCiAgICAgICAgICAgIF9vID0gJ1snOw0KICAgICAgICAgICAgX3EgPSAnXSc7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ2FwaUtleScpPT0nYWlydGFibGUnKXsNCiAgICAgICAgICAgIF9vID0gJ3snOw0KICAgICAgICAgICAgX3EgPSAnfSc7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9vP19xOl9vOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2ZpZWxkR3JvdXBzJyU+KGZncyA9IHt9KXsNCiAgICAgICAgdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19maWVsZEFnZ3JlZ2F0ZXMnJT4oZmFzID0ge30pew0KICAgICAgICB0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0ZpZWxkc1NRTCclPihmaWVsZHMpew0KICAgICAgICANCiAgICAgICAgZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyksIDwlPWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IF9uQ29kZShlYSkgKyAoZWEuRW50aXR5VHlwZT8nKyIuaWQiJzonJykpLmpvaW4oJywnKSU+XTsNCiAgICAgICAgZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpP2ZpZWxkczpbZmllbGRzXTsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBvcmRlcn0NCiAgICAgICAgICAgIGZpZWxkcyA9IFtdOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+KSBmaWVsZHMucHVzaChgJHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fWApOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmllbGRzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21EQk9iamVjdCclPihyPXt9KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQociwgew0KICAgICAgICAgICAgICAgIElkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KG9ialtlYUNvZGVdKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NlbGVjdEhlYWRlciclPihmaWVsZHMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gew0KICAgICAgICAgICAgICAgIHRhYmxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIGZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLA0KICAgICAgICAgICAgICAgIGpvaW5zOiB7fSwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKGZpZWxkcykgcmV0dXJuIHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TZWxlY3RTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHNxbCA9ICJzZWxlY3QgIjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX1gOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsNCg0KICAgICAgICAgICAgc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOw0KICAgICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7DQogICAgDQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKXsNCiAgICAgICAgICAgICAgICAvLyB7ZmllbGQ6IGZ1bmN0aW9ufQ0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgPSB0aGlzLl9fZXhwb3J0KHtzcWw6IHNxbH0sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIF9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpP1snSWQnXTp1bmRlZmluZWQsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih2LnJldXNlZD4yKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwlPXdhcm4oKSU+IlJldXNlZDogIiwgdik7DQogICAgICAgICAgICAgICAgICAgICAgICB2Lm9iai5zcWwgPSBgLypSRVNVRUQ6ICR7di5yZXVzZWR9Ki9gOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgLyphbmQgKi8ke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4odC5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnKS50aGlzKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLnNxbCArPSAodGhpcy5JZD09dGhpcy5JZCk/YCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A6JycsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCBJTiI7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJJTiI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuPCU9bU5hbWUlPih2Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpfSlgOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCB8fCBlYS5Jc0ltYWdlIHx8IGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgPCVpZihlYS5Jc0Jvb2wpeyU+Ij0iPCV9ZWxzZXslPih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIHx8ICJMSUtFIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYudG9JU09TdHJpbmcpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICh2PyIxIjoiMCIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBqT1AgPSAnVU5JT04gQUxMJzsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpbk9QID0gJ05PVCBJTic7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgICAgICBqT1AgPSAnSU5URVJTRUNUJzsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYW5kIC8qPCU9dGFOYW1lJT4qLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIikpLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzKXsNCiAgICAgICAgICAgICAgICBpZihPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoIXNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgICAgIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikhPT0ndW5kZWZpbmVkJz9zcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCk6c3FsOw0KICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBzcWw7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1BhdGhzJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHt9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPiA9IHYuPCU9bU5hbWUlPigpLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIC8vIHJldHVybiByZXQ7DQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7W2tdOiByZXRba119KSk7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1VwZGF0ZVNRTCclPihmaWVsZHMpew0KICAgICAgICBsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsNCiAgICAgICAgbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOw0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgcmV0dXJuIHNxbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvSW5zZXJ0U1FMJyU+KGZpZWxkcyl7DQogICAgICAgIGxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7DQogICAgICAgIGxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7DQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCjwlIH0gJT4NCiAgICANCiAgICA8JT1tTmFtZT0nX2NvcHlGcm9tJyU+KG9iail7DQogICAgICAgIGlmKCFvYmopIHJldHVybiBudWxsOw0KICAgICAgICByZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9PYmpUcmVlJyU+KGJDeWNsaWMpew0KICAgICAgICA8JT13YXJuKCklPiJkZXByZWNhdGVkIik7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICANCiAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCc8JT1jLk5hbWUlPicpLCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgQ3ljbGljOiBiQ3ljbGljLA0KICAgICAgICAgICAgLy9leHBvcnRlcjogdiA9PiA8JT13YXJuKCklPnYucmV1c2VkKSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4oPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKTwlfWVsc2V7JT52PCV9JT4pLA0KICAgIDwlIH0pOyU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9dGFOYW1lJT4obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKSksDQogICAgPCUgfSk7JT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J191bkN5Y2xlJyU+KHNvdXJjZT10aGlzKXsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQodGhpcywgew0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPihzb3VyY2U9PW9iai48JT1uTmFtZShlYSklPigpP251bGw6dW5kZWZpbmVkKSwNCiAgICA8JSB9KTslPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gdHJ1ZSwNCiAgICA8JSB9KTslPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3N0b3JlRW50aXR5Q2xhc3MnJT4oZGVwdGgpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZGVwdGgpPT09InVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7DQogICAgICAgICAgICBpZighZGVwdGgpIHJldHVybjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5Ub29sLjwlPW1OYW1lJT4gPSB0aGlzLlRvb2wuPCU9bU5hbWUlPiB8fCB7fTsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4pIHJldHVybjsNCiAgICAgICAgICAgIHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4gPSB0cnVlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsNCiAgICAgICAgICAgIA0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5EU0Nvbm5lY3QoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvQ3lUYWJsZShkZXB0aCk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbmVvNGooY3FsKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQWlyVGFibGUiKXslPg0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL2Jhc2VzJywgbnVsbCwge25hbWU6ICc8JT1zY29wZSU+Jywgd29ya3NwYWNlSWQ6IHRoaXMuVG9vbC5kYi53b3Jrc3BhY2VJZCwgdGFibGVzOiB0aGlzLl90b0FUVGFibGUoZGVwdGgpfSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyU+DQogICAgICAgICAgICAgICAgbGV0IHNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU1FMVGFibGUoe3JldXNlZDogM30pOyA8JS8qZGVwdGg6IGNoYWxsZW5nZSAtIHRvbyBsb3cgZG9lcyBub3QgY292ZXIgYWxsIHRhYmxlcywgdG9vIGhpZ2ggKG1heCBkZXB0aCkgcmVzdWx0cyBpbiBvdXQtb2YtbWVtb3J5IG9uIGJyb3dzZXIqLyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHNxbCk7DQogICAgPCUgfWVsc2UgaWYodD09IlNlcnZpY2VOb3ciKXslPg0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPnRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05UYWJsZSgpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7JT4NCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90b0VNU0NsYXNzKGRlcHRoKS5zdG9yZSgpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJCSVNlcnZlciIpeyU+DQogICAgICAgICAgICAgICAgLy8gb25seSBkbyB0aGlzIGlmIHRoZSBtb2R1bGUgaXMgbm90IGxvYWRlZCBmcm9tIA0KICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogew0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgQ29tcGFueTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb2RlOiB0aGlzLl9fY29uZmlnKCdjb21wYW55JywgJzwlPXNjb3BlJT4nKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICB9KSkuZm9yRWFjaChlYSA9PiAvKiB0cnllIF9lYVR5cGVzICovPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goc2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoc2VhLklkIT09ZWEuSWQgJiYgc2VhLk5hbWU9PWVhLk5hbWUgJiYgKHNlYS5FbnRpdHlDbGFzcy5JZD09ZWEuRW50aXR5Q2xhc3MuSWQgfHwgc2VhLkVudGl0eUNsYXNzLk5hbWU9PWVhLkVudGl0eUNsYXNzLk5hbWUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5JZCA9PSBlYS5JZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5FbnRpdHlDbGFzcy5JZCA9IGVhLkVudGl0eUNsYXNzLklkOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWU9PXNlYS5FbnRpdHlDbGFzcy5OYW1lKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoc2NlYSA9PiBzY2VhLk5hbWU9PWVhLk5hbWUpLklkID0gZWEuSWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KSk7DQogICAgPCUgfWVsc2UgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIGF3YWl0IHRoaXMuVG9vbC5kYi5jcmVhdGVDb2xsZWN0aW9uKDwlPV9uQ29kZSgpJT4sIHt2YWxpZGF0b3I6IHskanNvblNjaGVtYTogdGhpcy5fdG9KU09OU2NoZW1hKCl9fSk7DQogICAgPCUgfWVsc2UgaWYodD09IlJ4REIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgYXdhaXQgdGhpcy5Ub29sLmRiLmFkZENvbGxlY3Rpb25zKHtbPCU9X25Db2RlKCklPl06IHtzY2hlbWE6IHRoaXMuX3RvSlNPTlNjaGVtYSgpfX0pOw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbG9nJyU+KG9iaj10aGlzKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvYmopOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gb2JqLm1hcChvID0+IHRoaXMuX2xvZyhvKSk7DQogICAgICAgICAgICBpZihvYmouRW50aXR5Q2xhc3MpIG9iaiA9IG9iai5fdG9KU09OKHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nRFNDb25uZWN0JyU+KHRvb2w9dGhpcy5Ub29sKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPih0b29sKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0b29sKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbCBpcyBudWxsIiwgdGhpcy5Ub29scy5sZW5ndGgsIDwlPXNjb3BlJT4uVG9vbHMubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZighdG9vbC50eXBlKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbC50eXBlIGlzIG51bGwiLCB0b29sLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZih0b29sLmRiKSE9PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlRvb2wgYWxyZWFkeSBjb25uZWN0ZWQhIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgLyo8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50X3NldCAmJiAqLzwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLl9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKSl7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICB0b29sLl9fZG1sU3RhdGVtZW50cyA9IHRvb2wuX19kbWxTdGF0ZW1lbnRzIHx8IFtdOw0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJbPCU9dCU+XTogQ29ubmVjdGluZy4uLiIpOw0KDQogICAgICAgICAgICBpZih0b29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJFTVMiKXslPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNb25nb0RCIil7JT4NCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT50aGlzLl9fY29uZmlnKCd1cmknLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdjb25maWcnLCBudWxsLCB7dG9vbDogdG9vbH0pKTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YobW9uZ29kYikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSAoYXdhaXQgbmV3IG1vbmdvZGIuTW9uZ29DbGllbnQodGhpcy5fX2NvbmZpZygndXJpJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygnY29uZmlnJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkuY29ubmVjdCgpKS5kYih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSdSeERCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gYXdhaXQgUnhEQi5jcmVhdGVSeERhdGFiYXNlKHtuYW1lOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSwgc3RvcmFnZTogbnVsbH0pOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSdaYW5nb0RCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IHphbmdvLkRiKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pLCB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICA8JT1uTmFtZShlYyklPjogWyI8JT1lYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gbk5hbWUoZWEpKS5qb2luKCdcIiwgXCInKSU+Il0sDQogICAgICAgIDwlIH0pICU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgPCUgfWVsc2UgaWYodD09J0thZmthJyl7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yoa2Fma2FqcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcga2Fma2Fqcy5LYWZrYSh7DQogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRJZDogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYnJva2VyczogW3RoaXMuX19jb25maWcoJ2Jyb2tlcnMnLCBudWxsLCB7dG9vbDogdG9vbH0pXSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNzbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNhc2w6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdzYXNsX3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWNoYW5pc206IHRoaXMuX19jb25maWcoJ3Nhc2xfbWVjaGFuaXNtcycsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblRpbWVvdXQ6IDMwMDAsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB0b29sLnByb2R1Y2VyID0gdG9vbC5kYi5wcm9kdWNlcigpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLnByb2R1Y2VyLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIHRvb2wuY29uc3VtZXIgPSB0b29sLmRiLmNvbnN1bWVyKHtncm91cElkOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSl9KTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5jb25zdW1lci5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wuY29uc3VtZXIuc3Vic2NyaWJlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb21CZWdpbm5pbmc6IGZhbHNlLA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgICAgICAgICB0b29sLmNvbnN1bWVyLnJ1bih7ZWFjaE1lc3NhZ2U6IGFzeW5jICh7IHRvcGljLCBwYXJ0aXRpb24sIG1lc3NhZ2UgfSkgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KG1lc3NhZ2UudmFsdWUudG9TdHJpbmcoKSkucHJvY2VzcygpfSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSdNZW1vcnknKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICAnPCU9bk5hbWUoZWMpJT4nOiBbXSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgICAgICAgICAgfTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJFeGNlbCIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSA8JT1zY29wZSU+Lnhsc3hEYXRhP1hMU1gucmVhZCg8JT1zY29wZSU+Lnhsc3hEYXRhKTpYTFNYLnV0aWxzLmJvb2tfbmV3KCk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSBYTFNYLnJlYWQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnZmlsZW5hbWUnLCBudWxsLCB7dG9vbDogdG9vbH0pKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09IlNub3dGbGFrZSIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuc25vd2ZsYWtlKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbC5zbm93Zmxha2UuY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiB0aGlzLl9fY29uZmlnKCJhY2NvdW50IiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLl9fY29uZmlnKCJ1c2VybmFtZSIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygicGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb246IHRoaXMuX19jb25maWcoInNjb3BlIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiPCU9c2NvcGUlPiIsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdCgoZXJyLCBjb25uKT0+ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4nVW5hYmxlIHRvIGNvbm5lY3Q6ICcgKyBlcnIubWVzc2FnZSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlaihlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdGlvbl9JRCA9IGNvbm4uZ2V0SWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5lbzRqLmRyaXZlcigNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygndXJsJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgbmVvNGouYXV0aC5iYXNpYyh0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkNCiAgICAgICAgICAgICAgICApOw0KICAgIDwlfWVsc2UgaWYodD09IkFpclRhYmxlIil7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gew0KICAgICAgICAgICAgICAgICAgICBiYXNlSWQ6ICcnLA0KICAgICAgICAgICAgICAgICAgICB3b3Jrc3BhY2VJZDogdGhpcy5fX2NvbmZpZygnd29ya3NwYWNlSWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnLA0KICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS93aG9hbWknKSkuaWQsDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIGxldCBiYXNlcyA9IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS9iYXNlcycpKS5iYXNlczsNCiAgICAgICAgICAgICAgICBpZihiYXNlcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiLmJhc2VJZCA9IGJhc2VzLmZpbHRlcihiID0+IGIubmFtZT09JzwlPXNjb3BlJT4nKS5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYi5iYXNlSWQpIHRvb2wuZGIuYmFzZUlkID0gJ2FwcCcgKyB0aGlzLl91dWlkKCkuc3BsaXQoJy0nKS5zbGljZSgtMSlbMF07DQogICAgPCV9ZWxzZSBpZih0PT0iU3FsREIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXSl7DQogICAgICAgICAgICAgICAgICAgIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uRGF0YWJhc2Upew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHRvb2wpXS5EYXRhYmFzZSh0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIi4vPCU9c2NvcGUlPi5kYiIpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLmNyZWF0ZUNvbm5lY3Rpb24pew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdDogdGhpcy5fX2NvbmZpZygnc2VydmVyJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiB0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhYmFzZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICI8JT1zY29wZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLkNsaWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uQ2xpZW50KHtjb25uZWN0aW9uU3RyaW5nOiB0aGlzLl9fY29uZmlnKCdjb25uc3RyJywgbnVsbCwge3Rvb2w6IHRvb2x9KX0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5kYi5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoZ2xvYmFsKT09PSd1bmRlZmluZWQnICYmIHRoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pPT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAvLyBzcWxpdGUgaW4gYnJvd3Nlcg0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IFNRTC5EYXRhYmFzZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodG9vbC5zeXNfc2NvcGUpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyB0b29sLnN5c19zY29wZSA9IChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfYXBwIiwge3N5c19zY29wZTogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICJnbG9iYWwifSkpWzBdLnN5c19pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRvb2wuc3lzX3Byb3BlcnRpZXMpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyBsb2FkaW5nIHNvbWUgcGxhdGZvcm0gc3R1ZmYNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5zeXNfcHJvcGVydGllcyA9IHt9Ow0KICAgICAgICAgICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gT2JqZWN0LmtleXModG9vbC5zeXNfcHJvcGVydGllcykuZmlsdGVyKGsgPT4gIXRvb2wuc3lzX3Byb3BlcnRpZXNba10pLmpvaW4oJywnKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoY29uZGl0aW9uKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfcHJvcGVydGllcyIsIHtuYW1lOiAiSU4iK2NvbmRpdGlvbn0pKS5mb3JFYWNoKHIgPT4gdG9vbC5zeXNfcHJvcGVydGllc1tyLm5hbWVdID0gci52YWx1ZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgPCV9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCjwlIH0lPg0KICAgIH0NCiAgICAvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovDQogICAgDQogICAgPCU9bU5hbWU9J19tYXRjaGVzJyU+KHF1ZXJ5LCBvcHRpb25zKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lIT0iPCU9bk5hbWUoYyklPiIpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgICAgICAvL0Z1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgLy9OdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5faWQgPSB0aGlzLklkPT1xdWVyeS5JZCwNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY/di48JT1tTmFtZSU+KHF1ZXJ5P3F1ZXJ5LjwlPW5OYW1lKGVhKSU+KCk6bnVsbCk6dHJ1ZTsNCiAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY9PXF1ZXJ5LjwlPW5OYW1lKGVhKSU+KCk7DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoDQogICAgICAgICAgICAgICAgICAgICAgICAodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmICFxdWVyeS5fPCU9bk5hbWUoZWEpJT5fc2V0KSB8fA0KICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UNCiAgICAgICAgICAgICAgICAgICAgKSBvYmouPCU9bk5hbWUoZWEpJT4gPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYoDQogICAgICAgICAgICAgICAgICAgICAgICAoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiBxdWVyeS5fPCU9bk5hbWUoZWEpJT5fc2V0KSB8fA0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIXRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KHF1ZXJ5LjwlPW5OYW1lKGVhKSU+KCkpKSB8fA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICAgICAgICApIG9iai48JT1uTmFtZShlYSklPiA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pOyAlPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IHF1ZXJ5LjwlPXRhTmFtZSU+KCkuYW55KHEgPT4gX3YuPCU9bU5hbWUlPihxKSkpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5vTWF0Y2gpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX21hdGNoaW5nJyU+KHF1ZXJ5KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IkZvciA8JT1uTmFtZShlYSklPiIpOw0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9bk5hbWUoZWEpJT4gPSB2P1t2LjwlPW1OYW1lJT4ocXVlcnkpP3Y6bnVsbF0uY29uY2F0KHYuPCU9bU5hbWUlPihxdWVyeSkpLmZpbHRlcihtID0+IG0pOltdOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9dGFOYW1lJT4gPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KHF1ZXJ5KSkuZmxhdCgpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT4ibWF0Y2hlcyIsIG1hdGNoZXMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtIT1xdWVyeSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZVJlZmVyZW5jZSclPihyb290KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXJvb3QpIHJvb3Q9dGhpczsNCg0KICAgICAgICAgICAgaWYocm9vdCE9dGhpcyAmJiB0aGlzLlNldF9Pbikgew0KICAgICAgICAgICAgICAgIGxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsNCiAgICAgICAgICAgICAgICBpZighbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIG15TWF0Y2hlc1swXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB2LjwlPW1OYW1lJT4ocm9vdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXQhPXYpIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmV0KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pOyAlPg0KICAgICAgICANCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICB2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB0YS48JT1tTmFtZSU+KHJvb3QpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocmV0IT10YSkgdGhpcy48JT10YU5hbWUlPigpW2ldID0gcmV0Ow0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21Eb2N1bWVudCclPihvYmosIGJUb29sKXsNCiAgICAgICAgaWYoIW9iaikgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmKG9iai48JT1tTmFtZSU+KSByZXR1cm4gb2JqOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKG9iaik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICBpZig8JT1fYjY0dGVzdCgnb2JqJyklPikgb2JqID0gdGhpcy5fYXRvYihvYmopOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaWYob2JqLmxlbmd0aDwzMyAmJiAhb2JqLm1hdGNoKC9ccy9nKSl7DQogICAgICAgICAgICAgICAgICAgIG9iaiA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJywge3Rvb2w6IG9iai5fX3Rvb2x9KV06IG9iag0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmogPSBKU09OLnBhcnNlKG9iaik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJJbnZhbGlkIEpTT04gb3IgVVVJRCIsIG9iaik7DQogICAgICAgICAgICB9DQogICAgICAgIH1lbHNlIGlmKEFycmF5LmlzQXJyYXkob2JqKSl7DQogICAgICAgICAgICByZXR1cm4gb2JqLm1hcChvID0+IHRoaXMuPCU9bU5hbWUlPihvLCBiVG9vbCkpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZihvYmouX190b29sKSB0aGlzLlRvb2wgPSBvYmouX190b29sOw0KICAgICAgICANCiAgICAgICAgaWYoIU9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSkhPT0ndW5kZWZpbmVkJyAmJiBvYmpba10hPT1udWxsKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJFbXB0eSBvYmplY3Qgb3Igb2JqZWN0IG9mIG51bGxzIiwgb2JqKTsNCiAgICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bG9nKCklPm9iaik7DQogICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KG9iaiwgew0KICAgICAgICAgICAgX21hcDogYlRvb2wsDQogICAgICAgICAgICBpbXBvcnRlcjogdiA9PiB2Lm9iaiA9ICh2Lm9iaiYmdi5vYmouU2V0X0NvdW50PHRoaXMuU2V0X0NvdW50KT90aGlzOnYub2JqLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlM/b2JqLk9QRVJBVE9SUy5USElTOnVuZGVmaW5lZCksDQogICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYoaWRDb2RlPT0nSWQnKSBpZENvZGUgPSB0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyk7DQogICAgICAgICAgICAgICAgaWYob2JqW2lkQ29kZV0pIHRoaXMuSWQgPSBvYmpbaWRDb2RlXTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZihvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSl7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCByZWYgPSBvYmpbZWFDb2RlXTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YocmVmKT09PSd1bmRlZmluZWQnKSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICA8JSBpZighZWEuSXNBcnJheSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IlJlc3REQklPIikgcmVmID0gcmVmWzBdOw0KICAgICAgICAgICAgICAgIGlmKCFyZWYpIHJldHVybjsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQoNCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KCh0aGlzLjwlPW5OYW1lKGVhKSU+KCkgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPihyZWYsIGJUb29sKSk7DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSJTcWxEQiIpew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobW9tZW50KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IG5ldyBEYXRlKHJlZik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHJlZik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZWYuaW5kZXhPZignVCcpPjApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IERhdGUucGFyc2UocmVmKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IERhdGUucGFyc2UocmVmICsgIiBHTVQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZWYgPSBuZXcgRGF0ZShyZWYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHJlZik7DQogICAgICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHJlZik7DQogICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSkgPT4gb2JqW2VhQ29kZV0/dGhpcy48JT10YU5hbWUlPihvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KF92LCBiVG9vbCkpLCBvYmouT1BFUkFUT1JTP29iai5PUEVSQVRPUlNbZWFDb2RlXTp1bmRlZmluZWQsIHRydWUpOnVuZGVmaW5lZCwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KICAgIA0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgIDwlPW1OYW1lPSdfdG9Qcm90byclPihvcHRpb25zPXt9LCBzUGF0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogPCU9X25Db2RlKCklPiwgcHJvdG86IGBcblxubWVzc2FnZSAkezwlPV9uQ29kZSgpJT59IHtgLCBpbmRleDogMX0sIHsNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLmJNYXAsDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHYub2JqPSh2LnJldXNlZD4xKT97cHJvdG86IGBcblxuLy8gcmV1c2VkWyR7di5yZXVzZWR9XTogJHs8JT1fbkNvZGUoKSU+fVxuXG5gfTp2Lm9iaiwNCiAgICAgICAgICAgICAgICBfVEhJUzogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRyZXBlYXRlZCAkezwlPV9uQ29kZSgpJT59ICR7ZWFDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0c3RyaW5nICR7aWRDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSBgXG5cdGAgKyBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfWApOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGBcblx0YDsNCiAgICAgICAgPCUgaWYoZWEuUmVxdWlyZWQpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwldmFsdWVPZihlYS5SZXF1aXJlZCklPikgb2JqLnByb3RvICs9ICdyZXF1aXJlZCAnOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICdyZXBlYXRlZCAnOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgPCUgaWYoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gInN0cmluZyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJib29sIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbnQpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiaW50MzIiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0xvbmcpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiaW50NjQiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Zsb3QpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiZmxvYXQiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJkb3VibGUiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAic3RyaW5nIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IDwlPV9uQ29kZShlYS5FbnRpdHlUeXBlKSU+Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGAgJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRgICsgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9W11gKSArIGBcblx0cmVwZWF0ZWQgJHs8JT1fbkNvZGUodGEuRW50aXR5Q2xhc3MpJT59ICR7ZWFDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0c3RyaW5nICR7ZWZDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF9fY2xvc2U6IG9iaiA9PiBvYmoucHJvdG8gKz0gJ1xufVxuXG4nLA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBvcHRpb25zLCBzUGF0aCkucHJvdG87DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHJldCAmJiAhc1BhdGgpew0KICAgICAgICAgICAgICAgIHJldCA9IGBwYWNrYWdlIDwlPXNjb3BlJT47XG5cbnN5bnRheCA9ICJwcm90bzMiO1xuXG5gICsgcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlfSU+DQoNCiAgICA8JT1tTmFtZT0nX3RvSlNPTiclPihvcHRpb25zPXt9LCBzUGF0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHNQYXRoID0gc1BhdGggfHwgIiI7DQogICAgICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgICAgICByZXQuX19rZXlzID0gW107IC8vISENCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuYk1hcCl7DQogICAgICAgICAgICAgICAgcmV0Ll9fZ2VuZXJhdGVkID0gJyInICsgbmV3IERhdGUoKS50b0lTT1N0cmluZygpICsgJyInOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5uYW1lKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fdG9vbCA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbC5uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIHJldC5fX2NsYXNzID0gJyI8JT1uTmFtZShjKSU+Iic7DQogICAgICAgICAgICAgICAgICAgIHJldC5fX3R5cGUgPSAnIicrPCU9X25Db2RlKCklPisnIic7DQogICAgICAgICAgICAgICAgICAgIC8vcmV0Ll9fcGF0aCA9ICciJytzUGF0aCsnIic7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKDwlPW5zY29wZSU+Ll9ub2RlKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fbm9kZSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IDwlPW5zY29wZSU+Ll9ub2RlLmNvZGUoKQ0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHRoaXMuX2RlZmF1bHRzKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0ck1hcCA9IChvYmosIGVhQ29kZSwgdiwgc1BhdGgpID0+ICh2ICYmIHR5cGVvZih2KT09PSdzdHJpbmcnICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKC88PFtePj5dKz4+L2dtLCBtID0+IHsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fdHJNYXAgPSA8JT1zY29wZSU+Ll9fdHJNYXAgfHwgW107DQoNCiAgICAgICAgICAgICAgICBsZXQgdHJpZCA9IHRoaXMuX3V1aWQoKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgcFBhdGggPSAnLicrKHNQYXRoLnNwbGl0KCcuJykuc2xpY2UoMSwgLTEpLmpvaW4oJy4nKSk7DQogICAgICAgICAgICAgICAgaWYocFBhdGg9PSIuIikgcFBhdGggPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgdHIgPSBtLnJlcGxhY2UoJzw8JywgJycpLnJlcGxhY2UoJz4+JywgJycpLnJlcGxhY2UoL3t7bnJ9fS9nbSwgJyRub3QoJGV4aXN0cyhfX3JldXNlZCkpJykucmVwbGFjZSgve3t2Zn19L2csIG9ialtlYUNvZGVdKTsNCiAgICAgICAgICAgICAgICBpZih0ci5zdGFydHNXaXRoKCdzKCcpICYmIHRyLmVuZHNXaXRoKCcpJykpew0KICAgICAgICAgICAgICAgICAgICB0ciA9IHRyLnJlcGxhY2UoL3t7X199fS9nbSwgJ29KU09OJytzUGF0aCkucmVwbGFjZSgve3twcGF0aH19L2dtLCAnb0pTT04nK3BQYXRoKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgdHIgPSB0ci5yZXBsYWNlKC97e19ffX0vZ20sIGAqKltJZD0ke29iai5JZH1dWzBdYCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gPCU9d2FybigpJT5lYUNvZGUsIHRyaWQsIHRyKTsNCg0KICAgICAgICAgICAgICAgIHRyID0gdGhpcy5fYnRvYSh0cik7DQogICAgICAgICAgICAgICAgbGV0IG1hcCA9IDwlPXNjb3BlJT4uX190ck1hcC5maW5kKG8gPT4gby50cmFuc2Zvcm09PXRyKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gKG1hcD9tYXAuaWQ6PCU9c2NvcGUlPi5fX3RyTWFwWzwlPXNjb3BlJT4uX190ck1hcC5wdXNoKHtpZDogdHJpZCwgdHJhbnNmb3JtOiB0cn0pLTFdLmlkKTsNCiAgICAgICAgICAgIH0pOnY7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICAgICAgX21hcDogb3B0aW9ucy5iTWFwLA0KICAgICAgICAgICAgICAgIEZ1bGw6IG9wdGlvbnMuYkZ1bGwsDQogICAgICAgICAgICAgICAgTnVsbDogb3B0aW9ucy5iTnVsbCwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnJldXNlZCk9PT0ndW5kZWZpbmVkJyB8fCBvcHRpb25zLnJldXNlZD49di5yZXVzZWQpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5vYmogJiYgdHlwZW9mKHYub2JqLl9yZXR1cm4pPT09J3N0cmluZycgJiYgdi5vYmouX3JldHVybi5pbmRleE9mKCdfX3JldXNlZDogMScpPjApIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBvSGFzaCA9IG9wdGlvbnMuYkhhc2g/W3RoaXMuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub0FyZ3M6IHRydWUsIF9tYXA6IG9wdGlvbnMuYk1hcCwgbm9UeXBlczogZmFsc2V9LCAiPCU9bU5hbWUlPiIpXTpPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+IGs9PSdJZCcgfHwgay5pbmRleE9mKCdfXycpPT0wKS5tYXAoayA9PiB7dHJ5e3JldHVybiB7IFtrXTogSlNPTi5wYXJzZShyZXRba10pIH07IH1jYXRjaChleCl7cmV0dXJuIHtba106IHJldFtrXX07IH0gfSk7DQogICAgICAgICAgICAgICAgICAgIGxldCBlUmV0ID0gT2JqZWN0LmFzc2lnbiguLi5vSGFzaCwge19fcmV1c2VkOiB2LnJldXNlZH0gKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShlUmV0Ll9fa2V5cykpIGVSZXQuX19rZXlzLmZvckVhY2goZWsgPT4ge3RyeXsgZVJldFtla10gPSBKU09OLnBhcnNlKHJldFtla10pO31jYXRjaChleCl7ZVJldFtla10gPSByZXRbZWtdOyB9IH0pOw0KDQogICAgICAgICAgICAgICAgICAgIHYub2JqID0ge19yZXR1cm46IEpTT04uc3RyaW5naWZ5KGVSZXQpfTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIF9USElTOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYob3B0aW9ucy5iTWFwKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIG9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfWApKTsNCiAgICAgICAgICAgICAgICAgICAgb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmpbaWRDb2RlXSA9IGAiJHt2fSJgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5Jc1VuaXF1ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYob2JqLl9fa2V5cykgb2JqLl9fa2V5cy5wdXNoKGVhQ29kZSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgICAgICBpZighPCU9X2I2NHRlc3QoJ3YnKSU+KXsgLy8gaXMgbm90IGJhc2U2ND8NCiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLl9idG9hKHYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgdiA9IHYmJnYudG9JU09TdHJpbmc/di50b0lTT1N0cmluZygpOnY7DQogICAgICAgIDwlIH0lPg0KICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2P3YuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk6J251bGwnOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wgfHwgZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQgfHwgZWEuSXNEb3VibGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdHJNYXAob2JqLCBlYUNvZGUsIHYsIHNQYXRoKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSAnIicgKyB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9ICdbJyArICh2IHx8IFtdKS5tYXAoKF92LCBfaSkgPT4gX3YuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9WyR7X2l9XWApKS5maWx0ZXIoX3YgPT4gX3YpLmpvaW4oKSArICddJywNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodikpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSBKU09OLnN0cmluZ2lmeSh2KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdHJNYXAob2JqLCBlZkNvZGUsIHYsIHNQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSd1bmRlZmluZWQnKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtlZkNvZGVdID0gdjsNCiAgICAgICAgPCUgaWYoIWVmLklzQm9vbCAmJiAhZWYuSXNJbnQgJiYgIWVmLklzTG9uZyAmJiAhZWYuSXNGbG9hdCAmJiAhZWYuSXNEb3VibGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9ICciJyArIG9ialtlZkNvZGVdICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KDQogICAgICAgICAgICAgICAgX190ck1hcDogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXNQYXRoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5fX3RyTWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIDwlPXNjb3BlJT4uX190ck1hcDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICAgICBfcmV0dXJuOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvYmopIG9iai5fcmV0dXJuID0gKE9iamVjdC5rZXlzKG9ianx8e30pLmxlbmd0aCk/KCd7JyArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSk9PT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtvYmpba119YCkuY29uY2F0KE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSkhPT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtKU09OLnN0cmluZ2lmeShvYmpba10pfWApKS5qb2luKCkgKyAnfScpOidudWxsJzsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBvcHRpb25zLCBzUGF0aCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD9yZXQuX3JldHVybjpyZXQ7DQogICAgICAgICAgICByZXQgPSB0eXBlb2YocmV0KT09PSd1bmRlZmluZWQnP251bGw6cmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighc1BhdGggJiYgcmV0KXsNCiAgICAgICAgICAgICAgICByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsICdqYXZhc2NyaXB0Jyk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5wYXJzZSkgcmV0dXJuIEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmd6aXApIHJldHVybiB0aGlzLlV0ZjhBcnJheVRvU3RyKHRoaXMuX2NvbXByZXNzKHJldCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J190b0RvY3VtZW50JyU+KG9wdGlvbnM9e30pew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQganNvbiA9IHRoaXMuX3RvSlNPTihvcHRpb25zKTsNCiAgICAgICAgICAgIGxldCBvSlNPTiA9IEpTT04ucGFyc2UoanNvbik7DQogICAgICAgICAgICBsZXQgdHJNYXAgPSBvSlNPTi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgZGVsZXRlIG9KU09OLl9fdHJNYXA7DQogICAgICAgICAgICBqc29uID0gSlNPTi5zdHJpbmdpZnkob0pTT04pOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT4uLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Li4ucyk7DQogICAgICAgICAgICBsZXQgZXJyb3IgPSAoLi4ucykgPT4gPCU9ZXJyb3IoKSU+Li4ucyk7DQoNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiB0ck1hcCl7DQogICAgICAgICAgICAgICAgaWYoIW5ldyBSZWdFeHAodC5pZCkudGVzdChqc29uKSkgY29udGludWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHRybiA9IHRoaXMuX2F0b2IodC50cmFuc2Zvcm0pOw0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgb0pTT04gPSBKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICAgICAgICAgICAgICBsZXQgcmVzID0gdW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodHJuLnN0YXJ0c1dpdGgoInMoIikgJiYgdHJuLmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdGhpcy5ydW5TY3JpcHQoYChvSlNPTiwgb1Njb3BlLCBsb2csIHdhcm4sIGVycm9yKSA9PiAke3Rybi5zdWJzdHJpbmcoMiwgdHJuLmxlbmd0aC0xKX1gKShvSlNPTiwgPCU9c2NvcGUlPiwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXMgPSBhd2FpdCBqc29uYXRhKHRybikuZXZhbHVhdGUob0pTT04pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvLzwlPXdhcm4oKSU+dC5pZCwgcmVzLCB0cm4pOw0KICAgICAgICAgICAgICAgICAgICBqc29uID0ganNvbi5yZXBsYWNlKG5ldyBSZWdFeHAodC5pZCwgImciKSwgKCFBcnJheS5pc0FycmF5KHJlcykgJiYgdHlwZW9mKHJlcykhPT0nb2JqZWN0Jyk/cmVzOnRoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkocmVzKSkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+dC5pZCwgdHJuLCBleCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBqc29uID0ganNvbi5yZXBsYWNlKC8iX190ck1hcCI6XHNcW1x7W14+Pl0rXH1cXS9nbSwgJyJfX3RyTWFwIjogIiInKTsNCg0KICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYkpTT04/dGhpcy5fYmVhdXRpZnkoanNvbiwgJ2phdmFzY3JpcHQnKTpKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQo8JSBbew0KICAgIHdPYmo6ICdzcicsDQogICAgZnVuY3Rpb25zOiBbJ2hhc2hDb2RlJywgJ0VxdWFscycsICdzZXJ2ZXJEYXRlJywgJ19fc2NvcGUnLCAnYWRkTVNlY29uZHMnLCAnaXBBZGRyZXNzJ10uY29uY2F0KG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pP1snXycsICdidWlsZFVSTCcsICckX1JFUVVFU1QnLCAncGFyYW0nLCAnX3RvWE1MJywgJ2Nvb3AnLCAnT1InLCAnbXlSZXBsYWNlJywgJ3NlbmRYTUwnLCAncHJvY2Vzc1Jlc3BvbnNlJywgJ3Byb2Nlc3NSZXN1bHQnLCAncnVuU1JTY3JpcHQnLCAnZ3JvdXBCeScsICdTaG93RGVidWcnLCAnY2FjaGVSZXN1bHQnLCAndG9IZXgnLCAnU2hvd0Vycm9yJ106W10pLA0KfSwgew0KICAgIHdPYmo6ICdfRnJFTUQnLA0KICAgIGZ1bmN0aW9uczogWydfYXR0cicsICdydW5TY3JpcHQnLCAnX3VuaXF1ZScsICdzcicsICdfYXRvYicsICdfZ2V0U3RvcmVkU2NyaXB0JywgJ19idG9hJywgJ19fdGltZScsICdfd2FpdCcsICdfc3FsVHlwZScsICdfdXVpZCcsICdyZXF1aXJlJywgJ19pbmNsdWRlJywgJ19iZWF1dGlmeScsICdfaW5qZWN0JywgJ19jb21wcmVzcycsICdfZGVjb21wcmVzcycsICdVdGY4QXJyYXlUb1N0cicsICdyYW5kVVJMJ10sDQp9XS5mb3JFYWNoKGNjID0+IHsgJT4NCi8qIFNUQVJUOiA8JT1jYy53T2JqJT4gZnVuY3Rpb24gY29waWVzICovDQo8JSBjYy5mdW5jdGlvbnMuZm9yRWFjaChmID0+IHslPg0KDQovKiBDTE9ORTo6U1RBUlQ6IDwlPWNjLndPYmolPi48JT1mJT4oKSAqLzwlPV9GckVNRC5fY2xvbmVGdW5jdGlvbihjYy53T2JqLCBmLCBzY29wZSwgYykgJT4vKiBDTE9ORTo6RU5EICA6IDwlPWNjLndPYmolPi48JT1mJT4oKSAqLw0KPCUgfSklPg0KLyogRU5EOiA8JT1jYy53T2JqJT4gZnVuY3Rpb24gY29waWVzICovDQo8JSB9KTsgJT4NCiAgICANCiAgICA8JT1tTmFtZT0naTE4biclPihldiwgdil7DQogICAgICAgIGlmKHR5cGVvZih3aW5kb3cpPT09InVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKT09PSJ1bmRlZmluZWQiKSByZXR1cm4gdjsNCiAgICAgICAgDQogICAgICAgIGlmKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpew0KICAgICAgICAgICAgcmV0dXJuIHY7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsNCiAgICAgICAgfQ0KICAgIH0NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bU5hbWU9J2J5JyArIG5OYW1lKGVhLkVudGl0eVR5cGUpJT4oYXIpIHsNCiAgICAgICAgdmFyIHJldCA9IFtdOw0KICAgICAgICBhci5mb3JFYWNoKGEgPT4gew0KICAgICAgICAgICAgcmV0LmZvckVhY2gociA9PiB7DQogICAgICAgICAgICAgICAgaWYgKGFbIl88JT1uTmFtZShlYSklPiJdICYmIChhWyJfPCU9bk5hbWUoZWEpJT4iXS5FcXVhbHM/YVsiXzwlPW5OYW1lKGVhKSU+Il0uRXF1YWxzKHIpOnNyLkVxdWFscyhhWyJfPCU9bk5hbWUoZWEpJT4iXSwgcikpKSB7DQogICAgICAgICAgICAgICAgICAgIHIuXzwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+LnB1c2goYSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0pJT4NCg0KICAgIDwlPW1OYW1lPSd0b1N0cmluZyclPigpIHsNCjwlDQp2YXIgc0VhcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSAmJiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSk7DQp2YXIgX25hbWUgPSBzRWFzLmZpbmQoZWEgPT4gZWEuTmFtZS50b0xvd2VyQ2FzZSgpPT0nbmFtZScpOw0KaWYoX25hbWUpew0KJT4NCiAgICAgICAgcmV0dXJuIHRoaXMuXzwlPW5OYW1lKF9uYW1lKSU+Ow0KPCUNCn1lbHNlew0KJT4NCiAgICAgICAgcmV0dXJuIHRoaXMuSWQ7DQo8JQ0KfQ0KJT4NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nRW50aXR5VmFsdWUnJT4oYU5hbWUpIHsNCiAgICAgICAgbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7DQogICAgICAgIA0KICAgICAgICBpZighcmV0KXsNCiAgICAgICAgICAgIC8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlDQogICAgICAgICAgICByZXQgPSB7QWN0aXZlOiB0cnVlLCBPUEVSQVRPUlM6IHt9LCBFbnRpdHlBdHRyaWJ1dGU6IHtOYW1lOiBhTmFtZSwgQWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczoge0lkOiB0aGlzLkVudGl0eUNsYXNzLklkfX19Ow0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kJyU+KGRlcHRoID0gMSwgb2JqcywgZmllbGRzKSB7DQogICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoLCBvYmpzLCBudWxsLCBudWxsLCBmaWVsZHMpKVswXTsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX19hc3NlcnRWYWxpZCclPihiU3luYyl7DQo8JSBpZighYy5Ub29scy5sZW5ndGgpeyU+DQogICAgICAgIHJldHVybiB0cnVlOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgbGV0IGVycm9yID0ge307DQoNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuUmVxdWlyZWQpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKDwldmFsdWVPZihlYS5SZXF1aXJlZCklPil7DQogICAgICAgICAgICBlcnJvci48JT1uTmFtZShlYSklPiA9IHt9Ow0KICAgICAgICAgICAgaWYoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgZXJyb3IuPCU9bk5hbWUoZWEpJT5bIjAxIl0gPSAiTm90IFNldCI7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZighdGhpcy48JT1uTmFtZShlYSklPigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDIiXSA9ICJFbXB0eSBWYWx1ZSI7DQogICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgYlN5bmMgJiYgIXRoaXMuPCU9bk5hbWUoZWEpJT4oKS5fX3N5bmNfb24oKSkgZXJyb3IuPCU9bk5hbWUoZWEpJT5bIjAzIl0gPSAiTm90IGluIFN5bmMiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIGlmKCFPYmplY3Qua2V5cyhlcnJvci48JT1uTmFtZShlYSklPikubGVuZ3RoKSBkZWxldGUgZXJyb3IuPCU9bk5hbWUoZWEpJT47DQogICAgICAgIH0NCiAgICA8JSB9KSU+DQoNCiAgICAgICAgaWYoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCl7DQogICAgICAgICAgICB0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPkpTT04uc3RyaW5naWZ5KGVycm9yLG51bGwsNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3JhbmsnJT4oXzwlPW1OYW1lJT49MCl7DQoJCXRyeSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh7XzwlPW1OYW1lJT46IF88JT1tTmFtZSU+fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5yZXVzZWQ/di5vYmouX19yZXVzZWQgPSB2LnJldXNlZDowLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gIjwlPV9jTmFtZShjLCB0cnVlKSU+IiwNCgk8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouXzwlPW1OYW1lJT4gKz0gKG9ialtlYUNvZGVdID0gKHYgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPihfPCU9bU5hbWUlPisxKSkuXzwlPW1OYW1lJT4sDQoJPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IChvYmpbdGFDb2RlXSA9IFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5VHlwZSwgdHJ1ZSklPigpXS5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihfPCU9bU5hbWUlPisxKSkpLmZvckVhY2godiA9PiB2Ll88JT1tTmFtZSU+KSwNCiAgICA8JSB9KSU+DQoJICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KCQl9IGNhdGNoIChleCkgew0KCQkJPCU9ZXJyb3IoKSU+ZXgpOw0KCQl9DQoJfQ0KDQogICAgPCU9bU5hbWU9J19pc1F1ZXJ5JyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KC8qX190eXBlKi97SWQ6ICI8JT1uTmFtZShjKSU+IiwgPCU9bU5hbWUlPkNvdW50OiAwfSwgew0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0ge19jb29wOiB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIHx8IHVuZGVmaW5lZH07DQogICAgICAgICAgICAgICAgb2JqLjwlPW1OYW1lJT5Db3VudCArPSB0eXBlb2Yob2JqW2VhQ29kZV0uX2Nvb3ApPT09InVuZGVmaW5lZCI/MDoxOw0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi48JT1tTmFtZSU+KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0uX29iamVjdCA9IHYuPCU9bU5hbWUlPigpOw0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IG9ialtlYUNvZGVdLl9vYmplY3QuPCU9bU5hbWUlPkNvdW50Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgdGFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW3RhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgdW5kZWZpbmVkLCBfb2JqZWN0czogKHZ8fFtdKS5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKX07DQogICAgICAgICAgICAgICAgaWYob2JqW3RhQ29kZV0uX29iamVjdHMubGVuZ3RoKSBvYmpbdGFDb2RlXS48JT1tTmFtZSU+Q291bnQgKz0gb2JqW3RhQ29kZV0uX29iamVjdHMucmVkdWNlKCh2LCBvKSA9PiB2ICs9IG8uPCU9bU5hbWUlPkNvdW50KTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19uZXcnJT4oY2xOYW1lKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbE5hbWUpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgc3dpdGNoKGNsTmFtZSl7DQogICAgPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgICAgICAgICAgICAgY2FzZSAiPCU9bk5hbWUoX2MpJT4iOg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKF9jLCB0cnVlKSU+KCk7DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J3N0b3JlJyU+KCkgew0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bU5hbWUlPiIsIDwlbVJvdXRpbmcoYyklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICAgICAgDQogICAgICAgIGxldCBiVXBkYXRlID0gZmFsc2U7DQogICAgICAgIGxldCBiSW5zZXJ0ID0gZmFsc2U7DQoNCiAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSl7DQogICAgICAgICAgICA8JT13YXJuKCklPiJzdG9yaW5nIGRpc2FibGVkIik7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX2lzUXVlcnkoKS5faXNRdWVyeUNvdW50KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IkNhbm5vdCBzdG9yZSBhIHF1ZXJ5ISIpOw0KICAgICAgICB9ZWxzZSBpZighdGhpcy5fX3N5bmNfb24oKSl7DQogICAgICAgICAgICBsZXQgX3RoaXMgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBiRmluZCA9IGZhbHNlOw0KICAgICAgICAgICAgaWYodGhpcy5JZD09dGhpcy5JZCl7DQogICAgICAgICAgICAgICAgYkZpbmQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIF90aGlzLklkID0gdGhpcy5JZDsNCiAgICAgICAgICAgIH0NCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZig8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pew0KICAgICAgICAgICAgICAgIGJGaW5kID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBfdGhpcy48JT1uTmFtZShlYSklPih0aGlzLjwlPW5OYW1lKGVhKSU+KCksICc9Jyk7DQogICAgICAgICAgICB9DQo8JSB9KTsgJT4NCg0KICAgICAgICAgICAgaWYoYkZpbmQpew0KICAgICAgICAgICAgICAgIF90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOw0KICAgICAgICAgICAgfWVsc2UgX3RoaXMgPSBudWxsOw0KICAgICAgICAgICAgaWYoX3RoaXMpew0KICAgICAgICAgICAgICAgIHRoaXMuSWQgPSBfdGhpcy5JZDsNCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT4iX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7DQogICAgICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUNCiAgICAgICAgICAgICAgICBiSW5zZXJ0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsiPCIrdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICBpZighYlVwZGF0ZSAmJiAhYkluc2VydCl7DQogICAgICAgICAgICA8JT1sb2coKSU+Ik5vIGRhdGEgY2hhbmdlcyIpOw0KICAgICAgICB9ZWxzZXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uKT09PSJ1bmRlZmluZWQiIHx8IDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiA9IHtPd25lcjogdGhpcywgc3FsczogW10sIHN0YXJ0OiBuZXcgRGF0ZSgpLCBlbmQ6IG51bGx9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIShhd2FpdCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPigpKSkgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YD09PT4gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIGlmKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7DQogICAgICAgICAgICBpZihiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmA8PT09IEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSl7DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU3luY2luZy4uLjwlPXRhTmFtZSU+IiwgdGEpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0YS48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGJVcGRhdGUgfHwgYkluc2VydCl7DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLk93bmVyPT10aGlzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdpbnNlcnQnJT4oKXsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLlRvb2wuZGIuZ2V0Q29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikuaW5zZXJ0T25lKHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS5pbnNlcnRPbmUoJHt0aGlzLl90b0pTT04oe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uPCU9bU5hbWUlPih0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJLYWZrYSIpIHslPg0KICAgICAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJyk7DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5wdXNoKHRoaXMpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJOZW80aiIpIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2FsZXNGb3JjZSIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+LklkOw0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgICAgIGxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7DQogICAgDQogICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIjwlPW5OYW1lKGMpJT4iKS5jcmVhdGUob2JqKTsNCiAgICAgICAgICAgIHRoaXMuSWQgPSByZXMuaWQ7DQogICAgPCUgfSBlbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKSB7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlNlcnZpY2VOb3ciKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIGF3YWl0IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKSk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkdpdEh1YiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJGaWxlU3lzdGVtIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxlc3lzdGVtKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuSWQgPSAoYXdhaXQgdGhpcy5fdG9FTVNPYmplY3QoKS5zdG9yZSgpKS5JZDsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIGxldCBvYmogPSB7fTsNCiAgICAgICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQvKl9pZCgpKi87DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5Db2RlKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgbG9nKCI8JT10JT4gVVJMIiwgdXJsKTsNCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbG9nKCJyZXN1bHQiLCByZXMuZGF0YSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmVzLmRhdGEpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCBpbnNPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0SW5zZXJ0IiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCBudWxsLCAyKTsNCiAgICAgICAgICAgIGlmKCFpbnNPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5JZCA9IGluc09iai5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gaW5zT2JqLkVudGl0eVZhbHVlczsNCiAgICAgICAgICAgIHRoaXMuX3JldmVydCgpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSAlPg0KDQogICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSd1cGRhdGUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KDQogICAgPCUgaWYodCA9PSAiTW9uZ29EQiIpIHslPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLnVwZGF0ZU9uZSh7X2lkOiB0aGlzLklkfSwgeyRzZXQ6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pOw0KICAgICAgICAgICAgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGBkYi5nZXRDb2xsZWN0aW9uKCckezwlPV9uQ29kZSgpJT59JykudXBkYXRlT25lKHtfaWQ6ICcke3JldC5faWR9J30sIHskc2V0OiAke3RoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPlt0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5maW5kSW5kZXgobyA9PiBvLklkPT10aGlzLklkKV0gPSB0aGlzOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5wcm9kdWNlci5zZW5kKHsNCiAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7DQogICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KQ0KICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nY2FsbDogJyArIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ncmVzcG9uc2U6ICcsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5TWVyZ2UoKSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOw0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07DQogICAgPCUgfWVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksICdwdXQnKSkucmVzdWx0Ow0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJHaXRIdWIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0pTT04oe2JNYXA6IHRydWUsIHJldXNlZDogMX0pLCB0aGlzLklkKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiRmlsZVN5c3RlbSIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmlsZXN5c3RlbSh0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0pTT04oe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiRU1TIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl90b0VNU09iamVjdCgpLnN0b3JlKCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIDwlPWxvZygpJT4iU2VuZGluZyB1cGRhdGUgdG8gUkVTVERCSU8gdG8gc2F2ZSIpOw0KDQogICAgICAgICAgICBsZXQgdXJsID0gImh0dHBzOi8vIiArIHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJykgKyAiLnJlc3RkYi5pby9yZXN0LyIgKyA8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCkgKyAiLyIgKyB0aGlzLklkOw0KICAgICAgICAgICAgLy8gPCU9bG9nKCklPiJVcGRhdGUgdG8gUkVTVERCSU8iLCB1cmwpOw0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IGF4aW9zLnB1dCh1cmwsIG9iaiwgew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgImNhY2hlLWNvbnRyb2wiOiAibm8tY2FjaGUiLA0KICAgICAgICAgICAgICAgICAgICAieC1hcGlrZXkiOiB0aGlzLl9fY29uZmlnKCdhcGlrZXknKSwNCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQtdHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSkuZGF0YTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCB1cGRPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0VXBkYXRlIiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCAyKTsNCiAgICAgICAgICAgIGlmKCF1cGRPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29weUZyb20odXBkT2JqKTsNCiAgICA8JSB9ICU+DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXN1bHQiLCByZXQpOw0KICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCg0KICAgICAgICAgICAgLyoqKiBFTkQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nZmluZEFsbCclPihkZXB0aCA9IDEsIG9ianM9W10sIHN0YXJ0LCBlbmQsIGZpZWxkcykgew0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bU5hbWUlPiIsIDwlbVJvdXRpbmcoYyklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5DQoNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJNb25nb0RCIil7ICU+DQogICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5kYi5jb2xsZWN0aW9uKDwlPV9uQ29kZShjKSU+KS5maW5kKHRoaXMuX3RvU2VsZWN0TW9uZ29EQihmaWVsZHMsIG9ianMpKS50b0FycmF5KCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uZmluZCh0aGlzLl90b1NlbGVjdFJ4REIoZmllbGRzLCBvYmpzKSkuZXhlYygpOw0KICAgIDwlIH1lbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKXsgJT4NCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7ICU+DQogICAgICAgICAgICBsZXQgbyA9IHRoaXMuX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgbyA9IG5ldyA8JT1zY29wZSU+LkVudGl0eU9iamVjdCgpLlRISVMoW29dLmNvbmNhdChvYmpzLm1hcChfbyA9PiBfby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkpKSk7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eU9iamVjdChvKS48JT1tTmFtZSU+KCkpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iTWVtb3J5Iil7ICU+DQogICAgICAgICAgICByZXR1cm4gdGhpcy5Ub29sLmRiWzwlPV9uQ29kZSgpJT5dLmZpbHRlcihvID0+IG8gJiYgdGhpcy5fc2FtZUVudGl0eShvKSk7DQogICAgPCUgfWVsc2UgaWYodD09Ikh1YlNwb3QiKXsgJT4NCiAgICA8JSB9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwge3N5c3Bhcm1fcXVlcnk6IHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMsIHRydWUpfSkpLnJlc3VsdDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iU2FsZXNGb3JjZSIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwge3VybDogJ3Jlc3QudXJsLmdxbCd9KTsNCiAgICA8JSB9ZWxzZSBpZihfZmlsZVRvb2xzLmluZGV4T2YodCk+LTEpeyAlPg0KICAgICAgICAgICAgcmV0ID0gW2F3YWl0IHRoaXMuXzwlPXQudG9Mb3dlckNhc2UoKSU+KHRoaXMuX2ZpbGVOYW1lKCkpXTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgZiBvZiAodGhpcy5USElTKCkgfHwgW10pKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+ImZpbmRpbmcgIitmLm5hbWUoKSk7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgZi5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oZi5fZmlsZU5hbWUoKSkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0ID0gcmV0LmZsYXQoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0Lmxlbmd0aCAmJiB0eXBlb2YocmV0WzBdKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgICAgICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub09wZXJhdG9yczogdHJ1ZX0sICc8JT1tTmFtZSU+JykuX3RoaXMpOw0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImtleXMiLCBrZXlzKTsNCiAgICAgICAgICAgICAgICBsZXQgX3JldCA9IFtdOw0KICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgX3Igb2YgcmV0Lm1hcChyID0+IHIuc3BsaXQoJ19fJykpLm1hcChzciA9PiBPYmplY3QuYXNzaWduKHt9LCAuLi5rZXlzLm1hcCgoaywgaSkgPT4gKHtba106IHNyW2ldfSkpKSkubWFwKHIgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHIpKS5maWx0ZXIociA9PiByKSl7DQogICAgICAgICAgICAgICAgICAgIF9yZXQucHVzaChhd2FpdCBfci5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oX3IuX2ZpbGVOYW1lKCkpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0ID0gX3JldDsNCiAgICAgICAgICAgIH0NCiAgICA8JSB9ZWxzZSBpZih0PT0iTmVvNGoiKXsgJT4NCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lRdWVyeShmaWVsZHMsIG9ianMpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iUmVzdERCSU8iKXsgJT4NCiAgICAgICAgICAgIGxldCB0aGlzRG9jID0gdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pOw0KICAgICAgICAgICAgbGV0IGVhQ29kZSA9ICIiOw0KICAgICAgICA8JSAkLmVhY2goYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKSwgKF8sIGVhKSA9PiB7JT4NCiAgICAgICAgICAgIGVhQ29kZSA9IDwlPV9uQ29kZShlYSklPjsNCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQXJyYXkpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSIhPSIpew0KICAgICAgICAgICAgICAgICAgICB0aGlzRG9jW2VhQ29kZV0gPSB7IiRuaW4iOiB0aGlzRG9jW2VhQ29kZV19Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICB0aGlzRG9jW2VhQ29kZV0gPSB7IiRpbiI6IHRoaXNEb2NbZWFDb2RlXX07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KXsgJT4NCiAgICAgICAgICAgICAgICBpZihbbnVsbCwgJyUnLCAnTElLRSddLmluZGV4T2YodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk+LTEpew0KICAgICAgICAgICAgICAgICAgICB0aGlzRG9jW2VhQ29kZV0gPSB7IiRyZWdleCI6IHRoaXNEb2NbZWFDb2RlXSB8fCAiLioifTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgIDwlIH0pOyAlPg0KDQogICAgICAgICAgICBsZXQgdXJsID0gImh0dHBzOi8vIiArIHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJykgKyAiLnJlc3RkYi5pby9yZXN0LyIgKyA8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCkgKyAiP3E9IiArIEpTT04uc3RyaW5naWZ5KGNvbmRpdGlvbnMpOw0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IGF4aW9zLmdldCh1cmwsIHsNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjYWNoZS1jb250cm9sIjogIm5vLWNhY2hlIiwNCiAgICAgICAgICAgICAgICAgICAgIngtYXBpa2V5IjogdGhpcy5fX2NvbmZpZygnYXBpa2V5JyksDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSkpLmRhdGE7DQogICAgPCUgfWVsc2UgaWYodD09IkJJU2VydmVyIil7ICU+DQogICAgICAgICAgICBsZXQgcSA9IHsNCiAgICAgICAgICAgICAgICBUSElTOiB0aGlzLl9idWlsZFRoaXMoZGVwdGgpLmNvbmNhdCgob2JqcyB8fCBbXSkubWFwKG9iaiA9PiBvYmoudG9FbnRpdHlPYmplY3Q/ew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpLA0KICAgICAgICAgICAgICAgIH06b2JqKSksDQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogeyAvLyBhYnNvbHV0ZWx5IHJlcXVpcmVkIGZvciBpbmRleGluZw0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCksDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5xKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9hc09iamVjdHMoKGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmRhbGwiLCBudWxsLCBxKSkpOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIDwlPWxvZygpJT4iQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIGRlcHRoLCByZXQpOw0KICAgICAgICANCiAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gW3JldF07DQogICAgICAgIHJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlKSkuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gci5fX3N5bmNfb24obmV3IERhdGUoKSkpOw0KICAgICAgICANCg0KICAgICAgICBpZig8JT1KU09OLnN0cmluZ2lmeShfZmlsZVRvb2xzKSU+LmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk+LTEpIHJldCA9IHJldC5maWx0ZXIociA9PiB0aGlzLl9tYXRjaGVzKHIpKTsNCiAgICAgICAgDQogICAgICAgIGlmKGRlcHRoPjEpew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCByIG9mIHJldCl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZihyLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPW5OYW1lKGVhKSU+Iiwgci48JT1uTmFtZShlYSklPigpLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgICAgICByLjwlPW5OYW1lKGVhKSU+KGF3YWl0IHIuXzwlPW5OYW1lKGVhKSU+LmZpbmQoZGVwdGgtMSkpOw0KICAgICAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsgJT4NCiAgICA8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgICAgICA8JSBpZihfZmlsZVRvb2xzLmluZGV4T2YodCk+PTApeyAlPg0KICAgICAgICAgICAgICAgICAgICBsZXQgcl88JT10YU5hbWUlPiA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IF90YSBvZiByLjwlPXRhTmFtZSU+KCkpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiI8JT10YU5hbWUlPiIsIF90YSk7DQogICAgICAgICAgICAgICAgICAgICAgICByXzwlPXRhTmFtZSU+LnB1c2goYXdhaXQgX3RhLmZpbmQoZGVwdGgtMSkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHIuY2xlYXJfPCU9dGFOYW1lJT4oKTsNCiAgICAgICAgICAgICAgICAgICAgci48JT10YU5hbWUlPihyXzwlPXRhTmFtZSU+KTsNCiAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9dGFOYW1lJT4iLCByLjwlPXRhTmFtZSU+KCkpOw0KICAgICAgICAgICAgICAgICAgICByLjwlPXRhTmFtZSU+KGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW5OYW1lKHRhKSU+KHIpDQogICAgICAgICAgICA8JSBpZihmYWxzZSAmJiBbJ1NxbERCJ10uaW5kZXhPZih0KT49MCl7IC8vIHNxbCBzdGF0ZW1lbnRzIGRvIG5vdCBpbmNsdWRlIGxlZnQgam9pbnMgd2l0aG91dCBleHBsaWNpdCByZWZlcmVuY2VzICU+DQogICAgICAgICAgICAgICAgICAgICAgICA8JXRhLkVudGl0eUNsYXNzLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYSE9dGEpLmZvckVhY2goZWEgPT4geyU+LjwlPW5OYW1lKGVhKSU+KG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSk8JX0pJT4NCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgLjwlPW1OYW1lJT4oZGVwdGgtMSkpOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfSklPg0KPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IHJlZnMgPSByZXQuZmlsdGVyKHIgPT4gci5FbnRpdHlDbGFzcyk7DQogICAgICAgIGZvciBhd2FpdCAoY29uc3QgbyBvZiAob2JqcyB8fCBbXSkuZmlsdGVyKF9vID0+ICFfby5fX3N5bmNfb24oKSkpew0KICAgICAgICAgICAgaWYoby5fdG9FTVNPYmplY3Qpew0KICAgICAgICAgICAgICAgIHJlZnMucHVzaCguLi4oYXdhaXQgdGhpcy5fZnJvbUVNU1ZhbHVlcyhhd2FpdCBvLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKS48JT1tTmFtZSU+KGRlcHRoKSkpKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJlZnMucHVzaCguLi4oYXdhaXQgby48JT1tTmFtZSU+KGRlcHRoKSkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJlZnMgPSByZWZzLmZpbHRlcihyID0+IHIpOw0KICAgICAgICANCiAgICAgICAgcmVmcy5mb3JFYWNoKHIgPT4gci5fcmVzb2x2ZShyZWZzKSk7DQoNCiAgICAgICAgPCU9bG9nKCklPiJPdXRwdXQiLCByZXQpOw0KDQogICAgICAgIHJldHVybiByZXQ7DQogICAgICAgICAgICAgICAgLyoqKiBFTkQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCiAgICAgICAgfSwge2RlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMsIF9fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCg0KICAgICAgICByZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7cmV0OiBbXX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfcmVzb2x2ZSclPihyZWZzKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXJlZnMubGVuZ3RoKSByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5fX2ltcG9ydCh7fSwgew0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkpew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT1uTmFtZShlYSklPiIsIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS5JZCwgcmVmcy5tYXAociA9PiAoe2lkOiByLklkLCBjb2RlOiByLmNvZGUoKX0pKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHJlZnMuZmluZChvID0+IG8uSWQ9PXRoaXMuPCU9bk5hbWUoZWEpJT4oKS5JZCkgfHwgdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4ocmVmcykpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46ICgpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy48JT10YU5hbWUlPigpLmxlbmd0aCkgdGhpcy48JT10YU5hbWUlPih0aGlzLjwlPXRhTmFtZSU+KCkubWFwKHRhID0+IHJlZnMuZmluZChvID0+IG8uSWQ9PXRhLklkKSB8fCB0YS48JT1tTmFtZSU+KHJlZnMpKSwgbnVsbCwgdHJ1ZSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCjwlIGlmKG1haW5DbGFzcyhbJ0VNUyddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2Zyb21FTVNWYWx1ZXMnJT4oZXZzKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydFTVMnXSk9PWMpeyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKGV2cywgWy4uLm5ldyBTZXQoZXZzLm1hcCh2ID0+IHYuZW50aXR5QXR0cmlidXRlKCkuSWQpLmZsYXQoKSldLm1hcChpZCA9PiBuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoaWQpKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+ZXZzKTsNCiAgICAgICAgDQogICAgICAgICAgICBsZXQgb2JqcyA9IFtdOw0KICAgICAgICAgICAgdGhpcy5ncm91cEJ5KGV2cywgIl9lbnRpdHlPYmplY3QiKS5mb3JFYWNoKGV2ZyA9PiB7DQogICAgICAgICAgICAgICAgZXZnLmtleS5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKGV2Zy52YWx1ZXMpOw0KICAgICAgICAgICAgICAgIG9ianMucHVzaChldmcua2V5KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBvYmpzLmZvckVhY2gociA9PiByLmVudGl0eUNsYXNzKHIuZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcygpWzBdLmVudGl0eUF0dHJpYnV0ZSgpLmVudGl0eUNsYXNzKCkpKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCByIG9mIG9ianMpew0KICAgICAgICAgICAgICAgIHJldC5wdXNoKGF3YWl0IG5ldyA8JT1zY29wZSU+W3IuZW50aXR5Q2xhc3MoKS5uYW1lKCldKCkuX2Zyb21FTVNPYmplY3QocikpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JX1lbHNleyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydFTVMnXSxjKSklPigpLjwlPW1OYW1lJT4oZXZzKTsNCiAgICA8JX0lPg0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvRU1TQ2xhc3MnJT4oZGVwdGgpew0KICAgICAgICAvLyB3aHkgbm90IF9fZXhwb3J0ID8NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IG5ldyA8JT1zY29wZSU+LkVudGl0eUNsYXNzKCc8JT1jLklkJT4nKS5uYW1lKCI8JT1jLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKGMpJT4iKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5kYXRlKG5ldyBEYXRlKCkpLmNvbXBhbnkobmV3IDwlPXNjb3BlJT4uQ29tcGFueSgpLm5hbWUoIjwlPXNjb3BlJT4iKS5jb2RlKCI8JT1zY29wZSU+IikpLmVudGl0eU1vZHVsZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlNb2R1bGUoKS5jb2RlKCI8JT1zY29wZSU+IikubmFtZSgiPCU9c2NvcGUlPiIpKTsNCiAgICAgICAgICAgIGlmKCFkZXB0aCkgcmV0dXJuIHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0LmVudGl0eUNsYXNzX0VudGl0eU1ldGhvZHMoWw0KICAgIDwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5TWV0aG9kKCc8JT1tLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1tLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKG0pJT4iKS5lbnRpdHlNZXRob2RfRW50aXR5QXR0cmlidXRlcyhbDQogICAgICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9cC5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9cC5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShwKSU+IikuaXNBcnJheSg8JT1wLklzQXJyYXk/J3RydWUnOidmYWxzZSclPikucmVtYXJrKCI8JT1jLk5hbWUlPi48JT1tLk5hbWUlPigpIikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSkNCiAgICAgICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUocC5FbnRpdHlUeXBlKSU+KCkuPCU9bU5hbWUlPihkZXB0aC0xKSkNCiAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIC5pczwlPV9GckVNRC5fYXR0cihwKSU+KHRydWUpDQogICAgICAgICAgICA8JSB9JT4sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICBdKS5yZXNwb25zZUF0dHJpYnV0ZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPW0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUobS5SZXNwb25zZUF0dHJpYnV0ZSklPiIpLmVudGl0eUNsYXNzKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpDQogICAgICAgIDwlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpJT4oKS48JT1tTmFtZSU+KGRlcHRoLTEpKQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIC5pczwlPV9GckVNRC5fYXR0cihtLlJlc3BvbnNlQXR0cmlidXRlKSU+KHRydWUpDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICksDQogICAgPCUgfSklPg0KICAgICAgICAgICAgXSkuZW50aXR5Q2xhc3NfRW50aXR5QXR0cmlidXRlcyhbDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9ZWEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPWVhLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKGVhKSU+IikucmVtYXJrKCc8JT1jLk5hbWUlPi48JT1lYS5OYW1lJT4nKQ0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KGRlcHRoLTEpKQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIC5pczwlPV9GckVNRC5fYXR0cihlYSklPih0cnVlKQ0KICAgICAgICA8JSB9JT4sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgXSk7DQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2Zyb21FTVNPYmplY3QnJT4ob2JqKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdGhpcy5JZCA9IG9iai5JZDsNCiAgICAgICAgICAgIGxldCBldiA9IG51bGw7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgZXYgPSBvYmouZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcygpLmZpbmQoZXYgPT4gZXYuZW50aXR5QXR0cmlidXRlKCkuY29kZSgpPT08JT1fbkNvZGUoZWEpJT4pOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgaWYoZXYpIHRoaXMuPCU9bk5hbWUoZWEpJT4oYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZXYub2JqZWN0VmFsdWUoKSkpOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgaWYoZXYpIHRoaXMuPCU9bk5hbWUoZWEpJT4oZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKS50b0xvd2VyQ2FzZSgpJT5WYWx1ZSgpKTsNCiAgICAgICAgPCUgfSU+DQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b0VNU09iamVjdCclPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpew0KICAgICAgICBsZXQgcmV0ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5T2JqZWN0KCkuYWN0aXZlKHRydWUpLmVudGl0eUNsYXNzKHRoaXMuX3RvRU1TQ2xhc3MoKSk7DQoNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIEZ1bGw6ICFiUXVlcnksDQogICAgICAgICAgICAvL051bGw6ICFiUXVlcnksDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouSWQgPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZXYgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlWYWx1ZSgpLmFjdGl2ZSh0cnVlKS5lbnRpdHlBdHRyaWJ1dGUobmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1lYS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9ZWEuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoZWEpJT4iKS5lbnRpdHlDbGFzcyh0aGlzLl90b0VNU0NsYXNzKCkpKTsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBldi5vYmplY3RWYWx1ZSh2P3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpOm51bGwsIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIGV2LjwlPV9GckVNRC5fYXR0cihlYSkudG9Mb3dlckNhc2UoKSU+VmFsdWUodiwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIG9iai5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKGV2LCAnPT0nKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYodiAmJiBiVHlwZWRBdHRyaWJ1dGVzKSBvYmoub2JqZWN0VmFsdWVfRW50aXR5VmFsdWVzKHYubWFwKF92ID0+IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eUF0dHJpYnV0ZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPXRhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKCI8JT1uTmFtZSh0YSklPiIpLm5hbWUoIjwlPXRhLk5hbWUlPiIpLmVudGl0eUNsYXNzKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuX3RvRU1TQ2xhc3MoKSkpLm9iamVjdFZhbHVlKF92LjwlPW1OYW1lJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKSkpLCAnPT0nKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gJT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSkpeyU+DQogICAgPCU9bU5hbWU9J19hc09iamVjdHMnJT4oZXZzKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydCSVNlcnZlciddKSE9Yyl7JT4NCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydCSVNlcnZlciddLGMpKSU+KCkuPCU9bU5hbWUlPihldnMpOw0KICAgIDwlfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKGV2cyk9PT0idW5kZWZpbmVkIiB8fCAhZXZzIHx8ICFBcnJheS5pc0FycmF5KGV2cykgfHwgIWV2cy5sZW5ndGgpIHJldHVybiBbXTsNCg0KICAgICAgICAgICAgZXZzLmZvckVhY2goZXYgPT4gew0KICAgICAgICAgICAgICAgIGV2LkVudGl0eUF0dHJpYnV0ZSA9IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklkPT1ldi5FbnRpdHlBdHRyaWJ1dGVpZCk7DQogICAgICAgICAgICAgICAgZXYuRW50aXR5T2JqZWN0LkVudGl0eUNsYXNzID0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eUNsYXNzOw0KICAgICAgICAgICAgICAgIGlmKGV2Lk9iamVjdFZhbHVlKXsNCiAgICAgICAgICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUuRW50aXR5Q2xhc3MgPSA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChlYyA9PiBlYy5JZD09ZXYuT2JqZWN0VmFsdWUuRW50aXR5Q2xhc3MuSWQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbGV0IG9iaiA9IFtdOw0KICAgICAgICAgICAgdGhpcy5ncm91cEJ5KGV2cywgIkVudGl0eU9iamVjdCIpLmZvckVhY2goZXZnID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgYyA9IG5ldyA8JT1zY29wZSU+W2V2Zy5rZXkuRW50aXR5Q2xhc3MuTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKCk7DQogICAgICAgICAgICAgICAgYy5FbnRpdHlWYWx1ZXMgPSBldmcudmFsdWVzOw0KICAgICAgICAgICAgICAgIGMuVmFsdWVFbnRpdGllcyA9IFtdOw0KICAgICAgICAgICAgICAgIC8vIGMuRW50aXR5Q2xhc3MgPSBldmcua2V5LkVudGl0eUNsYXNzOw0KICAgICAgICAgICAgICAgIGMuSWQgPSBldmcua2V5LklkOw0KICAgICAgICAgICAgICAgIGV2Zy52YWx1ZXMuZm9yRWFjaCh2ID0+IHYuRW50aXR5T2JqZWN0ID0gYyk7DQogICAgICAgICAgICAgICAgb2JqLnB1c2goYyk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgZXZzLmZpbHRlcihldiA9PiBldi5PYmplY3RWYWx1ZSkuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgdmFyIF9mID0gb2JqLmZpbmQobyA9PiBvLklkID09IGV2Lk9iamVjdFZhbHVlLklkKTsNCiAgICAgICAgICAgICAgICBpZihfZikgX2YuVmFsdWVFbnRpdGllcy5wdXNoKGV2KTsNCiAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZSA9IF9mOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgb2JqLmZvckVhY2gobyA9PiB7DQogICAgICAgICAgICAgICAgaWYoby5FbnRpdHlDbGFzcyAmJiBvLkVudGl0eUNsYXNzLklkIT10aGlzLkVudGl0eUNsYXNzLklkKSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICByZXQucHVzaChvKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Lm1hcChvID0+IG8uX3JldmVydCgpKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfcmV2ZXJ0JyU+KGVvKSB7DQogICAgICAgIGlmIChlbykgew0KICAgICAgICAgICAgLy8gcmV2ZXJ0IGZyb20gc291cmNlIGRhdGENCiAgICAgICAgICAgIGlmKGVvLkVudGl0eUNsYXNzICYmICgodGhpcy5FbnRpdHlDbGFzcy5JZCAmJiBlby5FbnRpdHlDbGFzcy5JZCE9dGhpcy5FbnRpdHlDbGFzcy5JZCkgfHwgKHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBlby5FbnRpdHlDbGFzcy5OYW1lIT10aGlzLkVudGl0eUNsYXNzLk5hbWUpKSl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IkNhbm5vdCByZXZlcnQgIiArIEpTT04uc3RyaW5naWZ5KHRoaXMuRW50aXR5Q2xhc3MpICsgIiBmcm9tICIgKyBlby5FbnRpdHlDbGFzcy5OYW1lLCBlbyk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLklkID0gZW8uSWQ7DQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcyA9IGVvLkVudGl0eVZhbHVlcyB8fCBbXTsNCiAgICAgICAgICAgIHRoaXMuVmFsdWVFbnRpdGllcyA9IGVvLlZhbHVlRW50aXRpZXMgfHwgW107DQogICAgICAgICAgICByZXR1cm4gdGhpcy48JT1tTmFtZSU+KCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpZih0aGlzLl9fc3luY19vbigpICYmIE1hdGguYWJzKChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgNSl7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iT2JqZWN0IGFscmVhZHkgcmV2ZXJ0ZWQiLCB0aGlzLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7DQogICAgICAgIA0KICAgICAgICAgICAgLy8gdXNlIEVudGl0eVZhbHVlcyBhbmQgVmFsdWVFbnRpdGllcyB0byByZXZlcnQgdGhlIGF0dHJpYnV0ZSB2YWx1ZXMNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzLmZvckVhY2goZXYgPT4gew0KICAgICAgICAgICAgICAgIGxldCBlYSA9IG51bGw7DQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICBlYSA9IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoX2VhID0+IF9lYS5FbnRpdHlDbGFzcy5OYW1lPT0nPCU9Yy5OYW1lJT4nKS5maW5kKF9lYSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGVpZD09X2VhLklkKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGUuSWQ9PV9lYS5JZCkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZT09X2VhLk5hbWUpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgaWYoIWVhKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+InVuYWJsZSB0byBkZXRlY3QgYXR0cmlidXRlIGZyb20gdmFsdWUiLCBldik7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPmV2LCBleCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgdiA9IGV2Wyh0aGlzWyJfYXR0ciJdP3RoaXM6X0ZyRU1EKS5fYXR0cihlYSkgKyAiVmFsdWUiXTsNCiAgICAgICAgICAgICAgICBsZXQgcCA9IGVhLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzW3BdKSE9PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJpbnZhbGlkIHR5cGUiLCBlYSwgcCwgdik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYodiAmJiBlYS5FbnRpdHlUeXBlICYmIHR5cGVvZih2KT09PSdvYmplY3QnKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJyZXZlcnRpbmcgIiArIGVhLk5hbWUsIHYsIG5ldyA8JT1zY29wZSU+W2VhLkVudGl0eVR5cGUuTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKCkuPCU9bU5hbWUlPih2KSk7DQogICAgICAgICAgICAgICAgICAgIGlmKCF2LkVudGl0eVZhbHVlcyl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJlbXB0eSB2YWx1ZXMgZm9yICIgKyBlYS5OYW1lLCB2KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB2ID0gdi48JT1tTmFtZSU+P3YuPCU9bU5hbWUlPigpOm5ldyA8JT1zY29wZSU+W2VhLkVudGl0eVR5cGUuTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKCkuPCU9bU5hbWUlPih2KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhpc1twXSh2KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMuZmlsdGVyKHZlID0+IHZlLkVudGl0eUF0dHJpYnV0ZSkuZm9yRWFjaCh2ZSA9PiB7DQogICAgICAgICAgICAgICAgdmFyIHRhID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSWQ9PXZlLkVudGl0eUF0dHJpYnV0ZS5JZCk7DQogICAgICAgICAgICAgICAgaWYoIXRhKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICB2YXIgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsNCg0KICAgICAgICAgICAgICAgIGxldCB2ID0gdmUuRW50aXR5T2JqZWN0Ow0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICB2ID0gdi48JT1tTmFtZSU+P3YuPCU9bU5hbWUlPigpOm5ldyA8JT1zY29wZSU+W3RhLkVudGl0eVR5cGUuTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKCkuPCU9bU5hbWUlPih2KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhpc1t0YS5OYW1lLnJlcGxhY2UoLyAvZywgIl8iKSArICJfIiArIHRhTmFtZV0odik7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J192YWx1ZUNsYXNzJyU+KCl7DQogICAgICAgIGxldCBfY2xhc3MgPSB7QWN0aXZlOiB0cnVlfTsNCiAgICAgICAgaWYodGhpcy5FbnRpdHlDbGFzcy5FbnRpdHlNb2R1bGUpew0KICAgICAgICAgICAgX2NsYXNzLkVudGl0eU1vZHVsZSA9IHRoaXMuRW50aXR5Q2xhc3MuRW50aXR5TW9kdWxlOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIF9jbGFzcyA9IHsNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgQ29tcGFueToge0FjdGl2ZTogdHJ1ZSwgRW5hYmxlZDogdHJ1ZSwgRW50aXR5Q2xhc3NlczogW3RoaXMuRW50aXR5Q2xhc3NdfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX2NsYXNzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9YTUwnJT4oKXsNCiAgICAgICAgLy8gYW4gb3ZlcmxvYWQgb2YgdGhlIHNyLl90b1hNTA0KICAgICAgICBsZXQgcmV0ID0ge3htbDogYGB9Ow0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gcmV0LnhtbCArPSBgPCR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnfT4ke3Z9PC8ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J0lkJ30+YCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCR7ZWFDb2RlfT5gOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gdj92LjwlPW1OYW1lJT4oKTpudWxsOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwhW0NEQVRBWyR7dn1dXT5gOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8LyR7ZWFDb2RlfT5gOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8JHtlYUNvZGV9PmAgKyB2Lm1hcChfdiA9PiAnPE9iamVjdD4nICsgX3YuPCU9bU5hbWUlPigpICsgIjwvT2JqZWN0PiIpLmpvaW4oJycpICsgYDwvJHtlYUNvZGV9PmA7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldC54bWw7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19idWlsZFRoaXMnJT4oZGVwdGg9MSl7DQogICAgICAgIC8vIGNhbmRpZGF0ZSBmb3IgX19leHBvcnQNCiAgICAgICAgdmFyIHJldCA9IFt7DQogICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHtBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCl9LA0KICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB0aGlzLnRvRW50aXR5T2JqZWN0KHRydWUpLA0KICAgICAgICB9XTsNCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gZGVwdGg7IGkrKykgew0KICAgICAgICAgICAgcmV0LnB1c2goew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbcmV0W2kgLSAxXV0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHslPg0KICAgICAgICBpZihkZXB0aD4xKXsNCiAgICAgICAgICAgIGxldCB2ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1uTmFtZSh0YSklPih0aGlzKTsNCiAgICAgICAgICAgIHJldC5wdXNoKHsNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB2P3YudG9FbnRpdHlPYmplY3QodHJ1ZSk6bnVsbCwNCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgcmV0LnB1c2goew0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFt7DQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHY/di50b0VudGl0eU9iamVjdCh0cnVlKTpudWxsLA0KICAgICAgICAgICAgICAgICAgICB9XQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0ndG9FbnRpdHlPYmplY3QnJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKSB7DQogICAgICAgIGxldCByZXQgPSB7QWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpLCBFbnRpdHlWYWx1ZXM6IFtdLCBWYWx1ZUVudGl0aWVzOiBbXX07DQogICAgICAgIGlmKCFiUXVlcnkpIHJldC5EYXRlID0gdGhpcy5zZXJ2ZXJEYXRlKCk7IA0KDQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBGdWxsOiAhYlF1ZXJ5LA0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLklkID0gdiwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGV2ID0gew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgSWQ6IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQpLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lPT0nPCU9ZWEuTmFtZSU+JykuSWQsDQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPCU9ZWEuTmFtZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCksDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIE9QRVJBVE9SUzoge30sDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSB2LjwlPW1OYW1lJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKTsNCiAgICAgICAgICAgICAgICAgICAgZXYuT1BFUkFUT1JTLk9iamVjdFZhbHVlID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKSU+VmFsdWUgPSB2Ow0KICAgICAgICAgICAgICAgIGV2Lk9QRVJBVE9SUy48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIG9iai5WYWx1ZUVudGl0aWVzLnB1c2goZXYpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZih2ICYmIGJUeXBlZEF0dHJpYnV0ZXMpIG9iai5FbnRpdHlWYWx1ZXMucHVzaCh2Lm1hcChfdiA9PiAoew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgSWQ6ICc8JT10YS5JZCU+JywNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI8JT10YS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgT2JqZWN0VmFsdWU6IF92LjwlPW1OYW1lJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKSwNCiAgICAgICAgICAgICAgICB9KSkpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSAlPg0KfQ0K",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
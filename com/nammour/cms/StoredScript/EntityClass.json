{
	"Id": "e3d3b930ab2d088674ef543148af0d8ae7d342f5",
	"name": "EntityClass",
	"script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCh0eXBlb2YoJHtzfS5zdWJzdHJpbmcpIT09J3VuZGVmaW5lZCc/JHtzfS5zdWJzdHJpbmcoMCwgMTAwMCk6JHtzfSlgOw0KDQpsZXQgX2RlZiA9IChzLCB2KSA9PiAlPjwlPXMlPiA9IHR5cGVvZig8JT1zJT4pIT09J3VuZGVmaW5lZCc/PCU9cyU+OjwlPXYlPjs8JQ0KDQpsZXQgX2RlZmF1bHRzID0gKG9iaj0ndGhpcycsIF9jPWMpID0+IF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRGVmYXVsdCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKCE8JT1vYmolPi5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JT1vYmolPi48JT1uTmFtZShlYSklPig8JXZhbHVlT2YoZWEuRGVmYXVsdCklPik7DQogICAgICAgICAgICB9DQo8JSB9KTsNCg0KbGV0IGxvZyA9IChuLCBfdGhpcz0ndGhpcycpID0+IGAke190aGlzfS5sb2cobnVsbCwgdW5kZWZpbmVkLCAnJHtuIHx8IG1OYW1lfScsICdFbnRpdHlPYmplY3QnLCAwLCBgOw0KbGV0IHdhcm4gPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMSwgYDsNCmxldCBlcnJvciA9IChuLCBfdGhpcz0ndGhpcycpID0+IGAke190aGlzfS5sb2cobnVsbCwgdW5kZWZpbmVkLCAnJHtuIHx8IG1OYW1lfScsICdFbnRpdHlPYmplY3QnLCAyLCBgOw0KDQpsZXQgcWxUeXBlID0gKGVhLCBiSW5wdXQpID0+IHsNCiAgICBpZihlYS5Jc0Jvb2wpIHJldHVybiAnQm9vbGVhbic7DQogICAgLy9pZihlYS5Jc0RhdGUpIHJldHVybiAnRGF0ZVRpbWUnOw0KICAgIGlmKGVhLklzSW50IHx8IGVhLklzRmxvYXQpIHJldHVybiAnSW50JzsNCiAgICBpZihlYS5FbnRpdHlUeXBlKSByZXR1cm4gbk5hbWUoZWEuRW50aXR5VHlwZSkrKGJJbnB1dD8iSW5wdXQiOiIiKTsNCiAgICByZXR1cm4gJ1N0cmluZyc7DQp9Ow0KDQovLyB3aHkgaGFyZCBjb2RlZD8/Pw0KbGV0IF9yZXN0VG9vbHMgPSBbJ1NlcnZpY2VOb3cnLCAnU2FsZXNGb3JjZScsICdSZXN0REJJTycsICdHaXRIdWInLCAnRmlsZVN5c3RlbSddOw0KbGV0IF9zcWxUb29scyA9IFsnU3FsREInLCAnU2FsZXNGb3JjZScsICdTbm93Rmxha2UnXTsNCmxldCBfZmlsZVRvb2xzID0gWydHaXRIdWInLCAnRmlsZVN5c3RlbSddOw0KDQpsZXQgY2xzVG9vbHMgPSBfYyA9PiBfYy5Ub29scy5tYXAodCA9PiB0LnR5cGU/dC50eXBlLm5hbWU6KHQubmFtZSB8fCB0KSk7DQpsZXQgbWFpbkNsYXNzID0gKF9hclRvb2xzLCBfYz1jKSA9PiBhckNsYXNzZXMuZmluZChfX2MgPT4gKF9hclRvb2xzIHx8IGNsc1Rvb2xzKF9jKSkuZmluZCh0ID0+IGNsc1Rvb2xzKF9fYykuaW5jbHVkZXModCkpKSB8fCAoIShfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmxlbmd0aCAmJiBhckNsYXNzZXNbMF0pOw0KDQpsZXQgX2VhVHlwZXMgPSAoX2M9YywgYkFsbCkgPT4gX0ZyRU1ELl90b0pTKE9iamVjdC5hc3NpZ24oe30sIC4uLl9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgYkFsbD90cnVlOmVhLkVudGl0eVR5cGUpLm1hcChlYSA9PiAoe1tuTmFtZShlYSldOiBuTmFtZShlYS5FbnRpdHlUeXBlKSB8fCBfRnJFTUQuX2F0dHIoZWEpfSkpKSk7DQoNCmxldCBfY0ZpZWxkID0gKGVhLCBfYz1lYS5FbnRpdHlDbGFzcykgPT4gKChlYS5FbnRpdHlUeXBlPyhlYS5FbnRpdHlUeXBlLlR5cGVkQXR0cmlidXRlcy5maW5kKHRhID0+IHRhLkVudGl0eUNsYXNzPT1fYykgfHwgZWEuRW50aXR5Q2xhc3MuRW50aXR5QXR0cmlidXRlcy5maW5kKF9lYSA9PiBfZWEuRW50aXR5VHlwZT09X2MpKTpudWxsKSB8fCB7TmFtZTogIiJ9KS5OYW1lOw0KDQpsZXQgX2NOYW1lID0gKGNuPWMuTmFtZSwgYkFsaWFzKSA9PiB7DQogICAgaWYoY24uTmFtZSkgY24gPSBjbi5OYW1lOw0KICAgIGxldCBfYyA9IGFyQ2xhc3Nlcy5maW5kKGVjID0+IGVjLk5hbWU9PWNuKTsNCiAgICBpZighX2MpIHJldHVybiAnJzsNCiAgICByZXR1cm4gbk5hbWUoX2MsIGJBbGlhcyk7DQp9Ow0KDQpsZXQgYWxpYXMgPSAoY24sIGo9Jy4nKSA9PiAoc2NvcGUgKyAnLicgKyBfY05hbWUoY24sIHRydWUpLnJlcGxhY2UoX2NOYW1lKGNuKSwgJycpKS5zcGxpdCgnLicpLmZpbHRlcihuID0+IG4pLmpvaW4oaik7DQpsZXQgbnNjb3BlID0gYWxpYXMoJ05vZGUnKTsNCg0KbGV0IF92Q29kZSA9IGsgPT4geyU+KDwldmFsdWVPZihrLkNvZGUpJT4gfHwgKCI8JT1uQ29kZShrKSU+IikpPCV9Ow0KbGV0IF9uQ29kZSA9IChlYSwgYlR5cGVkKSA9PiBlYT8oInRoaXMuX25Db2RlKCciICsgbkNvZGUoZWEpICsgKGJUeXBlZD8oJ18nICsgZWEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSk6IiIpICArICInLCAiICsgKGJUeXBlZD9udWxsOl9GckVNRC5fdG9KUyhlYS5Db2RlKSkgKyAiKSIpOiJ0aGlzLl9uQ29kZSgpIjsNCmxldCBtUm91dGluZyA9IChjLCBtKSA9PiB7DQogICAgaWYgKCFjICYmIG0pIGMgPSBtLkVudGl0eUNsYXNzOw0KICAgIGlmICghbSAmJiAhYykgcmV0dXJuICIiOw0KICAgIGlmICghbSkgbSA9IGM7DQogICAgaWYgKCFtLlJvdXRpbmcgJiYgIWMuUm91dGluZykgcmV0dXJuICIiOw0KDQolPihfbm9kZSwgbWV0aG9kKSA9PiB7DQogICAgCWxldCBsb2cgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAwLCAuLi5tc2cpOw0KICAgIAlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JW0/bS5OYW1lOicnJT4iIHx8IG1ldGhvZCwgIlJvdXRlciIsIDEsIC4uLm1zZyk7DQogICAgCWxldCBlcnJvciA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JW0/bS5OYW1lOicnJT4iIHx8IG1ldGhvZCwgIlJvdXRlciIsIDIsIC4uLm1zZyk7DQogICAgCWxldCBvU2NvcGUgPSA8JT1hbGlhcygpJT47DQogICAgCWxldCBwU2NvcGUgPSA8JT1zY29wZSU+Ow0KICAgIAlsZXQgblNjb3BlID0gPCU9bnNjb3BlJT47DQoNCiAgICAgICAgdHJ5ew0KICAgICAgICA8JWZ1bmN0aW9uT2YobS5Sb3V0aW5nKSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICB3YXJuKGV4KTsNCiAgICAgICAgfQ0KfQ0KPCV9Ow0KDQpsZXQgbU5hbWUgPSAnJzsNCg0KbGV0IGZ1bmN0aW9uT2YgPSAoZnVuLCBfdGhpcz0ndGhpcycpID0+IHslPg0KICAgICAgICBsZXQgX19yZXQgPSB1bmRlZmluZWQ7DQogICAgPCUgaWYoZnVuKXslPg0KICAgICAgICA8JSBpZih0eXBlb2YoZnVuKT09PSdvYmplY3QnKXslPg0KICAgICAgICAgICAgPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZig8JT1fdGhpcyU+LlRvb2wgJiYgPCU9X3RoaXMlPi5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgICAgICAgICAgICAgIDwlIGlmKHR5cGVvZihmdW5bdF0pPT09J2Z1bmN0aW9uJyl7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuW3RdJT47DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9KEpTT04uc3RyaW5naWZ5KGZ1blt0XSkgfHwgJyIiJyklPjsNCiAgICAgICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgX19yZXQgPSA8JT1mdW4lPjsNCiAgICAgICAgPCUgfSU+DQogICAgPCUgfSU+DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0nc3RyaW5nJyAmJiBfX3JldC5zdGFydHNXaXRoKCJzKCIpICYmIF9fcmV0LmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgX19yZXQgPSB0aGlzLnJ1blNjcmlwdChfX3JldC5zbGljZSgyLC0xKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYodHlwZW9mKF9fcmV0KT09PSJmdW5jdGlvbiIpew0KICAgICAgICAgICAgX19yZXQgPSBfX3JldCg8JT1fdGhpcyU+KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX19yZXQ7DQo8JX07DQoNCmxldCB2YWx1ZU9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4oKA0KKG9TY29wZSkgPT4gew0KICAgIHRyeXsNCjwlZnVuY3Rpb25PZihmdW4sIF90aGlzKSU+DQogICAgfWNhdGNoKF92T2ZFeCl7DQogICAgICAgIDwlPXdhcm4oKSU+J3ZhbHVlT2YnLCBfdk9mRXgsIDwlPV9GckVNRC5fdG9KUyhmdW4pJT4pOw0KICAgIH0NCn0NCikoPCU9YWxpYXMoKSU+KSk8JX07DQoNCmxldCB1blJlY3Vyc2UgPSAob2JqLCBmdW4sIGZBcmdzPSdhcmd1bWVudHMnLCBzUmV0LCB2YWxpZGl0eT1gdGhpcy5fX2NvbmZpZygndW5SZWN1cnNlLnZhbGlkaXR5JywgMC41KWAsIGlkZikgPT4gew0KICAgIGlkZiA9IGlkZiB8fCBgKHRoaXM/dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpOidJZCcpYDsNCiAgICBmdW4gPSBmdW4gfHwgYCIke21OYW1lfSJgOw0KICAgIHNSZXQgPSBgDQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgIHYuZGF0ZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOw0KICAgICAgICAgICAgICAgIHYucmV1c2VkKys7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgICR7c1JldH0NCiAgICAgICAgfWNhdGNoKHNSZXRfZXgpew0KICAgICAgICAgICAgdGhpcy5sb2cobnVsbCwgdW5kZWZpbmVkLCAke2Z1bn0sICcke21OYW1lfS51blJlY3Vyc2UnLCAxLCAnc1JldCcsIHNSZXRfZXgpOw0KICAgICAgICB9ZmluYWxseXsNCiAgICAgICAgICAgIGlmKHYgJiYgdi5yZXVzZWQ+MSkgcmV0dXJuIHY/di5vYmo6djsNCiAgICAgICAgfQ0KICAgIGA7DQogICAgbGV0IGJEYW5nZXIgPSAoKSA9PiAlPihbIl90b0hhc2giXS5pbmRleE9mKDwlPWZ1biU+KT49MCk8JTsNCiU+DQogICAgICAgIGxldCB2ID0gdW5kZWZpbmVkOw0KICAgICAgICB0cnl7DQogICAgICAgICAgICA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0ID0gPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCB8fCB7fTsNCiAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+YEFib3J0aW5nIGFzIHBlciA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0LiR7PCU9ZnVuJT59YCk7DQogICAgICAgICAgICAgICAgPCU9c1JldCU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGxldCBfaWQgPSBudWxsOw0KICAgICAgICAgICAgaWYodHlwZW9mKDwlPW9iaiU+KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Ik51bGwgaW5wdXQiLCA8JT1vYmolPiwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgICAgIHJldHVybiA8JT1vYmolPjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZig8JT1vYmolPik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICAgICAgX2lkID0gdGhpcy5oYXNoQ29kZSg8JT1vYmolPik7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPls8JT1pZGYlPl07DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihfaWQpPT09J3VuZGVmaW5lZCcgfHwgIV9pZCl7DQogICAgICAgICAgICAgICAgaWYoPCU9b2JqJT4uSWQgJiYgPCU9b2JqJT4uSWQ9PTwlPW9iaiU+LklkKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT4uSWQ7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5JZD09dGhpcy5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5TZXRfT24pew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJ0aGlzLmhhc2hlZF9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKDwlPW9iaiU+LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT4uRW50aXR5Q2xhc3MuSWQgfHwgPCU9b2JqJT4uRW50aXR5Q2xhc3MuTmFtZSB8fCB0aGlzLl90b0hhc2goPCU9ZkFyZ3MlPiwge2RlcHRoOiA8JWJEYW5nZXIoKSU+PzM6dW5kZWZpbmVkfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI8JT1jLklkJT4iIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPikgfHwgIk5VTEwiOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gaWYoIjwlPW5OYW1lKGMpJT4iPT0iVXNlciIgJiYgPCU9ZnVuJT49PSJfdG9TTkZsb3ciKSA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Il9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4pOw0KICAgICAgICAgICAgDQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UgfHwge307DQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+IHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSB8fCB7fTsNCiAgICAgICAgCQ0KICAgICAgICAgICAgdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdOw0KDQogICAgICAgICAgICBpZih2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwKjwlPXZhbGlkaXR5JT4pKXsNCiAgICAgICAgICAgICAgICBpZigoPCViRGFuZ2VyKCklPj9uZXcgRGF0ZSgwKToodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKS5nZXRUaW1lKCkgPiB2LmRhdGUpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT5gU3Bhd25pbmcgaW4gJHs8JT1mdW4lPn1gLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iU2VsZWN0ZWQgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+LCB2LnJldXNlZCwgPCU9dmFsaWRpdHklPik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iUHVzaGluZyBoYXNoIiwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4pOw0KICAgICAgICAJdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gew0KICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLA0KICAgICAgICAgICAgICAgIGFyZ3M6IEpTT04uc3RyaW5naWZ5KDwlPWZBcmdzJT4pLA0KICAgICAgICAgICAgICAgIG9iajogPCU9b2JqJT4sDQogICAgICAgICAgICAgICAgcmV1c2VkOiAwLA0KICAgICAgICAgICAgICAgIHBhdGg6ICcnLA0KICAgICAgICAgICAgICAgIF9pZCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlLypleHBlcmltZW50YWw6IHJlbW92ZSB0aGlzIGlmIGFsbCBnb2VzIHdyb25nKi8lPg0KICAgICAgICAgICAgPCU9c1JldCU+DQogICAgCX1jYXRjaCh1blJlY0V4KXsNCiAgICAJICAgIGlmKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpew0KICAgIAkgICAgICAgIDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dID0gdHJ1ZTsNCiAgICAJICAgIH0NCiAgICAJICAgIDwlPWVycm9yKGAke21OYW1lfS51blJlY3Vyc2VgKSU+PCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+LCB1blJlY0V4LnRvU3RyaW5nKCkpOw0KICAgIAkgICAgPCU9c1JldCU+DQogICAgCX0NCjwlDQp9Ow0KDQpsZXQgaW52b2tlUnVsZSA9IHIgPT4gew0KJT4NCmF3YWl0IChhc3luYyAoYXV0aE9iaikgPT4gew0KICAgIGxldCBfcnVsZSA9IDwlPV9GckVNRC5fdG9KUyhyKSU+Ow0KICAgIGRlbGV0ZSBfcnVsZS5TY3JpcHQ7DQogICAgLy8gcnVsZVJ1bnMucHVzaChfcnVsZSk7DQogICAgdHJ5ew0KICAgICAgICA8JT1yLlNjcmlwdCU+DQogICAgfWNhdGNoKGV4KXsNCiAgICAgICAgX3J1bGUuRXhjZXB0aW9uID0gZXg7DQogICAgfQ0KfSkoYXV0aE9iaik7DQo8JQ0KfQ0KJT4NCg0KY2xhc3MgPCU9bk5hbWUoYyklPiB7DQogICAgPCU9bU5hbWU9J2NvbnN0cnVjdG9yJyU+KGlkLCB0b29sKSB7DQogICAgICAgIC8vc3VwZXIoaWQsIHRvb2wpOw0KDQogICAgICAgIHRoaXMuU2NvcGUgPSAiPCU9c2NvcGUlPiI7DQogICAgICAgIHRoaXMuRGVidWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5EZWJ1ZyklPjsNCiAgICAgICAgdGhpcy5Db25maWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db25maWcpJT47DQogICAgICAgIHRoaXMuVGVzdCA9IDwlPV9GckVNRC5fdG9KUyhjLlRlc3QpJT47DQogICAgICAgIHRoaXMuVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoYy5Ub29scyklPjsNCiAgICAgICAgdGhpcy5NYXBwaW5ncyA9IDwlPV9GckVNRC5fdG9KUyhjLk1hcHBpbmdzKSU+Ow0KDQogICAgICAgIC8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQ0KICAgICAgICB0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307DQogICAgICAgIHRoaXMuVG9vbCA9IHRvb2w7DQogICAgICAgIHRoaXMuSWQgPSBpZDsNCg0KICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsNCg0KICAgICAgICB0aGlzLkRhdGUgPSBudWxsOw0KDQogICAgICAgIHRoaXMuY2xlYXJfVEhJUygpOw0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcyA9IFtdOw0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KPCUgaWYoTnVtYmVyKGVhLklkKSl7JT4NCiAgICAgICAgICAgICAgICBJZDogIjwlPWVhLklkJT4iLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7TmFtZTogIj0ifSwNCiAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBPUEVSQVRPUlM6IHt9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KTsgJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KCk7DQo8JSB9KTsgJT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZWZhdWx0cyclPigpew0KPCVfZGVmYXVsdHMoKSU+DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IEVudGl0eUNsYXNzJyU+KCl7DQogICAgICAgIGxldCBlYyA9IHsNCjwlIGlmKE51bWJlcihjLklkKSl7JT4NCiAgICAgICAgICAgIElkOiAiPCU9Yy5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgTmFtZTogIjwlPWMuTmFtZSU+IiwNCiAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgIH07DQoNCjwlIGlmKGMuRW50aXR5TW9kdWxlaWQpeyAlPg0KICAgICAgICBlYy5FbnRpdHlNb2R1bGUgPSB7DQogICAgICAgICAgICBJZDogPCU9Yy5FbnRpdHlNb2R1bGVpZCU+DQogICAgICAgIH07DQo8JSB9JT4NCg0KICAgICAgICAvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXINCiAgICAgICAgaWYoIU51bWJlcihlYy5JZCkgJiYgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzKXsNCiAgICAgICAgICAgIGxldCBjaWQgPSA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWU9PWVjLk5hbWUpOw0KICAgICAgICAgICAgaWYoY2lkKSBlYy5JZCA9IGNpZC5JZDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZWM7DQogICAgfQ0KDQoJPCU9bU5hbWU9J2dldCBJZCclPigpIHsNCgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOw0KCX0NCg0KCTwlPW1OYW1lPSdzZXQgSWQnJT4oaWQpIHsNCgkJaWYgKCF0aGlzLlRvb2wpIHsNCgkJCTwlPWxvZygpJT4iRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYodGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXT09aWQpIHJldHVybjsNCgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOw0KCX0NCg0KICAgIDwlPW1OYW1lPSdnZXQgVG9vbCclPigpIHsNCiAgICAgICAgaWYodHlwZW9mKHRoaXMuX19Ub29sKSE9PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7DQogICAgICAgIGxldCBub1Rvb2wgPSB7DQogICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgIHR5cGU6IHtuYW1lOiAnJ30sDQogICAgICAgIH07DQogICAgICAgIGlmKHR5cGVvZig8JT1zY29wZSU+LlRvb2xzKSE9PSJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KDwlPXNjb3BlJT4uVG9vbHMpKXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPiI8JT1zY29wZSU+LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm4gbm9Ub29sOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gKDwlPXNjb3BlJT4uX19sYXN0VG9vbD9bPCU9c2NvcGUlPi5fX2xhc3RUb29sXTpbXSkuY29uY2F0KHRoaXMuVG9vbHMpLmZpbmQodCA9PiAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lPT1fdC5uYW1lKSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpIT09J3VuZGVmaW5lZCcpIHJldCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1yZXQgfHwgdC5uYW1lPT1yZXQubmFtZSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgaWYodGhpcy5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXSwNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH1lbHNlIHJldCA9IG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdzZXQgVG9vbCclPih0b29sKSB7DQogICAgICAgIGlmICh0eXBlb2YodG9vbCk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICBpZih0eXBlb2YodG9vbCk9PT0ic3RyaW5nIil7DQogICAgICAgICAgICB0b29sID0ge25hbWU6IHRvb2x9Ow0KICAgICAgICB9DQogICAgICAgIGlmKHRvb2wuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0eXBlb2YodG9vbC5uYW1lKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICB0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwge25hbWU6IHRvb2wubmFtZX07DQogICAgICAgIA0KICAgICAgICBpZighdG9vbC50eXBlICYmICF0b29sLm5hbWUpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iRW1wdHkgVG9vbCBvYmplY3QiKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCB0ID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7DQogICAgICAgIGlmICghdCkgew0KICAgICAgICAgICAgPCU9bG9nKCklPiJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPXNjb3BlJT4uX19sYXN0VG9vbCA9IHRoaXMuX19Ub29sID0gdDsNCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdUSElTJyU+KHYsIGNvKXsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOw0KICAgICAgICBpZighdikgcmV0dXJuIHRoaXM7DQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICB0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KT09PSdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWU9PXRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZT09dGhpcy5TY29wZSk7DQogICAgICAgIGlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nY2xlYXJfVEhJUyclPigpIHsNCiAgICAgICAgdGhpcy5fVEhJUyA9IFtdOw0KICAgICAgICB0aGlzLl9USElTX2Nvb3AgPSAnJzsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKGVhKSU+KHYsIGNvLCBpZCkgew0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICB2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCI8JT1lYS5OYW1lJT4iKTsNCiAgICAgICAgaWYgKCFldil7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpZCkgZXYuSWQgPSBpZDsNCg0KICAgICAgICBpZiAodHlwZW9mKHYpIT09J3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIC8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXINCg0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgICAgIHYgPSB2Lm1hcChfdiA9PiB7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHYgPSAoX3YgPT4gew0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIF92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nP192OihuZXcgRGF0ZShfdikpOw0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsNCiAgICA8JSB9JT4NCiAgICA8JSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgaWYoaXNOYU4oX3YpKSBfdiA9IDA7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihfdik9PT0nb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7DQogICAgPCUgfSU+DQoNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKF92ICYmICFfdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4idXNpbmcgX3RvRG9jdW1lbnQgZm9yIGludmFsaWQgc2V0dGVyIHZhbHVlIiwgX3YpOw0KICAgICAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoX3YgJiYgX3YuRW50aXR5Q2xhc3MuSWQhPT0nPCU9ZWEuRW50aXR5VHlwZS5JZCU+JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgU2V0dGVyIHZhbHVlIiwgX3YsICI8JT1lYS5FbnRpdHlUeXBlLklkJT4iLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiPCU9ZWEuRW50aXR5VHlwZS5OYW1lJT4iKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSAoKF92ICYmICF0aGlzLklkKSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgfSkodik7DQogICAgPCUgfSU+DQogICAgDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOw0KICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSB2Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgPCUgfSU+DQoNCiAgICAgICAgICAgIGlmKHRydWUgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT4hPXYpew0KICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IDwlPVNldF9PbiU+OyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQ0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJTZXQgYWZ0ZXIiLCB0aGlzLl88JT1uTmFtZShlYSklPj90aGlzLl88JT1uTmFtZShlYSklPi5TZXRfT246bnVsbCwgdj92LlNldF9PbjpudWxsKTsNCiAgICAgICAgICAgICAgICAvKmlmKHYpIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IHYuU2V0X09uOyovDQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gdjsNCiAgICAgICAgICAgIGlmIChjbykgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gY287DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2NsZWFyXycrbk5hbWUoZWEpJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPjsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT4gPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gIiI7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQogICAgLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KPCUgfSk7ICU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT10YS5OYW1lJT5fPCU9dGFOYW1lJT4gKiovDQogICAgPCU9bU5hbWU9bk5hbWUodGEpKydfJyt0YU5hbWUlPih2LCBjbywgYkNsZWFyKSB7DQogICAgICAgIGlmKHR5cGVvZih2KT09PSJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT47DQogICAgICAgIA0KICAgICAgICBpZih2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCE9PSc8JT10YS5FbnRpdHlDbGFzcy5JZCU+JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUhPT0nPCU9dGEuRW50aXR5Q2xhc3MuTmFtZSU+JykgcmV0dXJuIHRoaXM7DQogICAgICAgIA0KICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgDQogICAgICAgIHYgPSB2LmZpbHRlcihfdiA9PiAhdiB8fCBfdi5fPCU9bk5hbWUodGEpJT5fc2V0KS5jb25jYXQodi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll88JT1uTmFtZSh0YSklPl9zZXQpLm1hcChfdiA9PiB7DQogICAgICAgICAgICBpZighX3YuY29uc3RydWN0b3Ipew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5OYW1lKHRhKSU+IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsNCiAgICAgICAgICAgIH1lbHNlIGlmKF92LmNvbnN0cnVjdG9yLm5hbWU9PSJPYmplY3QiKXsNCiAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdikNCiAgICAgICAgICAgICAgICBfdi48JT1uTmFtZSh0YSklPih0aGlzKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gX3Y7DQogICAgICAgICAgICB9ZWxzZSBpZihfdi5jb25zdHJ1Y3Rvci5uYW1lIT0iPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4iKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uTmFtZSh0YSklPiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+Iik7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBfdi48JT1uTmFtZSh0YSklPih0aGlzKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gX3Y7DQogICAgICAgICAgICB9DQogICAgICAgIH0pLmZpbHRlcihfdiA9PiBfdikpOw0KICAgICAgICANCiAgICAgICAgaWYoYkNsZWFyKSB0aGlzLmNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+KCk7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+LnB1c2goLi4udik7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X3NldCA9IDwlPVNldF9PbiU+Ow0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjsNCg0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9zZXQgPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPiA9IG5ldyBBcnJheSgpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9jb29wID0gbnVsbDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4gKiovDQoNCjwlIH0pICU+DQoNCiAgICA8JT1tTmFtZT0nbG9nJyU+KGNsYXNzTmFtZSwgb2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCiAgICAgICAgdHlwZSA9IHR5cGUgfHwgIkVudGl0eU9iamVjdCI7DQogICAgICAgIA0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgb2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCgkJCWxldCBkZWJ1ZyA9IHRoaXMuRGVidWc7DQoJCQlsZXQgbGV2ZWxzID0gWyJpbmZvIiwgIndhcm4iLCAiZXJyb3IiLCAiY3JpdGljYWwiXTsNCg0KCQkJZGVidWcgPSBkZWJ1ZyB8fCBPYmplY3QuZnJvbUVudHJpZXMobmV3IE1hcChsZXZlbHMubWFwKGwgPT4gW2wsICcqJ10pKSk7DQoNCgkJCWxldCBmdW5jdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5sZXZlbHMubWFwKGwgPT4gKHsNCgkJCQlbbF06IGRlYnVnW2xdID8gZGVidWdbbF0uc3BsaXQoJywnKSA6IFtdDQoJCQl9KSkpOw0KDQoJCQlsZXQgY3NzID0gJ2JhY2tncm91bmQ6ICMwMGZmOTk7IGNvbG9yOiAjMDA4MDAwJzsNCgkJCWxldCBmZyA9ICdceDFiWzMybSc7DQoJCQlzd2l0Y2ggKE51bWJlcihsZXZlbCkpIHsNCgkJCQljYXNlIDE6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjZmZmZjAwOyBjb2xvcjogIzAwMDA4MCc7DQoJCQkJCWZnID0gJ1x4MWJbMzNtJzsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAyOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOw0KCQkJCQlmZyA9ICdceDFiWzMxbSc7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2UgMzoNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsNCgkJCQkJZmcgPSAnXHgxYlszMW1bQ1JJVElDQUxdJzsNCgkJCQkJYnJlYWs7DQoJCQl9DQoNCgkJCWlmIChmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLmV2ZXJ5KGYgPT4gIVsnKi4qJywgJyouJyArIG0sICcqJywgbSwgY2xhc3NOYW1lICsgJy4nICsgbSwgY2xhc3NOYW1lICsgJy4qJ10uaW5jbHVkZXMoZikpKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7DQoJCQkJY29uc29sZS5sb2coZmcgKyAiJXNceDFiWzBtIiwgYCR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHtjbGFzc05hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsNCgkJCX0gZWxzZSB7DQoJCQkJY29uc29sZS5sb2coYCVjICR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHtjbGFzc05hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgY3NzLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOw0KCQkJfQ0KCQl9IGNhdGNoIChleCkgew0KCQkJY29uc29sZS5sb2coZXgpOw0KCQl9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nc2V0SW50ZXJ2YWwnJT4oY2xhc3NOYW1lLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3Mpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsNCjwlIH1lbHNleyU+DQoJCXRyeSB7DQogICAgCQlsZXQgZk5hbWUgPSBmdW4udG9TdHJpbmcoKS5zcGxpdCgnKScpWzBdICsgJyknOw0KICAgIAkJdHJ5IHsNCiAgICAJCQkvLyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApOw0KICAgIA0KICAgIAkJCXRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCk7DQogICAgCQkJbGV0IHJldCA9IGF3YWl0IGZ1biguLi5hcmdzLmNvbmNhdChbbmV3IERhdGUoKV0pKTsNCiAgICANCiAgICAJCQk8JT1sb2coKSU+YHtDYWxsOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKSArIGAsIExvb3A6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApICsgJ30nKTsNCiAgICAJCQlpZiAoIXJldCkgew0KICAgIAkJCQk8JT1sb2coKSU+YGRpZCBub3QgcmV0dXJuIHRydWUsIGV4aXRpbmcgbG9vcGVyICgke3RoaXMuX190aW1lKGZOYW1lKX0pYCk7DQogICAgCQkJCXJldHVybjsNCiAgICAJCQl9DQogICAgCQl9IGNhdGNoIChleCkgew0KICAgIAkJCTwlPWVycm9yKCklPnRoaXMuX190aW1lKGZOYW1lKSwgZXgpOw0KICAgIAkJCWNvbnNvbGUudHJhY2UoKTsNCiAgICAJCX0NCiAgICAJCWlmICghTnVtYmVyKG1pbnV0ZXMpKSB7DQogICAgCQkJPCU9bG9nKCklPnRoaXMuX190aW1lKGZOYW1lKSwgIk5vdCByZXBlYXRpbmcuIE1pbnV0ZXMgaXMgIiArIG1pbnV0ZXMpOw0KICAgIAkJCXJldHVybjsNCiAgICAJCX0NCiAgICAJCWF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtaW51dGVzICogNjAgKiAxMDAwKSk7DQogICAgCQlhd2FpdCB0aGlzLjwlPW1OYW1lJT4obnVsbCwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsNCgkJfSBjYXRjaCAoZXgpIHsNCgkJCTwlPWVycm9yKCklPmV4KTsNCgkJfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19leGVjdXRlJyU+KGNsYXNzTmFtZSwgc2NvcGUsIG0sIGZSb3V0ZXIsIGZTY3JpcHQsIG9QYXJhbXMgPSB7fSwgc291cmNlKXsNCgkJdGhpcy5fX3RpbWUoYDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+LiR7bX1gKTsNCgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCgkJc2NvcGUgPSBzY29wZSB8fCA8JT1zY29wZSU+Ow0KCQlzb3VyY2UgPSBzb3VyY2UgfHwgdGhpczsNCg0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgc2NvcGUsIG0sIGZSb3V0ZXIsIGZTY3JpcHQsIG9QYXJhbXMsIHRoaXMpOw0KPCUgfWVsc2V7JT4NCgkJZGVsZXRlIDwlPXNjb3BlJT4uX3VuUmVjdXJzZTsgLy8gZXhwZXJpbWVudGFsDQoJCQ0KICAgIAlsZXQgX19iZWZvcmVSdWxlcyA9IG9QYXJhbXMuX19iZWZvcmVSdWxlcyB8fCBbXTsNCiAgICAJbGV0IF9fYWZ0ZXJSdWxlcyA9IG9QYXJhbXMuX19hZnRlclJ1bGVzIHx8IFtdOw0KICAgIAlkZWxldGUgb1BhcmFtcy5fX2JlZm9yZVJ1bGVzOw0KICAgIAlkZWxldGUgb1BhcmFtcy5fX2FmdGVyUnVsZXM7DQoNCiAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICBsZXQgZXJyb3IgPSAoLi4ucykgPT4gPCU9ZXJyb3IoKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgICAgIA0KICAgICAgICB0cnl7DQogICAgCQlsZXQgbFBhcmFtcyA9IE9iamVjdC5lbnRyaWVzKG9QYXJhbXMpLm1hcCh4ID0+IHhbMV0pOw0KICAgIAkJbGV0IHJlc3VsdHMgPSBbXTsNCiAgICANCiAgICAJCWxldCBub2RlcyA9IFtdOw0KICAgIAkJDQogICAgCQlpZiAoPCU9bnNjb3BlJT4uX25vZGUgJiYgYXdhaXQgZlJvdXRlcig8JT1uc2NvcGUlPi5fbm9kZSwgbSkpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlKTsNCiAgICAJCX0NCiAgICANCiAgICAJCWlmICg8JT1uc2NvcGUlPi5fbm9kZSAmJiA8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50ICYmIGF3YWl0IGZSb3V0ZXIoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCksIG0pKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSk7DQogICAgCQl9DQogICAgDQogICAgCQlmb3IgYXdhaXQgKGNvbnN0IGNuIG9mICg8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnRfTm9kZXMoKTpbXSkpIHsNCiAgICAgICAgICAgICAgICBpZiAoYXdhaXQgZlJvdXRlcihjbiwgbSkpIHsNCiAgICAgICAgICAgICAgICAJbG9nKCdhZGRpbmcgY2hpbGQgbm9kZScsIGNuKTsNCiAgICAgICAgICAgICAgICAJbm9kZXMucHVzaChjbik7DQogICAgICAgICAgICAgICAgfQ0KICAgIAkJfQ0KICAgIA0KICAgIAkJLy8gcmVtb3ZlIGFueSBudWxscw0KICAgIAkJbm9kZXMgPSBub2Rlcy5mbGF0KCkuZmlsdGVyKG4gPT4gbik7DQogICAgCQkNCiAgICAJCWlmICghbm9kZXMubGVuZ3RoKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZSk7DQogICAgCQl9DQogICAgCQkNCiAgICAJCW5vZGVzID0gdGhpcy5fdW5pcXVlKG5vZGVzLCAnX2NvZGUnKTsNCiAgICAJCWxvZygnbm9kZXMubGVuZ3RoJywgbm9kZXMubGVuZ3RoKTsNCg0KICAgIAkJZm9yIGF3YWl0IChjb25zdCBuIG9mIG5vZGVzKSB7DQogICAgCQkJbGV0IG5SZXQgPSBudWxsOw0KICAgIAkJCWxvZyhgJHttfSBAICR7bj8uY29kZSgpIHx8ICdMT0NBTCd9YCk7DQogICAgCQkJaWYgKCFuIHx8IHRoaXMuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUsIG4pKSB7DQogICAgCQkJCS8vIGxvY2FsIHNjcmlwdA0KICAgIAkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19iZWZvcmVSdWxlcykgew0KICAgICAgICAgICAgICAgICAgICAgICAgPCV2YWx1ZU9mKCJyLlNjcmlwdCIpJT4NCiAgICAJCQkJCS8vYXdhaXQgdGhpcy5fU2NyaXB0KGNsYXNzTmFtZSwgci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQmVmb3JlUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsNCiAgICAJCQkJfQ0KDQogICAgCQkJCW5SZXQgPSBhd2FpdCBmU2NyaXB0KCk7DQoNCiAgICAJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYWZ0ZXJSdWxlcykgew0KICAgICAgICAgICAgICAgICAgICAgICAgPCV2YWx1ZU9mKCJyLlNjcmlwdCIpJT4NCiAgICAJCQkJCS8vYXdhaXQgdGhpcy5fU2NyaXB0KGNsYXNzTmFtZSwgci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQWZ0ZXJSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOw0KICAgIAkJCQl9DQogICAgCQkJfSBlbHNlIHsNCiAgICAJCQkJblJldCA9IGF3YWl0IHNvdXJjZS5faW52b2tlTm9kZShuLCBtLCBvUGFyYW1zKTsNCiAgICAJCQl9DQogICAgDQogICAgCQkJcmVzdWx0cy5wdXNoKHsNCiAgICAJCQkJbm9kZTogbiwNCiAgICAJCQkJcmV0OiBuUmV0DQogICAgCQkJfSk7DQogICAgCQl9DQogICAgCQlsb2cocmVzdWx0cywgIl9leGVjdXRlIiwgJ1Jlc3VsdHMnKTsNCiAgICANCiAgICAJCWxldCBlcnJvcnMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIucmV0ICYmIHIucmV0Ll9fZXhjZXB0aW9uKS5tYXAociA9PiAoew0KICAgIAkJCW5vZGU6IHIubm9kZSA/IHsNCiAgICAJCQkJY29kZTogci5ub2RlLmNvZGUoKSwNCiAgICAJCQkJYWRkcmVzczogci5ub2RlLmFkZHJlc3MoKQ0KICAgIAkJCX0gOiBudWxsLA0KICAgIAkJCV9fZXhjZXB0aW9uOiByLnJldC5fX2V4Y2VwdGlvbg0KICAgIAkJfSkpOw0KDQogICAgCQlpZiAoZXJyb3JzLmxlbmd0aCkgew0KICAgIAkJCXdhcm4oImVycm9ycyIsIGVycm9ycyk7DQogICAgCQl9DQogICAgDQogICAgCQlyZXR1cm4gcmVzdWx0czsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIGVycm9yKGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19TY3JpcHQnJT4oY2xhc3NOYW1lLCBzY3JpcHQsIG0sIHR5cGUsIHNjb3BlLCBfbm9kZSwgLi4uc2ZBcmdzKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCiAgICAgICAgc2NvcGUgPSBzY29wZSB8fCA8JT1zY29wZSU+Ow0KICAgICAgICANCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIF9ub2RlLCAuLi5zZkFyZ3MpOw0KPCUgfWVsc2V7JT4NCiAgICAJaWYgKHR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgIAkNCiAgICAgICAgdHJ5ew0KICAgIAkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnc3RyaW5nJykgc2NyaXB0ID0gdGhpcy5ydW5TY3JpcHQoYCgpID0+IHske3NjcmlwdH19YCk7DQogICAgDQogICAgCQlsZXQgcmV0ID0gbnVsbDsNCiAgICAJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgew0KICAgIAkJCXJldCA9IGF3YWl0IHNjcmlwdCgpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBtLCB0eXBlLCBzY3JpcHQsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KDQogICAgPCU9bU5hbWU9J19zYW1lRW50aXR5JyU+KC4uLmFyRW50aXRpZXMpew0KICAgICAgICBpZihhckVudGl0aWVzLmxlbmd0aD09MCkgcmV0dXJuIGZhbHNlOw0KICAgICAgICBpZihhckVudGl0aWVzLmxlbmd0aD09MSkgYXJFbnRpdGllcy5wdXNoKHRoaXMpOw0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KC4uLmFyRW50aXRpZXMpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIGFyRW50aXRpZXMuc2xpY2UoMSkuZXZlcnkoZSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IHYgPSBhckVudGl0aWVzWzBdOw0KICAgICAgICAgICAgICAgIGxldCBuZWdUZXN0ID0gew0KICAgICAgICAgICAgICAgICAgICB2TnVsbDogdj09bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgZU51bGw6IGU9PW51bGwsDQogICAgICAgICAgICAgICAgICAgIHZPYmplY3Q6IHR5cGVvZih2KSE9PSdvYmplY3QnLA0KICAgICAgICAgICAgICAgICAgICBlT2JqZWN0OiB0eXBlb2YoZSkhPT0nb2JqZWN0JywNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4xLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICBpZihPYmplY3Qua2V5cyhPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3Qua2V5cyhuZWdUZXN0KS5maWx0ZXIoayA9PiBuZWdUZXN0W2tdKS5tYXAoayA9PiAoe3YsIGUsIFtrXTogdHJ1ZX0pKSkpLmxlbmd0aCkgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIC8vIHBhc3NlZCBpbml0aWFsIGNvbnNpc3RlbmN5IGNoZWNrDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodj09ZSkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbmVnVGVzdCA9IHsNCiAgICAgICAgICAgICAgICAgICAgZXZDb25zdHI6IHYuY29uc3RydWN0b3IubmFtZSE9ZS5jb25zdHJ1Y3Rvci5uYW1lLA0KICAgICAgICAgICAgICAgICAgICBlRW50aXR5OiAhZS5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgICAgICAgICAgdkVudGl0eTogIXYuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICAgICAgICAgIGV2RW50aXR5TmFtZXM6IHR5cGVvZihlLkVudGl0eUNsYXNzLk5hbWUpIT09J3VuZGVmaW5lZCcgJiYgZS5FbnRpdHlDbGFzcy5OYW1lIT12LkVudGl0eUNsYXNzLk5hbWUsDQogICAgICAgICAgICAgICAgICAgIGV2RW50aXR5SWRzOiB0eXBlb2YoZS5FbnRpdHlDbGFzcy5JZCkhPT0ndW5kZWZpbmVkJyAmJiBlLkVudGl0eUNsYXNzLklkIT12LkVudGl0eUNsYXNzLklkLA0KICAgICAgICAgICAgICAgICAgICBldklEczogdi5JZD09di5JZCAmJiBlLklkPT1lLklkICYmIHYuSWQhPWUuSWQsDQogICAgICAgICAgICAgICAgICAgIGV2SGFzaDogdi5fdG9IYXNoKG51bGwsIHtvbmx5VW5pcXVlOiB0cnVlfSwgJzwlPW1OYW1lJT4nKSE9ZS5fdG9IYXNoKG51bGwsIHtvbmx5VW5pcXVlOiB0cnVlfSwgJzwlPW1OYW1lJT4nKSwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4yLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICBuZWdUZXN0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmtleXMobmVnVGVzdCkuZmlsdGVyKGsgPT4gbmVnVGVzdFtrXSkubWFwKGsgPT4gKHt2LCBlLCBba106IHRydWV9KSkpOw0KICAgICAgICAgICAgICAgIGlmKCFPYmplY3Qua2V5cyhuZWdUZXN0KS5sZW5ndGgpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4zLCBuZWdUZXN0KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2dldCBTZXRfT24nJT4oKSB7DQogICAgICAgIGxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0LA0KPCUgfSklPg0KICAgICAgICApKTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBTZXRfQ291bnQnJT4oKSB7DQogICAgICAgIHJldHVybiBbDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCwNCjwlIH0pJT4NCiAgICAgICAgXS5maWx0ZXIocyA9PiBzKS5sZW5ndGg7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmxhdHRlbiclPihkZXB0aCl7DQogICAgICAgIDwlPXdhcm4oKSU+IkRFUFJFQ0FURUQiKTsNCiAgICAgICAgbGV0IHJldCA9IHt9Ow0KICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICByZXQuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXQuPCU9bk5hbWUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGRlcHRoLTEpPCV9JT46dGhpcy48JT1uTmFtZShlYSklPigpOw0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgIHJldC48JT10YU5hbWUlPiA9IHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodCA9PiB0P3QuPCU9bU5hbWUlPihkZXB0aC0xKTp0KTsNCjwlIH0pJT4NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0hhc2gnJT4oYXJncywgb3B0aW9ucywgZlNvdXJjZSl7DQogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgICAgICANCiAgICAgICAgbGV0IG9IYXNoID0gew0KICAgICAgICAgICAgY2xhc3M6ICI8JT1uTmFtZShjKSU+IiwNCiAgICAgICAgICAgIHNvdXJjZTogZlNvdXJjZSwNCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MsDQogICAgICAgICAgICBfdGhpczoge30NCiAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgIGlmKCFvcHRpb25zLm5vVGhpcyAmJiBmU291cmNlIT0iPCU9bU5hbWUlPiIgJiYgKHR5cGVvZihvcHRpb25zLmRlcHRoKT09PSd1bmRlZmluZWQnIHx8IC0tb3B0aW9ucy5kZXB0aD4wKSl7DQogICAgICAgICAgICB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7DQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiAhb3B0aW9ucy5ub09wZXJhdG9ycywNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLl9tYXAsDQogICAgICAgICAgICAgICAgVW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWUsDQogICAgICAgICAgICAgICAgTnVsbDogIW9wdGlvbnMub25seVVuaXF1ZSwgLy8/Pw0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+aWYob3B0aW9ucy5ub1R5cGVzKSByZXR1cm47PCV9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSA8JSBpZihlYS5FbnRpdHlUeXBlKXslPnY/di48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpOjwlfSU+djsNCiAgICAgICAgICAgICAgICB9LA0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IF92LjwlPW1OYW1lJT4obnVsbCwgb3B0aW9ucywgZlNvdXJjZSkpLA0KPCUgfSklPg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmpbZWZDb2RlXSA9IHYsDQo8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZihvcHRpb25zLm5vQXJncykgb0hhc2ggPSBvSGFzaC5fdGhpczsNCiAgICAgICAgcmV0dXJuIG9wdGlvbnMubm9Db2RlP29IYXNoOnRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2F1dGhvcml6ZSclPih1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpew0KPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgITwlPXNjb3BlJT4uX190b2tlbiAmJiB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udXNlcm5hbWUnXSl7DQogICAgICAgICAgICB1c2VybmFtZSA9IHRoaXMuVGVzdFsnPCU9bU5hbWUlPi51c2VybmFtZSddOw0KICAgICAgICAgICAgcGFzc3dvcmQgPSB0aGlzLlRlc3RbJzwlPW1OYW1lJT4ucGFzc3dvcmQnXTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmKGJTZXJ2ZXIpew0KICAgICAgICAgICAgaWYodXNlcm5hbWUgJiYgITwlPXNjb3BlJT4uX3Rlc3RVc2VyICYmIHRoaXMuVGVzdFsnPCU9bU5hbWUlPi50ZXN0VXNlciddKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll90ZXN0VXNlciA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHRoaXMuVGVzdFsnPCU9bU5hbWUlPi50ZXN0VXNlciddKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLnN0b3JlKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy51c2VybmFtZSh1c2VybmFtZSwgJz0nKS5wYXNzd29yZChwYXNzd29yZCwgJz0nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5maW5kKCk7DQogICAgICAgICAgICA8JT1sb2coKSU+IlNlcnZlcjogIiArIGJTZXJ2ZXIrIiwgT2JqOiIsIHJldCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHJldCl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGpzb253ZWJ0b2tlbikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IGpzb253ZWJ0b2tlbi5zaWduKHJldC5fdG9Eb2N1bWVudCgpLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgeyBleHBpcmVzSW46ICcxODAwcycgfSk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkocmV0Ll90b0RvY3VtZW50KCkpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBhY2Nlc3NfdG9rZW46IHJldCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICA8JT1sb2coKSU+IlNlcnZlcjogIiArIGJTZXJ2ZXIrIiwgdG9rZW46ICIsIHJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGxldCBjbGllbnRfaWQgPSB0aGlzLl9fY29uZmlnKCdjbGllbnRfaWQnKTsNCiAgICAgICAgICAgIGxldCBjbGllbnRfc2VjcmV0ID0gdGhpcy5fX2NvbmZpZygnc2VjcmV0Jyk7DQogICAgDQogICAgICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIDwlPXNjb3BlJT4uX190b2tlbil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJObyB1c2VybmFtZS9wYXNzd29yZCBhbmQgdG9rZW4gYWxyZWFkeSBleGlzdHMiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICA8JWlmKF9jTmFtZSgnb0F1dGggVG9rZW4nKSl7JT4NCiAgICAgICAgICAgIGxldCBkYXRhID0gew0KICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICdwYXNzd29yZCcsDQogICAgICAgICAgICAgICAgdXNlcm5hbWUsDQogICAgICAgICAgICAgICAgcGFzc3dvcmQsDQogICAgICAgICAgICAgICAgY2xpZW50X2lkLA0KICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgY29uZmlnID0gew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgPCU9c2NvcGUlPi5fX3Rva2VuICYmIDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuKXsNCiAgICAgICAgICAgICAgICBkYXRhID0gew0KICAgICAgICAgICAgICAgICAgICBncmFudF90eXBlOiAicmVmcmVzaF90b2tlbiIsDQogICAgICAgICAgICAgICAgICAgIHJlZnJlc2hfdG9rZW46IDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuLA0KICAgICAgICAgICAgICAgICAgICBjbGllbnRfaWQsDQogICAgICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQsDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7PCU9c2NvcGUlPi5fX3Rva2VuLnRva2VuX3R5cGV9ICR7PCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuc2VjdXJlKCk/J3MnOicnfTovLyR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuYWRkcmVzcygpfTokezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLnBvcnQoKSB8fCAzMDAwfS9vYXV0aC90b2tlbmAsIE9iamVjdC5rZXlzKGRhdGEpLm1hcChrZXkgPT4ga2V5ICsgJz0nICsgZGF0YVtrZXldKS5qb2luKCcmJyksIGNvbmZpZyk7DQogICAgICAgICAgICBpZihyZXQuZGF0YS5hY2Nlc3NfdG9rZW4pew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190b2tlbiA9IHJldC5kYXRhOw0KDQogICAgICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4pew0KICAgICAgICAgICAgICAgICAgICBpZihheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UuY2xlYXIpIGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS5jbGVhcigpOw0KICAgICAgICAgICAgICAgICAgICBheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UudXNlKHJlc3BvbnNlID0+IHJlc3BvbnNlLCBhc3luYyBlcnJvciA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSBlcnJvci5jb25maWc7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgJiYgIW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgJiYgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbi5pbmRleE9mKDwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW4pPjApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9hdXRob3JpemUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uID0gJ0JlYXJlciAnICsgPCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbjsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXhpb3Mob3JpZ2luYWxSZXF1ZXN0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICA8JSB9ZWxzZSBpZihhdXRoQ2xhc3MpeyU+DQogICAgCTwlPXNjb3BlJT4uX190b2tlbiA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuPCU9bU5hbWUucmVwbGFjZSgnXycsICcnKSU+KCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgPCU9d2FybigpJT4iTm8gYXV0aG9yaXphdGlvbiBkZWZpbmVkIik7DQogICAgPCUgfSU+DQogICAgICAgIH0NCjwlIH1lbHNleyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoKSklPigpLjwlPW1OYW1lJT4odXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsNCjwlfSU+DQogICAgfQ0KICAgIA0KPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19zZXJ2ZXInJT4ob3B0aW9ucz17fSkgew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmNsZWFyQ29uc29sZSkgY29uc29sZS5jbGVhcigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fVG9vbHMpIDwlPXNjb3BlJT4uVG9vbHMgPSA8JT1zY29wZSU+Ll9fVG9vbHM7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpPT09J3VuZGVmaW5lZCcgJiYgdHlwZW9mKDwlPXNjb3BlJT4uaHJlZnMpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAJCWZvciBhd2FpdCAoY29uc3QgbCBvZiA8JT1zY29wZSU+LmhyZWZzKSB7DQogICAgICAgIAkJCWF3YWl0IHRoaXMucmVxdWlyZShsLmxpYiwgPCU9c2NvcGUlPi5ocmVmcywgYXN5bmMgX2wgPT4gew0KICAgIDwlIGlmKF9jTmFtZSgnU3RvcmVkU2NyaXB0JykpeyU+DQogICAgICAgIAkJCWlmKF9sLnNjcmlwdCAmJiA8JT1zY29wZSU+LlRvb2xzKSByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTdG9yZWRTY3JpcHQnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfbC5zY3JpcHQpLmxvYWRTY3JpcHQoKTsNCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgbGV0IHNlY3VyZSA9IHRoaXMuX19jb25maWcoJ3NlY3VyZScpOw0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgLy8gZ2xvYmFscw0KICAgICAgICAgICAgICAgIHZhciBnbG9iYWxNb2R1bGVzID0gew0KICAgICAgICAgICAgICAgICAgICBleHByZXNzOiAnZXhwcmVzcycsDQogICAgICAgICAgICAgICAgICAgIGh0dHBzOiAnaHR0cHMnLA0KICAgICAgICAgICAgICAgICAgICBodHRwOiAnaHR0cCcsDQogICAgICAgICAgICAgICAgICAgIHNlbGZzaWduZWQ6ICdzZWxmc2lnbmVkJywNCiAgICAgICAgICAgICAgICAgICAgdXRpbDogJ3V0aWwnLA0KICAgICAgICAgICAgICAgICAgICBjb3JzOiAnY29ycycsDQogICAgICAgICAgICAgICAgICAgIGJvZHlQYXJzZXI6ICdib2R5LXBhcnNlcicsDQogICAgICAgICAgICAgICAgICAgIGF4aW9zOiAnYXhpb3MnLA0KICAgICAgICAgICAgICAgICAgICAvL2NyeXB0bzogJ2NyeXB0bycsDQogICAgICAgICAgICAgICAgICAgIG9zOiAnb3MnLA0KICAgICAgICAgICAgICAgICAgICAvL2ptZXNwYXRoOiAnam1lc3BhdGgnLA0KICAgICAgICAgICAgICAgICAgICBqc29ucGF0aDogJ2pzb25wYXRoJywNCiAgICAgICAgICAgICAgICAgICAganNvbmF0YTogJ2pzb25hdGEnLA0KICAgICAgICAgICAgICAgICAgICBEb3RPYmplY3Q6ICdkb3Qtb2JqZWN0JywNCiAgICAgICAgICAgICAgICAgICAgbWFjaGluZWlkOiAnbm9kZS1tYWNoaW5lLWlkJywNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIG1pbmltaXN0OiAnbWluaW1pc3QnLA0KICAgICAgICAgICAgICAgIA0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ2dyYXBocWwnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZ3JhcGhxbEhUVFA6ICdleHByZXNzLWdyYXBocWwnLA0KICAgICAgICAgICAgICAgICAgICBncmFwaHFsOiAnZ3JhcGhxbCcsDQogICAgICAgICAgICAgICAgICAgIHBsYXlncm91bmQ6ICdncmFwaHFsLXBsYXlncm91bmQtbWlkZGxld2FyZS1leHByZXNzJywNCjwlIH0lPg0KDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZW1haWwuaG9zdCddKXslPg0KICAgICAgICAgICAgICAgICAgICBub2RlbWFpbGVyOiAnbm9kZW1haWxlcicsDQo8JSB9JT4NCg0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ3RvdHAuc2VjcmV0J10peyU+DQogICAgICAgICAgICAgICAgICAgIG90cGF1dGg6ICdvdHBhdXRoJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgY2hpbGRfcHJvY2VzczogJ2NoaWxkX3Byb2Nlc3MnLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiAnZXZlbnRzJywNCiAgICAgICAgICAgICAgICAgICAgc29ja2V0aW86ICdzb2NrZXQuaW8nLA0KICAgICAgICAgICAgICAgICAgICBtcXR0OiAnbXF0dCcsDQogICAgICAgICAgICAgICAgICAgIGFtcXBsaWI6ICdhbXFwbGliJywNCiAgICAgICAgICAgICAgICAgICAgcHJvdG9idWZqczogJ3Byb3RvYnVmanMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIGZzOiAnZnMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0thZmthJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBrYWZrYWpzOiAna2Fma2FqcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnTmVvNGonXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIG5lbzRqOiAnbmVvNGotZHJpdmVyJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgICAgIE9BdXRoU2VydmVyOiAnZXhwcmVzcy1vYXV0aC1zZXJ2ZXInLA0KPCUgfWVsc2UgaWYoYXV0aENsYXNzKXslPg0KICAgICAgICAgICAgICAgICAgICBqc29ud2VidG9rZW46ICdqc29ud2VidG9rZW4nLA0KPCUgfSU+DQoNCg0KPCUgaWYobWFpbkNsYXNzKFsnU3FsREInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIHNxbGl0ZTogJ3NxbGl0ZTMnLA0KICAgICAgICAgICAgICAgICAgICBteXNxbDogJ215c3FsJywNCiAgICAgICAgICAgICAgICAgICAgcG9zdGdyZXM6ICdwZycsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ1Nub3dGbGFrZSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgc25vd2ZsYWtlOiAnc25vd2ZsYWtlLXNkaycsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ01vbmdvREInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIG1vbmdvZGI6ICdtb25nb2RiJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnUnhEQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgUnhEQjogJ3J4ZGInLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydFeGNlbCddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgWExTWDogJ3hsc3gnLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBtaXNzaW5nR2xvYmFsTW9kdWxlcyA9IE9iamVjdC5lbnRyaWVzKGdsb2JhbE1vZHVsZXMpLm1hcChlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsW2VbMF1dID0gcmVxdWlyZShlWzFdKTsNCiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ZXgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbMV07DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KS5maWx0ZXIoZSA9PiBlKTsNCiAgICAgICAgICAgICAgICBpZihtaXNzaW5nR2xvYmFsTW9kdWxlcy5sZW5ndGgpIDwlPXdhcm4oKSU+Im5wbSBpbnN0YWxsICIgKyBtaXNzaW5nR2xvYmFsTW9kdWxlcy5qb2luKCcgJykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgCQk8JT1sb2coKSU+YFN0YXJ0aW5nIFskezwlPW5zY29wZSU+Ll9ub2RlPzwlPW5zY29wZSU+Ll9ub2RlLmNvZGUoKTonJ31dLi4uYCk7DQoNCgkJCWlmIChvcHRpb25zLmxvYWRUb29scykgYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSkgfHwgX2NOYW1lKCklPigpLl9sb2FkVG9vbHMob3B0aW9ucy5zYXZlVG9vbHMpOw0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7ICAvKiBUb29scyBmaXJzdCBvciBOb2RlcyBmaXJzdD8/PyAqLyU+DQogICAgICAgICAgICBpZihvcHRpb25zLmluaXROb2RlKXsNCiAgICAgICAgICAgICAgICA8JT1uc2NvcGUlPi5fbm9kZSA9IGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5zZWN1cmUoc2VjdXJlKS5pbml0KHRoaXMuX19jb25maWcoJ2luaXQubG9vcCcsIDAuNSkpOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZig8JT1uc2NvcGUlPi5fbm9kZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuIDwlPWVycm9yKCklPiI8JT1uc2NvcGUlPi5fbm9kZSBpcyB1bmRlZmluZWQhIik7DQogICAgICAgICAgICB9DQo8JSB9JT4NCg0KICAgIAkJaWYgKHR5cGVvZih0aGlzLmluaXQpPT09J2Z1bmN0aW9uJyAmJiBvcHRpb25zLmluaXRTZWxmKSB7DQogICAgCQkJYXdhaXQgdGhpcy5pbml0KCk7DQogICAgDQogICAgCQkJbGV0IHNxbFRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQuX19kbWxTdGF0ZW1lbnRzKTsNCiAgICAJCQlpZiAob3B0aW9ucy5jb3B5RE1MICYmIHNxbFRvb2wpIHsNCiAgICAJCQkJbGV0IGRtbHMgPSBzcWxUb29sLl9fZG1sU3RhdGVtZW50czsNCiAgICAJCQkJaWYgKHNxbFRvb2wudHlwZS5uYW1lID09ICdTcWxEQicpIGRtbHMgPSBbIC8qIkN1c3RvbWVycyIsICJPcmRlcnMiLCAiU2hpcHBpbmdzIiwgKi8gImRlbW8iXS5tYXAodCA9PiBgZHJvcCB0YWJsZSBpZiBleGlzdHMgJHt0fWApLmNvbmNhdChkbWxzKTsNCiAgICAJCQkJX0ZyRU1ELl9jb3B5VGV4dFRvQ2xpcGJvYXJkKGRtbHMuam9pbignO1xuJykpOw0KICAgIAkJCX0NCiAgICAJCX0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlIFR5cGUnKSl7JT4NCiAgICAgICAgICAgIC8vIHJlZnJlc2ggc2NyaXB0DQogICAgICAgICAgICB0aGlzLnNldEludGVydmFsKG51bGwsIGFzeW5jICgvKnZlcnNpb24qLykgPT4gew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuc3IoKS5iTG9jYWwpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc2N0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlIFR5cGUnLCB0cnVlKSU+KG51bGwsICdGaWxlU3lzdGVtJykuX2Zyb21Eb2N1bWVudCg8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+IHx8IHtuYW1lOiAnTm9kZUpTJ30pOw0KICAgICAgICAgICAgICAgIGxldCBjdCA9IGF3YWl0IHNjdC5maW5kKCk7DQogICAgICAgICAgICAgICAgaWYoIWN0IHx8ICFjdC5hY3RpdmUoKSB8fCAhY3QuZW5hYmxlZCgpKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYoICFzY3QuZGF0ZSgpIHx8ICgoY3QuZGF0ZSgpLmdldFRpbWUoKSAtIHNjdC5kYXRlKCkuZ2V0VGltZSgpKS8xMDAwKSA+IDUgKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBOZXdlciB2ZXJzaW9uIGZvdW5kOiBbZGF0ZTogJHtjdC5kYXRlKCkudG9JU09TdHJpbmcoKX0sIHRvb2w6ICR7Y3QuVG9vbC5uYW1lfV0sIHN0b3JpbmcuLi5gKTsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB3YW50IHRvIHN0b3JlIHRoZSBjb250ZW50IGRpcmVjdGx5IHRvIHRoZSBub2RlanMuanMgZmlsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY3QuX2ZpbGVzeXN0ZW0oY3QuY29kZSgpICsgJy5qcycsIHRoaXMuX2F0b2IoY3QucmVtYXJrKCkpKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LnNlbGYgIT09IHdpbmRvdy50b3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ImlGcmFtZSBzaG91bGQgYmUgcmVzdGFydGVkLi4uIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4id2luZG93IGxvY2F0aW9uIHJlbG9hZGluZy4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3dpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJmcmFtZSBjaGVjayIsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+ID0gc2N0LmRhdGUoY3QuZGF0ZSgpKS5uYW1lKGN0Lm5hbWUoKSkuY29kZShjdC5jb2RlKCkpLl90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9LCAwLjUpOw0KPCUgfSU+DQogICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5sb2FkQ29udGVudCAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSB3aW5kb3cub25oYXNoY2hhbmdlID0gYXN5bmMgKCkgPT4gZG9jdW1lbnQuYm9keSA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7dG1wOiBsb2NhdGlvbi5oYXNoLnBhZ2V9KTsNCiAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGNvcnMoKSk7DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZSwgbGltaXQ6ICc1MG1iJ30pKTsNCiAgICAgICAgICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7DQogICAgICAgICAgICAgICAgICAgIHZlcmlmeTogKHJlcSwgcmVzLCBidWYpID0+IHJlcS5yYXdCb2R5ID0gYnVmDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddOw0KICAgICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuLnZlcmlmeSh0b2tlbiwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIChlcnIsIG9iaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoID0gbmV3IE9BdXRoU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgZGVidWc6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIHVzZUVycm9ySGFuZGxlcjogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWVNaWRkbGV3YXJlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyByZXF1aXJlQ2xpZW50QXV0aGVudGljYXRpb246IHsgcGFzc3dvcmQ6IGZhbHNlIH0sDQogICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtb2RlbDogKCgpID0+ICh7DQogICAgICAgICAgICAgICAgCQlnZXRBY2Nlc3NUb2tlbjogYmVhcmVyVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5hY2Nlc3NUb2tlbihiZWFyZXJUb2tlbikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0QWNjZXNzVG9rZW4nKSkudGhlbih0ID0+IHt0LmFjY2Vzc1Rva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5hY2Nlc3NUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICBnZXRDbGllbnQ6IChjbGllbnRJZCwgY2xpZW50U2VjcmV0KSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pbml0KCkuZmluYWxseSgoKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZChjbGllbnRJZCkuc2VjcmV0KGNsaWVudFNlY3JldCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldENsaWVudCcpKSwNCiAgICAgICAgICAgICAgICAJICAgIGdldFVzZXI6ICh1c2VybmFtZSwgcGFzc3dvcmQpID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLmF1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0VXNlcicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHNhdmVUb2tlbjogKHRva2VuLCBjbGllbnQsIHVzZXIpID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuX2Zyb21Eb2N1bWVudCh0b2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLl9mcm9tRG9jdW1lbnQoY2xpZW50KSkudXNlcih1c2VyKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdG9yZSgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnc2F2ZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgcmV2b2tlVG9rZW46IHRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkucmVmcmVzaFRva2VuKHRva2VuLnJlZnJlc2hUb2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLmlkKHRva2VuLmNsaWVudC5pZCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkpLmZpbmQoKS50aGVuKHQgPT4gdC5lbmFibGVkKGZhbHNlKS5hY3RpdmUoZmFsc2UpLnN0b3JlKCkpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAncmV2b2tlVG9rZW4nKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRSZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoMi8qd2h5Ki8pLnRoZW4odCA9PiB0Ll90b0RvY3VtZW50KCkpLnRoZW4odCA9PiB7dC5yZWZyZXNoVG9rZW5FeHBpcmVzQXQgPSBuZXcgRGF0ZSh0LnJlZnJlc2hUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgIAkgICAgICAgIH0pKSgpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoLmhhbmRsZXIgPSAodCwgbSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtKSA8JT1sb2coKSU+bSwgdC5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Ll90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPm0sIGV4LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9vYXV0aC90b2tlbicsIGFwcC5vYXV0aC50b2tlbigpKTsNCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXBwLm9hdXRoLmF1dGhlbnRpY2F0ZSgpOw0KPCUgfSU+DQoNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gbS5Jc1B1YmxpYykuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCjwlIH0pKSU+DQoNCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOw0KICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgYXBwLnVzZSgnL2dyYXBocWwnLCBncmFwaHFsSFRUUC5ncmFwaHFsSFRUUCh7DQogICAgICAgICAgICAgICAgICAgIHNjaGVtYTogZ3JhcGhxbC5idWlsZFNjaGVtYSh0aGlzLl90b0dRTFNjaGVtYSgpKSwNCiAgICAgICAgICAgICAgICAgICAgcm9vdFZhbHVlOiB0aGlzLl9xbFJlc29sdmVyKCksDQogICAgICAgICAgICAgICAgICAgIGdyYXBoaXFsOiB0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIiksDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoInBsYXlncm91bmQiKSAmJiB0eXBlb2YocGxheWdyb3VuZCkhPT0idW5kZWZpbmVkIikgYXBwLmdldCgnL3BsYXlncm91bmQnLCBwbGF5Z3JvdW5kLmRlZmF1bHQoeyBlbmRwb2ludDogJy9ncmFwaHFsJyB9KSkNCjwlIH0lPg0KDQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKT97DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksDQogICAgICAgICAgICAgICAgICAgICAgICB9OnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAgICBhd2FpdCA8JT1zY29wZSU+LnRyYW5zcG9ydGVyLnNlbmRNYWlsKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdG8sDQogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwb3J0ID0gPCU9bnNjb3BlJT4uX25vZGU/KDwlPW5zY29wZSU+Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKTozMDAwOw0KICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gIjAuMC4wLjAiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiA8JT1sb2coKSU+YDwlPXNjb3BlJT5bJHt0aGlzLmlwQWRkcmVzcygpfV0gbGlzdGVuaW5nIGF0IGh0dHAke3NlY3VyZT8ncyc6Jyd9Oi8vJHthZGRyZXNzfToke3BvcnR9YCk7DQogICAgICAgICAgICAgICAgaWYoc2VjdXJlKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNlcnQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZTogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gc2VsZnNpZ25lZC5nZW5lcmF0ZShbeyBuYW1lOiAnY29tbW9uTmFtZScsIHZhbHVlOiAnbmFtbW91ci5jb20nIH1dLCB7IGRheXM6IDM2NSB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwcy5jcmVhdGVTZXJ2ZXIoew0KICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBjZXJ0LnByaXZhdGUsDQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiBjZXJ0LmNlcnQNCiAgICAgICAgICAgICAgICAgICAgfSwgYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW5ib3VuZENhbGwnJT4ocmVxLCByZXMsIGNOYW1lLCBtTmFtZSl7DQogICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IDwlPXNjb3BlJT5bcmVxLnBhcmFtcy5jbGFzcyB8fCBjTmFtZV0oKS5faW52b2tlKHJlcS5wYXJhbXMubWV0aG9kIHx8IG1OYW1lLCByZXEuYm9keSwgcmVxLnF1ZXJ5LCByZXEuX19hdXRob3JpemF0aW9uKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBFeGNlcHRpb246ICJFeGNlcHRpb246ICIgKyBleCwNCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgdHlwZW9mKHJldCk9PT0ibnVtYmVyIikgcmV0ID0gcmV0LnRvU3RyaW5nKCk7DQogICAgICAgIHJlcy5zZW5kKHJldCk7DQogICAgfQ0KDQo8JSBpZihjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgIDwlPW1OYW1lPSdfcWxTZWxlY3Rpb25zJyU+KHNTZXQpew0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIGlmKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7DQogICAgICAgIA0KICAgICAgICBzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHMubmFtZS52YWx1ZT09IjwlPW5OYW1lKGVhKSU+Iil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPidSZWZlcmVuY2UgZm9yIDwlPW5OYW1lKGVhKSU+Jywgcyk7DQogICAgICAgICAgICAgICAgbGV0IHNPYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bk5hbWUoZWEpJT5fPCU9Yy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goc09iaik7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19xbFJlc29sdmVyJyU+KCl7DQogICAgICAgIHJldHVybiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKF9jKSU+OiBhc3luYyAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXBhcmVudC5kYXRhKSBwYXJlbnQucXVlcnkgPSBwYXJlbnQucXVlcnkgfHwge307DQogICAgICAgICAgICAgICAgbGV0IG9iaiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuX2Zyb21Eb2N1bWVudChwYXJlbnQucXVlcnkgfHwgcGFyZW50LmRhdGEpOw0KICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKHBhcmVudC5xdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZHMgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouZmluZEFsbChudWxsLCBvYmouX3FsU2VsZWN0aW9ucyhjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0KSwgbnVsbCwgbnVsbCwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0uY29uY2F0KGNvbnRleHQuZmllbGROb2Rlc1swXS5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucy5tYXAocyA9PiBzLm5hbWUudmFsdWUpKSk7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYocGFyZW50LmRhdGEpew0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouc3RvcmUoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYob2JqLl9fYXNzZXJ0RXJyb3IpIHRocm93IG9iai5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0Lm1hcChyID0+IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ/cmV0Ll90b0RvY3VtZW50KCk6cmV0Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5mb3JFYWNoKF9tID0+IHslPg0KICAgICAgICAgICAgLy8gPCU9bk5hbWUoX20pJT46IChwYXJlbnQsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuPCU9bk5hbWUoX20pJT4oIjwlPW5OYW1lKF9tKSU+IiwgcGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSwNCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgIH07DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9HUUxTY2hlbWEnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IGANCnR5cGUgUXVlcnkgew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgRmluZCBhbGwgbWF0Y2hlcyBmb3IgPCU9bk5hbWUoX2MpJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihxdWVyeTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IFs8JT1uTmFtZShfYyklPl0NCjwlIH0pJT4NCn0NCg0KdHlwZSBNdXRhdGlvbiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAiIiINCiAgICBTdG9yZSBhIHNpbmdsZSA8JT1uTmFtZShfYyklPiBvYmplY3QNCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihkYXRhOiA8JT1uTmFtZShfYyklPklucHV0KTogPCU9bk5hbWUoX2MpJT4NCjwlIH0pJT4NCn0NCiAgICANCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiIiIg0KSW5wdXQgdHlwZSBmb3IgPCU9bk5hbWUoX2MpJT4NCiIiIg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5JbnB1dHsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEsIHRydWUpJT4NCiAgICA8JSB9KSU+DQogICAgPCUgX2MuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kICYmIHRhLkVudGl0eVR5cGUpLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsgJT4NCiAgICA8JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjogWzwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+SW5wdXRdDQogICAgPCUgfSklPg0KICAgIE9QRVJBVE9SUzogPCU9bk5hbWUoX2MpJT5PcGVyYXRvcg0KfQ0KDQppbnB1dCA8JT1uTmFtZShfYyklPk9wZXJhdG9yew0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bk5hbWUoZWEpJT46IFN0cmluZw0KICAgIDwlIH0pJT4NCn0NCg0KIiIiDQo8JT1fYy5SZW1hcmslPg0KIiIiDQp0eXBlIDwlPW5OYW1lKF9jKSU+ew0KICAgIF9pZDogSUQhDQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1lYS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEpJT48JT1lYS5Jc1JlcXVpcmVkPychJzonJyU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPl0NCiAgICA8JSB9KSU+DQoNCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiAhX20uTWV0aG9kUGFyYW1ldGVycy5sZW5ndGgpLmZvckVhY2goX20gPT4geyU+DQogICAgIiIiDQogICAgPCU9X20uUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfbSklPjogPCU9cWxUeXBlKF9tLlJlc3BvbnNlQXR0cmlidXRlLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKF9tID0+IF9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT4oPCU9X20uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuTmFtZShwKSArICc6ICcgKyBxbFR5cGUocCwgdHJ1ZSkpLmpvaW4oJywgJyklPik6IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSklPg0KICAgIDwlIH0pJT4NCn0NCiAgICA8JSB9KSU+DQogICAgICAgIGA7DQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gLy8gZ3JhcGglPg0KDQo8JSB9IC8vIElzTWFpbiAlPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2VOb2RlJyU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsNCiAgICAgICAgLy8gaWYoIW4pIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKDwlPW5zY29wZSU+Ll9ub2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5zY29wZSU+Ll9ub2RlIG5vdCBkZWZpbmVkIik7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoZXZlbnQpew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkhPSc8JT1uTmFtZShjKSU+Jyl7DQogICAgICAgICAgICAgICAgbGV0IG9DbGFzcyA9IG51bGw7DQogICAgICAgICAgICAgICAgaWYoZmFsc2Upew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkrJy4nK21ldGhvZCsnIC4uLi4nKTsNCiAgICA8JSBzci5ncm91cEJ5KGFyQ2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLmZvckVhY2goZW0gPT4geyU+DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoWyI8JT1lbS52YWx1ZXMubWFwKG1jID0+IG5OYW1lKG1jKSkuam9pbignIiwgIicpJT4iXS5pbmRleE9mKGV2ZW50LmNsYXNzTmFtZSgpKT49MCl7DQogICAgICAgICAgICAgICAgICAgIG9DbGFzcyA9IG5ldyA8JT1zY29wZSU+PCU9ZW0ua2V5PygnLicrZW0ua2V5LkFsaWFzKTonJyU+W2V2ZW50LmNsYXNzTmFtZSgpXSgpOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG9DbGFzcy48JT1tTmFtZSU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOw0KICAgICAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIDwlPWVycm9yKCklPiJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQoNCiAgICAgICAgZGF0YSA9IGRhdGEgfHwge307DQoNCiAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0pTT04oe3BhcnNlOiAxfSk7DQogICAgICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCiAgICA8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIGRhdGEuPCU9bk5hbWUocCklPiA9IGRhdGEuPCU9bk5hbWUocCklPj9kYXRhLjwlPW5OYW1lKHApJT4NCiAgICAgICAgICAgIDwlaWYocC5Jc0FycmF5KXslPi5tYXAoX3AgPT4gX3A8JX0lPg0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPi5fdG9Eb2N1bWVudCgpDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihwLklzRGF0ZSl7JT4udG9JU09TdHJpbmcoKQ0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4pPCV9JT46dW5kZWZpbmVkOw0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgIGlmKHR5cGVvZihuKT09PSdzdHJpbmcnKSBuID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLmNvZGUobik7DQo8JSB9JT4NCg0KICAgICAgICBpZighbiB8fCA8JT1uc2NvcGUlPi5fbm9kZS5fc2FtZUVudGl0eShuKSl7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iTG9jYWwgbm9kZSIsIHJldCk7DQoNCiAgICAgICAgfWVsc2UgaWYobi5hZGRyZXNzKCkpew0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5uLmFkZHJlc3MoKSwgbi5wb3J0KCksIG1ldGhvZCk7DQogICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdCh1bmRlZmluZWQsIGRhdGEsIG51bGwsIG51bGwsIHtwYXRoOiBgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvPCU9bk5hbWUoYyklPi8ke21ldGhvZH1gLCBoZWFkZXJzOiB7fX0pOw0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICB9DQogICAgICAgIH1lbHNlew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpICYmIGMuTmFtZSE9PSdFdmVudCcpeyU+DQogICAgICAgICAgICBpZih0eXBlb2YoZGF0YSk9PT0ib2JqZWN0Iil7DQogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOw0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/Pw0KICAgICAgICAgICAgPCUgLyp1blJlY3Vyc2UoJ2RhdGEnLCAnbWV0aG9kJywgJ3t9JywgJycsIDUsICdfX3RoaXMuY29kZScpKi8gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGV2ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICc8JT1zY29wZSU+LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnPCU9bk5hbWUoYyklPicpLnNlbmRlcig8JT1uc2NvcGUlPi5fbm9kZSkuY2Fycmllcig8JT1uc2NvcGUlPi5fbm9kZSkucGF5bG9hZCh0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7DQogICAgICAgICAgICBpZihldmVudCl7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gSlNPTi5wYXJzZShyZXQpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2UgaWYocmV0ICYmIHR5cGVvZihyZXQucGF5bG9hZCk9PT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICAvLyByZXQgaXMgYW4gZXZlbnQNCiAgICAgICAgICAgICAgICByZXQgPSByZXQucGF5bG9hZCgpOw0KICAgICAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShyZXQpICYmIHJldFswXSAmJiB0eXBlb2YocmV0WzBdLnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0Lm1hcChyID0+IHIucGF5bG9hZCgpKTsNCiAgICAgICAgICAgICAgICBpZihyZXQubGVuZ3RoPT0xKSByZXQgPSByZXRbMF07DQogICAgICAgICAgICB9DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoIXJldCkgcmV0dXJuIG51bGw7DQogICAgICAgIHJldCA9IHJldC5kYXRhIHx8IHJldDsNCg0KICAgICAgICBpZihyZXQuX19leGNlcHRpb24pew0KICAgICAgICAgICAgLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXINCiAgICAgICAgICAgIDwlPWVycm9yKCklPmBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9DQoNCiAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgY2FzZSAiPCU9bkNvZGUobSklPiI6IHsNCiAgICA8JSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpJT4oKS5fZnJvbURvY3VtZW50KHJldCk7DQogICAgPCUgfSAlPg0KICAgIDwlIGlmKG0uTmFtZT09J2F1dGhvcml6ZScpeyU+DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3Rva2VuID0ge3Rva2VuX3R5cGU6ICJCZWFyZXIiLCBhY2Nlc3NfdG9rZW46IHJldH07DQogICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGNhc2UgImluc2VydCI6DQogICAgICAgICAgICBjYXNlICJ1cGRhdGUiOg0KICAgICAgICAgICAgY2FzZSAic3RvcmUiOg0KICAgICAgICAgICAgY2FzZSAiZGVsZXRlIjoNCiAgICAgICAgICAgIGNhc2UgImZpbmQiOiANCiAgICAgICAgICAgIGNhc2UgImZpbmRBbGwiOiB7DQogICAgICAgICAgICAgICAgaWYoIWJSYXcpIHJldCA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHJldCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQo8JSBpZihtYWluQ2xhc3MoKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2ludm9rZSclPihtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKXsNCiAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYyklPi4nICsgbWV0aG9kKTsNCiAgICAgICAgPCU9bG9nKCklPm1ldGhvZCwgcXVlcnksIGJvZHkpOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKGJvZHkpPT09J3N0cmluZycpew0KICAgICAgICAgICAgaWYoPCU9X2I2NHRlc3QoJ2JvZHknKSU+KXsgLy8gYmFzZTY0Pw0KICAgICAgICAgICAgICAgIGJvZHkgPSB0aGlzLl9hdG9iKGJvZHkpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZigvW14sOnt9XFtcXTAtOS5cLStFYWVmbG5yLXUgXG5cclx0XS8udGVzdChib2R5KSl7IC8vIGpzb24NCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgX3BhcmFtcyA9IHF1ZXJ5P09iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpOmJvZHk7DQogICAgICAgIGlmKHR5cGVvZihfcGFyYW1zKT09PSdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsNCiAgICAgICAgDQogICAgICAgIGlmKF9wYXJhbXMpew0KICAgICAgICAgICAgX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgX3BhcmFtcyA9IHt9Ow0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bG9nKCklPiJfcGFyYW1zIiwgX3BhcmFtcyk7DQoNCiAgICA8JSBpZihfY05hbWUoJ05vZGUnKSAmJiBjLk5hbWUhPSdOb2RlJyl7JT4NCiAgICAgICAgaWYoX3BhcmFtcy5fX25vZGUpew0KICAgICAgICAgICAgLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8NCiAgICAgICAgICAgIGxldCB0biA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS8qLl9kZVJlZmVyZW5jZSgpKi87DQogICAgICAgICAgICBkZWxldGUgX3BhcmFtcy5fX25vZGU7DQogICAgICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsNCiAgICAgICAgfQ0KICAgIDwlIH0lPg0KDQogICAgICAgIGlmKF9wYXJhbXMuX190aGlzKSB7DQogICAgICAgICAgICBfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOw0KICAgICAgICAgICAgbGV0IF9fdGhpcyA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykvKi5fZGVSZWZlcmVuY2UoKSovOw0KICAgICAgICAgICAgZGVsZXRlIF9wYXJhbXMuX190aGlzOw0KICAgICAgICAgICAgcmV0dXJuIGF3YWl0IF9fdGhpcy48JT1tTmFtZSU+KG1ldGhvZCwgX3BhcmFtcywgbnVsbCwgYXV0aE9iaik7DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgYXJBcmdzID0gW107DQogICAgICAgIHN3aXRjaChtZXRob2Qpew0KPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQo8JSBpZihfY05hbWUoJ1RyYW5zYWN0aW9uJykgJiYgX2NOYW1lKCdDb250ZW50JykgJiYgYy5OYW1lIT0nVHJhbnNhY3Rpb24nICYmICFtLklzU3luYyl7JT4NCiAgICAgICAgaWYoIV9wYXJhbXMuU3luYyl7DQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdDb250ZW50JywgdHJ1ZSklPigoYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdDb250ZW50JywgdHJ1ZSklPigpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLnNjb3BlKCI8JT1zY29wZSU+IikuY2xhc3MoIjwlPWMuTmFtZSU+IikubWV0aG9kKG1ldGhvZCkuYXV0aG9yaXphdGlvbihhdXRoT2JqKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5wYXlsb2FkKHRoaXMuX2J0b2EoX3BhcmFtcykpLnRyYW5zYWN0aW9uX1RyYW5zYWN0aW9uTG9ncyhbbmV3IDwlPXNjb3BlJT4uVHJhbnNhY3Rpb25Mb2coKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5zdGF0ZShuZXcgPCU9c2NvcGUlPi5UcmFuc2FjdGlvblN0YXRlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgibG9hZGVkIikpXSkuc3RvcmUoKSkuSWQpLl90b0RvY3VtZW50KCk7DQogICAgICAgIH0NCjwlIH0lPg0KDQogICAgPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlICYmIHAuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICBfcGFyYW1zLjwlPW5Db2RlKHApJT4gPSBfcGFyYW1zLjwlPW5Db2RlKHApJT4ubWFwKHAgPT4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUocC5FbnRpdHlUeXBlKSU+KCkuX2Zyb21Eb2N1bWVudChwKS5fZGVSZWZlcmVuY2UoKSk7DQogICAgICAgIDwlIH1lbHNlIGlmKHAuRW50aXR5VHlwZSl7ICU+DQogICAgICAgICAgICAgICAgX3BhcmFtcy48JT1uQ29kZShwKSU+ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUocC5FbnRpdHlUeXBlKSU+KCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLjwlPW5Db2RlKHApJT4pLl9kZVJlZmVyZW5jZSgpOw0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy48JT1uQ29kZShwKSU+KTsNCiAgICA8JSB9KTslPg0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KPCUgfSk7JT4NCg0KICAgICAgICAgICAgY2FzZSAiZmluZEFsbCI6ew0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAiZmluZCI6IHsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgb2JqID0gdGhpczsNCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICBpZighb2JqKXsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAnLTEnOiBgPCU9bk5hbWUoYyklPi48JT1tTmFtZSU+OiBvYmogaXMgdW5kZWZpbmVkYA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH1lbHNlIGlmKCFvYmpbbWV0aG9kXSl7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgJy0yJzogYDwlPW5OYW1lKGMpJT4uPCU9bU5hbWUlPjogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwNCiAgICAgICAgICAgICAgICAgICAgJ29iaic6IG9iag0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsNCiAgICAgICAgfQ0KICAgICAgICANCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgaWYoZmFsc2UgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uICYmICE8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKXsNCiAgICAgICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAnLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLA0KICAgICAgICAgICAgICAgICAgICAgICAgJ29iaic6IG9iag0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgaWYocmV0ICYmICFyZXQuX19leGNlcHRpb24pew0KICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlID0ge307DQogICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgICAgICAgICAgICAgIGxldCBfcmV0ID0gW107DQogICAgICAgICAgICAgICAgZm9yIGF3YWl0KGNvbnN0IHIgb2YgcmV0KXsNCiAgICAgICAgICAgICAgICAgICAgaWYociAmJiByLl90b0RvY3VtZW50KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+KSBkZWxldGUgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT4uX3RvRG9jdW1lbnQ7DQogICAgICAgICAgICAgICAgICAgICAgICBfcmV0LnB1c2goYXdhaXQgci5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgX3JldC5wdXNoKHIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXQgPSBfcmV0Ow0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpP2F3YWl0IHJldC5fdG9Eb2N1bWVudCgpOnJldDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPidyZXQnLCByZXQpOw0KICAgICAgICA8JT1sb2coKSU+YCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjKSU+LicgKyBtZXRob2QpfWApOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgPCU9bU5hbWU9J19wYXJzZUNvZGVTdGF0ZSclPih0KXsNCiAgICA8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgbGV0IHN0YXRlID0gdGhpcy5fX2NvbmZpZyh0aGlzLl9fY29uZmlnKCdvYXV0aC5yZWRpcmVjdC5zdGF0ZScsIG51bGwsIHt0b29sOiB0fSkpOw0KICAgICAgICBsZXQgY29kZSA9IHRoaXMuX19jb25maWcodGhpcy5fX2NvbmZpZygnb2F1dGgucmVkaXJlY3QuY29kZScsIG51bGwsIHt0b29sOiB0fSkpOw0KICAgICAgICBpZighc3RhdGUgfHwgIWNvZGUpIHJldHVybjsNCiAgICAgICAgc3RhdGUgPSBKU09OLnBhcnNlKHRoaXMuX2F0b2Ioc3RhdGUpKTsNCiAgICAgICAgaWYoc3RhdGUudG9vbCE9PXQubmFtZSkgcmV0dXJuOw0KDQogICAgICAgIDwlPWxvZygpJT4iR09UIENPREUgIiArIGNvZGUgKyAiIGZvciBub2RlICIgKyBzdGF0ZS5uY29kZSArICIgd2l0aCB0b29sICIgKyBzdGF0ZS50b29sKTsNCiAgICAgICAgaWYoITwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpIHx8ICE8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50Ll9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKSl7DQogICAgICAgICAgICA8JT1sb2coKSU+J25ldyBwYXJlbnQnLCBzdGF0ZS5uY29kZSk7DQogICAgICAgICAgICA8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLmNvZGUoc3RhdGUubmNvZGUpKTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1uc2NvcGUlPi5fbm9kZS5hdXRoQ29kZShjb2RlLCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkubmFtZShzdGF0ZS50b29sKSk7DQogICAgICAgIHdpbmRvdy5jbG9zZSgpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoKSklPigpLjwlPW1OYW1lJT4odCk7DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2xvYWRUb29scyclPihiU3RvcmUpew0KICAgICAgICBpZig8JT1zY29wZSU+LlRvb2xzICYmIDwlPXNjb3BlJT4uVG9vbHMubGVuZ3RoKXsNCiAgICAgICAgICAgIDwlPWxvZygpJT5gVG9vbHMgYWxyZWFkeSBsb2FkZWRgKTsNCiAgICAgICAgICAgIHJldHVybiA8JT1zY29wZSU+LlRvb2xzOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+YExvYWRpbmcgdG9vbHMuLi5gKTsNCiAgICAgICAgDQogICAgICAgIGxldCB0b29scyA9IFtdOw0KICAgICAgICB0b29scyA9IDwlPXNjb3BlJT4uX19Ub29scyB8fCB0b29sczsNCiAgICAgICAgZGVsZXRlIDwlPXNjb3BlJT4uX19Ub29sczsNCg0KICAgICAgICBsZXQgYXJUb29scyA9IDwlPV9GckVNRC5fdG9KUyhbLi4ubmV3IFNldChhckNsYXNzZXMubWFwKF9jID0+IF9jLlRvb2xzKS5mbGF0KCkpXSklPjsNCiAgICAgICAgbGV0IHRvb2xOYW1lcyA9IGFyVG9vbHMubWFwKHQgPT4gdC5uYW1lIHx8ICh0LnR5cGU/dC50eXBlLm5hbWU6dCkpOw0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0b29scy5sZW5ndGghPT10b29sTmFtZXMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAvLyBjYW5ub3QgdXNlIHJlcXVpcmUgeWV0LCBubyB0b29scyBwcm9wZXJseSBsb2FkZWQgdG8gdXNlIGEgbG9hZGVyIGZ1bmN0aW9uDQogICAgICAgICAgICAgICAgdG9vbHMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoe05hbWU6ICdBUElTRVJWRVJfPCU9bU5hbWUlPicsIEFjdGl2ZTogdHJ1ZSwgRW5hYmxlZDogdHJ1ZX0pIHx8IHRvb2xzOw0KICAgICAgICAgICAgfQ0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgICAgIGlmKCF0b29scy5sZW5ndGgpIHRvb2xzID0gKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVG9vbCcsIHRydWUpJT4oKS5USElTKHRvb2xOYW1lcy5tYXAodCA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkubmFtZSh0KSkpLmZpbmRBbGwoMikpLm1hcCh0ID0+IHQuX3RvSlNPTih7cGFyc2U6IDF9KSkgfHwgdG9vbHM7DQo8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgZml4VG9vbHMgPSB0b29scyA9PiB7DQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0Lm5hbWUnLCAndC50eXBlLm5hbWUnKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuZW5hYmxlZCcsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuZW5hYmxlZCcsIHRydWUpJT4NCg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfQ29uZmlncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUudHlwZV9NYXBwaW5ncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnRvb2xfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgIA0KICAgICAgICAgICAgICAgIFtdLmNvbmNhdCh0LnRvb2xfQ29uZmlncywgdC50eXBlLnR5cGVfQ29uZmlncywgdC50eXBlLnR5cGVfTWFwcGluZ3MsIHQudG9vbF9NYXBwaW5ncykuZm9yRWFjaChjID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIHRvb2xzLmZpbHRlcih0ID0+IHR5cGVvZih0KT09PSdvYmplY3QnICYmIHQpLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpIT09Im9iamVjdCIpLmNvbmNhdChEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5maWx0ZXIoYyA9PiB0eXBlb2YoYy52YWx1ZSk9PT0ib2JqZWN0IiAmJiBjLnZhbHVlKS5tYXAoYyA9PiBPYmplY3Qua2V5cyhjLnZhbHVlKS5tYXAobmNvZGUgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF9jID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGMubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYy52YWx1ZVtuY29kZV0sDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobmNvZGUhPSJkZWZhdWx0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Mubm9kZSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogbmNvZGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsIDwlLy8gb3RoZXJ3aXNlIGl0IHN0YXJ0cyBnZXR0aW5nIGV2ZW50cyU+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJOb2RlSlMiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfYzsNCiAgICAgICAgICAgICAgICAgICAgfSkuZmxhdCgpKS5mbGF0KCkpLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZm9yRWFjaChjID0+IGMudmFsdWUgPSBKU09OLnN0cmluZ2lmeShjLnZhbHVlKSk7DQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICk7DQogICAgICAgIH07DQoNCg0KICAgICAgICBmaXhUb29scyh0b29scyk7DQogICAgICAgIHRvb2xzID0gdG9vbHMuZmlsdGVyKHQgPT4gdC5hY3RpdmUpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHRvb2xOYW1lcy5maW5kKF90ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KDQogICAgICAgIDwlPWxvZygpJT5gVG9vbHMgYXJlICR7dG9vbHMubGVuZ3RofWApOw0KDQogICAgICAgIDwlPXNjb3BlJT4uVG9vbHMgPSB0b29sczsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zICYmIDwlPUpTT04uc3RyaW5naWZ5KF9yZXN0VG9vbHMpJT4uaW5kZXhPZih0LnR5cGUubmFtZSk+PTApLmZvckVhY2godCA9PiB7DQogICAgICAgICAgICB0LmF4aW9zID0gdHlwZW9mKGF4aW9zLmNyZWF0ZSk9PT0nZnVuY3Rpb24nP2F4aW9zLmNyZWF0ZSgpOmF4aW9zOw0KICAgICAgICAgICAgdC5heGlvcy5pbnRlcmNlcHRvcnMucmVxdWVzdC51c2UocmVxdWVzdCA9PiB0aGlzLl9yZXF1ZXN0SW50ZXJjZXB0b3IocmVxdWVzdCwgdCksIGVycm9yID0+IHt9KTsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShyZXNwb25zZSA9PiByZXNwb25zZSwgZXJyb3IgPT4gdGhpcy5fcmVzcG9uc2VJbnRlcmNlcHRvcihlcnJvciwgdCkpOw0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIC8vIGNvbm5lY3QgdG8gdGhlIGxvYWRlZCB0b29scyEhIQ0KICAgICAgICBsZXQgdG9vbCA9IHRoaXMuVG9vbDsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4uVG9vbHMpew0KPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHtlbS52YWx1ZXMgPSBlbS52YWx1ZXMuc29ydCgoYSwgYikgPT4gYi5SYW5rIC0gYS5SYW5rKTsgJT4NCiAgICAgICAgICAgIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlbS52YWx1ZXNbMF0sIHRydWUpJT4odW5kZWZpbmVkLCB0KS5fc3RvcmVFbnRpdHlDbGFzcyg8JT1lbS52YWx1ZXNbMF0uUmFuayU+KTsNCjwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLlRvb2wgPSB0b29sOw0KICAgICAgICANCiAgICAgICAgYXJUb29scyA9IGFyVG9vbHMuZmlsdGVyKF90ID0+ICF0b29scy5maW5kKHQgPT4gKHR5cGVvZihfdCk9PT0nc3RyaW5nJz9fdDpfdC5uYW1lKT09dC5uYW1lKSk7DQogICAgICAgIGZpeFRvb2xzKGFyVG9vbHMpOw0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgPCU9c2NvcGUlPi5vVG9vbHMgPSA8JT1zY29wZSU+LlRvb2xzLmNvbmNhdChhclRvb2xzKS5maWx0ZXIodCA9PiB0LmFjdGl2ZSkubWFwKHQgPT4gew0KICAgICAgICAgICAgdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50b29sKTsNCiAgICAgICAgICAgIHQudHlwZS50eXBlX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50eXBlKTsNCiAgICANCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCh0KTsNCiAgICAgICAgfSk7DQogICAgICAgIGlmKGJTdG9yZSl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFNhdmluZyB0b29scy4uLmApOw0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4ub1Rvb2xzKXsNCiAgICAgICAgICAgICAgICBhd2FpdCB0LnN0b3JlKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCjwlIH0lPg0KDQogICAgICAgIDwlPWxvZygpJT5gRXhpdGluZ2ApOw0KICAgICAgICByZXR1cm4gdG9vbHM7DQogICAgfQ0KICAgIA0KPCUgfSAvLyBtYWluQ2xhc3MgJT4NCg0KCTwlPW1OYW1lPSdfcGFyYW1ldHJpemUnJT4oc3RyLCBmdW4sIG9wdGlvbnM9e30sIHByZWZpeD0ne3snLCBwb3N0Zml4PSd9fScpIHsNCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2Yoc3RyKSE9PSdzdHJpbmcnKSByZXR1cm4gc3RyOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV4ID0gYCR7cHJlZml4fShbXiR7cG9zdGZpeH1dKykke3Bvc3RmaXh9YDsNCiAgICAgICAgICAgIChzdHIubWF0Y2gobmV3IFJlZ0V4cChyZXgsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gc3RyID0gc3RyLnJlcGxhY2UobSwgbSA9PiBmdW4obS5yZXBsYWNlKHByZWZpeCwgJycpLnJlcGxhY2UocG9zdGZpeCwgJycpKSkpOw0KDQogICAgICAgICAgICByZXR1cm4gc3RyOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHN0ciwgZnVuLCBvcHRpb25zLCBwcmVmaXgsIHBvc3RmaXgpOw0KPCUgfSU+DQoJfQ0KDQogICAgPCU9bU5hbWU9J19fc3luY19vbiclPihkKXsNCiAgICAgICAgdGhpcy5fPCU9bU5hbWUlPiA9IHRoaXMuXzwlPW1OYW1lJT4gfHwge307DQogICAgDQogICAgICAgIGlmKGQpeyAvLyBzZXQgdGhlIHZhbHVlDQogICAgICAgICAgICB0aGlzLl88JT1tTmFtZSU+W3RoaXMuVG9vbC5uYW1lXSA9IGQ7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KHRoaXMsIHsNCiAgICAgICAgICAgICAgICBDeWNsaWM6IHRydWUsDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk6dW5kZWZpbmVkLA0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICAvLzwlPXRhTmFtZSU+OiB0aGlzLjwlPXRhTmFtZSU+KCkuZm9yRWFjaCh0ID0+IHQuPCU9bU5hbWUlPihkKSksDQo8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGQpOw0KDQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSkgdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk7DQo8JSB9KSU+DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgLy8gdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpOw0KPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV07IC8vIGdldCB0aGUgdmFsdWUNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19jbG9uZSclPihiVHlwZUF0dHJpYnV0ZXMpew0KICAgICAgICA8JT13YXJuKCklPiJERVBSRUNBVEVEOiB1c2UgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodGhpcy5fdG9KU09OKCkpIik7DQoNCiAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIA0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCksIHsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4odjwlaWYoZWEuRW50aXR5VHlwZSl7JT4uPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpPCV9JT4pLA0KPCUgfSk7JT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IGJUeXBlQXR0cmlidXRlcz9vYmouPCU9dGFOYW1lJT4odi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpKSk6bnVsbCwNCjwlIH0pOyU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19tYXAnJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsNCiAgICAgICAgdG9vbCA9IHRvb2wgfHwgX3RoaXMuVG9vbDsNCiAgICAgICAgY29kZVR5cGUgPSBjb2RlVHlwZSB8fCA8JT1fZWFUeXBlcygpJT5bY29kZV07DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIG1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lIHx8ICI8JT1jLkVudGl0eU1vZHVsZT9jLkVudGl0eU1vZHVsZS5OYW1lOicnJT4iOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBfbG9nID0gYCR7bW9kdWxlTmFtZX0uJHtjbGFzc05hbWV9LiR7Y29udGV4dH0ke2JSZXZlcnNlPyc8PSc6Jz0+J30ke2NvZGV9YDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy9pZihBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKSk7DQogICAgICAgIA0KICAgICAgICAgICAgPCUgLyogdGVtcHRlZCB0byB1c2UganNvbmF0YSBpbiBRdWVyeSBmaWVsZHMsIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBqc29uYXRhLmV2YWx1YXRlIHJldHVybiBhIHByb21pc2UhISEgKi8lPg0KICAgICAgICAgICAgbGV0IHNGaWVsZCA9IGJSZXZlcnNlPyd0YXJnZXQnOidzb3VyY2UnOw0KICAgICAgICAgICAgbGV0IHNTY3JpcHQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgc0NvbmQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ0NvbmRpdGlvbic7DQogICAgICAgICAgICBsZXQgc1BhdGggPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRGaWVsZCA9IGJSZXZlcnNlPydzb3VyY2UnOid0YXJnZXQnOw0KICAgICAgICAgICAgbGV0IHRTY3JpcHQgPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgdFBhdGggPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRDb25kID0gKGJSZXZlcnNlPydpbic6J291dCcpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPmNsYXNzTmFtZSwgX2xvZywgLi4ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvcHRpb25zID0ge19jbGFzczogY2xhc3NOYW1lLCBfdGhpczogX3RoaXMsIHRvb2w6IHRvb2x9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX3NjcmlwdCA9IChzLCBtKSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW5TY3JpcHQoYChvU2NvcGUsIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcikgPT4gJHtzfWApKDwlPXNjb3BlJT4sIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgd2FybihtLnRlc3RzLmxvZywgZXgpOyANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX21hdGNoID0gKHMsIHIpID0+IHsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yocyk9PT0ndW5kZWZpbmVkJyB8fCBzPT09bnVsbCB8fCB0eXBlb2Yocy5tYXRjaCkhPT0nZnVuY3Rpb24nKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IHMubWF0Y2gobmV3IFJlZ0V4cChyLCAnZycpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gcz09ciB8fCAoKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKT90cnVlOmZhbHNlKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBpdGVtcyA9PiBpdGVtcy5tYXAoaXRlbSA9PiBBcnJheS5pc0FycmF5KGl0ZW0pID8gY2xvbmUoaXRlbSkgOiBpdGVtKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG1zID0gY2xvbmUoIFsuLi4odG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pXSApOyAvLyBkbyBub3QgdGFtcGVyIHdpdGggdGhlIG1hcHBpbmdzLCBkZWVwIGNsb25lDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gT2JqZWN0LmtleXMobSkuZm9yRWFjaChrID0+IG1ba10gPSB0aGlzLl9wYXJhbWV0cml6ZShtW2tdLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpKSk7DQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gbS50ZXN0cyA9IHsNCiAgICAgICAgICAgICAgICBhY3RpdmU6IDwldmFsdWVPZigibS5hY3RpdmUiKSU+LCAvL19zY3JpcHQobS5hY3RpdmUsIG0pLA0KICAgICAgICAgICAgICAgIGVuYWJsZWQ6IDwldmFsdWVPZigibS5lbmFibGVkIiklPiwgLy9fc2NyaXB0KG0uZW5hYmxlZCwgbSksDQogICAgICAgICAgICAgICAgY29udGV4dDogX21hdGNoKGNvbnRleHQsIG0uY29udGV4dCksDQogICAgICAgICAgICAgICAgY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwNCiAgICAgICAgICAgICAgICBtb2R1bGU6IF9tYXRjaChtb2R1bGVOYW1lLCBtLm1vZHVsZU5hbWUpLA0KICAgICAgICAgICAgICAgIHNGaWVsZDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSksDQogICAgICAgICAgICAgICAgc1NjcmlwdDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgc1BhdGg6IHR5cGVvZihtW3NQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHR5cGVvZihtW3RGaWVsZF0gfHwgbVt0U2NyaXB0XSB8fCBtW3RQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0ZXh0OiBgJHtjb2RlfToke3NGaWVsZH09PT4ke3RGaWVsZH1gLA0KICAgICAgICAgICAgICAgIGxvZzogYCR7X2xvZ31bJHttLmNvbnRleHR9LyR7bS5jbGFzc05hbWV9XWAsDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIG1zID0gbXMuZmlsdGVyKG0gPT4gbS50ZXN0cy5hY3RpdmUgJiYgbS50ZXN0cy5lbmFibGVkICYmIG0udGVzdHMuY29udGV4dCAmJiBtLnRlc3RzLmNsYXNzICYmIG0udGVzdHMubW9kdWxlICYmIChtLnRlc3RzLnNGaWVsZCB8fCBtLnRlc3RzLnNTY3JpcHQgfHwgbS50ZXN0cy5zUGF0aCkgJiYgbS50ZXN0cy50YXJnZXQpLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCUgLyogd2UgbWlnaHQgbm90IHdvcmsgd2l0aCBhbGwgbXMgZW50cmllcy4gbG9nIGhlcmUgaXMgb25seSBhIHByZXZpZXcgb2Ygd2hhdCBtaWdodCB3b3JrISAqLyAlPg0KICAgICAgICAgICAgLy9pZihtcy5maWx0ZXIobSA9PiBtLmRlYnVnKS5sZW5ndGgpIGxvZyh0aGlzLl9iZWF1dGlmeShtcy5maWx0ZXIobSA9PiBtLmRlYnVnKSwgJ2phdmFzY3JpcHQnKSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiB7DQogICAgICAgICAgICAgICAgaWYobVt0U2NyaXB0XSl7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RDb25kXSk9PT0ndW5kZWZpbmVkJyB8fCA8JXZhbHVlT2YoIm1bdENvbmRdIiwgJ190aGlzJyklPil7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnKSBsb2cobS50ZXN0cy5sb2cgKyAnOiAnICsgdFNjcmlwdCwgJzwlPW1OYW1lJT4nLCBtW3RTY3JpcHRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSA8JXZhbHVlT2YoIm1bdFNjcmlwdF0iLCAnX3RoaXMnKSU+DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0gam1lc3BhdGguc2VhcmNoKG9iakZyb20sIG1bc1BhdGhdKTsNCiAgICAgICAgICAgICAgICBpZihtW3NQYXRoXSAmJiB0eXBlb2YoanNvbnBhdGgpIT09J3VuZGVmaW5lZCcpIGNvZGUgPSBqc29ucGF0aC5xdWVyeShvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0RmllbGRdKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGRQYXRoID0gJyc7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RGaWVsZF0pPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5yZXBsYWNlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAobVtzRmllbGRdLCAnZycpLCBtW3RGaWVsZF0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9jb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGAke2NvZGV9LmNvZGVgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gbVt0RmllbGRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYGRvdGNvcHlgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSBEb3RPYmplY3QuY29weShtW3NGaWVsZF0sIG1bdEZpZWxkXSwgb2JqRnJvbSwgb2JqVG8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnICYmIGRQYXRoKSBsb2coYCR7bS50ZXN0cy5sb2d9LyR7ZFBhdGh9W2NvZGU9JHtjb2RlfV06ICR7bVtzRmllbGRdfSA9PiAke21bdEZpZWxkXX1gKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwgam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0gam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdENvbmRdKSkpIG9ialRvW21bdEZpZWxkXV0gPSBqc29ucGF0aC5xdWVyeShvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiBkZWxldGUgbS50ZXN0cyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gb2JqVG87DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoY29udGV4dD09J0VudGl0eUNsYXNzJyAmJiBjbGFzc05hbWU9PSdVc2VyJykgPCU9d2FybigpJT4iR09UIEhFUkUiLCBjb2RlLCBjb250ZXh0LCBvcHRpb25zKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJhbWV0cml6ZShjb2RlLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19uQ29kZSclPihjb2RlLCBvQ29kZSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgICAgICBpZighY29kZSAmJiAhb0NvZGUpew0KICAgICAgICAgICAgICAgIGNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOw0KICAgICAgICAgICAgICAgIGNvZGUgPSAiPCU9bkNvZGUoYyklPiI7DQogICAgICAgICAgICAgICAgb0NvZGUgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db2RlKSU+Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgcmV0ID0gY29kZTsNCiAgICAgICAgICAgIGlmKG9Db2RlICYmIHR5cGVvZihvQ29kZSk9PT0nb2JqZWN0Jyl7DQogICAgICAgICAgICAgICAgcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IG9Db2RlW3RoaXMuVG9vbC50eXBlLm5hbWVdIHx8IHJldDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21hcChyZXQsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgICAgIHJldHVybiBjb2RlOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfX2NvbmZpZyclPihuLCBudWxsVmFsdWUsIG9wdGlvbnMpew0KICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCiAgICAgICAgb3B0aW9ucy5fdGhpcyA9IG9wdGlvbnMuX3RoaXMgfHwgdGhpczsNCiAgICAgICAgb3B0aW9ucy5fY2xhc3MgPSBvcHRpb25zLl9jbGFzcyB8fCAnPCU9bk5hbWUoYyklPic7DQogICAgICAgIG9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCBvcHRpb25zLl90aGlzLlRvb2wgfHwgdGhpcy5Ub29sOw0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdvYmplY3QnICYmIG9wdGlvbnMudG9vbC5jb25zdHJ1Y3Rvci5uYW1lPT0nVG9vbCcpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wubmFtZSgpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpPT09J3N0cmluZycpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wgfHwgdC50eXBlLm5hbWU9PW9wdGlvbnMudG9vbCk7DQoNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe190aGlzOiB0aGlzLCB0b29sOiB0aGlzLlRvb2wsIF9jbGFzczogJzwlPW5OYW1lKGMpJT4nfSwgb3B0aW9ucyB8fCB7fSkpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCkhPT0nb2JqZWN0JykgPCU9d2FybigpJT5vcHRpb25zLnRvb2wpOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMudG9vbCkgPCU9d2FybigpJT4idG9vbCBub3QgZGVmaW5lZCIsIG9wdGlvbnMuX3RoaXMuVG9vbCwgPCU9c2NvcGUlPi5Ub29scywgb3B0aW9ucy5fdGhpcy5Ub29scyk7DQogICAgICAgICAgICAvL29wdGlvbnMubm9DYWNoZSA9IHRydWU7DQogICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlKSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gPSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gfHwge307DQoNCiAgICAgICAgICAgIGxldCBuSUQgPSA8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCk6J2RlZmF1bHQnOw0KDQogICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9uc1tuXSkhPT0ndW5kZWZpbmVkJykgbnVsbFZhbHVlID0gbnVsbFZhbHVlIHx8IG9wdGlvbnNbbl07DQogICAgICAgICAgICBsZXQgcmV0ID0gbnVsbFZhbHVlOw0KICAgICAgICAgICAgaWYodHlwZW9mKHJldCk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyB1c2Ugc2NvcGUgY2FjaGUgKGltcHJvdmVzIHBlcmZvcm1hbmNlPz8/KQ0KICAgICAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUgJiYgT2JqZWN0Lmhhc093big8JT1zY29wZSU+LjwlPW1OYW1lJT4sIGAke29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWApKSByZXR1cm4gPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyB0b29sX0NvbmZpZ3MsIHR5cGVfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lDQogICAgICAgICAgICBsZXQgdGNvbmYgPSBbXS5jb25jYXQob3B0aW9ucy50b29sLnR5cGUudHlwZV9Db25maWdzIHx8IFtdLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjICYmIGMubmFtZT09biAmJiAoIWMubm9kZSB8fCBjLm5vZGUuY29kZT09bklEKSkuc29ydChjID0+IGMubm9kZT8oYy5ub2RlLmNvZGU9PSdkZWZhdWx0Jz8wOi0xKToxKTsNCiAgICAgICAgICAgIGlmKHRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgaWYodGNvbmZbMF0uc2NyaXB0KXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGNvbmZbMF0uc2NyaXB0Ow0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IF9zYyA9IHRoaXMuX3BhcmFtZXRyaXplKHRjb25mWzBdLnNjcmlwdCwgcCA9PiB0aGlzLjwlPW1OYW1lJT4ocCwgbnVsbCwgb3B0aW9ucykgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoIl9zYyIpJT47DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnZhbHVlOw0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBbMSwyLDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goamV4KXt9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYob3B0aW9ucy5uZXdWYWx1ZSl7DQogICAgICAgICAgICAgICAgbGV0IHRjID0gdGNvbmYubGVuZ3RoP3Rjb25mWzBdOnt9Ow0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubm9kZSkgdGMubm9kZSA9IHtjb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpfTsNCiAgICAgICAgICAgICAgICB0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICAgICAgdGMubmFtZSA9IG47DQogICAgICAgICAgICAgICAgaWYoIXRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncykucHVzaCh0Yyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldCA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcNCiAgICAgICAgICAgIGxldCBtY29uZiA9IG9wdGlvbnMuX3RoaXMuQ29uZmlnP29wdGlvbnMuX3RoaXMuQ29uZmlnW25dOnVuZGVmaW5lZDsNCiAgICAgICAgICAgIG1jb25mID0gdGhpcy5fcGFyYW1ldHJpemUobWNvbmYsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIG1jb25mID0gPCV2YWx1ZU9mKCJtY29uZiIpJT47DQogICAgICAgICAgICBpZih0eXBlb2YobWNvbmYpIT09InVuZGVmaW5lZCIpIHJldCA9IG1jb25mOw0KDQogICAgICAgICAgICAvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3Qpew0KICAgICAgICAgICAgICAgIHJldCA9IERvdE9iamVjdC5waWNrKG4sIGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpKSB8fCByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodGhpcy4kX1JFUVVFU1QpIHJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gY29uZmlnIHJlcGxhY2VtZW50DQogICAgICAgICAgICByZXQgPSB0aGlzLl9wYXJhbWV0cml6ZShyZXQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdID0gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoInJldCIpJT47DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPm4sIG51bGxWYWx1ZSwgb3B0aW9ucy5fY2xhc3MsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQoNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgLyoqDQogICAgICogU3VtbWFyeS4gPCU9bS5OYW1lJT4uDQogICAgICoNCiAgICAgKiBEZXNjcmlwdGlvbi4gPCU9bS5SZW1hcmslPi4NCiAgICAgKg0KICAgICAqIEBzaW5jZSAgICAgIHgueC54DQogICAgICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4NCiAgICAgKiBAYWNjZXNzICAgICBwdWJsaWMNCiAgICAgKg0KICAgICAqIEBjbGFzcw0KICAgICAqIEBhdWdtZW50cyBwYXJlbnQNCiAgICAgKiBAbWl4ZXMgICAgbWl4aW4NCiAgICAgKg0KICAgICAqIEBhbGlhcyAgICByZWFsTmFtZQ0KICAgICAqIEBtZW1iZXJvZiBuYW1lc3BhY2UNCiAgICAgKg0KICAgICAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbg0KICAgICAqIEBsaW5rIFVSTA0KICAgICAqIEBnbG9iYWwNCiAgICAgKg0KICAgICAqIEBmaXJlcyAgIGV2ZW50TmFtZQ0KICAgICAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLg0KICAgICAqDQogICAgICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqDQogICAgICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqLw0KICAgIDwlIGlmKCFtLklzU3luYyl7JT5hc3luYyA8JX0lPjwlPW1OYW1lPW5Db2RlKG0pJT4oPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IHAuTmFtZSkuam9pbignLCAnKSU+KXsNCg0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAwLCAuLi5tc2cpOw0KICAgIAlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JT1uQ29kZShtKSU+IiwgbnVsbCwgMSwgLi4ubXNnKTsNCiAgICAJbGV0IGVycm9yID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAgICAgDQogICAgDQo8JSBpZighbS5Jc1N5bmMpeyU+DQogICAgPCUgaWYoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbnVsbDsNCiAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSwgdHJ1ZSklPigpOw0KICAgIDwlIH1lbHNlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNCb29sKXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IGZhbHNlOw0KICAgIDwlIH1lbHNlIGlmKG0uSXNBcnJheSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBbXTsNCiAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IG51bGw7DQogICAgPCUgfSAlPg0KICAgIA0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bkNvZGUobSklPiIsIDwlbVJvdXRpbmcoYywgbSklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICANCjwlIH0lPg0KPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRGVmYXVsdCkuZm9yRWFjaChwID0+IHslPg0KICAgICAgICBpZih0eXBlb2YoPCU9bk5hbWUocCklPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT1uTmFtZShwKSU+ID0gPCV2YWx1ZU9mKHAuRGVmYXVsdCklPjsNCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIHZhciBlcnJvcnMgPSB7DQogICAgICAgIDwlICBbXS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuUmVxdWlyZWQpLm1hcChwID0+ICh7DQogICAgICAgICAgICAgICAgQ29kZTogYCR7bk5hbWUocCl9LXJlcXVpcmVkYCwNCiAgICAgICAgICAgICAgICBFcnJvcjogYCR7bk5hbWUocCl9IGlzIGEgcmVxdWlyZWQgUGFyYW1ldGVyYCwNCiAgICAgICAgICAgICAgICBTY3JpcHQ6IGB0eXBlb2YoJHtuTmFtZShwKX0pPT09J3VuZGVmaW5lZCdgLA0KICAgICAgICAgICAgfSkpKS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSkubWFwKHAgPT4gKHsNCiAgICAgICAgICAgICAgICBDb2RlOiBgJHtuTmFtZShwKX1gLA0KICAgICAgICAgICAgICAgIEVycm9yOiBgJHtuTmFtZShwKX0gaXMgbm90IG9mIHR5cGUgJHtuTmFtZShwLkVudGl0eVR5cGUpfWAsDQogICAgICAgICAgICAgICAgU2NyaXB0OiBgKCEke25OYW1lKHApfSAmJiAke3AuUmVxdWlyZWQ/J3RydWUnOidmYWxzZSd9KSB8fCAoJHtuTmFtZShwKX0gJiYgKCR7bk5hbWUocCl9LmNvbnN0cnVjdG9yLm5hbWUhPScke25OYW1lKHAuRW50aXR5VHlwZSl9JyB8fCAke25OYW1lKHApfS5FbnRpdHlDbGFzcy5OYW1lIT0nJHtuTmFtZShwLkVudGl0eVR5cGUpfScpKWAsDQogICAgICAgICAgICB9KSkpLmNvbmNhdChtLlZhbGlkYXRvcnMgfHwgW10pLmZpbHRlcih2ID0+ICF2Lklnbm9yZSkuZm9yRWFjaCh2ID0+IHsgJT4NCiAgICAgICAgICAgICI8JT12LkNvZGUlPiI6ICgoPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IHAuTmFtZSkuam9pbignLCAnKSU+KSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KDQogICAgICAgICAgICAgICAgPCUgaWYodi5TY3JpcHQuaW5kZXhPZigncmV0dXJuICcpPDApeyU+DQogICAgICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSANCiAgICAgICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgICAgICAgICA8JT12LlNjcmlwdCU+DQogICAgICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPiJhbnN3ZXIiLCAiPCU9di5Db2RlJT4iLCBhbnN3ZXIpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5zd2VyOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+InZhbGlkYXRvciIsICI8JT12LkNvZGUlPiIsIGV4KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSg8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lKS5qb2luKCcsICcpJT4pPygnPCU9di5FcnJvciU+JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpOicnLA0KICAgICAgICA8JSB9KSAlPg0KICAgICAgICB9Ow0KICAgICAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsNCiAgICAgICAgaWYoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpew0KICAgICAgICAgICAgT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+e1trXTogZXJyb3JzW2tdfSk7DQogICAgICAgICAgICAgICAgZGVsZXRlIGVycm9yc1trXTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICAgICAgX19leGNlcHRpb246IGVycm9ycywNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bS5TY3JpcHQlPg0KICAgICAgICANCjwlIGlmKCFtLklzU3luYyl7JT4NCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBwLk5hbWUgKyAiOiAiICsgcC5OYW1lKS5qb2luKCcsICcpJT59KTsNCiAgICAgICAgDQogICAgICAgIA0KICAgICAgICAvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMNCiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7DQoNCiAgICAgICAgLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPw0KICAgICAgICBsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsNCiAgICAgICAgaWYoX19leCkgcmV0dXJuIF9fZXgucmV0Ow0KDQogICAgICAgIDwlPW0uUmVkdWNlJT4NCg0KICAgICAgICA8JSBpZihtLklzQXJyYXkgfHwgbS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5KXslPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAociA9PiByLnJldCkuZmxhdCgpOw0KICAgICAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aD9yZXN1bHRzWzBdLnJldDpudWxsOw0KICAgICAgICA8JSB9JT4NCjwlIH0lPg0KICAgIH0NCjwlIH0pOyU+DQoNCjwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX3Jlc3BvbnNlSW50ZXJjZXB0b3InJT4oZXJyb3IsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGVycm9yLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSBlcnJvci5jb25maWc7DQogICAgICAgICAgICBpZiAodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSAmJiBlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSk+MCkgew0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOw0KICAgICAgICAgICAgICAgIC8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190eXBlIiwgIkJlYXJlciIsIHt0b29sOiB0fSkgKyAiICIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgICAgIHJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIDwlPWxvZygpJT5jb25maWcpOw0KICAgICAgICByZXR1cm4gY29uZmlnOw0KICAgIDwlIH0lPg0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfcmVxdWVzdEludGVyY2VwdG9yJyU+KGNvbmZpZywgdCl7DQogICAgPCUgaWYobWFpbkNsYXNzKF9yZXN0VG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcyhfcmVzdFRvb2xzKSklPigpLjwlPW1OYW1lJT4oY29uZmlnLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge2hlYWRlcnM6IHt9fTsNCiAgICAgICAgICAgIGNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307DQogICAgICAgICAgICBjb25maWcubWV0YS5jb3VudGVyID0gNDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRva2VuVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW4udXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVHlwZSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IHRva2VuID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuLiIrY29uZmlnLm1ldGhvZCwgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlfSksIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgaWYoIWNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gJiYgW3Rva2VuVXJpLCByZWZyZXNoVXJpLCBhdXRoVXJpXS5pbmRleE9mKGNvbmZpZy51cmwpPDApew0KICAgICAgICAgICAgICAgIGlmKCF0b2tlbil7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoQ29kZSA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5jb2RlJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGF1dGhNZXRob2QgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUubWV0aG9kJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKCF0b2tlblVyaSAmJiAhYXV0aENvZGUgJiYgIWF1dGhNZXRob2QgJiYgdGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVHlwZSA9ICdCYXNpYyc7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSArICI6IiArIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJykpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KPCVpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSJnZXQiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBvciBsb2FkIGEgbmV3IG9hdXRoIHN0YXRlDQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUuc3RhdGUiLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHt0b29sOiB0Lm5hbWUsIG5jb2RlOiA8JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCl9KSl9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF1dGhvcml6ZSBhbmQgZ2V0IHRoZSBhdXRoIGNvZGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHthdXRoVXJpfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4oYXV0aFVyaSk7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNldEludGVydmFsKG51bGwsIHRvb2wgPT4gPCU9bnNjb3BlJT4uX25vZGUgJiYgY29uZmlnLm1ldGEuY291bnRlci0tICYmICEoYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSkpLCAwLjEsIHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBEb25lIExvb3Bpbmc6ICR7YXV0aENvZGV9YCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZighYXV0aENvZGUpIGF1dGhNZXRob2Q9dW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICB9DQo8JX0lPg0KDQogICAgICAgICAgICAgICAgICAgIGlmKGF1dGhNZXRob2Qpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZsb3cgPSAoIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSdwb3N0Jyk/J2F1dGhvcml6ZSc6J3Rva2VuJzsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgdG9rZW4NCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB0b2tlblVyaSBtaWdodCBoYXZlIGEgZGVwZW5kZW5jeSBvbiB0aGUgYXV0aG9yaXphdGlvbiBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30udXJpYCwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0Y29uZmlnID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdG9rZW5VcmksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0Jywge3Rvb2w6IHR9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uY29udGVudF90eXBlYCwgInRleHQvanNvbiIsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBdXRob3JpemF0aW9uIjogIkJhc2ljICIrdGhpcy5fYnRvYSh0aGlzLl9fY29uZmlnKCJvYXV0aC5sb2dpbiIsIG51bGwsIHt0b29sOiB0fSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uYm9keWAsIG51bGwsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBUb2tlbiBmZXRjaGVkIC0gJHtmbG93fWAsIHRjb25maWcsIHRyZXMuZGF0YSk7DQogICAgICAgICAgICAgICAgICAgICAgICBbJ2FjY2Vzc190b2tlbicsICd0b2tlbl90eXBlJywgJ2V4cGlyZXNfaW4nLCAncmVmcmVzaF90b2tlbiddLmZvckVhY2godGEgPT4gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHt0YX1gLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwge3Rvb2w6IHR9KV19KSk7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBhdXRoVHlwZSArICIgIiArIHRva2VuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3Jlc3QnJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKXsNCiAgICAgICAgLyogdE5hbWUgbm8gbG9uZ2VyIHJlcXVpcmVkISEgKi8NCiAgICAgICAgdE5hbWUgPSB0TmFtZSB8fCA8JT1fbkNvZGUoKSU+Ow0KICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7X3RoaXM6IHRoaXN9Ow0KICAgICAgICBvcHRpb25zLnROYW1lID0gb3B0aW9ucy50TmFtZSB8fCB0TmFtZTsNCiAgICAgICAgDQogICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsNCiAgICAgICAgbWV0aG9kID0gbWV0aG9kIHx8IChkYXRhPyJwb3N0IjoiZ2V0Iik7DQogICAgICAgIA0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oLypudWxsLCB0aGlzLlRvb2wqLykuPCU9bU5hbWUlPih0TmFtZSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuZm9ybSl7DQogICAgICAgICAgICAgICAgbGV0IGZkID0gbmV3IEZvcm1EYXRhKCk7DQogICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChrID0+IGZkLmFwcGVuZChrLCBkYXRhW2tdKSk7DQogICAgICAgICAgICAgICAgZGF0YSA9IGZkOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgYHJlc3RhcGkudXJsLiR7bWV0aG9kfWAsIHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgJ3Jlc3RhcGkudXJsJywgb3B0aW9ucy5wYXRoICsgb3B0aW9ucy5maWxlLCBvcHRpb25zKSwgb3B0aW9ucyksDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsDQogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMuJyttZXRob2QsIHRoaXMuX19jb25maWcoJ3Jlc3RhcGkuaGVhZGVycycsIHt9LCBvcHRpb25zKSwgb3B0aW9ucyksIG9wdGlvbnMuaGVhZGVycyB8fCB7fSksDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICB2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1czw0MDAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICA8JT1sb2coKSU+YFtMSVZFOiR7dGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpfV1gLCBjb25maWcpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzLlRvb2wuYXhpb3MpIT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKGF4aW9zKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gKGF3YWl0ICgodGhpcy5Ub29sLmF4aW9zIHx8IGF4aW9zKSkoY29uZmlnKSkuZGF0YTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgKGF3YWl0IGZldGNoKGNvbmZpZy51cmwsIGNvbmZpZykpLmpzb24oKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iYXhpb3Mgbm90IGRlZmluZWQhLCB1c2luZyBmZXRjaCIsIHJldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCU9bG9nKCklPkpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCkpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0gLy8gbWFpbkNsYXNzKF9yZXN0VG9vbHMpICU+DQoNCjwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpKXslPg0KICAgIDwlPW1OYW1lPSdfdG9TUUxUYWJsZSclPihvcHRpb25zPXt9KXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiAiPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPiIsIGRlcHM6IHt9LCBzcWw6IGBgLCBmaWVsZHM6IGBgfSwgew0KICAgICAgICAgICAgLy9fbWFwOiB0cnVlLA0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICBfX2hlYWRlcjogb2JqID0+IG9iai5zcWwgPSBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSAoJHtvYmouZmllbGRzfS8qPCU9bk5hbWUoYyklPiovKTtcbmAsDQogICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2Lm9iaiA9ICh0eXBlb2Yob3B0aW9ucy5yZXVzZWQpPT09J3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZXVzZWQ+PXYucmV1c2VkKT92Lm9iajp7c3FsOiB2Lm9iai5zcWwgKz0gYC8qPCU9bk5hbWUoYyklPjogcmV1c2VkOiAke3YucmV1c2VkfSovXG5cbmAsIElkOiB2Lm9iai5JZH0sDQogICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCI8JT1fRnJFTUQuX2F0dHIoZWEpJT4iLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWAsDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPiA9ICh2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgICAgICAgICAgb2JqLmZpZWxkcyArPSBgLCR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouZGVwcy48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiA9ICh2ICYmIHYubGVuZ3RoKT92WzBdOm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJldC5kZXBzIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0LmRlcHNba10pPT09J3N0cmluZycpLm1hcChrID0+IHJldC5kZXBzW2tdKS5qb2luKCdcblxuJykgKyByZXQuc3FsOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21TUUxUYWJsZSclPih0YWJsZSwgZmllbGRzKXsNCiAgICAgICAgLy8gdGFibGUgaXMgYSBqc29uIGFycmF5DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICBpZigoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCI8JT1uTmFtZShlYSklPiIpKSB8fCAhZmllbGRzKXsNCiAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4odGFibGVbIjwlPW5Db2RlKGVhKSU+Il0pOw0KICAgICAgICB9DQo8JSB9KTsgJT4NCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfc3FsJyU+KHNxbCwgX3RoaXMpew0KICAgICAgICBfdGhpcyA9IF90aGlzIHx8IHRoaXM7DQogICAgPCUgaWYobWFpbkNsYXNzKF9zcWxUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoX3NxbFRvb2xzKSklPigpLjwlPW1OYW1lJT4oc3FsLCBfdGhpcyk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgaWYoIXRoaXMuVG9vbC5kYiB8fCAhc3FsIHx8ICFzcWwudHJpbSgpKXsNCiAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIpIDwlPWxvZygpJT5zcWwsICIgPD09U0tJUFBFRD09PiIpOw0KICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZihzcWwuaW5kZXhPZignO1xuJyk+MCl7DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHNxbFMgb2Ygc3FsLnNwbGl0KCc7XG4nKSl7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy48JT1tTmFtZSU+KHNxbFMudHJpbSgpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQoNCiAgICAgICAgaWYoKHNxbC5tYXRjaCgvXCgvZykgfHwgW10pLmxlbmd0aCE9KHNxbC5tYXRjaCgvXCkvZykgfHwgW10pLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+ImluY29ycmVjdCBzcWwiLCBzcWwpOw0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IF9vayA9IChfcmV0LCBfc3FsKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKF9zcWwgJiYgX3NxbC5pbmRleE9mKCdzZWxlY3QnKSkgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKF9zcWwpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShfcmV0KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgZGIgPSB0aGlzLlRvb2wuZGI7DQogICAgICAgICAgICAgICAgbGV0IHR5cGUgPSB0aGlzLl9fY29uZmlnKCd0eXBlJyk7DQogICAgDQogICAgICAgICAgICAgICAgbGV0IGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIC8vIFF1ZXJ5IGxpc3Qgb2Ygc3RhdGVtZW50IHN0YXJ0aW5nIGtleXdvcmRzICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgcUxpc3QgPSBbInNlbGVjdCIsICJpbnNlcnQiLCAidXBkYXRlIiwgImRlbGV0ZSJdOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlLnRyYW5zYWN0aW9ucycsIHRydWUpKXsNCiAgICAgICAgICAgICAgICAgICAgcUxpc3QgPSBxTGlzdC5jb25jYXQoWyJiZWdpbiIsICJzdGFydCIsICJjb21taXQiXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGxldCBiUXVlcnkgPSBxTGlzdC5pbmRleE9mKHNxbC5zdWJzdHJpbmcoMCwgc3FsLmluZGV4T2YoJyAnKSkudHJpbSgpLnRvTG93ZXJDYXNlKCkpPj0wOw0KDQogICAgICAgICAgICAgICAgaWYoYlF1ZXJ5KXsNCiAgICAgICAgICAgICAgICAgICAgLy8gcXVlcnkNCiAgICAgICAgICAgICAgICAgICAgaWYoWydteXNxbCcsICdwb3N0Z3JlcyddLmluZGV4T2YodHlwZSk+PTApIGZ1biA9ICdxdWVyeSc7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGU9PSdzcWxpdGUnKSBmdW4gPSAnYWxsJzsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgLy8gRE1MDQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ3J1bic7DQoNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlID0gdGhpcy5Ub29sLmRtbENhY2hlIHx8IHt9Ow0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShzcWwpXSkgcmV0dXJuIF9vaygwKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0gPSBzcWw7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKHR5cGU9PSdzcWxpdGUnICYmIHR5cGVvZih3aW5kb3cpIT09J3VuZGVmaW5lZCcpIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIGlmKGZ1biAmJiAhZGJbZnVuXSkgZnVuID0gIiI7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikhPT0ndW5kZWZpbmVkJz9zcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCk6c3FsOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHt0eXBlfS4ke2Z1bn1gLCBzcWwpOw0KICAgICAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbikgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLnNxbHMucHVzaChzcWwpOw0KDQogICAgICAgICAgICAgICAgaWYgKGZ1bikgew0KICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGU9PSJwb3N0Z3JlcyIpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGJbZnVuXShzcWwpLnRoZW4ocm93cyA9PiBfb2socm93cywgc3FsKSkuY2F0Y2gocmV0RXggPT4gcmVqZWN0KHJldEV4KSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGJbZnVuXShzcWwsIFtdLCAoZXJyb3IsIHJvd3MpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihlcnJvcil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vayhyb3dzLCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlPT0nc25vd2ZsYWtlJykgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLlRvb2wuZGIuZXhlY3V0ZSh7DQogICAgICAgICAgICAgICAgICAgICAgICBzcWxUZXh0OiBzcWwsDQogICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZTogZnVuY3Rpb24oZXJyLCBzdG10LCByb3dzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vayhyb3dzLCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlPT0nc3FsaXRlJykgew0KICAgICAgICAgICAgICAgICAgICAvLyBzcWxpdGUgaW4gdGhlIGJyb3dzZXINCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IG51bGw7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBkYi5leGVjKHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZighcmV0IHx8ICFyZXQubGVuZ3RoKSByZXR1cm4gX29rKHJldCwgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gcmV0WzBdLnZhbHVlcy5tYXAociA9PiBPYmplY3QuZnJvbUVudHJpZXMobmV3IE1hcChyZXRbMF0uY29sdW1ucy5tYXAoKGMsIGkpID0+IFtjLCByW2ldXSkpKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXgpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmKHR5cGU9PSdxdWVzdGRiJyl7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3QobnVsbCwge3F1ZXJ5OiBzcWx9KS50aGVuKHIgPT4gX29rKHIsIHNxbCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+YA0KRVJST1I6DQoke2V4fQ0KDQpXaGlsZSBTZW5kaW5nIFF1ZXJ5IA0KJHtzcWx9DQpgKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmKHJldCAmJiByZXQucm93cykgcmV0ID0gcmV0LnJvd3M7ICAgICAgICANCiAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXQubWFwKHIgPT4gRG90T2JqZWN0Lm9iamVjdChyKSk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0FpclRhYmxlJ10pKXslPg0KPCUNCmxldCBfdG9UeXBlQVQgPSBlYSA9PiB7DQogICAgbGV0IHJldCA9IHtuYW1lOiBuTmFtZShlYSksIGRlc2NyaXB0aW9uOiBlYS5OYW1lLCB0eXBlOiAic2luZ2xlTGluZVRleHQifTsNCiAgICBpZihlYS5Jc0Jvb2wpew0KICAgICAgICByZXQudHlwZSA9ICJjaGVja2JveCI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgY29sb3I6ICJncmVlbkJyaWdodCIsDQogICAgICAgICAgICBpY29uOiAiY2hlY2siDQogICAgICAgIH07DQogICAgfQ0KICAgIGlmKGVhLklzRGF0ZSl7DQogICAgICAgIHJldC50eXBlID0gImRhdGVUaW1lIjsNCiAgICAgICAgcmV0Lm9wdGlvbnMgPSB7DQogICAgICAgICAgICBkYXRlRm9ybWF0OiB7DQogICAgICAgICAgICAgICAgbmFtZTogJ2lzbycNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICB0aW1lRm9ybWF0OiB7DQogICAgICAgICAgICAgICAgbmFtZTogJzI0aG91cicsDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZVpvbmU6ICd1dGMnLA0KICAgICAgICB9Ow0KICAgIH0NCiAgICANCiAgICByZXR1cm4gcmV0Ow0KfTsNCiU+DQogICAgPCU9bU5hbWU9J190b0FUVGFibGUnJT4obGV2ZWwpew0KICAgICAgICBsZXQgcmV0ID0gW3sNCiAgICAgICAgICAgIG5hbWU6ICc8JT1uTmFtZShjKSU+JywNCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJywNCiAgICAgICAgICAgIGZpZWxkczogWw0KICAgICAgICAgICAgICAgIHtuYW1lOiB0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyksIGRlc2NyaXB0aW9uOiAnSUQnLCB0eXBlOiAnc2luZ2xlTGluZVRleHQnfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+PCU9X0ZyRU1ELl90b0pTKF90b1R5cGVBVChlYSkpJT4sPCUgfSklPl0sDQogICAgICAgIH1dOw0KDQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gcmV0LnB1c2gobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0LnNxbCk7DQogICAgICAgIHJldHVybiByZXQuc3FsOw0KDQogICAgICAgIHJldCA9IHJldC5maWx0ZXIoKHRhZywgaW5kZXgsIGFycmF5KSA9PiBhcnJheS5maW5kSW5kZXgodCA9PiB0Lm5hbWUgPT0gdGFnLm5hbWUpID09IGluZGV4KTsNCiAgICAgICAgPCU9bG9nKCklPnJldCwgbGV2ZWwpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvQVRGdW5jdGlvbiclPigpew0KICAgICAgICBsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfS5gOw0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7ZnVuOiAiIn0sIHsNCiAgICAgICAgICAgIF9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpP1snSWQnXTp1bmRlZmluZWQsDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4odC5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIiwNCiAgICAgICAgICAgIElkOiBvYmogPT4gb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJOT1QgSU4iOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICIiOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJJTiI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2LjwlPW1OYW1lJT4odi5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpKX0pYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAoJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQgfHwgZWEuSXNJbWFnZSB8fCBlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArIDwlaWYoZWEuSXNCb29sKXslPiI9IjwlfWVsc2V7JT4odGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCB8fCAiTElLRSIpPCV9JT4gKyAiICI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYudG9JU09TdHJpbmcpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyAodj8iMSI6IjAiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiBhbmQgLyo8JT10YU5hbWUlPiovICI7DQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9Jyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIk5PVCBFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9Jyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIkVYSVNUUyI7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCAiSU4ifWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiAoIiArICh2IHx8IFtdKS5tYXAodCA9PiAodCAmJiB0LjwlPW1OYW1lJT4pP3QuPCU9bU5hbWUlPigiPCU9bk5hbWUodGEpJT4uaWQiKToodCB8fCAnTlVMTCcpKS5qb2luKCcgVU5JT04gQUxMLypNMk0qLyAnKSArICIpIjsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfYWlydGFibGUnJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0FpclRhYmxlJ10pKSU+KCkuPCU9bU5hbWUlPih0TmFtZSwgcGFyYW1zLCBkYXRhLCBtZXRob2QpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgICAgIGxldCByZXQgPSAoYXdhaXQgYXhpb3MucmVxdWVzdCh7DQogICAgICAgICAgICAgICAgdXJsOiBgJHt0aGlzLl9fY29uZmlnKCdlbmRwb2ludFVybCcpfSR7dE5hbWV9YCwNCiAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZD9tZXRob2Q6KGRhdGE/InBvc3QiOiJnZXQiKSwNCiAgICAgICAgICAgICAgICBwYXJhbXM6IHsNCiAgICAgICAgICAgICAgICAgICAgZmlsdGVyQnlGb3JtdWxhOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLA0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQtdHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgfSkpLmRhdGE7DQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5KU09OLnN0cmluZ2lmeShleC5yZXNwb25zZS5kYXRhLCBudWxsLCA0KSk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2ZpbGVzeXN0ZW0nJT4oZmlsZSwgY29udGVudCwgb2JqPXRoaXMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZmlsZSwgY29udGVudCwgb2JqKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighZmlsZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIGxldCBwYXRoID0gb2JqLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJz8nLi9kYi8nOidodHRwczovL3t7b3duZXJ9fS5naXRodWIuaW8vJykpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAvLyB3cml0ZQ0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKChwYXRoICsgZmlsZSkucmVwbGFjZSgvKC4qXC8pLiovZywgJyQxJyksIHsgcmVjdXJzaXZlOiB0cnVlIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmMocGF0aCArIGZpbGUsIHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnPy8qdGhpcy5fYnRvYSgqL0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpLyopKi86Y29udGVudCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihmaWxlLmVuZHNXaXRoKCcvJykpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJzaW11bGF0ZWQgZGlyZWN0b3J5IGxpc3RpbmcuLi4uIiwgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IFsiRU1TIFdlYiJdOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyByZWFkDQogICAgICAgICAgICAgICAgICAgIGlmKHBhdGguc3RhcnRzV2l0aCgnaHR0cCcpICYmIHBhdGguaW5kZXhPZignOi8vJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgbnVsbCwgbnVsbCwge3VybDogJ3BhdGgucmVhZCcsIGZpbGUsIHBhdGh9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuZnMuZXhpc3RzU3luYyhwYXRoICsgZmlsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyhwYXRoICsgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD8ocmV0LmRhdGEgfHwgcmV0KTpyZXQ7DQogICAgICAgICAgICA8JT1sb2coKSU+YFske29iai5fX2NvbmZpZygnbGl2ZScsIHRydWUpPycnOidOT1QgJ31MSVZFfCR7dHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCc/J3dyaXRlJzoncmVhZCd9XSR7cGF0aCArIGZpbGV9OiAkeyhyZXQgfHwgJycpLmxlbmd0aH1gKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKF9maWxlVG9vbHMpKXslPg0KICAgIDwlPW1OYW1lPSdfZmlsZU5hbWUnJT4oX2NsYXNzPTwlPV9uQ29kZSgpJT4sIG9iaj10aGlzLCBhbGlhcz0iPCU9YWxpYXMoKSU+Iil7DQogICAgPCUgaWYobWFpbkNsYXNzKF9maWxlVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9maWxlVG9vbHMpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihfY2xhc3MsIG9iaiwgYWxpYXM9IjwlPWFsaWFzKCklPiIpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIDwlPWxvZygpJT5vYmouX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub09wZXJhdG9yczogdHJ1ZX0sICc8JT1tTmFtZSU+JykuX3RoaXMpOw0KDQogICAgICAgICAgICBsZXQgZk5hbWUgPSBPYmplY3QudmFsdWVzKG9iai5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vT3BlcmF0b3JzOiB0cnVlfSwgJzwlPW1OYW1lJT4nKS5fdGhpcykuam9pbignX18nKTsNCiAgICAgICAgICAgIGlmKGZOYW1lKSBmTmFtZSs9Jy5qc29uJzsNCiAgICAgICAgICAgIHJldHVybiAob2JqLl9fY29uZmlnKCdzdG9yZS5yb290JywgJzwlPXNjb3BlJT4vJykgKyBgJHthbGlhcy5zcGxpdCgnLicpLnNsaWNlKDEpLmpvaW4oJy8nKX0vJHtfY2xhc3N9LyR7Zk5hbWV9YCkucmVwbGFjZSgvXC9cLy9nLCAnLycpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2dpdGh1YiclPihmaWxlLCBjb250ZW50LCBpZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnR2l0SHViJ10pIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnR2l0SHViJ10pKSU+KG51bGwsIHRoaXMuVG9vbCkuPCU9bU5hbWUlPihmaWxlLCBjb250ZW50LCBpZCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIWZpbGUpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2hhMSA9IGFzeW5jIHN0ciA9PiB0eXBlb2YoY3J5cHRvLnN1YnRsZSkhPT0ndW5kZWZpbmVkJz9BcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCdTSEEtMScsIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgnYmxvYiAnICsgbmV3IEJsb2IoW3N0cl0pLnNpemUgKyAnXHgwMCcgKyBzdHIpKSkpLm1hcCh2ID0+IHYudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJykpLmpvaW4oJycpOnN0ci5zdWJzdHJpbmcoMCwgMTApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdCh1bmRlZmluZWQsIG51bGwsIGNvbnRlbnQ/SlNPTi5zdHJpbmdpZnkoew0KICAgIAkJCW1lc3NhZ2U6ICJkZXBsb3llZCBieSA8JT1tTmFtZSU+KCkiLA0KICAgIAkJCXNoYTogaWQgfHwgY29udGVudFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLA0KICAgIAkJCWNvbnRlbnQ6IHRoaXMuX2J0b2EodHlwZW9mKGNvbnRlbnQpPT09J29iamVjdCc/SlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgJ1x0Jyk6Y29udGVudCksDQogICAgCQl9KTpudWxsLCBjb250ZW50PydwdXQnOm51bGwsIHsNCiAgICAJCSAgICBmaWxlLA0KICAgIAkJfSk7DQogICAgCQkNCiAgICAJCWlmKCFyZXQpIHJldHVybiByZXQ7DQogICAgCQkNCiAgICAJCXJldCA9IGNvbnRlbnQ/cmV0LmNvbnRlbnQ6cmV0Ow0KICAgIAkJaWYoZmlsZS5pbmRleE9mKCdpbmRleC5tZCcpPj0wKSByZXR1cm4gcmV0Ow0KICAgIAkJDQogICAgCQlpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgIAkJICAgIC8vIGluIGNhc2Ugd2UgYXJlIGxpc3RpbmcgdGhlIGNvbnRlbnRzIG9mIGEgZm9sZGVyIHJlc291cmNlDQogICAgCQkgICAgcmV0dXJuIHJldC5tYXAociA9PiByLm5hbWUucmVwbGFjZSgnLmpzb24nLCAnJykpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgCQlsZXQgX3RoaXMgPSB7fTsNCiAgICAJCWlmKHJldC5zaGEpew0KICAgIAkJICAgIF90aGlzID0gcmV0LmNvbnRlbnQ/SlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSk6e307DQogICAgCQkgICAgX3RoaXNbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSA9IHJldC5zaGE7IC8vPz8NCiAgICAJCX1lbHNlIGlmKHJldFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldKXsNCiAgICAJCSAgICAvLzwlPXdhcm4oKSU+J3NoYTEnLCBmaWxlLCBhd2FpdCBzaGExKEpTT04uc3RyaW5naWZ5KHJldCkpKTsNCiAgICAJCSAgICBfdGhpcyA9IHJldDsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJPCU9bG9nKCklPmZpbGUsIGNvbnRlbnQ/J3B1dCc6J2dldCcsIF90aGlzKTsNCiAgICAgICAgICAgIHJldHVybiBfdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydTYWxlc0ZvcmNlJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9TRlF1ZXJ5JyU+KGZpZWxkcywgb2JqcywgYlN0cmluZyl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtbPCU9X25Db2RlKCklPl06IHtwYXJhbXM6IHt3aGVyZToge2FuZDogW10sIG9yOiBbXX19LCBlZGdlczoge25vZGU6IHt9fX19LCB7DQogICAgICAgICAgICAvL09QRVJBVE9SUzogdHJ1ZSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9ials8JT1fbkNvZGUoKSU+XS5wYXJhbXMud2hlcmUuYW5kLnB1c2goe0lkOiB7ZXE6IHZ9fSksDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgb3AgPSAnZXEnOw0KICAgICAgICAgICAgICAgIGxldCBjb25kID0ge1tlYUNvZGVdOiB7W29wXTogDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlucTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFwaU5hbWU6ICdJZCcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgWzwlPV9uQ29kZShlYS5FbnRpdHlUeXBlKSU+XTogdj92LjwlPW1OYW1lJT4oKVs8JT1fbkNvZGUoZWEuRW50aXR5VHlwZSklPl0ucGFyYW1zLndoZXJlLmFuZDpbXSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICAodj92LnRvSVNPU3RyaW5nKCk6bnVsbCkNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgdg0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9fTsNCiAgICAgICAgICAgICAgICBvYmpbPCU9X25Db2RlKCklPl0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgDQogICAgICAgIC8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7DQogICAgICAgIA0KICAgICAgICBpZihiU3RyaW5nKXsNCiAgICAgICAgICAgIHJldCA9IHtxdWVyeToge1s8JT1fbkNvZGUoKSU+ICsgJ1F1ZXJ5J106IHt1aWFwaToge3F1ZXJ5OiByZXR9fX19Ow0KICAgICAgICAgICAgcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydTZXJ2aWNlTm93J10pKXslPg0KICAgIDwlDQogICAgbGV0IF9pZCA9IHMgPT4gLypzP3M6Ki9gdGhpcy5fdXVpZCgke3N8fHVuZGVmaW5lZH0pLnJlcGxhY2UoLy0vZywgJycpYDsNCiAgICBsZXQgX3RpZCA9IF9jID0+IF9pZCgiJyIrc2NvcGUrIi4iKyAoX2MgfHwgYykuTmFtZSArICInIik7DQogICAgbGV0IGFwcCA9ICgpID0+IHslPmFwcGxpY2F0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQXBwbGljYXRpb24nLCB0cnVlKSU+KCkuY29kZSh0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+JykpKTwlfTsNCiAgICANCiAgICBsZXQgbGFiZWwgPSAodCwgbiwgYywgcCkgPT4ge249c3IuRW5nbGlzaE5hbWUobik7ICU+LjwlPXQlPl9GaWVsZF9MYWJlbHMoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmllbGQgTGFiZWwnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLnJlbWFyaygnPCU9biU+JykubmFtZSgnPCU9biU+JykuY29kZSg8JT1jJT4pLmxhbmd1YWdlKCdlbicpLnBsdXJhbCgnPCU9KHAgfHwgKG4gKyAncycpKSU+JykuPCVhcHAoKSU+XSk8JX07JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9TTlRhYmxlJyU+KCl7DQogICAgICAgIC8vdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICB0cnl7DQogICAgPCUgaWYoX2NOYW1lKCdBcHBsaWNhdGlvbicpKXslPg0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUYWJsZScsIHRydWUpJT4oPCU9X3RpZCgpJT4pLmNvZGUoPCU9X25Db2RlKCklPikuPCVhcHAoKSU+Lm5hbWUoJzwlPWMuTmFtZSU+JykucmVtYXJrKGA8JT1jLlJlbWFyayU+YCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSksIHsNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnRhYmxlX0NvbHVtbnMobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdDb2x1bW4nLCB0cnVlKSU+KDwlPV9pZCgiJyIrc2NvcGUrIi4iK2MuTmFtZSsiJytlYUNvZGUiKSU+KS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+IikuY29kZShlYUNvZGUpLnR5cGUoJzwlPV9GckVNRC5fYXR0cihlYSklPicpLnJlZmVyZW5jZSg8JWlmKGVhLkVudGl0eVR5cGUpeyU+KHYgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPigpPCV9ZWxzZXslPm51bGw8JX0lPikvKjwlbGFiZWwoJ2NvbHVtbicsIGVhLk5hbWUsICdlYUNvZGUnLCBlYS5QbHVyYWwpJT4qLyksDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnJlZmVyZW5jZV9Db2x1bW5zKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29sdW1uJywgdHJ1ZSklPigpLmFjdGl2ZShmYWxzZSkuZW5hYmxlZCh0cnVlKS5jb2RlKGVhQ29kZSkudHlwZSgnTGlzdCcpLm5hbWUoIjwlPW5OYW1lKHRhKSU+IDwlPXRhLkVudGl0eUNsYXNzLlBsdXJhbCU+IikucmVmZXJlbmNlKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSkvKjwlbGFiZWwoJ2NvbHVtbicsIHRhLk5hbWUrJyAnK3RhLkVudGl0eUNsYXNzLlBsdXJhbCwgJ2VhQ29kZScsIHRhLkVudGl0eUNsYXNzLlBsdXJhbCklPiovKSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NORmxvdyclPihiRHJhZnQsIGJIZWFkZXIpew0KICAgICAgICB0cnl7DQogICAgPCUgaWYoX2NOYW1lKCdBcHBsaWNhdGlvbicpKXslPg0KICAgICAgICA8JSBsZXQgYk9yZGVyID0gMTsgbGV0IF9maWQgPSBfYyA9PiBfaWQoIiciK3Njb3BlKyIuJyArIChiRHJhZnQ/J2QnOidzJykgKyAnbCIrIChfYyB8fCBjKS5OYW1lICsgIiciKTsNCiAgICAgICAgbGV0IGxvZ2ljID0gKG4sIHQsIG1hcD1bXSkgPT4geyU+DQogICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgTG9naWMnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm9yZGVyKDwlPWJPcmRlcisrJT4pLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKCc8JT1uJT4nKS5yZW1hcmsoJzwlPW4lPicpDQogICAgICAgICAgICAgICAgLmJsb2NrKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBCbG9jaycsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSg8JT1faWQoKSU+KS5uYW1lKCc8JT1uJT4nKQ0KICAgICAgICAgICAgICAgICAgICAuYmxvY2tfRWxlbWVudF9NYXBwaW5ncyhbPCUgbWFwLmZpbHRlcihtID0+IG0pLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCI8JT1uJT4gLSAiICsgPCU9bS5jZCU+KS5jb2RlKDwlPW0uY2QlPikudmFsdWUoPCU9bS52JT4pPCVwQ29tcG91bmQobS52LCBtLnRybiklPiwNCiAgICAgICAgICAgICAgICAgICAgPCV9KSU+XSkNCiAgICAgICAgICAgICAgICApLmRlZmluaXRpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdMb2dpYyBEZWZpbml0aW9uJywgdHJ1ZSklPignPCU9dCU+IDwlPW4lPicpLmNvZGUoJzwlPXQlPicpLm5hbWUoJzwlPXQlPicpKS48JWFwcCgpJT4NCiAgICAgICAgPCV9DQogICAgICAgIGxldCBhY3Rpb24gPSAoYUNvZGUsIHBhcmFtcz17fSkgPT4geyAlPg0KICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBY3Rpb24gSW5zdGFuY2UnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUodGhpcy5fdXVpZCgpKS5hY3Rpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBY3Rpb24gVHlwZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnPCU9YUNvZGUlPicpKS5vcmRlcig8JT1iT3JkZXIrKyU+KS48JWFwcCgpJT4NCiAgICAgICAgICAgIC5hY3Rpb25fVmFyaWFibGVfVmFsdWVzKFsNCiAgICAgICAgICAgIDwlIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVmFyaWFibGUgVmFsdWUnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoPCU9cGFyYW1zW3BdJT4pLmFjdGlvbklucHV0KA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FjdGlvbiBJbnB1dCcsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKQ0KICAgICAgICAgICAgICAgICkubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSgiIikpLA0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgXSkNCiAgICAgICAgPCV9DQogICAgICAgIGxldCBzdWJmbG93ID0gKGZsb3csIHBhcmFtcz17fSwgYk5vV2FpdCkgPT4geyAlPg0KICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IEluc3RhbmNlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKHRoaXMuX3V1aWQoKSkuc3ViZmxvdyg8JT1mbG93JT4pLm9yZGVyKDwlPWJPcmRlcisrJT4pLjwlYXBwKCklPg0KICAgICAgICAgICAgPCUgaWYoIWJOb1dhaXQpeyU+DQogICAgICAgICAgICAuaW5zdGFuY2VfRmxvd19JbnN0YW5jZV9JbnB1dHMoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnN0YW5jZSBJbnB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnd2FpdF9mb3JfY29tcGxldGlvbicpLm5hbWUoJ1dhaXQgZm9yIENvbXBsZXRpb24nKS50eXBlKCdCb29sJyldKQ0KICAgICAgICAgICAgLmluc3RhbmNlX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVmFyaWFibGUgVmFsdWUnLCB0cnVlKSU+KCkuY29kZSgnd2FpdF9mb3JfY29tcGxldGlvbicpLnZhbHVlKCcxJykNCiAgICAgICAgICAgICAgICAgICAgLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnd2FpdF9mb3JfY29tcGxldGlvbicpKQ0KICAgICAgICAgICAgXSkNCiAgICAgICAgICAgIDwlfSU+DQogICAgICAgICAgICAuaW5zdGFuY2VfVmFyaWFibGVfVmFsdWVzKFsNCiAgICAgICAgICAgIDwlIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVmFyaWFibGUgVmFsdWUnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoPCU9cGFyYW1zW3BdJT4pLmZsb3dJbnB1dCgNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0JywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpDQogICAgICAgICAgICAgICAgKS5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KSkNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pDQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgcENvbXBvdW5kID0gKHYsIHRybikgPT4ge2lmKCF0cm4pIHJldHVybjsgJT4uZWxlbWVudE1hcHBpbmdfUGlsbF9Db21wb3VuZHMoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUGlsbCBDb21wb3VuZCcsIHRydWUpJT4odGhpcy5fdXVpZCgpKS5jb2RlKCcnKS5uYW1lKDwlPXYlPikub3JkZXIoMCkvKi5yZW1hcmsodGhpcy5fYnRvYShgPCU9SlNPTi5zdHJpbmdpZnkoW10pJT5gKSkqLy48JWFwcCgpJT4NCiAgICAgICAgICAgIC5wYXJlbnRfUGlsbF9Db21wb3VuZHMoWw0KICAgICAgICAgICAgPCUgT2JqZWN0LmtleXModHJuKS5mb3JFYWNoKCh0LCBpKSA9PiB7JT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdQaWxsIENvbXBvdW5kJywgdHJ1ZSklPih0aGlzLl91dWlkKCkpLmNvZGUoIjwlPXQlPiIpLm9yZGVyKDwlPWkrMSU+KS5uYW1lKDwlPXYlPikucmVtYXJrKHRoaXMuX2J0b2EoYDwlPUpTT04uc3RyaW5naWZ5KHRyblt0XSklPmApKS48JWFwcCgpJT4vKi50cmFuc2Zvcm0obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUcmFuc2Zvcm0nLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPXQlPicpLnRyYW5zZm9ybV9UcmFuc2Zvcm1fQ29tcG9zaXRpb25zKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RyYW5zZm9ybSBDb21wb3NpdGlvbicsIHRydWUpJT4oKS5jb2RlKCcnKV0pKSovLA0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgXSldKQ0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgDQogICAgICAgICAgICAvKg0KICAgICAgICAgICAgICogT09CIEVuZHBvaW50OiBodHRwczovL2RldjE2MjU3MC5zZXJ2aWNlLW5vdy5jb20vYXBpL25vdy9wcm9jZXNzZmxvdy9mbG93b2JqZWN0L3N0YXJ0L3N1YmZsb3cNCiAgICAgICAgICAgICAqIFBheWxvYWQ6IHsibmFtZSI6InhfNzg2MTFfc2Nob29sX21hbi5Vc2VyX2xvb2t1cCIsImlucHV0cyI6eyJqc29uIjp7Im5hbWUiOiJ0ZXN0IiwiZ2VuZGVyIjp7ImNvZGUiOiJNIiwgIk9QRVJBVE9SUyI6IHsiY29kZSI6ICIhPSJ9fSwidXNlcl9TdHVkZW50cyI6W3sibmFtZSI6IlNUQSIsImdlbmRlciI6eyJjb2RlIjoiTSJ9fV19fX0NCiAgICAgICAgICAgICovDQoNCiAgICAgICAgICAgIGxldCBmbG93ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93JywgdHJ1ZSklPig8JT1fZmlkKCklPikubmFtZSgnPCU9Yy5OYW1lJT4gTG9va3VwJykuY29kZSg8JT1fbkNvZGUoKSU+ICsgJ19sb29rdXAnKS48JWFwcCgpJT4uYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSk7DQogICAgICAgICAgICBpZihiSGVhZGVyKSByZXR1cm4gZmxvdzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQoZmxvdy8qLl9kZWZhdWx0cygpKi8NCiAgICAgICAgICAgICAgICAuZmxvd19GbG93X1NldHRpbmdzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgU2V0dGluZycsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnQUNUSU9OJyldKQ0KICAgICAgICAgICAgICAgIC5mbG93X0Zsb3dfSW5wdXRzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSgnanNvbicpLm5hbWUoJ0pTT04nKS50eXBlKCdKU09OJyk8JWxhYmVsKCdpbnB1dCcsICdKU09OJywgIidqc29uJyIpJT4NCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfT3V0cHV0cyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBPdXRwdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKDwlPV9uQ29kZSgpJT4gKyAnX2xpc3QnKS5uYW1lKCc8JT1uTmFtZShjKSU+IExpc3QnKS50eXBlKCdMaXN0JykucmVmZXJlbmNlKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVGFibGUnLCB0cnVlKSU+KCI8JT1uTmFtZShjKSU+IikubmFtZSgnPCU9Yy5OYW1lJT4nKS5jb2RlKDwlPV9uQ29kZSgpJT4pLjwlYXBwKCklPikNCiAgICAgICAgICAgICAgICAgICAgPCVsYWJlbCgnb3V0cHV0JywgYy5OYW1lICsgJyBMaXN0JywgX25Db2RlKCkgKyAiKyAnX2xpc3QnIiklPg0KICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19WYXJpYWJsZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKCdqc29uJykubmFtZSgnSlNPTicpLnR5cGUoJ0pTT04nKTwlbGFiZWwoJ3ZhcmlhYmxlJywgJ0pTT04nLCAnImpzb24iJyklPiwNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSgnZXF1ZXJ5JykubmFtZSgnRVF1ZXJ5JykudHlwZSgnU3RyaW5nJyk8JWxhYmVsKCd2YXJpYWJsZScsICdFUXVlcnknLCAnImVxdWVyeSInKSU+LA0KICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdTZXQgJyArIGMuTmFtZSArICcgSlNPTicsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2pzb24nIiwgdjogIid7e3N1YmZsb3cuanNvbn19JyJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgPCUgLy8gLCB0cm46IHtyZXBsYWNlX3N0cmluZzoge3JlZ2V4OiAiLy9nIiwgcmVwbGFjZV9zdHJpbmc6ICIifX0lPg0KICAgICAgICAgICAgICAgIF0pLnNlY3VyaXR5Q29udHJvbChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IENvbnRyb2wnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ3N5c19odWJfZmxvdycpLm5hbWUoYHN5c19zY29wZS5zY29wZT0ke3RoaXMuX19jb25maWcoJ3Njb3BlJywgJzwlPXNjb3BlJT4nKX1gKS50eXBlKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU2VjdXJpdHkgVHlwZScsIHRydWUpJT4oKS5jb2RlKCdjbGllbnRfY2FsbGFibGVfZmxvd19vYmplY3QnKSkub3BlcmF0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU2VjdXJpdHkgT3BlcmF0aW9uJywgdHJ1ZSklPigpLmNvZGUoJ2V4ZWN1dGUnKSkuPCVhcHAoKSU+KSwgew0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIC8vZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSB2LnJldXNlZD9uZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cnLCB0cnVlKSU+KHYub2JqLklkKTp2Lm9iaiwgLyppbmZvcm1hdGlvbiBsb3NzKi8NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBOdWxsOiAhYkhlYWRlciwNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iajwlaWYoMCB8fCAoWyduYW1lJywgJ3JlbWFyaycsICdkYXRlJywgJ29yZGVyJywgJ2FjdGl2ZScsICdlbmFibGVkJ10uaW5kZXhPZihlYS5OYW1lKTwwKSl7JT4uZmxvd19GbG93X1ZhcmlhYmxlcyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZShlYUNvZGUpLm5hbWUoJzwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4nKS50eXBlKDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+J0pTT04nPCUgfWVsc2V7JT4nPCU9X0ZyRU1ELl9hdHRyKGVhKSU+JzwlfSU+KTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSwgImVhQ29kZSIpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnPCU9bk5hbWUoYyklPi48JT1lYS5OYW1lJT4uU2V0JykuY29kZShlYUNvZGUgKyAnX3NldCcpLm5hbWUoJzwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4gU2V0JykudHlwZSgnQm9vbCcpPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lICsgJyBTZXQnLCAiZWFDb2RlICsgJ19zZXQnIiklPiwNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKGVhQ29kZSArICdfb3AnKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+IE9wZXJhdG9yJykudHlwZSgnU3RyaW5nJyk8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUgKyAnIE9wZXJhdG9yJywgImVhQ29kZSArICdfb3AnIiklPiwNCiAgICAgICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ1NldCAnK2VhLk5hbWUsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbDQogICAgICAgICAgICAgICAgICAgICAgICBlYS5FbnRpdHlUeXBlP251bGw6e2NkOiAiZWFDb2RlIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuanNvbn19JyIsIHRybjogT2JqZWN0LmFzc2lnbih7fSwge3ZhbHVlX21hcDoge2tleTogIiR7ZWFDb2RlfSIsIGRlZmF1bHQ6ICIifX0sIGVhLl9Jc0RhdGU/e3N0cmluZ190b19kYXRlOiB7ZGF0ZV9mb3JtYXQ6ICJ5eXl5LU1NLWRkXCdUXCdISDptbTpzc1wnWlwnIiwgY3VzdG9tX2Zvcm1hdDogIiJ9fTp7fSl9LA0KICAgICAgICAgICAgICAgICAgICAgICAgLy97Y2Q6ICJlYUNvZGUrJ19zZXQnIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319fSciLCB0cm46IHtpc19udWxsOiB7fX19LA0KICAgICAgICAgICAgICAgICAgICAgICAgLy97Y2Q6ICJlYUNvZGUrJ19vcCciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5vcGVyYXRvcnN9fSciLCB0cm46IHt2YWx1ZV9tYXA6IHtrZXk6ICIke2VhQ29kZX0ifX19LA0KICAgICAgICAgICAgICAgICAgICBdKSU+LmxvZ2ljX0Zsb3dfSW5wdXRfU2NyaXB0cyhbDQogICAgICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnU2V0IDwlPWVhLk5hbWUlPicpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSkucmVtYXJrKGByZXR1cm4gZmRfZGF0YS5mbG93X3Zhci5qc29uLiR7ZWFDb2RlfTtgKSw8JX0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnU2V0IDwlPWVhLk5hbWUlPiBTZXQnKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUgKyAnX3NldCcpLnJlbWFyayhgcmV0dXJuIHR5cGVvZihmZF9kYXRhLmZsb3dfdmFyLmpzb24uJHtlYUNvZGV9KSFcdTAwM2RcdTAwM2RcdTAwMjd1bmRlZmluZWRcdTAwMjc7YCksDQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCdTZXQgPCU9ZWEuTmFtZSU+IE9wZXJhdG9yJykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlICsgJ19vcCcpLnJlbWFyayhgcmV0dXJuIChmZF9kYXRhLmZsb3dfdmFyLmpzb24uT1BFUkFUT1JTIHx8IHt9KS4ke2VhQ29kZX07YCksDQogICAgICAgICAgICAgICAgICAgIF0pLA0KDQogICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0lmICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIFNldCcsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicgKyBlYUNvZGUgKyAnX3NldH19PXRydWUnIn1dKSU+DQogICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT4ucGFyZW50X0Zsb3dfSW5zdGFuY2VzKDwlc3ViZmxvdygnbmV3ICcrc2NvcGUrJy4nK19jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSsnKCkuJyttTmFtZSsnKGZhbHNlLCB0cnVlKScsIHtqc29uOiAiJ3t7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX0nIn0pJT4pPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgLnBhcmVudF9GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBZGQgJytlYS5OYW1lKycgdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5JywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19XicrZWFDb2RlIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnSWYgJyArIGMuTmFtZSArICcgJytlYS5OYW1lKycgT3BlcmF0b3IgaXMgbm90IGVtcHR5JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ19vcH19IT0nIn1dKSU+LnBhcmVudF9GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kICcrZWEuTmFtZSsnIE9wZXJhdG9yIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fXt7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnX29wfX0nIn1dKSU+DQogICAgICAgICAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0Vsc2UgJyArIGMuTmFtZSArICcgJytlYS5OYW1lKycgbm90IFNldCcsICdFbHNlJyklPi5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCA9IHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeSBmb3IgJytlYS5OYW1lLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX09JyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+PCVsb2dpYygnRm9yIGVhY2ggJytjLk5hbWUrJyAnK2VhLk5hbWUsICdGb3IgRWFjaCcsIFt7Y2Q6ICInaXRlbXMnIiwgdjogIid7ezw8KiojJGZbaW50ZXJuYWxfbmFtZT1cXCciK2MuTmFtZSsiX2xvb2t1cFxcJyBhbmQgJG5vdCgkZXhpc3RzKGZsb3dfRmxvd19TbmFwc2hvdHMpKV0uc25hcHNob3RfRmxvd19Mb2dpY3MuKioucGFyZW50X0Zsb3dfSW5zdGFuY2VzIyRmaVskbnVtYmVyKG9yZGVyKTw9IitiT3JkZXIrIiBhbmQgc3ViZmxvdy5pbnRlcm5hbF9uYW1lPVxcJyIrZWEuRW50aXR5VHlwZS5OYW1lKyJfbG9va3VwXFwnXS51aV9pZD4+LiIrZWEuRW50aXR5VHlwZS5OYW1lKyJfbGlzdH19JyJ9XSklPi5wYXJlbnRfRmxvd19Mb2dpY3MoWzwlfSU+DQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgJytlYS5OYW1lKycgdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5JywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19e3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fScifV0pJT4sDQogICAgICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+XSk8JX0lPiwNCiAgICAgICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgXSk8JX0lPg0KICAgICAgICAgICAgICAgICwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmo8JWlmKDAgfHwgWydVc2VyJywgJ0dlbmRlcicsICdfU3R1ZGVudCcsICdfVGVhY2hlciddLmluZGV4T2YodGEuRW50aXR5Q2xhc3MuTmFtZSk+PTApeyU+LmZsb3dfRmxvd19Mb2dpY3MoWzwlbG9naWMoJ0lmICcrdGFOYW1lKycgbm90IGVtcHR5JywgJ0lmJyklPi5wYXJlbnRfRmxvd19JbnN0YW5jZXMoPCVzdWJmbG93KCduZXcgJytzY29wZSsnLicrX2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSsnKCkuJyttTmFtZSsnKGJEcmFmdCwgdHJ1ZSknLCB7anNvbjogIid0ZXN0JyJ9KSU+KV0pPCV9JT4sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICBfbG9va3VwOiBvYmogPT4gb2JqLmZsb3dfRmxvd19Mb2dpY3MoWzwlbG9naWMoJ0lmIEVRdWVyeSBub3QgZW1wdHknLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fSE9JyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICAucGFyZW50X0FjdGlvbl9JbnN0YW5jZXMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVhY3Rpb24oJ2xvb2tfdXBfcmVjb3JkcycsIHt0YWJsZTogJyI8PCQuc3lzX3Njb3BlLnNjb3BlPj5fIisoJytfbkNvZGUoKSsnKS50b0xvd2VyQ2FzZSgpJ30pJT4sDQogICAgICAgICAgICAgICAgICAgIF0pLmxvZ2ljX0Zsb3dfSW5wdXRfU2NyaXB0cyhbDQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPigpLm5hbWUoJ1NldCBDb25kaXRpb24nKS5hY3RpdmUodHJ1ZSkuY29kZSgnY29uZGl0aW9ucycpLnJlbWFyayhgcmV0dXJuIGZkX2RhdGEuZmxvd192YXIuZXF1ZXJ5O2ApLA0KICAgICAgICAgICAgICAgICAgICBdKQ0KICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgIF9zbmFwc2hvdDogb2JqID0+IGJEcmFmdD9udWxsOm9iai5mbG93X0Zsb3dfU25hcHNob3RzKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBTbmFwc2hvdCcsIHRydWUpJT4oPCU9X2ZpZCgpJT4pLnNuYXBzaG90X0Zsb3dfUGxhbnMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgUGxhbicsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnPCU9Yy5OYW1lJT5fUGxhbicpLm5hbWUoJzwlPWMuTmFtZSU+IFBsYW4nKQ0KICAgICAgICAgICAgICAgICAgICBdKS5mcm9tRmxvdyh0aGlzLjwlPW1OYW1lJT4odHJ1ZSkpKSwNCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+IiwgYkRyYWZ0LCBiSGVhZGVyKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdfdG9TTlNjcmlwdCclPihvcHRpb25zPXt9KXsNCiAgICAgICAgb3B0aW9ucy5fdGhpcyA9IG9wdGlvbnMuX3RoaXMgfHwgdGhpczsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgICAgICBsZXQgZXhwID0gb3B0aW9ucy5yYXc/Il90b0pTT04iOiJfdG9Eb2N1bWVudCI7DQogICAgICAgICAgICBsZXQgcm9sbGJhY2sgPSAob3B0aW9ucy5hcHAgJiYgb3B0aW9ucy5yb2xsYmFjayk/YXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdSb2xsYmFjayBDb250ZXh0JywgdHJ1ZSklPigpLmNvZGUoJ2xhc3QnKVtleHBdKE9iamVjdC5hc3NpZ24oe2JKU09OOiB0cnVlfSwgb3B0aW9ucykpOiIiOw0KICAgICAgICAgICAgbGV0IGRiID0gb3B0aW9ucy5kYj9hd2FpdCBvcHRpb25zLl90aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOVGFibGUoKVtleHBdKE9iamVjdC5hc3NpZ24oe2JKU09OOiB0cnVlfSwgb3B0aW9ucykpOiIiOw0KICAgICAgICAgICAgbGV0IGZsb3cgPSBvcHRpb25zLmZsb3c/YXdhaXQgb3B0aW9ucy5fdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTkZsb3cob3B0aW9ucy5kcmFmdClbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5nemlwKXsNCiAgICAgICAgICAgICAgICBpZihmbG93KSBmbG93ID0gdGhpcy5VdGY4QXJyYXlUb1N0cihhd2FpdCB0aGlzLl9jb21wcmVzcyhmbG93KSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0ZXN0ID0gKG9wdGlvbnMudGVzdCAmJiBvcHRpb25zLmZsb3cgJiYgIW9wdGlvbnMuZHJhZnQpP2Bcbi8qZ3MuY2FjaGVGbHVzaCgpOyAqL2dzLmluZm8oc25fZmQuRmxvd0FQSS5nZXRSdW5uZXIoKS5zdWJmbG93KCcke3RoaXMuX19jb25maWcoJ3Njb3BlJywgJzwlPXNjb3BlJT4nKX0uVXNlcl9sb29rdXAnKS5pbkZvcmVncm91bmQoKS53aXRoSW5wdXRzKHtqc29uOiB7Y29kZToidGVzdCIsZGF0ZTonMjAyNC0wNS0wM1QxODo0NDowMy4xNzdaJyxnZW5kZXI6e2NvZGU6Ik0iLCBPUEVSQVRPUlM6IHtjb2RlOiAiIT0ifX0sdXNlcl9TdHVkZW50czpbe2NvZGU6IlNUQSIsZ2VuZGVyOntjb2RlOiJNIn19XSwgT1BFUkFUT1JTOiB7ZGF0ZTogJzwnfX19KS5ydW4oKS5nZXRPdXRwdXRzKClbIlVzZXJfbGlzdCJdKTtcbmA6Jyc7DQogICAgICAgICAgICBsZXQgYXBwID0gb3B0aW9ucy5hcHA/KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQXBwbGljYXRpb24nLCB0cnVlKSU+KCkvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05TYXZlKG9wdGlvbnMpICsgYFxuIHZhciBjb25maWcgPSB7QXBwbGljYXRpb246IHtyZWFkT25seTogdHJ1ZX0sIFRhYmxlOiB7aWRLZXk6ICduYW1lJywgTG9nU2V0OiAwfSwgQ29sdW1uOiB7TG9nU2V0OiAwfSwgRWxlbWVudF9NYXBwaW5nOiB7TG9nU2V0OiAwfSwgQWN0aW9uX0lucHV0OiB7cmVhZE9ubHk6IHRydWV9LCBBY3Rpb25fVHlwZToge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ21hc3Rlcl9zbmFwc2hvdCd9LCBBY3Rpb25fSW5zdGFuY2U6IHtMb2dTZXQ6IDB9LCBTZWN1cml0eV9UeXBlOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbmFtZSd9LCBTZWN1cml0eV9PcGVyYXRpb246IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICduYW1lJ30sIExvZ2ljX0RlZmluaXRpb246IHtyZWFkT25seTogdHJ1ZX0sIEZsb3c6IHtMb2dTZXQ6IDB9LCBUcmFuc2Zvcm06IHtyZWFkT25seTogdHJ1ZX0sIFRyYW5zZm9ybV9Db21wb3NpdGlvbjoge3JlYWRPbmx5OiB0cnVlfSwgUm9sbGJhY2tfQ29udGV4dDoge3JlYWRPbmx5OiB0cnVlfX07IFxuYCArIChvcHRpb25zLnJvbGxiYWNrPygidmFyIGNpZCA9IHNhdmVSb2xsYmFja19Db250ZXh0KCIrcm9sbGJhY2srYCk7IGlmKGNpZCl7dmFyIHJ3ID0gbmV3IEdsaWRlUm9sbGJhY2tXb3JrZXIoKTsgcncuc2V0Um9sbGJhY2tDb250ZXh0SUQoY2lkLnN5c19pZCk7IHJ3LnN0YXJ0KCk7fSBcbmApOiIiKSsgKG9wdGlvbnMuZGI/KCJzYXZlVGFibGUoIitkYisiKTsgXG4iKToiIikgKyAob3B0aW9ucy5mbG93Pygic2F2ZUZsb3coIitmbG93KyIpOyBcbiIpOiIiKSArIHRlc3QpOihyb2xsYmFjayArIGRiICsgZmxvdyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBzY3JpcHQgPSB0aGlzLl9iZWF1dGlmeShhcHAsICdqYXZhc2NyaXB0Jyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLmRlcGxveSkgcmV0dXJuIHNjcmlwdDsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1NOU2F2ZSclPihvcHRpb25zKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCUgdmFyIF9mUmVnRXhwID0gL19me1tefV0rfS9nbTsgJT4NCiAgICAgICAgICAgIGxldCBfZiA9ICh2LCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB2Ow0KICAgICAgICAgICAgICAgICAgICAvL2lmKHYuc3RhcnRzV2l0aCgiZigiKSAmJiB2LmVuZHNXaXRoKCIpIikpIHJldCA9ICcoJyt2LnNsaWNlKDIsLTEpKycpJzsNCiAgICAgICAgICAgICAgICAgICAgaWYodi5zdGFydHNXaXRoKCJzKCIpICYmIHYuZW5kc1dpdGgoIikiKSl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBgKGZ1bmN0aW9uIChvYmosICR7ZWFDb2RlfSl7YCt2LnNsaWNlKDIsLTEpK2B9KShvYmosICR7ZWFDb2RlfSlgOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZihyZXQgJiYgcmV0Lm1hdGNoICYmIHJldC5tYXRjaCg8JT1fZlJlZ0V4cCU+KSkgcmV0ID0gYChmdW5jdGlvbiAob2JqLCAke2VhQ29kZX0peyR7cmV0LmluZGV4T2YoInJldHVybiIpPDA/InJldHVybiAiOiIifSAnYCtyZXQucmVwbGFjZSg8JT1fZlJlZ0V4cCU+LCBtID0+IGAnICsgJHttLnNsaWNlKDMsIC0xKX0gKyAnYCkrYCc7fSkob2JqLCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICAgICAgaWYocmV0ICYmIHJldC5tYXRjaCAmJiByZXQubWF0Y2goLzw8W14+Pl0rPj4vZ20pKSByZXQgPSAnIiInOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYChmdW5jdGlvbih2KXsgdHJ5eyByZXR1cm4gKHYgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoPCU9X2ZSZWdFeHAlPiwgZnVuY3Rpb24obSl7cmV0dXJuIGV2YWwobS5zbGljZSgzLCAtMSkpO30pOnY7ICB9Y2F0Y2goZXgpe2dzLmluZm8oJ19me0V4Y2VwdGlvbn06ICR7ZWFDb2RlfTogJyArIGV4KTsgcmV0dXJuIHY7fSB9KSgke3JldH0gfHwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBlYUNvZGU7DQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7SWQ6ICI8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+IiwgdmFyczogYGAsIGNvZGU6IGBgLCBxdWVyeTogYGAsIHNldDogYGAsIGVzZXQ6IGBgLCBkc2V0OiBgYCwgdGFzOiBgYCwgZGVwczoge319LCB7DQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e2NvZGU6IHYub2JqLmNvZGUgKyBgXG5cbi8qKiByZXVzZWQ6IHYub2JqLklkKiovXG5cbmAsIGRlcHM6ICcnLCBJZDogdi5vYmouSWR9LA0KDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLklkID0gYGlmKG9iai4ke2lkQ29kZX0gJiYgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKS5sZW5ndGg9PTMyKXtfdG9TdHJpbmcrPSdfJytvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpOyBnci5nZXQoJ3N5c19pZCcsIG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykpO31cbmA7DQogICAgICAgICAgICAgICAgICAgIG9iai5pZFRvU3RyaW5nID0gYF90b1N0cmluZyArPSAob2JqP29iai4ke2lkQ29kZX06KCdncl8nK2dyLnN5c19pZCkpICsgJzogJzsgYDsNCiAgICAgICAgICAgICAgICAgICAgb2JqLm5ld1VVSUQgPSBgaWYoIW9iai4ke2lkQ29kZX0gfHwgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKS5sZW5ndGghPTMyKXtvYmouJHtpZENvZGV9ID0gZ3Iuc2V0TmV3R3VpZCgpO31lbHNle2dyLnNldE5ld0d1aWRWYWx1ZShvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpKTt9fVxuYDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUhPWMpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICA8JSB9JT4NCg0KICAgICAgICAgICAgICAgICAgICBvYmoudmFycyArPSBgdmFyICR7ZWFDb2RlfSA9IDwlaWYoZWEuRW50aXR5VHlwZSl7JT4oKChyZWZzLjwlPW5OYW1lKGVhKSU+ID0gKHR5cGVvZihvYmouJHtlYUNvZGV9KSE9PSd1bmRlZmluZWQnPy8qdGhpcy4qL3NhdmU8JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+KG9iai4ke2VhQ29kZX0sIHs8JT1uTmFtZShjKSU+OiBvYmosIDwlPW5OYW1lKGMvKmVhKi8pJT5SZWZzOiByZWZzLCA8JT1uTmFtZShjKS50b0xvd2VyQ2FzZSgpJT46IGdyfSwgIjwlPW5OYW1lKGMpJT4iLCByZWZzLjwlPW5OYW1lKGVhKSU+IHx8IC8qRVhQOiByZWZzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpLnRvTG93ZXJDYXNlKCklPiB8fCAqLygke19mKDwldmFsdWVPZihlYS5EZWZhdWx0KSU+LCBlYUNvZGUpfSkpOnJlZnMuPCU9bk5hbWUoZWEpJT4pKSB8fCB7c3lzX2lkOiAnJ30pWy8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+LmlkS2V5IHx8ICJzeXNfaWQiXSkudG9TdHJpbmcoKTwlfWVsc2V7JT5vYmouJHtlYUNvZGV9PCV9JT47YDsNCiAgICAgICAgPCUgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5xdWVyeSArPSBgX3RvU3RyaW5nKz0nXycrJHtlYUNvZGV9OyBfdG9RdWVyeS4ke2VhQ29kZX0gPSAke19mKHYsIGVhQ29kZSl9OyBgOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnNldCArPSBgaWYodHlwZW9mKF90b1NldC4ke2VhQ29kZX0gPSAke19mKHYsIGVhQ29kZSl9KSE9PSd1bmRlZmluZWQnPCVpZihlYS5FbnRpdHlUeXBlKXslPiYmIF90b1NldC4ke2VhQ29kZX08JX0lPikgZ3Iuc2V0VmFsdWUoJyR7ZWFDb2RlfScsIF90b1NldC4ke2VhQ29kZX0pO2A7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmouZXNldCArPSBgaWYodHlwZW9mKF90b1NldC4ke2VmQ29kZX0gPSAke19mKEpTT04uc3RyaW5naWZ5KHYpLCAnb2JqLicrZWZDb2RlKX0pIT09J3VuZGVmaW5lZCcpIGdyLnNldFZhbHVlKCcke2VmQ29kZX0nLCBfdG9TZXQuJHtlZkNvZGV9KTtgLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai50YXMgKz0gYHJlZnMuPCU9dGFOYW1lJT4gPSAoKG9iaj9vYmouJHtlYUNvZGV9OltdKSB8fCBbXSkubWFwKGZ1bmN0aW9uKG8pe2dzLmluZm8oX3RvU3RyaW5nICsgJyA9PiBzYXZlPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4oJHtlYUNvZGV9W10pJyk7IHJldHVybiAvKnRoaXMuKi9zYXZlPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4obywgezwlPW5OYW1lKGMpJT46IG9iaiwgPCU9bk5hbWUoYykudG9Mb3dlckNhc2UoKSU+OiBnciwgbWFueVJlZnM6IHJlZnN9LCAiPCU9bk5hbWUoYyklPiIpO30pO2ANCiAgICAgICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIXJldC5kc2V0KSByZXQuZHNldCArPSBgXG5pZih0eXBlb2Yob2JqKT09PSJvYmplY3QiKSBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihmdW5jdGlvbihrKXtyZXR1cm4gIWsuc3RhcnRzV2l0aCgnX18nKSAmJiBbJ3N5c19pZCcsICdJZCcsICdPUEVSQVRPUlMnXS5pbmRleE9mKGspPDAgJiYgdHlwZW9mKF90b1NldFtrXSk9PT0ndW5kZWZpbmVkJyAmJiAhQXJyYXkuaXNBcnJheShvYmpba10pO30pLmZvckVhY2goZnVuY3Rpb24oayl7X3RvU2V0W2tdID0gJHtfZigib2JqW2tdIiwgIm51bGwiKX07IGlmKF90b1NldFtrXSAmJiBfdG9TZXRba10uX19jbGFzcyl7X3RvU2V0W2tdID0gX3RvU2V0W2tdW2NvbmZpZ1tfdG9TZXRba10uX19jbGFzc10uaWRGaWVsZCB8fCAnSWQnXTsgfSBnci5zZXRWYWx1ZShrLCBfdG9TZXRba10gKTsgfSlcbmA7DQoNCiAgICAgICAgICAgIHJldC5jb2RlICs9IGAke09iamVjdC52YWx1ZXMocmV0LmRlcHMpLmpvaW4oJ1xuJyl9ZnVuY3Rpb24gc2F2ZTwlPW5OYW1lKGMpJT4ob2JqLCByZWZzLCBzb3VyY2UsIGdyKXtyZWZzID0gcmVmcyB8fCB7fTsgLyp0aGlzLiovY29uZmlnLnNhdmVfJHs8JT1fbkNvZGUoKSU+fSA9IHNhdmU8JT1uTmFtZShjKSU+OyAvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPiA9IC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+IHx8IHt9OyAvKnRoaXMuKi9jb25maWcuX2lkTWFwID0gLyp0aGlzLiovY29uZmlnLl9pZE1hcCB8fCBbXTsgdmFyIF90b1N0cmluZyA9IHNvdXJjZSArICdbJyArIChyZWZzW3NvdXJjZV0uc3lzX2lkKSArICddPT4gc2F2ZTwlPW5OYW1lKGMpJT4oJzsgaWYodHlwZW9mKG9iaik9PT0nc3RyaW5nJyAmJiBvYmoubGVuZ3RoPj0zMil7dmFyIHJldCA9IHt9OyByZXRbLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uaWRLZXkgfHwgInN5c19pZCJdPW9iajsgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnKTogb2JqIGlzIHV1aWQsIHJldHVybmluZyB7JytvYmorJ30nKTsgcmV0dXJuIHJldDt9IGlmKCFvYmogJiYgIWdyKXtncy5pbmZvKF90b1N0cmluZyArICcpOiBvYmogaXMgbnVsbCcpOyByZXR1cm4gbnVsbDt9ICR7cmV0LmlkVG9TdHJpbmd9IHZhciBiU2F2ZSA9ICEvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5yZWFkT25seTsgaWYoIWdyKXsgZ3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTtcbiR7cmV0LklkfVxuJHtyZXQudmFyc31cbmlmKCFnci5pc1ZhbGlkUmVjb3JkKCkpe2dyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7IHZhciBfdG9RdWVyeT17fTsgJHtyZXQucXVlcnl9IFxuX3RvU3RyaW5nICs9ICcpOiAnOyBpZihvYmouX19rZXlzICYmIChiU2F2ZSB8fCBjb25maWcuPCU9bk5hbWUoYyklPi5yZWFkT25seSkpe2lmKF90b1F1ZXJ5Ll9fZW5jb2RlZFF1ZXJ5KXtnci5hZGRFbmNvZGVkUXVlcnkoX3RvUXVlcnkuX19lbmNvZGVkUXVlcnkpO31lbHNle29iai5fX2tleXMuZm9yRWFjaChmdW5jdGlvbihrKXtnci5hZGRRdWVyeShrLCBfdG9RdWVyeVtrXSB8fCBvYmpba10pO30pO30gZ3Iuc2V0TGltaXQoMSk7IGlmKCFnci5nZXRFbmNvZGVkUXVlcnkoKSkgZ3IuYWRkUXVlcnkoJ3N5c19pZCcsICctMScpOyBncy5pbmZvKF90b1N0cmluZyArICdFbmNvZGVkIFF1ZXJ5OiAnICsgZ3IuZ2V0RW5jb2RlZFF1ZXJ5KCkpOyBnci5xdWVyeSgpO2lmKCFnci5uZXh0KCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ25vdCBmb3VuZCcpO31lbHNle2dzLmluZm8oX3RvU3RyaW5nICsgJ2ZvdW5kIFskezwlPV9uQ29kZSgpJT59LycgKyBnci5zeXNfaWQgKyAnXSAtIGlzIHZhbGlkOiAnICsgZ3IuaXNWYWxpZFJlY29yZCgpKTsgb2JqLklkID0gZ3Iuc3lzX2lkLnRvU3RyaW5nKCk7IGlmKG9iai5fX3JldXNlZCl7Lypncy5pbmZvKF90b1N0cmluZyArICc6IF9fcmV1c2VkOiBbJHs8JT1fbkNvZGUoKSU+fS8nICsgZ3Iuc3lzX2lkICsgJ10gLSBpcyB2YWxpZDogJyArIGdyLmlzVmFsaWRSZWNvcmQoKSk7ICovcmV0dXJuIGdyO30gfX19fWVsc2V7YlNhdmU9ZmFsc2U7fSBpZihiU2F2ZSAmJiAhZ3IuaXNWYWxpZFJlY29yZCgpKXtncy5pbmZvKF90b1N0cmluZyArICdpbnNlcnRpbmcuLi4nKTsgZ3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTsgZ3IuaW5pdGlhbGl6ZSgpOyAke3JldC5uZXdVVUlEfSBpZihiU2F2ZSAmJiBvYmope3ZhciBfdG9TZXQgPSB7fTsgLypzZXQqLyR7cmV0LnNldH0gLyplc2V0Ki8ke3JldC5lc2V0fSAgJHtyZXQuZHNldH0gaWYoLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uTm9Xb3JrZmxvdykgZ3Iuc2V0V29ya2Zsb3coZmFsc2UpOyBpZigvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5Mb2dTZXQpIGdzLmluZm8oX3RvU3RyaW5nICsgJ190b1NldDogJyArIEpTT04uc3RyaW5naWZ5KF90b1NldCkpOyB9ZWxzZSBpZighZ3IuaXNWYWxpZFJlY29yZCgpKXtncy5pbmZvKF90b1N0cmluZyArICdbYlNhdmU9JyArIGJTYXZlICsgJ10gLSByZXR1cm5pbmcgbnVsbC4nKTsgcmV0dXJuIG51bGw7fVxuaWYoIWJTYXZlIHx8IGdyLnVwZGF0ZSgpKXsgaWYoZmFsc2UgJiYgYlNhdmUpe2NvbmZpZy5faWRNYXAucHVzaCh7dGFibGU6ICckezwlPV9uQ29kZSgpJT59Jywgc3lzX2lkOiBnci5zeXNfaWQudG9TdHJpbmcoKSwga2V5czogb2JqLl9fa2V5cy5tYXAoZnVuY3Rpb24oayl7cmV0dXJuIHtrOiBrLCB2OiBfdG9RdWVyeVtrXSB8fCBvYmpba119O30pfSk7fSAke3JldC50YXN9XG5ncy5pbmZvKF90b1N0cmluZyArICdbYlNhdmU9JyArIGJTYXZlICsgJ10gLSByZXR1cm5pbmcgJyArIGdyLnN5c19pZCk7IHJldHVybiBncjt9fVxuYDsNCg0KICAgICAgICAgICAgLypyZXR1cm4gT2JqZWN0LnZhbHVlcyhPYmplY3QuYXNzaWduKHt9LCAuLi5yZXQuY29kZS5zcGxpdCgnZnVuY3Rpb24gc2F2ZScpLmZpbHRlcihzID0+IHMpLnNvcnQoKGEsIGIpID0+IGEubGVuZ3RoIC0gYi5sZW5ndGgpLm1hcChzID0+ICh7W3Muc3BsaXQoJyhvYmosIHJlZnMsIHNvdXJjZSwgZ3IpJylbMF1dOiAnZnVuY3Rpb24gc2F2ZScrc30pKSkpLmpvaW4oJ1xuJyk7ICovDQogICAgICAgICAgICByZXR1cm4gcmV0LmNvZGU7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NOUXVlcnknJT4oZmllbGRzLCBvYmpzLCBiVVJMKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgIE9QRVJBVE9SUzogdHJ1ZSwNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdj92LjwlPW1OYW1lJT4oKTpudWxsOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsNCiAgICAgICAgICAgICAgICBsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOw0KICAgICAgICAgICAgICAgIGlmKCh2LmdldEhvdXJzKCk9PTAgJiYgdi5nZXRNaW51dGVzKCk9PTAgJiYgdi5nZXRTZWNvbmRzKCk9PTApIHx8IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSc9JyB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCl7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCE9PSdCRVRXRUVOJyl7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgIG9iai5PUEVSQVRPUlMuPCU9bk5hbWUoZWEpJT4gPSAnPSc7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICANCiAgICAgICAgT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkhPT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YocmV0W2tdKSE9PSdvYmplY3QnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7DQoNCiAgICAgICAgZGVsZXRlIHJldC5PUEVSQVRPUlM7DQogICAgICAgIE9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOw0KDQogICAgICAgIHJldCA9IERvdE9iamVjdC5kb3QocmV0KTsNCg0KICAgICAgICAvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMNCiAgICAgICAgT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KDQogICAgICAgIGlmKGJVUkwpIHJldCA9IE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KCTwlPW1OYW1lPSdfX2V4cG9ydCclPihvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsNCgkgICAgdHJ5ew0KICAgIAkgICAgaWYoIW9iaikgcmV0dXJuIHRoaXM7DQogICAgCSAgICANCiAgICAJICAgIGlmKG9wdGlvbnMuT1BFUkFUT1JTKSBvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsNCiAgICAJICAgIA0KICAgIAkgICAgPCUgLyogSU1QT1JUQU5UOiB0aGlzLklkPT10aGlzLklkIG1ha2VzIHN1cmUgdGhlIElkIGlzIGZpeGVkIGZvciB0aGUgdG9vbCwgbm90IGdldHRpbmcgZ2VuZXJhdGVkIGV2ZXJ5IHRpbWUgd2UgY2FsbCBpdCAqLyAlPg0KICAgIAkgICAgDQogICAgCSAgICBsZXQgZWFDb2RlcyA9IHsNCiAgICAJICAgICAgICBleHBvcnRlcjogIiIsDQogICAgCSAgICAgICAgSWQ6ICIiLA0KICAgIAkgICAgfTsNCiAgICAJICAgIA0KICAgIAkJaWYgKCFvcHRpb25zLlVuaXF1ZSAmJiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCkpIHRoaXMuX19vcHRpb25zKCJJZCIsIG9iaiwgZWFDb2Rlcy5JZCA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ0lkJyk6J0lkJyksIHRoaXMuSWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQogICAgCQkNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVmLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoImVmXzwlPW5OYW1lKGVmKSU+Iiwgb2JqLCBlYUNvZGVzLmVmXzwlPW5OYW1lKGVmKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWYpJT46PCVfdkNvZGUoZWYpJT4pLCA8JXZhbHVlT2YoZWYuVmFsdWUpJT4sIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQo8JSB9KSU+DQoNCgkJICAgIDwlIHVuUmVjdXJzZSgnb2JqJywgJ2Z1bicsICdmQXJncycsICdpZih0eXBlb2Yob3B0aW9ucy5leHBvcnRlcik9PT0iZnVuY3Rpb24iKSBvcHRpb25zLmV4cG9ydGVyKHYpJyklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiAhZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiX1RISVMiLCBvYmosIGVhQ29kZXMuX1RISVMgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdfVEhJUycpOiJfVEhJUyIpLCB0aGlzLl9USElTLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT10YU5hbWUlPiIsIG9iaiwgZWFDb2Rlcy48JT10YU5hbWUlPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKHRhLCB0cnVlKSU+OiI8JT10YU5hbWUlPiIpLCB0aGlzLjwlPXRhTmFtZSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQodGEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICAgICAgT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pPT09J2Z1bmN0aW9uJyAmJiAhT2JqZWN0LmtleXMoZWFDb2RlcykuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiB0aGlzLl9fb3B0aW9ucyhrLCBvYmosIGssIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKSk7DQogICAgICAgIA0KICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gfHwge307DQogICAgICAgICAgICAoPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgfHwgW10pLmZvckVhY2gobiA9PiBuLl9jW24uZWFGaWVsZF0obi5fY1tuLmVhRmllbGRdKCkuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub0FyZ3M6IHRydWUsIF9tYXA6IG9wdGlvbnMuX21hcH0sIGZ1bikpKTsNCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljID0gW107IC8vPz8NCiAgICAgICAgICAgIA0KICAgIAkJcmV0dXJuIG9iajsNCiAgICAJfWNhdGNoKGV4KXsNCiAgICAJICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAJfQ0KCX0NCgkNCgk8JT1tTmFtZT0nX19vcHRpb25zJyU+KGZpZWxkLCBvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzPXRoaXMsIG9wdGlvbnM9e30sIGZ1biwgZWFGaWVsZCl7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZmllbGQsIG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXMsIG9wdGlvbnMsIGZ1biwgZWFGaWVsZCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsNCiAgICAgICAgICAgIGlmKCFvYmopIHJldHVybjsNCiAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkhPT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZWFPYmopIT09J3VuZGVmaW5lZCcgJiYgIW9wdGlvbnMuTnVsbCl7DQogICAgICAgICAgICAgICAgaWYoZmllbGQhPSdJZCcgJiYgdHlwZW9mKF90aGlzW2ZpZWxkXSk9PT0nZnVuY3Rpb24nICYmICFfdGhpc1snXycrZmllbGQrJ19zZXQnXSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpIT09J3VuZGVmaW5lZCcpIGVhT2JqID0gZWFPYmouZmlsdGVyKHYgPT4gdik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLk51bGwgJiYgQXJyYXkuaXNBcnJheShlYU9iaikgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOw0KDQogICAgICAgICAgICBsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXMpOw0KICAgICAgICAgICAgaWYob3B0aW9ucy5PUEVSQVRPUlMgJiYgX3RoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwge1tmaWVsZF06IF90aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ119KTsNCg0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuQ3ljbGljICYmIGVhRmllbGQgJiYgb2JqICYmIG9iai5FbnRpdHlDbGFzcyAmJiB0eXBlb2Yob2JqW2ZpZWxkXSk9PT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSB8fCB7fTsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljIHx8IFtdOw0KICAgICAgICAgICAgICAgIGxldCBfY3ljbGVzID0gb2JqW2ZpZWxkXSgpOw0KICAgICAgICAgICAgICAgIGlmKCFBcnJheS5pc0FycmF5KF9jeWNsZXMpKSBfY3ljbGVzID0gW19jeWNsZXNdOw0KICAgICAgICAgICAgICAgIF9jeWNsZXMgPSBfY3ljbGVzLmZpbHRlcihfYyA9PiBfYyAmJiB0eXBlb2YoX2NbZWFGaWVsZF0pPT09J2Z1bmN0aW9uJyAmJiBfY1snXycgKyBlYUZpZWxkICsgJ19zZXQnXSAmJiBvYmouX3NhbWVFbnRpdHkoX2NbZWFGaWVsZF0oKSkpLm1hcChfYyA9PiAoew0KICAgICAgICAgICAgICAgICAgICAvKm1hcmsgX2NbZWFGaWVsZF1fc2V0IHRvIG51bGwgaW5zdGVhZCovDQogICAgICAgICAgICAgICAgICAgIF9jLA0KICAgICAgICAgICAgICAgICAgICBlYUZpZWxkLA0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgICAgICAgICBpZihfY3ljbGVzLmxlbmd0aCkgPCU9d2FybigpJT5mdW4gKyAiL19jeWNsZXMiLCBfY3ljbGVzKTsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYy5wdXNoKC4uLl9jeWNsZXMpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZihvcHRpb25zLl9tYXApIF90aGlzLl9tYXAoZmllbGQsIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJywgZnVuLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCc/b2JqOmVhT2JqLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCc/X3RoaXM6b2JqLCBlYUNvZGUpOw0KDQogICAgICAgICAgICByZXR1cm4gX3JldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmZ1biwgZmllbGQsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KCQ0KCTwlPW1OYW1lPSdfX2ltcG9ydCclPihvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsNCiAgICAgICAgaWYodHlwZW9mKG9iaikhPT0nb2JqZWN0Jyl7DQogICAgICAgICAgICA8JT13YXJuKCklPmAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQoJICAgIA0KICAgICAgICBsZXQgZWFDb2RlcyA9IHt9Ow0KDQoJCXRoaXMuX19vcHRpb25zKCJJZCIsIG9iaiwgZWFDb2Rlcy5JZCA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ0lkJyk6J0lkJyksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCgkJDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQoJCTwlIHVuUmVjdXJzZSgndGhpcycsICdmdW4nLCAnZkFyZ3MnLCAnaWYodHlwZW9mKG9wdGlvbnMuaW1wb3J0ZXIpPT09ImZ1bmN0aW9uIikgb3B0aW9ucy5pbXBvcnRlcih2KScpJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgIWVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQoJCXRoaXMuX19vcHRpb25zKCJfVEhJUyIsIG9iaiwgZWFDb2Rlcy5fVEhJUyA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ19USElTJyk6J19USElTJyksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4gew0KICAgIGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOw0KJT4NCiAgICAgICAgdGhpcy5fX29wdGlvbnMoIjwlPXRhTmFtZSU+Iiwgb2JqLCBlYUNvZGVzLjwlPXRhTmFtZSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUodGEsIHRydWUpJT46IjwlPXRhTmFtZSU+IiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZCh0YSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgIE9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKT09PSdmdW5jdGlvbicgJiYgIU9iamVjdC5rZXlzKGVhQ29kZXMpLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gdGhpcy5fX29wdGlvbnMoaywgb2JqLCBrLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bikpOw0KDQoJCXJldHVybiB0aGlzOw0KCX0NCg0KPCUgaWYobWFpbkNsYXNzKFsnTmVvNGonXSkpeyU+DQogICAgPCU9bU5hbWU9J190b0N5VGFibGUnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2NxbDogYA0KQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSBJUyBVTklRVUU7DQpDUkVBVEUgQ09OU1RSQUlOVCBJRiBOT1QgRVhJU1RTIEZPUiAobzokezwlPV9uQ29kZSgpJT59KSBSRVFVSVJFIG8uJHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9IElTIE5PVCBOVUxMOw0KICAgICAgICBgfSwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgb2JqLmNxbCArPSB2P3YuPCU9bU5hbWUlPigpOicnOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1VuaXF1ZSl7JT4NCiAgICAgICAgICAgICAgICBvYmouY3FsICs9IGBDUkVBVEUgQ09OU1RSQUlOVCBJRiBOT1QgRVhJU1RTIEZPUiAobzokezwlPV9uQ29kZSgpJT59KSBSRVFVSVJFIG8uJHtlYUNvZGV9IElTIFVOSVFVRTsNCmANCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLmNxbCArPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpLmpvaW4oJ1xuJyksDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQuY3FsKTsNCiAgICAgICAgcmV0dXJuIHJldC5jcWw7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9DeU1lcmdlJyU+KGZpZWxkcywgYlJhdyl7DQogICAgICAgIGxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcywgdHJ1ZSk7DQogICAgICAgIGxldCB1a2V5cyA9IFtdOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSB1a2V5cy5wdXNoKDwlPV9uQ29kZShlYSklPik7DQogICAgPCUgfSklPg0KICAgICAgICBsZXQgY3FsID0gYDokezwlPV9uQ29kZSgpJT59IHtgICsgT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB1a2V5cy5pbmNsdWRlcyhrKSkubWFwKGsgPT4gayArICI6ICIgKyBvYmpba10pLmpvaW4oJywgJykgKyBgfSlgOw0KICAgICAgICANCiAgICAgICAgaWYoIWJSYXcpew0KICAgICAgICAgICAgbGV0IG1hdGNoID0gJ1xuTUFUQ0ggKG8nICsgY3FsOw0KICAgICAgICAgICAgY3FsID0gJ01FUkdFIChvJyArIGNxbDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG9uU2V0ID0gT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiAhdWtleXMuaW5jbHVkZXMoaykpLm1hcChrID0+ICJvLiIgKyBrICsgIj0iICsgb2JqW2tdKS5qb2luKCcsICcpDQogICAgICAgICAgICBjcWwgKz0gJ1xuT04gQ1JFQVRFIFNFVCAnICsgb25TZXQgKyAnXG5PTiBNQVRDSCBTRVQgJyArIG9uU2V0Ow0KICAgICAgICAgICAgY3FsICs9ICdcblJFVFVSTiBvOyc7DQoNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgY3FsICs9IG1hdGNoICsgJywgJyArIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KG51bGwsIHRydWUpLnJlcGxhY2UoJyg6JywgJyg8JT1uTmFtZShlYSklPjonKSArICcgTUVSR0UgKG8pLVs6PCU9bk5hbWUoYyklPl88JT1uTmFtZShlYSklPl0tPig8JT1uTmFtZShlYSklPik7JzsNCiAgICA8JSB9KSU+DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgY3FsID0gJygnICsgY3FsOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+Y3FsKTsNCiAgICAgICAgcmV0dXJuIGNxbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvQ3lRdWVyeSclPihmaWVsZHMsIG9ianMpew0KICAgICAgICBsZXQgc3FsID0gIk1BVENIICI7DQogICAgICAgIA0KICAgICAgICBsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCl9JHt0aGlzLl9RKCl9YDsNCg0KICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsNCg0KICAgICAgICBzcWwgKz0gYCAoJHt0UHJlZn06JHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgICAgICANCiAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGAgT1BUSU9OQUwgTUFUQ0ggKCR7dGhpcy5fUSgpfSR7a30ke3RoaXMuX1EoKX06JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9KSBPUFRJT05BTCBNQVRDSCAoJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCl9JHt0aGlzLl9RKCl9KS1bOiR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9XS0+KCR7dGhpcy5fUSgpfSR7a30ke3RoaXMuX1EoKX0pYCk7DQogICAgICAgIA0KDQogICAgICAgIC8vc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOw0KICAgICAgICAvL09iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOw0KICAgICAgICANCiAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcyl7DQogICAgICAgICAgICAvLyB7ZmllbGQ6IGZ1bmN0aW9ufQ0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT59KCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KDQogICAgICAgIHNxbCArPSBgIHdoZXJlIDE9MWA7DQoNCiAgICAgICAgc3FsID0gdGhpcy5fX2V4cG9ydCh7c3FsOiBzcWx9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UICI7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICIiOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICIiOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICIiOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke2Nvb3B9IEVYSVNUUyB7JHt2LjwlPW1OYW1lJT4oKX19YDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCB8fCBlYS5Jc0ltYWdlIHx8IGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArIDwlaWYoZWEuSXNCb29sKXslPiI9IjwlfWVsc2V7JT4odGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCB8fCAiQ09OVEFJTlMiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArIHYgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0iYm9vbGVhbiIpew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICh2PyIxIjoiMCIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiKCIgKyB2LjwlPW1OYW1lJT4oKSArICIpIjsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPXRhTmFtZSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIikpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBqT1AgPSAnVU5JT04gQUxMJzsNCiAgICAgICAgICAgICAgICBsZXQgaW5PUCA9ICdJTic7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nIT0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdOT1QgSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgaW5PUCA9ICdOT1QgSU4nOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nSU4nKXsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPT0nKXsNCiAgICAgICAgICAgICAgICAgICAgak9QID0gJ0lOVEVSU0VDVCc7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGFuZCAvKjwlPXRhTmFtZSU+Ki8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGZpZWxkcykuc3FsOw0KDQogICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcyl7DQogICAgICAgICAgICBpZihPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+fWA7DQogICAgPCUgfSklPg0KICAgICAgICB9DQoNCiAgICAgICAgaWYoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSl7DQogICAgICAgICAgICAvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc3FsICs9ICcgcmV0dXJuICcgKyBbdFByZWZdLmNvbmNhdChPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLm1hcChrID0+IGAke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9YCkpLmpvaW4oJywgJyk7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzcWw7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19uZW80aiclPihjcWwpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pPT1jKXslPg0KICAgICAgICBsZXQgc2Vzc2lvbiA9IG51bGw7DQogICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYiB8fCAhY3FsIHx8ICFjcWwudHJpbSgpKXsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+Y3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gW107DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBpZihjcWwuaW5kZXhPZignO1xuJyk+MCl7DQogICAgICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIGNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLjwlPW1OYW1lJT4oc3FsUy50cmltKCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBiU3RvcmUgPSBbIk1FUkdFIiwgIkNSRUFURSIsICJVUERBVEUiXS5maWx0ZXIobiA9PiBjcWwuaW5kZXhPZihuKT49MCkuZmluZChuID0+IG4pOw0KICAgICAgICAgICAgbGV0IGJETUwgPSBbIkNPTlNUUkFJTlQiXS5maWx0ZXIobiA9PiBjcWwuaW5kZXhPZihuKT49MCkuZmluZChuID0+IG4pOw0KDQogICAgICAgICAgICBpZihiRE1MKXsNCiAgICAgICAgICAgICAgICB0aGlzLlRvb2wuZG1sQ2FjaGUgPSB0aGlzLlRvb2wuZG1sQ2FjaGUgfHwge307DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoY3FsKV0pIHJldHVybjsNCiAgICAgICAgICAgICAgICB0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShjcWwpXSA9IGNxbDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgc2Vzc2lvbiA9IHRoaXMuVG9vbC5kYi5zZXNzaW9uKHsgZGF0YWJhc2U6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJykgfSk7DQogICAgICAgICAgICBsZXQgZnVuID0gJ1JlYWQnOw0KICAgICAgICAgICAgaWYoYlN0b3JlIHx8IGJETUwpIGZ1biA9ICdXcml0ZSc7DQogICAgICAgICAgICBpZihmdW49PSdXcml0ZScpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChjcWwpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgICAgICAvL3JldCA9IChhd2FpdCBzZXNzaW9uWydleGVjdXRlJytmdW5dKHR4ID0+IHR4LnJ1bihjcWwpKSkucmVjb3JkczsNCiAgICAgICAgICAgIC8vPCU9bG9nKCklPnJldCk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgaWYoc2Vzc2lvbikgYXdhaXQgc2Vzc2lvbi5jbG9zZSgpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydOZW80aiddKSklPigpLjwlPW1OYW1lJT4oY3FsKTsNCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnUnhEQicsICdNb25nb0RCJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9KU09OU2NoZW1hJyU+KCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygnanNvbi50eXBlJywgJ3R5cGUnKTsNCiAgICAgICAgICAgIGxldCBzY2hlbWEgPSB7DQogICAgICAgICAgICAgICAgJGlkOiAnPCU9Yy5JZCU+JywNCiAgICAgICAgICAgICAgICAkc2NoZW1hOiAiaHR0cHM6Ly9qc29uLXNjaGVtYS5vcmcvZHJhZnQvMjAyMC0xMi9zY2hlbWEiLA0KICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnPCU9Yy5SZW1hcmslPicsDQogICAgICAgICAgICAgICAgdGl0bGU6IDwlPV9uQ29kZSgpJT4sDQogICAgICAgICAgICAgICAgW3R5cGVdOiAnb2JqZWN0JywNCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiAwLA0KICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBbPCU9X25Db2RlKGVhKSU+XTogew0KICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICI8JT1lYS5SZW1hcmslPiIsDQogICAgICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuYXJyYXknLCAnYXJyYXknKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiB7DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICAkcmVmOiAnPCU9ZWEuRW50aXR5Q2xhc3MuSWQlPicsDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLnN0cmluZycsICdzdHJpbmcnKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLnRleHQnLCAnc3RyaW5nJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5ib29sJywgJ2Jvb2xlYW4nKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuaW50JywgJ2ludGVnZXInKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5mbG9hdCcsICdudW1iZXInKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW1hZ2UpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5pbWFnZScsICdvYmplY3QnKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmZpbGUnLCAnb2JqZWN0JyksDQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBbPCVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuUmVxdWlyZWQpLm1hcChlYSA9PiB7JT48JT1fbkNvZGUoZWEpJT48JX0pLmpvaW4oJywnKSU+XSwNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT5zY2hlbWEpOw0KICAgICAgICAgICAgcmV0dXJuIHNjaGVtYTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydNb25nb0RCJywgJ1J4REInLCAnWmFuZ29EQiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU2VsZWN0TWRiJyU+KCl7DQogICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBfVEhJUzogb2JqID0+IG9iai5faWQgPSB7JGluOiB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPigpKX0sDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5faWQgPSB0aGlzLklkLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKCF2LjwlPW1OYW1lJT4pIHJldHVybjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7fTsNCiAgICAgICAgICAgICAgICBsZXQgb3AgPSAiJGUiOw0KICAgICAgICAgICAgICAgIHN3aXRjaCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKXsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPiI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZ3QiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIjwiOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGx0IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI+PSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZ3RlIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI8PSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkbHRlIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkbmUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIklOIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRpbiI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXVtvcF0gPSB2LjwlPW1OYW1lJT4oKS50b0lTT1N0cmluZygpOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSB7JGluOiB2Lm1hcCh0ID0+IHQuPCU9bU5hbWUlPigpKX0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvREJPYmplY3QnJT4oZmllbGRzLCBiTm9SZWYpew0KICAgICAgICBpZighdGhpcy5JZCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsNCiAgICAgICAgfQ0KICAgICAgICBsZXQgcmV0ID0gew0KICAgICAgICAgICAgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyINCiAgICAgICAgfTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICBpZigoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9ZWEuTmFtZSU+IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiAoIWJOb1JlZiB8fCA8JT1lYS5FbnRpdHlUeXBlPydmYWxzZSc6J3RydWUnJT4pKXsNCiAgICAgICAgICAgIGxldCBmVmFsdWUgPSBudWxsOw0KICAgICAgICAgICAgbGV0IHYgPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZih2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQ9PXYuSWQpKXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIk5VTEwiOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2PzE6MDsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZT8nVHJ1ZSc6J0ZhbHNlJzsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdTcWxEQicpIGZWYWx1ZSA9ICInIiArIGZWYWx1ZSArICInIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2IHx8ICcwJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArICh2P3YudG9JU09TdHJpbmcoKToiMTk3MC0xLTEiKSArICInIjsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc09iamVjdCl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIEpTT04uc3RyaW5naWZ5KHYsIG51bGwsICdcdCcpICsgIiciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9IHY9PT1udWxsPyJOVUxMIjooIiciICsgKChmYWxzZSAmJiB2ICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKC9cXG4vZywgIlxcXFxuIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcJy9nLCAiXFxcXCciKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICdcXFxcIicpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCYvZywgIlxcXFwmIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcci9nLCAiXFxcXHIiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFx0L2csICJcXFxcdCIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXGIvZywgIlxcXFxiIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcZi9nLCAiXFxcXGYiKSAgOnYpICsgIiciKTsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgaWYodj09PW51bGwpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICJOVUxMIjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdTcWxEQicpew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J215c3FsJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBGUk9NX0JBU0U2NCgnJHt0aGlzLl9idG9hKHYpfScpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYGNhc3QodW5oZXgoJyR7di5zcGxpdCgiIikubWFwKHggPT4gKDI1NiArIHguY2hhckNvZGVBdCgpKS50b1N0cmluZygxNikuc3Vic3RyKC0yKSkuam9pbigiIil9JykgYXMgdmFyY2hhcilgOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSB2Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdiArICInIjsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXRbPCU9X25Db2RlKGVhKSU+ICsgIjwlPShlYS5FbnRpdHlUeXBlPydpZCc6JycpJT4iXSA9IGZWYWx1ZTsNCiAgICAgICAgfQ0KICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J2dldCclPihuYW1lKSB7DQogICAgICAgIGlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7DQogICAgICAgIHZhciB0ID0gbnVsbDsNCiAgICAgICAgJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsNCiAgICAgICAgICAgIHQgPSB7DQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB0ID8gew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFt0XQ0KICAgICAgICAgICAgICAgIH0gOiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgSWQ6IHRoaXMuSWQNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KICAgICAgICAgICAgICAgICAgICBOYW1lOiBmLA0KICAgICAgICAgICAgICAgICAgICBPUEVSQVRPUlM6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI9Ig0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsNCiAgICAgICAgICAgIDwlPWxvZygpJT5ldik7DQogICAgICAgICAgICBpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsNCg0KICAgICAgICAgICAgaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPlskLmdyZXAoPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsNCiAgICAgICAgfSk7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpKXslPg0KICAgIDwlPW1OYW1lPSdfUSclPigpew0KICAgICAgICBsZXQgX28gPSAnIic7DQogICAgICAgIGxldCBfcSA9IF9vOw0KDQogICAgICAgIGlmKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk9PTApew0KICAgICAgICAgICAgX28gPSBfcSA9ICIiOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZT09J05lbzRqJyl7DQogICAgICAgICAgICBfbyA9IF9xID0gJ2AnOw0KICAgICAgICB9ZWxzZSBpZihbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpPT0wKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSBgJ2A7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbHNlcnZlcicpew0KICAgICAgICAgICAgX28gPSAnWyc7DQogICAgICAgICAgICBfcSA9ICddJzsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygnYXBpS2V5Jyk9PSdhaXJ0YWJsZScpew0KICAgICAgICAgICAgX28gPSAneyc7DQogICAgICAgICAgICBfcSA9ICd9JzsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX28/X3E6X287DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmllbGRHcm91cHMnJT4oZmdzID0ge30pew0KICAgICAgICB0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2ZpZWxkQWdncmVnYXRlcyclPihmYXMgPSB7fSl7DQogICAgICAgIHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvRmllbGRzU1FMJyU+KGZpZWxkcyl7DQogICAgICAgIA0KICAgICAgICBmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSwgPCU9Yy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gX25Db2RlKGVhKSArIChlYS5FbnRpdHlUeXBlPycrIi5pZCInOicnKSkuam9pbignLCcpJT5dOw0KICAgICAgICBmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcyk/ZmllbGRzOltmaWVsZHNdOw0KDQogICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcyl7DQogICAgICAgICAgICAvLyB7ZmllbGQ6IG9yZGVyfQ0KICAgICAgICAgICAgZmllbGRzID0gW107DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIGZpZWxkcy5wdXNoKGAkezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59YCk7DQogICAgPCUgfSklPg0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmaWVsZHM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZnJvbURCT2JqZWN0JyU+KHI9e30pew0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7DQogICAgICAgICAgICAgICAgSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ob2JqW2VhQ29kZV0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU2VsZWN0SGVhZGVyJyU+KGZpZWxkcyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSB7DQogICAgICAgICAgICAgICAgdGFibGU6IDwlPV9uQ29kZSgpJT4sDQogICAgICAgICAgICAgICAgZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksDQogICAgICAgICAgICAgICAgam9pbnM6IHt9LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoZmllbGRzKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1NlbGVjdFNRTCclPihmaWVsZHMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgc3FsID0gInNlbGVjdCAiOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOw0KDQogICAgICAgICAgICBzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7DQogICAgICAgICAgICBPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsNCiAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpew0KICAgICAgICAgICAgICAgIC8vIHtmaWVsZDogZnVuY3Rpb259DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT59KCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgIHNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNxbCArPSBgIHdoZXJlIDE9MWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNxbCA9IHRoaXMuX19leHBvcnQoe3NxbDogc3FsfSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCk/WydJZCddOnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHYucmV1c2VkPjIpew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9d2FybigpJT4iUmV1c2VkOiAiLCB2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHYub2JqLnNxbCA9IGAvKlJFU1VFRDogJHt2LnJldXNlZH0qL2A7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIF9USElTOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCAvKmFuZCAqLyR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPih0Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCcpLnRoaXMpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmouc3FsICs9ICh0aGlzLklkPT10aGlzLklkKT9gIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDonJywNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHYgJiYgdi50b0lTT1N0cmluZyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiKCIgKyB2LjwlPW1OYW1lJT4oKSArICIpIjsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPXRhTmFtZSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IGpPUCA9ICdVTklPTiBBTEwnOw0KICAgICAgICAgICAgICAgICAgICBsZXQgaW5PUCA9ICdJTic7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nIT0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdOT1QgSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluT1AgPSAnTk9UIElOJzsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdJTicpew0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPT0nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGpPUCA9ICdJTlRFUlNFQ1QnOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBhbmQgLyo8JT10YU5hbWUlPiovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuPCU9bU5hbWUlPigiPCU9bk5hbWUodGEpJT4uaWQiKSkuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGZpZWxkcykuc3FsOw0KDQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgICAgIGlmKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+fWA7DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZighc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSl7DQogICAgICAgICAgICAgICAgc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSE9PSd1bmRlZmluZWQnP3NxbEZvcm1hdHRlci5mb3JtYXQoc3FsKTpzcWw7DQogICAgICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHNxbDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvUGF0aHMnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4ge30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+ID0gdi48JT1tTmFtZSU+KCksDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9dGFOYW1lJT4gPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgLy8gcmV0dXJuIHJldDsNCiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHtba106IHJldFtrXX0pKTsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvVXBkYXRlU1FMJyU+KGZpZWxkcyl7DQogICAgICAgIGxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOw0KICAgICAgICBsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7DQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9JbnNlcnRTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsNCiAgICAgICAgbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsNCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIHJldHVybiBzcWw7DQogICAgfQ0KPCUgfSAlPg0KICAgIA0KICAgIDwlPW1OYW1lPSdfY29weUZyb20nJT4ob2JqKXsNCiAgICAgICAgaWYoIW9iaikgcmV0dXJuIG51bGw7DQogICAgICAgIHJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b09ialRyZWUnJT4oYkN5Y2xpYyl7DQogICAgICAgIDwlPXdhcm4oKSU+ImRlcHJlY2F0ZWQiKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIA0KICAgICAgICB0aGlzLl9kZWZhdWx0cygpOw0KDQogICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLk5hbWUsIHRydWUpJT4oJzwlPWMuTmFtZSU+JyksIHsNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBDeWNsaWM6IGJDeWNsaWMsDQogICAgICAgICAgICAvL2V4cG9ydGVyOiB2ID0+IDwlPXdhcm4oKSU+di5yZXVzZWQpLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPig8JWlmKGVhLkVudGl0eVR5cGUpeyU+bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KGJDeWNsaWMpPCV9ZWxzZXslPnY8JX0lPiksDQogICAgPCUgfSk7JT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT10YU5hbWUlPihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KGJDeWNsaWMpKSwNCiAgICA8JSB9KTslPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3VuQ3ljbGUnJT4oc291cmNlPXRoaXMpew0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh0aGlzLCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KHNvdXJjZT09b2JqLjwlPW5OYW1lKGVhKSU+KCk/bnVsbDp1bmRlZmluZWQpLA0KICAgIDwlIH0pOyU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB0cnVlLA0KICAgIDwlIH0pOyU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdfc3RvcmVFbnRpdHlDbGFzcyclPihkZXB0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihkZXB0aCk9PT0idW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsNCiAgICAgICAgICAgIGlmKCFkZXB0aCkgcmV0dXJuOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLlRvb2wuPCU9bU5hbWUlPiA9IHRoaXMuVG9vbC48JT1tTmFtZSU+IHx8IHt9Ow0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLjwlPW1OYW1lJT4uPCU9bk5hbWUoYyklPikgcmV0dXJuOw0KICAgICAgICAgICAgdGhpcy5Ub29sLjwlPW1OYW1lJT4uPCU9bk5hbWUoYyklPiA9IHRydWU7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5gc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOw0KICAgICAgICAgICAgDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLkRTQ29ubmVjdCgpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik5lbzRqIil7JT4NCiAgICAgICAgICAgICAgICBsZXQgY3FsID0gdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9DeVRhYmxlKGRlcHRoKTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Y3FsKTsNCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aihjcWwpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJBaXJUYWJsZSIpeyU+DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fYWlydGFibGUoJ21ldGEvYmFzZXMnLCBudWxsLCB7bmFtZTogJzwlPXNjb3BlJT4nLCB3b3Jrc3BhY2VJZDogdGhpcy5Ub29sLmRiLndvcmtzcGFjZUlkLCB0YWJsZXM6IHRoaXMuX3RvQVRUYWJsZShkZXB0aCl9KTsNCiAgICA8JSB9ZWxzZSBpZihfc3FsVG9vbHMuaW5kZXhPZih0KT49MCl7JT4NCiAgICAgICAgICAgICAgICBsZXQgc3FsID0gdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TUUxUYWJsZSh7cmV1c2VkOiAzfSk7IDwlLypkZXB0aDogY2hhbGxlbmdlIC0gdG9vIGxvdyBkb2VzIG5vdCBjb3ZlciBhbGwgdGFibGVzLCB0b28gaGlnaCAobWF4IGRlcHRoKSByZXN1bHRzIGluIG91dC1vZi1tZW1vcnkgb24gYnJvd3NlciovJT4NCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoc3FsKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyU+DQogICAgICAgICAgICAgICAgLy88JT1sb2coKSU+dGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlRhYmxlKCkpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJFTVMiKXslPg0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TQ2xhc3MoZGVwdGgpLnN0b3JlKCk7DQogICAgPCUgfWVsc2UgaWYodD09IkJJU2VydmVyIil7JT4NCiAgICAgICAgICAgICAgICAvLyBvbmx5IGRvIHRoaXMgaWYgdGhlIG1vZHVsZSBpcyBub3QgbG9hZGVkIGZyb20gDQogICAgICAgICAgICAgICAgKGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBDb21wYW55OiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvZGU6IHRoaXMuX19jb25maWcoJ2NvbXBhbnknLCAnPCU9c2NvcGUlPicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIH0pKS5mb3JFYWNoKGVhID0+IC8qIHRyeWUgX2VhVHlwZXMgKi88JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChzZWEgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihzZWEuSWQhPT1lYS5JZCAmJiBzZWEuTmFtZT09ZWEuTmFtZSAmJiAoc2VhLkVudGl0eUNsYXNzLklkPT1lYS5FbnRpdHlDbGFzcy5JZCB8fCBzZWEuRW50aXR5Q2xhc3MuTmFtZT09ZWEuRW50aXR5Q2xhc3MuTmFtZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgc2VhLklkID09IGVhLklkOw0KICAgICAgICAgICAgICAgICAgICAgICAgc2VhLkVudGl0eUNsYXNzLklkID0gZWEuRW50aXR5Q2xhc3MuSWQ7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZT09c2VhLkVudGl0eUNsYXNzLk5hbWUpLkVudGl0eUF0dHJpYnV0ZXMuZmluZChzY2VhID0+IHNjZWEuTmFtZT09ZWEuTmFtZSkuSWQgPSBlYS5JZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iTW9uZ29EQiIgfHwgdD09IlphbmdvREIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgYXdhaXQgdGhpcy5Ub29sLmRiLmNyZWF0ZUNvbGxlY3Rpb24oPCU9X25Db2RlKCklPiwge3ZhbGlkYXRvcjogeyRqc29uU2NoZW1hOiB0aGlzLl90b0pTT05TY2hlbWEoKX19KTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iUnhEQiIpeyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRiKSBhd2FpdCB0aGlzLlRvb2wuZGIuYWRkQ29sbGVjdGlvbnMoe1s8JT1fbkNvZGUoKSU+XToge3NjaGVtYTogdGhpcy5fdG9KU09OU2NoZW1hKCl9fSk7DQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19sb2cnJT4ob2JqPXRoaXMpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KG9iaik7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBvYmoubWFwKG8gPT4gdGhpcy5fbG9nKG8pKTsNCiAgICAgICAgICAgIGlmKG9iai5FbnRpdHlDbGFzcykgb2JqID0gb2JqLl90b0pTT04oe2JNYXA6IHRydWV9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5vYmopOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdEU0Nvbm5lY3QnJT4odG9vbD10aGlzLlRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KHRvb2wpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXRvb2wpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJUb29sIGlzIG51bGwiLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKCF0b29sLnR5cGUpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJUb29sLnR5cGUgaXMgbnVsbCIsIHRvb2wsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHRvb2wuZGIpIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iVG9vbCBhbHJlYWR5IGNvbm5lY3RlZCEiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZig8JT1uc2NvcGUlPi5fbm9kZSAmJiAvKjwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnRfc2V0ICYmICovPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Ik5vZGUgaGFzIGEgdmFsaWQgcGFyZW50LCBubyBsb2NhbCBTUUwgcG9zc2libGUiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRvb2wuX19kbWxTdGF0ZW1lbnRzID0gdG9vbC5fX2RtbFN0YXRlbWVudHMgfHwgW107DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICA8JT1sb2coKSU+Ils8JT10JT5dOiBDb25uZWN0aW5nLi4uIik7DQoNCiAgICAgICAgICAgIGlmKHRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09IkVNUyIpeyU+DQogICAgPCUgfWVsc2UgaWYodD09Ik1vbmdvREIiKXslPg0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPnRoaXMuX19jb25maWcoJ3VyaScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ2NvbmZpZycsIG51bGwsIHt0b29sOiB0b29sfSkpOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtb25nb2RiKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IChhd2FpdCBuZXcgbW9uZ29kYi5Nb25nb0NsaWVudCh0aGlzLl9fY29uZmlnKCd1cmknLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdjb25maWcnLCBudWxsLCB7dG9vbDogdG9vbH0pKS5jb25uZWN0KCkpLmRiKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pKTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYodD09J1J4REInKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBhd2FpdCBSeERCLmNyZWF0ZVJ4RGF0YWJhc2Uoe25hbWU6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pLCBzdG9yYWdlOiBudWxsfSk7DQogICAgPCUgfWVsc2UgaWYodD09J1phbmdvREInKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgemFuZ28uRGIodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCAiPCU9c2NvcGUlPiIsIHt0b29sOiB0b29sfSksIHsNCiAgICAgICAgPCUgYXJDbGFzc2VzLmZvckVhY2goZWMgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVjKSU+OiBbIjwlPWVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBuTmFtZShlYSkpLmpvaW4oJ1wiLCBcIicpJT4iXSwNCiAgICAgICAgPCUgfSkgJT4NCiAgICAgICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZSBpZih0PT0nS2Fma2EnKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihrYWZrYWpzKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBrYWZrYWpzLkthZmthKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudElkOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBicm9rZXJzOiBbdGhpcy5fX2NvbmZpZygnYnJva2VycycsIG51bGwsIHt0b29sOiB0b29sfSldLA0KICAgICAgICAgICAgICAgICAgICAgICAgc3NsOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgc2FzbDogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Nhc2xfcGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lY2hhbmlzbTogdGhpcy5fX2NvbmZpZygnc2FzbF9tZWNoYW5pc21zJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uVGltZW91dDogMzAwMCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIHRvb2wucHJvZHVjZXIgPSB0b29sLmRiLnByb2R1Y2VyKCk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wucHJvZHVjZXIuY29ubmVjdCgpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgdG9vbC5jb25zdW1lciA9IHRvb2wuZGIuY29uc3VtZXIoe2dyb3VwSWQ6IHRoaXMuX19jb25maWcoJ2NsaWVudElkJywgbnVsbCwge3Rvb2w6IHRvb2x9KX0pOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLmNvbnN1bWVyLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5jb25zdW1lci5zdWJzY3JpYmUoew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICc8JT1zY29wZSU+LmNhbGwnLA0KICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUJlZ2lubmluZzogZmFsc2UsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICA8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgICAgICAgICAgICAgICAgIHRvb2wuY29uc3VtZXIucnVuKHtlYWNoTWVzc2FnZTogYXN5bmMgKHsgdG9waWMsIHBhcnRpdGlvbiwgbWVzc2FnZSB9KSA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0V2ZW50JywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQobWVzc2FnZS52YWx1ZS50b1N0cmluZygpKS5wcm9jZXNzKCl9KTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09J01lbW9yeScpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IHsNCiAgICAgICAgPCUgYXJDbGFzc2VzLmZvckVhY2goZWMgPT4geyU+DQogICAgICAgICAgICAgICAgICAgICc8JT1uTmFtZShlYyklPic6IFtdLA0KICAgICAgICA8JSB9KTsgJT4NCiAgICAgICAgICAgICAgICB9Ow0KICAgIDwlfWVsc2UgaWYodD09IkV4Y2VsIil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5kYiA9IDwlPXNjb3BlJT4ueGxzeERhdGE/WExTWC5yZWFkKDwlPXNjb3BlJT4ueGxzeERhdGEpOlhMU1gudXRpbHMuYm9va19uZXcoKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5kYiA9IFhMU1gucmVhZChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdmaWxlbmFtZScsIG51bGwsIHt0b29sOiB0b29sfSkpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCV9ZWxzZSBpZih0PT0iU25vd0ZsYWtlIil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnICYmIGdsb2JhbC5zbm93Zmxha2Upew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gZ2xvYmFsLnNub3dmbGFrZS5jcmVhdGVDb25uZWN0aW9uKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHRoaXMuX19jb25maWcoImFjY291bnQiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuX19jb25maWcoInVzZXJuYW1lIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCJwYXNzd29yZCIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbjogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICI8JT1zY29wZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYi5jb25uZWN0KChlcnIsIGNvbm4pPT57DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPidVbmFibGUgdG8gY29ubmVjdDogJyArIGVyci5tZXNzYWdlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqKGVycik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYi5jb25uZWN0aW9uX0lEID0gY29ubi5nZXRJZCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09Ik5lbzRqIil7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gbmVvNGouZHJpdmVyKA0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9fY29uZmlnKCd1cmwnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICBuZW80ai5hdXRoLmJhc2ljKHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygncGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pKQ0KICAgICAgICAgICAgICAgICk7DQogICAgPCV9ZWxzZSBpZih0PT0iQWlyVGFibGUiKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSB7DQogICAgICAgICAgICAgICAgICAgIGJhc2VJZDogJycsDQogICAgICAgICAgICAgICAgICAgIHdvcmtzcGFjZUlkOiB0aGlzLl9fY29uZmlnKCd3b3Jrc3BhY2VJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnLA0KICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICAgICAgICAgIHVzZXJJZDogKGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL3dob2FtaScpKS5pZCwNCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAgICAgbGV0IGJhc2VzID0gKGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL2Jhc2VzJykpLmJhc2VzOw0KICAgICAgICAgICAgICAgIGlmKGJhc2VzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuYmFzZUlkID0gYmFzZXMuZmlsdGVyKGIgPT4gYi5uYW1lPT0nPCU9c2NvcGUlPicpLmlkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiLmJhc2VJZCkgdG9vbC5kYi5iYXNlSWQgPSAnYXBwJyArIHRoaXMuX3V1aWQoKS5zcGxpdCgnLScpLnNsaWNlKC0xKVswXTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJTcWxEQiIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldKXsNCiAgICAgICAgICAgICAgICAgICAgaWYoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5EYXRhYmFzZSl7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgdG9vbCldLkRhdGFiYXNlKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiLi88JT1zY29wZSU+LmRiIik7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uY3JlYXRlQ29ubmVjdGlvbil7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5jcmVhdGVDb25uZWN0aW9uKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob3N0OiB0aGlzLl9fY29uZmlnKCdzZXJ2ZXInLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXI6IHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygncGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIjwlPXNjb3BlJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uQ2xpZW50KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5DbGllbnQoe2Nvbm5lY3Rpb25TdHJpbmc6IHRoaXMuX19jb25maWcoJ2Nvbm5zdHInLCBudWxsLCB7dG9vbDogdG9vbH0pfSk7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLmRiLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZihnbG9iYWwpPT09J3VuZGVmaW5lZCcgJiYgdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSk9PT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgIC8vIHNxbGl0ZSBpbiBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgU1FMLkRhdGFiYXNlKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09IlNlcnZpY2VOb3ciKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0b29sLnN5c19zY29wZSk9PT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgIC8vIHRvb2wuc3lzX3Njb3BlID0gKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19hcHAiLCB7c3lzX3Njb3BlOiB0aGlzLl9fY29uZmlnKCJzY29wZSIsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgImdsb2JhbCJ9KSlbMF0uc3lzX2lkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodG9vbC5zeXNfcHJvcGVydGllcyk9PT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgIC8vIGxvYWRpbmcgc29tZSBwbGF0Zm9ybSBzdHVmZg0KICAgICAgICAgICAgICAgICAgICB0b29sLnN5c19wcm9wZXJ0aWVzID0ge307DQogICAgICAgICAgICAgICAgICAgIGxldCBjb25kaXRpb24gPSBPYmplY3Qua2V5cyh0b29sLnN5c19wcm9wZXJ0aWVzKS5maWx0ZXIoayA9PiAhdG9vbC5zeXNfcHJvcGVydGllc1trXSkuam9pbignLCcpOw0KICAgICAgICAgICAgICAgICAgICBpZihjb25kaXRpb24pew0KICAgICAgICAgICAgICAgICAgICAgICAgKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19wcm9wZXJ0aWVzIiwge25hbWU6ICJJTiIrY29uZGl0aW9ufSkpLmZvckVhY2gociA9PiB0b29sLnN5c19wcm9wZXJ0aWVzW3IubmFtZV0gPSByLnZhbHVlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KPCUgfSU+DQogICAgfQ0KICAgIC8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8NCiAgICANCiAgICA8JT1tTmFtZT0nX21hdGNoZXMnJT4ocXVlcnksIG9wdGlvbnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUhPSI8JT1uTmFtZShjKSU+IikgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIC8vRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAvL051bGw6IHRydWUsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQ9PXF1ZXJ5LklkLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj92LjwlPW1OYW1lJT4ocXVlcnk/cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTpudWxsKTp0cnVlOw0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj09cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgIXF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICAgICAgICApIG9iai48JT1uTmFtZShlYSklPiA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICghdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4ocXVlcnkuPCU9bk5hbWUoZWEpJT4oKSkpIHx8DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgICAgICAgICAgICkgb2JqLjwlPW5OYW1lKGVhKSU+ID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gcXVlcnkuPCU9dGFOYW1lJT4oKS5hbnkocSA9PiBfdi48JT1tTmFtZSU+KHEpKSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPm9NYXRjaCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWF0Y2hpbmcnJT4ocXVlcnkpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iRm9yIDwlPW5OYW1lKGVhKSU+Iik7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY/W3YuPCU9bU5hbWUlPihxdWVyeSk/djpudWxsXS5jb25jYXQodi48JT1tTmFtZSU+KHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSk6W107DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4ocXVlcnkpKS5mbGF0KCk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgPCU9bG9nKCklPiJtYXRjaGVzIiwgbWF0Y2hlcyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0hPXF1ZXJ5KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCByZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2RlUmVmZXJlbmNlJyU+KHJvb3Qpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcm9vdCkgcm9vdD10aGlzOw0KDQogICAgICAgICAgICBpZihyb290IT10aGlzICYmIHRoaXMuU2V0X09uKSB7DQogICAgICAgICAgICAgICAgbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOw0KICAgICAgICAgICAgICAgIGlmKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbXlNYXRjaGVzWzBdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHYuPCU9bU5hbWUlPihyb290KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJldCE9dikgdGhpcy48JT1uTmFtZShlYSklPihyZXQpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHRhLjwlPW1OYW1lJT4ocm9vdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXQhPXRhKSB0aGlzLjwlPXRhTmFtZSU+KClbaV0gPSByZXQ7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZnJvbURvY3VtZW50JyU+KG9iaiwgYlRvb2wpew0KICAgICAgICBpZighb2JqKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYob2JqLjwlPW1OYW1lJT4pIHJldHVybiBvYmo7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob2JqKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdvYmonKSU+KSBvYmogPSB0aGlzLl9hdG9iKG9iaik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBpZihvYmoubGVuZ3RoPDMzICYmICFvYmoubWF0Y2goL1xzL2cpKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnLCB7dG9vbDogb2JqLl9fdG9vbH0pXTogb2JqDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iaiA9IEpTT04ucGFyc2Uob2JqKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgSlNPTiBvciBVVUlEIiwgb2JqKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShvYmopKXsNCiAgICAgICAgICAgIHJldHVybiBvYmoubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KG8sIGJUb29sKSk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKG9iai5fX3Rvb2wpIHRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7DQogICAgICAgIA0KICAgICAgICBpZighT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB0eXBlb2Yob2JqW2tdKSE9PSd1bmRlZmluZWQnICYmIG9ialtrXSE9PW51bGwpLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkVtcHR5IG9iamVjdCBvciBvYmplY3Qgb2YgbnVsbHMiLCBvYmopOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQob2JqLCB7DQogICAgICAgICAgICBfbWFwOiBiVG9vbCwNCiAgICAgICAgICAgIGltcG9ydGVyOiB2ID0+IHYub2JqID0gKHYub2JqJiZ2Lm9iai5TZXRfQ291bnQ8dGhpcy5TZXRfQ291bnQpP3RoaXM6di5vYmosDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUz9vYmouT1BFUkFUT1JTLlRISVM6dW5kZWZpbmVkKSwNCiAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZihpZENvZGU9PSdJZCcpIGlkQ29kZSA9IHRoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTsNCiAgICAgICAgICAgICAgICBpZihvYmpbaWRDb2RlXSkgdGhpcy5JZCA9IG9ialtpZENvZGVdOw0KICAgICAgICAgICAgfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgIGlmKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHJlZiA9IG9ialtlYUNvZGVdOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihyZWYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIDwlIGlmKCFlYS5Jc0FycmF5KXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iUmVzdERCSU8iKSByZWYgPSByZWZbMF07DQogICAgICAgICAgICAgICAgaWYoIXJlZikgcmV0dXJuOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4oKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KHJlZiwgYlRvb2wpKTsNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IlNxbERCIil7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtb21lbnQpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gbmV3IERhdGUocmVmKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YocmVmKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlZi5pbmRleE9mKCdUJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJlZiA9IG5ldyBEYXRlKHJlZik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlKSA9PiBvYmpbZWFDb2RlXT90aGlzLjwlPXRhTmFtZSU+KG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oX3YsIGJUb29sKSksIG9iai5PUEVSQVRPUlM/b2JqLk9QRVJBVE9SU1tlYUNvZGVdOnVuZGVmaW5lZCwgdHJ1ZSk6dW5kZWZpbmVkLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQo8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgPCU9bU5hbWU9J190b1Byb3RvJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiA8JT1fbkNvZGUoKSU+LCBwcm90bzogYFxuXG5tZXNzYWdlICR7PCU9X25Db2RlKCklPn0ge2AsIGluZGV4OiAxfSwgew0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuYk1hcCwNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmo9KHYucmV1c2VkPjEpP3twcm90bzogYFxuXG4vLyByZXVzZWRbJHt2LnJldXNlZH1dOiAkezwlPV9uQ29kZSgpJT59XG5cbmB9OnYub2JqLA0KICAgICAgICAgICAgICAgIF9USElTOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdHJlcGVhdGVkICR7PCU9X25Db2RlKCklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtpZENvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGBcblx0YCArIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYFxuXHRgOw0KICAgICAgICA8JSBpZihlYS5SZXF1aXJlZCl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KSBvYmoucHJvdG8gKz0gJ3JlcXVpcmVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gJ3JlcGVhdGVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAic3RyaW5nIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImJvb2wiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQzMiI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzTG9uZyl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQ2NCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmxvdCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJmbG9hdCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImRvdWJsZSI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJzdHJpbmciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYCAke2VhQ29kZX0gPSAke29iai5pbmRleCsrfTtgOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdGAgKyBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bXWApICsgYFxuXHRyZXBlYXRlZCAkezwlPV9uQ29kZSh0YS5FbnRpdHlDbGFzcyklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtlZkNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX19jbG9zZTogb2JqID0+IG9iai5wcm90byArPSAnXG59XG5cbicsDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIG9wdGlvbnMsIHNQYXRoKS5wcm90bzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0ICYmICFzUGF0aCl7DQogICAgICAgICAgICAgICAgcmV0ID0gYHBhY2thZ2UgPCU9c2NvcGUlPjtcblxuc3ludGF4ID0gInByb3RvMyI7XG5cbmAgKyByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCV9JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9KU09OJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgc1BhdGggPSBzUGF0aCB8fCAiIjsNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIHJldC5fX2tleXMgPSBbXTsgLy8hIQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5iTWFwKXsNCiAgICAgICAgICAgICAgICByZXQuX19nZW5lcmF0ZWQgPSAnIicgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyAnIic7DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLm5hbWUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX190b29sID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fY2xhc3MgPSAnIjwlPW5OYW1lKGMpJT4iJzsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fdHlwZSA9ICciJys8JT1fbkNvZGUoKSU+KyciJzsNCiAgICAgICAgICAgICAgICAgICAgLy9yZXQuX19wYXRoID0gJyInK3NQYXRoKyciJzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX19ub2RlID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRyTWFwID0gKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgPT4gKHYgJiYgdHlwZW9mKHYpPT09J3N0cmluZycgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoLzw8W14+Pl0rPj4vZ20sIG0gPT4gew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190ck1hcCA9IDwlPXNjb3BlJT4uX190ck1hcCB8fCBbXTsNCg0KICAgICAgICAgICAgICAgIGxldCB0cmlkID0gdGhpcy5fdXVpZCgpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwUGF0aCA9ICcuJysoc1BhdGguc3BsaXQoJy4nKS5zbGljZSgxLCAtMSkuam9pbignLicpKTsNCiAgICAgICAgICAgICAgICBpZihwUGF0aD09Ii4iKSBwUGF0aCA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCB0ciA9IG0ucmVwbGFjZSgnPDwnLCAnJykucmVwbGFjZSgnPj4nLCAnJykucmVwbGFjZSgve3tucn19L2dtLCAnJG5vdCgkZXhpc3RzKF9fcmV1c2VkKSknKS5yZXBsYWNlKC97e3ZmfX0vZywgb2JqW2VhQ29kZV0pOw0KICAgICAgICAgICAgICAgIGlmKHRyLnN0YXJ0c1dpdGgoJ3MoJykgJiYgdHIuZW5kc1dpdGgoJyknKSl7DQogICAgICAgICAgICAgICAgICAgIHRyID0gdHIucmVwbGFjZSgve3tfX319L2dtLCAnb0pTT04nK3NQYXRoKS5yZXBsYWNlKC97e3BwYXRofX0vZ20sICdvSlNPTicrcFBhdGgpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICB0ciA9IHRyLnJlcGxhY2UoL3t7X199fS9nbSwgYCoqW0lkPSR7b2JqLklkfV1bMF1gKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyA8JT13YXJuKCklPmVhQ29kZSwgdHJpZCwgdHIpOw0KDQogICAgICAgICAgICAgICAgdHIgPSB0aGlzLl9idG9hKHRyKTsNCiAgICAgICAgICAgICAgICBsZXQgbWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwLmZpbmQobyA9PiBvLnRyYW5zZm9ybT09dHIpOw0KICAgICAgICAgICAgICAgIHJldHVybiAobWFwP21hcC5pZDo8JT1zY29wZSU+Ll9fdHJNYXBbPCU9c2NvcGUlPi5fX3RyTWFwLnB1c2goe2lkOiB0cmlkLCB0cmFuc2Zvcm06IHRyfSktMV0uaWQpOw0KICAgICAgICAgICAgfSk6djsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLmJNYXAsDQogICAgICAgICAgICAgICAgRnVsbDogb3B0aW9ucy5iRnVsbCwNCiAgICAgICAgICAgICAgICBOdWxsOiBvcHRpb25zLmJOdWxsLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2Lm9iaiAmJiB0eXBlb2Yodi5vYmouX3JldHVybik9PT0nc3RyaW5nJyAmJiB2Lm9iai5fcmV0dXJuLmluZGV4T2YoJ19fcmV1c2VkOiAxJyk+MCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IG9IYXNoID0gb3B0aW9ucy5iSGFzaD9bdGhpcy5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vQXJnczogdHJ1ZSwgX21hcDogb3B0aW9ucy5iTWFwLCBub1R5cGVzOiBmYWxzZX0sICI8JT1tTmFtZSU+IildOk9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gaz09J0lkJyB8fCBrLmluZGV4T2YoJ19fJyk9PTApLm1hcChrID0+IHt0cnl7cmV0dXJuIHsgW2tdOiBKU09OLnBhcnNlKHJldFtrXSkgfTsgfWNhdGNoKGV4KXtyZXR1cm4ge1trXTogcmV0W2tdfTsgfSB9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGVSZXQgPSBPYmplY3QuYXNzaWduKC4uLm9IYXNoLCB7X19yZXVzZWQ6IHYucmV1c2VkfSApOw0KICAgICAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGVSZXQuX19rZXlzKSkgZVJldC5fX2tleXMuZm9yRWFjaChlayA9PiB7dHJ5eyBlUmV0W2VrXSA9IEpTT04ucGFyc2UocmV0W2VrXSk7fWNhdGNoKGV4KXtlUmV0W2VrXSA9IHJldFtla107IH0gfSk7DQoNCiAgICAgICAgICAgICAgICAgICAgdi5vYmogPSB7X3JldHVybjogSlNPTi5zdHJpbmdpZnkoZVJldCl9Ow0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgX1RISVM6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmJNYXApIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCkpOw0KICAgICAgICAgICAgICAgICAgICBvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gYCIke3Z9ImAsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgICAgICBpZihvYmouX19rZXlzKSBvYmouX19rZXlzLnB1c2goZWFDb2RlKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKCE8JT1fYjY0dGVzdCgndicpJT4peyAvLyBpcyBub3QgYmFzZTY0Pw0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuX2J0b2Eodik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICB2ID0gdiYmdi50b0lTT1N0cmluZz92LnRvSVNPU3RyaW5nKCk6djsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY/di48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKTonbnVsbCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCB8fCBlYS5Jc0ludCB8fCBlYS5Jc0xvbmcgfHwgZWEuSXNGbG9hdCB8fCBlYS5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9ICciJyArIHRyTWFwKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgKyAnIic7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gJ1snICsgKHYgfHwgW10pLm1hcCgoX3YsIF9pKSA9PiBfdi48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bJHtfaX1dYCkpLmZpbHRlcihfdiA9PiBfdikuam9pbigpICsgJ10nLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheSh2KSl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9IEpTT04uc3RyaW5naWZ5KHYpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0ck1hcChvYmosIGVmQ29kZSwgdiwgc1BhdGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSB2Ow0KICAgICAgICA8JSBpZighZWYuSXNCb29sICYmICFlZi5Jc0ludCAmJiAhZWYuSXNMb25nICYmICFlZi5Jc0Zsb2F0ICYmICFlZi5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtlZkNvZGVdID0gJyInICsgb2JqW2VmQ29kZV0gKyAnIic7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQoNCiAgICAgICAgICAgICAgICBfX3RyTWFwOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZighc1BhdGgpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLl9fdHJNYXAgPSA8JT1zY29wZSU+Ll9fdHJNYXAgfHwgW107DQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgPCU9c2NvcGUlPi5fX3RyTWFwOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgICAgIF9yZXR1cm46IG9iaiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iaikgb2JqLl9yZXR1cm4gPSAoT2JqZWN0LmtleXMob2JqfHx7fSkubGVuZ3RoKT8oJ3snICsgT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB0eXBlb2Yob2JqW2tdKT09PSJzdHJpbmciKS5tYXAoayA9PiBgIiR7a30iOiAke29ialtrXX1gKS5jb25jYXQoT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB0eXBlb2Yob2JqW2tdKSE9PSJzdHJpbmciKS5tYXAoayA9PiBgIiR7a30iOiAke0pTT04uc3RyaW5naWZ5KG9ialtrXSl9YCkpLmpvaW4oKSArICd9Jyk6J251bGwnOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIG9wdGlvbnMsIHNQYXRoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gcmV0P3JldC5fcmV0dXJuOnJldDsNCiAgICAgICAgICAgIHJldCA9IHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCc/bnVsbDpyZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFzUGF0aCAmJiByZXQpew0KICAgICAgICAgICAgICAgIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgJ2phdmFzY3JpcHQnKTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShyZXQpOw0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuZ3ppcCkgcmV0dXJuIHRoaXMuVXRmOEFycmF5VG9TdHIodGhpcy5fY29tcHJlc3MocmV0KSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3RvRG9jdW1lbnQnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBqc29uID0gdGhpcy5fdG9KU09OKG9wdGlvbnMpOw0KICAgICAgICAgICAgbGV0IG9KU09OID0gSlNPTi5wYXJzZShqc29uKTsNCiAgICAgICAgICAgIGxldCB0ck1hcCA9IG9KU09OLl9fdHJNYXAgfHwgW107DQogICAgICAgICAgICBkZWxldGUgb0pTT04uX190ck1hcDsNCiAgICAgICAgICAgIGpzb24gPSBKU09OLnN0cmluZ2lmeShvSlNPTik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBsb2cgPSAoLi4ucykgPT4gPCU9bG9nKCklPi4uLnMpOw0KICAgICAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT4uLi5zKTsNCiAgICAgICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT4uLi5zKTsNCg0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIHRyTWFwKXsNCiAgICAgICAgICAgICAgICBpZighbmV3IFJlZ0V4cCh0LmlkKS50ZXN0KGpzb24pKSBjb250aW51ZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgdHJuID0gdGhpcy5fYXRvYih0LnRyYW5zZm9ybSk7DQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICBvSlNPTiA9IEpTT04ucGFyc2UoanNvbik7DQogICAgICAgICAgICAgICAgICAgIGxldCByZXMgPSB1bmRlZmluZWQ7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih0cm4uc3RhcnRzV2l0aCgicygiKSAmJiB0cm4uZW5kc1dpdGgoIikiKSl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXMgPSB0aGlzLnJ1blNjcmlwdChgKG9KU09OLCBvU2NvcGUsIGxvZywgd2FybiwgZXJyb3IpID0+ICR7dHJuLnN1YnN0cmluZygyLCB0cm4ubGVuZ3RoLTEpfWApKG9KU09OLCA8JT1zY29wZSU+LCBsb2csIHdhcm4sIGVycm9yKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAvL3JlcyA9IGF3YWl0IGpzb25hdGEodHJuKS5ldmFsdWF0ZShvSlNPTik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIC8vPCU9d2FybigpJT50LmlkLCByZXMsIHRybik7DQogICAgICAgICAgICAgICAgICAgIGpzb24gPSBqc29uLnJlcGxhY2UobmV3IFJlZ0V4cCh0LmlkLCAiZyIpLCAoIUFycmF5LmlzQXJyYXkocmVzKSAmJiB0eXBlb2YocmVzKSE9PSdvYmplY3QnKT9yZXM6dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShyZXMpKSk7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT50LmlkLCB0cm4sIGV4KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIGpzb24gPSBqc29uLnJlcGxhY2UoLyJfX3RyTWFwIjpcc1xbXHtbXj4+XStcfVxdL2dtLCAnIl9fdHJNYXAiOiAiIicpOw0KDQogICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5iSlNPTj90aGlzLl9iZWF1dGlmeShqc29uLCAnamF2YXNjcmlwdCcpOkpTT04ucGFyc2UoanNvbik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCjwlIFt7DQogICAgd09iajogJ3NyJywNCiAgICBmdW5jdGlvbnM6IFsnaGFzaENvZGUnLCAnRXF1YWxzJywgJ3NlcnZlckRhdGUnLCAnX19zY29wZScsICdhZGRNU2Vjb25kcycsICdpcEFkZHJlc3MnXS5jb25jYXQobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSk/WydfJywgJ2J1aWxkVVJMJywgJyRfUkVRVUVTVCcsICdwYXJhbScsICdfdG9YTUwnLCAnY29vcCcsICdPUicsICdteVJlcGxhY2UnLCAnc2VuZFhNTCcsICdwcm9jZXNzUmVzcG9uc2UnLCAncHJvY2Vzc1Jlc3VsdCcsICdydW5TUlNjcmlwdCcsICdncm91cEJ5JywgJ1Nob3dEZWJ1ZycsICdjYWNoZVJlc3VsdCcsICd0b0hleCcsICdTaG93RXJyb3InXTpbXSksDQp9LCB7DQogICAgd09iajogJ19GckVNRCcsDQogICAgZnVuY3Rpb25zOiBbJ19hdHRyJywgJ3J1blNjcmlwdCcsICdfdW5pcXVlJywgJ3NyJywgJ19hdG9iJywgJ19nZXRTdG9yZWRTY3JpcHQnLCAnX2J0b2EnLCAnX190aW1lJywgJ193YWl0JywgJ19zcWxUeXBlJywgJ191dWlkJywgJ3JlcXVpcmUnLCAnX2luY2x1ZGUnLCAnX2JlYXV0aWZ5JywgJ19pbmplY3QnLCAnX2NvbXByZXNzJywgJ19kZWNvbXByZXNzJywgJ1V0ZjhBcnJheVRvU3RyJywgJ3JhbmRVUkwnXSwNCn1dLmZvckVhY2goY2MgPT4geyAlPg0KLyogU1RBUlQ6IDwlPWNjLndPYmolPiBmdW5jdGlvbiBjb3BpZXMgKi8NCjwlIGNjLmZ1bmN0aW9ucy5mb3JFYWNoKGYgPT4geyU+DQoNCi8qIENMT05FOjpTVEFSVDogPCU9Y2Mud09iaiU+LjwlPWYlPigpICovPCU9X0ZyRU1ELl9jbG9uZUZ1bmN0aW9uKGNjLndPYmosIGYsIHNjb3BlLCBjKSAlPi8qIENMT05FOjpFTkQgIDogPCU9Y2Mud09iaiU+LjwlPWYlPigpICovDQo8JSB9KSU+DQovKiBFTkQ6IDwlPWNjLndPYmolPiBmdW5jdGlvbiBjb3BpZXMgKi8NCjwlIH0pOyAlPg0KICAgIA0KICAgIDwlPW1OYW1lPSdpMThuJyU+KGV2LCB2KXsNCiAgICAgICAgaWYodHlwZW9mKHdpbmRvdyk9PT0idW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpPT09InVuZGVmaW5lZCIpIHJldHVybiB2Ow0KICAgICAgICANCiAgICAgICAgaWYoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZyl7DQogICAgICAgICAgICByZXR1cm4gdjsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICByZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2Ow0KICAgICAgICB9DQogICAgfQ0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICA8JT1tTmFtZT0nYnknICsgbk5hbWUoZWEuRW50aXR5VHlwZSklPihhcikgew0KICAgICAgICB2YXIgcmV0ID0gW107DQogICAgICAgIGFyLmZvckVhY2goYSA9PiB7DQogICAgICAgICAgICByZXQuZm9yRWFjaChyID0+IHsNCiAgICAgICAgICAgICAgICBpZiAoYVsiXzwlPW5OYW1lKGVhKSU+Il0gJiYgKGFbIl88JT1uTmFtZShlYSklPiJdLkVxdWFscz9hWyJfPCU9bk5hbWUoZWEpJT4iXS5FcXVhbHMocik6c3IuRXF1YWxzKGFbIl88JT1uTmFtZShlYSklPiJdLCByKSkpIHsNCiAgICAgICAgICAgICAgICAgICAgci5fPCU9bk5hbWUoZWEpJT5fPCU9Yy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpJT4ucHVzaChhKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSklPg0KDQogICAgPCU9bU5hbWU9J3RvU3RyaW5nJyU+KCkgew0KPCUNCnZhciBzRWFzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlICYmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpKTsNCnZhciBfbmFtZSA9IHNFYXMuZmluZChlYSA9PiBlYS5OYW1lLnRvTG93ZXJDYXNlKCk9PSduYW1lJyk7DQppZihfbmFtZSl7DQolPg0KICAgICAgICByZXR1cm4gdGhpcy5fPCU9bk5hbWUoX25hbWUpJT47DQo8JQ0KfWVsc2V7DQolPg0KICAgICAgICByZXR1cm4gdGhpcy5JZDsNCjwlDQp9DQolPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdFbnRpdHlWYWx1ZSclPihhTmFtZSkgew0KICAgICAgICBsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpew0KICAgICAgICAgICAgLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUNCiAgICAgICAgICAgIHJldCA9IHtBY3RpdmU6IHRydWUsIE9QRVJBVE9SUzoge30sIEVudGl0eUF0dHJpYnV0ZToge05hbWU6IGFOYW1lLCBBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB7SWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWR9fX07DQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J2ZpbmQnJT4oZGVwdGggPSAxLCBvYmpzLCBmaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgsIG9ianMsIG51bGwsIG51bGwsIGZpZWxkcykpWzBdOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfX2Fzc2VydFZhbGlkJyU+KGJTeW5jKXsNCjwlIGlmKCFjLlRvb2xzLmxlbmd0aCl7JT4NCiAgICAgICAgcmV0dXJuIHRydWU7DQo8JSB9ZWxzZXslPg0KICAgICAgICBsZXQgZXJyb3IgPSB7fTsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KXsNCiAgICAgICAgICAgIGVycm9yLjwlPW5OYW1lKGVhKSU+ID0ge307DQogICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBlcnJvci48JT1uTmFtZShlYSklPlsiMDEiXSA9ICJOb3QgU2V0IjsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKCF0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIGVycm9yLjwlPW5OYW1lKGVhKSU+WyIwMiJdID0gIkVtcHR5IFZhbHVlIjsNCiAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiBiU3luYyAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLl9fc3luY19vbigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDMiXSA9ICJOb3QgaW4gU3luYyI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKGVycm9yLjwlPW5OYW1lKGVhKSU+KS5sZW5ndGgpIGRlbGV0ZSBlcnJvci48JT1uTmFtZShlYSklPjsNCiAgICAgICAgfQ0KICAgIDwlIH0pJT4NCg0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKXsNCiAgICAgICAgICAgIHRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOw0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXJyb3IsbnVsbCw0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfcmFuayclPihfPCU9bU5hbWUlPj0wKXsNCgkJdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHtfPCU9bU5hbWUlPjogXzwlPW1OYW1lJT59LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2LnJldXNlZD92Lm9iai5fX3JldXNlZCA9IHYucmV1c2VkOjAsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSAiPCU9X2NOYW1lKGMsIHRydWUpJT4iLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5fPCU9bU5hbWUlPiArPSAob2JqW2VhQ29kZV0gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKS5fPCU9bU5hbWUlPiwNCgk8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIHRhQ29kZSwgdikgPT4gKG9ialt0YUNvZGVdID0gW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlUeXBlLCB0cnVlKSU+KCldLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKSkuZm9yRWFjaCh2ID0+IHYuXzwlPW1OYW1lJT4pLA0KICAgIDwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCgl9DQoNCiAgICA8JT1tTmFtZT0nX2lzUXVlcnknJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoLypfX3R5cGUqL3tJZDogIjwlPW5OYW1lKGMpJT4iLCA8JT1tTmFtZSU+Q291bnQ6IDB9LCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgdW5kZWZpbmVkfTsNCiAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IHR5cGVvZihvYmpbZWFDb2RlXS5fY29vcCk9PT0idW5kZWZpbmVkIj8wOjE7DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LjwlPW1OYW1lJT4pew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXS5fb2JqZWN0ID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1tTmFtZSU+Q291bnQgKz0gb2JqW2VhQ29kZV0uX29iamVjdC48JT1tTmFtZSU+Q291bnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmpbdGFDb2RlXSA9IHtfY29vcDogdGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCB1bmRlZmluZWQsIF9vYmplY3RzOiAodnx8W10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpfTsNCiAgICAgICAgICAgICAgICBpZihvYmpbdGFDb2RlXS5fb2JqZWN0cy5sZW5ndGgpIG9ialt0YUNvZGVdLjwlPW1OYW1lJT5Db3VudCArPSBvYmpbdGFDb2RlXS5fb2JqZWN0cy5yZWR1Y2UoKHYsIG8pID0+IHYgKz0gby48JT1tTmFtZSU+Q291bnQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX25ldyclPihjbE5hbWUpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsTmFtZSk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzd2l0Y2goY2xOYW1lKXsNCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uTmFtZShfYyklPiI6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoX2MsIHRydWUpJT4oKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nc3RvcmUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAvKioqIFNUQVJUIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgICAgICANCiAgICAgICAgbGV0IGJVcGRhdGUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGJJbnNlcnQgPSBmYWxzZTsNCg0KICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+InN0b3JpbmcgZGlzYWJsZWQiKTsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5faXNRdWVyeSgpLl9pc1F1ZXJ5Q291bnQpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHN0b3JlIGEgcXVlcnkhIik7DQogICAgICAgIH1lbHNlIGlmKCF0aGlzLl9fc3luY19vbigpKXsNCiAgICAgICAgICAgIGxldCBfdGhpcyA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGJGaW5kID0gZmFsc2U7DQogICAgICAgICAgICBpZih0aGlzLklkPT10aGlzLklkKXsNCiAgICAgICAgICAgICAgICBiRmluZCA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuSWQgPSB0aGlzLklkOw0KICAgICAgICAgICAgfQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPil7DQogICAgICAgICAgICAgICAgYkZpbmQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIF90aGlzLjwlPW5OYW1lKGVhKSU+KHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgJz0nKTsNCiAgICAgICAgICAgIH0NCjwlIH0pOyAlPg0KDQogICAgICAgICAgICBpZihiRmluZCl7DQogICAgICAgICAgICAgICAgX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7DQogICAgICAgICAgICB9ZWxzZSBfdGhpcyA9IG51bGw7DQogICAgICAgICAgICBpZihfdGhpcyl7DQogICAgICAgICAgICAgICAgdGhpcy5JZCA9IF90aGlzLklkOw0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPiJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsNCiAgICAgICAgICAgICAgICBiVXBkYXRlID0gdHJ1ZTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQ0KICAgICAgICAgICAgICAgIGJJbnNlcnQgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9ZWxzZSBpZihNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKXsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyI8Iit0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBiVXBkYXRlID0gdHJ1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmKCFiVXBkYXRlICYmICFiSW5zZXJ0KXsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iTm8gZGF0YSBjaGFuZ2VzIik7DQogICAgICAgIH1lbHNlew0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pPT09InVuZGVmaW5lZCIgfHwgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCl7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uID0ge093bmVyOiB0aGlzLCBzcWxzOiBbXSwgc3RhcnQ6IG5ldyBEYXRlKCksIGVuZDogbnVsbH07DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICB0aGlzLl9kZWZhdWx0cygpOw0KDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKXsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiAhKGF3YWl0IHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KCkpKSB0aGlzLmNsZWFyXzwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KTsgJT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5gPT09PiBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOw0KICAgICAgICAgICAgaWYoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsNCiAgICAgICAgICAgIGlmKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7DQogICAgICAgICAgICA8JT1sb2coKSU+YDw9PT0gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKXsNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy48JT10YU5hbWUlPigpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJTeW5jaW5nLi4uPCU9dGFOYW1lJT4iLCB0YSk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRhLjwlPW1OYW1lJT4oKTsNCiAgICAgICAgICAgICAgICB9DQo8JSB9KTsgJT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoYlVwZGF0ZSB8fCBiSW5zZXJ0KXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09IlNxbERCIil7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiAmJiAhPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXI9PXRoaXMpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J2luc2VydCclPigpew0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bU5hbWUlPiIsIDwlbVJvdXRpbmcoYyklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iTW9uZ29EQiIgfHwgdD09IlphbmdvREIiKXsgJT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYi5nZXRDb2xsZWN0aW9uKDwlPV9uQ29kZShjKSU+KS5pbnNlcnRPbmUodGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pKTsNCiAgICAgICAgICAgIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChgZGIuZ2V0Q29sbGVjdGlvbignJHs8JT1fbkNvZGUoKSU+fScpLmluc2VydE9uZSgke3RoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZX0pfSlgKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUnhEQiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5Ub29sLmRiWzwlPV9uQ29kZShjKSU+XS48JT1tTmFtZSU+KHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLlRvb2wucHJvZHVjZXIuc2VuZCh7DQogICAgICAgICAgICAgICAgdG9waWM6ICc8JT1zY29wZSU+LmNhbGwnLA0KICAgICAgICAgICAgICAgIG1lc3NhZ2VzOiBbew0KICAgICAgICAgICAgICAgICAgICBrZXk6IHRoaXMuSWQsDQogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkNCiAgICAgICAgICAgICAgICB9XQ0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICA8JT1sb2coKSU+J2NhbGw6ICcgKyB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+J3Jlc3BvbnNlOiAnLCByZXQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJNZW1vcnkiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuVG9vbC5kYi48JT1uTmFtZShjKSU+LnB1c2godGhpcyk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5fbmVvNGoodGhpcy5fdG9DeU1lcmdlKCkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJTYWxlc0ZvcmNlIikgeyU+DQogICAgICAgICAgICBsZXQgb2JqID0ge307DQogICAgICAgICAgICA8JSAkLmVhY2goYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKSwgKF8sIGVhKSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT4uSWQ7DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsNCiAgICANCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiPCU9bk5hbWUoYyklPiIpLmNyZWF0ZShvYmopOw0KICAgICAgICAgICAgdGhpcy5JZCA9IHJlcy5pZDsNCiAgICA8JSB9IGVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4icmVzdWx0IiwgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSkpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiR2l0SHViIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9KU09OKHtiTWFwOiB0cnVlLCByZXVzZWQ6IDF9KSwgdGhpcy5JZCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkZpbGVTeXN0ZW0iKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ZpbGVzeXN0ZW0odGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9KU09OKHtiTWFwOiB0cnVlLCByZXVzZWQ6IDF9KSk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkVNUyIpIHslPg0KICAgICAgICAgICAgdGhpcy5JZCA9IChhd2FpdCB0aGlzLl90b0VNU09iamVjdCgpLnN0b3JlKCkpLklkOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uQ29kZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKS5JZC8qX2lkKCkqLzsNCiAgICAgICAgICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk7DQogICAgICAgICAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfSk7ICU+DQogICAgDQogICAgICAgICAgICBsZXQgdXJsID0gImh0dHBzOi8vIiArIHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJykgKyAiLnJlc3RkYi5pby9yZXN0LyIgKyA8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCk7DQogICAgICAgICAgICBsb2coIjwlPXQlPiBVUkwiLCB1cmwpOw0KICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGF4aW9zLnBvc3QodXJsLCBvYmosIHsNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjYWNoZS1jb250cm9sIjogIm5vLWNhY2hlIiwNCiAgICAgICAgICAgICAgICAgICAgIngtYXBpa2V5IjogdGhpcy5fX2NvbmZpZygnYXBpa2V5JyksDQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICBsb2coInJlc3VsdCIsIHJlcy5kYXRhKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXMuZGF0YSk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IGluc09iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RJbnNlcnQiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIG51bGwsIDIpOw0KICAgICAgICAgICAgaWYoIWluc09iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLklkID0gaW5zT2JqLklkOw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMgPSBpbnNPYmouRW50aXR5VmFsdWVzOw0KICAgICAgICAgICAgdGhpcy5fcmV2ZXJ0KCk7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICA8JSB9ICU+DQogICAgICAgIH0NCjwlIH0pICU+DQoNCiAgICAgICAgdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0sIHtfX2JlZm9yZVJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5CZWZvcmUpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgX19hZnRlclJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5BZnRlcikubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dfSk7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7cmV0OiBudWxsfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkNCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J3VwZGF0ZSclPigpIHsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQoNCiAgICA8JSBpZih0ID09ICJNb25nb0RCIikgeyU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLlRvb2wuZGIuY29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikudXBkYXRlT25lKHtfaWQ6IHRoaXMuSWR9LCB7JHNldDogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pfSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS51cGRhdGVPbmUoe19pZDogJyR7cmV0Ll9pZH0nfSwgeyRzZXQ6ICR7dGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pfSlgKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJNZW1vcnkiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuVG9vbC5kYi48JT1uTmFtZShjKSU+W3RoaXMuVG9vbC5kYi48JT1uTmFtZShjKSU+LmZpbmRJbmRleChvID0+IG8uSWQ9PXRoaXMuSWQpXSA9IHRoaXM7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiS2Fma2EiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTmVvNGoiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9ZWxzZSBpZihfc3FsVG9vbHMuaW5kZXhPZih0KT49MCkgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7DQogICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJTZXJ2aWNlTm93IikgeyU+DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCBhd2FpdCB0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlLCByZXVzZWQ6IDF9KSwgJ3B1dCcpKS5yZXN1bHQ7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIkdpdEh1YiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJGaWxlU3lzdGVtIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxlc3lzdGVtKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TT2JqZWN0KCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZW5kaW5nIHVwZGF0ZSB0byBSRVNUREJJTyB0byBzYXZlIik7DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICIvIiArIHRoaXMuSWQ7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+IlVwZGF0ZSB0byBSRVNUREJJTyIsIHVybCk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MucHV0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IHVwZE9iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RVcGRhdGUiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIDIpOw0KICAgICAgICAgICAgaWYoIXVwZE9iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb3B5RnJvbSh1cGRPYmopOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOw0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KDQogICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kQWxsJyU+KGRlcHRoID0gMSwgb2Jqcz1bXSwgc3RhcnQsIGVuZCwgZmllbGRzKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkNCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiKXsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLmZpbmQodGhpcy5fdG9TZWxlY3RNb25nb0RCKGZpZWxkcywgb2JqcykpLnRvQXJyYXkoKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUnhEQiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5Ub29sLmRiWzwlPV9uQ29kZShjKSU+XS5maW5kKHRoaXMuX3RvU2VsZWN0UnhEQihmaWVsZHMsIG9ianMpKS5leGVjKCk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJFTVMiKXsgJT4NCiAgICAgICAgICAgIGxldCBvID0gdGhpcy5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSBvID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5T2JqZWN0KCkuVEhJUyhbb10uY29uY2F0KG9ianMubWFwKF9vID0+IF9vLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKSkpKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5T2JqZWN0KG8pLjwlPW1OYW1lJT4oKSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNZW1vcnkiKXsgJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzLlRvb2wuZGJbPCU9X25Db2RlKCklPl0uZmlsdGVyKG8gPT4gbyAmJiB0aGlzLl9zYW1lRW50aXR5KG8pKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iSHViU3BvdCIpeyAlPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7ICU+DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7c3lzcGFybV9xdWVyeTogdGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSl9KSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTYWxlc0ZvcmNlIil7ICU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7dXJsOiAncmVzdC51cmwuZ3FsJ30pOw0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICByZXQgPSBbYXdhaXQgdGhpcy5fPCU9dC50b0xvd2VyQ2FzZSgpJT4odGhpcy5fZmlsZU5hbWUoKSldOw0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBmIG9mICh0aGlzLlRISVMoKSB8fCBbXSkpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iZmluZGluZyAiK2YubmFtZSgpKTsNCiAgICAgICAgICAgICAgICByZXQucHVzaChhd2FpdCBmLl88JT10LnRvTG93ZXJDYXNlKCklPihmLl9maWxlTmFtZSgpKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXQgPSByZXQuZmxhdCgpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihyZXQubGVuZ3RoICYmIHR5cGVvZihyZXRbMF0pPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgIGxldCBrZXlzID0gT2JqZWN0LmtleXMobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vT3BlcmF0b3JzOiB0cnVlfSwgJzwlPW1OYW1lJT4nKS5fdGhpcyk7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4ia2V5cyIsIGtleXMpOw0KICAgICAgICAgICAgICAgIGxldCBfcmV0ID0gW107DQogICAgICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBfciBvZiByZXQubWFwKHIgPT4gci5zcGxpdCgnX18nKSkubWFwKHNyID0+IE9iamVjdC5hc3NpZ24oe30sIC4uLmtleXMubWFwKChrLCBpKSA9PiAoe1trXTogc3JbaV19KSkpKS5tYXAociA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQocikpLmZpbHRlcihyID0+IHIpKXsNCiAgICAgICAgICAgICAgICAgICAgX3JldC5wdXNoKGF3YWl0IF9yLl88JT10LnRvTG93ZXJDYXNlKCklPihfci5fZmlsZU5hbWUoKSkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXQgPSBfcmV0Ow0KICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSJOZW80aiIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fbmVvNGoodGhpcy5fdG9DeVF1ZXJ5KGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJSZXN0REJJTyIpeyAlPg0KICAgICAgICAgICAgbGV0IHRoaXNEb2MgPSB0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICBsZXQgZWFDb2RlID0gIiI7DQogICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgZWFDb2RlID0gPCU9X25Db2RlKGVhKSU+Ow0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNBcnJheSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IiE9Iil7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJG5pbiI6IHRoaXNEb2NbZWFDb2RlXX07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJGluIjogdGhpc0RvY1tlYUNvZGVdfTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyAlPg0KICAgICAgICAgICAgICAgIGlmKFtudWxsLCAnJScsICdMSUtFJ10uaW5kZXhPZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT4tMSl7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJHJlZ2V4IjogdGhpc0RvY1tlYUNvZGVdIHx8ICIuKiJ9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICI/cT0iICsgSlNPTi5zdHJpbmdpZnkoY29uZGl0aW9ucyk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MuZ2V0KHVybCwgew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgImNhY2hlLWNvbnRyb2wiOiAibm8tY2FjaGUiLA0KICAgICAgICAgICAgICAgICAgICAieC1hcGlrZXkiOiB0aGlzLl9fY29uZmlnKCdhcGlrZXknKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSkuZGF0YTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQklTZXJ2ZXIiKXsgJT4NCiAgICAgICAgICAgIGxldCBxID0gew0KICAgICAgICAgICAgICAgIFRISVM6IHRoaXMuX2J1aWxkVGhpcyhkZXB0aCkuY29uY2F0KChvYmpzIHx8IFtdKS5tYXAob2JqID0+IG9iai50b0VudGl0eU9iamVjdD97DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgICAgICAgICAgfTpvYmopKSwNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7IC8vIGFic29sdXRlbHkgcmVxdWlyZWQgZm9yIGluZGV4aW5nDQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgPCU9bG9nKCklPnEpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FzT2JqZWN0cygoYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZGFsbCIsIG51bGwsIHEpKSk7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgPCU9bG9nKCklPiJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgZGVwdGgsIHJldCk7DQogICAgICAgIA0KICAgICAgICBpZighQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSBbcmV0XTsNCiAgICAgICAgcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHIsIHRydWUpKS5maWx0ZXIociA9PiByKS5tYXAociA9PiByLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7DQogICAgICAgIA0KDQogICAgICAgIGlmKDwlPUpTT04uc3RyaW5naWZ5KF9maWxlVG9vbHMpJT4uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKT4tMSkgcmV0ID0gcmV0LmZpbHRlcihyID0+IHRoaXMuX21hdGNoZXMocikpOw0KICAgICAgICANCiAgICAgICAgaWYoZGVwdGg+MSl7DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2YgcmV0KXsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHIuXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9bk5hbWUoZWEpJT4iLCByLjwlPW5OYW1lKGVhKSU+KCkuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9bk5hbWUoZWEpJT4oYXdhaXQgci5fPCU9bk5hbWUoZWEpJT4uZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgICAgIDwlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT49MCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGxldCByXzwlPXRhTmFtZSU+ID0gW107DQogICAgICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgX3RhIG9mIHIuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IjwlPXRhTmFtZSU+IiwgX3RhKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJfPCU9dGFOYW1lJT4ucHVzaChhd2FpdCBfdGEuZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgci5jbGVhcl88JT10YU5hbWUlPigpOw0KICAgICAgICAgICAgICAgICAgICByLjwlPXRhTmFtZSU+KHJfPCU9dGFOYW1lJT4pOw0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT10YU5hbWUlPiIsIHIuPCU9dGFOYW1lJT4oKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9dGFOYW1lJT4oYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bk5hbWUodGEpJT4ocikNCiAgICAgICAgICAgIDwlIGlmKGZhbHNlICYmIFsnU3FsREInXS5pbmRleE9mKHQpPj0wKXsgLy8gc3FsIHN0YXRlbWVudHMgZG8gbm90IGluY2x1ZGUgbGVmdCBqb2lucyB3aXRob3V0IGV4cGxpY2l0IHJlZmVyZW5jZXMgJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwldGEuRW50aXR5Q2xhc3MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhIT10YSkuZm9yRWFjaChlYSA9PiB7JT4uPCU9bk5hbWUoZWEpJT4obmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKTwlfSklPg0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgICAgICAuPCU9bU5hbWUlPihkZXB0aC0xKSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgcmVmcyA9IHJldC5maWx0ZXIociA9PiByLkVudGl0eUNsYXNzKTsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBvIG9mIChvYmpzIHx8IFtdKS5maWx0ZXIoX28gPT4gIV9vLl9fc3luY19vbigpKSl7DQogICAgICAgICAgICBpZihvLl90b0VNU09iamVjdCl7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG8uX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpLjwlPW1OYW1lJT4oZGVwdGgpKSkpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCBvLjwlPW1OYW1lJT4oZGVwdGgpKSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmVmcyA9IHJlZnMuZmlsdGVyKHIgPT4gcik7DQogICAgICAgIA0KICAgICAgICByZWZzLmZvckVhY2gociA9PiByLl9yZXNvbHZlKHJlZnMpKTsNCg0KICAgICAgICA8JT1sb2coKSU+Ik91dHB1dCIsIHJldCk7DQoNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7ZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcywgX19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IFtdfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXNvbHZlJyU+KHJlZnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcmVmcy5sZW5ndGgpIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLl9faW1wb3J0KHt9LCB7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAoKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPW5OYW1lKGVhKSU+IiwgdGhpcy48JT1uTmFtZShlYSklPigpLklkLCByZWZzLm1hcChyID0+ICh7aWQ6IHIuSWQsIGNvZGU6IHIuY29kZSgpfSkpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmcy5maW5kKG8gPT4gby5JZD09dGhpcy48JT1uTmFtZShlYSklPigpLklkKSB8fCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihyZWZzKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLjwlPXRhTmFtZSU+KCkubGVuZ3RoKSB0aGlzLjwlPXRhTmFtZSU+KHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodGEgPT4gcmVmcy5maW5kKG8gPT4gby5JZD09dGEuSWQpIHx8IHRhLjwlPW1OYW1lJT4ocmVmcykpLCBudWxsLCB0cnVlKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KPCUgaWYobWFpbkNsYXNzKFsnRU1TJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU1ZhbHVlcyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0VNUyddKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMoZXZzLCBbLi4ubmV3IFNldChldnMubWFwKHYgPT4gdi5lbnRpdHlBdHRyaWJ1dGUoKS5JZCkuZmxhdCgpKV0ubWFwKGlkID0+IG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZShpZCkpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5ldnMpOw0KICAgICAgICANCiAgICAgICAgICAgIGxldCBvYmpzID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiX2VudGl0eU9iamVjdCIpLmZvckVhY2goZXZnID0+IHsNCiAgICAgICAgICAgICAgICBldmcua2V5LmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXZnLnZhbHVlcyk7DQogICAgICAgICAgICAgICAgb2Jqcy5wdXNoKGV2Zy5rZXkpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIG9ianMuZm9yRWFjaChyID0+IHIuZW50aXR5Q2xhc3Moci5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKClbMF0uZW50aXR5QXR0cmlidXRlKCkuZW50aXR5Q2xhc3MoKSkpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygb2Jqcyl7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgbmV3IDwlPXNjb3BlJT5bci5lbnRpdHlDbGFzcygpLm5hbWUoKV0oKS5fZnJvbUVNU09iamVjdChyKSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0VNUyddLGMpKSU+KCkuPCU9bU5hbWUlPihldnMpOw0KICAgIDwlfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9FTVNDbGFzcyclPihkZXB0aCl7DQogICAgICAgIC8vIHdoeSBub3QgX19leHBvcnQgPw0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3MoJzwlPWMuSWQlPicpLm5hbWUoIjwlPWMuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoYyklPiIpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmRhdGUobmV3IERhdGUoKSkuY29tcGFueShuZXcgPCU9c2NvcGUlPi5Db21wYW55KCkubmFtZSgiPCU9c2NvcGUlPiIpLmNvZGUoIjwlPXNjb3BlJT4iKSkuZW50aXR5TW9kdWxlKG5ldyA8JT1zY29wZSU+LkVudGl0eU1vZHVsZSgpLmNvZGUoIjwlPXNjb3BlJT4iKS5uYW1lKCI8JT1zY29wZSU+IikpOw0KICAgICAgICAgICAgaWYoIWRlcHRoKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQuZW50aXR5Q2xhc3NfRW50aXR5TWV0aG9kcyhbDQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlNZXRob2QoJzwlPW0uSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPW0uTmFtZSU+IikuY29kZSgiPCU9bk5hbWUobSklPiIpLmVudGl0eU1ldGhvZF9FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICAgICAgPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1wLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1wLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKHApJT4iKS5pc0FycmF5KDwlPXAuSXNBcnJheT8ndHJ1ZSc6J2ZhbHNlJyU+KS5yZW1hcmsoIjwlPWMuTmFtZSU+LjwlPW0uTmFtZSU+KCkiKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKQ0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS48JT1tTmFtZSU+KGRlcHRoLTEpKQ0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKHApJT4odHJ1ZSkNCiAgICAgICAgICAgIDwlIH0lPiwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF0pLnJlc3BvbnNlQXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlKSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSkNCiAgICAgICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKG0uUmVzcG9uc2VBdHRyaWJ1dGUpJT4odHJ1ZSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKS5lbnRpdHlDbGFzc19FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1lYS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9ZWEuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoZWEpJT4iKS5yZW1hcmsoJzwlPWMuTmFtZSU+LjwlPWVhLk5hbWUlPicpDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKGVhKSU+KHRydWUpDQogICAgICAgIDwlIH0lPiwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU09iamVjdCclPihvYmopew0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0aGlzLklkID0gb2JqLklkOw0KICAgICAgICAgICAgbGV0IGV2ID0gbnVsbDsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBldiA9IG9iai5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKCkuZmluZChldiA9PiBldi5lbnRpdHlBdHRyaWJ1dGUoKS5jb2RlKCk9PTwlPV9uQ29kZShlYSklPik7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihldi5vYmplY3RWYWx1ZSgpKSk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihldi48JT1fRnJFTUQuX2F0dHIoZWEpLnRvTG93ZXJDYXNlKCklPlZhbHVlKCkpOw0KICAgICAgICA8JSB9JT4NCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvRU1TT2JqZWN0JyU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyl7DQogICAgICAgIGxldCByZXQgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlPYmplY3QoKS5hY3RpdmUodHJ1ZSkuZW50aXR5Q2xhc3ModGhpcy5fdG9FTVNDbGFzcygpKTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIC8vTnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5JZCA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eUF0dHJpYnV0ZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPWVhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1lYS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShlYSklPiIpLmVudGl0eUNsYXNzKHRoaXMuX3RvRU1TQ2xhc3MoKSkpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGV2Lm9iamVjdFZhbHVlKHY/di48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyk6bnVsbCwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKS50b0xvd2VyQ2FzZSgpJT5WYWx1ZSh2LCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXYsICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZih2ICYmIGJUeXBlZEF0dHJpYnV0ZXMpIG9iai5vYmplY3RWYWx1ZV9FbnRpdHlWYWx1ZXModi5tYXAoX3YgPT4gbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5QXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9dGEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUoIjwlPW5OYW1lKHRhKSU+IikubmFtZSgiPCU9dGEuTmFtZSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdG9FTVNDbGFzcygpKSkub2JqZWN0VmFsdWUoX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpKSksICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoWydCSVNlcnZlciddKSl7JT4NCiAgICA8JT1tTmFtZT0nX2FzT2JqZWN0cyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pIT1jKXslPg0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10sYykpJT4oKS48JT1tTmFtZSU+KGV2cyk7DQogICAgPCV9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZXZzKT09PSJ1bmRlZmluZWQiIHx8ICFldnMgfHwgIUFycmF5LmlzQXJyYXkoZXZzKSB8fCAhZXZzLmxlbmd0aCkgcmV0dXJuIFtdOw0KDQogICAgICAgICAgICBldnMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgZXYuRW50aXR5QXR0cmlidXRlID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSWQ9PWV2LkVudGl0eUF0dHJpYnV0ZWlkKTsNCiAgICAgICAgICAgICAgICBldi5FbnRpdHlPYmplY3QuRW50aXR5Q2xhc3MgPSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgaWYoZXYuT2JqZWN0VmFsdWUpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcyA9IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcy5maW5kKGVjID0+IGVjLklkPT1ldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcy5JZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICBsZXQgb2JqID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiRW50aXR5T2JqZWN0IikuZm9yRWFjaChldmcgPT4gew0KICAgICAgICAgICAgICAgIGxldCBjID0gbmV3IDwlPXNjb3BlJT5bZXZnLmtleS5FbnRpdHlDbGFzcy5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKTsNCiAgICAgICAgICAgICAgICBjLkVudGl0eVZhbHVlcyA9IGV2Zy52YWx1ZXM7DQogICAgICAgICAgICAgICAgYy5WYWx1ZUVudGl0aWVzID0gW107DQogICAgICAgICAgICAgICAgLy8gYy5FbnRpdHlDbGFzcyA9IGV2Zy5rZXkuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgYy5JZCA9IGV2Zy5rZXkuSWQ7DQogICAgICAgICAgICAgICAgZXZnLnZhbHVlcy5mb3JFYWNoKHYgPT4gdi5FbnRpdHlPYmplY3QgPSBjKTsNCiAgICAgICAgICAgICAgICBvYmoucHVzaChjKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBldnMuZmlsdGVyKGV2ID0+IGV2Lk9iamVjdFZhbHVlKS5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgX2YgPSBvYmouZmluZChvID0+IG8uSWQgPT0gZXYuT2JqZWN0VmFsdWUuSWQpOw0KICAgICAgICAgICAgICAgIGlmKF9mKSBfZi5WYWx1ZUVudGl0aWVzLnB1c2goZXYpOw0KICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gX2Y7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBvYmouZm9yRWFjaChvID0+IHsNCiAgICAgICAgICAgICAgICBpZihvLkVudGl0eUNsYXNzICYmIG8uRW50aXR5Q2xhc3MuSWQhPXRoaXMuRW50aXR5Q2xhc3MuSWQpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKG8pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQubWFwKG8gPT4gby5fcmV2ZXJ0KCkpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCV9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXZlcnQnJT4oZW8pIHsNCiAgICAgICAgaWYgKGVvKSB7DQogICAgICAgICAgICAvLyByZXZlcnQgZnJvbSBzb3VyY2UgZGF0YQ0KICAgICAgICAgICAgaWYoZW8uRW50aXR5Q2xhc3MgJiYgKCh0aGlzLkVudGl0eUNsYXNzLklkICYmIGVvLkVudGl0eUNsYXNzLklkIT10aGlzLkVudGl0eUNsYXNzLklkKSB8fCAodGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIGVvLkVudGl0eUNsYXNzLk5hbWUhPXRoaXMuRW50aXR5Q2xhc3MuTmFtZSkpKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iQ2Fubm90IHJldmVydCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5FbnRpdHlDbGFzcykgKyAiIGZyb20gIiArIGVvLkVudGl0eUNsYXNzLk5hbWUsIGVvKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuSWQgPSBlby5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gZW8uRW50aXR5VmFsdWVzIHx8IFtdOw0KICAgICAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzID0gZW8uVmFsdWVFbnRpdGllcyB8fCBbXTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLjwlPW1OYW1lJT4oKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmKHRoaXMuX19zeW5jX29uKCkgJiYgTWF0aC5hYnMoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCA1KXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJPYmplY3QgYWxyZWFkeSByZXZlcnRlZCIsIHRoaXMuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgDQogICAgICAgICAgICAvLyB1c2UgRW50aXR5VmFsdWVzIGFuZCBWYWx1ZUVudGl0aWVzIHRvIHJldmVydCB0aGUgYXR0cmlidXRlIHZhbHVlcw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGVhID0gbnVsbDsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIGVhID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihfZWEgPT4gX2VhLkVudGl0eUNsYXNzLk5hbWU9PSc8JT1jLk5hbWUlPicpLmZpbmQoX2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZWlkPT1fZWEuSWQpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGUpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5JZD09X2VhLklkKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lPT1fZWEuTmFtZSkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBpZighZWEpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4idW5hYmxlIHRvIGRldGVjdCBhdHRyaWJ1dGUgZnJvbSB2YWx1ZSIsIGV2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXYsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGxldCB2ID0gZXZbKHRoaXNbIl9hdHRyIl0/dGhpczpfRnJFTUQpLl9hdHRyKGVhKSArICJWYWx1ZSJdOw0KICAgICAgICAgICAgICAgIGxldCBwID0gZWEuTmFtZS5yZXBsYWNlKC8gL2csICdfJyk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRoaXNbcF0pIT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImludmFsaWQgdHlwZSIsIGVhLCBwLCB2KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZih2ICYmIGVhLkVudGl0eVR5cGUgJiYgdHlwZW9mKHYpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+InJldmVydGluZyAiICsgZWEuTmFtZSwgdiwgbmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXYuRW50aXR5VmFsdWVzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImVtcHR5IHZhbHVlcyBmb3IgIiArIGVhLk5hbWUsIHYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3BdKHYpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHRoaXMuVmFsdWVFbnRpdGllcy5maWx0ZXIodmUgPT4gdmUuRW50aXR5QXR0cmlidXRlKS5mb3JFYWNoKHZlID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgdGEgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5JZD09dmUuRW50aXR5QXR0cmlidXRlLklkKTsNCiAgICAgICAgICAgICAgICBpZighdGEpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHZhciB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOw0KDQogICAgICAgICAgICAgICAgbGV0IHYgPSB2ZS5FbnRpdHlPYmplY3Q7DQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bdGEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3RhLk5hbWUucmVwbGFjZSgvIC9nLCAiXyIpICsgIl8iICsgdGFOYW1lXSh2KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3ZhbHVlQ2xhc3MnJT4oKXsNCiAgICAgICAgbGV0IF9jbGFzcyA9IHtBY3RpdmU6IHRydWV9Ow0KICAgICAgICBpZih0aGlzLkVudGl0eUNsYXNzLkVudGl0eU1vZHVsZSl7DQogICAgICAgICAgICBfY2xhc3MuRW50aXR5TW9kdWxlID0gdGhpcy5FbnRpdHlDbGFzcy5FbnRpdHlNb2R1bGU7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgX2NsYXNzID0gew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBDb21wYW55OiB7QWN0aXZlOiB0cnVlLCBFbmFibGVkOiB0cnVlLCBFbnRpdHlDbGFzc2VzOiBbdGhpcy5FbnRpdHlDbGFzc119DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgICAgIHJldHVybiBfY2xhc3M7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1hNTCclPigpew0KICAgICAgICAvLyBhbiBvdmVybG9hZCBvZiB0aGUgc3IuX3RvWE1MDQogICAgICAgIGxldCByZXQgPSB7eG1sOiBgYH07DQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQueG1sICs9IGA8JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCd9PiR7dn08LyR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnfT5gLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8JHtlYUNvZGV9PmA7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSB2P3YuPCU9bU5hbWUlPigpOm51bGw7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCFbQ0RBVEFbJHt2fV1dPmA7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwvJHtlYUNvZGV9PmA7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwke2VhQ29kZX0+YCArIHYubWFwKF92ID0+ICc8T2JqZWN0PicgKyBfdi48JT1tTmFtZSU+KCkgKyAiPC9PYmplY3Q+Iikuam9pbignJykgKyBgPC8ke2VhQ29kZX0+YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0LnhtbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX2J1aWxkVGhpcyclPihkZXB0aD0xKXsNCiAgICAgICAgLy8gY2FuZGlkYXRlIGZvciBfX2V4cG9ydA0KICAgICAgICB2YXIgcmV0ID0gW3sNCiAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZToge0FjdGl2ZTogdHJ1ZSwgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKX0sDQogICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHRoaXMudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgIH1dOw0KICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSBkZXB0aDsgaSsrKSB7DQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFtyZXRbaSAtIDFdXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIGlmKGRlcHRoPjEpew0KICAgICAgICAgICAgbGV0IHYgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgcmV0LnB1c2goew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHY/di50b0VudGl0eU9iamVjdCh0cnVlKTpudWxsLA0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3sNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdj92LnRvRW50aXR5T2JqZWN0KHRydWUpOm51bGwsDQogICAgICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSd0b0VudGl0eU9iamVjdCclPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpIHsNCiAgICAgICAgbGV0IHJldCA9IHtBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCksIEVudGl0eVZhbHVlczogW10sIFZhbHVlRW50aXRpZXM6IFtdfTsNCiAgICAgICAgaWYoIWJRdWVyeSkgcmV0LkRhdGUgPSB0aGlzLnNlcnZlckRhdGUoKTsgDQoNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIEZ1bGw6ICFiUXVlcnksDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouSWQgPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZXYgPSB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCkuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWU9PSc8JT1lYS5OYW1lJT4nKS5JZCwNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI8JT1lYS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7fSwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZSA9IHYuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpOw0KICAgICAgICAgICAgICAgICAgICBldi5PUEVSQVRPUlMuT2JqZWN0VmFsdWUgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgICAgICAgICAgICAgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLlZhbHVlRW50aXRpZXMucHVzaChldik7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKHYgJiYgYlR5cGVkQXR0cmlidXRlcykgb2JqLkVudGl0eVZhbHVlcy5wdXNoKHYubWFwKF92ID0+ICh7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogJzwlPXRhLklkJT4nLA0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIjwlPXRhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBPYmplY3RWYWx1ZTogX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpLA0KICAgICAgICAgICAgICAgIH0pKSk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9ICU+DQp9DQo=",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
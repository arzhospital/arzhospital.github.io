{
	"Id": "125564e0fcc507469e75f1db3d2d93079765b71a",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "EntityClass",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCgke3N9fHwnLicpYDsNCg0KbGV0IF9kZWYgPSAocywgdikgPT4gJT48JT1zJT4gPSB0eXBlb2YoPCU9cyU+KSE9PSd1bmRlZmluZWQnPzwlPXMlPjo8JT12JT47PCUNCg0KbGV0IF9kZWZhdWx0cyA9IChvYmo9J3RoaXMnLCBfYz1jKSA9PiBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkRlZmF1bHQpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighPCU9b2JqJT4uXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgPCU9b2JqJT4uPCU9bk5hbWUoZWEpJT4oPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4pOw0KICAgICAgICAgICAgfQ0KPCUgfSk7DQoNCmxldCBsb2cgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMCwgYDsNCmxldCB3YXJuID0gKG4sIF90aGlzPSd0aGlzJykgPT4gYCR7X3RoaXN9LmxvZyhudWxsLCB1bmRlZmluZWQsICcke24gfHwgbU5hbWV9JywgJ0VudGl0eU9iamVjdCcsIDEsIGA7DQpsZXQgZXJyb3IgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMiwgYDsNCg0KbGV0IHFsVHlwZSA9IChlYSwgYklucHV0KSA9PiB7DQogICAgaWYoZWEuSXNCb29sKSByZXR1cm4gJ0Jvb2xlYW4nOw0KICAgIC8vaWYoZWEuSXNEYXRlKSByZXR1cm4gJ0RhdGVUaW1lJzsNCiAgICBpZihlYS5Jc0ludCB8fCBlYS5Jc0Zsb2F0KSByZXR1cm4gJ0ludCc7DQogICAgaWYoZWEuRW50aXR5VHlwZSkgcmV0dXJuIG5OYW1lKGVhLkVudGl0eVR5cGUpKyhiSW5wdXQ/IklucHV0IjoiIik7DQogICAgcmV0dXJuICdTdHJpbmcnOw0KfTsNCg0KLy8gd2h5IGhhcmQgY29kZWQ/Pz8NCmxldCBfcmVzdFRvb2xzID0gWydTZXJ2aWNlTm93JywgJ1NhbGVzRm9yY2UnLCAnUmVzdERCSU8nLCAnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCmxldCBfc3FsVG9vbHMgPSBbJ1NxbERCJywgJ1NhbGVzRm9yY2UnLCAnU25vd0ZsYWtlJ107DQpsZXQgX2ZpbGVUb29scyA9IFsnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCg0KbGV0IGNsc1Rvb2xzID0gX2MgPT4gX2MuVG9vbHMubWFwKHQgPT4gdC50eXBlP3QudHlwZS5uYW1lOih0Lm5hbWUgfHwgdCkpOw0KbGV0IG1haW5DbGFzcyA9IChfYXJUb29scywgX2M9YykgPT4gYXJDbGFzc2VzLmZpbmQoX19jID0+IChfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmZpbmQodCA9PiBjbHNUb29scyhfX2MpLmluY2x1ZGVzKHQpKSkgfHwgKCEoX2FyVG9vbHMgfHwgY2xzVG9vbHMoX2MpKS5sZW5ndGggJiYgYXJDbGFzc2VzWzBdKTsNCg0KbGV0IF9lYVR5cGVzID0gKF9jPWMsIGJBbGwpID0+IF9GckVNRC5fdG9KUyhPYmplY3QuYXNzaWduKHt9LCAuLi5fYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGJBbGw/dHJ1ZTplYS5FbnRpdHlUeXBlKS5tYXAoZWEgPT4gKHtbbk5hbWUoZWEpXTogbk5hbWUoZWEuRW50aXR5VHlwZSkgfHwgX0ZyRU1ELl9hdHRyKGVhKX0pKSkpOw0KDQpsZXQgX2NGaWVsZCA9IChlYSwgX2M9ZWEuRW50aXR5Q2xhc3MpID0+ICgoZWEuRW50aXR5VHlwZT8oZWEuRW50aXR5VHlwZS5UeXBlZEF0dHJpYnV0ZXMuZmluZCh0YSA9PiB0YS5FbnRpdHlDbGFzcz09X2MpIHx8IGVhLkVudGl0eUNsYXNzLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLkVudGl0eVR5cGU9PV9jKSk6bnVsbCkgfHwge05hbWU6ICIifSkuTmFtZTsNCg0KbGV0IF9jTmFtZSA9IChjbj1jLk5hbWUsIGJBbGlhcykgPT4gew0KICAgIGlmKGNuLk5hbWUpIGNuID0gY24uTmFtZTsNCiAgICBsZXQgX2MgPSBhckNsYXNzZXMuZmluZChlYyA9PiBlYy5OYW1lPT1jbik7DQogICAgaWYoIV9jKSByZXR1cm4gJyc7DQogICAgcmV0dXJuIG5OYW1lKF9jLCBiQWxpYXMpOw0KfTsNCg0KbGV0IGFsaWFzID0gKGNuLCBqPScuJykgPT4gKHNjb3BlICsgJy4nICsgX2NOYW1lKGNuLCB0cnVlKS5yZXBsYWNlKF9jTmFtZShjbiksICcnKSkuc3BsaXQoJy4nKS5maWx0ZXIobiA9PiBuKS5qb2luKGopOw0KbGV0IG5zY29wZSA9IGFsaWFzKCdOb2RlJyk7DQoNCmxldCBfdkNvZGUgPSBrID0+IHslPig8JXZhbHVlT2Yoay5Db2RlKSU+IHx8ICgiPCU9bkNvZGUoayklPiIpKTwlfTsNCmxldCBfbkNvZGUgPSAoZWEsIGJUeXBlZCkgPT4gZWE/KCJ0aGlzLl9uQ29kZSgnIiArIG5Db2RlKGVhKSArIChiVHlwZWQ/KCdfJyArIGVhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJykpOiIiKSAgKyAiJywgIiArIChiVHlwZWQ/bnVsbDpfRnJFTUQuX3RvSlMoZWEuQ29kZSkpICsgIikiKToidGhpcy5fbkNvZGUoKSI7DQpsZXQgbVJvdXRpbmcgPSAoYywgbSkgPT4gew0KICAgIGlmICghYyAmJiBtKSBjID0gbS5FbnRpdHlDbGFzczsNCiAgICBpZiAoIW0gJiYgIWMpIHJldHVybiAiIjsNCiAgICBpZiAoIW0pIG0gPSBjOw0KICAgIGlmICghbS5Sb3V0aW5nICYmICFjLlJvdXRpbmcpIHJldHVybiAiIjsNCg0KJT4oX25vZGUsIG1ldGhvZCkgPT4gew0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlbT9tLk5hbWU6JyclPiIgfHwgbWV0aG9kLCAiUm91dGVyIiwgMCwgLi4ubXNnKTsNCiAgICAJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAJbGV0IG5TY29wZSA9IDwlPW5zY29wZSU+Ow0KDQogICAgICAgIHRyeXsNCiAgICAgICAgPCVmdW5jdGlvbk9mKG0uUm91dGluZyklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgd2FybihleCk7DQogICAgICAgIH0NCn0NCjwlfTsNCg0KbGV0IG1OYW1lID0gJyc7DQoNCmxldCBmdW5jdGlvbk9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4NCiAgICAgICAgbGV0IF9fcmV0ID0gdW5kZWZpbmVkOw0KICAgIDwlIGlmKGZ1bil7JT4NCiAgICAgICAgPCUgaWYodHlwZW9mKGZ1bik9PT0nb2JqZWN0Jyl7JT4NCiAgICAgICAgICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYoPCU9X3RoaXMlPi5Ub29sICYmIDwlPV90aGlzJT4uVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgICAgICAgICA8JSBpZih0eXBlb2YoZnVuW3RdKT09PSdmdW5jdGlvbicpeyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPWZ1blt0XSU+Ow0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPShKU09OLnN0cmluZ2lmeShmdW5bdF0pIHx8ICciIicpJT47DQogICAgICAgICAgICAgICAgPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuJT47DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0lPg0KICAgICAgICBpZih0eXBlb2YoX19yZXQpPT09J3N0cmluZycgJiYgX19yZXQuc3RhcnRzV2l0aCgicygiKSAmJiBfX3JldC5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgIF9fcmV0ID0gdGhpcy5ydW5TY3JpcHQoX19yZXQuc2xpY2UoMiwtMSkpOw0KICAgICAgICB9DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgIF9fcmV0ID0gX19yZXQoPCU9X3RoaXMlPik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9fcmV0Ow0KPCV9Ow0KDQpsZXQgdmFsdWVPZiA9IChmdW4sIF90aGlzPSd0aGlzJykgPT4geyU+KCgNCihvU2NvcGUpID0+IHsNCiAgICB0cnl7DQo8JWZ1bmN0aW9uT2YoZnVuLCBfdGhpcyklPg0KICAgIH1jYXRjaChfdk9mRXgpew0KICAgICAgICA8JT13YXJuKCklPid2YWx1ZU9mJywgX3ZPZkV4LCA8JT1fRnJFTUQuX3RvSlMoZnVuKSU+KTsNCiAgICB9DQp9DQopKDwlPWFsaWFzKCklPikpPCV9Ow0KDQpsZXQgdW5SZWN1cnNlID0gKG9iaiwgZnVuLCBmQXJncz0nYXJndW1lbnRzJywgc1JldCwgdmFsaWRpdHk9YHRoaXMuX19jb25maWcoJ3VuUmVjdXJzZS52YWxpZGl0eScsIDAuNSlgLCBpZGYpID0+IHsNCiAgICBpZGYgPSBpZGYgfHwgYCh0aGlzP3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTonSWQnKWA7DQogICAgZnVuID0gZnVuIHx8IGAiJHttTmFtZX0iYDsNCiAgICBzUmV0ID0gYA0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICB2LmRhdGUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgICAgICAgICAgICAgICB2LnJldXNlZCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAke3NSZXR9DQogICAgICAgIH1jYXRjaChzUmV0X2V4KXsNCiAgICAgICAgICAgIHRoaXMubG9nKG51bGwsIHVuZGVmaW5lZCwgJHtmdW59LCAnJHttTmFtZX0udW5SZWN1cnNlJywgMSwgJ3NSZXQnLCBzUmV0X2V4KTsNCiAgICAgICAgfWZpbmFsbHl7DQogICAgICAgICAgICBpZih2ICYmIHYucmV1c2VkPjEpIHJldHVybiB2P3Yub2JqOnY7DQogICAgICAgIH0NCiAgICBgOw0KICAgIGxldCBiRGFuZ2VyID0gKCkgPT4gJT4oWyJfdG9IYXNoIl0uaW5kZXhPZig8JT1mdW4lPik+PTApPCU7DQolPg0KICAgICAgICBsZXQgdiA9IHVuZGVmaW5lZDsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCA9IDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnQgfHwge307DQogICAgICAgICAgICBpZig8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPmBBYm9ydGluZyBhcyBwZXIgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydC4kezwlPWZ1biU+fWApOw0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgX2lkID0gbnVsbDsNCiAgICAgICAgICAgIGlmKHR5cGVvZig8JT1vYmolPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPiJOdWxsIGlucHV0IiwgPCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gPCU9b2JqJT47DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoPCU9b2JqJT4pPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuaGFzaENvZGUoPCU9b2JqJT4pOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKDwlPW9iaiU+WzwlPWlkZiU+XSkhPT0ndW5kZWZpbmVkJyAmJiA8JT1vYmolPls8JT1pZGYlPl09PTwlPW9iaiU+WzwlPWlkZiU+XSl7DQogICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT5bPCU9aWRmJT5dOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoX2lkKT09PSd1bmRlZmluZWQnIHx8ICFfaWQpew0KICAgICAgICAgICAgICAgIGlmKDwlPW9iaiU+LklkICYmIDwlPW9iaiU+LklkPT08JT1vYmolPi5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IDwlPW9iaiU+LklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtvbmx5VW5pcXVlOiB0cnVlfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4idGhpcy5oYXNoZWRfaWQiLCBfaWQsIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihvYmouU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gb2JqLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJvYmouaGFzaGVkX2lkIiwgX2lkLCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPik7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoPCU9b2JqJT4uRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPi5FbnRpdHlDbGFzcy5JZCB8fCA8JT1vYmolPi5FbnRpdHlDbGFzcy5OYW1lIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjwlPWMuSWQlPiIgfHwgdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtkZXB0aDogPCViRGFuZ2VyKCklPj8zOnVuZGVmaW5lZH0sIDwlPWZ1biU+KSB8fCAiTlVMTCI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UgfHwge307DQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+IHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSB8fCB7fTsNCiAgICAgICAgCQ0KICAgICAgICAgICAgdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdOw0KDQogICAgICAgICAgICBpZih2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwKjwlPXZhbGlkaXR5JT4pKXsNCiAgICAgICAgICAgICAgICBpZigoPCViRGFuZ2VyKCklPj9uZXcgRGF0ZSgwKToodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKS5nZXRUaW1lKCkgPiB2LmRhdGUpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT5gU3Bhd25pbmcgaW4gJHs8JT1mdW4lPn1gLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iU2VsZWN0ZWQgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+LCB2LnJldXNlZCwgPCU9dmFsaWRpdHklPik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iUHVzaGluZyBoYXNoIiwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4pOw0KICAgICAgICAJdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gew0KICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLA0KICAgICAgICAgICAgICAgIGFyZ3M6IEpTT04uc3RyaW5naWZ5KDwlPWZBcmdzJT4pLA0KICAgICAgICAgICAgICAgIG9iajogPCU9b2JqJT4sDQogICAgICAgICAgICAgICAgcmV1c2VkOiAwLA0KICAgICAgICAgICAgICAgIHBhdGg6ICcnLA0KICAgICAgICAgICAgICAgIF9pZCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlLypleHBlcmltZW50YWw6IHJlbW92ZSB0aGlzIGlmIGFsbCBnb2VzIHdyb25nKi8lPg0KICAgICAgICAgICAgPCU9c1JldCU+DQogICAgCX1jYXRjaCh1blJlY0V4KXsNCiAgICAJICAgIGlmKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpew0KICAgIAkgICAgICAgIDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dID0gdHJ1ZTsNCiAgICAJICAgIH0NCiAgICAJICAgIDwlPWVycm9yKGAke21OYW1lfS51blJlY3Vyc2VgKSU+PCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+LCB1blJlY0V4LnRvU3RyaW5nKCkpOw0KICAgIAkgICAgPCU9c1JldCU+DQogICAgCX0NCjwlDQp9Ow0KDQpsZXQgaW52b2tlUnVsZSA9IHIgPT4gew0KJT4NCmF3YWl0IChhc3luYyAoYXV0aE9iaikgPT4gew0KICAgIGxldCBfcnVsZSA9IDwlPV9GckVNRC5fdG9KUyhyKSU+Ow0KICAgIGRlbGV0ZSBfcnVsZS5TY3JpcHQ7DQogICAgLy8gcnVsZVJ1bnMucHVzaChfcnVsZSk7DQogICAgdHJ5ew0KICAgICAgICA8JT1yLlNjcmlwdCU+DQogICAgfWNhdGNoKGV4KXsNCiAgICAgICAgX3J1bGUuRXhjZXB0aW9uID0gZXg7DQogICAgfQ0KfSkoYXV0aE9iaik7DQo8JQ0KfQ0KJT4NCg0KY2xhc3MgPCU9bk5hbWUoYyklPiB7DQogICAgPCU9bU5hbWU9J2NvbnN0cnVjdG9yJyU+KGlkLCB0b29sKSB7DQogICAgICAgIC8vc3VwZXIoaWQsIHRvb2wpOw0KDQogICAgICAgIHRoaXMuU2NvcGUgPSAiPCU9c2NvcGUlPiI7DQogICAgICAgIHRoaXMuRGVidWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5EZWJ1ZyklPjsNCiAgICAgICAgdGhpcy5Db25maWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db25maWcpJT47DQogICAgICAgIHRoaXMuVGVzdCA9IDwlPV9GckVNRC5fdG9KUyhjLlRlc3QpJT47DQogICAgICAgIHRoaXMuVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoYy5Ub29scyklPjsNCiAgICAgICAgdGhpcy5NYXBwaW5ncyA9IDwlPV9GckVNRC5fdG9KUyhjLk1hcHBpbmdzKSU+Ow0KDQogICAgICAgIC8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQ0KICAgICAgICB0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307DQogICAgICAgIHRoaXMuVG9vbCA9IHRvb2w7DQogICAgICAgIHRoaXMuSWQgPSBpZDsNCg0KICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsNCg0KICAgICAgICB0aGlzLkRhdGUgPSBudWxsOw0KDQogICAgICAgIHRoaXMuY2xlYXJfVEhJUygpOw0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcyA9IFtdOw0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KPCUgaWYoTnVtYmVyKGVhLklkKSl7JT4NCiAgICAgICAgICAgICAgICBJZDogIjwlPWVhLklkJT4iLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7TmFtZTogIj0ifSwNCiAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBPUEVSQVRPUlM6IHt9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KTsgJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KCk7DQo8JSB9KTsgJT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZWZhdWx0cyclPigpew0KPCVfZGVmYXVsdHMoKSU+DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IEVudGl0eUNsYXNzJyU+KCl7DQogICAgICAgIGxldCBlYyA9IHsNCjwlIGlmKE51bWJlcihjLklkKSl7JT4NCiAgICAgICAgICAgIElkOiAiPCU9Yy5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgTmFtZTogIjwlPWMuTmFtZSU+IiwNCiAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgIH07DQoNCjwlIGlmKGMuRW50aXR5TW9kdWxlaWQpeyAlPg0KICAgICAgICBlYy5FbnRpdHlNb2R1bGUgPSB7DQogICAgICAgICAgICBJZDogPCU9Yy5FbnRpdHlNb2R1bGVpZCU+DQogICAgICAgIH07DQo8JSB9JT4NCg0KICAgICAgICAvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXINCiAgICAgICAgaWYoIU51bWJlcihlYy5JZCkgJiYgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzKXsNCiAgICAgICAgICAgIGxldCBjaWQgPSA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWU9PWVjLk5hbWUpOw0KICAgICAgICAgICAgaWYoY2lkKSBlYy5JZCA9IGNpZC5JZDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZWM7DQogICAgfQ0KDQoJPCU9bU5hbWU9J2dldCBJZCclPigpIHsNCgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOw0KCX0NCg0KCTwlPW1OYW1lPSdzZXQgSWQnJT4oaWQpIHsNCgkJaWYgKCF0aGlzLlRvb2wpIHsNCgkJCTwlPWxvZygpJT4iRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYodGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXT09aWQpIHJldHVybjsNCgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOw0KCX0NCg0KICAgIDwlPW1OYW1lPSdnZXQgVG9vbCclPigpIHsNCiAgICAgICAgaWYodHlwZW9mKHRoaXMuX19Ub29sKSE9PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7DQogICAgICAgIGxldCBub1Rvb2wgPSB7DQogICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgIHR5cGU6IHtuYW1lOiAnJ30sDQogICAgICAgIH07DQogICAgICAgIGlmKHR5cGVvZig8JT1zY29wZSU+LlRvb2xzKSE9PSJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KDwlPXNjb3BlJT4uVG9vbHMpKXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPiI8JT1zY29wZSU+LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm4gbm9Ub29sOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gKDwlPXNjb3BlJT4uX19sYXN0VG9vbD9bPCU9c2NvcGUlPi5fX2xhc3RUb29sXTpbXSkuY29uY2F0KHRoaXMuVG9vbHMpLmZpbmQodCA9PiAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lPT1fdC5uYW1lKSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpIT09J3VuZGVmaW5lZCcpIHJldCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1yZXQgfHwgdC5uYW1lPT1yZXQubmFtZSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgaWYodGhpcy5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXSwNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH1lbHNlIHJldCA9IG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdzZXQgVG9vbCclPih0b29sKSB7DQogICAgICAgIGlmICh0eXBlb2YodG9vbCk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICBpZih0eXBlb2YodG9vbCk9PT0ic3RyaW5nIil7DQogICAgICAgICAgICB0b29sID0ge25hbWU6IHRvb2x9Ow0KICAgICAgICB9DQogICAgICAgIGlmKHRvb2wuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0eXBlb2YodG9vbC5uYW1lKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICB0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwge25hbWU6IHRvb2wubmFtZX07DQogICAgICAgIA0KICAgICAgICBpZighdG9vbC50eXBlICYmICF0b29sLm5hbWUpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iRW1wdHkgVG9vbCBvYmplY3QiKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCB0ID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7DQogICAgICAgIGlmICghdCkgew0KICAgICAgICAgICAgPCU9bG9nKCklPiJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPXNjb3BlJT4uX19sYXN0VG9vbCA9IHRoaXMuX19Ub29sID0gdDsNCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdUSElTJyU+KHYsIGNvKXsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOw0KICAgICAgICBpZighdikgcmV0dXJuIHRoaXM7DQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICB0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KT09PSdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWU9PXRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZT09dGhpcy5TY29wZSk7DQogICAgICAgIGlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nY2xlYXJfVEhJUyclPigpIHsNCiAgICAgICAgdGhpcy5fVEhJUyA9IFtdOw0KICAgICAgICB0aGlzLl9USElTX2Nvb3AgPSAnJzsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKGVhKSU+KHYsIGNvLCBpZCkgew0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICB2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCI8JT1lYS5OYW1lJT4iKTsNCiAgICAgICAgaWYgKCFldil7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpZCkgZXYuSWQgPSBpZDsNCg0KICAgICAgICBpZiAodHlwZW9mKHYpIT09J3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIC8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXINCg0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgICAgIHYgPSB2Lm1hcChfdiA9PiB7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHYgPSAoX3YgPT4gew0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIF92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nP192OihuZXcgRGF0ZShfdikpOw0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsNCiAgICA8JSB9JT4NCiAgICA8JSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgaWYoaXNOYU4oX3YpKSBfdiA9IDA7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihfdik9PT0nb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7DQogICAgPCUgfSU+DQoNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKF92ICYmICFfdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4idXNpbmcgX3RvRG9jdW1lbnQgZm9yIGludmFsaWQgc2V0dGVyIHZhbHVlIiwgX3YpOw0KICAgICAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoX3YgJiYgX3YuRW50aXR5Q2xhc3MuSWQhPT0nPCU9ZWEuRW50aXR5VHlwZS5JZCU+JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgU2V0dGVyIHZhbHVlIiwgX3YsICI8JT1lYS5FbnRpdHlUeXBlLklkJT4iLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiPCU9ZWEuRW50aXR5VHlwZS5OYW1lJT4iKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSAoKF92ICYmICF0aGlzLklkKSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgfSkodik7DQogICAgPCUgfSU+DQogICAgDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOw0KICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSB2Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgPCUgfSU+DQoNCiAgICAgICAgICAgIGlmKHRydWUgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT4hPXYpew0KICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IDwlPVNldF9PbiU+OyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQ0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJTZXQgYWZ0ZXIiLCB0aGlzLl88JT1uTmFtZShlYSklPj90aGlzLl88JT1uTmFtZShlYSklPi5TZXRfT246bnVsbCwgdj92LlNldF9PbjpudWxsKTsNCiAgICAgICAgICAgICAgICAvKmlmKHYpIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IHYuU2V0X09uOyovDQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gdjsNCiAgICAgICAgICAgIGlmIChjbykgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gY287DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2NsZWFyXycrbk5hbWUoZWEpJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPjsNCiAgICAgICAgLyoNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT4gPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gIiI7DQogICAgICAgICovDQogICAgICAgIA0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT47DQogICAgICAgIGRlbGV0ZSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIC8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPWVhLk5hbWUlPiAqKi8NCjwlIH0pOyAlPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9dGEuTmFtZSU+XzwlPXRhTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKHRhKSsnXycrdGFOYW1lJT4odiwgY28sIGJDbGVhcikgew0KICAgICAgICBpZih0eXBlb2Yodik9PT0idW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+Ow0KICAgICAgICANCiAgICAgICAgaWYodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQhPT0nPCU9dGEuRW50aXR5Q2xhc3MuSWQlPicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPXRhLkVudGl0eUNsYXNzLk5hbWUlPicpIHJldHVybiB0aGlzOw0KICAgICAgICANCiAgICAgICAgdiA9IEFycmF5LmlzQXJyYXkodik/djpbdl07DQogICAgICAgIA0KICAgICAgICB2ID0gdi5maWx0ZXIoX3YgPT4gIXYgfHwgX3YuXzwlPW5OYW1lKHRhKSU+X3NldCkuY29uY2F0KHYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fPCU9bk5hbWUodGEpJT5fc2V0KS5tYXAoX3YgPT4gew0KICAgICAgICAgICAgaWYoIV92LmNvbnN0cnVjdG9yKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uTmFtZSh0YSklPiBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7DQogICAgICAgICAgICB9ZWxzZSBpZihfdi5jb25zdHJ1Y3Rvci5uYW1lPT0iT2JqZWN0Iil7DQogICAgICAgICAgICAgICAgX3YgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3YpDQogICAgICAgICAgICAgICAgX3YuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgICAgICAgICAgfWVsc2UgaWYoX3YuY29uc3RydWN0b3IubmFtZSE9IjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+Iil7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iPCU9bk5hbWUodGEpJT4gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICI8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiIpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgX3YuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9KS5maWx0ZXIoX3YgPT4gX3YpKTsNCiAgICAgICAgDQogICAgICAgIGlmKGJDbGVhcikgdGhpcy5jbGVhcl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPigpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPi5wdXNoKC4uLnYpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9zZXQgPSA8JT1TZXRfT24lPjsNCiAgICAgICAgaWYgKGNvKSB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9jb29wID0gY287DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIGNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT47DQoNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4gPSBuZXcgQXJyYXkoKTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fY29vcCA9IG51bGw7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIC8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+ICoqLw0KDQo8JSB9KSAlPg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAvKiogc3RhcnQ6IGdldHRlcnMgZm9yIDwlPWVmLk5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT0nZ2V0ICcrbk5hbWUoZWYpJT4oKXsNCiAgICAgICAgcmV0dXJuIDwldmFsdWVPZihlZi5WYWx1ZSklPjsNCiAgICB9DQogICAgLyoqIGVuZDogZ2V0dGVycyBmb3IgPCU9ZWYuTmFtZSU+ICoqLw0KPCUgfSklPg0KDQogICAgPCU9bU5hbWU9J2xvZyclPihjbGFzc05hbWUsIG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIHR5cGUgPSB0eXBlIHx8ICJFbnRpdHlPYmplY3QiOw0KICAgICAgICANCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQoJCQlsZXQgZGVidWcgPSB0aGlzLkRlYnVnOw0KCQkJbGV0IGxldmVscyA9IFsiaW5mbyIsICJ3YXJuIiwgImVycm9yIiwgImNyaXRpY2FsIl07DQoNCgkJCWRlYnVnID0gZGVidWcgfHwgT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAobGV2ZWxzLm1hcChsID0+IFtsLCAnKiddKSkpOw0KDQoJCQlsZXQgZnVuY3Rpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgLi4ubGV2ZWxzLm1hcChsID0+ICh7DQoJCQkJW2xdOiBkZWJ1Z1tsXSA/IGRlYnVnW2xdLnNwbGl0KCcsJykgOiBbXQ0KCQkJfSkpKTsNCg0KCQkJbGV0IGNzcyA9ICdiYWNrZ3JvdW5kOiAjMDBmZjk5OyBjb2xvcjogIzAwODAwMCc7DQoJCQlsZXQgZmcgPSAnXHgxYlszMm0nOw0KCQkJc3dpdGNoIChOdW1iZXIobGV2ZWwpKSB7DQoJCQkJY2FzZSAxOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2ZmZmYwMDsgY29sb3I6ICMwMDAwODAnOw0KCQkJCQlmZyA9ICdceDFiWzMzbSc7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2UgMjoNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsNCgkJCQkJZmcgPSAnXHgxYlszMW0nOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIDM6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7DQoJCQkJCWZnID0gJ1x4MWJbMzFtW0NSSVRJQ0FMXSc7DQoJCQkJCWJyZWFrOw0KCQkJfQ0KDQoJCQlpZiAoZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXS5ldmVyeShmID0+ICFbJyouKicsICcqLicgKyBtLCAnKicsIG0sIGNsYXNzTmFtZSArICcuJyArIG0sIGNsYXNzTmFtZSArICcuKiddLmluY2x1ZGVzKGYpKSkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgew0KCQkJCWNvbnNvbGUubG9nKGZnICsgIiVzXHgxYlswbSIsIGAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7Y2xhc3NOYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7DQoJCQl9IGVsc2Ugew0KCQkJCWNvbnNvbGUubG9nKGAlYyAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7Y2xhc3NOYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIGNzcywgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsNCgkJCX0NCgkJfSBjYXRjaCAoZXgpIHsNCgkJCWNvbnNvbGUubG9nKGV4KTsNCgkJfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J3NldEludGVydmFsJyU+KGNsYXNzTmFtZSwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIGZ1biwgbWludXRlcywgLi4uYXJncyk7DQo8JSB9ZWxzZXslPg0KCQl0cnkgew0KICAgIAkJbGV0IGZOYW1lID0gZnVuLnRvU3RyaW5nKCkuc3BsaXQoJyknKVswXSArICcpJzsNCiAgICAJCXRyeSB7DQogICAgCQkJLy8gdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKTsNCiAgICANCiAgICAJCQl0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApOw0KICAgIAkJCWxldCByZXQgPSBhd2FpdCBmdW4oLi4uYXJncy5jb25jYXQoW25ldyBEYXRlKCldKSk7DQogICAgDQogICAgCQkJPCU9bG9nKCklPmB7Q2FsbDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCkgKyBgLCBMb29wOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKSArICd9Jyk7DQogICAgCQkJaWYgKCFyZXQpIHsNCiAgICAJCQkJPCU9bG9nKCklPmBkaWQgbm90IHJldHVybiB0cnVlLCBleGl0aW5nIGxvb3BlciAoJHt0aGlzLl9fdGltZShmTmFtZSl9KWApOw0KICAgIAkJCQlyZXR1cm47DQogICAgCQkJfQ0KICAgIAkJfSBjYXRjaCAoZXgpIHsNCiAgICAJCQk8JT1lcnJvcigpJT50aGlzLl9fdGltZShmTmFtZSksIGV4KTsNCiAgICAJCQljb25zb2xlLnRyYWNlKCk7DQogICAgCQl9DQogICAgCQlpZiAoIU51bWJlcihtaW51dGVzKSkgew0KICAgIAkJCTwlPWxvZygpJT50aGlzLl9fdGltZShmTmFtZSksICJOb3QgcmVwZWF0aW5nLiBNaW51dGVzIGlzICIgKyBtaW51dGVzKTsNCiAgICAJCQlyZXR1cm47DQogICAgCQl9DQogICAgCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgbWludXRlcyAqIDYwICogMTAwMCkpOw0KICAgIAkJYXdhaXQgdGhpcy48JT1tTmFtZSU+KG51bGwsIGZ1biwgbWludXRlcywgLi4uYXJncyk7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZXhlY3V0ZSclPihjbGFzc05hbWUsIHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zID0ge30sIHNvdXJjZSl7DQoJCXRoaXMuX190aW1lKGA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPi4ke219YCk7DQoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQoJCXNjb3BlID0gc2NvcGUgfHwgPCU9c2NvcGUlPjsNCgkJc291cmNlID0gc291cmNlIHx8IHRoaXM7DQoNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zLCB0aGlzKTsNCjwlIH1lbHNleyU+DQoJCWRlbGV0ZSA8JT1zY29wZSU+Ll91blJlY3Vyc2U7IC8vIGV4cGVyaW1lbnRhbA0KCQkNCiAgICAJbGV0IF9fYmVmb3JlUnVsZXMgPSBvUGFyYW1zLl9fYmVmb3JlUnVsZXMgfHwgW107DQogICAgCWxldCBfX2FmdGVyUnVsZXMgPSBvUGFyYW1zLl9fYWZ0ZXJSdWxlcyB8fCBbXTsNCiAgICAJZGVsZXRlIG9QYXJhbXMuX19iZWZvcmVSdWxlczsNCiAgICAJZGVsZXRlIG9QYXJhbXMuX19hZnRlclJ1bGVzOw0KDQogICAgICAgIGxldCBsb2cgPSAoLi4ucykgPT4gPCU9bG9nKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgIAkJbGV0IGxQYXJhbXMgPSBPYmplY3QuZW50cmllcyhvUGFyYW1zKS5tYXAoeCA9PiB4WzFdKTsNCiAgICAJCWxldCByZXN1bHRzID0gW107DQogICAgDQogICAgCQlsZXQgbm9kZXMgPSBbXTsNCiAgICAJCQ0KICAgIAkJaWYgKDwlPW5zY29wZSU+Ll9ub2RlICYmIGF3YWl0IGZSb3V0ZXIoPCU9bnNjb3BlJT4uX25vZGUsIG0pKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZSk7DQogICAgCQl9DQogICAgDQogICAgCQlpZiAoPCU9bnNjb3BlJT4uX25vZGUgJiYgPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudCAmJiBhd2FpdCBmUm91dGVyKDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLCBtKSkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJZm9yIGF3YWl0IChjb25zdCBjbiBvZiAoPCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUucGFyZW50X05vZGVzKCk6W10pKSB7DQogICAgICAgICAgICAgICAgaWYgKGF3YWl0IGZSb3V0ZXIoY24sIG0pKSB7DQogICAgICAgICAgICAgICAgCWxvZygnYWRkaW5nIGNoaWxkIG5vZGUnLCBjbik7DQogICAgICAgICAgICAgICAgCW5vZGVzLnB1c2goY24pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAJCX0NCiAgICANCiAgICAJCS8vIHJlbW92ZSBhbnkgbnVsbHMNCiAgICAJCW5vZGVzID0gbm9kZXMuZmxhdCgpLmZpbHRlcihuID0+IG4pOw0KICAgIAkJDQogICAgCQlpZiAoIW5vZGVzLmxlbmd0aCkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgCQlub2RlcyA9IHRoaXMuX3VuaXF1ZShub2RlcywgJ19jb2RlJyk7DQogICAgCQlsb2coJ25vZGVzLmxlbmd0aCcsIG5vZGVzLmxlbmd0aCk7DQoNCiAgICAJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBub2Rlcykgew0KICAgIAkJCWxldCBuUmV0ID0gbnVsbDsNCiAgICAJCQlsb2coYCR7bX0gQCAke24/LmNvZGUoKSB8fCAnTE9DQUwnfWApOw0KICAgIAkJCWlmICghbiB8fCB0aGlzLl9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLCBuKSkgew0KICAgIAkJCQkvLyBsb2NhbCBzY3JpcHQNCiAgICAJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYmVmb3JlUnVsZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwldmFsdWVPZigici5TY3JpcHQiKSU+DQogICAgCQkJCQkvL2F3YWl0IHRoaXMuX1NjcmlwdChjbGFzc05hbWUsIHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0JlZm9yZVJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7DQogICAgCQkJCX0NCg0KICAgIAkJCQluUmV0ID0gYXdhaXQgZlNjcmlwdCgpOw0KDQogICAgCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2FmdGVyUnVsZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwldmFsdWVPZigici5TY3JpcHQiKSU+DQogICAgCQkJCQkvL2F3YWl0IHRoaXMuX1NjcmlwdChjbGFzc05hbWUsIHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0FmdGVyUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsNCiAgICAJCQkJfQ0KICAgIAkJCX0gZWxzZSB7DQogICAgCQkJCW5SZXQgPSBhd2FpdCBzb3VyY2UuX2ludm9rZU5vZGUobiwgbSwgb1BhcmFtcyk7DQogICAgCQkJfQ0KICAgIA0KICAgIAkJCXJlc3VsdHMucHVzaCh7DQogICAgCQkJCW5vZGU6IG4sDQogICAgCQkJCXJldDogblJldA0KICAgIAkJCX0pOw0KICAgIAkJfQ0KICAgIAkJbG9nKHJlc3VsdHMsICJfZXhlY3V0ZSIsICdSZXN1bHRzJyk7DQogICAgDQogICAgCQlsZXQgZXJyb3JzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnJldCAmJiByLnJldC5fX2V4Y2VwdGlvbikubWFwKHIgPT4gKHsNCiAgICAJCQlub2RlOiByLm5vZGUgPyB7DQogICAgCQkJCWNvZGU6IHIubm9kZS5jb2RlKCksDQogICAgCQkJCWFkZHJlc3M6IHIubm9kZS5hZGRyZXNzKCkNCiAgICAJCQl9IDogbnVsbCwNCiAgICAJCQlfX2V4Y2VwdGlvbjogci5yZXQuX19leGNlcHRpb24NCiAgICAJCX0pKTsNCg0KICAgIAkJaWYgKGVycm9ycy5sZW5ndGgpIHsNCiAgICAJCQl3YXJuKCJlcnJvcnMiLCBlcnJvcnMpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJcmV0dXJuIHJlc3VsdHM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICBlcnJvcihleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfU2NyaXB0JyU+KGNsYXNzTmFtZSwgc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgX25vZGUsIC4uLnNmQXJncyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgPCU9c2NvcGUlPjsNCiAgICAgICAgDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBzY3JpcHQsIG0sIHR5cGUsIHNjb3BlLCBfbm9kZSwgLi4uc2ZBcmdzKTsNCjwlIH1lbHNleyU+DQogICAgCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAJDQogICAgICAgIHRyeXsNCiAgICAJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3N0cmluZycpIHNjcmlwdCA9IHRoaXMucnVuU2NyaXB0KGAoKSA9PiB7JHtzY3JpcHR9fWApOw0KICAgIA0KICAgIAkJbGV0IHJldCA9IG51bGw7DQogICAgCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdmdW5jdGlvbicpIHsNCiAgICAJCQlyZXQgPSBhd2FpdCBzY3JpcHQoKTsNCiAgICAJCX0NCiAgICANCiAgICAJCXJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmNsYXNzTmFtZSwgbSwgdHlwZSwgc2NyaXB0LCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCg0KICAgIDwlPW1OYW1lPSdfc2FtZUVudGl0eSclPiguLi5hckVudGl0aWVzKXsNCiAgICAgICAgaWYoYXJFbnRpdGllcy5sZW5ndGg9PTApIHJldHVybiBmYWxzZTsNCiAgICAgICAgaWYoYXJFbnRpdGllcy5sZW5ndGg9PTEpIGFyRW50aXRpZXMucHVzaCh0aGlzKTsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPiguLi5hckVudGl0aWVzKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldHVybiBhckVudGl0aWVzLnNsaWNlKDEpLmV2ZXJ5KGUgPT4gew0KICAgICAgICAgICAgICAgIGxldCB2ID0gYXJFbnRpdGllc1swXTsNCiAgICAgICAgICAgICAgICBsZXQgbmVnVGVzdCA9IHsNCiAgICAgICAgICAgICAgICAgICAgdk51bGw6IHY9PW51bGwsDQogICAgICAgICAgICAgICAgICAgIGVOdWxsOiBlPT1udWxsLA0KICAgICAgICAgICAgICAgICAgICB2T2JqZWN0OiB0eXBlb2YodikhPT0nb2JqZWN0JywNCiAgICAgICAgICAgICAgICAgICAgZU9iamVjdDogdHlwZW9mKGUpIT09J29iamVjdCcsDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MSwgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgaWYoT2JqZWN0LmtleXMoT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmtleXMobmVnVGVzdCkuZmlsdGVyKGsgPT4gbmVnVGVzdFtrXSkubWFwKGsgPT4gKHt2LCBlLCBba106IHRydWV9KSkpKS5sZW5ndGgpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAvLyBwYXNzZWQgaW5pdGlhbCBjb25zaXN0ZW5jeSBjaGVjaw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHY9PWUpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG5lZ1Rlc3QgPSB7DQogICAgICAgICAgICAgICAgICAgIGV2Q29uc3RyOiB2LmNvbnN0cnVjdG9yLm5hbWUhPWUuY29uc3RydWN0b3IubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgZUVudGl0eTogIWUuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICAgICAgICAgIHZFbnRpdHk6ICF2LkVudGl0eUNsYXNzLA0KICAgICAgICAgICAgICAgICAgICBldkVudGl0eU5hbWVzOiB0eXBlb2YoZS5FbnRpdHlDbGFzcy5OYW1lKSE9PSd1bmRlZmluZWQnICYmIGUuRW50aXR5Q2xhc3MuTmFtZSE9di5FbnRpdHlDbGFzcy5OYW1lLA0KICAgICAgICAgICAgICAgICAgICBldkVudGl0eUlkczogdHlwZW9mKGUuRW50aXR5Q2xhc3MuSWQpIT09J3VuZGVmaW5lZCcgJiYgZS5FbnRpdHlDbGFzcy5JZCE9di5FbnRpdHlDbGFzcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgZXZJRHM6IHYuSWQ9PXYuSWQgJiYgZS5JZD09ZS5JZCAmJiB2LklkIT1lLklkLA0KICAgICAgICAgICAgICAgICAgICBldkhhc2g6IHYuX3RvSGFzaChudWxsLCB7b25seVVuaXF1ZTogdHJ1ZX0sICc8JT1tTmFtZSU+JykhPWUuX3RvSGFzaChudWxsLCB7b25seVVuaXF1ZTogdHJ1ZX0sICc8JT1tTmFtZSU+JyksDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MiwgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgbmVnVGVzdCA9IE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5rZXlzKG5lZ1Rlc3QpLmZpbHRlcihrID0+IG5lZ1Rlc3Rba10pLm1hcChrID0+ICh7diwgZSwgW2tdOiB0cnVlfSkpKTsNCiAgICAgICAgICAgICAgICBpZighT2JqZWN0LmtleXMobmVnVGVzdCkubGVuZ3RoKSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MywgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdnZXQgU2V0X09uJyU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgfHwgbnVsbCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0IHx8IG51bGwsDQo8JSB9KSU+DQogICAgICAgICkpOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPiJyZXQiLCByZXQpOw0KICAgICAgICANCiAgICAgICAgaWYoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IFNldF9Db3VudCclPigpIHsNCiAgICAgICAgcmV0dXJuIFsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0LA0KPCUgfSklPg0KICAgICAgICBdLmZpbHRlcihzID0+IHMpLmxlbmd0aDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mbGF0dGVuJyU+KGRlcHRoKXsNCiAgICAgICAgPCU9d2FybigpJT4iREVQUkVDQVRFRCIpOw0KICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgIGlmKCFkZXB0aCkgcmV0dXJuIHJldDsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgcmV0Ll88JT1uTmFtZShlYSklPl9zZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQ7DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgIHJldC48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKT90aGlzLjwlPW5OYW1lKGVhKSU+KCk8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oZGVwdGgtMSk8JX0lPjp0aGlzLjwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KSU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgcmV0LjwlPXRhTmFtZSU+ID0gdGhpcy48JT10YU5hbWUlPigpLm1hcCh0ID0+IHQ/dC48JT1tTmFtZSU+KGRlcHRoLTEpOnQpOw0KPCUgfSklPg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvSGFzaCclPihhcmdzLCBvcHRpb25zLCBmU291cmNlKXsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQogICAgICAgIA0KICAgICAgICBsZXQgb0hhc2ggPSB7DQogICAgICAgICAgICBjbGFzczogIjwlPW5OYW1lKGMpJT4iLA0KICAgICAgICAgICAgc291cmNlOiBmU291cmNlLA0KICAgICAgICAgICAgYXJnczogYXJncywNCiAgICAgICAgICAgIF90aGlzOiB7fQ0KICAgICAgICB9Ow0KICAgICAgICANCiAgICAgICAgaWYoIW9wdGlvbnMubm9UaGlzICYmIGZTb3VyY2UhPSI8JT1tTmFtZSU+IiAmJiAodHlwZW9mKG9wdGlvbnMuZGVwdGgpPT09J3VuZGVmaW5lZCcgfHwgLS1vcHRpb25zLmRlcHRoPjApKXsNCiAgICAgICAgICAgIHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsNCiAgICAgICAgICAgICAgICBPUEVSQVRPUlM6ICFvcHRpb25zLm5vT3BlcmF0b3JzLA0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuX21hcCwNCiAgICAgICAgICAgICAgICBVbmlxdWU6IG9wdGlvbnMub25seVVuaXF1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+aWYob3B0aW9ucy5ub1R5cGVzKSByZXR1cm47PCV9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSA8JSBpZihlYS5FbnRpdHlUeXBlKXslPnY/di48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpOjwlfSU+KChvcHRpb25zLm9ubHlVbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KT8odnx8bnVsbCk6dik7DQogICAgICAgICAgICAgICAgfSwNCjwlIH0pJT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpKSwNCjwlIH0pJT4NCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqW2VmQ29kZV0gPSB2LA0KPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYob3B0aW9ucy5ub0FyZ3MpIG9IYXNoID0gb0hhc2guX3RoaXM7DQogICAgICAgIHJldHVybiBvcHRpb25zLm5vQ29kZT9vSGFzaDp0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19hdXRob3JpemUnJT4odXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKXsNCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmICE8JT1zY29wZSU+Ll9fdG9rZW4gJiYgdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnVzZXJuYW1lJ10pew0KICAgICAgICAgICAgdXNlcm5hbWUgPSB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udXNlcm5hbWUnXTsNCiAgICAgICAgICAgIHBhc3N3b3JkID0gdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnBhc3N3b3JkJ107DQogICAgICAgIH0NCg0KICAgICAgICBpZihiU2VydmVyKXsNCiAgICAgICAgICAgIGlmKHVzZXJuYW1lICYmICE8JT1zY29wZSU+Ll90ZXN0VXNlciAmJiB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udGVzdFVzZXInXSl7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdGVzdFVzZXIgPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCh0aGlzLlRlc3RbJzwlPW1OYW1lJT4udGVzdFVzZXInXSkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS5zdG9yZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMudXNlcm5hbWUodXNlcm5hbWUsICc9JykucGFzc3dvcmQocGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZXJ2ZXI6ICIgKyBiU2VydmVyKyIsIE9iajoiLCByZXQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihyZXQpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihqc29ud2VidG9rZW4pIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICByZXQgPSBqc29ud2VidG9rZW4uc2lnbihyZXQuX3RvRG9jdW1lbnQoKSwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIHsgZXhwaXJlc0luOiAnMTgwMHMnIH0pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXQgPSB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJldC5fdG9Eb2N1bWVudCgpKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiByZXQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZXJ2ZXI6ICIgKyBiU2VydmVyKyIsIHRva2VuOiAiLCByZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBsZXQgY2xpZW50X2lkID0gdGhpcy5fX2NvbmZpZygnY2xpZW50X2lkJyk7DQogICAgICAgICAgICBsZXQgY2xpZW50X3NlY3JldCA9IHRoaXMuX19jb25maWcoJ3NlY3JldCcpOw0KICAgIA0KICAgICAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiA8JT1zY29wZSU+Ll9fdG9rZW4pew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iTm8gdXNlcm5hbWUvcGFzc3dvcmQgYW5kIHRva2VuIGFscmVhZHkgZXhpc3RzIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgPCVpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICBsZXQgZGF0YSA9IHsNCiAgICAgICAgICAgICAgICBncmFudF90eXBlOiAncGFzc3dvcmQnLA0KICAgICAgICAgICAgICAgIHVzZXJuYW1lLA0KICAgICAgICAgICAgICAgIHBhc3N3b3JkLA0KICAgICAgICAgICAgICAgIGNsaWVudF9pZCwNCiAgICAgICAgICAgICAgICBjbGllbnRfc2VjcmV0LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIDwlPXNjb3BlJT4uX190b2tlbiAmJiA8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbil7DQogICAgICAgICAgICAgICAgZGF0YSA9IHsNCiAgICAgICAgICAgICAgICAgICAgZ3JhbnRfdHlwZTogInJlZnJlc2hfdG9rZW4iLA0KICAgICAgICAgICAgICAgICAgICByZWZyZXNoX3Rva2VuOiA8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbiwNCiAgICAgICAgICAgICAgICAgICAgY2xpZW50X2lkLA0KICAgICAgICAgICAgICAgICAgICBjbGllbnRfc2VjcmV0LA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAkezwlPXNjb3BlJT4uX190b2tlbi50b2tlbl90eXBlfSAkezwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW59YDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAkezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLnNlY3VyZSgpPydzJzonJ306Ly8kezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLmFkZHJlc3MoKX06JHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5wb3J0KCkgfHwgMzAwMH0vb2F1dGgvdG9rZW5gLCBPYmplY3Qua2V5cyhkYXRhKS5tYXAoa2V5ID0+IGtleSArICc9JyArIGRhdGFba2V5XSkuam9pbignJicpLCBjb25maWcpOw0KICAgICAgICAgICAgaWYocmV0LmRhdGEuYWNjZXNzX3Rva2VuKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fdG9rZW4gPSByZXQuZGF0YTsNCg0KICAgICAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuKXsNCiAgICAgICAgICAgICAgICAgICAgaWYoYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLmNsZWFyKSBheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UuY2xlYXIoKTsNCiAgICAgICAgICAgICAgICAgICAgYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShyZXNwb25zZSA9PiByZXNwb25zZSwgYXN5bmMgZXJyb3IgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxICYmICFvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ICYmIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24uaW5kZXhPZig8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VuKT4wKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fYXV0aG9yaXplKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIDwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW47DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYoYXV0aENsYXNzKXslPg0KICAgIAk8JT1zY29wZSU+Ll9fdG9rZW4gPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShhdXRoQ2xhc3MpJT4oKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLjwlPW1OYW1lLnJlcGxhY2UoJ18nLCAnJyklPigpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIDwlPXdhcm4oKSU+Ik5vIGF1dGhvcml6YXRpb24gZGVmaW5lZCIpOw0KICAgIDwlIH0lPg0KICAgICAgICB9DQo8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7DQo8JX0lPg0KICAgIH0NCiAgICANCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfc2VydmVyJyU+KG9wdGlvbnM9e30pIHsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYob3B0aW9ucy5jbGVhckNvbnNvbGUpIGNvbnNvbGUuY2xlYXIoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fX1Rvb2xzKSA8JT1zY29wZSU+LlRvb2xzID0gPCU9c2NvcGUlPi5fX1Rvb2xzOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZig8JT1zY29wZSU+LmhyZWZzKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgPCU9c2NvcGUlPi5ocmVmcykgew0KICAgICAgICAJCQlhd2FpdCB0aGlzLnJlcXVpcmUobC5saWIsIDwlPXNjb3BlJT4uaHJlZnMsIGFzeW5jIF9sID0+IHsNCiAgICA8JSBpZihfY05hbWUoJ1N0b3JlZFNjcmlwdCcpKXslPg0KICAgICAgICAgICAgICAgICAgICBpZihfbC5zY3JpcHQgJiYgPCU9c2NvcGUlPi5Ub29scykgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU3RvcmVkU2NyaXB0JywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX2wuc2NyaXB0KS5sb2FkU2NyaXB0KCk7DQogICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgIGxldCBzZWN1cmUgPSB0aGlzLl9fY29uZmlnKCdzZWN1cmUnKTsNCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIC8vIGdsb2JhbHMNCiAgICAgICAgICAgICAgICB2YXIgZ2xvYmFsTW9kdWxlcyA9IHsNCiAgICAgICAgICAgICAgICAgICAgZXhwcmVzczogJ2V4cHJlc3MnLA0KICAgICAgICAgICAgICAgICAgICBodHRwczogJ2h0dHBzJywNCiAgICAgICAgICAgICAgICAgICAgaHR0cDogJ2h0dHAnLA0KICAgICAgICAgICAgICAgICAgICBzZWxmc2lnbmVkOiAnc2VsZnNpZ25lZCcsDQogICAgICAgICAgICAgICAgICAgIHV0aWw6ICd1dGlsJywNCiAgICAgICAgICAgICAgICAgICAgY29yczogJ2NvcnMnLA0KICAgICAgICAgICAgICAgICAgICBib2R5UGFyc2VyOiAnYm9keS1wYXJzZXInLA0KICAgICAgICAgICAgICAgICAgICBheGlvczogJ2F4aW9zJywNCiAgICAgICAgICAgICAgICAgICAgLy9jcnlwdG86ICdjcnlwdG8nLA0KICAgICAgICAgICAgICAgICAgICBvczogJ29zJywNCiAgICAgICAgICAgICAgICAgICAgLy9qbWVzcGF0aDogJ2ptZXNwYXRoJywNCiAgICAgICAgICAgICAgICAgICAganNvbnBhdGg6ICdqc29ucGF0aCcsDQogICAgICAgICAgICAgICAgICAgIGpzb25hdGE6ICdqc29uYXRhJywNCiAgICAgICAgICAgICAgICAgICAgRG90T2JqZWN0OiAnZG90LW9iamVjdCcsDQogICAgICAgICAgICAgICAgICAgIG1hY2hpbmVpZDogJ25vZGUtbWFjaGluZS1pZCcsDQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtaW5pbWlzdDogJ21pbmltaXN0JywNCiAgICAgICAgICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgICAgIGdyYXBocWxIVFRQOiAnZXhwcmVzcy1ncmFwaHFsJywNCiAgICAgICAgICAgICAgICAgICAgZ3JhcGhxbDogJ2dyYXBocWwnLA0KICAgICAgICAgICAgICAgICAgICBwbGF5Z3JvdW5kOiAnZ3JhcGhxbC1wbGF5Z3JvdW5kLW1pZGRsZXdhcmUtZXhwcmVzcycsDQo8JSB9JT4NCg0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ2VtYWlsLmhvc3QnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbm9kZW1haWxlcjogJ25vZGVtYWlsZXInLA0KPCUgfSU+DQoNCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWyd0b3RwLnNlY3JldCddKXslPg0KICAgICAgICAgICAgICAgICAgICBvdHBhdXRoOiAnb3RwYXV0aCcsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgICAgICAgICAgICAgIGNoaWxkX3Byb2Nlc3M6ICdjaGlsZF9wcm9jZXNzJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgICAgICAgICAgICAgICAgIGV2ZW50czogJ2V2ZW50cycsDQogICAgICAgICAgICAgICAgICAgIHNvY2tldGlvOiAnc29ja2V0LmlvJywNCiAgICAgICAgICAgICAgICAgICAgbXF0dDogJ21xdHQnLA0KICAgICAgICAgICAgICAgICAgICBhbXFwbGliOiAnYW1xcGxpYicsDQogICAgICAgICAgICAgICAgICAgIHByb3RvYnVmanM6ICdwcm90b2J1ZmpzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBmczogJ2ZzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydLYWZrYSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAga2Fma2FqczogJ2thZmthanMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBuZW80ajogJ25lbzRqLWRyaXZlcicsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgICAgICAgICBPQXV0aFNlcnZlcjogJ2V4cHJlc3Mtb2F1dGgtc2VydmVyJywNCjwlIH1lbHNlIGlmKGF1dGhDbGFzcyl7JT4NCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuOiAnanNvbndlYnRva2VuJywNCjwlIH0lPg0KDQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NxbERCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBzcWxpdGU6ICdzcWxpdGUzJywNCiAgICAgICAgICAgICAgICAgICAgbXlzcWw6ICdteXNxbCcsDQogICAgICAgICAgICAgICAgICAgIHBvc3RncmVzOiAncGcnLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydTbm93Rmxha2UnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIHNub3dmbGFrZTogJ3Nub3dmbGFrZS1zZGsnLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydNb25nb0RCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBtb25nb2RiOiAnbW9uZ29kYicsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ1J4REInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIFJ4REI6ICdyeGRiJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnRXhjZWwnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIFhMU1g6ICd4bHN4JywNCjwlIH0lPg0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgbWlzc2luZ0dsb2JhbE1vZHVsZXMgPSBPYmplY3QuZW50cmllcyhnbG9iYWxNb2R1bGVzKS5tYXAoZSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbFtlWzBdXSA9IHJlcXVpcmUoZVsxXSk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlWzFdOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSkuZmlsdGVyKGUgPT4gZSk7DQogICAgICAgICAgICAgICAgaWYobWlzc2luZ0dsb2JhbE1vZHVsZXMubGVuZ3RoKSA8JT13YXJuKCklPiJucG0gaW5zdGFsbCAiICsgbWlzc2luZ0dsb2JhbE1vZHVsZXMuam9pbignICcpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgIAkJPCU9bG9nKCklPmBTdGFydGluZyBbJHs8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCk6Jyd9XS4uLmApOw0KDQoJCQlpZiAob3B0aW9ucy5sb2FkVG9vbHMpIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpIHx8IF9jTmFtZSgpJT4oKS5fbG9hZFRvb2xzKG9wdGlvbnMuc2F2ZVRvb2xzKTsNCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyAgLyogVG9vbHMgZmlyc3Qgb3IgTm9kZXMgZmlyc3Q/Pz8gKi8lPg0KICAgICAgICAgICAgaWYob3B0aW9ucy5pbml0Tm9kZSl7DQogICAgICAgICAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUgPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuc2VjdXJlKHNlY3VyZSkuaW5pdCh0aGlzLl9fY29uZmlnKCdpbml0Lmxvb3AnLCAwLjUpKTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9bnNjb3BlJT4uX25vZGUpPT09J3VuZGVmaW5lZCcpIHJldHVybiA8JT1lcnJvcigpJT4iPCU9bnNjb3BlJT4uX25vZGUgaXMgdW5kZWZpbmVkISIpOw0KICAgICAgICAgICAgfQ0KPCUgfSU+DQoNCiAgICAJCWlmICh0eXBlb2YodGhpcy5pbml0KT09PSdmdW5jdGlvbicgJiYgb3B0aW9ucy5pbml0U2VsZikgew0KICAgIAkJCWF3YWl0IHRoaXMuaW5pdCgpOw0KICAgIA0KICAgIAkJCWxldCBzcWxUb29sID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Ll9fZG1sU3RhdGVtZW50cyk7DQogICAgCQkJaWYgKG9wdGlvbnMuY29weURNTCAmJiBzcWxUb29sKSB7DQogICAgCQkJCWxldCBkbWxzID0gc3FsVG9vbC5fX2RtbFN0YXRlbWVudHM7DQogICAgCQkJCWlmIChzcWxUb29sLnR5cGUubmFtZSA9PSAnU3FsREInKSBkbWxzID0gWyAvKiJDdXN0b21lcnMiLCAiT3JkZXJzIiwgIlNoaXBwaW5ncyIsICovICJkZW1vIl0ubWFwKHQgPT4gYGRyb3AgdGFibGUgaWYgZXhpc3RzICR7dH1gKS5jb25jYXQoZG1scyk7DQogICAgCQkJCV9GckVNRC5fY29weVRleHRUb0NsaXBib2FyZChkbWxzLmpvaW4oJztcbicpKTsNCiAgICAJCQl9DQogICAgCQl9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZSBUeXBlJykpeyAvKnRvZG86IHJlcGxhY2UgdGhpcyB3aXRoIGFuIE9UQVVwZGF0ZSBjb25jZXB0ICovJT4NCiAgICAgICAgICAgIC8vIHJlZnJlc2ggc2NyaXB0DQogICAgICAgICAgICB0aGlzLnNldEludGVydmFsKG51bGwsIGFzeW5jICgvKnZlcnNpb24qLykgPT4gew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuc3IoKS5iTG9jYWwpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc2N0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlIFR5cGUnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCg8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+IHx8IHtuYW1lOiAnTm9kZUpTJ30pOw0KICAgICAgICAgICAgICAgIGxldCBjdCA9IGF3YWl0IHNjdC5maW5kKCk7DQogICAgICAgICAgICAgICAgaWYoIWN0IHx8ICFjdC5hY3RpdmUoKSB8fCAhY3QuZW5hYmxlZCgpKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYoICFzY3QuZGF0ZSgpIHx8ICgoY3QuZGF0ZSgpLmdldFRpbWUoKSAtIHNjdC5kYXRlKCkuZ2V0VGltZSgpKS8xMDAwKSA+IDUgKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBOZXdlciB2ZXJzaW9uIGZvdW5kOiBbZGF0ZTogJHtjdC5kYXRlKCkudG9JU09TdHJpbmcoKX0sIHRvb2w6ICR7Y3QuVG9vbC5uYW1lfV0sIHN0b3JpbmcuLi5gKTsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB3YW50IHRvIHN0b3JlIHRoZSBjb250ZW50IGRpcmVjdGx5IHRvIHRoZSBub2RlanMuanMgZmlsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY3QuX2ZpbGVzeXN0ZW0oY3QuY29kZSgpICsgJy5qcycsIHRoaXMuX2F0b2IoY3QucmVtYXJrKCkpKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LnNlbGYgIT09IHdpbmRvdy50b3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ImlGcmFtZSBzaG91bGQgYmUgcmVzdGFydGVkLi4uIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4id2luZG93IGxvY2F0aW9uIHJlbG9hZGluZy4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3dpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJmcmFtZSBjaGVjayIsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+ID0gc2N0LmRhdGUoY3QuZGF0ZSgpKS5uYW1lKGN0Lm5hbWUoKSkuY29kZShjdC5jb2RlKCkpLl90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9LCAwLjUpOw0KPCUgfSU+DQogICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5sb2FkQ29udGVudCAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSB3aW5kb3cub25oYXNoY2hhbmdlID0gYXN5bmMgKCkgPT4gZG9jdW1lbnQuYm9keSA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7dG1wOiBsb2NhdGlvbi5oYXNoLnBhZ2V9KTsNCiAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGNvcnMoKSk7DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZSwgbGltaXQ6ICc1MG1iJ30pKTsNCiAgICAgICAgICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7DQogICAgICAgICAgICAgICAgICAgIHZlcmlmeTogKHJlcSwgcmVzLCBidWYpID0+IHJlcS5yYXdCb2R5ID0gYnVmDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddOw0KICAgICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuLnZlcmlmeSh0b2tlbiwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIChlcnIsIG9iaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoID0gbmV3IE9BdXRoU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgZGVidWc6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIHVzZUVycm9ySGFuZGxlcjogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWVNaWRkbGV3YXJlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyByZXF1aXJlQ2xpZW50QXV0aGVudGljYXRpb246IHsgcGFzc3dvcmQ6IGZhbHNlIH0sDQogICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtb2RlbDogKCgpID0+ICh7DQogICAgICAgICAgICAgICAgCQlnZXRBY2Nlc3NUb2tlbjogYmVhcmVyVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5hY2Nlc3NUb2tlbihiZWFyZXJUb2tlbikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0QWNjZXNzVG9rZW4nKSkudGhlbih0ID0+IHt0LmFjY2Vzc1Rva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5hY2Nlc3NUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICBnZXRDbGllbnQ6IChjbGllbnRJZCwgY2xpZW50U2VjcmV0KSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pbml0KCkuZmluYWxseSgoKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZChjbGllbnRJZCkuc2VjcmV0KGNsaWVudFNlY3JldCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldENsaWVudCcpKSwNCiAgICAgICAgICAgICAgICAJICAgIGdldFVzZXI6ICh1c2VybmFtZSwgcGFzc3dvcmQpID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLmF1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0VXNlcicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHNhdmVUb2tlbjogKHRva2VuLCBjbGllbnQsIHVzZXIpID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuX2Zyb21Eb2N1bWVudCh0b2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLl9mcm9tRG9jdW1lbnQoY2xpZW50KSkudXNlcih1c2VyKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdG9yZSgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnc2F2ZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgcmV2b2tlVG9rZW46IHRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkucmVmcmVzaFRva2VuKHRva2VuLnJlZnJlc2hUb2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLmlkKHRva2VuLmNsaWVudC5pZCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkpLmZpbmQoKS50aGVuKHQgPT4gdC5lbmFibGVkKGZhbHNlKS5hY3RpdmUoZmFsc2UpLnN0b3JlKCkpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAncmV2b2tlVG9rZW4nKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRSZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoMi8qd2h5Ki8pLnRoZW4odCA9PiB0Ll90b0RvY3VtZW50KCkpLnRoZW4odCA9PiB7dC5yZWZyZXNoVG9rZW5FeHBpcmVzQXQgPSBuZXcgRGF0ZSh0LnJlZnJlc2hUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgIAkgICAgICAgIH0pKSgpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoLmhhbmRsZXIgPSAodCwgbSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtKSA8JT1sb2coKSU+bSwgdC5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Ll90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPm0sIGV4LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9vYXV0aC90b2tlbicsIGFwcC5vYXV0aC50b2tlbigpKTsNCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXBwLm9hdXRoLmF1dGhlbnRpY2F0ZSgpOw0KPCUgfSU+DQoNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gbS5Jc1B1YmxpYykuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCjwlIH0pKSU+DQoNCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOw0KICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgYXBwLnVzZSgnL2dyYXBocWwnLCBncmFwaHFsSFRUUC5ncmFwaHFsSFRUUCh7DQogICAgICAgICAgICAgICAgICAgIHNjaGVtYTogZ3JhcGhxbC5idWlsZFNjaGVtYSh0aGlzLl90b0dRTFNjaGVtYSgpKSwNCiAgICAgICAgICAgICAgICAgICAgcm9vdFZhbHVlOiB0aGlzLl9xbFJlc29sdmVyKCksDQogICAgICAgICAgICAgICAgICAgIGdyYXBoaXFsOiB0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIiksDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoInBsYXlncm91bmQiKSAmJiB0eXBlb2YocGxheWdyb3VuZCkhPT0idW5kZWZpbmVkIikgYXBwLmdldCgnL3BsYXlncm91bmQnLCBwbGF5Z3JvdW5kLmRlZmF1bHQoeyBlbmRwb2ludDogJy9ncmFwaHFsJyB9KSkNCjwlIH0lPg0KDQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKT97DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksDQogICAgICAgICAgICAgICAgICAgICAgICB9OnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAgICBhd2FpdCA8JT1zY29wZSU+LnRyYW5zcG9ydGVyLnNlbmRNYWlsKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdG8sDQogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwb3J0ID0gPCU9bnNjb3BlJT4uX25vZGU/KDwlPW5zY29wZSU+Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKTozMDAwOw0KICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gIjAuMC4wLjAiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiA8JT1sb2coKSU+YDwlPXNjb3BlJT5bJHt0aGlzLmlwQWRkcmVzcygpfV0gbGlzdGVuaW5nIGF0IGh0dHAke3NlY3VyZT8ncyc6Jyd9Oi8vJHthZGRyZXNzfToke3BvcnR9YCk7DQogICAgICAgICAgICAgICAgaWYoc2VjdXJlKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNlcnQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZTogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gc2VsZnNpZ25lZC5nZW5lcmF0ZShbeyBuYW1lOiAnY29tbW9uTmFtZScsIHZhbHVlOiAnbmFtbW91ci5jb20nIH1dLCB7IGRheXM6IDM2NSB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwcy5jcmVhdGVTZXJ2ZXIoew0KICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBjZXJ0LnByaXZhdGUsDQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiBjZXJ0LmNlcnQNCiAgICAgICAgICAgICAgICAgICAgfSwgYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW5ib3VuZENhbGwnJT4ocmVxLCByZXMsIGNOYW1lLCBtTmFtZSl7DQogICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IDwlPXNjb3BlJT5bcmVxLnBhcmFtcy5jbGFzcyB8fCBjTmFtZV0oKS5faW52b2tlKHJlcS5wYXJhbXMubWV0aG9kIHx8IG1OYW1lLCByZXEuYm9keSwgcmVxLnF1ZXJ5LCByZXEuX19hdXRob3JpemF0aW9uKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBFeGNlcHRpb246ICJFeGNlcHRpb246ICIgKyBleCwNCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgdHlwZW9mKHJldCk9PT0ibnVtYmVyIikgcmV0ID0gcmV0LnRvU3RyaW5nKCk7DQogICAgICAgIHJlcy5zZW5kKHJldCk7DQogICAgfQ0KDQo8JSBpZihjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgIDwlPW1OYW1lPSdfcWxTZWxlY3Rpb25zJyU+KHNTZXQpew0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIGlmKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7DQogICAgICAgIA0KICAgICAgICBzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHMubmFtZS52YWx1ZT09IjwlPW5OYW1lKGVhKSU+Iil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPidSZWZlcmVuY2UgZm9yIDwlPW5OYW1lKGVhKSU+Jywgcyk7DQogICAgICAgICAgICAgICAgbGV0IHNPYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bk5hbWUoZWEpJT5fPCU9Yy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goc09iaik7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19xbFJlc29sdmVyJyU+KCl7DQogICAgICAgIHJldHVybiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKF9jKSU+OiBhc3luYyAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXBhcmVudC5kYXRhKSBwYXJlbnQucXVlcnkgPSBwYXJlbnQucXVlcnkgfHwge307DQogICAgICAgICAgICAgICAgbGV0IG9iaiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuX2Zyb21Eb2N1bWVudChwYXJlbnQucXVlcnkgfHwgcGFyZW50LmRhdGEpOw0KICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKHBhcmVudC5xdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZHMgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouZmluZEFsbChudWxsLCBvYmouX3FsU2VsZWN0aW9ucyhjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0KSwgbnVsbCwgbnVsbCwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0uY29uY2F0KGNvbnRleHQuZmllbGROb2Rlc1swXS5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucy5tYXAocyA9PiBzLm5hbWUudmFsdWUpKSk7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYocGFyZW50LmRhdGEpew0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouc3RvcmUoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYob2JqLl9fYXNzZXJ0RXJyb3IpIHRocm93IG9iai5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0Lm1hcChyID0+IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ/cmV0Ll90b0RvY3VtZW50KCk6cmV0Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5mb3JFYWNoKF9tID0+IHslPg0KICAgICAgICAgICAgLy8gPCU9bk5hbWUoX20pJT46IChwYXJlbnQsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuPCU9bk5hbWUoX20pJT4oIjwlPW5OYW1lKF9tKSU+IiwgcGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSwNCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgIH07DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9HUUxTY2hlbWEnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IGANCnR5cGUgUXVlcnkgew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgRmluZCBhbGwgbWF0Y2hlcyBmb3IgPCU9bk5hbWUoX2MpJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihxdWVyeTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IFs8JT1uTmFtZShfYyklPl0NCjwlIH0pJT4NCn0NCg0KdHlwZSBNdXRhdGlvbiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAiIiINCiAgICBTdG9yZSBhIHNpbmdsZSA8JT1uTmFtZShfYyklPiBvYmplY3QNCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihkYXRhOiA8JT1uTmFtZShfYyklPklucHV0KTogPCU9bk5hbWUoX2MpJT4NCjwlIH0pJT4NCn0NCiAgICANCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiIiIg0KSW5wdXQgdHlwZSBmb3IgPCU9bk5hbWUoX2MpJT4NCiIiIg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5JbnB1dHsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEsIHRydWUpJT4NCiAgICA8JSB9KSU+DQogICAgPCUgX2MuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kICYmIHRhLkVudGl0eVR5cGUpLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsgJT4NCiAgICA8JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjogWzwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+SW5wdXRdDQogICAgPCUgfSklPg0KICAgIE9QRVJBVE9SUzogPCU9bk5hbWUoX2MpJT5PcGVyYXRvcg0KfQ0KDQppbnB1dCA8JT1uTmFtZShfYyklPk9wZXJhdG9yew0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bk5hbWUoZWEpJT46IFN0cmluZw0KICAgIDwlIH0pJT4NCn0NCg0KIiIiDQo8JT1fYy5SZW1hcmslPg0KIiIiDQp0eXBlIDwlPW5OYW1lKF9jKSU+ew0KICAgIF9pZDogSUQhDQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1lYS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEpJT48JT1lYS5Jc1JlcXVpcmVkPychJzonJyU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPl0NCiAgICA8JSB9KSU+DQoNCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiAhX20uTWV0aG9kUGFyYW1ldGVycy5sZW5ndGgpLmZvckVhY2goX20gPT4geyU+DQogICAgIiIiDQogICAgPCU9X20uUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfbSklPjogPCU9cWxUeXBlKF9tLlJlc3BvbnNlQXR0cmlidXRlLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKF9tID0+IF9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT4oPCU9X20uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuTmFtZShwKSArICc6ICcgKyBxbFR5cGUocCwgdHJ1ZSkpLmpvaW4oJywgJyklPik6IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSklPg0KICAgIDwlIH0pJT4NCn0NCiAgICA8JSB9KSU+DQogICAgICAgIGA7DQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gLy8gZ3JhcGglPg0KDQo8JSB9IC8vIElzTWFpbiAlPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2VOb2RlJyU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsNCiAgICAgICAgLy8gaWYoIW4pIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKDwlPW5zY29wZSU+Ll9ub2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5zY29wZSU+Ll9ub2RlIG5vdCBkZWZpbmVkIik7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoZXZlbnQpew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkhPSc8JT1uTmFtZShjKSU+Jyl7DQogICAgICAgICAgICAgICAgbGV0IG9DbGFzcyA9IG51bGw7DQogICAgICAgICAgICAgICAgaWYoZmFsc2Upew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkrJy4nK21ldGhvZCsnIC4uLi4nKTsNCiAgICA8JSBzci5ncm91cEJ5KGFyQ2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLmZvckVhY2goZW0gPT4geyU+DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoWyI8JT1lbS52YWx1ZXMubWFwKG1jID0+IG5OYW1lKG1jKSkuam9pbignIiwgIicpJT4iXS5pbmRleE9mKGV2ZW50LmNsYXNzTmFtZSgpKT49MCl7DQogICAgICAgICAgICAgICAgICAgIG9DbGFzcyA9IG5ldyA8JT1zY29wZSU+PCU9ZW0ua2V5PygnLicrZW0ua2V5LkFsaWFzKTonJyU+W2V2ZW50LmNsYXNzTmFtZSgpXSgpOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG9DbGFzcy48JT1tTmFtZSU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOw0KICAgICAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIDwlPWVycm9yKCklPiJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQoNCiAgICAgICAgZGF0YSA9IGRhdGEgfHwge307DQoNCiAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0pTT04oe3BhcnNlOiAxfSk7DQogICAgICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCiAgICA8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIGRhdGEuPCU9bk5hbWUocCklPiA9IGRhdGEuPCU9bk5hbWUocCklPj9kYXRhLjwlPW5OYW1lKHApJT4NCiAgICAgICAgICAgIDwlaWYocC5Jc0FycmF5KXslPi5tYXAoX3AgPT4gX3A8JX0lPg0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPi5fdG9Eb2N1bWVudCgpDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihwLklzRGF0ZSl7JT4udG9JU09TdHJpbmcoKQ0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4pPCV9JT46dW5kZWZpbmVkOw0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgIGlmKHR5cGVvZihuKT09PSdzdHJpbmcnKSBuID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLmNvZGUobik7DQo8JSB9JT4NCg0KICAgICAgICBpZighbiB8fCA8JT1uc2NvcGUlPi5fbm9kZS5fc2FtZUVudGl0eShuKSl7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iTG9jYWwgbm9kZSIsIHJldCk7DQoNCiAgICAgICAgfWVsc2UgaWYobi5hZGRyZXNzKCkpew0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5uLmFkZHJlc3MoKSwgbi5wb3J0KCksIG1ldGhvZCk7DQogICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdCh1bmRlZmluZWQsIGRhdGEsIG51bGwsIG51bGwsIHtwYXRoOiBgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvPCU9bk5hbWUoYyklPi8ke21ldGhvZH1gLCBoZWFkZXJzOiB7fX0pOw0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICB9DQogICAgICAgIH1lbHNlew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpICYmIGMuTmFtZSE9PSdFdmVudCcpeyU+DQogICAgICAgICAgICBpZih0eXBlb2YoZGF0YSk9PT0ib2JqZWN0Iil7DQogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOw0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/Pw0KICAgICAgICAgICAgPCUgLyp1blJlY3Vyc2UoJ2RhdGEnLCAnbWV0aG9kJywgJ3t9JywgJycsIDUsICdfX3RoaXMuY29kZScpKi8gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGV2ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICc8JT1zY29wZSU+LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnPCU9bk5hbWUoYyklPicpLnNlbmRlcig8JT1uc2NvcGUlPi5fbm9kZSkuY2Fycmllcig8JT1uc2NvcGUlPi5fbm9kZSkucGF5bG9hZCh0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7DQogICAgICAgICAgICBpZihldmVudCl7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gSlNPTi5wYXJzZShyZXQpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2UgaWYocmV0ICYmIHR5cGVvZihyZXQucGF5bG9hZCk9PT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICAvLyByZXQgaXMgYW4gZXZlbnQNCiAgICAgICAgICAgICAgICByZXQgPSByZXQucGF5bG9hZCgpOw0KICAgICAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShyZXQpICYmIHJldFswXSAmJiB0eXBlb2YocmV0WzBdLnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0Lm1hcChyID0+IHIucGF5bG9hZCgpKTsNCiAgICAgICAgICAgICAgICBpZihyZXQubGVuZ3RoPT0xKSByZXQgPSByZXRbMF07DQogICAgICAgICAgICB9DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoIXJldCkgcmV0dXJuIG51bGw7DQogICAgICAgIHJldCA9IHJldC5kYXRhIHx8IHJldDsNCg0KICAgICAgICBpZihyZXQuX19leGNlcHRpb24pew0KICAgICAgICAgICAgLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXINCiAgICAgICAgICAgIDwlPWVycm9yKCklPmBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9DQoNCiAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgY2FzZSAiPCU9bkNvZGUobSklPiI6IHsNCiAgICA8JSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgIDwlIH0gJT4NCiAgICA8JSBpZihtLk5hbWU9PSdhdXRob3JpemUnKXslPg0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190b2tlbiA9IHt0b2tlbl90eXBlOiAiQmVhcmVyIiwgYWNjZXNzX3Rva2VuOiByZXR9Ow0KICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyAlPg0KDQogICAgICAgICAgICBjYXNlICJpbnNlcnQiOg0KICAgICAgICAgICAgY2FzZSAidXBkYXRlIjoNCiAgICAgICAgICAgIGNhc2UgInN0b3JlIjoNCiAgICAgICAgICAgIGNhc2UgImRlbGV0ZSI6DQogICAgICAgICAgICBjYXNlICJmaW5kIjogDQogICAgICAgICAgICBjYXNlICJmaW5kQWxsIjogew0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KPCUgaWYobWFpbkNsYXNzKCkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2UnJT4obWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iail7DQogICAgICAgIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMpJT4uJyArIG1ldGhvZCk7DQogICAgICAgIDwlPWxvZygpJT5tZXRob2QsIHF1ZXJ5LCBib2R5KTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihib2R5KT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdib2R5JyklPil7IC8vIGJhc2U2ND8NCiAgICAgICAgICAgICAgICBib2R5ID0gdGhpcy5fYXRvYihib2R5KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoL1teLDp7fVxbXF0wLTkuXC0rRWFlZmxuci11IFxuXHJcdF0vLnRlc3QoYm9keSkpeyAvLyBqc29uDQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IF9wYXJhbXMgPSBxdWVyeT9PYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KTpib2R5Ow0KICAgICAgICBpZih0eXBlb2YoX3BhcmFtcyk9PT0nc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7DQogICAgICAgIA0KICAgICAgICBpZihfcGFyYW1zKXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSB7fTsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPWxvZygpJT4iX3BhcmFtcyIsIF9wYXJhbXMpOw0KDQogICAgPCUgaWYoX2NOYW1lKCdOb2RlJykgJiYgYy5OYW1lIT0nTm9kZScpeyU+DQogICAgICAgIGlmKF9wYXJhbXMuX19ub2RlKXsNCiAgICAgICAgICAgIC8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/DQogICAgICAgICAgICBsZXQgdG4gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkvKi5fZGVSZWZlcmVuY2UoKSovOw0KICAgICAgICAgICAgZGVsZXRlIF9wYXJhbXMuX19ub2RlOw0KICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCg0KICAgICAgICBpZihfcGFyYW1zLl9fdGhpcykgew0KICAgICAgICAgICAgX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsNCiAgICAgICAgICAgIGxldCBfX3RoaXMgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLyouX2RlUmVmZXJlbmNlKCkqLzsNCiAgICAgICAgICAgIGRlbGV0ZSBfcGFyYW1zLl9fdGhpczsNCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBfX3RoaXMuPCU9bU5hbWUlPihtZXRob2QsIF9wYXJhbXMsIG51bGwsIGF1dGhPYmopOw0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IGFyQXJncyA9IFtdOw0KICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KPCUgaWYoX2NOYW1lKCdUcmFuc2FjdGlvbicpICYmIF9jTmFtZSgnQ29udGVudCcpICYmIGMuTmFtZSE9J1RyYW5zYWN0aW9uJyAmJiAhbS5Jc1N5bmMpeyU+DQogICAgICAgIGlmKCFfcGFyYW1zLlN5bmMpew0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zY29wZSgiPCU9c2NvcGUlPiIpLmNsYXNzKCI8JT1jLk5hbWUlPiIpLm1ldGhvZChtZXRob2QpLmF1dGhvcml6YXRpb24oYXV0aE9iaikuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucGF5bG9hZCh0aGlzLl9idG9hKF9wYXJhbXMpKS50cmFuc2FjdGlvbl9UcmFuc2FjdGlvbkxvZ3MoW25ldyA8JT1zY29wZSU+LlRyYW5zYWN0aW9uTG9nKCkuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkuc3RhdGUobmV3IDwlPXNjb3BlJT4uVHJhbnNhY3Rpb25TdGF0ZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoImxvYWRlZCIpKV0pLnN0b3JlKCkpLklkKS5fdG9Eb2N1bWVudCgpOw0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSAmJiBwLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgX3BhcmFtcy48JT1uQ29kZShwKSU+ID0gX3BhcmFtcy48JT1uQ29kZShwKSU+Lm1hcChwID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQocCkuX2RlUmVmZXJlbmNlKCkpOw0KICAgICAgICA8JSB9ZWxzZSBpZihwLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIF9wYXJhbXMuPCU9bkNvZGUocCklPiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy48JT1uQ29kZShwKSU+KS5fZGVSZWZlcmVuY2UoKTsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuPCU9bkNvZGUocCklPik7DQogICAgPCUgfSk7JT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyU+DQoNCiAgICAgICAgICAgIGNhc2UgImZpbmRBbGwiOnsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgImZpbmQiOiB7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IG9iaiA9IHRoaXM7DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgaWYoIW9iail7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgJy0xJzogYDwlPW5OYW1lKGMpJT4uPCU9bU5hbWUlPjogb2JqIGlzIHVuZGVmaW5lZGANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZSBpZighb2JqW21ldGhvZF0pew0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICctMic6IGA8JT1uTmFtZShjKSU+LjwlPW1OYW1lJT46IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsDQogICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7DQogICAgICAgIH0NCiAgICAgICAgDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgIGlmKGZhbHNlICYmIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiAmJiAhPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCl7DQogICAgICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAgICAgJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIGlmKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZSA9IHt9Ow0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICBsZXQgX3JldCA9IFtdOw0KICAgICAgICAgICAgICAgIGZvciBhd2FpdChjb25zdCByIG9mIHJldCl7DQogICAgICAgICAgICAgICAgICAgIGlmKHIgJiYgci5fdG9Eb2N1bWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPikgZGVsZXRlIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+Ll90b0RvY3VtZW50Ow0KICAgICAgICAgICAgICAgICAgICAgICAgX3JldC5wdXNoKGF3YWl0IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIF9yZXQucHVzaChyKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0ID0gX3JldDsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KT9hd2FpdCByZXQuX3RvRG9jdW1lbnQoKTpyZXQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT4ncmV0JywgcmV0KTsNCiAgICAgICAgPCU9bG9nKCklPmAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYyklPi4nICsgbWV0aG9kKX1gKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgIDwlPW1OYW1lPSdfcGFyc2VDb2RlU3RhdGUnJT4odCl7DQogICAgPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuX19jb25maWcodGhpcy5fX2NvbmZpZygnb2F1dGgucmVkaXJlY3Quc3RhdGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgbGV0IGNvZGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgaWYoIXN0YXRlIHx8ICFjb2RlKSByZXR1cm47DQogICAgICAgIHN0YXRlID0gSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHN0YXRlKSk7DQogICAgICAgIGlmKHN0YXRlLnRvb2whPT10Lm5hbWUpIHJldHVybjsNCg0KICAgICAgICA8JT1sb2coKSU+IkdPVCBDT0RFICIgKyBjb2RlICsgIiBmb3Igbm9kZSAiICsgc3RhdGUubmNvZGUgKyAiIHdpdGggdG9vbCAiICsgc3RhdGUudG9vbCk7DQogICAgICAgIGlmKCE8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSB8fCAhPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudC5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSkpew0KICAgICAgICAgICAgPCU9bG9nKCklPiduZXcgcGFyZW50Jywgc3RhdGUubmNvZGUpOw0KICAgICAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKHN0YXRlLm5jb2RlKSk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUuYXV0aENvZGUoY29kZSwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUoc3RhdGUudG9vbCkpOw0KICAgICAgICB3aW5kb3cuY2xvc2UoKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHQpOw0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19sb2FkVG9vbHMnJT4oYlN0b3JlKXsNCiAgICAgICAgaWYoPCU9c2NvcGUlPi5Ub29scyAmJiA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFscmVhZHkgbG9hZGVkYCk7DQogICAgICAgICAgICByZXR1cm4gPCU9c2NvcGUlPi5Ub29sczsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmBMb2FkaW5nIHRvb2xzLi4uYCk7DQogICAgICAgIA0KICAgICAgICBsZXQgdG9vbHMgPSBbXTsNCiAgICAgICAgdG9vbHMgPSA8JT1zY29wZSU+Ll9fVG9vbHMgfHwgdG9vbHM7DQogICAgICAgIGRlbGV0ZSA8JT1zY29wZSU+Ll9fVG9vbHM7DQoNCiAgICAgICAgbGV0IGFyVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoWy4uLm5ldyBTZXQoYXJDbGFzc2VzLm1hcChfYyA9PiBfYy5Ub29scykuZmxhdCgpKV0pJT47DQogICAgICAgIGxldCB0b29sTmFtZXMgPSBhclRvb2xzLm1hcCh0ID0+IHQubmFtZSB8fCAodC50eXBlP3QudHlwZS5uYW1lOnQpKTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodG9vbHMubGVuZ3RoIT09dG9vbE5hbWVzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgLy8gY2Fubm90IHVzZSByZXF1aXJlIHlldCwgbm8gdG9vbHMgcHJvcGVybHkgbG9hZGVkIHRvIHVzZSBhIGxvYWRlciBmdW5jdGlvbg0KICAgICAgICAgICAgICAgIHRvb2xzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHtOYW1lOiAnQVBJU0VSVkVSPCU9bU5hbWUlPicsIEFjdGl2ZTogdHJ1ZSwgRW5hYmxlZDogdHJ1ZX0pIHx8IHRvb2xzOw0KICAgICAgICAgICAgfQ0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgICAgIGlmKCF0b29scy5sZW5ndGgpIHRvb2xzID0gKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVG9vbCcsIHRydWUpJT4oKS5USElTKHRvb2xOYW1lcy5tYXAodCA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkubmFtZSh0KSkpLmZpbmRBbGwoMikpLm1hcCh0ID0+IHQuX3RvSlNPTih7cGFyc2U6IDF9KSkgfHwgdG9vbHM7DQo8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgZml4VG9vbHMgPSB0b29scyA9PiB7DQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0Lm5hbWUnLCAndC50eXBlLm5hbWUnKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuZW5hYmxlZCcsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuZW5hYmxlZCcsIHRydWUpJT4NCg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfQ29uZmlncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUudHlwZV9NYXBwaW5ncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnRvb2xfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgIA0KICAgICAgICAgICAgICAgIFtdLmNvbmNhdCh0LnRvb2xfQ29uZmlncywgdC50eXBlLnR5cGVfQ29uZmlncywgdC50eXBlLnR5cGVfTWFwcGluZ3MsIHQudG9vbF9NYXBwaW5ncykuZm9yRWFjaChjID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIHRvb2xzLmZpbHRlcih0ID0+IHR5cGVvZih0KT09PSdvYmplY3QnICYmIHQpLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpIT09Im9iamVjdCIpLmNvbmNhdChEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5maWx0ZXIoYyA9PiB0eXBlb2YoYy52YWx1ZSk9PT0ib2JqZWN0IiAmJiBjLnZhbHVlKS5tYXAoYyA9PiBPYmplY3Qua2V5cyhjLnZhbHVlKS5tYXAobmNvZGUgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF9jID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGMubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYy52YWx1ZVtuY29kZV0sDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobmNvZGUhPSJkZWZhdWx0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Mubm9kZSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogbmNvZGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsIDwlLy8gb3RoZXJ3aXNlIGl0IHN0YXJ0cyBnZXR0aW5nIGV2ZW50cyU+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJOb2RlSlMiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfYzsNCiAgICAgICAgICAgICAgICAgICAgfSkuZmxhdCgpKS5mbGF0KCkpLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZm9yRWFjaChjID0+IGMudmFsdWUgPSBKU09OLnN0cmluZ2lmeShjLnZhbHVlKSk7DQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICk7DQogICAgICAgIH07DQoNCg0KICAgICAgICBmaXhUb29scyh0b29scyk7DQogICAgICAgIHRvb2xzID0gdG9vbHMuZmlsdGVyKHQgPT4gdC5hY3RpdmUpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHRvb2xOYW1lcy5maW5kKF90ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KDQogICAgICAgIDwlPWxvZygpJT5gVG9vbHMgYXJlICR7dG9vbHMubGVuZ3RofWApOw0KDQogICAgICAgIDwlPXNjb3BlJT4uVG9vbHMgPSB0b29sczsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zICYmIDwlPUpTT04uc3RyaW5naWZ5KF9yZXN0VG9vbHMpJT4uaW5kZXhPZih0LnR5cGUubmFtZSk+PTApLmZvckVhY2godCA9PiB7DQogICAgICAgICAgICB0LmF4aW9zID0gdHlwZW9mKGF4aW9zLmNyZWF0ZSk9PT0nZnVuY3Rpb24nP2F4aW9zLmNyZWF0ZSgpOmF4aW9zOw0KICAgICAgICAgICAgdC5heGlvcy5pbnRlcmNlcHRvcnMucmVxdWVzdC51c2UocmVxdWVzdCA9PiB0aGlzLl9yZXF1ZXN0SW50ZXJjZXB0b3IocmVxdWVzdCwgdCksIGVycm9yID0+IHt9KTsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShyZXNwb25zZSA9PiByZXNwb25zZSwgZXJyb3IgPT4gdGhpcy5fcmVzcG9uc2VJbnRlcmNlcHRvcihlcnJvciwgdCkpOw0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIC8vIGNvbm5lY3QgdG8gdGhlIGxvYWRlZCB0b29scyEhIQ0KICAgICAgICBsZXQgdG9vbCA9IHRoaXMuVG9vbDsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4uVG9vbHMpew0KPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHtlbS52YWx1ZXMgPSBlbS52YWx1ZXMuc29ydCgoYSwgYikgPT4gYi5SYW5rIC0gYS5SYW5rKTsgJT4NCiAgICAgICAgICAgIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlbS52YWx1ZXNbMF0sIHRydWUpJT4odW5kZWZpbmVkLCB0KS5fc3RvcmVFbnRpdHlDbGFzcyg8JT1lbS52YWx1ZXNbMF0uUmFuayU+KTsNCjwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLlRvb2wgPSB0b29sOw0KICAgICAgICANCiAgICAgICAgYXJUb29scyA9IGFyVG9vbHMuZmlsdGVyKF90ID0+ICF0b29scy5maW5kKHQgPT4gKHR5cGVvZihfdCk9PT0nc3RyaW5nJz9fdDpfdC5uYW1lKT09dC5uYW1lKSk7DQogICAgICAgIGZpeFRvb2xzKGFyVG9vbHMpOw0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgPCU9c2NvcGUlPi5vVG9vbHMgPSA8JT1zY29wZSU+LlRvb2xzLmNvbmNhdChhclRvb2xzKS5maWx0ZXIodCA9PiB0LmFjdGl2ZSkubWFwKHQgPT4gew0KICAgICAgICAgICAgdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50b29sKTsNCiAgICAgICAgICAgIHQudHlwZS50eXBlX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50eXBlKTsNCiAgICANCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCh0KTsNCiAgICAgICAgfSk7DQogICAgICAgIGlmKGJTdG9yZSl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFNhdmluZyB0b29scy4uLmApOw0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4ub1Rvb2xzKXsNCiAgICAgICAgICAgICAgICBhd2FpdCB0LnN0b3JlKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCjwlIH0lPg0KDQogICAgICAgIDwlPWxvZygpJT5gRXhpdGluZ2ApOw0KICAgICAgICByZXR1cm4gdG9vbHM7DQogICAgfQ0KICAgIA0KPCUgfSAvLyBtYWluQ2xhc3MgJT4NCg0KCTwlPW1OYW1lPSdfcGFyYW1ldHJpemUnJT4oc3RyLCBmdW4sIG9wdGlvbnM9e30sIHByZWZpeD0ne3snLCBwb3N0Zml4PSd9fScpIHsNCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2Yoc3RyKSE9PSdzdHJpbmcnKSByZXR1cm4gc3RyOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV4ID0gYCR7cHJlZml4fShbXiR7cG9zdGZpeH1dKykke3Bvc3RmaXh9YDsNCiAgICAgICAgICAgIChzdHIubWF0Y2gobmV3IFJlZ0V4cChyZXgsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gc3RyID0gc3RyLnJlcGxhY2UobSwgbSA9PiBmdW4obS5yZXBsYWNlKHByZWZpeCwgJycpLnJlcGxhY2UocG9zdGZpeCwgJycpKSkpOw0KDQogICAgICAgICAgICByZXR1cm4gc3RyOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHN0ciwgZnVuLCBvcHRpb25zLCBwcmVmaXgsIHBvc3RmaXgpOw0KPCUgfSU+DQoJfQ0KDQogICAgPCU9bU5hbWU9J19fc3luY19vbiclPihkKXsNCiAgICAgICAgdGhpcy5fPCU9bU5hbWUlPiA9IHRoaXMuXzwlPW1OYW1lJT4gfHwge307DQogICAgDQogICAgICAgIGlmKGQpeyAvLyBzZXQgdGhlIHZhbHVlDQogICAgICAgICAgICB0aGlzLl88JT1tTmFtZSU+W3RoaXMuVG9vbC5uYW1lXSA9IGQ7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KHRoaXMsIHsNCiAgICAgICAgICAgICAgICBDeWNsaWM6IHRydWUsDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk6dW5kZWZpbmVkLA0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICAvLzwlPXRhTmFtZSU+OiB0aGlzLjwlPXRhTmFtZSU+KCkuZm9yRWFjaCh0ID0+IHQuPCU9bU5hbWUlPihkKSksDQo8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGQpOw0KDQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSkgdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk7DQo8JSB9KSU+DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgLy8gdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpOw0KPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV07IC8vIGdldCB0aGUgdmFsdWUNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19jbG9uZSclPihiVHlwZUF0dHJpYnV0ZXMpew0KICAgICAgICA8JT13YXJuKCklPiJERVBSRUNBVEVEOiB1c2UgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodGhpcy5fdG9KU09OKCkpIik7DQoNCiAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIA0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCksIHsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4odjwlaWYoZWEuRW50aXR5VHlwZSl7JT4uPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpPCV9JT4pLA0KPCUgfSk7JT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IGJUeXBlQXR0cmlidXRlcz9vYmouPCU9dGFOYW1lJT4odi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpKSk6bnVsbCwNCjwlIH0pOyU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19tYXAnJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsNCiAgICAgICAgdG9vbCA9IHRvb2wgfHwgX3RoaXMuVG9vbDsNCiAgICAgICAgY29kZVR5cGUgPSBjb2RlVHlwZSB8fCA8JT1fZWFUeXBlcygpJT5bY29kZV07DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIG1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lIHx8ICI8JT1jLkVudGl0eU1vZHVsZT9jLkVudGl0eU1vZHVsZS5OYW1lOicnJT4iOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBfbG9nID0gYCR7bW9kdWxlTmFtZX0uJHtjbGFzc05hbWV9LiR7Y29udGV4dH0ke2JSZXZlcnNlPyc8PSc6Jz0+J30ke2NvZGV9YDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy9pZihBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKSk7DQogICAgICAgIA0KICAgICAgICAgICAgPCUgLyogdGVtcHRlZCB0byB1c2UganNvbmF0YSBpbiBRdWVyeSBmaWVsZHMsIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBqc29uYXRhLmV2YWx1YXRlIHJldHVybiBhIHByb21pc2UhISEgKi8lPg0KICAgICAgICAgICAgbGV0IHNGaWVsZCA9IGJSZXZlcnNlPyd0YXJnZXQnOidzb3VyY2UnOw0KICAgICAgICAgICAgbGV0IHNTY3JpcHQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgc0NvbmQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ0NvbmRpdGlvbic7DQogICAgICAgICAgICBsZXQgc1BhdGggPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRGaWVsZCA9IGJSZXZlcnNlPydzb3VyY2UnOid0YXJnZXQnOw0KICAgICAgICAgICAgbGV0IHRTY3JpcHQgPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgdFBhdGggPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRDb25kID0gKGJSZXZlcnNlPydpbic6J291dCcpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPmNsYXNzTmFtZSwgX2xvZywgLi4ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvcHRpb25zID0ge19jbGFzczogY2xhc3NOYW1lLCBfdGhpczogX3RoaXMsIHRvb2w6IHRvb2x9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX3NjcmlwdCA9IChzLCBtKSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW5TY3JpcHQoYChvU2NvcGUsIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcikgPT4gJHtzfWApKDwlPXNjb3BlJT4sIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgd2FybihtLnRlc3RzLmxvZywgZXgpOyANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX21hdGNoID0gKHMsIHIpID0+IHsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yocyk9PT0ndW5kZWZpbmVkJyB8fCBzPT09bnVsbCB8fCB0eXBlb2Yocy5tYXRjaCkhPT0nZnVuY3Rpb24nKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IHMubWF0Y2gobmV3IFJlZ0V4cChyLCAnZycpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gcz09ciB8fCAoKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKT90cnVlOmZhbHNlKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBpdGVtcyA9PiBpdGVtcy5tYXAoaXRlbSA9PiBBcnJheS5pc0FycmF5KGl0ZW0pID8gY2xvbmUoaXRlbSkgOiBpdGVtKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG1zID0gY2xvbmUoIFsuLi4odG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pXSApOyAvLyBkbyBub3QgdGFtcGVyIHdpdGggdGhlIG1hcHBpbmdzLCBkZWVwIGNsb25lDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gT2JqZWN0LmtleXMobSkuZm9yRWFjaChrID0+IG1ba10gPSB0aGlzLl9wYXJhbWV0cml6ZShtW2tdLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpKSk7DQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gbS50ZXN0cyA9IHsNCiAgICAgICAgICAgICAgICBhY3RpdmU6IDwldmFsdWVPZigibS5hY3RpdmUiKSU+LCAvL19zY3JpcHQobS5hY3RpdmUsIG0pLA0KICAgICAgICAgICAgICAgIGVuYWJsZWQ6IDwldmFsdWVPZigibS5lbmFibGVkIiklPiwgLy9fc2NyaXB0KG0uZW5hYmxlZCwgbSksDQogICAgICAgICAgICAgICAgY29udGV4dDogX21hdGNoKGNvbnRleHQsIG0uY29udGV4dCksDQogICAgICAgICAgICAgICAgY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwNCiAgICAgICAgICAgICAgICBtb2R1bGU6IF9tYXRjaChtb2R1bGVOYW1lLCBtLm1vZHVsZU5hbWUpLA0KICAgICAgICAgICAgICAgIHNGaWVsZDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSksDQogICAgICAgICAgICAgICAgc1NjcmlwdDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgc1BhdGg6IHR5cGVvZihtW3NQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHR5cGVvZihtW3RGaWVsZF0gfHwgbVt0U2NyaXB0XSB8fCBtW3RQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0ZXh0OiBgJHtjb2RlfToke3NGaWVsZH09PT4ke3RGaWVsZH1gLA0KICAgICAgICAgICAgICAgIGxvZzogYCR7X2xvZ31bJHttLmNvbnRleHR9LyR7bS5jbGFzc05hbWV9XWAsDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIG1zID0gbXMuZmlsdGVyKG0gPT4gbS50ZXN0cy5hY3RpdmUgJiYgbS50ZXN0cy5lbmFibGVkICYmIG0udGVzdHMuY29udGV4dCAmJiBtLnRlc3RzLmNsYXNzICYmIG0udGVzdHMubW9kdWxlICYmIChtLnRlc3RzLnNGaWVsZCB8fCBtLnRlc3RzLnNTY3JpcHQgfHwgbS50ZXN0cy5zUGF0aCkgJiYgbS50ZXN0cy50YXJnZXQpLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCUgLyogd2UgbWlnaHQgbm90IHdvcmsgd2l0aCBhbGwgbXMgZW50cmllcy4gbG9nIGhlcmUgaXMgb25seSBhIHByZXZpZXcgb2Ygd2hhdCBtaWdodCB3b3JrISAqLyAlPg0KICAgICAgICAgICAgLy9pZihtcy5maWx0ZXIobSA9PiBtLmRlYnVnKS5sZW5ndGgpIGxvZyh0aGlzLl9iZWF1dGlmeShtcy5maWx0ZXIobSA9PiBtLmRlYnVnKSwgJ2phdmFzY3JpcHQnKSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiB7DQogICAgICAgICAgICAgICAgaWYobVt0U2NyaXB0XSl7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RDb25kXSk9PT0ndW5kZWZpbmVkJyB8fCA8JXZhbHVlT2YoIm1bdENvbmRdIiwgJ190aGlzJyklPil7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnKSBsb2cobS50ZXN0cy5sb2cgKyAnOiAnICsgdFNjcmlwdCwgJzwlPW1OYW1lJT4nLCBtW3RTY3JpcHRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSA8JXZhbHVlT2YoIm1bdFNjcmlwdF0iLCAnX3RoaXMnKSU+DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0gam1lc3BhdGguc2VhcmNoKG9iakZyb20sIG1bc1BhdGhdKTsNCiAgICAgICAgICAgICAgICBpZihtW3NQYXRoXSAmJiB0eXBlb2YoanNvbnBhdGgpIT09J3VuZGVmaW5lZCcpIGNvZGUgPSBqc29ucGF0aC5xdWVyeShvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0RmllbGRdKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGRQYXRoID0gJyc7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RGaWVsZF0pPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5yZXBsYWNlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAobVtzRmllbGRdLCAnZycpLCBtW3RGaWVsZF0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9jb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGAke2NvZGV9LmNvZGVgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gbVt0RmllbGRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYGRvdGNvcHlgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSBEb3RPYmplY3QuY29weShtW3NGaWVsZF0sIG1bdEZpZWxkXSwgb2JqRnJvbSwgb2JqVG8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnICYmIGRQYXRoKSBsb2coYCR7bS50ZXN0cy5sb2d9LyR7ZFBhdGh9W2NvZGU9JHtjb2RlfV06ICR7bVtzRmllbGRdfSA9PiAke21bdEZpZWxkXX1gKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwgam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0gam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdENvbmRdKSkpIG9ialRvW21bdEZpZWxkXV0gPSBqc29ucGF0aC5xdWVyeShvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiBkZWxldGUgbS50ZXN0cyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gb2JqVG87DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoY29udGV4dD09J0VudGl0eUNsYXNzJyAmJiBjbGFzc05hbWU9PSdVc2VyJykgPCU9d2FybigpJT4iR09UIEhFUkUiLCBjb2RlLCBjb250ZXh0LCBvcHRpb25zKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJhbWV0cml6ZShjb2RlLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19uQ29kZSclPihjb2RlLCBvQ29kZSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgICAgICBpZighY29kZSAmJiAhb0NvZGUpew0KICAgICAgICAgICAgICAgIGNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOw0KICAgICAgICAgICAgICAgIGNvZGUgPSAiPCU9bkNvZGUoYyklPiI7DQogICAgICAgICAgICAgICAgb0NvZGUgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db2RlKSU+Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgcmV0ID0gY29kZTsNCiAgICAgICAgICAgIGlmKG9Db2RlICYmIHR5cGVvZihvQ29kZSk9PT0nb2JqZWN0Jyl7DQogICAgICAgICAgICAgICAgcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IG9Db2RlW3RoaXMuVG9vbC50eXBlLm5hbWVdIHx8IHJldDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21hcChyZXQsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgICAgIHJldHVybiBjb2RlOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfX2NvbmZpZyclPihuLCBudWxsVmFsdWUsIG9wdGlvbnMpew0KICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCiAgICAgICAgb3B0aW9ucy5fdGhpcyA9IG9wdGlvbnMuX3RoaXMgfHwgdGhpczsNCiAgICAgICAgb3B0aW9ucy5fY2xhc3MgPSBvcHRpb25zLl9jbGFzcyB8fCAnPCU9bk5hbWUoYyklPic7DQogICAgICAgIG9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCBvcHRpb25zLl90aGlzLlRvb2wgfHwgdGhpcy5Ub29sOw0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdvYmplY3QnICYmIG9wdGlvbnMudG9vbC5jb25zdHJ1Y3Rvci5uYW1lPT0nVG9vbCcpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wubmFtZSgpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpPT09J3N0cmluZycpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wgfHwgdC50eXBlLm5hbWU9PW9wdGlvbnMudG9vbCk7DQoNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe190aGlzOiB0aGlzLCB0b29sOiB0aGlzLlRvb2wsIF9jbGFzczogJzwlPW5OYW1lKGMpJT4nfSwgb3B0aW9ucyB8fCB7fSkpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCkhPT0nb2JqZWN0JykgPCU9d2FybigpJT5vcHRpb25zLnRvb2wpOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMudG9vbCkgPCU9d2FybigpJT4idG9vbCBub3QgZGVmaW5lZCIsIG9wdGlvbnMuX3RoaXMuVG9vbCwgPCU9c2NvcGUlPi5Ub29scywgb3B0aW9ucy5fdGhpcy5Ub29scyk7DQogICAgICAgICAgICAvL29wdGlvbnMubm9DYWNoZSA9IHRydWU7DQogICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlKSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gPSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gfHwge307DQoNCiAgICAgICAgICAgIGxldCBuSUQgPSA8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCk6J2RlZmF1bHQnOw0KDQogICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9uc1tuXSkhPT0ndW5kZWZpbmVkJykgbnVsbFZhbHVlID0gbnVsbFZhbHVlIHx8IG9wdGlvbnNbbl07DQogICAgICAgICAgICBsZXQgcmV0ID0gbnVsbFZhbHVlOw0KICAgICAgICAgICAgaWYodHlwZW9mKHJldCk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyB1c2Ugc2NvcGUgY2FjaGUgKGltcHJvdmVzIHBlcmZvcm1hbmNlPz8/KQ0KICAgICAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUgJiYgT2JqZWN0Lmhhc093big8JT1zY29wZSU+LjwlPW1OYW1lJT4sIGAke29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWApKSByZXR1cm4gPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyB0b29sX0NvbmZpZ3MsIHR5cGVfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lDQogICAgICAgICAgICBsZXQgdGNvbmYgPSBbXS5jb25jYXQob3B0aW9ucy50b29sLnR5cGUudHlwZV9Db25maWdzIHx8IFtdLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjICYmIGMubmFtZT09biAmJiAoIWMubm9kZSB8fCBjLm5vZGUuY29kZT09bklEKSkuc29ydChjID0+IGMubm9kZT8oYy5ub2RlLmNvZGU9PSdkZWZhdWx0Jz8wOi0xKToxKTsNCiAgICAgICAgICAgIGlmKHRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgaWYodGNvbmZbMF0uc2NyaXB0KXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGNvbmZbMF0uc2NyaXB0Ow0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IF9zYyA9IHRoaXMuX3BhcmFtZXRyaXplKHRjb25mWzBdLnNjcmlwdCwgcCA9PiB0aGlzLjwlPW1OYW1lJT4ocCwgbnVsbCwgb3B0aW9ucykgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoIl9zYyIpJT47DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnZhbHVlOw0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBbMSwyLDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goamV4KXt9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYob3B0aW9ucy5uZXdWYWx1ZSl7DQogICAgICAgICAgICAgICAgbGV0IHRjID0gdGNvbmYubGVuZ3RoP3Rjb25mWzBdOnt9Ow0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubm9kZSkgdGMubm9kZSA9IHtjb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpfTsNCiAgICAgICAgICAgICAgICB0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICAgICAgdGMubmFtZSA9IG47DQogICAgICAgICAgICAgICAgaWYoIXRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncykucHVzaCh0Yyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldCA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcNCiAgICAgICAgICAgIGxldCBtY29uZiA9IG9wdGlvbnMuX3RoaXMuQ29uZmlnP29wdGlvbnMuX3RoaXMuQ29uZmlnW25dOnVuZGVmaW5lZDsNCiAgICAgICAgICAgIG1jb25mID0gdGhpcy5fcGFyYW1ldHJpemUobWNvbmYsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIG1jb25mID0gPCV2YWx1ZU9mKCJtY29uZiIpJT47DQogICAgICAgICAgICBpZih0eXBlb2YobWNvbmYpIT09InVuZGVmaW5lZCIpIHJldCA9IG1jb25mOw0KDQogICAgICAgICAgICAvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3Qpew0KICAgICAgICAgICAgICAgIHJldCA9IERvdE9iamVjdC5waWNrKG4sIGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpKSB8fCByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodGhpcy4kX1JFUVVFU1QpIHJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gY29uZmlnIHJlcGxhY2VtZW50DQogICAgICAgICAgICByZXQgPSB0aGlzLl9wYXJhbWV0cml6ZShyZXQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdID0gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoInJldCIpJT47DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPm4sIG51bGxWYWx1ZSwgb3B0aW9ucy5fY2xhc3MsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQoNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgLyoqDQogICAgICogU3VtbWFyeS4gPCU9bS5OYW1lJT4uDQogICAgICoNCiAgICAgKiBEZXNjcmlwdGlvbi4gPCU9bS5SZW1hcmslPi4NCiAgICAgKg0KICAgICAqIEBzaW5jZSAgICAgIHgueC54DQogICAgICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4NCiAgICAgKiBAYWNjZXNzICAgICBwdWJsaWMNCiAgICAgKg0KICAgICAqIEBjbGFzcw0KICAgICAqIEBhdWdtZW50cyBwYXJlbnQNCiAgICAgKiBAbWl4ZXMgICAgbWl4aW4NCiAgICAgKg0KICAgICAqIEBhbGlhcyAgICByZWFsTmFtZQ0KICAgICAqIEBtZW1iZXJvZiBuYW1lc3BhY2UNCiAgICAgKg0KICAgICAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbg0KICAgICAqIEBsaW5rIFVSTA0KICAgICAqIEBnbG9iYWwNCiAgICAgKg0KICAgICAqIEBmaXJlcyAgIGV2ZW50TmFtZQ0KICAgICAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLg0KICAgICAqDQogICAgICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqDQogICAgICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqLw0KICAgIDwlIGlmKCFtLklzU3luYyl7JT5hc3luYyA8JX0lPjwlPW1OYW1lPW5Db2RlKG0pJT4oPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IG5Db2RlKHApKS5qb2luKCcsICcpJT4pew0KDQogICAgCWxldCBsb2cgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCU9bkNvZGUobSklPiIsIG51bGwsIDAsIC4uLm1zZyk7DQogICAgCWxldCB3YXJuID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCU9bkNvZGUobSklPiIsIG51bGwsIDIsIC4uLm1zZyk7DQogICAgCWxldCBvU2NvcGUgPSA8JT1hbGlhcygpJT47DQogICAgCWxldCBwU2NvcGUgPSA8JT1zY29wZSU+Ow0KICAgICAgICANCiAgICANCjwlIGlmKCFtLklzU3luYyl7JT4NCiAgICA8JSBpZighbS5SZXNwb25zZUF0dHJpYnV0ZSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBudWxsOw0KICAgIDwlIH1lbHNlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLCB0cnVlKSU+KCk7DQogICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0Jvb2wpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gZmFsc2U7DQogICAgPCUgfWVsc2UgaWYobS5Jc0FycmF5KXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IFtdOw0KICAgIDwlIH1lbHNleyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbnVsbDsNCiAgICA8JSB9ICU+DQogICAgDQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1uQ29kZShtKSU+IiwgPCVtUm91dGluZyhjLCBtKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIA0KPCUgfSU+DQo8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5EZWZhdWx0KS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgIGlmKHR5cGVvZig8JT1uTmFtZShwKSU+KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIDwlPW5OYW1lKHApJT4gPSA8JXZhbHVlT2YocC5EZWZhdWx0KSU+Ow0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgdmFyIGVycm9ycyA9IHsNCiAgICAgICAgPCUgIFtdLmNvbmNhdChtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5SZXF1aXJlZCkubWFwKHAgPT4gKHsNCiAgICAgICAgICAgICAgICBDb2RlOiBgJHtuTmFtZShwKX0tcmVxdWlyZWRgLA0KICAgICAgICAgICAgICAgIEVycm9yOiBgJHtuTmFtZShwKX0gaXMgYSByZXF1aXJlZCBQYXJhbWV0ZXJgLA0KICAgICAgICAgICAgICAgIFNjcmlwdDogYHR5cGVvZigke25OYW1lKHApfSk9PT0ndW5kZWZpbmVkJ2AsDQogICAgICAgICAgICB9KSkpLmNvbmNhdChtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlKS5tYXAocCA9PiAoew0KICAgICAgICAgICAgICAgIENvZGU6IGAke25OYW1lKHApfWAsDQogICAgICAgICAgICAgICAgRXJyb3I6IGAke25OYW1lKHApfSBpcyBub3Qgb2YgdHlwZSAke25OYW1lKHAuRW50aXR5VHlwZSl9YCwNCiAgICAgICAgICAgICAgICBTY3JpcHQ6IGAoISR7bk5hbWUocCl9ICYmICR7cC5SZXF1aXJlZD8ndHJ1ZSc6J2ZhbHNlJ30pIHx8ICgke25OYW1lKHApfSAmJiAoJHtuTmFtZShwKX0uY29uc3RydWN0b3IubmFtZSE9JyR7bk5hbWUocC5FbnRpdHlUeXBlKX0nIHx8ICR7bk5hbWUocCl9LkVudGl0eUNsYXNzLk5hbWUhPScke25OYW1lKHAuRW50aXR5VHlwZSl9JykpYCwNCiAgICAgICAgICAgIH0pKSkuY29uY2F0KG0uVmFsaWRhdG9ycyB8fCBbXSkuZmlsdGVyKHYgPT4gIXYuSWdub3JlKS5mb3JFYWNoKHYgPT4geyAlPg0KICAgICAgICAgICAgIjwlPXYuQ29kZSU+IjogKCg8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lKS5qb2luKCcsICcpJT4pID0+IHsNCiAgICAgICAgICAgICAgICB0cnl7DQoNCiAgICAgICAgICAgICAgICA8JSBpZih2LlNjcmlwdC5pbmRleE9mKCdyZXR1cm4gJyk8MCl7JT4NCiAgICAgICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IA0KICAgICAgICAgICAgICAgIDwlfSU+DQogICAgICAgICAgICAgICAgICAgIDwlPXYuU2NyaXB0JT4NCiAgICAgICAgICAgICAgICAgICAgLy88JT1sb2coKSU+ImFuc3dlciIsICI8JT12LkNvZGUlPiIsIGFuc3dlcik7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhbnN3ZXI7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4idmFsaWRhdG9yIiwgIjwlPXYuQ29kZSU+IiwgZXgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBwLk5hbWUpLmpvaW4oJywgJyklPik/KCc8JT12LkVycm9yJT4nIHx8ICdWYWxpZGF0aW9uIEVycm9yJyk6JycsDQogICAgICAgIDwlIH0pICU+DQogICAgICAgIH07DQogICAgICAgIE9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOw0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCl7DQogICAgICAgICAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT57W2tdOiBlcnJvcnNba119KTsNCiAgICAgICAgICAgICAgICBkZWxldGUgZXJyb3JzW2tdOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBpZihPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogZXJyb3JzLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICA8JT1tLlNjcmlwdCU+DQogICAgICAgIA0KPCUgaWYoIW0uSXNTeW5jKXslPg0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKG0uTWV0aG9kUnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKG0uTWV0aG9kUnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IG5Db2RlKHApICsgIjogIiArIG5Db2RlKHApKS5qb2luKCcsICcpJT59KTsNCiAgICAgICAgDQogICAgICAgIA0KICAgICAgICAvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMNCiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7DQoNCiAgICAgICAgLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPw0KICAgICAgICBsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsNCiAgICAgICAgaWYoX19leCkgcmV0dXJuIF9fZXgucmV0Ow0KDQogICAgICAgIDwlPW0uUmVkdWNlJT4NCg0KICAgICAgICA8JSBpZihtLklzQXJyYXkgfHwgbS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5KXslPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAociA9PiByLnJldCkuZmxhdCgpOw0KICAgICAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aD9yZXN1bHRzWzBdLnJldDpudWxsOw0KICAgICAgICA8JSB9JT4NCjwlIH0lPg0KICAgIH0NCjwlIH0pOyU+DQoNCjwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX3Jlc3BvbnNlSW50ZXJjZXB0b3InJT4oZXJyb3IsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGVycm9yLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSBlcnJvci5jb25maWc7DQogICAgICAgICAgICBpZiAodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSAmJiBlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSk+MCkgew0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOw0KICAgICAgICAgICAgICAgIC8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190eXBlIiwgIkJlYXJlciIsIHt0b29sOiB0fSkgKyAiICIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgICAgIHJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIDwlPWxvZygpJT5jb25maWcpOw0KICAgICAgICByZXR1cm4gY29uZmlnOw0KICAgIDwlIH0lPg0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfcmVxdWVzdEludGVyY2VwdG9yJyU+KGNvbmZpZywgdCl7DQogICAgPCUgaWYobWFpbkNsYXNzKF9yZXN0VG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcyhfcmVzdFRvb2xzKSklPigpLjwlPW1OYW1lJT4oY29uZmlnLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge2hlYWRlcnM6IHt9fTsNCiAgICAgICAgICAgIGNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307DQogICAgICAgICAgICBjb25maWcubWV0YS5jb3VudGVyID0gNDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRva2VuVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW4udXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVHlwZSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IHRva2VuID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuLiIrY29uZmlnLm1ldGhvZCwgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlfSksIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgaWYoIWNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gJiYgW3Rva2VuVXJpLCByZWZyZXNoVXJpLCBhdXRoVXJpXS5pbmRleE9mKGNvbmZpZy51cmwpPDApew0KICAgICAgICAgICAgICAgIGlmKCF0b2tlbil7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoQ29kZSA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5jb2RlJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGF1dGhNZXRob2QgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUubWV0aG9kJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKCF0b2tlblVyaSAmJiAhYXV0aENvZGUgJiYgIWF1dGhNZXRob2QgJiYgdGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVHlwZSA9ICdCYXNpYyc7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSArICI6IiArIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJykpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KPCVpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSJnZXQiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBvciBsb2FkIGEgbmV3IG9hdXRoIHN0YXRlDQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUuc3RhdGUiLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHt0b29sOiB0Lm5hbWUsIG5jb2RlOiA8JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCl9KSl9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF1dGhvcml6ZSBhbmQgZ2V0IHRoZSBhdXRoIGNvZGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHthdXRoVXJpfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4oYXV0aFVyaSk7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNldEludGVydmFsKG51bGwsIHRvb2wgPT4gPCU9bnNjb3BlJT4uX25vZGUgJiYgY29uZmlnLm1ldGEuY291bnRlci0tICYmICEoYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSkpLCAwLjEsIHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBEb25lIExvb3Bpbmc6ICR7YXV0aENvZGV9YCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZighYXV0aENvZGUpIGF1dGhNZXRob2Q9dW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICB9DQo8JX0lPg0KDQogICAgICAgICAgICAgICAgICAgIGlmKGF1dGhNZXRob2Qpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZsb3cgPSAoIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSdwb3N0Jyk/J2F1dGhvcml6ZSc6J3Rva2VuJzsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgdG9rZW4NCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB0b2tlblVyaSBtaWdodCBoYXZlIGEgZGVwZW5kZW5jeSBvbiB0aGUgYXV0aG9yaXphdGlvbiBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30udXJpYCwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0Y29uZmlnID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdG9rZW5VcmksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0Jywge3Rvb2w6IHR9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uY29udGVudF90eXBlYCwgInRleHQvanNvbiIsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBdXRob3JpemF0aW9uIjogIkJhc2ljICIrdGhpcy5fYnRvYSh0aGlzLl9fY29uZmlnKCJvYXV0aC5sb2dpbiIsIG51bGwsIHt0b29sOiB0fSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uYm9keWAsIG51bGwsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBUb2tlbiBmZXRjaGVkIC0gJHtmbG93fWAsIHRjb25maWcsIHRyZXMuZGF0YSk7DQogICAgICAgICAgICAgICAgICAgICAgICBbJ2FjY2Vzc190b2tlbicsICd0b2tlbl90eXBlJywgJ2V4cGlyZXNfaW4nLCAncmVmcmVzaF90b2tlbiddLmZvckVhY2godGEgPT4gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHt0YX1gLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwge3Rvb2w6IHR9KV19KSk7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBhdXRoVHlwZSArICIgIiArIHRva2VuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXN0JyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyl7DQogICAgICAgIC8qIHROYW1lIG5vIGxvbmdlciByZXF1aXJlZCEhICovDQogICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge190aGlzOiB0aGlzfTsNCiAgICAgICAgb3B0aW9ucy50TmFtZSA9IG9wdGlvbnMudE5hbWUgfHwgdE5hbWU7DQogICAgICAgIA0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307DQogICAgICAgIG1ldGhvZCA9IG1ldGhvZCB8fCAoZGF0YT8icG9zdCI6ImdldCIpOw0KICAgICAgICANCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KC8qbnVsbCwgdGhpcy5Ub29sKi8pLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmZvcm0pew0KICAgICAgICAgICAgICAgIGxldCBmZCA9IG5ldyBGb3JtRGF0YSgpOw0KICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goayA9PiBmZC5hcHBlbmQoaywgZGF0YVtrXSkpOw0KICAgICAgICAgICAgICAgIGRhdGEgPSBmZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgYHJlc3RhcGkudXJsLiR7bWV0aG9kfWAsIHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgJ3Jlc3RhcGkudXJsJywgKG9wdGlvbnMucGF0aHx8JycpICsgb3B0aW9ucy5maWxlLCBvcHRpb25zKSwgb3B0aW9ucyksDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsDQogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMuJyttZXRob2QsIHRoaXMuX19jb25maWcoJ3Jlc3RhcGkuaGVhZGVycycsIHt9LCBvcHRpb25zKSwgb3B0aW9ucyksIG9wdGlvbnMuaGVhZGVycyB8fCB7fSksDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICB2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1czw0MDAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICA8JT1sb2coKSU+YFtMSVZFOiR7dGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpfV1gLCBjb25maWcsIG9wdGlvbnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzLlRvb2wuYXhpb3MpIT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKGF4aW9zKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gKGF3YWl0ICgodGhpcy5Ub29sLmF4aW9zIHx8IGF4aW9zKSkoY29uZmlnKSkuZGF0YTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgKGF3YWl0IGZldGNoKGNvbmZpZy51cmwsIGNvbmZpZykpLmpzb24oKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iYXhpb3Mgbm90IGRlZmluZWQhLCB1c2luZyBmZXRjaCIsIHJldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9IC8vIG1haW5DbGFzcyhfcmVzdFRvb2xzKSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU1FMVGFibGUnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCBkZXBzOiB7fSwgc3FsOiBgYCwgZmllbGRzOiBgYH0sIHsNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgX19oZWFkZXI6IG9iaiA9PiBvYmouc3FsID0gYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKCR7b2JqLmZpZWxkc30vKjwlPW5OYW1lKGMpJT4qLyk7XG5gLA0KICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e3NxbDogdi5vYmouc3FsICs9IGAvKjwlPW5OYW1lKGMpJT46IHJldXNlZDogJHt2LnJldXNlZH0qL1xuXG5gLCBJZDogdi5vYmouSWR9LA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLmZpZWxkcyArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAsJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIjwlPV9GckVNRC5fYXR0cihlYSklPiIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQuZGVwcyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldC5kZXBzW2tdKT09PSdzdHJpbmcnKS5tYXAoayA9PiByZXQuZGVwc1trXSkuam9pbignXG5cbicpICsgcmV0LnNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tU1FMVGFibGUnJT4odGFibGUsIGZpZWxkcyl7DQogICAgICAgIC8vIHRhYmxlIGlzIGEganNvbiBhcnJheQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9bk5hbWUoZWEpJT4iKSkgfHwgIWZpZWxkcyl7DQogICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHRhYmxlWyI8JT1uQ29kZShlYSklPiJdKTsNCiAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3NxbCclPihzcWwsIF90aGlzKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgIDwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9zcWxUb29scykpJT4oKS48JT1tTmFtZSU+KHNxbCwgX3RoaXMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+c3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoc3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIHNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGlmKChzcWwubWF0Y2goL1woL2cpIHx8IFtdKS5sZW5ndGghPShzcWwubWF0Y2goL1wpL2cpIHx8IFtdKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJpbmNvcnJlY3Qgc3FsIiwgc3FsKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgICAgIGxldCBfb2sgPSAoX3JldCwgX3NxbCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoX3JldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRiID0gdGhpcy5Ub29sLmRiOw0KICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOw0KICAgIA0KICAgICAgICAgICAgICAgIGxldCBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgICAgIHFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKT49MDsNCg0KICAgICAgICAgICAgICAgIGlmKGJRdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIC8vIHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ2FsbCc7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIERNTA0KICAgICAgICAgICAgICAgICAgICBpZihbJ215c3FsJywgJ3Bvc3RncmVzJ10uaW5kZXhPZih0eXBlKT49MCkgZnVuID0gJ3F1ZXJ5JzsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZT09J3NxbGl0ZScpIGZ1biA9ICdydW4nOw0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfb2soMCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICBpZihmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7dHlwZX0uJHtmdW59YCwgc3FsKTsNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChmdW4pIHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0icG9zdGdyZXMiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsKS50aGVuKHJvd3MgPT4gX29rKHJvd3MsIHNxbCkpLmNhdGNoKHJldEV4ID0+IHJlamVjdChyZXRFeCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3Nub3dmbGFrZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRiLmV4ZWN1dGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgc3FsVGV4dDogc3FsLA0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3NxbGl0ZScpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIHRoZSBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGIuZXhlYyhzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgICAgICAgICBfb2socmV0LCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlPT0ncXVlc3RkYicpew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0KG51bGwsIHtxdWVyeTogc3FsfSkudGhlbihyID0+IF9vayhyLCBzcWwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmANCkVSUk9SOg0KJHtleH0NCg0KV2hpbGUgU2VuZGluZyBRdWVyeSANCiR7c3FsfQ0KYCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgcmV0LnJvd3MpIHJldCA9IHJldC5yb3dzOyAgICAgICAgDQogICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSl7JT4NCjwlDQpsZXQgX3RvVHlwZUFUID0gZWEgPT4gew0KICAgIGxldCByZXQgPSB7bmFtZTogbk5hbWUoZWEpLCBkZXNjcmlwdGlvbjogZWEuTmFtZSwgdHlwZTogInNpbmdsZUxpbmVUZXh0In07DQogICAgaWYoZWEuSXNCb29sKXsNCiAgICAgICAgcmV0LnR5cGUgPSAiY2hlY2tib3giOw0KICAgICAgICByZXQub3B0aW9ucyA9IHsNCiAgICAgICAgICAgIGNvbG9yOiAiZ3JlZW5CcmlnaHQiLA0KICAgICAgICAgICAgaWNvbjogImNoZWNrIg0KICAgICAgICB9Ow0KICAgIH0NCiAgICBpZihlYS5Jc0RhdGUpew0KICAgICAgICByZXQudHlwZSA9ICJkYXRlVGltZSI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgZGF0ZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICdpc28nDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICcyNGhvdXInLA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRpbWVab25lOiAndXRjJywNCiAgICAgICAgfTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJldDsNCn07DQolPg0KICAgIDwlPW1OYW1lPSdfdG9BVFRhYmxlJyU+KGxldmVsKXsNCiAgICAgICAgbGV0IHJldCA9IFt7DQogICAgICAgICAgICBuYW1lOiAnPCU9bk5hbWUoYyklPicsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICBmaWVsZHM6IFsNCiAgICAgICAgICAgICAgICB7bmFtZTogdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCBkZXNjcmlwdGlvbjogJ0lEJywgdHlwZTogJ3NpbmdsZUxpbmVUZXh0J30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPjwlPV9GckVNRC5fdG9KUyhfdG9UeXBlQVQoZWEpKSU+LDwlIH0pJT5dLA0KICAgICAgICB9XTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQucHVzaChuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5zcWwpOw0KICAgICAgICByZXR1cm4gcmV0LnNxbDsNCg0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKCh0YWcsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KHQgPT4gdC5uYW1lID09IHRhZy5uYW1lKSA9PSBpbmRleCk7DQogICAgICAgIDwlPWxvZygpJT5yZXQsIGxldmVsKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0FURnVuY3Rpb24nJT4oKXsNCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0uYDsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2Z1bjogIiJ9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSIsDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgKCR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIgYW5kIC8qPCU9dGFOYW1lJT4qLyAiOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJOT1QgRVhJU1RTIjsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke3RoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgIklOIn1gOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIgKCIgKyAodiB8fCBbXSkubWFwKHQgPT4gKHQgJiYgdC48JT1tTmFtZSU+KT90LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIik6KHQgfHwgJ05VTEwnKSkuam9pbignIFVOSU9OIEFMTC8qTTJNKi8gJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2FpcnRhYmxlJyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQWlyVGFibGUnXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydBaXJUYWJsZSddKSklPigpLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0TmFtZSA9IHROYW1lIHx8IDwlPV9uQ29kZSgpJT47DQogICAgICAgICAgICBsZXQgcmV0ID0gKGF3YWl0IGF4aW9zLnJlcXVlc3Qoew0KICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5fX2NvbmZpZygnZW5kcG9pbnRVcmwnKX0ke3ROYW1lfWAsDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2Q/bWV0aG9kOihkYXRhPyJwb3N0IjoiZ2V0IiksDQogICAgICAgICAgICAgICAgcGFyYW1zOiB7DQogICAgICAgICAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogcGFyYW1zLA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXgucmVzcG9uc2UuZGF0YSwgbnVsbCwgNCkpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19maWxlc3lzdGVtJyU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmo9dGhpcyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWxlLCBjb250ZW50LCBpZCwgb2JqKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighZmlsZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIGxldCBwYXRoID0gb2JqLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJz8nLi9kYi8nOidodHRwczovL3t7b3duZXJ9fS5naXRodWIuaW8vJykpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAvLyB3cml0ZQ0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKChwYXRoICsgZmlsZSkucmVwbGFjZSgvKC4qXC8pLiovZywgJyQxJyksIHsgcmVjdXJzaXZlOiB0cnVlIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmMocGF0aCArIGZpbGUsIHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnPy8qdGhpcy5fYnRvYSgqL0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpLyopKi86Y29udGVudCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihmYWxzZSAmJiBmaWxlLmVuZHNXaXRoKCcvJykpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJzaW11bGF0ZWQgZGlyZWN0b3J5IGxpc3RpbmcuLi4uIiwgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IFsiRU1TIFdlYiJdOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyByZWFkDQogICAgICAgICAgICAgICAgICAgIGlmKHBhdGguc3RhcnRzV2l0aCgnaHR0cCcpICYmIHBhdGguaW5kZXhPZignOi8vJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgbnVsbCwgbnVsbCwge3VybDogJ3BhdGgucmVhZCcsIGZpbGUsIHBhdGh9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuZnMuZXhpc3RzU3luYyhwYXRoICsgZmlsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyhwYXRoICsgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD8ocmV0LmRhdGEgfHwgcmV0KTpyZXQ7DQogICAgICAgICAgICA8JT1sb2coKSU+YFske29iai5fX2NvbmZpZygnbGl2ZScsIHRydWUpPycnOidOT1QgJ31MSVZFfCR7dHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCc/J3dyaXRlJzoncmVhZCd9XSR7cGF0aCArIGZpbGV9OiAkeyhyZXQgfHwgJycpLmxlbmd0aH1gKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIDwlPW1OYW1lPSdnZXQgX1RvU3RyaW5nJyU+KCl7IDwlIC8qQmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIEJJU2VydmVyICovICU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KFtdLCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBVbmlxdWU6IHRydWUsDQoJPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wdXNoKHY/djwlaWYoZWEuRW50aXR5VHlwZSl7JT4uX1RvU3RyaW5nPCV9JT46bnVsbCksDQoJPCUgfSklPg0KCSAgICAgICAgfSwgIjwlPW1OYW1lJT4iKS5mbGF0KCkuam9pbignLScpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQo8JSBpZihtYWluQ2xhc3MoX2ZpbGVUb29scykpeyU+DQogICAgPCU9bU5hbWU9J190b0ZpbGVOYW1lJyU+KHNQYXRoPSIiLCBleHQ9Jy5qc29uJyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBmTmFtZSA9IHRoaXMuX19leHBvcnQoW10sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIFVuaXF1ZTogdHJ1ZSwNCgk8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnB1c2godj92PCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGAke3NQYXRofS4ke2VhQ29kZX1gLCBleHQpPCV9JT46J251bGwnKSwNCgk8JSB9KSU+DQoJICAgICAgICB9LCAiPCU9bU5hbWUlPiIpLmpvaW4oJ19fJyk7DQoJICAgICAgICANCgkgICAgICAgIGlmKCFzUGF0aCl7DQogICAgICAgICAgICAgICAgZk5hbWUgPSAodGhpcy5fX2NvbmZpZygnc3RvcmUucm9vdCcsICc8JT1zY29wZSU+LycpICsgYCR7IjwlPWFsaWFzKCklPiIuc3BsaXQoJy4nKS5zbGljZSgxKS5qb2luKCcvJyl9LyR7PCU9X25Db2RlKCklPn0vJHtmTmFtZSArIGV4dH1gKS5yZXBsYWNlKC9cL1wvL2csICcvJyk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmTmFtZSA9ICdbJyArIGZOYW1lICsgJ10nOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gZk5hbWU7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tRmlsZU5hbWUnJT4oZk5hbWUsIHNQYXRoPSIiLCBleHQ9Jy5qc29uJyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihmTmFtZSkhPT0nc3RyaW5nJykgPCU9d2FybigpJT4iZk5hbWUgbm90IGEgc3RyaW5nIiwgZk5hbWUsIHNQYXRoLCBleHQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihmTmFtZS5pbmRleE9mKCcvJyk+PTApIGZOYW1lID0gZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnJldmVyc2UoKS5yZWR1Y2UoKHYsIGUpID0+IHYgKyAnX19bJyArIGUpICsgZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnNsaWNlKDEpLnJlZHVjZSh2ID0+IHYgKyAnXScsICdfX251bGwnKSArICgoZk5hbWUuc3BsaXQoJy4nKS5sZW5ndGg+MSk/KCcuJytmTmFtZS5zcGxpdCgnLicpWzFdKTpleHQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydCh7bmFtZTogZk5hbWUucmVwbGFjZShleHQsICcnKX0sIHsNCiAgICAgICAgICAgICAgICBVbmlxdWU6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGxldCB2ID0gb2JqLm5hbWUuc3BsaXQoJ19fJylbMF07DQogICAgICAgICAgICAgICAgICAgIG9iai5uYW1lID0gb2JqLm5hbWUuc3BsaXQoJ19fJykuc2xpY2UoMSkuam9pbignX18nKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmVhQ29kZSwgdiwgb2JqLm5hbWUsIHNQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPih2LCAnPScpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5lYUNvZGUsIG9iai5uYW1lLnNsaWNlKDEsIC0xKSwgc1BhdGgpOw0KICAgICAgICAgICAgICAgICAgICBpZihvYmoubmFtZT09J251bGwnIHx8ICFvYmoubmFtZSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvYmoubmFtZS5zbGljZSgxLCAtMSksIGAke3NQYXRofS4ke2VhQ29kZX1gLCBleHQpKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+IiwgZk5hbWUsIHNQYXRoKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydHaXRIdWInXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19naXRodWInJT4oZmlsZSwgY29udGVudCwgaWQsIG9iaj10aGlzKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydHaXRIdWInXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydHaXRIdWInXSkpJT4obnVsbCwgdGhpcy5Ub29sKS48JT1tTmFtZSU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmopOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFmaWxlKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHNoYTEgPSBhc3luYyBzdHIgPT4gdHlwZW9mKGNyeXB0by5zdWJ0bGUpIT09J3VuZGVmaW5lZCc/QXJyYXkuZnJvbShuZXcgVWludDhBcnJheShhd2FpdCBjcnlwdG8uc3VidGxlLmRpZ2VzdCgnU0hBLTEnLCBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoJ2Jsb2IgJyArIG5ldyBCbG9iKFtzdHJdKS5zaXplICsgJ1x4MDAnICsgc3RyKSkpKS5tYXAodiA9PiB2LnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpKS5qb2luKCcnKTpzdHIuc3Vic3RyaW5nKDAsIDEwKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPiJmaWxlIiwgZmlsZSwgY29udGVudD8ncHV0JzonZ2V0Jyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgY29udGVudD9KU09OLnN0cmluZ2lmeSh7DQogICAgCQkJbWVzc2FnZTogImRlcGxveWVkIGJ5IDwlPW1OYW1lJT4oKSIsDQogICAgCQkJc2hhOiBpZCB8fCBjb250ZW50W3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sDQogICAgCQkJY29udGVudDogdGhpcy5fYnRvYSh0eXBlb2YoY29udGVudCk9PT0nb2JqZWN0Jz9KU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCAnXHQnKTpjb250ZW50KSwNCiAgICAJCX0pOm51bGwsIGNvbnRlbnQ/J3B1dCc6bnVsbCwgew0KICAgIAkJICAgIGZpbGU6IChmaWxlICsgKChjb250ZW50IHx8IGZpbGUuZW5kc1dpdGgoJy8nKSk/Jyc6KCc/cmFuZD0nK01hdGgucmFuZG9tKCkpKSksDQogICAgCQl9KTsNCiAgICAJCQ0KICAgIAkJaWYoIXJldCkgcmV0dXJuIHJldDsNCiAgICAJCQ0KICAgIAkJcmV0ID0gY29udGVudD9yZXQuY29udGVudDpyZXQ7DQoNCiAgICAgICAgICAgIGxldCBpZHhGaWxlID0gJ2luZGV4Lmh0bSc7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+InJldCIsIHJldCk7DQogICAgCQlpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgIAkJICAgIC8vIGluIGNhc2Ugd2UgYXJlIGxpc3RpbmcgdGhlIGNvbnRlbnRzIG9mIGEgZm9sZGVyIHJlc291cmNlDQogICAgCQkgICAgcmV0dXJuIHJldC5maWx0ZXIociA9PiAodHlwZW9mKHIudHlwZSk9PT0ndW5kZWZpbmVkJyB8fCByLnR5cGU9PSdmaWxlJykgJiYgci5uYW1lIT1pZHhGaWxlKS5tYXAociA9PiAoe1t0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldOiByLnNoYSB8fCByW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sIG5hbWU6IHIubmFtZS5yZXBsYWNlKCcuanNvbicsICcnKX0pKTsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJbGV0IF90aGlzID0ge307DQogICAgCQlpZihyZXQuc2hhKXsNCiAgICAJCSAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIF90aGlzID0gcmV0LmNvbnRlbnQ/SlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSk6e307DQogICAgICAgICAgICAgICAgfWNhdGNoKF9leCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+Im5vdCBhIHZhbGlkIEpTT04gb2JqZWN0IiwgZmlsZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIAkJICANCiAgICAJCSAgICBfdGhpc1tvYmouX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0gPSByZXQuc2hhOyAvLz8/DQogICAgCQl9ZWxzZSBpZihyZXRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSl7DQogICAgCQkgICAgLy88JT13YXJuKCklPidzaGExJywgZmlsZSwgYXdhaXQgc2hhMShKU09OLnN0cmluZ2lmeShyZXQpKSk7DQogICAgCQkgICAgX3RoaXMgPSByZXQ7DQogICAgCQl9DQogICAgCQkNCiAgICAJCTwlPWxvZygpJT5maWxlLCBjb250ZW50PydwdXQnOidnZXQnLCBfdGhpcyk7DQogICAgCQkNCiAgICAgICAgICAgIGxldCBmUm9vdCA9IGZpbGUuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSkuam9pbignLycpOw0KICAgICAgICAgICAgaWYoZmlsZS5pbmRleE9mKGlkeEZpbGUpPj0wKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgaWR4RmlsZSA9IGZSb290ICsgJy8nICsgaWR4RmlsZTsNCiAgICAJCQ0KICAgIAkJaWYoLyohb2JqLl9fc3luY19vbigpICYmICovY29udGVudCl7DQogICAgCQkgICAgLy8gbmV3IGNvbnRlbnQgc3RvcmVkDQogICAgCQkgICAgbGV0IGlkeFJldCA9IGF3YWl0IG9iai48JT1tTmFtZSU+KGlkeEZpbGUpOw0KICAgIAkJICAgIGxldCBpZHhMaXN0ID0gYXdhaXQgb2JqLjwlPW1OYW1lJT4oZlJvb3QpOw0KICAgIAkJICAgIGF3YWl0IG9iai48JT1tTmFtZSU+KGlkeEZpbGUsIGlkeExpc3QsIGlkeFJldD9pZHhSZXQuc2hhOm51bGwpOw0KICAgIAkJICAgIDwlPWxvZygpJT4iZmlsZSBjb250ZW50IiwgZmlsZSwgaWR4RmlsZSwgcmV0LCBpZHhMaXN0KTsNCiAgICAJCX0NCiAgICAJCQ0KICAgICAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NhbGVzRm9yY2UnXSkpeyU+DQogICAgPCU9bU5hbWU9J190b1NGUXVlcnknJT4oZmllbGRzLCBvYmpzLCBiU3RyaW5nKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe1s8JT1fbkNvZGUoKSU+XToge3BhcmFtczoge3doZXJlOiB7YW5kOiBbXSwgb3I6IFtdfX0sIGVkZ2VzOiB7bm9kZToge319fX0sIHsNCiAgICAgICAgICAgIC8vT1BFUkFUT1JTOiB0cnVlLA0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqWzwlPV9uQ29kZSgpJT5dLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7SWQ6IHtlcTogdn19KSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBvcCA9ICdlcSc7DQogICAgICAgICAgICAgICAgbGV0IGNvbmQgPSB7W2VhQ29kZV06IHtbb3BdOiANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5xOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXBpTmFtZTogJ0lkJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT5dOiB2P3YuPCU9bU5hbWUlPigpWzwlPV9uQ29kZShlYS5FbnRpdHlUeXBlKSU+XS5wYXJhbXMud2hlcmUuYW5kOltdLA0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgICh2P3YudG9JU09TdHJpbmcoKTpudWxsKQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICB2DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH19Ow0KICAgICAgICAgICAgICAgIG9ials8JT1fbkNvZGUoKSU+XS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICANCiAgICAgICAgLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsNCiAgICAgICAgDQogICAgICAgIGlmKGJTdHJpbmcpew0KICAgICAgICAgICAgcmV0ID0ge3F1ZXJ5OiB7WzwlPV9uQ29kZSgpJT4gKyAnUXVlcnknXToge3VpYXBpOiB7cXVlcnk6IHJldH19fX07DQogICAgICAgICAgICByZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NlcnZpY2VOb3cnXSkpeyU+DQogICAgPCUNCiAgICBsZXQgX2lkID0gcyA9PiAvKnM/czoqL2B0aGlzLl91dWlkKCR7c3x8dW5kZWZpbmVkfSkucmVwbGFjZSgvLS9nLCAnJylgOw0KICAgIGxldCBfdGlkID0gX2MgPT4gX2lkKCInIitzY29wZSsiLiIrIChfYyB8fCBjKS5OYW1lICsgIiciKTsNCiAgICBsZXQgYXBwID0gKCkgPT4geyU+YXBwbGljYXRpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBcHBsaWNhdGlvbicsIHRydWUpJT4oKS5jb2RlKHRoaXMuX19jb25maWcoJ3Njb3BlJywgJzwlPXNjb3BlJT4nKSkpPCV9Ow0KICAgIA0KICAgIGxldCBsYWJlbCA9ICh0LCBuLCBjLCBwKSA9PiB7bj1zci5FbmdsaXNoTmFtZShuKTsgJT4uPCU9dCU+X0ZpZWxkX0xhYmVscyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGaWVsZCBMYWJlbCcsIHRydWUpJT4oPCU9X2lkKCklPikucmVtYXJrKCc8JT1uJT4nKS5uYW1lKCc8JT1uJT4nKS5jb2RlKDwlPWMlPikubGFuZ3VhZ2UoJ2VuJykucGx1cmFsKCc8JT0ocCB8fCAobiArICdzJykpJT4nKS48JWFwcCgpJT5dKTwlfTslPg0KDQogICAgPCU9bU5hbWU9J190b1NOVGFibGUnJT4oKXsNCiAgICAgICAgLy90aGlzLl9kZWZhdWx0cygpOw0KDQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RhYmxlJywgdHJ1ZSklPig8JT1fdGlkKCklPikuY29kZSg8JT1fbkNvZGUoKSU+KS48JWFwcCgpJT4ubmFtZSgnPCU9Yy5OYW1lJT4nKS5yZW1hcmsoYDwlPWMuUmVtYXJrJT5gKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKSwgew0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoudGFibGVfQ29sdW1ucyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbHVtbicsIHRydWUpJT4oPCU9X2lkKCInIitzY29wZSsiLiIrYy5OYW1lKyInK2VhQ29kZSIpJT4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4iKS5jb2RlKGVhQ29kZSkudHlwZSgnPCU9X0ZyRU1ELl9hdHRyKGVhKSU+JykucmVmZXJlbmNlKDwlaWYoZWEuRW50aXR5VHlwZSl7JT4odiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KCk8JX1lbHNleyU+bnVsbDwlfSU+KS8qPCVsYWJlbCgnY29sdW1uJywgZWEuTmFtZSwgJ2VhQ29kZScsIGVhLlBsdXJhbCklPiovKSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucmVmZXJlbmNlX0NvbHVtbnMobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdDb2x1bW4nLCB0cnVlKSU+KCkuYWN0aXZlKGZhbHNlKS5lbmFibGVkKHRydWUpLmNvZGUoZWFDb2RlKS50eXBlKCdMaXN0JykubmFtZSgiPCU9bk5hbWUodGEpJT4gPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsJT4iKS5yZWZlcmVuY2UobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKS8qPCVsYWJlbCgnY29sdW1uJywgdGEuTmFtZSsnICcrdGEuRW50aXR5Q2xhc3MuUGx1cmFsLCAnZWFDb2RlJywgdGEuRW50aXR5Q2xhc3MuUGx1cmFsKSU+Ki8pLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU05GbG93JyU+KGJEcmFmdCwgYkhlYWRlcil7DQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgIDwlIGxldCBiT3JkZXIgPSAxOyBsZXQgX2ZpZCA9IF9jID0+IF9pZCgiJyIrc2NvcGUrIi4nICsgKGJEcmFmdD8nZCc6J3MnKSArICdsIisgKF9jIHx8IGMpLk5hbWUgKyAiJyIpOw0KICAgICAgICBsZXQgbG9naWMgPSAobiwgdCwgbWFwPVtdKSA9PiB7JT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBMb2dpYycsIHRydWUpJT4oPCU9X2lkKCklPikub3JkZXIoPCU9Yk9yZGVyKyslPikuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUoJzwlPW4lPicpLnJlbWFyaygnPCU9biU+JykNCiAgICAgICAgICAgICAgICAuYmxvY2sobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IEJsb2NrJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKDwlPV9pZCgpJT4pLm5hbWUoJzwlPW4lPicpDQogICAgICAgICAgICAgICAgICAgIC5ibG9ja19FbGVtZW50X01hcHBpbmdzKFs8JSBtYXAuZmlsdGVyKG0gPT4gbSkuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoIjwlPW4lPiAtICIgKyA8JT1tLmNkJT4pLmNvZGUoPCU9bS5jZCU+KS52YWx1ZSg8JT1tLnYlPik8JXBDb21wb3VuZChtLnYsIG0udHJuKSU+LA0KICAgICAgICAgICAgICAgICAgICA8JX0pJT5dKQ0KICAgICAgICAgICAgICAgICkuZGVmaW5pdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0xvZ2ljIERlZmluaXRpb24nLCB0cnVlKSU+KCc8JT10JT4gPCU9biU+JykuY29kZSgnPCU9dCU+JykubmFtZSgnPCU9dCU+JykpLjwlYXBwKCklPg0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IGFjdGlvbiA9IChhQ29kZSwgcGFyYW1zPXt9KSA9PiB7ICU+DQogICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FjdGlvbiBJbnN0YW5jZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSh0aGlzLl91dWlkKCkpLmFjdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FjdGlvbiBUeXBlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT1hQ29kZSU+JykpLm9yZGVyKDwlPWJPcmRlcisrJT4pLjwlYXBwKCklPg0KICAgICAgICAgICAgLmFjdGlvbl9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgPCUgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikuYWN0aW9uSW5wdXQoDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIElucHV0JywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpDQogICAgICAgICAgICAgICAgKS5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKCIiKSksDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKQ0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IHN1YmZsb3cgPSAoZmxvdywgcGFyYW1zPXt9LCBiTm9XYWl0KSA9PiB7ICU+DQogICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5zdGFuY2UnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUodGhpcy5fdXVpZCgpKS5zdWJmbG93KDwlPWZsb3clPikub3JkZXIoPCU9Yk9yZGVyKyslPikuPCVhcHAoKSU+DQogICAgICAgICAgICA8JSBpZighYk5vV2FpdCl7JT4NCiAgICAgICAgICAgIC5pbnN0YW5jZV9GbG93X0luc3RhbmNlX0lucHV0cyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IEluc3RhbmNlIElucHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykubmFtZSgnV2FpdCBmb3IgQ29tcGxldGlvbicpLnR5cGUoJ0Jvb2wnKV0pDQogICAgICAgICAgICAuaW5zdGFuY2VfVmFyaWFibGVfVmFsdWVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykudmFsdWUoJzEnKQ0KICAgICAgICAgICAgICAgICAgICAubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykpDQogICAgICAgICAgICBdKQ0KICAgICAgICAgICAgPCV9JT4NCiAgICAgICAgICAgIC5pbnN0YW5jZV9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgPCUgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikuZmxvd0lucHV0KA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykNCiAgICAgICAgICAgICAgICApLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoPCU9cGFyYW1zW3BdJT4pKQ0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgXSkNCiAgICAgICAgPCV9DQogICAgICAgIGxldCBwQ29tcG91bmQgPSAodiwgdHJuKSA9PiB7aWYoIXRybikgcmV0dXJuOyAlPi5lbGVtZW50TWFwcGluZ19QaWxsX0NvbXBvdW5kcyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdQaWxsIENvbXBvdW5kJywgdHJ1ZSklPih0aGlzLl91dWlkKCkpLmNvZGUoJycpLm5hbWUoPCU9diU+KS5vcmRlcigwKS8qLnJlbWFyayh0aGlzLl9idG9hKGA8JT1KU09OLnN0cmluZ2lmeShbXSklPmApKSovLjwlYXBwKCklPg0KICAgICAgICAgICAgLnBhcmVudF9QaWxsX0NvbXBvdW5kcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyh0cm4pLmZvckVhY2goKHQsIGkpID0+IHslPiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1BpbGwgQ29tcG91bmQnLCB0cnVlKSU+KHRoaXMuX3V1aWQoKSkuY29kZSgiPCU9dCU+Iikub3JkZXIoPCU9aSsxJT4pLm5hbWUoPCU9diU+KS5yZW1hcmsodGhpcy5fYnRvYShgPCU9SlNPTi5zdHJpbmdpZnkodHJuW3RdKSU+YCkpLjwlYXBwKCklPi8qLnRyYW5zZm9ybShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RyYW5zZm9ybScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnPCU9dCU+JykudHJhbnNmb3JtX1RyYW5zZm9ybV9Db21wb3NpdGlvbnMoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVHJhbnNmb3JtIENvbXBvc2l0aW9uJywgdHJ1ZSklPigpLmNvZGUoJycpXSkpKi8sDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKV0pDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgDQogICAgICAgICAgICANCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgKiBPT0IgRW5kcG9pbnQ6IGh0dHBzOi8vZGV2MTYyNTcwLnNlcnZpY2Utbm93LmNvbS9hcGkvbm93L3Byb2Nlc3NmbG93L2Zsb3dvYmplY3Qvc3RhcnQvc3ViZmxvdw0KICAgICAgICAgICAgICogUGF5bG9hZDogeyJuYW1lIjoieF83ODYxMV9zY2hvb2xfbWFuLlVzZXJfbG9va3VwIiwiaW5wdXRzIjp7Impzb24iOnsibmFtZSI6InRlc3QiLCJnZW5kZXIiOnsiY29kZSI6Ik0iLCAiT1BFUkFUT1JTIjogeyJjb2RlIjogIiE9In19LCJ1c2VyX1N0dWRlbnRzIjpbeyJuYW1lIjoiU1RBIiwiZ2VuZGVyIjp7ImNvZGUiOiJNIn19XX19fQ0KICAgICAgICAgICAgKi8NCg0KICAgICAgICAgICAgbGV0IGZsb3cgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cnLCB0cnVlKSU+KDwlPV9maWQoKSU+KS5uYW1lKCc8JT1jLk5hbWUlPiBMb29rdXAnKS5jb2RlKDwlPV9uQ29kZSgpJT4gKyAnX2xvb2t1cCcpLjwlYXBwKCklPi5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKTsNCiAgICAgICAgICAgIGlmKGJIZWFkZXIpIHJldHVybiBmbG93Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChmbG93LyouX2RlZmF1bHRzKCkqLw0KICAgICAgICAgICAgICAgIC5mbG93X0Zsb3dfU2V0dGluZ3MoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBTZXR0aW5nJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCdBQ1RJT04nKV0pDQogICAgICAgICAgICAgICAgLmZsb3dfRmxvd19JbnB1dHMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKCdqc29uJykubmFtZSgnSlNPTicpLnR5cGUoJ0pTT04nKTwlbGFiZWwoJ2lucHV0JywgJ0pTT04nLCAiJ2pzb24nIiklPg0KICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19PdXRwdXRzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IE91dHB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoPCU9X25Db2RlKCklPiArICdfbGlzdCcpLm5hbWUoJzwlPW5OYW1lKGMpJT4gTGlzdCcpLnR5cGUoJ0xpc3QnKS5yZWZlcmVuY2UobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUYWJsZScsIHRydWUpJT4oIjwlPW5OYW1lKGMpJT4iKS5uYW1lKCc8JT1jLk5hbWUlPicpLmNvZGUoPCU9X25Db2RlKCklPikuPCVhcHAoKSU+KQ0KICAgICAgICAgICAgICAgICAgICA8JWxhYmVsKCdvdXRwdXQnLCBjLk5hbWUgKyAnIExpc3QnLCBfbkNvZGUoKSArICIrICdfbGlzdCciKSU+DQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X1ZhcmlhYmxlcyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2pzb24nKS5uYW1lKCdKU09OJykudHlwZSgnSlNPTicpPCVsYWJlbCgndmFyaWFibGUnLCAnSlNPTicsICcianNvbiInKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKCdlcXVlcnknKS5uYW1lKCdFUXVlcnknKS50eXBlKCdTdHJpbmcnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgJ0VRdWVyeScsICciZXF1ZXJ5IicpJT4sDQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ1NldCAnICsgYy5OYW1lICsgJyBKU09OJywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInanNvbiciLCB2OiAiJ3t7c3ViZmxvdy5qc29ufX0nIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICA8JSAvLyAsIHRybjoge3JlcGxhY2Vfc3RyaW5nOiB7cmVnZXg6ICIvL2ciLCByZXBsYWNlX3N0cmluZzogIiJ9fSU+DQogICAgICAgICAgICAgICAgXSkuc2VjdXJpdHlDb250cm9sKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU2VjdXJpdHkgQ29udHJvbCcsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnc3lzX2h1Yl9mbG93JykubmFtZShgc3lzX3Njb3BlLnNjb3BlPSR7dGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpfWApLnR5cGUobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBUeXBlJywgdHJ1ZSklPigpLmNvZGUoJ2NsaWVudF9jYWxsYWJsZV9mbG93X29iamVjdCcpKS5vcGVyYXRpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBPcGVyYXRpb24nLCB0cnVlKSU+KCkuY29kZSgnZXhlY3V0ZScpKS48JWFwcCgpJT4pLCB7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy9leHBvcnRlcjogdiA9PiB2Lm9iaiA9IHYucmV1c2VkP25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdycsIHRydWUpJT4odi5vYmouSWQpOnYub2JqLCAvKmluZm9ybWF0aW9uIGxvc3MqLw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIE51bGw6ICFiSGVhZGVyLA0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgDQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqPCVpZigwIHx8IChbJ25hbWUnLCAncmVtYXJrJywgJ2RhdGUnLCAnb3JkZXInLCAnYWN0aXZlJywgJ2VuYWJsZWQnXS5pbmRleE9mKGVhLk5hbWUpPDApKXslPi5mbG93X0Zsb3dfVmFyaWFibGVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKGVhQ29kZSkubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPicpLnR5cGUoPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4nSlNPTic8JSB9ZWxzZXslPic8JT1fRnJFTUQuX2F0dHIoZWEpJT4nPCV9JT4pPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lLCAiZWFDb2RlIiklPiwNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCc8JT1uTmFtZShjKSU+LjwlPWVhLk5hbWUlPi5TZXQnKS5jb2RlKGVhQ29kZSArICdfc2V0JykubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiBTZXQnKS50eXBlKCdCb29sJyk8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUgKyAnIFNldCcsICJlYUNvZGUgKyAnX3NldCciKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoZWFDb2RlICsgJ19vcCcpLm5hbWUoJzwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4gT3BlcmF0b3InKS50eXBlKCdTdHJpbmcnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSArICcgT3BlcmF0b3InLCAiZWFDb2RlICsgJ19vcCciKSU+LA0KICAgICAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnU2V0ICcrZWEuTmFtZSwgJ1NldCBGbG93IFZhcmlhYmxlcycsIFsNCiAgICAgICAgICAgICAgICAgICAgICAgIGVhLkVudGl0eVR5cGU/bnVsbDp7Y2Q6ICJlYUNvZGUiLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5qc29ufX0nIiwgdHJuOiBPYmplY3QuYXNzaWduKHt9LCB7dmFsdWVfbWFwOiB7a2V5OiAiJHtlYUNvZGV9IiwgZGVmYXVsdDogIiJ9fSwgZWEuX0lzRGF0ZT97c3RyaW5nX3RvX2RhdGU6IHtkYXRlX2Zvcm1hdDogInl5eXktTU0tZGRcJ1RcJ0hIOm1tOnNzXCdaXCciLCBjdXN0b21fZm9ybWF0OiAiIn19Ont9KX0sDQogICAgICAgICAgICAgICAgICAgICAgICAvL3tjZDogImVhQ29kZSsnX3NldCciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX19JyIsIHRybjoge2lzX251bGw6IHt9fX0sDQogICAgICAgICAgICAgICAgICAgICAgICAvL3tjZDogImVhQ29kZSsnX29wJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLm9wZXJhdG9yc319JyIsIHRybjoge3ZhbHVlX21hcDoge2tleTogIiR7ZWFDb2RlfSJ9fX0sDQogICAgICAgICAgICAgICAgICAgIF0pJT4ubG9naWNfRmxvd19JbnB1dF9TY3JpcHRzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT5uZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCdTZXQgPCU9ZWEuTmFtZSU+JykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlKS5yZW1hcmsoYHJldHVybiBmZF9kYXRhLmZsb3dfdmFyLmpzb24uJHtlYUNvZGV9O2ApLDwlfSU+DQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCdTZXQgPCU9ZWEuTmFtZSU+IFNldCcpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSArICdfc2V0JykucmVtYXJrKGByZXR1cm4gdHlwZW9mKGZkX2RhdGEuZmxvd192YXIuanNvbi4ke2VhQ29kZX0pIVx1MDAzZFx1MDAzZFx1MDAyN3VuZGVmaW5lZFx1MDAyNztgKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4gT3BlcmF0b3InKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUgKyAnX29wJykucmVtYXJrKGByZXR1cm4gKGZkX2RhdGEuZmxvd192YXIuanNvbi5PUEVSQVRPUlMgfHwge30pLiR7ZWFDb2RlfTtgKSwNCiAgICAgICAgICAgICAgICAgICAgXSksDQoNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnSWYgJyArIGMuTmFtZSArICcgJytlYS5OYW1lKycgU2V0JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuJyArIGVhQ29kZSArICdfc2V0fX09dHJ1ZScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPi5wYXJlbnRfRmxvd19JbnN0YW5jZXMoPCVzdWJmbG93KCduZXcgJytzY29wZSsnLicrX2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpKycoKS4nK21OYW1lKycoZmFsc2UsIHRydWUpJywge2pzb246ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fScifSklPik8JX0lPg0KICAgICAgICAgICAgICAgICAgICAucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FkZCAnK2VhLk5hbWUrJyB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX1eJytlYUNvZGUifV0pJT4sDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdJZiAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBPcGVyYXRvciBpcyBub3QgZW1wdHknLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnX29wfX0hPScifV0pJT4ucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgJytlYS5OYW1lKycgT3BlcmF0b3IgdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5JywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19e3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKydfb3B9fScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnRWxzZSAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBub3QgU2V0JywgJ0Vsc2UnKSU+LnBhcmVudF9GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kID0gdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5IGZvciAnK2VhLk5hbWUsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fT0nIn1dKSU+DQogICAgICAgICAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT48JWxvZ2ljKCdGb3IgZWFjaCAnK2MuTmFtZSsnICcrZWEuTmFtZSwgJ0ZvciBFYWNoJywgW3tjZDogIidpdGVtcyciLCB2OiAiJ3t7PDwqKiMkZltpbnRlcm5hbF9uYW1lPVxcJyIrYy5OYW1lKyJfbG9va3VwXFwnIGFuZCAkbm90KCRleGlzdHMoZmxvd19GbG93X1NuYXBzaG90cykpXS5zbmFwc2hvdF9GbG93X0xvZ2ljcy4qKi5wYXJlbnRfRmxvd19JbnN0YW5jZXMjJGZpWyRudW1iZXIob3JkZXIpPD0iK2JPcmRlcisiIGFuZCBzdWJmbG93LmludGVybmFsX25hbWU9XFwnIitlYS5FbnRpdHlUeXBlLk5hbWUrIl9sb29rdXBcXCddLnVpX2lkPj4uIitlYS5FbnRpdHlUeXBlLk5hbWUrIl9saXN0fX0nIn1dKSU+LnBhcmVudF9GbG93X0xvZ2ljcyhbPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCAnK2VhLk5hbWUrJyB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX17e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319JyJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT5dKTwlfSU+LA0KICAgICAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICBdKTwlfSU+DQogICAgICAgICAgICAgICAgLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iajwlaWYoMCB8fCBbJ1VzZXInLCAnR2VuZGVyJywgJ19TdHVkZW50JywgJ19UZWFjaGVyJ10uaW5kZXhPZih0YS5FbnRpdHlDbGFzcy5OYW1lKT49MCl7JT4uZmxvd19GbG93X0xvZ2ljcyhbPCVsb2dpYygnSWYgJyt0YU5hbWUrJyBub3QgZW1wdHknLCAnSWYnKSU+LnBhcmVudF9GbG93X0luc3RhbmNlcyg8JXN1YmZsb3coJ25ldyAnK3Njb3BlKycuJytfY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpKycoKS4nK21OYW1lKycoYkRyYWZ0LCB0cnVlKScsIHtqc29uOiAiJ3Rlc3QnIn0pJT4pXSk8JX0lPiwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF9sb29rdXA6IG9iaiA9PiBvYmouZmxvd19GbG93X0xvZ2ljcyhbPCVsb2dpYygnSWYgRVF1ZXJ5IG5vdCBlbXB0eScsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19IT0nIn1dKSU+DQogICAgICAgICAgICAgICAgICAgIC5wYXJlbnRfQWN0aW9uX0luc3RhbmNlcyhbDQogICAgICAgICAgICAgICAgICAgICAgICA8JWFjdGlvbignbG9va191cF9yZWNvcmRzJywge3RhYmxlOiAnIjw8JC5zeXNfc2NvcGUuc2NvcGU+Pl8iKygnK19uQ29kZSgpKycpLnRvTG93ZXJDYXNlKCknfSklPiwNCiAgICAgICAgICAgICAgICAgICAgXSkubG9naWNfRmxvd19JbnB1dF9TY3JpcHRzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KCkubmFtZSgnU2V0IENvbmRpdGlvbicpLmFjdGl2ZSh0cnVlKS5jb2RlKCdjb25kaXRpb25zJykucmVtYXJrKGByZXR1cm4gZmRfZGF0YS5mbG93X3Zhci5lcXVlcnk7YCksDQogICAgICAgICAgICAgICAgICAgIF0pDQogICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgX3NuYXBzaG90OiBvYmogPT4gYkRyYWZ0P251bGw6b2JqLmZsb3dfRmxvd19TbmFwc2hvdHMobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFNuYXBzaG90JywgdHJ1ZSklPig8JT1fZmlkKCklPikuc25hcHNob3RfRmxvd19QbGFucyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBQbGFuJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT1jLk5hbWUlPl9QbGFuJykubmFtZSgnPCU9Yy5OYW1lJT4gUGxhbicpDQogICAgICAgICAgICAgICAgICAgIF0pLmZyb21GbG93KHRoaXMuPCU9bU5hbWUlPih0cnVlKSkpLA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBiRHJhZnQsIGJIZWFkZXIpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICByZXR1cm4gW107DQogICAgPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J190b1NOU2NyaXB0JyU+KG9wdGlvbnM9e30pew0KICAgICAgICBvcHRpb25zLl90aGlzID0gb3B0aW9ucy5fdGhpcyB8fCB0aGlzOw0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgICAgIGxldCBleHAgPSBvcHRpb25zLnJhdz8iX3RvSlNPTiI6Il90b0RvY3VtZW50IjsNCiAgICAgICAgICAgIGxldCByb2xsYmFjayA9IChvcHRpb25zLmFwcCAmJiBvcHRpb25zLnJvbGxiYWNrKT9hd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1JvbGxiYWNrIENvbnRleHQnLCB0cnVlKSU+KCkuY29kZSgnbGFzdCcpW2V4cF0oT2JqZWN0LmFzc2lnbih7YkpTT046IHRydWV9LCBvcHRpb25zKSk6IiI7DQogICAgICAgICAgICBsZXQgZGIgPSBvcHRpb25zLmRiP2F3YWl0IG9wdGlvbnMuX3RoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05UYWJsZSgpW2V4cF0oT2JqZWN0LmFzc2lnbih7YkpTT046IHRydWV9LCBvcHRpb25zKSk6IiI7DQogICAgICAgICAgICBsZXQgZmxvdyA9IG9wdGlvbnMuZmxvdz9hd2FpdCBvcHRpb25zLl90aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NORmxvdyhvcHRpb25zLmRyYWZ0KVtleHBdKE9iamVjdC5hc3NpZ24oe2JKU09OOiB0cnVlfSwgb3B0aW9ucykpOiIiOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvcHRpb25zLmd6aXApew0KICAgICAgICAgICAgICAgIGlmKGZsb3cpIGZsb3cgPSB0aGlzLlV0ZjhBcnJheVRvU3RyKGF3YWl0IHRoaXMuX2NvbXByZXNzKGZsb3cpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRlc3QgPSAob3B0aW9ucy50ZXN0ICYmIG9wdGlvbnMuZmxvdyAmJiAhb3B0aW9ucy5kcmFmdCk/YFxuLypncy5jYWNoZUZsdXNoKCk7ICovZ3MuaW5mbyhzbl9mZC5GbG93QVBJLmdldFJ1bm5lcigpLnN1YmZsb3coJyR7dGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpfS5Vc2VyX2xvb2t1cCcpLmluRm9yZWdyb3VuZCgpLndpdGhJbnB1dHMoe2pzb246IHtjb2RlOiJ0ZXN0IixkYXRlOicyMDI0LTA1LTAzVDE4OjQ0OjAzLjE3N1onLGdlbmRlcjp7Y29kZToiTSIsIE9QRVJBVE9SUzoge2NvZGU6ICIhPSJ9fSx1c2VyX1N0dWRlbnRzOlt7Y29kZToiU1RBIixnZW5kZXI6e2NvZGU6Ik0ifX1dLCBPUEVSQVRPUlM6IHtkYXRlOiAnPCd9fX0pLnJ1bigpLmdldE91dHB1dHMoKVsiVXNlcl9saXN0Il0pO1xuYDonJzsNCiAgICAgICAgICAgIGxldCBhcHAgPSBvcHRpb25zLmFwcD8obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBcHBsaWNhdGlvbicsIHRydWUpJT4oKS8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlNhdmUob3B0aW9ucykgKyBgXG4gdmFyIGNvbmZpZyA9IHtBcHBsaWNhdGlvbjoge3JlYWRPbmx5OiB0cnVlfSwgVGFibGU6IHtpZEtleTogJ25hbWUnLCBMb2dTZXQ6IDB9LCBDb2x1bW46IHtMb2dTZXQ6IDB9LCBFbGVtZW50X01hcHBpbmc6IHtMb2dTZXQ6IDB9LCBBY3Rpb25fSW5wdXQ6IHtyZWFkT25seTogdHJ1ZX0sIEFjdGlvbl9UeXBlOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbWFzdGVyX3NuYXBzaG90J30sIEFjdGlvbl9JbnN0YW5jZToge0xvZ1NldDogMH0sIFNlY3VyaXR5X1R5cGU6IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICduYW1lJ30sIFNlY3VyaXR5X09wZXJhdGlvbjoge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ25hbWUnfSwgTG9naWNfRGVmaW5pdGlvbjoge3JlYWRPbmx5OiB0cnVlfSwgRmxvdzoge0xvZ1NldDogMH0sIFRyYW5zZm9ybToge3JlYWRPbmx5OiB0cnVlfSwgVHJhbnNmb3JtX0NvbXBvc2l0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBSb2xsYmFja19Db250ZXh0OiB7cmVhZE9ubHk6IHRydWV9fTsgXG5gICsgKG9wdGlvbnMucm9sbGJhY2s/KCJ2YXIgY2lkID0gc2F2ZVJvbGxiYWNrX0NvbnRleHQoIityb2xsYmFjaytgKTsgaWYoY2lkKXt2YXIgcncgPSBuZXcgR2xpZGVSb2xsYmFja1dvcmtlcigpOyBydy5zZXRSb2xsYmFja0NvbnRleHRJRChjaWQuc3lzX2lkKTsgcncuc3RhcnQoKTt9IFxuYCk6IiIpKyAob3B0aW9ucy5kYj8oInNhdmVUYWJsZSgiK2RiKyIpOyBcbiIpOiIiKSArIChvcHRpb25zLmZsb3c/KCJzYXZlRmxvdygiK2Zsb3crIik7IFxuIik6IiIpICsgdGVzdCk6KHJvbGxiYWNrICsgZGIgKyBmbG93KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHNjcmlwdCA9IHRoaXMuX2JlYXV0aWZ5KGFwcCwgJ2phdmFzY3JpcHQnKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuZGVwbG95KSByZXR1cm4gc2NyaXB0Ow0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvU05TYXZlJyU+KG9wdGlvbnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICA8JSB2YXIgX2ZSZWdFeHAgPSAvX2Z7W159XSt9L2dtOyAlPg0KICAgICAgICAgICAgbGV0IF9mID0gKHYsIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHY7DQogICAgICAgICAgICAgICAgICAgIC8vaWYodi5zdGFydHNXaXRoKCJmKCIpICYmIHYuZW5kc1dpdGgoIikiKSkgcmV0ID0gJygnK3Yuc2xpY2UoMiwtMSkrJyknOw0KICAgICAgICAgICAgICAgICAgICBpZih2LnN0YXJ0c1dpdGgoInMoIikgJiYgdi5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGAoZnVuY3Rpb24gKG9iaiwgJHtlYUNvZGV9KXtgK3Yuc2xpY2UoMiwtMSkrYH0pKG9iaiwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHJldCAmJiByZXQubWF0Y2ggJiYgcmV0Lm1hdGNoKDwlPV9mUmVnRXhwJT4pKSByZXQgPSBgKGZ1bmN0aW9uIChvYmosICR7ZWFDb2RlfSl7JHtyZXQuaW5kZXhPZigicmV0dXJuIik8MD8icmV0dXJuICI6IiJ9ICdgK3JldC5yZXBsYWNlKDwlPV9mUmVnRXhwJT4sIG0gPT4gYCcgKyAke20uc2xpY2UoMywgLTEpfSArICdgKStgJzt9KShvYmosICR7ZWFDb2RlfSlgOw0KICAgICAgICAgICAgICAgICAgICBpZihyZXQgJiYgcmV0Lm1hdGNoICYmIHJldC5tYXRjaCgvPDxbXj4+XSs+Pi9nbSkpIHJldCA9ICciIic7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBgKGZ1bmN0aW9uKHYpeyB0cnl7IHJldHVybiAodiAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSg8JT1fZlJlZ0V4cCU+LCBmdW5jdGlvbihtKXtyZXR1cm4gZXZhbChtLnNsaWNlKDMsIC0xKSk7fSk6djsgIH1jYXRjaChleCl7Z3MuaW5mbygnX2Z7RXhjZXB0aW9ufTogJHtlYUNvZGV9OiAnICsgZXgpOyByZXR1cm4gdjt9IH0pKCR7cmV0fSB8fCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGVhQ29kZTsNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCB2YXJzOiBgYCwgY29kZTogYGAsIHF1ZXJ5OiBgYCwgc2V0OiBgYCwgZXNldDogYGAsIGRzZXQ6IGBgLCB0YXM6IGBgLCBkZXBzOiB7fX0sIHsNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2Lm9iaiA9ICh0eXBlb2Yob3B0aW9ucy5yZXVzZWQpPT09J3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZXVzZWQ+PXYucmV1c2VkKT92Lm9iajp7Y29kZTogdi5vYmouY29kZSArIGBcblxuLyoqIHJldXNlZDogdi5vYmouSWQqKi9cblxuYCwgZGVwczogJycsIElkOiB2Lm9iai5JZH0sDQoNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmouSWQgPSBgaWYob2JqLiR7aWRDb2RlfSAmJiBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpLmxlbmd0aD09MzIpe190b1N0cmluZys9J18nK29iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJyk7IGdyLmdldCgnc3lzX2lkJywgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKSk7fVxuYDsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmlkVG9TdHJpbmcgPSBgX3RvU3RyaW5nICs9IChvYmo/b2JqLiR7aWRDb2RlfTooJ2dyXycrZ3Iuc3lzX2lkKSkgKyAnOiAnOyBgOw0KICAgICAgICAgICAgICAgICAgICBvYmoubmV3VVVJRCA9IGBpZighb2JqLiR7aWRDb2RlfSB8fCBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpLmxlbmd0aCE9MzIpe29iai4ke2lkQ29kZX0gPSBnci5zZXROZXdHdWlkKCk7fWVsc2V7Z3Iuc2V0TmV3R3VpZFZhbHVlKG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykpO319XG5gOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSE9Yyl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPiA9ICh2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgICAgIG9iai52YXJzICs9IGB2YXIgJHtlYUNvZGV9ID0gPCVpZihlYS5FbnRpdHlUeXBlKXslPigoKHJlZnMuPCU9bk5hbWUoZWEpJT4gPSAodHlwZW9mKG9iai4ke2VhQ29kZX0pIT09J3VuZGVmaW5lZCc/Lyp0aGlzLiovc2F2ZTwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4ob2JqLiR7ZWFDb2RlfSwgezwlPW5OYW1lKGMpJT46IG9iaiwgPCU9bk5hbWUoYy8qZWEqLyklPlJlZnM6IHJlZnMsIDwlPW5OYW1lKGMpLnRvTG93ZXJDYXNlKCklPjogZ3J9LCAiPCU9bk5hbWUoYyklPiIsIHJlZnMuPCU9bk5hbWUoZWEpJT4gfHwgLypFWFA6IHJlZnMuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSkudG9Mb3dlckNhc2UoKSU+IHx8ICovKCR7X2YoPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4sIGVhQ29kZSl9KSk6cmVmcy48JT1uTmFtZShlYSklPikpIHx8IHtzeXNfaWQ6ICcnfSlbLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4uaWRLZXkgfHwgInN5c19pZCJdKS50b1N0cmluZygpPCV9ZWxzZXslPm9iai4ke2VhQ29kZX08JX0lPjtgOw0KICAgICAgICA8JSBpZihlYS5Jc1VuaXF1ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnF1ZXJ5ICs9IGBfdG9TdHJpbmcrPSdfJyske2VhQ29kZX07IF90b1F1ZXJ5LiR7ZWFDb2RlfSA9ICR7X2YodiwgZWFDb2RlKX07IGA7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmouc2V0ICs9IGBpZih0eXBlb2YoX3RvU2V0LiR7ZWFDb2RlfSA9ICR7X2YodiwgZWFDb2RlKX0pIT09J3VuZGVmaW5lZCc8JWlmKGVhLkVudGl0eVR5cGUpeyU+JiYgX3RvU2V0LiR7ZWFDb2RlfTwlfSU+KSBnci5zZXRWYWx1ZSgnJHtlYUNvZGV9JywgX3RvU2V0LiR7ZWFDb2RlfSk7YDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IG9iai5lc2V0ICs9IGBpZih0eXBlb2YoX3RvU2V0LiR7ZWZDb2RlfSA9ICR7X2YoSlNPTi5zdHJpbmdpZnkodiksICdvYmouJytlZkNvZGUpfSkhPT0ndW5kZWZpbmVkJykgZ3Iuc2V0VmFsdWUoJyR7ZWZDb2RlfScsIF90b1NldC4ke2VmQ29kZX0pO2AsDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnRhcyArPSBgcmVmcy48JT10YU5hbWUlPiA9ICgob2JqP29iai4ke2VhQ29kZX06W10pIHx8IFtdKS5tYXAoZnVuY3Rpb24obyl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnID0+IHNhdmU8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPigke2VhQ29kZX1bXSknKTsgcmV0dXJuIC8qdGhpcy4qL3NhdmU8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPihvLCB7PCU9bk5hbWUoYyklPjogb2JqLCA8JT1uTmFtZShjKS50b0xvd2VyQ2FzZSgpJT46IGdyLCBtYW55UmVmczogcmVmc30sICI8JT1uTmFtZShjKSU+Iik7fSk7YA0KICAgICAgICAgICAgICAgICAgICBvYmouZGVwcy48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiA9ICh2ICYmIHYubGVuZ3RoKT92WzBdOm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighcmV0LmRzZXQpIHJldC5kc2V0ICs9IGBcbmlmKHR5cGVvZihvYmopPT09Im9iamVjdCIpIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGZ1bmN0aW9uKGspe3JldHVybiAhay5zdGFydHNXaXRoKCdfXycpICYmIFsnc3lzX2lkJywgJ0lkJywgJ09QRVJBVE9SUyddLmluZGV4T2Yoayk8MCAmJiB0eXBlb2YoX3RvU2V0W2tdKT09PSd1bmRlZmluZWQnICYmICFBcnJheS5pc0FycmF5KG9ialtrXSk7fSkuZm9yRWFjaChmdW5jdGlvbihrKXtfdG9TZXRba10gPSAke19mKCJvYmpba10iLCAibnVsbCIpfTsgaWYoX3RvU2V0W2tdICYmIF90b1NldFtrXS5fX2NsYXNzKXtfdG9TZXRba10gPSBfdG9TZXRba11bY29uZmlnW190b1NldFtrXS5fX2NsYXNzXS5pZEZpZWxkIHx8ICdJZCddOyB9IGdyLnNldFZhbHVlKGssIF90b1NldFtrXSApOyB9KVxuYDsNCg0KICAgICAgICAgICAgcmV0LmNvZGUgKz0gYCR7T2JqZWN0LnZhbHVlcyhyZXQuZGVwcykuam9pbignXG4nKX1mdW5jdGlvbiBzYXZlPCU9bk5hbWUoYyklPihvYmosIHJlZnMsIHNvdXJjZSwgZ3Ipe3JlZnMgPSByZWZzIHx8IHt9OyAvKnRoaXMuKi9jb25maWcuc2F2ZV8kezwlPV9uQ29kZSgpJT59ID0gc2F2ZTwlPW5OYW1lKGMpJT47IC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+ID0gLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4gfHwge307IC8qdGhpcy4qL2NvbmZpZy5faWRNYXAgPSAvKnRoaXMuKi9jb25maWcuX2lkTWFwIHx8IFtdOyB2YXIgX3RvU3RyaW5nID0gc291cmNlICsgJ1snICsgKHJlZnNbc291cmNlXS5zeXNfaWQpICsgJ109PiBzYXZlPCU9bk5hbWUoYyklPignOyBpZih0eXBlb2Yob2JqKT09PSdzdHJpbmcnICYmIG9iai5sZW5ndGg+PTMyKXt2YXIgcmV0ID0ge307IHJldFsvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5pZEtleSB8fCAic3lzX2lkIl09b2JqOyBncy5pbmZvKF90b1N0cmluZyArICcpOiBvYmogaXMgdXVpZCwgcmV0dXJuaW5nIHsnK29iaisnfScpOyByZXR1cm4gcmV0O30gaWYoIW9iaiAmJiAhZ3Ipe2dzLmluZm8oX3RvU3RyaW5nICsgJyk6IG9iaiBpcyBudWxsJyk7IHJldHVybiBudWxsO30gJHtyZXQuaWRUb1N0cmluZ30gdmFyIGJTYXZlID0gIS8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LnJlYWRPbmx5OyBpZighZ3IpeyBnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpO1xuJHtyZXQuSWR9XG4ke3JldC52YXJzfVxuaWYoIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTsgdmFyIF90b1F1ZXJ5PXt9OyAke3JldC5xdWVyeX0gXG5fdG9TdHJpbmcgKz0gJyk6ICc7IGlmKG9iai5fX2tleXMgJiYgKGJTYXZlIHx8IGNvbmZpZy48JT1uTmFtZShjKSU+LnJlYWRPbmx5KSl7aWYoX3RvUXVlcnkuX19lbmNvZGVkUXVlcnkpe2dyLmFkZEVuY29kZWRRdWVyeShfdG9RdWVyeS5fX2VuY29kZWRRdWVyeSk7fWVsc2V7b2JqLl9fa2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGspe2dyLmFkZFF1ZXJ5KGssIF90b1F1ZXJ5W2tdIHx8IG9ialtrXSk7fSk7fSBnci5zZXRMaW1pdCgxKTsgaWYoIWdyLmdldEVuY29kZWRRdWVyeSgpKSBnci5hZGRRdWVyeSgnc3lzX2lkJywgJy0xJyk7IGdzLmluZm8oX3RvU3RyaW5nICsgJ0VuY29kZWQgUXVlcnk6ICcgKyBnci5nZXRFbmNvZGVkUXVlcnkoKSk7IGdyLnF1ZXJ5KCk7aWYoIWdyLm5leHQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnbm90IGZvdW5kJyk7fWVsc2V7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnZm91bmQgWyR7PCU9X25Db2RlKCklPn0vJyArIGdyLnN5c19pZCArICddIC0gaXMgdmFsaWQ6ICcgKyBnci5pc1ZhbGlkUmVjb3JkKCkpOyBvYmouSWQgPSBnci5zeXNfaWQudG9TdHJpbmcoKTsgaWYob2JqLl9fcmV1c2VkKXsvKmdzLmluZm8oX3RvU3RyaW5nICsgJzogX19yZXVzZWQ6IFskezwlPV9uQ29kZSgpJT59LycgKyBnci5zeXNfaWQgKyAnXSAtIGlzIHZhbGlkOiAnICsgZ3IuaXNWYWxpZFJlY29yZCgpKTsgKi9yZXR1cm4gZ3I7fSB9fX19ZWxzZXtiU2F2ZT1mYWxzZTt9IGlmKGJTYXZlICYmICFnci5pc1ZhbGlkUmVjb3JkKCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ2luc2VydGluZy4uLicpOyBnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpOyBnci5pbml0aWFsaXplKCk7ICR7cmV0Lm5ld1VVSUR9IGlmKGJTYXZlICYmIG9iail7dmFyIF90b1NldCA9IHt9OyAvKnNldCovJHtyZXQuc2V0fSAvKmVzZXQqLyR7cmV0LmVzZXR9ICAke3JldC5kc2V0fSBpZigvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5Ob1dvcmtmbG93KSBnci5zZXRXb3JrZmxvdyhmYWxzZSk7IGlmKC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LkxvZ1NldCkgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnX3RvU2V0OiAnICsgSlNPTi5zdHJpbmdpZnkoX3RvU2V0KSk7IH1lbHNlIGlmKCFnci5pc1ZhbGlkUmVjb3JkKCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ1tiU2F2ZT0nICsgYlNhdmUgKyAnXSAtIHJldHVybmluZyBudWxsLicpOyByZXR1cm4gbnVsbDt9XG5pZighYlNhdmUgfHwgZ3IudXBkYXRlKCkpeyBpZihmYWxzZSAmJiBiU2F2ZSl7Y29uZmlnLl9pZE1hcC5wdXNoKHt0YWJsZTogJyR7PCU9X25Db2RlKCklPn0nLCBzeXNfaWQ6IGdyLnN5c19pZC50b1N0cmluZygpLCBrZXlzOiBvYmouX19rZXlzLm1hcChmdW5jdGlvbihrKXtyZXR1cm4ge2s6IGssIHY6IF90b1F1ZXJ5W2tdIHx8IG9ialtrXX07fSl9KTt9ICR7cmV0LnRhc31cbmdzLmluZm8oX3RvU3RyaW5nICsgJ1tiU2F2ZT0nICsgYlNhdmUgKyAnXSAtIHJldHVybmluZyAnICsgZ3Iuc3lzX2lkKTsgcmV0dXJuIGdyO319XG5gOw0KDQogICAgICAgICAgICAvKnJldHVybiBPYmplY3QudmFsdWVzKE9iamVjdC5hc3NpZ24oe30sIC4uLnJldC5jb2RlLnNwbGl0KCdmdW5jdGlvbiBzYXZlJykuZmlsdGVyKHMgPT4gcykuc29ydCgoYSwgYikgPT4gYS5sZW5ndGggLSBiLmxlbmd0aCkubWFwKHMgPT4gKHtbcy5zcGxpdCgnKG9iaiwgcmVmcywgc291cmNlLCBnciknKVswXV06ICdmdW5jdGlvbiBzYXZlJytzfSkpKSkuam9pbignXG4nKTsgKi8NCiAgICAgICAgICAgIHJldHVybiByZXQuY29kZTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU05RdWVyeSclPihmaWVsZHMsIG9ianMsIGJVUkwpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgT1BFUkFUT1JTOiB0cnVlLA0KICAgICAgICAgICAgLy9fbWFwOiB0cnVlLA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2P3YuPCU9bU5hbWUlPigpOm51bGw7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOw0KICAgICAgICAgICAgICAgIGxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7DQogICAgICAgICAgICAgICAgaWYoKHYuZ2V0SG91cnMoKT09MCAmJiB2LmdldE1pbnV0ZXMoKT09MCAmJiB2LmdldFNlY29uZHMoKT09MCkgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09Jz0nIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIT09J0JFVFdFRU4nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgb2JqLk9QRVJBVE9SUy48JT1uTmFtZShlYSklPiA9ICc9JzsNCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICBPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSE9PSd1bmRlZmluZWQnICYmIHR5cGVvZihyZXRba10pIT09J29iamVjdCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsNCg0KICAgICAgICBkZWxldGUgcmV0Lk9QRVJBVE9SUzsNCiAgICAgICAgT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7DQoNCiAgICAgICAgcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOw0KDQogICAgICAgIC8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycw0KICAgICAgICBPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQoNCiAgICAgICAgaWYoYlVSTCkgcmV0ID0gT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0lPg0KDQoJPCU9bU5hbWU9J19fZXhwb3J0JyU+KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgew0KCSAgICB0cnl7DQogICAgCSAgICBpZighb2JqKSByZXR1cm4gdGhpczsNCiAgICAJICAgIA0KICAgIAkgICAgaWYob3B0aW9ucy5PUEVSQVRPUlMpIG9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9Ow0KICAgIAkgICAgDQogICAgCSAgICA8JSAvKiBJTVBPUlRBTlQ6IHRoaXMuSWQ9PXRoaXMuSWQgbWFrZXMgc3VyZSB0aGUgSWQgaXMgZml4ZWQgZm9yIHRoZSB0b29sLCBub3QgZ2V0dGluZyBnZW5lcmF0ZWQgZXZlcnkgdGltZSB3ZSBjYWxsIGl0ICovICU+DQogICAgCSAgICANCiAgICAJICAgIGxldCBlYUNvZGVzID0gew0KICAgIAkgICAgICAgIGV4cG9ydGVyOiAiIiwNCiAgICAJICAgICAgICBJZDogIiIsDQogICAgCSAgICB9Ow0KICAgIAkgICAgDQogICAgCQlpZiAoIW9wdGlvbnMuVW5pcXVlICYmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKSkgdGhpcy5fX29wdGlvbnMoIklkIiwgb2JqLCBlYUNvZGVzLklkID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnSWQnKTonSWQnKSwgdGhpcy5JZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCiAgICAJCQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWYuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiZWZfPCU9bk5hbWUoZWYpJT4iLCBvYmosIGVhQ29kZXMuZWZfPCU9bk5hbWUoZWYpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlZiklPjo8JV92Q29kZShlZiklPiksIDwldmFsdWVPZihlZi5WYWx1ZSklPiwgdGhpcywgb3B0aW9ucywgZnVuKTsNCjwlIH0pJT4NCg0KCQkgICAgPCUgdW5SZWN1cnNlKCdvYmonLCAnZnVuJywgJ2ZBcmdzJywgJ2lmKHR5cGVvZihvcHRpb25zLmV4cG9ydGVyKT09PSJmdW5jdGlvbiIpIG9wdGlvbnMuZXhwb3J0ZXIodiknKSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmICFlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCJfVEhJUyIsIG9iaiwgZWFDb2Rlcy5fVEhJUyA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ19USElTJyk6Il9USElTIiksIHRoaXMuX1RISVMsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIjwlPXRhTmFtZSU+Iiwgb2JqLCBlYUNvZGVzLjwlPXRhTmFtZSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUodGEsIHRydWUpJT46IjwlPXRhTmFtZSU+IiksIHRoaXMuPCU9dGFOYW1lJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZCh0YSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSBPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSk9PT0nZnVuY3Rpb24nICYmICFPYmplY3Qua2V5cyhlYUNvZGVzKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IHRoaXMuX19vcHRpb25zKGssIG9iaiwgaywgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pKTsNCiAgICAgICAgDQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSB8fCB7fTsNCiAgICAgICAgICAgICg8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyB8fCBbXSkuZm9yRWFjaChuID0+IG4uX2Nbbi5lYUZpZWxkXShuLl9jW24uZWFGaWVsZF0oKS5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vQXJnczogdHJ1ZSwgX21hcDogb3B0aW9ucy5fbWFwfSwgZnVuKSkpOw0KICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgPSBbXTsgLy8/Pw0KICAgICAgICAgICAgDQogICAgCQlyZXR1cm4gb2JqOw0KICAgIAl9Y2F0Y2goZXgpew0KICAgIAkgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgIAl9DQoJfQ0KCQ0KCTwlPW1OYW1lPSdfX29wdGlvbnMnJT4oZmllbGQsIG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXM9dGhpcywgb3B0aW9ucz17fSwgZnVuLCBlYUZpZWxkKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWVsZCwgb2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcywgb3B0aW9ucywgZnVuLCBlYUZpZWxkKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOw0KICAgICAgICAgICAgaWYoIW9iaikgcmV0dXJuOw0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnNbZmllbGRdKSE9PSJmdW5jdGlvbiIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihlYU9iaikhPT0ndW5kZWZpbmVkJyAmJiAhb3B0aW9ucy5OdWxsKXsNCiAgICAgICAgICAgICAgICBpZihmaWVsZCE9J0lkJyAmJiB0eXBlb2YoX3RoaXNbZmllbGRdKT09PSdmdW5jdGlvbicgJiYgIV90aGlzWydfJytmaWVsZCsnX3NldCddKSByZXR1cm47DQogICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkhPT0ndW5kZWZpbmVkJykgZWFPYmogPSBlYU9iai5maWx0ZXIodiA9PiB2KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuTnVsbCAmJiBBcnJheS5pc0FycmF5KGVhT2JqKSAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47DQoNCiAgICAgICAgICAgIGxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcyk7DQogICAgICAgICAgICBpZihvcHRpb25zLk9QRVJBVE9SUyAmJiBfdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7W2ZpZWxkXTogX3RoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXX0pOw0KDQogICAgICAgICAgICBpZighb3B0aW9ucy5DeWNsaWMgJiYgZWFGaWVsZCAmJiBvYmogJiYgb2JqLkVudGl0eUNsYXNzICYmIHR5cGVvZihvYmpbZmllbGRdKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dIHx8IHt9Ow0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgfHwgW107DQogICAgICAgICAgICAgICAgbGV0IF9jeWNsZXMgPSBvYmpbZmllbGRdKCk7DQogICAgICAgICAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkoX2N5Y2xlcykpIF9jeWNsZXMgPSBbX2N5Y2xlc107DQogICAgICAgICAgICAgICAgX2N5Y2xlcyA9IF9jeWNsZXMuZmlsdGVyKF9jID0+IF9jICYmIHR5cGVvZihfY1tlYUZpZWxkXSk9PT0nZnVuY3Rpb24nICYmIF9jWydfJyArIGVhRmllbGQgKyAnX3NldCddICYmIG9iai5fc2FtZUVudGl0eShfY1tlYUZpZWxkXSgpKSkubWFwKF9jID0+ICh7DQogICAgICAgICAgICAgICAgICAgIC8qbWFyayBfY1tlYUZpZWxkXV9zZXQgdG8gbnVsbCBpbnN0ZWFkKi8NCiAgICAgICAgICAgICAgICAgICAgX2MsDQogICAgICAgICAgICAgICAgICAgIGVhRmllbGQsDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKF9jeWNsZXMubGVuZ3RoKSA8JT13YXJuKCklPmZ1biArICIvX2N5Y2xlcyIsIF9jeWNsZXMpOw0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljLnB1c2goLi4uX2N5Y2xlcyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuX21hcCkgX3RoaXMuX21hcChmaWVsZCwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnLCBmdW4sIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJz9vYmo6ZWFPYmosIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJz9fdGhpczpvYmosIGVhQ29kZSk7DQoNCiAgICAgICAgICAgIHJldHVybiBfcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZnVuLCBmaWVsZCwgZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoJDQoJPCU9bU5hbWU9J19faW1wb3J0JyU+KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgew0KICAgICAgICBpZih0eXBlb2Yob2JqKSE9PSdvYmplY3QnKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+YCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCgkgICAgDQogICAgICAgIGxldCBlYUNvZGVzID0ge307DQoNCgkJaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIklkIiwgb2JqLCBlYUNvZGVzLklkID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnSWQnKTonSWQnKSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KCQkNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQoJCTwlIHVuUmVjdXJzZSgndGhpcycsICdmdW4nLCAnZkFyZ3MnLCAnaWYodHlwZW9mKG9wdGlvbnMuaW1wb3J0ZXIpPT09ImZ1bmN0aW9uIikgb3B0aW9ucy5pbXBvcnRlcih2KScpJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgIWVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSAgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KCQlpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiX1RISVMiLCBvYmosIGVhQ29kZXMuX1RISVMgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdfVEhJUycpOidfVEhJUycpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHsNCiAgICBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsNCiU+DQogICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT10YU5hbWUlPiIsIG9iaiwgZWFDb2Rlcy48JT10YU5hbWUlPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKHRhLCB0cnVlKSU+OiI8JT10YU5hbWUlPiIpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQodGEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSBPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSk9PT0nZnVuY3Rpb24nICYmICFPYmplY3Qua2V5cyhlYUNvZGVzKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IHRoaXMuX19vcHRpb25zKGssIG9iaiwgaywgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pKTsNCg0KCQlyZXR1cm4gdGhpczsNCgl9DQoNCjwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9DeVRhYmxlJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtjcWw6IGANCkNSRUFURSBDT05TVFJBSU5UIElGIE5PVCBFWElTVFMgRk9SIChvOiR7PCU9X25Db2RlKCklPn0pIFJFUVVJUkUgby4ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0gSVMgVU5JUVVFOw0KQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSBJUyBOT1QgTlVMTDsNCiAgICAgICAgYH0sIHsNCiAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9iai5jcWwgKz0gdj92LjwlPW1OYW1lJT4oKTonJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgb2JqLmNxbCArPSBgQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7ZWFDb2RlfSBJUyBVTklRVUU7DQpgDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5jcWwgKz0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKS5qb2luKCdcbicpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0LmNxbCk7DQogICAgICAgIHJldHVybiByZXQuY3FsOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvQ3lNZXJnZSclPihmaWVsZHMsIGJSYXcpew0KICAgICAgICBsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMsIHRydWUpOw0KICAgICAgICBsZXQgdWtleXMgPSBbXTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikgdWtleXMucHVzaCg8JT1fbkNvZGUoZWEpJT4pOw0KICAgIDwlIH0pJT4NCiAgICAgICAgbGV0IGNxbCA9IGA6JHs8JT1fbkNvZGUoKSU+fSB7YCArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdWtleXMuaW5jbHVkZXMoaykpLm1hcChrID0+IGsgKyAiOiAiICsgb2JqW2tdKS5qb2luKCcsICcpICsgYH0pYDsNCiAgICAgICAgDQogICAgICAgIGlmKCFiUmF3KXsNCiAgICAgICAgICAgIGxldCBtYXRjaCA9ICdcbk1BVENIIChvJyArIGNxbDsNCiAgICAgICAgICAgIGNxbCA9ICdNRVJHRSAobycgKyBjcWw7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvblNldCA9IE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gIXVrZXlzLmluY2x1ZGVzKGspKS5tYXAoayA9PiAiby4iICsgayArICI9IiArIG9ialtrXSkuam9pbignLCAnKQ0KICAgICAgICAgICAgY3FsICs9ICdcbk9OIENSRUFURSBTRVQgJyArIG9uU2V0ICsgJ1xuT04gTUFUQ0ggU0VUICcgKyBvblNldDsNCiAgICAgICAgICAgIGNxbCArPSAnXG5SRVRVUk4gbzsnOw0KDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIGNxbCArPSBtYXRjaCArICcsICcgKyB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihudWxsLCB0cnVlKS5yZXBsYWNlKCcoOicsICcoPCU9bk5hbWUoZWEpJT46JykgKyAnIE1FUkdFIChvKS1bOjwlPW5OYW1lKGMpJT5fPCU9bk5hbWUoZWEpJT5dLT4oPCU9bk5hbWUoZWEpJT4pOyc7DQogICAgPCUgfSklPg0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGNxbCA9ICcoJyArIGNxbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgIHJldHVybiBjcWw7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b0N5UXVlcnknJT4oZmllbGRzLCBvYmpzKXsNCiAgICAgICAgbGV0IHNxbCA9ICJNQVRDSCAiOw0KICAgICAgICANCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfWA7DQoNCiAgICAgICAgbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7DQoNCiAgICAgICAgc3FsICs9IGAgKCR7dFByZWZ9OiR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICAgICAgDQogICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgIE9QVElPTkFMIE1BVENIICgke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9OiR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSkgT1BUSU9OQUwgTUFUQ0ggKCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfSktWzoke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfV0tPigke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9KWApOw0KICAgICAgICANCg0KICAgICAgICAvL3NxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsNCiAgICAgICAgLy9PYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBmdW5jdGlvbn0NCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgIH0NCg0KICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KDQogICAgICAgIHNxbCA9IHRoaXMuX19leHBvcnQoe3NxbDogc3FsfSwgew0KICAgICAgICAgICAgX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCk/WydJZCddOnVuZGVmaW5lZCwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPih0Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIElkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCAiOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHtjb29wfSBFWElTVFMgeyR7di48JT1tTmFtZSU+KCl9fWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQgfHwgZWEuSXNJbWFnZSB8fCBlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkNPTlRBSU5TIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi50b0lTT1N0cmluZyl7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAodj8iMSI6IjAiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC48JT1tTmFtZSU+KCI8JT1uTmFtZSh0YSklPi5pZCIpKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgak9QID0gJ1VOSU9OIEFMTCc7DQogICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGA7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgIGluT1AgPSAnTk9UIElOJzsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J0lOJyl7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgIGpPUCA9ICdJTlRFUlNFQ1QnOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBhbmQgLyo8JT10YU5hbWUlPiovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgaWYoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KDQogICAgICAgIGlmKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNxbCArPSAnIHJldHVybiAnICsgW3RQcmVmXS5jb25jYXQoT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5tYXAoayA9PiBgJHt0aGlzLl9RKCl9JHtrfSR7dGhpcy5fUSgpfWApKS5qb2luKCcsICcpOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfbmVvNGonJT4oY3FsKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKT09Yyl7JT4NCiAgICAgICAgbGV0IHNlc3Npb24gPSBudWxsOw0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIWNxbCB8fCAhY3FsLnRyaW0oKSl7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYikgPCU9bG9nKCklPmNxbCwgIiA8PT1TS0lQUEVEPT0+Iik7DQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgaWYoY3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3Qgc3FsUyBvZiBjcWwuc3BsaXQoJztcbicpKXsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy48JT1tTmFtZSU+KHNxbFMudHJpbSgpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYlN0b3JlID0gWyJNRVJHRSIsICJDUkVBVEUiLCAiVVBEQVRFIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCiAgICAgICAgICAgIGxldCBiRE1MID0gWyJDT05TVFJBSU5UIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCg0KICAgICAgICAgICAgaWYoYkRNTCl7DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlID0gdGhpcy5Ub29sLmRtbENhY2hlIHx8IHt9Ow0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKGNxbCldKSByZXR1cm47DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoY3FsKV0gPSBjcWw7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHNlc3Npb24gPSB0aGlzLlRvb2wuZGIuc2Vzc2lvbih7IGRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpIH0pOw0KICAgICAgICAgICAgbGV0IGZ1biA9ICdSZWFkJzsNCiAgICAgICAgICAgIGlmKGJTdG9yZSB8fCBiRE1MKSBmdW4gPSAnV3JpdGUnOw0KICAgICAgICAgICAgaWYoZnVuPT0nV3JpdGUnKSB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goY3FsKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5jcWwpOw0KICAgICAgICAgICAgLy9yZXQgPSAoYXdhaXQgc2Vzc2lvblsnZXhlY3V0ZScrZnVuXSh0eCA9PiB0eC5ydW4oY3FsKSkpLnJlY29yZHM7DQogICAgICAgICAgICAvLzwlPWxvZygpJT5yZXQpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIGlmKHNlc3Npb24pIGF3YWl0IHNlc3Npb24uY2xvc2UoKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnTmVvNGonXSkpJT4oKS48JT1tTmFtZSU+KGNxbCk7DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1J4REInLCAnTW9uZ29EQiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvSlNPTlNjaGVtYSclPigpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgdHlwZSA9IHRoaXMuX19jb25maWcoJ2pzb24udHlwZScsICd0eXBlJyk7DQogICAgICAgICAgICBsZXQgc2NoZW1hID0gew0KICAgICAgICAgICAgICAgICRpZDogJzwlPWMuSWQlPicsDQogICAgICAgICAgICAgICAgJHNjaGVtYTogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LzIwMjAtMTIvc2NoZW1hIiwNCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJzwlPWMuUmVtYXJrJT4nLA0KICAgICAgICAgICAgICAgIHRpdGxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIFt0eXBlXTogJ29iamVjdCcsDQogICAgICAgICAgICAgICAgdmVyc2lvbjogMCwNCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7DQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgWzwlPV9uQ29kZShlYSklPl06IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiPCU9ZWEuUmVtYXJrJT4iLA0KICAgICAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmFycmF5JywgJ2FycmF5JyksDQogICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogew0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgJHJlZjogJzwlPWVhLkVudGl0eUNsYXNzLklkJT4nLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5zdHJpbmcnLCAnc3RyaW5nJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS50ZXh0JywgJ3N0cmluZycpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuYm9vbCcsICdib29sZWFuJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmludCcsICdpbnRlZ2VyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuZmxvYXQnLCAnbnVtYmVyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ltYWdlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuaW1hZ2UnLCAnb2JqZWN0JyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5maWxlJywgJ29iamVjdCcpLA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICByZXF1aXJlZDogWzwlYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLlJlcXVpcmVkKS5tYXAoZWEgPT4geyU+PCU9X25Db2RlKGVhKSU+PCV9KS5qb2luKCcsJyklPl0sDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICA8JT1sb2coKSU+c2NoZW1hKTsNCiAgICAgICAgICAgIHJldHVybiBzY2hlbWE7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnTW9uZ29EQicsICdSeERCJywgJ1phbmdvREInXSkpeyU+DQogICAgPCU9bU5hbWU9J190b1NlbGVjdE1kYiclPigpew0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouX2lkID0geyRpbjogdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgICAgICAgICAgSWQ6IG9iaiA9PiBvYmouX2lkID0gdGhpcy5JZCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZighdi48JT1tTmFtZSU+KSByZXR1cm47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0ge307DQogICAgICAgICAgICAgICAgbGV0IG9wID0gIiRlIjsNCiAgICAgICAgICAgICAgICBzd2l0Y2godGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj4iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI8IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRsdCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPD0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGx0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJG5lIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICJJTiI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkaW4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV1bb3BdID0gdi48JT1tTmFtZSU+KCkudG9JU09TdHJpbmcoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHYuPCU9bU5hbWUlPigpOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0geyRpbjogdi5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKF9zcWxUb29scykpeyU+DQogICAgPCU9bU5hbWU9J190b0RCT2JqZWN0JyU+KGZpZWxkcywgYk5vUmVmKXsNCiAgICAgICAgaWYoIXRoaXMuSWQpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7DQogICAgICAgIH0NCiAgICAgICAgbGV0IHJldCA9IHsNCiAgICAgICAgICAgIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciDQogICAgICAgIH07DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIjwlPWVhLk5hbWUlPiIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgKCFiTm9SZWYgfHwgPCU9ZWEuRW50aXR5VHlwZT8nZmFsc2UnOid0cnVlJyU+KSl7DQogICAgICAgICAgICBsZXQgZlZhbHVlID0gbnVsbDsNCiAgICAgICAgICAgIGxldCB2ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgaWYodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkPT12LklkKSl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdi5JZCArICInIjsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICJOVUxMIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdj8xOjA7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSBmVmFsdWU/J1RydWUnOidGYWxzZSc7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKSBmVmFsdWUgPSAiJyIgKyBmVmFsdWUgKyAiJyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdiB8fCAnMCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyAodj92LnRvSVNPU3RyaW5nKCk6IjE5NzAtMS0xIikgKyAiJyI7DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNPYmplY3QpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyBKU09OLnN0cmluZ2lmeSh2LCBudWxsLCAnXHQnKSArICInIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2PT09bnVsbD8iTlVMTCI6KCInIiArICgoZmFsc2UgJiYgdiAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSgvXFxuL2csICJcXFxcbiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCcvZywgIlxcXFwnIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnXFxcXCInKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwmL2csICJcXFxcJiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXHIvZywgIlxcXFxyIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcdC9nLCAiXFxcXHQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFxiL2csICJcXFxcYiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXGYvZywgIlxcXFxmIikgIDp2KSArICInIik7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgIGlmKHY9PT1udWxsKXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiTlVMTCI7DQogICAgICAgICAgICB9ZWxzZSBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKXsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgRlJPTV9CQVNFNjQoJyR7dGhpcy5fYnRvYSh2KX0nKWA7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBjYXN0KHVuaGV4KCcke3Yuc3BsaXQoIiIpLm1hcCh4ID0+ICgyNTYgKyB4LmNoYXJDb2RlQXQoKSkudG9TdHJpbmcoMTYpLnN1YnN0cigtMikpLmpvaW4oIiIpfScpIGFzIHZhcmNoYXIpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gdjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0WzwlPV9uQ29kZShlYSklPiArICI8JT0oZWEuRW50aXR5VHlwZT8naWQnOicnKSU+Il0gPSBmVmFsdWU7DQogICAgICAgIH0NCiAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdnZXQnJT4obmFtZSkgew0KICAgICAgICBpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOw0KICAgICAgICB2YXIgdCA9IG51bGw7DQogICAgICAgICQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7DQogICAgICAgICAgICB0ID0gew0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdCA/IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbdF0NCiAgICAgICAgICAgICAgICB9IDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIElkOiB0aGlzLklkDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgTmFtZTogZiwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPSINCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7DQogICAgICAgICAgICA8JT1sb2coKSU+ZXYpOw0KICAgICAgICAgICAgaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7DQoNCiAgICAgICAgICAgIGlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOw0KDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT5bJC5ncmVwKDwlPXNjb3BlJT4uRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7DQogICAgICAgIH0pOw0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX1EnJT4oKXsNCiAgICAgICAgbGV0IF9vID0gJyInOw0KICAgICAgICBsZXQgX3EgPSBfbzsNCg0KICAgICAgICBpZihbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpPT0wKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSAiIjsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpew0KICAgICAgICAgICAgX28gPSBfcSA9ICdgJzsNCiAgICAgICAgfWVsc2UgaWYoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKT09MCl7DQogICAgICAgICAgICBfbyA9IF9xID0gYCdgOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxzZXJ2ZXInKXsNCiAgICAgICAgICAgIF9vID0gJ1snOw0KICAgICAgICAgICAgX3EgPSAnXSc7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ2FwaUtleScpPT0nYWlydGFibGUnKXsNCiAgICAgICAgICAgIF9vID0gJ3snOw0KICAgICAgICAgICAgX3EgPSAnfSc7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9vP19xOl9vOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2ZpZWxkR3JvdXBzJyU+KGZncyA9IHt9KXsNCiAgICAgICAgdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19maWVsZEFnZ3JlZ2F0ZXMnJT4oZmFzID0ge30pew0KICAgICAgICB0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0ZpZWxkc1NRTCclPihmaWVsZHMpew0KICAgICAgICANCiAgICAgICAgZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyksIDwlPWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IF9uQ29kZShlYSkgKyAoZWEuRW50aXR5VHlwZT8nKyIuaWQiJzonJykpLmpvaW4oJywnKSU+XTsNCiAgICAgICAgZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpP2ZpZWxkczpbZmllbGRzXTsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBvcmRlcn0NCiAgICAgICAgICAgIGZpZWxkcyA9IFtdOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+KSBmaWVsZHMucHVzaChgJHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fWApOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmllbGRzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21EQk9iamVjdCclPihyPXt9KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQociwgew0KICAgICAgICAgICAgICAgIElkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KG9ialtlYUNvZGVdKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NlbGVjdEhlYWRlciclPihmaWVsZHMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gew0KICAgICAgICAgICAgICAgIHRhYmxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIGZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLA0KICAgICAgICAgICAgICAgIGpvaW5zOiB7fSwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKGZpZWxkcykgcmV0dXJuIHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TZWxlY3RTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHNxbCA9ICJzZWxlY3QgIjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX1gOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsNCg0KICAgICAgICAgICAgc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOw0KICAgICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7DQogICAgDQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKXsNCiAgICAgICAgICAgICAgICAvLyB7ZmllbGQ6IGZ1bmN0aW9ufQ0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgPSB0aGlzLl9fZXhwb3J0KHtzcWw6IHNxbH0sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIF9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpP1snSWQnXTp1bmRlZmluZWQsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih2LnJldXNlZD4yKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwlPXdhcm4oKSU+IlJldXNlZDogIiwgdik7DQogICAgICAgICAgICAgICAgICAgICAgICB2Lm9iai5zcWwgPSBgLypSRVNVRUQ6ICR7di5yZXVzZWR9Ki9gOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgLyphbmQgKi8ke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4odC5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnKS50aGlzKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLnNxbCArPSAodGhpcy5JZD09dGhpcy5JZCk/YCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A6JycsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCBJTiI7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJJTiI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuPCU9bU5hbWUlPih2Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpfSlgOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCB8fCBlYS5Jc0ltYWdlIHx8IGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgPCVpZihlYS5Jc0Jvb2wpeyU+Ij0iPCV9ZWxzZXslPih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIHx8ICJMSUtFIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYudG9JU09TdHJpbmcpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICh2PyIxIjoiMCIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBqT1AgPSAnVU5JT04gQUxMJzsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpbk9QID0gJ05PVCBJTic7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgICAgICBqT1AgPSAnSU5URVJTRUNUJzsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYW5kIC8qPCU9dGFOYW1lJT4qLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIikpLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzKXsNCiAgICAgICAgICAgICAgICBpZihPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoIXNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgICAgIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikhPT0ndW5kZWZpbmVkJz9zcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCk6c3FsOw0KICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBzcWw7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1BhdGhzJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHt9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPiA9IHYuPCU9bU5hbWUlPigpLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIC8vIHJldHVybiByZXQ7DQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7W2tdOiByZXRba119KSk7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1VwZGF0ZVNRTCclPihmaWVsZHMpew0KICAgICAgICBsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsNCiAgICAgICAgbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOw0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgcmV0dXJuIHNxbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvSW5zZXJ0U1FMJyU+KGZpZWxkcyl7DQogICAgICAgIGxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7DQogICAgICAgIGxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7DQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCjwlIH0gJT4NCiAgICANCiAgICA8JT1tTmFtZT0nX2NvcHlGcm9tJyU+KG9iail7DQogICAgICAgIGlmKCFvYmopIHJldHVybiBudWxsOw0KICAgICAgICByZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9PYmpUcmVlJyU+KGJDeWNsaWMpew0KICAgICAgICA8JT13YXJuKCklPiJkZXByZWNhdGVkIik7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICANCiAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCc8JT1jLk5hbWUlPicpLCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgQ3ljbGljOiBiQ3ljbGljLA0KICAgICAgICAgICAgLy9leHBvcnRlcjogdiA9PiA8JT13YXJuKCklPnYucmV1c2VkKSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4oPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKTwlfWVsc2V7JT52PCV9JT4pLA0KICAgIDwlIH0pOyU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9dGFOYW1lJT4obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKSksDQogICAgPCUgfSk7JT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J191bkN5Y2xlJyU+KHNvdXJjZT10aGlzKXsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQodGhpcywgew0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPihzb3VyY2U9PW9iai48JT1uTmFtZShlYSklPigpP251bGw6dW5kZWZpbmVkKSwNCiAgICA8JSB9KTslPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gdHJ1ZSwNCiAgICA8JSB9KTslPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3N0b3JlRW50aXR5Q2xhc3MnJT4oZGVwdGgpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZGVwdGgpPT09InVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7DQogICAgICAgICAgICBpZighZGVwdGgpIHJldHVybjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5Ub29sLjwlPW1OYW1lJT4gPSB0aGlzLlRvb2wuPCU9bU5hbWUlPiB8fCB7fTsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4pIHJldHVybjsNCiAgICAgICAgICAgIHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4gPSB0cnVlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsNCiAgICAgICAgICAgIA0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5EU0Nvbm5lY3QoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvQ3lUYWJsZShkZXB0aCk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbmVvNGooY3FsKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQWlyVGFibGUiKXslPg0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL2Jhc2VzJywgbnVsbCwge25hbWU6ICc8JT1zY29wZSU+Jywgd29ya3NwYWNlSWQ6IHRoaXMuVG9vbC5kYi53b3Jrc3BhY2VJZCwgdGFibGVzOiB0aGlzLl90b0FUVGFibGUoZGVwdGgpfSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyU+DQogICAgICAgICAgICAgICAgbGV0IHNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU1FMVGFibGUoe3JldXNlZDogM30pOyA8JS8qZGVwdGg6IGNoYWxsZW5nZSAtIHRvbyBsb3cgZG9lcyBub3QgY292ZXIgYWxsIHRhYmxlcywgdG9vIGhpZ2ggKG1heCBkZXB0aCkgcmVzdWx0cyBpbiBvdXQtb2YtbWVtb3J5IG9uIGJyb3dzZXIqLyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHNxbCk7DQogICAgPCUgfWVsc2UgaWYodD09IlNlcnZpY2VOb3ciKXslPg0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPnRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05UYWJsZSgpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7JT4NCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90b0VNU0NsYXNzKGRlcHRoKS5zdG9yZSgpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJCSVNlcnZlciIpeyU+DQogICAgICAgICAgICAgICAgLy8gb25seSBkbyB0aGlzIGlmIHRoZSBtb2R1bGUgaXMgbm90IGxvYWRlZCBmcm9tIA0KICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogew0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgQ29tcGFueTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb2RlOiB0aGlzLl9fY29uZmlnKCdjb21wYW55JywgJzwlPXNjb3BlJT4nKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICB9KSkuZm9yRWFjaChlYSA9PiAvKiB0cnllIF9lYVR5cGVzICovPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goc2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoc2VhLklkIT09ZWEuSWQgJiYgc2VhLk5hbWU9PWVhLk5hbWUgJiYgKHNlYS5FbnRpdHlDbGFzcy5JZD09ZWEuRW50aXR5Q2xhc3MuSWQgfHwgc2VhLkVudGl0eUNsYXNzLk5hbWU9PWVhLkVudGl0eUNsYXNzLk5hbWUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5JZCA9PSBlYS5JZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5FbnRpdHlDbGFzcy5JZCA9IGVhLkVudGl0eUNsYXNzLklkOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWU9PXNlYS5FbnRpdHlDbGFzcy5OYW1lKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoc2NlYSA9PiBzY2VhLk5hbWU9PWVhLk5hbWUpLklkID0gZWEuSWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KSk7DQogICAgPCUgfWVsc2UgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIGF3YWl0IHRoaXMuVG9vbC5kYi5jcmVhdGVDb2xsZWN0aW9uKDwlPV9uQ29kZSgpJT4sIHt2YWxpZGF0b3I6IHskanNvblNjaGVtYTogdGhpcy5fdG9KU09OU2NoZW1hKCl9fSk7DQogICAgPCUgfWVsc2UgaWYodD09IlJ4REIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgYXdhaXQgdGhpcy5Ub29sLmRiLmFkZENvbGxlY3Rpb25zKHtbPCU9X25Db2RlKCklPl06IHtzY2hlbWE6IHRoaXMuX3RvSlNPTlNjaGVtYSgpfX0pOw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbG9nJyU+KG9iaj10aGlzKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvYmopOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gb2JqLm1hcChvID0+IHRoaXMuX2xvZyhvKSk7DQogICAgICAgICAgICBpZihvYmouRW50aXR5Q2xhc3MpIG9iaiA9IG9iai5fdG9KU09OKHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nRFNDb25uZWN0JyU+KHRvb2w9dGhpcy5Ub29sKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPih0b29sKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0b29sKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbCBpcyBudWxsIiwgdGhpcy5Ub29scy5sZW5ndGgsIDwlPXNjb3BlJT4uVG9vbHMubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZighdG9vbC50eXBlKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbC50eXBlIGlzIG51bGwiLCB0b29sLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZih0b29sLmRiKSE9PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlRvb2wgYWxyZWFkeSBjb25uZWN0ZWQhIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgLyo8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50X3NldCAmJiAqLzwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLl9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKSl7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICB0b29sLl9fZG1sU3RhdGVtZW50cyA9IHRvb2wuX19kbWxTdGF0ZW1lbnRzIHx8IFtdOw0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJbPCU9dCU+XTogQ29ubmVjdGluZy4uLiIpOw0KDQogICAgICAgICAgICBpZih0b29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJFTVMiKXslPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNb25nb0RCIil7JT4NCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT50aGlzLl9fY29uZmlnKCd1cmknLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdjb25maWcnLCBudWxsLCB7dG9vbDogdG9vbH0pKTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YobW9uZ29kYikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSAoYXdhaXQgbmV3IG1vbmdvZGIuTW9uZ29DbGllbnQodGhpcy5fX2NvbmZpZygndXJpJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygnY29uZmlnJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkuY29ubmVjdCgpKS5kYih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSdSeERCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gYXdhaXQgUnhEQi5jcmVhdGVSeERhdGFiYXNlKHtuYW1lOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSwgc3RvcmFnZTogbnVsbH0pOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSdaYW5nb0RCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IHphbmdvLkRiKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pLCB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICA8JT1uTmFtZShlYyklPjogWyI8JT1lYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gbk5hbWUoZWEpKS5qb2luKCdcIiwgXCInKSU+Il0sDQogICAgICAgIDwlIH0pICU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgPCUgfWVsc2UgaWYodD09J0thZmthJyl7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yoa2Fma2FqcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcga2Fma2Fqcy5LYWZrYSh7DQogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRJZDogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYnJva2VyczogW3RoaXMuX19jb25maWcoJ2Jyb2tlcnMnLCBudWxsLCB7dG9vbDogdG9vbH0pXSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNzbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNhc2w6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdzYXNsX3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWNoYW5pc206IHRoaXMuX19jb25maWcoJ3Nhc2xfbWVjaGFuaXNtcycsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblRpbWVvdXQ6IDMwMDAsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB0b29sLnByb2R1Y2VyID0gdG9vbC5kYi5wcm9kdWNlcigpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLnByb2R1Y2VyLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIHRvb2wuY29uc3VtZXIgPSB0b29sLmRiLmNvbnN1bWVyKHtncm91cElkOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSl9KTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5jb25zdW1lci5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wuY29uc3VtZXIuc3Vic2NyaWJlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb21CZWdpbm5pbmc6IGZhbHNlLA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgICAgICAgICB0b29sLmNvbnN1bWVyLnJ1bih7ZWFjaE1lc3NhZ2U6IGFzeW5jICh7IHRvcGljLCBwYXJ0aXRpb24sIG1lc3NhZ2UgfSkgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KG1lc3NhZ2UudmFsdWUudG9TdHJpbmcoKSkucHJvY2VzcygpfSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSdNZW1vcnknKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICAnPCU9bk5hbWUoZWMpJT4nOiBbXSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgICAgICAgICAgfTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJFeGNlbCIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSA8JT1zY29wZSU+Lnhsc3hEYXRhP1hMU1gucmVhZCg8JT1zY29wZSU+Lnhsc3hEYXRhKTpYTFNYLnV0aWxzLmJvb2tfbmV3KCk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSBYTFNYLnJlYWQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnZmlsZW5hbWUnLCBudWxsLCB7dG9vbDogdG9vbH0pKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09IlNub3dGbGFrZSIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuc25vd2ZsYWtlKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbC5zbm93Zmxha2UuY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiB0aGlzLl9fY29uZmlnKCJhY2NvdW50IiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLl9fY29uZmlnKCJ1c2VybmFtZSIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygicGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb246IHRoaXMuX19jb25maWcoInNjb3BlIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiPCU9c2NvcGUlPiIsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdCgoZXJyLCBjb25uKT0+ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4nVW5hYmxlIHRvIGNvbm5lY3Q6ICcgKyBlcnIubWVzc2FnZSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlaihlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdGlvbl9JRCA9IGNvbm4uZ2V0SWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5lbzRqLmRyaXZlcigNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygndXJsJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgbmVvNGouYXV0aC5iYXNpYyh0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkNCiAgICAgICAgICAgICAgICApOw0KICAgIDwlfWVsc2UgaWYodD09IkFpclRhYmxlIil7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gew0KICAgICAgICAgICAgICAgICAgICBiYXNlSWQ6ICcnLA0KICAgICAgICAgICAgICAgICAgICB3b3Jrc3BhY2VJZDogdGhpcy5fX2NvbmZpZygnd29ya3NwYWNlSWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnLA0KICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS93aG9hbWknKSkuaWQsDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIGxldCBiYXNlcyA9IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS9iYXNlcycpKS5iYXNlczsNCiAgICAgICAgICAgICAgICBpZihiYXNlcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiLmJhc2VJZCA9IGJhc2VzLmZpbHRlcihiID0+IGIubmFtZT09JzwlPXNjb3BlJT4nKS5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYi5iYXNlSWQpIHRvb2wuZGIuYmFzZUlkID0gJ2FwcCcgKyB0aGlzLl91dWlkKCkuc3BsaXQoJy0nKS5zbGljZSgtMSlbMF07DQogICAgPCV9ZWxzZSBpZih0PT0iU3FsREIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXSl7DQogICAgICAgICAgICAgICAgICAgIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uRGF0YWJhc2Upew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHRvb2wpXS5EYXRhYmFzZSh0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIi4vPCU9c2NvcGUlPi5kYiIpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLmNyZWF0ZUNvbm5lY3Rpb24pew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdDogdGhpcy5fX2NvbmZpZygnc2VydmVyJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiB0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhYmFzZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICI8JT1zY29wZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLkNsaWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uQ2xpZW50KHtjb25uZWN0aW9uU3RyaW5nOiB0aGlzLl9fY29uZmlnKCdjb25uc3RyJywgbnVsbCwge3Rvb2w6IHRvb2x9KX0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5kYi5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoZ2xvYmFsKT09PSd1bmRlZmluZWQnICYmIHRoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pPT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAvLyBzcWxpdGUgaW4gYnJvd3Nlcg0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IFNRTC5EYXRhYmFzZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodG9vbC5zeXNfc2NvcGUpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyB0b29sLnN5c19zY29wZSA9IChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfYXBwIiwge3N5c19zY29wZTogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICJnbG9iYWwifSkpWzBdLnN5c19pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRvb2wuc3lzX3Byb3BlcnRpZXMpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyBsb2FkaW5nIHNvbWUgcGxhdGZvcm0gc3R1ZmYNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5zeXNfcHJvcGVydGllcyA9IHt9Ow0KICAgICAgICAgICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gT2JqZWN0LmtleXModG9vbC5zeXNfcHJvcGVydGllcykuZmlsdGVyKGsgPT4gIXRvb2wuc3lzX3Byb3BlcnRpZXNba10pLmpvaW4oJywnKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoY29uZGl0aW9uKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfcHJvcGVydGllcyIsIHtuYW1lOiAiSU4iK2NvbmRpdGlvbn0pKS5mb3JFYWNoKHIgPT4gdG9vbC5zeXNfcHJvcGVydGllc1tyLm5hbWVdID0gci52YWx1ZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgPCV9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCjwlIH0lPg0KICAgIH0NCiAgICAvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovDQogICAgDQogICAgPCU9bU5hbWU9J19tYXRjaGVzJyU+KHF1ZXJ5LCBvcHRpb25zKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIGlmKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSE9IjwlPW5OYW1lKGMpJT4iKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihtaWNyb2RpZmYpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGxldCB0SGFzaCA9IHRoaXMuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWV9LCAnPCU9bU5hbWUlPicpLl90aGlzOw0KICAgICAgICAgICAgICAgIGxldCBxSGFzaCA9IHF1ZXJ5Ll90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogb3B0aW9ucy5vbmx5VW5pcXVlfSwgJzwlPW1OYW1lJT4nKS5fdGhpczsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgZGlmZiA9IG1pY3JvZGlmZihxSGFzaCwgdEhhc2gpLmZpbHRlcihkID0+IGQudHlwZSE9J0NSRUFURScgJiYgWydPUEVSQVRPUlMnLCAnSWQnXS5pbmRleE9mKGQucGF0aFswXSk8MCk7DQogICAgICAgICAgICAgICAgLy88JT1sb2coKSU+J1t0L3FdJywgdEhhc2gsIHFIYXNoLCBkaWZmKTsNCiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gZGlmZi5maWx0ZXIoZCA9PiBkLnR5cGU9PSdDSEFOR0UnKS5yZWR1Y2UoKHYsIGQpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNvb3AgPSBxdWVyeVsnXycgKyBkLnBhdGhbMF0gKyAnX2Nvb3AnXSB8fCAodHlwZW9mKGQudmFsdWUpPT09J3N0cmluZyc/J0xJS0UnOic9Jyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBsZXQgb2xkVmFsdWUgPSB0eXBlb2YoZC5vbGRWYWx1ZSk9PT0nc3RyaW5nJz9kLm9sZFZhbHVlLnNwbGl0KCcvJykuc2xpY2UoLTEpWzBdOmQub2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ZC5wYXRoWzBdLCBkLm9sZFZhbHVlLCBkLnZhbHVlLCBjb29wLCBvbGRWYWx1ZSwgZCk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdMSUtFJzogcmV0dXJuIHYgJiYgKG9sZFZhbHVlPT09bnVsbCB8fCBkLnZhbHVlLmluZGV4T2Yob2xkVmFsdWUpPj0wKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz0nOiByZXR1cm4gdiAmJiAob2xkVmFsdWU9PT1udWxsIHx8ICFkLnZhbHVlIHx8IGQudmFsdWU9PW9sZFZhbHVlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyE9JzogcmV0dXJuIHYgJiYgZC52YWx1ZSE9b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc+PSc6IHJldHVybiB2ICYmIGQudmFsdWU+PW9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPD0nOiByZXR1cm4gdiAmJiBkLnZhbHVlPD1vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz4nOiByZXR1cm4gdiAmJiBkLnZhbHVlPm9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPCc6IHJldHVybiB2ICYmIGQudmFsdWU8b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LCB0cnVlKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+J1t0L3FdJywgcmV0LCBkaWZmKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIC8vRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAvL051bGw6IHRydWUsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQ9PXF1ZXJ5LklkLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj92LjwlPW1OYW1lJT4ocXVlcnk/cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTpudWxsKTp0cnVlOw0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj09cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgIXF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICAgICAgICApIG9iai48JT1uTmFtZShlYSklPiA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICghdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4ocXVlcnkuPCU9bk5hbWUoZWEpJT4oKSkpIHx8DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgICAgICAgICAgICkgb2JqLjwlPW5OYW1lKGVhKSU+ID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gcXVlcnkuPCU9dGFOYW1lJT4oKS5hbnkocSA9PiBfdi48JT1tTmFtZSU+KHEpKSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPm9NYXRjaCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWF0Y2hpbmcnJT4ocXVlcnkpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iRm9yIDwlPW5OYW1lKGVhKSU+Iik7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY/W3YuPCU9bU5hbWUlPihxdWVyeSk/djpudWxsXS5jb25jYXQodi48JT1tTmFtZSU+KHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSk6W107DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4ocXVlcnkpKS5mbGF0KCk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgPCU9bG9nKCklPiJtYXRjaGVzIiwgbWF0Y2hlcyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0hPXF1ZXJ5KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCByZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2RlUmVmZXJlbmNlJyU+KHJvb3Qpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcm9vdCkgcm9vdD10aGlzOw0KDQogICAgICAgICAgICBpZihyb290IT10aGlzICYmIHRoaXMuU2V0X09uKSB7DQogICAgICAgICAgICAgICAgbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOw0KICAgICAgICAgICAgICAgIGlmKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbXlNYXRjaGVzWzBdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHYuPCU9bU5hbWUlPihyb290KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJldCE9dikgdGhpcy48JT1uTmFtZShlYSklPihyZXQpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHRhLjwlPW1OYW1lJT4ocm9vdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXQhPXRhKSB0aGlzLjwlPXRhTmFtZSU+KClbaV0gPSByZXQ7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZnJvbURvY3VtZW50JyU+KG9iaiwgYlRvb2wpew0KICAgICAgICBpZighb2JqKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYob2JqLjwlPW1OYW1lJT4pIHJldHVybiBvYmo7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob2JqKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdvYmonKSU+KSBvYmogPSB0aGlzLl9hdG9iKG9iaik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBpZihvYmoubGVuZ3RoPDMzICYmICFvYmoubWF0Y2goL1xzL2cpKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnLCB7dG9vbDogb2JqLl9fdG9vbH0pXTogb2JqDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iaiA9IEpTT04ucGFyc2Uob2JqKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgSlNPTiBvciBVVUlEIiwgb2JqKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShvYmopKXsNCiAgICAgICAgICAgIHJldHVybiBvYmoubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KG8sIGJUb29sKSk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKG9iai5fX3Rvb2wpIHRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7DQogICAgICAgIA0KICAgICAgICBpZighT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB0eXBlb2Yob2JqW2tdKSE9PSd1bmRlZmluZWQnICYmIG9ialtrXSE9PW51bGwpLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkVtcHR5IG9iamVjdCBvciBvYmplY3Qgb2YgbnVsbHMiLCBvYmopOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQob2JqLCB7DQogICAgICAgICAgICBfbWFwOiBiVG9vbCwNCiAgICAgICAgICAgIGltcG9ydGVyOiB2ID0+IHYub2JqID0gKHYub2JqJiZ2Lm9iai5TZXRfQ291bnQ8dGhpcy5TZXRfQ291bnQpP3RoaXM6di5vYmosDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUz9vYmouT1BFUkFUT1JTLlRISVM6dW5kZWZpbmVkKSwNCiAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZihpZENvZGU9PSdJZCcpIGlkQ29kZSA9IHRoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTsNCiAgICAgICAgICAgICAgICBpZihvYmpbaWRDb2RlXSkgdGhpcy5JZCA9IG9ialtpZENvZGVdOw0KICAgICAgICAgICAgfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgIGlmKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHJlZiA9IG9ialtlYUNvZGVdOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihyZWYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIDwlIGlmKCFlYS5Jc0FycmF5KXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iUmVzdERCSU8iKSByZWYgPSByZWZbMF07DQogICAgICAgICAgICAgICAgaWYoIXJlZikgcmV0dXJuOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4oKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KHJlZiwgYlRvb2wpKTsNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IlNxbERCIil7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtb21lbnQpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gbmV3IERhdGUocmVmKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YocmVmKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlZi5pbmRleE9mKCdUJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJlZiA9IG5ldyBEYXRlKHJlZik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KCg8JT1fYjY0dGVzdCgncmVmJyklPik/dGhpcy5fYXRvYihyZWYpOihyZWYgfHwgJycpKTsNCiAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlKSA9PiBvYmpbZWFDb2RlXT90aGlzLjwlPXRhTmFtZSU+KG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oX3YsIGJUb29sKSksIG9iai5PUEVSQVRPUlM/b2JqLk9QRVJBVE9SU1tlYUNvZGVdOnVuZGVmaW5lZCwgdHJ1ZSk6dW5kZWZpbmVkLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQo8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgPCU9bU5hbWU9J190b1Byb3RvJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiA8JT1fbkNvZGUoKSU+LCBwcm90bzogYFxuXG5tZXNzYWdlICR7PCU9X25Db2RlKCklPn0ge2AsIGluZGV4OiAxfSwgew0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuYk1hcCwNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmo9KHYucmV1c2VkPjEpP3twcm90bzogYFxuXG4vLyByZXVzZWRbJHt2LnJldXNlZH1dOiAkezwlPV9uQ29kZSgpJT59XG5cbmB9OnYub2JqLA0KICAgICAgICAgICAgICAgIF9USElTOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdHJlcGVhdGVkICR7PCU9X25Db2RlKCklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtpZENvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGBcblx0YCArIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYFxuXHRgOw0KICAgICAgICA8JSBpZihlYS5SZXF1aXJlZCl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KSBvYmoucHJvdG8gKz0gJ3JlcXVpcmVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gJ3JlcGVhdGVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAic3RyaW5nIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImJvb2wiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQzMiI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzTG9uZyl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQ2NCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmxvdCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJmbG9hdCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImRvdWJsZSI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJzdHJpbmciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYCAke2VhQ29kZX0gPSAke29iai5pbmRleCsrfTtgOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdGAgKyBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bXWApICsgYFxuXHRyZXBlYXRlZCAkezwlPV9uQ29kZSh0YS5FbnRpdHlDbGFzcyklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtlZkNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX19jbG9zZTogb2JqID0+IG9iai5wcm90byArPSAnXG59XG5cbicsDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIG9wdGlvbnMsIHNQYXRoKS5wcm90bzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0ICYmICFzUGF0aCl7DQogICAgICAgICAgICAgICAgcmV0ID0gYHBhY2thZ2UgPCU9c2NvcGUlPjtcblxuc3ludGF4ID0gInByb3RvMyI7XG5cbmAgKyByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCV9JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9KU09OJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgc1BhdGggPSBzUGF0aCB8fCAiIjsNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIHJldC5fX2tleXMgPSBbXTsgLy8hIQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5iTWFwKXsNCiAgICAgICAgICAgICAgICByZXQuX19nZW5lcmF0ZWQgPSAnIicgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyAnIic7DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLm5hbWUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX190b29sID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fY2xhc3MgPSAnIjwlPW5OYW1lKGMpJT4iJzsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fdHlwZSA9ICciJys8JT1fbkNvZGUoKSU+KyciJzsNCiAgICAgICAgICAgICAgICAgICAgLy9yZXQuX19wYXRoID0gJyInK3NQYXRoKyciJzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX19ub2RlID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRyTWFwID0gKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgPT4gKHYgJiYgdHlwZW9mKHYpPT09J3N0cmluZycgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoLzw8W14+Pl0rPj4vZ20sIG0gPT4gew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190ck1hcCA9IDwlPXNjb3BlJT4uX190ck1hcCB8fCBbXTsNCg0KICAgICAgICAgICAgICAgIGxldCB0cmlkID0gdGhpcy5fdXVpZCgpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwUGF0aCA9ICcuJysoc1BhdGguc3BsaXQoJy4nKS5zbGljZSgxLCAtMSkuam9pbignLicpKTsNCiAgICAgICAgICAgICAgICBpZihwUGF0aD09Ii4iKSBwUGF0aCA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCB0ciA9IG0ucmVwbGFjZSgnPDwnLCAnJykucmVwbGFjZSgnPj4nLCAnJykucmVwbGFjZSgve3tucn19L2dtLCAnJG5vdCgkZXhpc3RzKF9fcmV1c2VkKSknKS5yZXBsYWNlKC97e3ZmfX0vZywgb2JqW2VhQ29kZV0pOw0KICAgICAgICAgICAgICAgIGlmKHRyLnN0YXJ0c1dpdGgoJ3MoJykgJiYgdHIuZW5kc1dpdGgoJyknKSl7DQogICAgICAgICAgICAgICAgICAgIHRyID0gdHIucmVwbGFjZSgve3tfX319L2dtLCAnb0pTT04nK3NQYXRoKS5yZXBsYWNlKC97e3BwYXRofX0vZ20sICdvSlNPTicrcFBhdGgpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICB0ciA9IHRyLnJlcGxhY2UoL3t7X199fS9nbSwgYCoqW0lkPSR7b2JqLklkfV1bMF1gKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyA8JT13YXJuKCklPmVhQ29kZSwgdHJpZCwgdHIpOw0KDQogICAgICAgICAgICAgICAgdHIgPSB0aGlzLl9idG9hKHRyKTsNCiAgICAgICAgICAgICAgICBsZXQgbWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwLmZpbmQobyA9PiBvLnRyYW5zZm9ybT09dHIpOw0KICAgICAgICAgICAgICAgIHJldHVybiAobWFwP21hcC5pZDo8JT1zY29wZSU+Ll9fdHJNYXBbPCU9c2NvcGUlPi5fX3RyTWFwLnB1c2goe2lkOiB0cmlkLCB0cmFuc2Zvcm06IHRyfSktMV0uaWQpOw0KICAgICAgICAgICAgfSk6djsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLmJNYXAsDQogICAgICAgICAgICAgICAgRnVsbDogb3B0aW9ucy5iRnVsbCwNCiAgICAgICAgICAgICAgICBOdWxsOiBvcHRpb25zLmJOdWxsLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2Lm9iaiAmJiB0eXBlb2Yodi5vYmouX3JldHVybik9PT0nc3RyaW5nJyAmJiB2Lm9iai5fcmV0dXJuLmluZGV4T2YoJ19fcmV1c2VkOiAxJyk+MCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IG9IYXNoID0gb3B0aW9ucy5iSGFzaD9bdGhpcy5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vQXJnczogdHJ1ZSwgX21hcDogb3B0aW9ucy5iTWFwLCBub1R5cGVzOiBmYWxzZX0sICI8JT1tTmFtZSU+IildOk9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gaz09J0lkJyB8fCBrLmluZGV4T2YoJ19fJyk9PTApLm1hcChrID0+IHt0cnl7cmV0dXJuIHsgW2tdOiBKU09OLnBhcnNlKHJldFtrXSkgfTsgfWNhdGNoKGV4KXtyZXR1cm4ge1trXTogcmV0W2tdfTsgfSB9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGVSZXQgPSBPYmplY3QuYXNzaWduKC4uLm9IYXNoLCB7X19yZXVzZWQ6IHYucmV1c2VkfSApOw0KICAgICAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGVSZXQuX19rZXlzKSkgZVJldC5fX2tleXMuZm9yRWFjaChlayA9PiB7dHJ5eyBlUmV0W2VrXSA9IEpTT04ucGFyc2UocmV0W2VrXSk7fWNhdGNoKGV4KXtlUmV0W2VrXSA9IHJldFtla107IH0gfSk7DQoNCiAgICAgICAgICAgICAgICAgICAgdi5vYmogPSB7X3JldHVybjogSlNPTi5zdHJpbmdpZnkoZVJldCl9Ow0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgX1RISVM6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmJNYXApIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCkpOw0KICAgICAgICAgICAgICAgICAgICBvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gYCIke3Z9ImAsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgICAgICBpZihvYmouX19rZXlzKSBvYmouX19rZXlzLnB1c2goZWFDb2RlKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKCE8JT1fYjY0dGVzdCgndicpJT4peyAvLyBpcyBub3QgYmFzZTY0Pw0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuX2J0b2Eodik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICB2ID0gdiYmdi50b0lTT1N0cmluZz92LnRvSVNPU3RyaW5nKCk6djsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY/di48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKTonbnVsbCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCB8fCBlYS5Jc0ludCB8fCBlYS5Jc0xvbmcgfHwgZWEuSXNGbG9hdCB8fCBlYS5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpIHx8ICdudWxsJzsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSAnIicgKyB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9ICdbJyArICh2IHx8IFtdKS5tYXAoKF92LCBfaSkgPT4gX3YuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9WyR7X2l9XWApKS5maWx0ZXIoX3YgPT4gX3YpLmpvaW4oKSArICddJywNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodikpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSBKU09OLnN0cmluZ2lmeSh2KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdHJNYXAob2JqLCBlZkNvZGUsIHYsIHNQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSd1bmRlZmluZWQnKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWYpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBpZighPCU9X2I2NHRlc3QoJ3YnKSU+KXsgLy8gaXMgbm90IGJhc2U2ND8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gdGhpcy5fYnRvYSh2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWYuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYmJnYudG9JU09TdHJpbmc/di50b0lTT1N0cmluZygpOnY7DQogICAgICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9IHY7DQogICAgICAgIDwlIGlmKCFlZi5Jc0Jvb2wgJiYgIWVmLklzSW50ICYmICFlZi5Jc0xvbmcgJiYgIWVmLklzRmxvYXQgJiYgIWVmLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSAnIicgKyBvYmpbZWZDb2RlXSArICciJzsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCg0KICAgICAgICAgICAgICAgIF9fdHJNYXA6IG9iaiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCFzUGF0aCl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouX190ck1hcCA9IDwlPXNjb3BlJT4uX190ck1hcCB8fCBbXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSA8JT1zY29wZSU+Ll9fdHJNYXA7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAgICAgX3JldHVybjogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYob2JqKSBvYmouX3JldHVybiA9IChPYmplY3Qua2V5cyhvYmp8fHt9KS5sZW5ndGgpPygneycgKyBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHR5cGVvZihvYmpba10pPT09InN0cmluZyIpLm1hcChrID0+IGAiJHtrfSI6ICR7b2JqW2tdfWApLmNvbmNhdChPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHR5cGVvZihvYmpba10pIT09InN0cmluZyIpLm1hcChrID0+IGAiJHtrfSI6ICR7SlNPTi5zdHJpbmdpZnkob2JqW2tdKX1gKSkuam9pbigpICsgJ30nKTonbnVsbCc7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iiwgb3B0aW9ucywgc1BhdGgpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSByZXQ/cmV0Ll9yZXR1cm46cmV0Ow0KICAgICAgICAgICAgcmV0ID0gdHlwZW9mKHJldCk9PT0ndW5kZWZpbmVkJz9udWxsOnJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIXNQYXRoICYmIHJldCl7DQogICAgICAgICAgICAgICAgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCAnamF2YXNjcmlwdCcpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHJldCk7DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5nemlwKSByZXR1cm4gdGhpcy5VdGY4QXJyYXlUb1N0cih0aGlzLl9jb21wcmVzcyhyZXQpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfdG9Eb2N1bWVudCclPihvcHRpb25zPXt9KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IGpzb24gPSB0aGlzLl90b0pTT04ob3B0aW9ucyk7DQogICAgICAgICAgICBsZXQgb0pTT04gPSBKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICAgICAgbGV0IHRyTWFwID0gb0pTT04uX190ck1hcCB8fCBbXTsNCiAgICAgICAgICAgIGRlbGV0ZSBvSlNPTi5fX3RyTWFwOw0KICAgICAgICAgICAganNvbiA9IEpTT04uc3RyaW5naWZ5KG9KU09OKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Li4ucyk7DQogICAgICAgICAgICBsZXQgd2FybiA9ICguLi5zKSA9PiA8JT13YXJuKCklPi4uLnMpOw0KICAgICAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPi4uLnMpOw0KDQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHQgb2YgdHJNYXApew0KICAgICAgICAgICAgICAgIGlmKCFuZXcgUmVnRXhwKHQuaWQpLnRlc3QoanNvbikpIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCB0cm4gPSB0aGlzLl9hdG9iKHQudHJhbnNmb3JtKTsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIG9KU09OID0gSlNPTi5wYXJzZShqc29uKTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJlcyA9IHVuZGVmaW5lZDsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHRybi5zdGFydHNXaXRoKCJzKCIpICYmIHRybi5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IHRoaXMucnVuU2NyaXB0KGAob0pTT04sIG9TY29wZSwgbG9nLCB3YXJuLCBlcnJvcikgPT4gJHt0cm4uc3Vic3RyaW5nKDIsIHRybi5sZW5ndGgtMSl9YCkob0pTT04sIDwlPXNjb3BlJT4sIGxvZywgd2FybiwgZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vcmVzID0gYXdhaXQganNvbmF0YSh0cm4pLmV2YWx1YXRlKG9KU09OKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgLy88JT13YXJuKCklPnQuaWQsIHJlcywgdHJuKTsNCiAgICAgICAgICAgICAgICAgICAganNvbiA9IGpzb24ucmVwbGFjZShuZXcgUmVnRXhwKHQuaWQsICJnIiksICghQXJyYXkuaXNBcnJheShyZXMpICYmIHR5cGVvZihyZXMpIT09J29iamVjdCcpP3Jlczp0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJlcykpKTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPnQuaWQsIHRybiwgZXgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8ganNvbiA9IGpzb24ucmVwbGFjZSgvIl9fdHJNYXAiOlxzXFtce1tePj5dK1x9XF0vZ20sICciX190ck1hcCI6ICIiJyk7DQoNCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmJKU09OP3RoaXMuX2JlYXV0aWZ5KGpzb24sICdqYXZhc2NyaXB0Jyk6SlNPTi5wYXJzZShqc29uKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KPCUNCl9jbG9uZUZ1bmN0aW9uID0gKG8sIGYsIHNjb3BlLCBjKSA9PiB7DQoNCiAgICBsZXQgb2JqID0gbnVsbDsNCiAgICBpZihvPT0nc3InICYmIHR5cGVvZihzcikhPT0ndW5kZWZpbmVkJykgb2JqID0gc3I7DQogICAgaWYobz09J19GckVNRCcgJiYgdHlwZW9mKF9GckVNRCkhPT0ndW5kZWZpbmVkJykgb2JqID0gX0ZyRU1EOw0KICAgIA0KICAgIGxldCBjb2RlID0gb2JqW2ZdID8gb2JqW2ZdLnRvU3RyaW5nKCkgOiBgICAgJHtmfSgpew0KICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgaW4gX2Nsb25lRnVuY3Rpb24oJHtvfSwgJHtmfSk6IEludmFsaWQgRnVuY3Rpb24gTmFtZScpOw0KICAgIH1gOw0KICAgIGxldCBzID0gY29kZS5yZXBsYWNlKCcpJywgJykgPT4gJyk7DQogICAgaWYgKHMuaW5kZXhPZignZnVuY3Rpb24nKSA9PSAwIHx8IHMuaW5kZXhPZignYXN5bmMgZnVuY3Rpb24nKSA9PSAwKSB7DQogICAgCXMgPSBzLnJlcGxhY2UoJ2Z1bmN0aW9uJywgJyAnKTsNCiAgICB9IGVsc2Ugew0KICAgIAlzID0gcy5yZXBsYWNlKGYsICcnKTsNCiAgICB9DQoNCiAgICBpZiAoYy5Jc01haW4gJiYgIW9ialtmXSkgew0KICAgIAljb25zb2xlLmxvZygnRXJyb3IgaW4gX2Nsb25lRnVuY3Rpb24oKTogSW52YWxpZCBGdW5jdGlvbiBOYW1lICcgKyBmKTsNCiAgICB9DQoNCiAgICByZXR1cm4gYA0KICAgICR7Zn0oLi4ucGFyYW1zKXsNCiAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LiR7b30pIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy4ke299LiR7Zn0oLi4ucGFyYW1zKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBgICsgKGMuSXNNYWluID8gYHJldHVybiAoJHtzfSkoLi4ucGFyYW1zKTtgIDogYHJldHVybiBuZXcgJHtzY29wZX0uJHtuTmFtZShtYWluQ2xhc3MoKSl9KCkuJHtmfSguLi5wYXJhbXMpO2ApICsgYA0KICAgICAgICB9DQoJfQ0KICAgIGA7DQp9Ow0KDQoNClt7DQogICAgd09iajogJ3NyJywNCiAgICBmdW5jdGlvbnM6IFsnaGFzaENvZGUnLCAnRXF1YWxzJywgJ3NlcnZlckRhdGUnLCAnX19zY29wZScsICdhZGRNU2Vjb25kcycsICdpcEFkZHJlc3MnXS5jb25jYXQobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSk/WydfJywgJ2J1aWxkVVJMJywgJyRfUkVRVUVTVCcsICdwYXJhbScsICdfdG9YTUwnLCAnY29vcCcsICdPUicsICdteVJlcGxhY2UnLCAnc2VuZFhNTCcsICdwcm9jZXNzUmVzcG9uc2UnLCAncHJvY2Vzc1Jlc3VsdCcsICdydW5TUlNjcmlwdCcsICdncm91cEJ5JywgJ1Nob3dEZWJ1ZycsICdjYWNoZVJlc3VsdCcsICd0b0hleCcsICdTaG93RXJyb3InXTpbXSksDQp9LCB7DQogICAgd09iajogJ19GckVNRCcsDQogICAgZnVuY3Rpb25zOiBbJ19hdHRyJywgJ3J1blNjcmlwdCcsICdfdW5pcXVlJywgJ3NyJywgJ19hdG9iJywgJ19nZXRTdG9yZWRTY3JpcHQnLCAnX2J0b2EnLCAnX190aW1lJywgJ193YWl0JywgJ19zcWxUeXBlJywgJ191dWlkJywgJ3JlcXVpcmUnLCAnX2luY2x1ZGUnLCAnX2JlYXV0aWZ5JywgJ19pbmplY3QnLCAnX2NvbXByZXNzJywgJ19kZWNvbXByZXNzJywgJ1V0ZjhBcnJheVRvU3RyJywgJ3JhbmRVUkwnXSwNCn1dLmZvckVhY2goY2MgPT4geyAlPg0KLyogU1RBUlQ6IDwlPWNjLndPYmolPiBmdW5jdGlvbiBjb3BpZXMgKi8NCjwlIGNjLmZ1bmN0aW9ucy5mb3JFYWNoKGYgPT4geyU+DQoNCi8qIENMT05FOjpTVEFSVDogPCU9Y2Mud09iaiU+LjwlPWYlPigpICovPCU9X2Nsb25lRnVuY3Rpb24oY2Mud09iaiwgZiwgc2NvcGUsIGMpICU+LyogQ0xPTkU6OkVORCAgOiA8JT1jYy53T2JqJT4uPCU9ZiU+KCkgKi8NCjwlIH0pJT4NCi8qIEVORDogPCU9Y2Mud09iaiU+IGZ1bmN0aW9uIGNvcGllcyAqLw0KPCUgfSk7ICU+DQogICAgDQogICAgPCU9bU5hbWU9J2kxOG4nJT4oZXYsIHYpew0KICAgICAgICBpZih0eXBlb2Yod2luZG93KT09PSJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSk9PT0idW5kZWZpbmVkIikgcmV0dXJuIHY7DQogICAgICAgIA0KICAgICAgICBpZighZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKXsNCiAgICAgICAgICAgIHJldHVybiB2Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7DQogICAgICAgIH0NCiAgICB9DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW1OYW1lPSdieScgKyBuTmFtZShlYS5FbnRpdHlUeXBlKSU+KGFyKSB7DQogICAgICAgIHZhciByZXQgPSBbXTsNCiAgICAgICAgYXIuZm9yRWFjaChhID0+IHsNCiAgICAgICAgICAgIHJldC5mb3JFYWNoKHIgPT4gew0KICAgICAgICAgICAgICAgIGlmIChhWyJfPCU9bk5hbWUoZWEpJT4iXSAmJiAoYVsiXzwlPW5OYW1lKGVhKSU+Il0uRXF1YWxzP2FbIl88JT1uTmFtZShlYSklPiJdLkVxdWFscyhyKTpzci5FcXVhbHMoYVsiXzwlPW5OYW1lKGVhKSU+Il0sIHIpKSkgew0KICAgICAgICAgICAgICAgICAgICByLl88JT1uTmFtZShlYSklPl88JT1jLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyklPi5wdXNoKGEpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9KSU+DQoNCiAgICA8JT1tTmFtZT0nRW50aXR5VmFsdWUnJT4oYU5hbWUpIHsNCiAgICAgICAgbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7DQogICAgICAgIA0KICAgICAgICBpZighcmV0KXsNCiAgICAgICAgICAgIC8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlDQogICAgICAgICAgICByZXQgPSB7QWN0aXZlOiB0cnVlLCBPUEVSQVRPUlM6IHt9LCBFbnRpdHlBdHRyaWJ1dGU6IHtOYW1lOiBhTmFtZSwgQWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczoge0lkOiB0aGlzLkVudGl0eUNsYXNzLklkfX19Ow0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfX2Fzc2VydFZhbGlkJyU+KGJTeW5jKXsNCjwlIGlmKCFjLlRvb2xzLmxlbmd0aCl7JT4NCiAgICAgICAgcmV0dXJuIHRydWU7DQo8JSB9ZWxzZXslPg0KICAgICAgICBsZXQgZXJyb3IgPSB7fTsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KXsNCiAgICAgICAgICAgIGVycm9yLjwlPW5OYW1lKGVhKSU+ID0ge307DQogICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBlcnJvci48JT1uTmFtZShlYSklPlsiMDEiXSA9ICJOb3QgU2V0IjsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKCF0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIGVycm9yLjwlPW5OYW1lKGVhKSU+WyIwMiJdID0gIkVtcHR5IFZhbHVlIjsNCiAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiBiU3luYyAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLl9fc3luY19vbigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDMiXSA9ICJOb3QgaW4gU3luYyI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKGVycm9yLjwlPW5OYW1lKGVhKSU+KS5sZW5ndGgpIGRlbGV0ZSBlcnJvci48JT1uTmFtZShlYSklPjsNCiAgICAgICAgfQ0KICAgIDwlIH0pJT4NCg0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKXsNCiAgICAgICAgICAgIHRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOw0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXJyb3IsbnVsbCw0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfcmFuayclPihfPCU9bU5hbWUlPj0wKXsNCgkJdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHtfPCU9bU5hbWUlPjogXzwlPW1OYW1lJT59LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2LnJldXNlZD92Lm9iai5fX3JldXNlZCA9IHYucmV1c2VkOjAsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSAiPCU9X2NOYW1lKGMsIHRydWUpJT4iLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5fPCU9bU5hbWUlPiArPSAob2JqW2VhQ29kZV0gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKS5fPCU9bU5hbWUlPiwNCgk8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIHRhQ29kZSwgdikgPT4gKG9ialt0YUNvZGVdID0gW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlUeXBlLCB0cnVlKSU+KCldLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKSkuZm9yRWFjaCh2ID0+IHYuXzwlPW1OYW1lJT4pLA0KICAgIDwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCgl9DQoNCiAgICA8JT1tTmFtZT0nX2lzUXVlcnknJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoLypfX3R5cGUqL3tJZDogIjwlPW5OYW1lKGMpJT4iLCA8JT1tTmFtZSU+Q291bnQ6IDB9LCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgdW5kZWZpbmVkfTsNCiAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IHR5cGVvZihvYmpbZWFDb2RlXS5fY29vcCk9PT0idW5kZWZpbmVkIj8wOjE7DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LjwlPW1OYW1lJT4pew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXS5fb2JqZWN0ID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1tTmFtZSU+Q291bnQgKz0gb2JqW2VhQ29kZV0uX29iamVjdC48JT1tTmFtZSU+Q291bnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmpbdGFDb2RlXSA9IHtfY29vcDogdGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCB1bmRlZmluZWQsIF9vYmplY3RzOiAodnx8W10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpfTsNCiAgICAgICAgICAgICAgICBpZihvYmpbdGFDb2RlXS5fb2JqZWN0cy5sZW5ndGgpIG9ialt0YUNvZGVdLjwlPW1OYW1lJT5Db3VudCArPSBvYmpbdGFDb2RlXS5fb2JqZWN0cy5yZWR1Y2UoKHYsIG8pID0+IHYgKz0gby48JT1tTmFtZSU+Q291bnQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX25ldyclPihjbE5hbWUsIHRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsTmFtZSwgdG9vbCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzd2l0Y2goY2xOYW1lKXsNCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uTmFtZShfYyklPiI6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoX2MsIHRydWUpJT4odW5kZWZpbmVkLCB0b29sKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nc3RvcmUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAvKioqIFNUQVJUIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgICAgICANCiAgICAgICAgbGV0IGJVcGRhdGUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGJJbnNlcnQgPSBmYWxzZTsNCg0KICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+InN0b3JpbmcgZGlzYWJsZWQiKTsNCiAgICAgICAgfWVsc2UgaWYoZmFsc2UgJiYgdGhpcy5faXNRdWVyeSgpLl9pc1F1ZXJ5Q291bnQpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHN0b3JlIGEgcXVlcnkhIik7DQogICAgICAgIH1lbHNlIGlmKCF0aGlzLl9fc3luY19vbigpIHx8IDwlPV9GckVNRC5fdG9KUyhfZmlsZVRvb2xzKSU+LmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk+PTApew0KICAgICAgICAgICAgbGV0IF90aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYkZpbmQgPSBmYWxzZTsNCiAgICAgICAgICAgIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgIGJGaW5kID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBfdGhpcy5JZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICB9DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KXsNCiAgICAgICAgICAgICAgICBiRmluZCA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuPCU9bk5hbWUoZWEpJT4odGhpcy48JT1uTmFtZShlYSklPigpLCAnPScpOw0KICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGlmKGJGaW5kKXsNCiAgICAgICAgICAgICAgICBfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsNCiAgICAgICAgICAgIH1lbHNlIF90aGlzID0gbnVsbDsNCiAgICAgICAgICAgIGlmKF90aGlzKXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gX3RoaXMuSWQ7DQogICAgICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24oX3RoaXMuX19zeW5jX29uKCkpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7DQogICAgICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUNCiAgICAgICAgICAgICAgICBiSW5zZXJ0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsiPCIrdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICBpZighYlVwZGF0ZSAmJiAhYkluc2VydCl7DQogICAgICAgICAgICA8JT1sb2coKSU+Ik5vIGRhdGEgY2hhbmdlcyIpOw0KICAgICAgICB9ZWxzZXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uKT09PSJ1bmRlZmluZWQiIHx8IDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiA9IHtPd25lcjogdGhpcywgc3FsczogW10sIHN0YXJ0OiBuZXcgRGF0ZSgpLCBlbmQ6IG51bGx9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIShhd2FpdCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPigpKSkgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YD09PT4gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIGlmKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7DQogICAgICAgICAgICBpZihiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmA8PT09IEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSl7DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU3luY2luZy4uLjwlPXRhTmFtZSU+IiwgdGEpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0YS48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGJVcGRhdGUgfHwgYkluc2VydCl7DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLk93bmVyPT10aGlzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdpbnNlcnQnJT4oKXsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLlRvb2wuZGIuZ2V0Q29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikuaW5zZXJ0T25lKHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS5pbnNlcnRPbmUoJHt0aGlzLl90b0pTT04oe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uPCU9bU5hbWUlPih0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJLYWZrYSIpIHslPg0KICAgICAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJyk7DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5wdXNoKHRoaXMpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJOZW80aiIpIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2FsZXNGb3JjZSIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+LklkOw0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgICAgIGxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7DQogICAgDQogICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIjwlPW5OYW1lKGMpJT4iKS5jcmVhdGUob2JqKTsNCiAgICAgICAgICAgIHRoaXMuSWQgPSByZXMuaWQ7DQogICAgPCUgfSBlbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKSB7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlNlcnZpY2VOb3ciKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIGF3YWl0IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKSk7DQogICAgPCUgfSBlbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuSWQgPSAoYXdhaXQgdGhpcy5fdG9FTVNPYmplY3QoKS5zdG9yZSgpKS5JZDsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIGxldCBvYmogPSB7fTsNCiAgICAgICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQvKl9pZCgpKi87DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5Db2RlKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgbG9nKCI8JT10JT4gVVJMIiwgdXJsKTsNCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbG9nKCJyZXN1bHQiLCByZXMuZGF0YSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmVzLmRhdGEpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCBpbnNPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0SW5zZXJ0IiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCBudWxsLCAyKTsNCiAgICAgICAgICAgIGlmKCFpbnNPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5JZCA9IGluc09iai5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gaW5zT2JqLkVudGl0eVZhbHVlczsNCiAgICAgICAgICAgIHRoaXMuX3JldmVydCgpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSAlPg0KDQogICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSd1cGRhdGUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KDQogICAgPCUgaWYodCA9PSAiTW9uZ29EQiIpIHslPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLnVwZGF0ZU9uZSh7X2lkOiB0aGlzLklkfSwgeyRzZXQ6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pOw0KICAgICAgICAgICAgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGBkYi5nZXRDb2xsZWN0aW9uKCckezwlPV9uQ29kZSgpJT59JykudXBkYXRlT25lKHtfaWQ6ICcke3JldC5faWR9J30sIHskc2V0OiAke3RoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPlt0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5maW5kSW5kZXgobyA9PiBvLklkPT10aGlzLklkKV0gPSB0aGlzOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5wcm9kdWNlci5zZW5kKHsNCiAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7DQogICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KQ0KICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nY2FsbDogJyArIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ncmVzcG9uc2U6ICcsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5TWVyZ2UoKSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOw0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07DQogICAgPCUgfWVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksICdwdXQnKSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TT2JqZWN0KCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZW5kaW5nIHVwZGF0ZSB0byBSRVNUREJJTyB0byBzYXZlIik7DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICIvIiArIHRoaXMuSWQ7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+IlVwZGF0ZSB0byBSRVNUREJJTyIsIHVybCk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MucHV0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IHVwZE9iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RVcGRhdGUiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIDIpOw0KICAgICAgICAgICAgaWYoIXVwZE9iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb3B5RnJvbSh1cGRPYmopOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOw0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KDQogICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kJyU+KGRlcHRoID0gMSwgb2JqcywgZmllbGRzKSB7DQogICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoLCBvYmpzLCBudWxsLCBudWxsLCBmaWVsZHMpKVswXTsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nZmluZEFsbCclPihkZXB0aCA9IDEsIG9ianM9W10sIHN0YXJ0LCBlbmQsIGZpZWxkcykgew0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bU5hbWUlPiIsIDwlbVJvdXRpbmcoYyklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5DQoNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJNb25nb0RCIil7ICU+DQogICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5kYi5jb2xsZWN0aW9uKDwlPV9uQ29kZShjKSU+KS5maW5kKHRoaXMuX3RvU2VsZWN0TW9uZ29EQihmaWVsZHMsIG9ianMpKS50b0FycmF5KCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uZmluZCh0aGlzLl90b1NlbGVjdFJ4REIoZmllbGRzLCBvYmpzKSkuZXhlYygpOw0KICAgIDwlIH1lbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKXsgJT4NCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7ICU+DQogICAgICAgICAgICBsZXQgbyA9IHRoaXMuX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgbyA9IG5ldyA8JT1zY29wZSU+LkVudGl0eU9iamVjdCgpLlRISVMoW29dLmNvbmNhdChvYmpzLm1hcChfbyA9PiBfby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkpKSk7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eU9iamVjdChvKS48JT1tTmFtZSU+KCkpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iTWVtb3J5Iil7ICU+DQogICAgICAgICAgICByZXR1cm4gdGhpcy5Ub29sLmRiWzwlPV9uQ29kZSgpJT5dLmZpbHRlcihvID0+IG8gJiYgdGhpcy5fc2FtZUVudGl0eShvKSk7DQogICAgPCUgfWVsc2UgaWYodD09Ikh1YlNwb3QiKXsgJT4NCiAgICA8JSB9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwge3N5c3Bhcm1fcXVlcnk6IHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMsIHRydWUpfSkpLnJlc3VsdDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iU2FsZXNGb3JjZSIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwge3VybDogJ3Jlc3QudXJsLmdxbCd9KTsNCiAgICA8JSB9ZWxzZSBpZihfZmlsZVRvb2xzLmluZGV4T2YodCk+LTEpeyAlPg0KICAgICAgICAgICAgbGV0IGROYW1lID0gdGhpcy5fdG9GaWxlTmFtZSgpLnNwbGl0KCcvJykuc2xpY2UoMCwgLTEpLmpvaW4oJy8nKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGRMaXN0ID0gYXdhaXQgdGhpcy5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oZE5hbWUpOw0KDQogICAgICAgICAgICA8JT1sb2coKSU+ImROYW1lIiwgZE5hbWUsIHRoaXMuX3RvRmlsZU5hbWUoKSwgImRMaXN0IiwgZExpc3QpOw0KICAgICAgICAgICAgbGV0IGlkeExpc3QgPSAoZExpc3QgfHwgW10pLmZpbHRlcihyID0+IHR5cGVvZihyLm5hbWUpIT09J3VuZGVmaW5lZCcpLm1hcChyID0+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21GaWxlTmFtZShyLm5hbWUpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iaWR4TGlzdCIsIGlkeExpc3QsIGlkeExpc3QubWFwKHIgPT4gci5fdG9GaWxlTmFtZSgpKSk7DQogICAgICAgICAgICBpZHhMaXN0ID0gaWR4TGlzdC5maWx0ZXIociA9PiByLl9tYXRjaGVzKHRoaXMsIHtvbmx5VW5pcXVlOiB0cnVlfSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJpZHhMaXN0IGZpbHRlcmVkIiwgaWR4TGlzdCk7IA0KDQogICAgICAgICAgICBpZihpZHhMaXN0Lmxlbmd0aD09MSl7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgdGhpcy5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oZE5hbWUgKyAnLycgKyBpZHhMaXN0WzBdLl90b0ZpbGVOYW1lKCkuc3BsaXQoJy8nKS5zbGljZSgtMSkuam9pbignLycpKSk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZXQgPSBpZHhMaXN0Ow0KICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSJOZW80aiIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fbmVvNGoodGhpcy5fdG9DeVF1ZXJ5KGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJSZXN0REJJTyIpeyAlPg0KICAgICAgICAgICAgbGV0IHRoaXNEb2MgPSB0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICBsZXQgZWFDb2RlID0gIiI7DQogICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgZWFDb2RlID0gPCU9X25Db2RlKGVhKSU+Ow0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNBcnJheSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IiE9Iil7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJG5pbiI6IHRoaXNEb2NbZWFDb2RlXX07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJGluIjogdGhpc0RvY1tlYUNvZGVdfTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyAlPg0KICAgICAgICAgICAgICAgIGlmKFtudWxsLCAnJScsICdMSUtFJ10uaW5kZXhPZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT4tMSl7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJHJlZ2V4IjogdGhpc0RvY1tlYUNvZGVdIHx8ICIuKiJ9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICI/cT0iICsgSlNPTi5zdHJpbmdpZnkoY29uZGl0aW9ucyk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MuZ2V0KHVybCwgew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgImNhY2hlLWNvbnRyb2wiOiAibm8tY2FjaGUiLA0KICAgICAgICAgICAgICAgICAgICAieC1hcGlrZXkiOiB0aGlzLl9fY29uZmlnKCdhcGlrZXknKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSkuZGF0YTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQklTZXJ2ZXIiKXsgJT4NCiAgICAgICAgICAgIGxldCBxID0gew0KICAgICAgICAgICAgICAgIFRISVM6IHRoaXMuX2J1aWxkVGhpcyhkZXB0aCkuY29uY2F0KChvYmpzIHx8IFtdKS5tYXAob2JqID0+IG9iai50b0VudGl0eU9iamVjdD97DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgICAgICAgICAgfTpvYmopKSwNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7IC8vIGFic29sdXRlbHkgcmVxdWlyZWQgZm9yIGluZGV4aW5nDQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgPCU9bG9nKCklPnEpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FzT2JqZWN0cygoYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZGFsbCIsIG51bGwsIHEpKSk7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgPCU9bG9nKCklPiJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgZGVwdGgsIHJldCk7DQogICAgICAgIA0KICAgICAgICBpZighQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSBbcmV0XTsNCiAgICAgICAgcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHIsIHRydWUpKS5maWx0ZXIociA9PiByKS5tYXAociA9PiByLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7DQoNCiAgICAgICAgaWYoZGVwdGg+MSl7DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2YgcmV0KXsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHIuXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9bk5hbWUoZWEpJT4iLCByLjwlPW5OYW1lKGVhKSU+KCkuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9bk5hbWUoZWEpJT4oYXdhaXQgci5fPCU9bk5hbWUoZWEpJT4uZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgICAgIDwlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT49MCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGxldCByXzwlPXRhTmFtZSU+ID0gW107DQogICAgICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgX3RhIG9mIHIuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IjwlPXRhTmFtZSU+IiwgX3RhKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJfPCU9dGFOYW1lJT4ucHVzaChhd2FpdCBfdGEuZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgci5jbGVhcl88JT10YU5hbWUlPigpOw0KICAgICAgICAgICAgICAgICAgICByLjwlPXRhTmFtZSU+KHJfPCU9dGFOYW1lJT4pOw0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT10YU5hbWUlPiIsIHIuPCU9dGFOYW1lJT4oKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9dGFOYW1lJT4oYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bk5hbWUodGEpJT4ocikNCiAgICAgICAgICAgIDwlIGlmKGZhbHNlICYmIFsnU3FsREInXS5pbmRleE9mKHQpPj0wKXsgLy8gc3FsIHN0YXRlbWVudHMgZG8gbm90IGluY2x1ZGUgbGVmdCBqb2lucyB3aXRob3V0IGV4cGxpY2l0IHJlZmVyZW5jZXMgJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwldGEuRW50aXR5Q2xhc3MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhIT10YSkuZm9yRWFjaChlYSA9PiB7JT4uPCU9bk5hbWUoZWEpJT4obmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKTwlfSklPg0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgICAgICAuPCU9bU5hbWUlPihkZXB0aC0xKSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgcmVmcyA9IHJldC5maWx0ZXIociA9PiByLkVudGl0eUNsYXNzKTsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBvIG9mIChvYmpzIHx8IFtdKS5maWx0ZXIoX28gPT4gIV9vLl9fc3luY19vbigpKSl7DQogICAgICAgICAgICBpZihvLl90b0VNU09iamVjdCl7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG8uX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpLjwlPW1OYW1lJT4oZGVwdGgpKSkpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCBvLjwlPW1OYW1lJT4oZGVwdGgpKSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmVmcyA9IHJlZnMuZmlsdGVyKHIgPT4gcik7DQogICAgICAgIA0KICAgICAgICByZWZzLmZvckVhY2gociA9PiByLl9yZXNvbHZlKHJlZnMpKTsNCg0KICAgICAgICA8JT1sb2coKSU+Ik91dHB1dCIsIHJldCk7DQoNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7ZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcywgX19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IFtdfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXNvbHZlJyU+KHJlZnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcmVmcy5sZW5ndGgpIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLl9faW1wb3J0KHt9LCB7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAoKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPW5OYW1lKGVhKSU+IiwgdGhpcy48JT1uTmFtZShlYSklPigpLklkLCByZWZzLm1hcChyID0+ICh7aWQ6IHIuSWQsIGNvZGU6IHIuY29kZSgpfSkpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmcy5maW5kKG8gPT4gby5JZD09dGhpcy48JT1uTmFtZShlYSklPigpLklkKSB8fCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihyZWZzKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLjwlPXRhTmFtZSU+KCkubGVuZ3RoKSB0aGlzLjwlPXRhTmFtZSU+KHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodGEgPT4gcmVmcy5maW5kKG8gPT4gby5JZD09dGEuSWQpIHx8IHRhLjwlPW1OYW1lJT4ocmVmcykpLCBudWxsLCB0cnVlKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KPCUgaWYobWFpbkNsYXNzKFsnRU1TJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU1ZhbHVlcyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0VNUyddKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMoZXZzLCBbLi4ubmV3IFNldChldnMubWFwKHYgPT4gdi5lbnRpdHlBdHRyaWJ1dGUoKS5JZCkuZmxhdCgpKV0ubWFwKGlkID0+IG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZShpZCkpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5ldnMpOw0KICAgICAgICANCiAgICAgICAgICAgIGxldCBvYmpzID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiX2VudGl0eU9iamVjdCIpLmZvckVhY2goZXZnID0+IHsNCiAgICAgICAgICAgICAgICBldmcua2V5LmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXZnLnZhbHVlcyk7DQogICAgICAgICAgICAgICAgb2Jqcy5wdXNoKGV2Zy5rZXkpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIG9ianMuZm9yRWFjaChyID0+IHIuZW50aXR5Q2xhc3Moci5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKClbMF0uZW50aXR5QXR0cmlidXRlKCkuZW50aXR5Q2xhc3MoKSkpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygb2Jqcyl7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgbmV3IDwlPXNjb3BlJT5bci5lbnRpdHlDbGFzcygpLm5hbWUoKV0oKS5fZnJvbUVNU09iamVjdChyKSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0VNUyddLGMpKSU+KCkuPCU9bU5hbWUlPihldnMpOw0KICAgIDwlfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9FTVNDbGFzcyclPihkZXB0aCl7DQogICAgICAgIC8vIHdoeSBub3QgX19leHBvcnQgPw0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3MoJzwlPWMuSWQlPicpLm5hbWUoIjwlPWMuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoYyklPiIpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmRhdGUobmV3IERhdGUoKSkuY29tcGFueShuZXcgPCU9c2NvcGUlPi5Db21wYW55KCkubmFtZSgiPCU9c2NvcGUlPiIpLmNvZGUoIjwlPXNjb3BlJT4iKSkuZW50aXR5TW9kdWxlKG5ldyA8JT1zY29wZSU+LkVudGl0eU1vZHVsZSgpLmNvZGUoIjwlPXNjb3BlJT4iKS5uYW1lKCI8JT1zY29wZSU+IikpOw0KICAgICAgICAgICAgaWYoIWRlcHRoKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQuZW50aXR5Q2xhc3NfRW50aXR5TWV0aG9kcyhbDQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlNZXRob2QoJzwlPW0uSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPW0uTmFtZSU+IikuY29kZSgiPCU9bk5hbWUobSklPiIpLmVudGl0eU1ldGhvZF9FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICAgICAgPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1wLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1wLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKHApJT4iKS5pc0FycmF5KDwlPXAuSXNBcnJheT8ndHJ1ZSc6J2ZhbHNlJyU+KS5yZW1hcmsoIjwlPWMuTmFtZSU+LjwlPW0uTmFtZSU+KCkiKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKQ0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS48JT1tTmFtZSU+KGRlcHRoLTEpKQ0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKHApJT4odHJ1ZSkNCiAgICAgICAgICAgIDwlIH0lPiwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF0pLnJlc3BvbnNlQXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlKSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSkNCiAgICAgICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKG0uUmVzcG9uc2VBdHRyaWJ1dGUpJT4odHJ1ZSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKS5lbnRpdHlDbGFzc19FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1lYS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9ZWEuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoZWEpJT4iKS5yZW1hcmsoJzwlPWMuTmFtZSU+LjwlPWVhLk5hbWUlPicpDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKGVhKSU+KHRydWUpDQogICAgICAgIDwlIH0lPiwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU09iamVjdCclPihvYmopew0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0aGlzLklkID0gb2JqLklkOw0KICAgICAgICAgICAgbGV0IGV2ID0gbnVsbDsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBldiA9IG9iai5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKCkuZmluZChldiA9PiBldi5lbnRpdHlBdHRyaWJ1dGUoKS5jb2RlKCk9PTwlPV9uQ29kZShlYSklPik7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihldi5vYmplY3RWYWx1ZSgpKSk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihldi48JT1fRnJFTUQuX2F0dHIoZWEpLnRvTG93ZXJDYXNlKCklPlZhbHVlKCkpOw0KICAgICAgICA8JSB9JT4NCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvRU1TT2JqZWN0JyU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyl7DQogICAgICAgIGxldCByZXQgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlPYmplY3QoKS5hY3RpdmUodHJ1ZSkuZW50aXR5Q2xhc3ModGhpcy5fdG9FTVNDbGFzcygpKTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIC8vTnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5JZCA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eUF0dHJpYnV0ZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPWVhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1lYS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShlYSklPiIpLmVudGl0eUNsYXNzKHRoaXMuX3RvRU1TQ2xhc3MoKSkpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGV2Lm9iamVjdFZhbHVlKHY/di48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyk6bnVsbCwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKS50b0xvd2VyQ2FzZSgpJT5WYWx1ZSh2LCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXYsICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZih2ICYmIGJUeXBlZEF0dHJpYnV0ZXMpIG9iai5vYmplY3RWYWx1ZV9FbnRpdHlWYWx1ZXModi5tYXAoX3YgPT4gbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5QXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9dGEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUoIjwlPW5OYW1lKHRhKSU+IikubmFtZSgiPCU9dGEuTmFtZSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdG9FTVNDbGFzcygpKSkub2JqZWN0VmFsdWUoX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpKSksICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoWydCSVNlcnZlciddKSl7JT4NCiAgICA8JT1tTmFtZT0nX2FzT2JqZWN0cyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pIT1jKXslPg0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10sYykpJT4oKS48JT1tTmFtZSU+KGV2cyk7DQogICAgPCV9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZXZzKT09PSJ1bmRlZmluZWQiIHx8ICFldnMgfHwgIUFycmF5LmlzQXJyYXkoZXZzKSB8fCAhZXZzLmxlbmd0aCkgcmV0dXJuIFtdOw0KDQogICAgICAgICAgICBldnMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgZXYuRW50aXR5QXR0cmlidXRlID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSWQ9PWV2LkVudGl0eUF0dHJpYnV0ZWlkKTsNCiAgICAgICAgICAgICAgICBldi5FbnRpdHlPYmplY3QuRW50aXR5Q2xhc3MgPSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgaWYoZXYuT2JqZWN0VmFsdWUpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcyA9IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcy5maW5kKGVjID0+IGVjLklkPT1ldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcy5JZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICBsZXQgb2JqID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiRW50aXR5T2JqZWN0IikuZm9yRWFjaChldmcgPT4gew0KICAgICAgICAgICAgICAgIGxldCBjID0gbmV3IDwlPXNjb3BlJT5bZXZnLmtleS5FbnRpdHlDbGFzcy5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKTsNCiAgICAgICAgICAgICAgICBjLkVudGl0eVZhbHVlcyA9IGV2Zy52YWx1ZXM7DQogICAgICAgICAgICAgICAgYy5WYWx1ZUVudGl0aWVzID0gW107DQogICAgICAgICAgICAgICAgLy8gYy5FbnRpdHlDbGFzcyA9IGV2Zy5rZXkuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgYy5JZCA9IGV2Zy5rZXkuSWQ7DQogICAgICAgICAgICAgICAgZXZnLnZhbHVlcy5mb3JFYWNoKHYgPT4gdi5FbnRpdHlPYmplY3QgPSBjKTsNCiAgICAgICAgICAgICAgICBvYmoucHVzaChjKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBldnMuZmlsdGVyKGV2ID0+IGV2Lk9iamVjdFZhbHVlKS5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgX2YgPSBvYmouZmluZChvID0+IG8uSWQgPT0gZXYuT2JqZWN0VmFsdWUuSWQpOw0KICAgICAgICAgICAgICAgIGlmKF9mKSBfZi5WYWx1ZUVudGl0aWVzLnB1c2goZXYpOw0KICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gX2Y7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBvYmouZm9yRWFjaChvID0+IHsNCiAgICAgICAgICAgICAgICBpZihvLkVudGl0eUNsYXNzICYmIG8uRW50aXR5Q2xhc3MuSWQhPXRoaXMuRW50aXR5Q2xhc3MuSWQpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKG8pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQubWFwKG8gPT4gby5fcmV2ZXJ0KCkpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCV9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXZlcnQnJT4oZW8pIHsNCiAgICAgICAgaWYgKGVvKSB7DQogICAgICAgICAgICAvLyByZXZlcnQgZnJvbSBzb3VyY2UgZGF0YQ0KICAgICAgICAgICAgaWYoZW8uRW50aXR5Q2xhc3MgJiYgKCh0aGlzLkVudGl0eUNsYXNzLklkICYmIGVvLkVudGl0eUNsYXNzLklkIT10aGlzLkVudGl0eUNsYXNzLklkKSB8fCAodGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIGVvLkVudGl0eUNsYXNzLk5hbWUhPXRoaXMuRW50aXR5Q2xhc3MuTmFtZSkpKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iQ2Fubm90IHJldmVydCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5FbnRpdHlDbGFzcykgKyAiIGZyb20gIiArIGVvLkVudGl0eUNsYXNzLk5hbWUsIGVvKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuSWQgPSBlby5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gZW8uRW50aXR5VmFsdWVzIHx8IFtdOw0KICAgICAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzID0gZW8uVmFsdWVFbnRpdGllcyB8fCBbXTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLjwlPW1OYW1lJT4oKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmKHRoaXMuX19zeW5jX29uKCkgJiYgTWF0aC5hYnMoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCA1KXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJPYmplY3QgYWxyZWFkeSByZXZlcnRlZCIsIHRoaXMuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgDQogICAgICAgICAgICAvLyB1c2UgRW50aXR5VmFsdWVzIGFuZCBWYWx1ZUVudGl0aWVzIHRvIHJldmVydCB0aGUgYXR0cmlidXRlIHZhbHVlcw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGVhID0gbnVsbDsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIGVhID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihfZWEgPT4gX2VhLkVudGl0eUNsYXNzLk5hbWU9PSc8JT1jLk5hbWUlPicpLmZpbmQoX2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZWlkPT1fZWEuSWQpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGUpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5JZD09X2VhLklkKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lPT1fZWEuTmFtZSkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBpZighZWEpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4idW5hYmxlIHRvIGRldGVjdCBhdHRyaWJ1dGUgZnJvbSB2YWx1ZSIsIGV2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXYsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGxldCB2ID0gZXZbKHRoaXNbIl9hdHRyIl0/dGhpczpfRnJFTUQpLl9hdHRyKGVhKSArICJWYWx1ZSJdOw0KICAgICAgICAgICAgICAgIGxldCBwID0gZWEuTmFtZS5yZXBsYWNlKC8gL2csICdfJyk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRoaXNbcF0pIT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImludmFsaWQgdHlwZSIsIGVhLCBwLCB2KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZih2ICYmIGVhLkVudGl0eVR5cGUgJiYgdHlwZW9mKHYpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+InJldmVydGluZyAiICsgZWEuTmFtZSwgdiwgbmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXYuRW50aXR5VmFsdWVzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImVtcHR5IHZhbHVlcyBmb3IgIiArIGVhLk5hbWUsIHYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3BdKHYpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHRoaXMuVmFsdWVFbnRpdGllcy5maWx0ZXIodmUgPT4gdmUuRW50aXR5QXR0cmlidXRlKS5mb3JFYWNoKHZlID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgdGEgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5JZD09dmUuRW50aXR5QXR0cmlidXRlLklkKTsNCiAgICAgICAgICAgICAgICBpZighdGEpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHZhciB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOw0KDQogICAgICAgICAgICAgICAgbGV0IHYgPSB2ZS5FbnRpdHlPYmplY3Q7DQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bdGEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3RhLk5hbWUucmVwbGFjZSgvIC9nLCAiXyIpICsgIl8iICsgdGFOYW1lXSh2KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3ZhbHVlQ2xhc3MnJT4oKXsNCiAgICAgICAgbGV0IF9jbGFzcyA9IHtBY3RpdmU6IHRydWV9Ow0KICAgICAgICBpZih0aGlzLkVudGl0eUNsYXNzLkVudGl0eU1vZHVsZSl7DQogICAgICAgICAgICBfY2xhc3MuRW50aXR5TW9kdWxlID0gdGhpcy5FbnRpdHlDbGFzcy5FbnRpdHlNb2R1bGU7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgX2NsYXNzID0gew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBDb21wYW55OiB7QWN0aXZlOiB0cnVlLCBFbmFibGVkOiB0cnVlLCBFbnRpdHlDbGFzc2VzOiBbdGhpcy5FbnRpdHlDbGFzc119DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgICAgIHJldHVybiBfY2xhc3M7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1hNTCclPigpew0KICAgICAgICAvLyBhbiBvdmVybG9hZCBvZiB0aGUgc3IuX3RvWE1MDQogICAgICAgIGxldCByZXQgPSB7eG1sOiBgYH07DQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQueG1sICs9IGA8JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCd9PiR7dn08LyR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnfT5gLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8JHtlYUNvZGV9PmA7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSB2P3YuPCU9bU5hbWUlPigpOm51bGw7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCFbQ0RBVEFbJHt2fV1dPmA7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwvJHtlYUNvZGV9PmA7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwke2VhQ29kZX0+YCArIHYubWFwKF92ID0+ICc8T2JqZWN0PicgKyBfdi48JT1tTmFtZSU+KCkgKyAiPC9PYmplY3Q+Iikuam9pbignJykgKyBgPC8ke2VhQ29kZX0+YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0LnhtbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX2J1aWxkVGhpcyclPihkZXB0aD0xKXsNCiAgICAgICAgLy8gY2FuZGlkYXRlIGZvciBfX2V4cG9ydA0KICAgICAgICB2YXIgcmV0ID0gW3sNCiAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZToge0FjdGl2ZTogdHJ1ZSwgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKX0sDQogICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHRoaXMudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgIH1dOw0KICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSBkZXB0aDsgaSsrKSB7DQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFtyZXRbaSAtIDFdXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIGlmKGRlcHRoPjEpew0KICAgICAgICAgICAgbGV0IHYgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgcmV0LnB1c2goew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHY/di50b0VudGl0eU9iamVjdCh0cnVlKTpudWxsLA0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3sNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdj92LnRvRW50aXR5T2JqZWN0KHRydWUpOm51bGwsDQogICAgICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSd0b0VudGl0eU9iamVjdCclPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpIHsNCiAgICAgICAgbGV0IHJldCA9IHtBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCksIEVudGl0eVZhbHVlczogW10sIFZhbHVlRW50aXRpZXM6IFtdfTsNCiAgICAgICAgaWYoIWJRdWVyeSkgcmV0LkRhdGUgPSB0aGlzLnNlcnZlckRhdGUoKTsgDQoNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIEZ1bGw6ICFiUXVlcnksDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouSWQgPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZXYgPSB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCkuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWU9PSc8JT1lYS5OYW1lJT4nKS5JZCwNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI8JT1lYS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7fSwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZSA9IHYuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpOw0KICAgICAgICAgICAgICAgICAgICBldi5PUEVSQVRPUlMuT2JqZWN0VmFsdWUgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgICAgICAgICAgICAgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLlZhbHVlRW50aXRpZXMucHVzaChldik7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKHYgJiYgYlR5cGVkQXR0cmlidXRlcykgb2JqLkVudGl0eVZhbHVlcy5wdXNoKHYubWFwKF92ID0+ICh7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogJzwlPXRhLklkJT4nLA0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIjwlPXRhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBPYmplY3RWYWx1ZTogX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpLA0KICAgICAgICAgICAgICAgIH0pKSk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9ICU+DQp9DQo=",
	"Name": "RW50aXR5Q2xhc3M=",
	"Script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCgke3N9fHwnLicpYDsNCg0KbGV0IF9kZWYgPSAocywgdikgPT4gJT48JT1zJT4gPSB0eXBlb2YoPCU9cyU+KSE9PSd1bmRlZmluZWQnPzwlPXMlPjo8JT12JT47PCUNCg0KbGV0IF9kZWZhdWx0cyA9IChvYmo9J3RoaXMnLCBfYz1jKSA9PiBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkRlZmF1bHQpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighPCU9b2JqJT4uXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgPCU9b2JqJT4uPCU9bk5hbWUoZWEpJT4oPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4pOw0KICAgICAgICAgICAgfQ0KPCUgfSk7DQoNCmxldCBsb2cgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMCwgYDsNCmxldCB3YXJuID0gKG4sIF90aGlzPSd0aGlzJykgPT4gYCR7X3RoaXN9LmxvZyhudWxsLCB1bmRlZmluZWQsICcke24gfHwgbU5hbWV9JywgJ0VudGl0eU9iamVjdCcsIDEsIGA7DQpsZXQgZXJyb3IgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMiwgYDsNCg0KbGV0IHFsVHlwZSA9IChlYSwgYklucHV0KSA9PiB7DQogICAgaWYoZWEuSXNCb29sKSByZXR1cm4gJ0Jvb2xlYW4nOw0KICAgIC8vaWYoZWEuSXNEYXRlKSByZXR1cm4gJ0RhdGVUaW1lJzsNCiAgICBpZihlYS5Jc0ludCB8fCBlYS5Jc0Zsb2F0KSByZXR1cm4gJ0ludCc7DQogICAgaWYoZWEuRW50aXR5VHlwZSkgcmV0dXJuIG5OYW1lKGVhLkVudGl0eVR5cGUpKyhiSW5wdXQ/IklucHV0IjoiIik7DQogICAgcmV0dXJuICdTdHJpbmcnOw0KfTsNCg0KLy8gd2h5IGhhcmQgY29kZWQ/Pz8NCmxldCBfcmVzdFRvb2xzID0gWydTZXJ2aWNlTm93JywgJ1NhbGVzRm9yY2UnLCAnUmVzdERCSU8nLCAnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCmxldCBfc3FsVG9vbHMgPSBbJ1NxbERCJywgJ1NhbGVzRm9yY2UnLCAnU25vd0ZsYWtlJ107DQpsZXQgX2ZpbGVUb29scyA9IFsnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCg0KbGV0IGNsc1Rvb2xzID0gX2MgPT4gX2MuVG9vbHMubWFwKHQgPT4gdC50eXBlP3QudHlwZS5uYW1lOih0Lm5hbWUgfHwgdCkpOw0KbGV0IG1haW5DbGFzcyA9IChfYXJUb29scywgX2M9YykgPT4gYXJDbGFzc2VzLmZpbmQoX19jID0+IChfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmZpbmQodCA9PiBjbHNUb29scyhfX2MpLmluY2x1ZGVzKHQpKSkgfHwgKCEoX2FyVG9vbHMgfHwgY2xzVG9vbHMoX2MpKS5sZW5ndGggJiYgYXJDbGFzc2VzWzBdKTsNCg0KbGV0IF9lYVR5cGVzID0gKF9jPWMsIGJBbGwpID0+IF9GckVNRC5fdG9KUyhPYmplY3QuYXNzaWduKHt9LCAuLi5fYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGJBbGw/dHJ1ZTplYS5FbnRpdHlUeXBlKS5tYXAoZWEgPT4gKHtbbk5hbWUoZWEpXTogbk5hbWUoZWEuRW50aXR5VHlwZSkgfHwgX0ZyRU1ELl9hdHRyKGVhKX0pKSkpOw0KDQpsZXQgX2NGaWVsZCA9IChlYSwgX2M9ZWEuRW50aXR5Q2xhc3MpID0+ICgoZWEuRW50aXR5VHlwZT8oZWEuRW50aXR5VHlwZS5UeXBlZEF0dHJpYnV0ZXMuZmluZCh0YSA9PiB0YS5FbnRpdHlDbGFzcz09X2MpIHx8IGVhLkVudGl0eUNsYXNzLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLkVudGl0eVR5cGU9PV9jKSk6bnVsbCkgfHwge05hbWU6ICIifSkuTmFtZTsNCg0KbGV0IF9jTmFtZSA9IChjbj1jLk5hbWUsIGJBbGlhcykgPT4gew0KICAgIGlmKGNuLk5hbWUpIGNuID0gY24uTmFtZTsNCiAgICBsZXQgX2MgPSBhckNsYXNzZXMuZmluZChlYyA9PiBlYy5OYW1lPT1jbik7DQogICAgaWYoIV9jKSByZXR1cm4gJyc7DQogICAgcmV0dXJuIG5OYW1lKF9jLCBiQWxpYXMpOw0KfTsNCg0KbGV0IGFsaWFzID0gKGNuLCBqPScuJykgPT4gKHNjb3BlICsgJy4nICsgX2NOYW1lKGNuLCB0cnVlKS5yZXBsYWNlKF9jTmFtZShjbiksICcnKSkuc3BsaXQoJy4nKS5maWx0ZXIobiA9PiBuKS5qb2luKGopOw0KbGV0IG5zY29wZSA9IGFsaWFzKCdOb2RlJyk7DQoNCmxldCBfdkNvZGUgPSBrID0+IHslPig8JXZhbHVlT2Yoay5Db2RlKSU+IHx8ICgiPCU9bkNvZGUoayklPiIpKTwlfTsNCmxldCBfbkNvZGUgPSAoZWEsIGJUeXBlZCkgPT4gZWE/KCJ0aGlzLl9uQ29kZSgnIiArIG5Db2RlKGVhKSArIChiVHlwZWQ/KCdfJyArIGVhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJykpOiIiKSAgKyAiJywgIiArIChiVHlwZWQ/bnVsbDpfRnJFTUQuX3RvSlMoZWEuQ29kZSkpICsgIikiKToidGhpcy5fbkNvZGUoKSI7DQpsZXQgbVJvdXRpbmcgPSAoYywgbSkgPT4gew0KICAgIGlmICghYyAmJiBtKSBjID0gbS5FbnRpdHlDbGFzczsNCiAgICBpZiAoIW0gJiYgIWMpIHJldHVybiAiIjsNCiAgICBpZiAoIW0pIG0gPSBjOw0KICAgIGlmICghbS5Sb3V0aW5nICYmICFjLlJvdXRpbmcpIHJldHVybiAiIjsNCg0KJT4oX25vZGUsIG1ldGhvZCkgPT4gew0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlbT9tLk5hbWU6JyclPiIgfHwgbWV0aG9kLCAiUm91dGVyIiwgMCwgLi4ubXNnKTsNCiAgICAJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAJbGV0IG5TY29wZSA9IDwlPW5zY29wZSU+Ow0KDQogICAgICAgIHRyeXsNCiAgICAgICAgPCVmdW5jdGlvbk9mKG0uUm91dGluZyklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgd2FybihleCk7DQogICAgICAgIH0NCn0NCjwlfTsNCg0KbGV0IG1OYW1lID0gJyc7DQoNCmxldCBmdW5jdGlvbk9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4NCiAgICAgICAgbGV0IF9fcmV0ID0gdW5kZWZpbmVkOw0KICAgIDwlIGlmKGZ1bil7JT4NCiAgICAgICAgPCUgaWYodHlwZW9mKGZ1bik9PT0nb2JqZWN0Jyl7JT4NCiAgICAgICAgICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYoPCU9X3RoaXMlPi5Ub29sICYmIDwlPV90aGlzJT4uVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgICAgICAgICA8JSBpZih0eXBlb2YoZnVuW3RdKT09PSdmdW5jdGlvbicpeyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPWZ1blt0XSU+Ow0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPShKU09OLnN0cmluZ2lmeShmdW5bdF0pIHx8ICciIicpJT47DQogICAgICAgICAgICAgICAgPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuJT47DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0lPg0KICAgICAgICBpZih0eXBlb2YoX19yZXQpPT09J3N0cmluZycgJiYgX19yZXQuc3RhcnRzV2l0aCgicygiKSAmJiBfX3JldC5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgIF9fcmV0ID0gdGhpcy5ydW5TY3JpcHQoX19yZXQuc2xpY2UoMiwtMSkpOw0KICAgICAgICB9DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgIF9fcmV0ID0gX19yZXQoPCU9X3RoaXMlPik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9fcmV0Ow0KPCV9Ow0KDQpsZXQgdmFsdWVPZiA9IChmdW4sIF90aGlzPSd0aGlzJykgPT4geyU+KCgNCihvU2NvcGUpID0+IHsNCiAgICB0cnl7DQo8JWZ1bmN0aW9uT2YoZnVuLCBfdGhpcyklPg0KICAgIH1jYXRjaChfdk9mRXgpew0KICAgICAgICA8JT13YXJuKCklPid2YWx1ZU9mJywgX3ZPZkV4LCA8JT1fRnJFTUQuX3RvSlMoZnVuKSU+KTsNCiAgICB9DQp9DQopKDwlPWFsaWFzKCklPikpPCV9Ow0KDQpsZXQgdW5SZWN1cnNlID0gKG9iaiwgZnVuLCBmQXJncz0nYXJndW1lbnRzJywgc1JldCwgdmFsaWRpdHk9YHRoaXMuX19jb25maWcoJ3VuUmVjdXJzZS52YWxpZGl0eScsIDAuNSlgLCBpZGYpID0+IHsNCiAgICBpZGYgPSBpZGYgfHwgYCh0aGlzP3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTonSWQnKWA7DQogICAgZnVuID0gZnVuIHx8IGAiJHttTmFtZX0iYDsNCiAgICBzUmV0ID0gYA0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICB2LmRhdGUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgICAgICAgICAgICAgICB2LnJldXNlZCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAke3NSZXR9DQogICAgICAgIH1jYXRjaChzUmV0X2V4KXsNCiAgICAgICAgICAgIHRoaXMubG9nKG51bGwsIHVuZGVmaW5lZCwgJHtmdW59LCAnJHttTmFtZX0udW5SZWN1cnNlJywgMSwgJ3NSZXQnLCBzUmV0X2V4KTsNCiAgICAgICAgfWZpbmFsbHl7DQogICAgICAgICAgICBpZih2ICYmIHYucmV1c2VkPjEpIHJldHVybiB2P3Yub2JqOnY7DQogICAgICAgIH0NCiAgICBgOw0KICAgIGxldCBiRGFuZ2VyID0gKCkgPT4gJT4oWyJfdG9IYXNoIl0uaW5kZXhPZig8JT1mdW4lPik+PTApPCU7DQolPg0KICAgICAgICBsZXQgdiA9IHVuZGVmaW5lZDsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCA9IDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnQgfHwge307DQogICAgICAgICAgICBpZig8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPmBBYm9ydGluZyBhcyBwZXIgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydC4kezwlPWZ1biU+fWApOw0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgX2lkID0gbnVsbDsNCiAgICAgICAgICAgIGlmKHR5cGVvZig8JT1vYmolPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPiJOdWxsIGlucHV0IiwgPCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gPCU9b2JqJT47DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoPCU9b2JqJT4pPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuaGFzaENvZGUoPCU9b2JqJT4pOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKDwlPW9iaiU+WzwlPWlkZiU+XSkhPT0ndW5kZWZpbmVkJyAmJiA8JT1vYmolPls8JT1pZGYlPl09PTwlPW9iaiU+WzwlPWlkZiU+XSl7DQogICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT5bPCU9aWRmJT5dOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoX2lkKT09PSd1bmRlZmluZWQnIHx8ICFfaWQpew0KICAgICAgICAgICAgICAgIGlmKDwlPW9iaiU+LklkICYmIDwlPW9iaiU+LklkPT08JT1vYmolPi5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IDwlPW9iaiU+LklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtvbmx5VW5pcXVlOiB0cnVlfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4idGhpcy5oYXNoZWRfaWQiLCBfaWQsIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihvYmouU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gb2JqLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJvYmouaGFzaGVkX2lkIiwgX2lkLCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPik7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoPCU9b2JqJT4uRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPi5FbnRpdHlDbGFzcy5JZCB8fCA8JT1vYmolPi5FbnRpdHlDbGFzcy5OYW1lIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjwlPWMuSWQlPiIgfHwgdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtkZXB0aDogPCViRGFuZ2VyKCklPj8zOnVuZGVmaW5lZH0sIDwlPWZ1biU+KSB8fCAiTlVMTCI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UgfHwge307DQogICAgICAgIAk8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+IHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSB8fCB7fTsNCiAgICAgICAgCQ0KICAgICAgICAgICAgdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdOw0KDQogICAgICAgICAgICBpZih2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwKjwlPXZhbGlkaXR5JT4pKXsNCiAgICAgICAgICAgICAgICBpZigoPCViRGFuZ2VyKCklPj9uZXcgRGF0ZSgwKToodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKS5nZXRUaW1lKCkgPiB2LmRhdGUpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT5gU3Bhd25pbmcgaW4gJHs8JT1mdW4lPn1gLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iU2VsZWN0ZWQgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+LCB2LnJldXNlZCwgPCU9dmFsaWRpdHklPik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4iUHVzaGluZyBoYXNoIiwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4pOw0KICAgICAgICAJdiA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gew0KICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLA0KICAgICAgICAgICAgICAgIGFyZ3M6IEpTT04uc3RyaW5naWZ5KDwlPWZBcmdzJT4pLA0KICAgICAgICAgICAgICAgIG9iajogPCU9b2JqJT4sDQogICAgICAgICAgICAgICAgcmV1c2VkOiAwLA0KICAgICAgICAgICAgICAgIHBhdGg6ICcnLA0KICAgICAgICAgICAgICAgIF9pZCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlLypleHBlcmltZW50YWw6IHJlbW92ZSB0aGlzIGlmIGFsbCBnb2VzIHdyb25nKi8lPg0KICAgICAgICAgICAgPCU9c1JldCU+DQogICAgCX1jYXRjaCh1blJlY0V4KXsNCiAgICAJICAgIGlmKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpew0KICAgIAkgICAgICAgIDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnRbPCU9ZnVuJT5dID0gdHJ1ZTsNCiAgICAJICAgIH0NCiAgICAJICAgIDwlPWVycm9yKGAke21OYW1lfS51blJlY3Vyc2VgKSU+PCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+LCB1blJlY0V4LnRvU3RyaW5nKCkpOw0KICAgIAkgICAgPCU9c1JldCU+DQogICAgCX0NCjwlDQp9Ow0KDQpsZXQgaW52b2tlUnVsZSA9IHIgPT4gew0KJT4NCmF3YWl0IChhc3luYyAoYXV0aE9iaikgPT4gew0KICAgIGxldCBfcnVsZSA9IDwlPV9GckVNRC5fdG9KUyhyKSU+Ow0KICAgIGRlbGV0ZSBfcnVsZS5TY3JpcHQ7DQogICAgLy8gcnVsZVJ1bnMucHVzaChfcnVsZSk7DQogICAgdHJ5ew0KICAgICAgICA8JT1yLlNjcmlwdCU+DQogICAgfWNhdGNoKGV4KXsNCiAgICAgICAgX3J1bGUuRXhjZXB0aW9uID0gZXg7DQogICAgfQ0KfSkoYXV0aE9iaik7DQo8JQ0KfQ0KJT4NCg0KY2xhc3MgPCU9bk5hbWUoYyklPiB7DQogICAgPCU9bU5hbWU9J2NvbnN0cnVjdG9yJyU+KGlkLCB0b29sKSB7DQogICAgICAgIC8vc3VwZXIoaWQsIHRvb2wpOw0KDQogICAgICAgIHRoaXMuU2NvcGUgPSAiPCU9c2NvcGUlPiI7DQogICAgICAgIHRoaXMuRGVidWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5EZWJ1ZyklPjsNCiAgICAgICAgdGhpcy5Db25maWcgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db25maWcpJT47DQogICAgICAgIHRoaXMuVGVzdCA9IDwlPV9GckVNRC5fdG9KUyhjLlRlc3QpJT47DQogICAgICAgIHRoaXMuVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoYy5Ub29scyklPjsNCiAgICAgICAgdGhpcy5NYXBwaW5ncyA9IDwlPV9GckVNRC5fdG9KUyhjLk1hcHBpbmdzKSU+Ow0KDQogICAgICAgIC8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQ0KICAgICAgICB0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307DQogICAgICAgIHRoaXMuVG9vbCA9IHRvb2w7DQogICAgICAgIHRoaXMuSWQgPSBpZDsNCg0KICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsNCg0KICAgICAgICB0aGlzLkRhdGUgPSBudWxsOw0KDQogICAgICAgIHRoaXMuY2xlYXJfVEhJUygpOw0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcyA9IFtdOw0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KPCUgaWYoTnVtYmVyKGVhLklkKSl7JT4NCiAgICAgICAgICAgICAgICBJZDogIjwlPWVhLklkJT4iLA0KPCUgfSU+DQogICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7TmFtZTogIj0ifSwNCiAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBPUEVSQVRPUlM6IHt9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KTsgJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KCk7DQo8JSB9KTsgJT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZWZhdWx0cyclPigpew0KPCVfZGVmYXVsdHMoKSU+DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IEVudGl0eUNsYXNzJyU+KCl7DQogICAgICAgIGxldCBlYyA9IHsNCjwlIGlmKE51bWJlcihjLklkKSl7JT4NCiAgICAgICAgICAgIElkOiAiPCU9Yy5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgTmFtZTogIjwlPWMuTmFtZSU+IiwNCiAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgIH07DQoNCjwlIGlmKGMuRW50aXR5TW9kdWxlaWQpeyAlPg0KICAgICAgICBlYy5FbnRpdHlNb2R1bGUgPSB7DQogICAgICAgICAgICBJZDogPCU9Yy5FbnRpdHlNb2R1bGVpZCU+DQogICAgICAgIH07DQo8JSB9JT4NCg0KICAgICAgICAvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXINCiAgICAgICAgaWYoIU51bWJlcihlYy5JZCkgJiYgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzKXsNCiAgICAgICAgICAgIGxldCBjaWQgPSA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWU9PWVjLk5hbWUpOw0KICAgICAgICAgICAgaWYoY2lkKSBlYy5JZCA9IGNpZC5JZDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZWM7DQogICAgfQ0KDQoJPCU9bU5hbWU9J2dldCBJZCclPigpIHsNCgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOw0KCX0NCg0KCTwlPW1OYW1lPSdzZXQgSWQnJT4oaWQpIHsNCgkJaWYgKCF0aGlzLlRvb2wpIHsNCgkJCTwlPWxvZygpJT4iRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYodGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXT09aWQpIHJldHVybjsNCgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOw0KCX0NCg0KICAgIDwlPW1OYW1lPSdnZXQgVG9vbCclPigpIHsNCiAgICAgICAgaWYodHlwZW9mKHRoaXMuX19Ub29sKSE9PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7DQogICAgICAgIGxldCBub1Rvb2wgPSB7DQogICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgIHR5cGU6IHtuYW1lOiAnJ30sDQogICAgICAgIH07DQogICAgICAgIGlmKHR5cGVvZig8JT1zY29wZSU+LlRvb2xzKSE9PSJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KDwlPXNjb3BlJT4uVG9vbHMpKXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPiI8JT1zY29wZSU+LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm4gbm9Ub29sOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gKDwlPXNjb3BlJT4uX19sYXN0VG9vbD9bPCU9c2NvcGUlPi5fX2xhc3RUb29sXTpbXSkuY29uY2F0KHRoaXMuVG9vbHMpLmZpbmQodCA9PiAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lPT1fdC5uYW1lKSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpIT09J3VuZGVmaW5lZCcpIHJldCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1yZXQgfHwgdC5uYW1lPT1yZXQubmFtZSk7DQogICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgaWYodGhpcy5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXSwNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sc1swXQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH1lbHNlIHJldCA9IG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdzZXQgVG9vbCclPih0b29sKSB7DQogICAgICAgIGlmICh0eXBlb2YodG9vbCk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICBpZih0eXBlb2YodG9vbCk9PT0ic3RyaW5nIil7DQogICAgICAgICAgICB0b29sID0ge25hbWU6IHRvb2x9Ow0KICAgICAgICB9DQogICAgICAgIGlmKHRvb2wuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0eXBlb2YodG9vbC5uYW1lKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSk9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICB0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwge25hbWU6IHRvb2wubmFtZX07DQogICAgICAgIA0KICAgICAgICBpZighdG9vbC50eXBlICYmICF0b29sLm5hbWUpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iRW1wdHkgVG9vbCBvYmplY3QiKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCB0ID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7DQogICAgICAgIGlmICghdCkgew0KICAgICAgICAgICAgPCU9bG9nKCklPiJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgPCU9c2NvcGUlPi5Ub29scyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPXNjb3BlJT4uX19sYXN0VG9vbCA9IHRoaXMuX19Ub29sID0gdDsNCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdUSElTJyU+KHYsIGNvKXsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOw0KICAgICAgICBpZighdikgcmV0dXJuIHRoaXM7DQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICB0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KT09PSdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWU9PXRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZT09dGhpcy5TY29wZSk7DQogICAgICAgIGlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nY2xlYXJfVEhJUyclPigpIHsNCiAgICAgICAgdGhpcy5fVEhJUyA9IFtdOw0KICAgICAgICB0aGlzLl9USElTX2Nvb3AgPSAnJzsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9ZWEuTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKGVhKSU+KHYsIGNvLCBpZCkgew0KICAgICAgICBpZiAoY28pIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBjbzsNCg0KICAgICAgICB2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCI8JT1lYS5OYW1lJT4iKTsNCiAgICAgICAgaWYgKCFldil7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpZCkgZXYuSWQgPSBpZDsNCg0KICAgICAgICBpZiAodHlwZW9mKHYpIT09J3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIC8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXINCg0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgICAgIHYgPSB2Lm1hcChfdiA9PiB7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHYgPSAoX3YgPT4gew0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIF92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nP192OihuZXcgRGF0ZShfdikpOw0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsNCiAgICA8JSB9JT4NCiAgICA8JSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgaWYoaXNOYU4oX3YpKSBfdiA9IDA7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihfdik9PT0nb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7DQogICAgPCUgfSU+DQoNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKF92ICYmICFfdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4idXNpbmcgX3RvRG9jdW1lbnQgZm9yIGludmFsaWQgc2V0dGVyIHZhbHVlIiwgX3YpOw0KICAgICAgICAgICAgICAgICAgICBfdiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfdik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoX3YgJiYgX3YuRW50aXR5Q2xhc3MuSWQhPT0nPCU9ZWEuRW50aXR5VHlwZS5JZCU+JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgU2V0dGVyIHZhbHVlIiwgX3YsICI8JT1lYS5FbnRpdHlUeXBlLklkJT4iLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiPCU9ZWEuRW50aXR5VHlwZS5OYW1lJT4iKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSAoKF92ICYmICF0aGlzLklkKSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgfSkodik7DQogICAgPCUgfSU+DQogICAgDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOw0KICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSB2Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgPCUgfSU+DQoNCiAgICAgICAgICAgIGlmKHRydWUgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT4hPXYpew0KICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IDwlPVNldF9PbiU+OyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQ0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJTZXQgYWZ0ZXIiLCB0aGlzLl88JT1uTmFtZShlYSklPj90aGlzLl88JT1uTmFtZShlYSklPi5TZXRfT246bnVsbCwgdj92LlNldF9PbjpudWxsKTsNCiAgICAgICAgICAgICAgICAvKmlmKHYpIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IHYuU2V0X09uOyovDQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gdjsNCiAgICAgICAgICAgIGlmIChjbykgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gY287DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J2NsZWFyXycrbk5hbWUoZWEpJT4oKSB7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPjsNCiAgICAgICAgLyoNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT4gPSBudWxsOw0KICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gIiI7DQogICAgICAgICovDQogICAgICAgIA0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT47DQogICAgICAgIGRlbGV0ZSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIC8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPWVhLk5hbWUlPiAqKi8NCjwlIH0pOyAlPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgIC8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgPCU9dGEuTmFtZSU+XzwlPXRhTmFtZSU+ICoqLw0KICAgIDwlPW1OYW1lPW5OYW1lKHRhKSsnXycrdGFOYW1lJT4odiwgY28sIGJDbGVhcikgew0KICAgICAgICBpZih0eXBlb2Yodik9PT0idW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+Ow0KICAgICAgICANCiAgICAgICAgaWYodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQhPT0nPCU9dGEuRW50aXR5Q2xhc3MuSWQlPicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lIT09JzwlPXRhLkVudGl0eUNsYXNzLk5hbWUlPicpIHJldHVybiB0aGlzOw0KICAgICAgICANCiAgICAgICAgdiA9IEFycmF5LmlzQXJyYXkodik/djpbdl07DQogICAgICAgIA0KICAgICAgICB2ID0gdi5maWx0ZXIoX3YgPT4gIXYgfHwgX3YuXzwlPW5OYW1lKHRhKSU+X3NldCkuY29uY2F0KHYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fPCU9bk5hbWUodGEpJT5fc2V0KS5tYXAoX3YgPT4gew0KICAgICAgICAgICAgaWYoIV92LmNvbnN0cnVjdG9yKXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uTmFtZSh0YSklPiBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7DQogICAgICAgICAgICB9ZWxzZSBpZihfdi5jb25zdHJ1Y3Rvci5uYW1lPT0iT2JqZWN0Iil7DQogICAgICAgICAgICAgICAgX3YgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3YpDQogICAgICAgICAgICAgICAgX3YuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgICAgICAgICAgfWVsc2UgaWYoX3YuY29uc3RydWN0b3IubmFtZSE9IjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+Iil7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iPCU9bk5hbWUodGEpJT4gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICI8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiIpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgX3YuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0dXJuIF92Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9KS5maWx0ZXIoX3YgPT4gX3YpKTsNCiAgICAgICAgDQogICAgICAgIGlmKGJDbGVhcikgdGhpcy5jbGVhcl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPigpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPi5wdXNoKC4uLnYpOw0KICAgICAgICB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9zZXQgPSA8JT1TZXRfT24lPjsNCiAgICAgICAgaWYgKGNvKSB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPl9jb29wID0gY287DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIGNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT47DQoNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fc2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4gPSBuZXcgQXJyYXkoKTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fY29vcCA9IG51bGw7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIC8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+ICoqLw0KDQo8JSB9KSAlPg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAvKiogc3RhcnQ6IGdldHRlcnMgZm9yIDwlPWVmLk5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT0nZ2V0ICcrbk5hbWUoZWYpJT4oKXsNCiAgICAgICAgcmV0dXJuIDwldmFsdWVPZihlZi5WYWx1ZSklPjsNCiAgICB9DQogICAgLyoqIGVuZDogZ2V0dGVycyBmb3IgPCU9ZWYuTmFtZSU+ICoqLw0KPCUgfSklPg0KDQogICAgPCU9bU5hbWU9J2xvZyclPihjbGFzc05hbWUsIG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIHR5cGUgPSB0eXBlIHx8ICJFbnRpdHlPYmplY3QiOw0KICAgICAgICANCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQoJCQlsZXQgZGVidWcgPSB0aGlzLkRlYnVnOw0KCQkJbGV0IGxldmVscyA9IFsiaW5mbyIsICJ3YXJuIiwgImVycm9yIiwgImNyaXRpY2FsIl07DQoNCgkJCWRlYnVnID0gZGVidWcgfHwgT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAobGV2ZWxzLm1hcChsID0+IFtsLCAnKiddKSkpOw0KDQoJCQlsZXQgZnVuY3Rpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgLi4ubGV2ZWxzLm1hcChsID0+ICh7DQoJCQkJW2xdOiBkZWJ1Z1tsXSA/IGRlYnVnW2xdLnNwbGl0KCcsJykgOiBbXQ0KCQkJfSkpKTsNCg0KCQkJbGV0IGNzcyA9ICdiYWNrZ3JvdW5kOiAjMDBmZjk5OyBjb2xvcjogIzAwODAwMCc7DQoJCQlsZXQgZmcgPSAnXHgxYlszMm0nOw0KCQkJc3dpdGNoIChOdW1iZXIobGV2ZWwpKSB7DQoJCQkJY2FzZSAxOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2ZmZmYwMDsgY29sb3I6ICMwMDAwODAnOw0KCQkJCQlmZyA9ICdceDFiWzMzbSc7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2UgMjoNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsNCgkJCQkJZmcgPSAnXHgxYlszMW0nOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIDM6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7DQoJCQkJCWZnID0gJ1x4MWJbMzFtW0NSSVRJQ0FMXSc7DQoJCQkJCWJyZWFrOw0KCQkJfQ0KDQoJCQlpZiAoZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXS5ldmVyeShmID0+ICFbJyouKicsICcqLicgKyBtLCAnKicsIG0sIGNsYXNzTmFtZSArICcuJyArIG0sIGNsYXNzTmFtZSArICcuKiddLmluY2x1ZGVzKGYpKSkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgew0KCQkJCWNvbnNvbGUubG9nKGZnICsgIiVzXHgxYlswbSIsIGAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7Y2xhc3NOYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7DQoJCQl9IGVsc2Ugew0KCQkJCWNvbnNvbGUubG9nKGAlYyAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7Y2xhc3NOYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIGNzcywgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsNCgkJCX0NCgkJfSBjYXRjaCAoZXgpIHsNCgkJCWNvbnNvbGUubG9nKGV4KTsNCgkJfQ0KPCUgfSU+DQoJfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J3NldEludGVydmFsJyU+KGNsYXNzTmFtZSwgZnVuLCBtaW51dGVzLCAuLi5hcmdzKXsNCiAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICI8JT1uTmFtZShjKSU+IjsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIGZ1biwgbWludXRlcywgLi4uYXJncyk7DQo8JSB9ZWxzZXslPg0KCQl0cnkgew0KICAgIAkJbGV0IGZOYW1lID0gZnVuLnRvU3RyaW5nKCkuc3BsaXQoJyknKVswXSArICcpJzsNCiAgICAJCXRyeSB7DQogICAgCQkJLy8gdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKTsNCiAgICANCiAgICAJCQl0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApOw0KICAgIAkJCWxldCByZXQgPSBhd2FpdCBmdW4oLi4uYXJncy5jb25jYXQoW25ldyBEYXRlKCldKSk7DQogICAgDQogICAgCQkJPCU9bG9nKCklPmB7Q2FsbDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCkgKyBgLCBMb29wOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKSArICd9Jyk7DQogICAgCQkJaWYgKCFyZXQpIHsNCiAgICAJCQkJPCU9bG9nKCklPmBkaWQgbm90IHJldHVybiB0cnVlLCBleGl0aW5nIGxvb3BlciAoJHt0aGlzLl9fdGltZShmTmFtZSl9KWApOw0KICAgIAkJCQlyZXR1cm47DQogICAgCQkJfQ0KICAgIAkJfSBjYXRjaCAoZXgpIHsNCiAgICAJCQk8JT1lcnJvcigpJT50aGlzLl9fdGltZShmTmFtZSksIGV4KTsNCiAgICAJCQljb25zb2xlLnRyYWNlKCk7DQogICAgCQl9DQogICAgCQlpZiAoIU51bWJlcihtaW51dGVzKSkgew0KICAgIAkJCTwlPWxvZygpJT50aGlzLl9fdGltZShmTmFtZSksICJOb3QgcmVwZWF0aW5nLiBNaW51dGVzIGlzICIgKyBtaW51dGVzKTsNCiAgICAJCQlyZXR1cm47DQogICAgCQl9DQogICAgCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgbWludXRlcyAqIDYwICogMTAwMCkpOw0KICAgIAkJYXdhaXQgdGhpcy48JT1tTmFtZSU+KG51bGwsIGZ1biwgbWludXRlcywgLi4uYXJncyk7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZXhlY3V0ZSclPihjbGFzc05hbWUsIHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zID0ge30sIHNvdXJjZSl7DQoJCXRoaXMuX190aW1lKGA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPi4ke219YCk7DQoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQoJCXNjb3BlID0gc2NvcGUgfHwgPCU9c2NvcGUlPjsNCgkJc291cmNlID0gc291cmNlIHx8IHRoaXM7DQoNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihjbGFzc05hbWUsIHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zLCB0aGlzKTsNCjwlIH1lbHNleyU+DQoJCWRlbGV0ZSA8JT1zY29wZSU+Ll91blJlY3Vyc2U7IC8vIGV4cGVyaW1lbnRhbA0KCQkNCiAgICAJbGV0IF9fYmVmb3JlUnVsZXMgPSBvUGFyYW1zLl9fYmVmb3JlUnVsZXMgfHwgW107DQogICAgCWxldCBfX2FmdGVyUnVsZXMgPSBvUGFyYW1zLl9fYWZ0ZXJSdWxlcyB8fCBbXTsNCiAgICAJZGVsZXRlIG9QYXJhbXMuX19iZWZvcmVSdWxlczsNCiAgICAJZGVsZXRlIG9QYXJhbXMuX19hZnRlclJ1bGVzOw0KDQogICAgICAgIGxldCBsb2cgPSAoLi4ucykgPT4gPCU9bG9nKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBtLCAuLi5zKTsNCiAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgIAkJbGV0IGxQYXJhbXMgPSBPYmplY3QuZW50cmllcyhvUGFyYW1zKS5tYXAoeCA9PiB4WzFdKTsNCiAgICAJCWxldCByZXN1bHRzID0gW107DQogICAgDQogICAgCQlsZXQgbm9kZXMgPSBbXTsNCiAgICAJCQ0KICAgIAkJaWYgKDwlPW5zY29wZSU+Ll9ub2RlICYmIGF3YWl0IGZSb3V0ZXIoPCU9bnNjb3BlJT4uX25vZGUsIG0pKSB7DQogICAgCQkJbm9kZXMucHVzaCg8JT1uc2NvcGUlPi5fbm9kZSk7DQogICAgCQl9DQogICAgDQogICAgCQlpZiAoPCU9bnNjb3BlJT4uX25vZGUgJiYgPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudCAmJiBhd2FpdCBmUm91dGVyKDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLCBtKSkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJZm9yIGF3YWl0IChjb25zdCBjbiBvZiAoPCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUucGFyZW50X05vZGVzKCk6W10pKSB7DQogICAgICAgICAgICAgICAgaWYgKGF3YWl0IGZSb3V0ZXIoY24sIG0pKSB7DQogICAgICAgICAgICAgICAgCWxvZygnYWRkaW5nIGNoaWxkIG5vZGUnLCBjbik7DQogICAgICAgICAgICAgICAgCW5vZGVzLnB1c2goY24pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAJCX0NCiAgICANCiAgICAJCS8vIHJlbW92ZSBhbnkgbnVsbHMNCiAgICAJCW5vZGVzID0gbm9kZXMuZmxhdCgpLmZpbHRlcihuID0+IG4pOw0KICAgIAkJDQogICAgCQlpZiAoIW5vZGVzLmxlbmd0aCkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgCQlub2RlcyA9IHRoaXMuX3VuaXF1ZShub2RlcywgJ19jb2RlJyk7DQogICAgCQlsb2coJ25vZGVzLmxlbmd0aCcsIG5vZGVzLmxlbmd0aCk7DQoNCiAgICAJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBub2Rlcykgew0KICAgIAkJCWxldCBuUmV0ID0gbnVsbDsNCiAgICAJCQlsb2coYCR7bX0gQCAke24/LmNvZGUoKSB8fCAnTE9DQUwnfWApOw0KICAgIAkJCWlmICghbiB8fCB0aGlzLl9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLCBuKSkgew0KICAgIAkJCQkvLyBsb2NhbCBzY3JpcHQNCiAgICAJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYmVmb3JlUnVsZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwldmFsdWVPZigici5TY3JpcHQiKSU+DQogICAgCQkJCQkvL2F3YWl0IHRoaXMuX1NjcmlwdChjbGFzc05hbWUsIHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0JlZm9yZVJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7DQogICAgCQkJCX0NCg0KICAgIAkJCQluUmV0ID0gYXdhaXQgZlNjcmlwdCgpOw0KDQogICAgCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2FmdGVyUnVsZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwldmFsdWVPZigici5TY3JpcHQiKSU+DQogICAgCQkJCQkvL2F3YWl0IHRoaXMuX1NjcmlwdChjbGFzc05hbWUsIHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0FmdGVyUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsNCiAgICAJCQkJfQ0KICAgIAkJCX0gZWxzZSB7DQogICAgCQkJCW5SZXQgPSBhd2FpdCBzb3VyY2UuX2ludm9rZU5vZGUobiwgbSwgb1BhcmFtcyk7DQogICAgCQkJfQ0KICAgIA0KICAgIAkJCXJlc3VsdHMucHVzaCh7DQogICAgCQkJCW5vZGU6IG4sDQogICAgCQkJCXJldDogblJldA0KICAgIAkJCX0pOw0KICAgIAkJfQ0KICAgIAkJbG9nKHJlc3VsdHMsICJfZXhlY3V0ZSIsICdSZXN1bHRzJyk7DQogICAgDQogICAgCQlsZXQgZXJyb3JzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnJldCAmJiByLnJldC5fX2V4Y2VwdGlvbikubWFwKHIgPT4gKHsNCiAgICAJCQlub2RlOiByLm5vZGUgPyB7DQogICAgCQkJCWNvZGU6IHIubm9kZS5jb2RlKCksDQogICAgCQkJCWFkZHJlc3M6IHIubm9kZS5hZGRyZXNzKCkNCiAgICAJCQl9IDogbnVsbCwNCiAgICAJCQlfX2V4Y2VwdGlvbjogci5yZXQuX19leGNlcHRpb24NCiAgICAJCX0pKTsNCg0KICAgIAkJaWYgKGVycm9ycy5sZW5ndGgpIHsNCiAgICAJCQl3YXJuKCJlcnJvcnMiLCBlcnJvcnMpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJcmV0dXJuIHJlc3VsdHM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICBlcnJvcihleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfU2NyaXB0JyU+KGNsYXNzTmFtZSwgc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgX25vZGUsIC4uLnNmQXJncyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgPCU9c2NvcGUlPjsNCiAgICAgICAgDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBzY3JpcHQsIG0sIHR5cGUsIHNjb3BlLCBfbm9kZSwgLi4uc2ZBcmdzKTsNCjwlIH1lbHNleyU+DQogICAgCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAJDQogICAgICAgIHRyeXsNCiAgICAJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3N0cmluZycpIHNjcmlwdCA9IHRoaXMucnVuU2NyaXB0KGAoKSA9PiB7JHtzY3JpcHR9fWApOw0KICAgIA0KICAgIAkJbGV0IHJldCA9IG51bGw7DQogICAgCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdmdW5jdGlvbicpIHsNCiAgICAJCQlyZXQgPSBhd2FpdCBzY3JpcHQoKTsNCiAgICAJCX0NCiAgICANCiAgICAJCXJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmNsYXNzTmFtZSwgbSwgdHlwZSwgc2NyaXB0LCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCg0KICAgIDwlPW1OYW1lPSdfc2FtZUVudGl0eSclPiguLi5hckVudGl0aWVzKXsNCiAgICAgICAgaWYoYXJFbnRpdGllcy5sZW5ndGg9PTApIHJldHVybiBmYWxzZTsNCiAgICAgICAgaWYoYXJFbnRpdGllcy5sZW5ndGg9PTEpIGFyRW50aXRpZXMucHVzaCh0aGlzKTsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPiguLi5hckVudGl0aWVzKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldHVybiBhckVudGl0aWVzLnNsaWNlKDEpLmV2ZXJ5KGUgPT4gew0KICAgICAgICAgICAgICAgIGxldCB2ID0gYXJFbnRpdGllc1swXTsNCiAgICAgICAgICAgICAgICBsZXQgbmVnVGVzdCA9IHsNCiAgICAgICAgICAgICAgICAgICAgdk51bGw6IHY9PW51bGwsDQogICAgICAgICAgICAgICAgICAgIGVOdWxsOiBlPT1udWxsLA0KICAgICAgICAgICAgICAgICAgICB2T2JqZWN0OiB0eXBlb2YodikhPT0nb2JqZWN0JywNCiAgICAgICAgICAgICAgICAgICAgZU9iamVjdDogdHlwZW9mKGUpIT09J29iamVjdCcsDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MSwgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgaWYoT2JqZWN0LmtleXMoT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmtleXMobmVnVGVzdCkuZmlsdGVyKGsgPT4gbmVnVGVzdFtrXSkubWFwKGsgPT4gKHt2LCBlLCBba106IHRydWV9KSkpKS5sZW5ndGgpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAvLyBwYXNzZWQgaW5pdGlhbCBjb25zaXN0ZW5jeSBjaGVjaw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHY9PWUpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG5lZ1Rlc3QgPSB7DQogICAgICAgICAgICAgICAgICAgIGV2Q29uc3RyOiB2LmNvbnN0cnVjdG9yLm5hbWUhPWUuY29uc3RydWN0b3IubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgZUVudGl0eTogIWUuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICAgICAgICAgIHZFbnRpdHk6ICF2LkVudGl0eUNsYXNzLA0KICAgICAgICAgICAgICAgICAgICBldkVudGl0eU5hbWVzOiB0eXBlb2YoZS5FbnRpdHlDbGFzcy5OYW1lKSE9PSd1bmRlZmluZWQnICYmIGUuRW50aXR5Q2xhc3MuTmFtZSE9di5FbnRpdHlDbGFzcy5OYW1lLA0KICAgICAgICAgICAgICAgICAgICBldkVudGl0eUlkczogdHlwZW9mKGUuRW50aXR5Q2xhc3MuSWQpIT09J3VuZGVmaW5lZCcgJiYgZS5FbnRpdHlDbGFzcy5JZCE9di5FbnRpdHlDbGFzcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgZXZJRHM6IHYuSWQ9PXYuSWQgJiYgZS5JZD09ZS5JZCAmJiB2LklkIT1lLklkLA0KICAgICAgICAgICAgICAgICAgICBldkhhc2g6IHYuX3RvSGFzaChudWxsLCB7b25seVVuaXF1ZTogdHJ1ZX0sICc8JT1tTmFtZSU+JykhPWUuX3RvSGFzaChudWxsLCB7b25seVVuaXF1ZTogdHJ1ZX0sICc8JT1tTmFtZSU+JyksDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MiwgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgbmVnVGVzdCA9IE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5rZXlzKG5lZ1Rlc3QpLmZpbHRlcihrID0+IG5lZ1Rlc3Rba10pLm1hcChrID0+ICh7diwgZSwgW2tdOiB0cnVlfSkpKTsNCiAgICAgICAgICAgICAgICBpZighT2JqZWN0LmtleXMobmVnVGVzdCkubGVuZ3RoKSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+MywgbmVnVGVzdCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdnZXQgU2V0X09uJyU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgfHwgbnVsbCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0IHx8IG51bGwsDQo8JSB9KSU+DQogICAgICAgICkpOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPiJyZXQiLCByZXQpOw0KICAgICAgICANCiAgICAgICAgaWYoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nZ2V0IFNldF9Db3VudCclPigpIHsNCiAgICAgICAgcmV0dXJuIFsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCwNCjwlIH0pJT4gICAgICAgICAgICANCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgdGhpcy5fPCU9dGFOYW1lJT5fc2V0LA0KPCUgfSklPg0KICAgICAgICBdLmZpbHRlcihzID0+IHMpLmxlbmd0aDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mbGF0dGVuJyU+KGRlcHRoKXsNCiAgICAgICAgPCU9d2FybigpJT4iREVQUkVDQVRFRCIpOw0KICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgIGlmKCFkZXB0aCkgcmV0dXJuIHJldDsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgcmV0Ll88JT1uTmFtZShlYSklPl9zZXQgPSB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQ7DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgIHJldC48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKT90aGlzLjwlPW5OYW1lKGVhKSU+KCk8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oZGVwdGgtMSk8JX0lPjp0aGlzLjwlPW5OYW1lKGVhKSU+KCk7DQo8JSB9KSU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgcmV0LjwlPXRhTmFtZSU+ID0gdGhpcy48JT10YU5hbWUlPigpLm1hcCh0ID0+IHQ/dC48JT1tTmFtZSU+KGRlcHRoLTEpOnQpOw0KPCUgfSklPg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvSGFzaCclPihhcmdzLCBvcHRpb25zLCBmU291cmNlKXsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQogICAgICAgIA0KICAgICAgICBsZXQgb0hhc2ggPSB7DQogICAgICAgICAgICBjbGFzczogIjwlPW5OYW1lKGMpJT4iLA0KICAgICAgICAgICAgc291cmNlOiBmU291cmNlLA0KICAgICAgICAgICAgYXJnczogYXJncywNCiAgICAgICAgICAgIF90aGlzOiB7fQ0KICAgICAgICB9Ow0KICAgICAgICANCiAgICAgICAgaWYoIW9wdGlvbnMubm9UaGlzICYmIGZTb3VyY2UhPSI8JT1tTmFtZSU+IiAmJiAodHlwZW9mKG9wdGlvbnMuZGVwdGgpPT09J3VuZGVmaW5lZCcgfHwgLS1vcHRpb25zLmRlcHRoPjApKXsNCiAgICAgICAgICAgIHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsNCiAgICAgICAgICAgICAgICBPUEVSQVRPUlM6ICFvcHRpb25zLm5vT3BlcmF0b3JzLA0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuX21hcCwNCiAgICAgICAgICAgICAgICBVbmlxdWU6IG9wdGlvbnMub25seVVuaXF1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+aWYob3B0aW9ucy5ub1R5cGVzKSByZXR1cm47PCV9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSA8JSBpZihlYS5FbnRpdHlUeXBlKXslPnY/di48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpOjwlfSU+KChvcHRpb25zLm9ubHlVbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KT8odnx8bnVsbCk6dik7DQogICAgICAgICAgICAgICAgfSwNCjwlIH0pJT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KG51bGwsIG9wdGlvbnMsIGZTb3VyY2UpKSwNCjwlIH0pJT4NCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqW2VmQ29kZV0gPSB2LA0KPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYob3B0aW9ucy5ub0FyZ3MpIG9IYXNoID0gb0hhc2guX3RoaXM7DQogICAgICAgIHJldHVybiBvcHRpb25zLm5vQ29kZT9vSGFzaDp0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19hdXRob3JpemUnJT4odXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKXsNCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmICE8JT1zY29wZSU+Ll9fdG9rZW4gJiYgdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnVzZXJuYW1lJ10pew0KICAgICAgICAgICAgdXNlcm5hbWUgPSB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udXNlcm5hbWUnXTsNCiAgICAgICAgICAgIHBhc3N3b3JkID0gdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnBhc3N3b3JkJ107DQogICAgICAgIH0NCg0KICAgICAgICBpZihiU2VydmVyKXsNCiAgICAgICAgICAgIGlmKHVzZXJuYW1lICYmICE8JT1zY29wZSU+Ll90ZXN0VXNlciAmJiB0aGlzLlRlc3RbJzwlPW1OYW1lJT4udGVzdFVzZXInXSl7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdGVzdFVzZXIgPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCh0aGlzLlRlc3RbJzwlPW1OYW1lJT4udGVzdFVzZXInXSkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS5zdG9yZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMudXNlcm5hbWUodXNlcm5hbWUsICc9JykucGFzc3dvcmQocGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZXJ2ZXI6ICIgKyBiU2VydmVyKyIsIE9iajoiLCByZXQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihyZXQpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihqc29ud2VidG9rZW4pIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICByZXQgPSBqc29ud2VidG9rZW4uc2lnbihyZXQuX3RvRG9jdW1lbnQoKSwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIHsgZXhwaXJlc0luOiAnMTgwMHMnIH0pOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXQgPSB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJldC5fdG9Eb2N1bWVudCgpKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiByZXQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZXJ2ZXI6ICIgKyBiU2VydmVyKyIsIHRva2VuOiAiLCByZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBsZXQgY2xpZW50X2lkID0gdGhpcy5fX2NvbmZpZygnY2xpZW50X2lkJyk7DQogICAgICAgICAgICBsZXQgY2xpZW50X3NlY3JldCA9IHRoaXMuX19jb25maWcoJ3NlY3JldCcpOw0KICAgIA0KICAgICAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiA8JT1zY29wZSU+Ll9fdG9rZW4pew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iTm8gdXNlcm5hbWUvcGFzc3dvcmQgYW5kIHRva2VuIGFscmVhZHkgZXhpc3RzIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgPCVpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICBsZXQgZGF0YSA9IHsNCiAgICAgICAgICAgICAgICBncmFudF90eXBlOiAncGFzc3dvcmQnLA0KICAgICAgICAgICAgICAgIHVzZXJuYW1lLA0KICAgICAgICAgICAgICAgIHBhc3N3b3JkLA0KICAgICAgICAgICAgICAgIGNsaWVudF9pZCwNCiAgICAgICAgICAgICAgICBjbGllbnRfc2VjcmV0LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgICAgICBpZighdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIDwlPXNjb3BlJT4uX190b2tlbiAmJiA8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbil7DQogICAgICAgICAgICAgICAgZGF0YSA9IHsNCiAgICAgICAgICAgICAgICAgICAgZ3JhbnRfdHlwZTogInJlZnJlc2hfdG9rZW4iLA0KICAgICAgICAgICAgICAgICAgICByZWZyZXNoX3Rva2VuOiA8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbiwNCiAgICAgICAgICAgICAgICAgICAgY2xpZW50X2lkLA0KICAgICAgICAgICAgICAgICAgICBjbGllbnRfc2VjcmV0LA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAkezwlPXNjb3BlJT4uX190b2tlbi50b2tlbl90eXBlfSAkezwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW59YDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAkezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLnNlY3VyZSgpPydzJzonJ306Ly8kezwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLmFkZHJlc3MoKX06JHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5wb3J0KCkgfHwgMzAwMH0vb2F1dGgvdG9rZW5gLCBPYmplY3Qua2V5cyhkYXRhKS5tYXAoa2V5ID0+IGtleSArICc9JyArIGRhdGFba2V5XSkuam9pbignJicpLCBjb25maWcpOw0KICAgICAgICAgICAgaWYocmV0LmRhdGEuYWNjZXNzX3Rva2VuKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fdG9rZW4gPSByZXQuZGF0YTsNCg0KICAgICAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX190b2tlbi5yZWZyZXNoX3Rva2VuKXsNCiAgICAgICAgICAgICAgICAgICAgaWYoYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLmNsZWFyKSBheGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UuY2xlYXIoKTsNCiAgICAgICAgICAgICAgICAgICAgYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShyZXNwb25zZSA9PiByZXNwb25zZSwgYXN5bmMgZXJyb3IgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxICYmICFvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ICYmIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24uaW5kZXhPZig8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VuKT4wKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fYXV0aG9yaXplKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9ICdCZWFyZXIgJyArIDwlPXNjb3BlJT4uX190b2tlbi5hY2Nlc3NfdG9rZW47DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYoYXV0aENsYXNzKXslPg0KICAgIAk8JT1zY29wZSU+Ll9fdG9rZW4gPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShhdXRoQ2xhc3MpJT4oKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLjwlPW1OYW1lLnJlcGxhY2UoJ18nLCAnJyklPigpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIDwlPXdhcm4oKSU+Ik5vIGF1dGhvcml6YXRpb24gZGVmaW5lZCIpOw0KICAgIDwlIH0lPg0KICAgICAgICB9DQo8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7DQo8JX0lPg0KICAgIH0NCiAgICANCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfc2VydmVyJyU+KG9wdGlvbnM9e30pIHsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYob3B0aW9ucy5jbGVhckNvbnNvbGUpIGNvbnNvbGUuY2xlYXIoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fX1Rvb2xzKSA8JT1zY29wZSU+LlRvb2xzID0gPCU9c2NvcGUlPi5fX1Rvb2xzOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKT09PSd1bmRlZmluZWQnICYmIHR5cGVvZig8JT1zY29wZSU+LmhyZWZzKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgPCU9c2NvcGUlPi5ocmVmcykgew0KICAgICAgICAJCQlhd2FpdCB0aGlzLnJlcXVpcmUobC5saWIsIDwlPXNjb3BlJT4uaHJlZnMsIGFzeW5jIF9sID0+IHsNCiAgICA8JSBpZihfY05hbWUoJ1N0b3JlZFNjcmlwdCcpKXslPg0KICAgICAgICAgICAgICAgICAgICBpZihfbC5zY3JpcHQgJiYgPCU9c2NvcGUlPi5Ub29scykgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU3RvcmVkU2NyaXB0JywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX2wuc2NyaXB0KS5sb2FkU2NyaXB0KCk7DQogICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgIGxldCBzZWN1cmUgPSB0aGlzLl9fY29uZmlnKCdzZWN1cmUnKTsNCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIC8vIGdsb2JhbHMNCiAgICAgICAgICAgICAgICB2YXIgZ2xvYmFsTW9kdWxlcyA9IHsNCiAgICAgICAgICAgICAgICAgICAgZXhwcmVzczogJ2V4cHJlc3MnLA0KICAgICAgICAgICAgICAgICAgICBodHRwczogJ2h0dHBzJywNCiAgICAgICAgICAgICAgICAgICAgaHR0cDogJ2h0dHAnLA0KICAgICAgICAgICAgICAgICAgICBzZWxmc2lnbmVkOiAnc2VsZnNpZ25lZCcsDQogICAgICAgICAgICAgICAgICAgIHV0aWw6ICd1dGlsJywNCiAgICAgICAgICAgICAgICAgICAgY29yczogJ2NvcnMnLA0KICAgICAgICAgICAgICAgICAgICBib2R5UGFyc2VyOiAnYm9keS1wYXJzZXInLA0KICAgICAgICAgICAgICAgICAgICBheGlvczogJ2F4aW9zJywNCiAgICAgICAgICAgICAgICAgICAgLy9jcnlwdG86ICdjcnlwdG8nLA0KICAgICAgICAgICAgICAgICAgICBvczogJ29zJywNCiAgICAgICAgICAgICAgICAgICAgLy9qbWVzcGF0aDogJ2ptZXNwYXRoJywNCiAgICAgICAgICAgICAgICAgICAganNvbnBhdGg6ICdqc29ucGF0aCcsDQogICAgICAgICAgICAgICAgICAgIGpzb25hdGE6ICdqc29uYXRhJywNCiAgICAgICAgICAgICAgICAgICAgRG90T2JqZWN0OiAnZG90LW9iamVjdCcsDQogICAgICAgICAgICAgICAgICAgIG1hY2hpbmVpZDogJ25vZGUtbWFjaGluZS1pZCcsDQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtaW5pbWlzdDogJ21pbmltaXN0JywNCiAgICAgICAgICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgICAgIGdyYXBocWxIVFRQOiAnZXhwcmVzcy1ncmFwaHFsJywNCiAgICAgICAgICAgICAgICAgICAgZ3JhcGhxbDogJ2dyYXBocWwnLA0KICAgICAgICAgICAgICAgICAgICBwbGF5Z3JvdW5kOiAnZ3JhcGhxbC1wbGF5Z3JvdW5kLW1pZGRsZXdhcmUtZXhwcmVzcycsDQo8JSB9JT4NCg0KPCUgaWYoYy5Db25maWcgJiYgYy5Db25maWdbJ2VtYWlsLmhvc3QnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbm9kZW1haWxlcjogJ25vZGVtYWlsZXInLA0KPCUgfSU+DQoNCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWyd0b3RwLnNlY3JldCddKXslPg0KICAgICAgICAgICAgICAgICAgICBvdHBhdXRoOiAnb3RwYXV0aCcsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgICAgICAgICAgICAgIGNoaWxkX3Byb2Nlc3M6ICdjaGlsZF9wcm9jZXNzJywNCjwlIH0lPg0KDQo8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgICAgICAgICAgICAgICAgIGV2ZW50czogJ2V2ZW50cycsDQogICAgICAgICAgICAgICAgICAgIHNvY2tldGlvOiAnc29ja2V0LmlvJywNCiAgICAgICAgICAgICAgICAgICAgbXF0dDogJ21xdHQnLA0KICAgICAgICAgICAgICAgICAgICBhbXFwbGliOiAnYW1xcGxpYicsDQogICAgICAgICAgICAgICAgICAgIHByb3RvYnVmanM6ICdwcm90b2J1ZmpzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBmczogJ2ZzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydLYWZrYSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAga2Fma2FqczogJ2thZmthanMnLA0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBuZW80ajogJ25lbzRqLWRyaXZlcicsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgICAgICAgICBPQXV0aFNlcnZlcjogJ2V4cHJlc3Mtb2F1dGgtc2VydmVyJywNCjwlIH1lbHNlIGlmKGF1dGhDbGFzcyl7JT4NCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuOiAnanNvbndlYnRva2VuJywNCjwlIH0lPg0KDQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NxbERCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBzcWxpdGU6ICdzcWxpdGUzJywNCiAgICAgICAgICAgICAgICAgICAgbXlzcWw6ICdteXNxbCcsDQogICAgICAgICAgICAgICAgICAgIHBvc3RncmVzOiAncGcnLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydTbm93Rmxha2UnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIHNub3dmbGFrZTogJ3Nub3dmbGFrZS1zZGsnLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydNb25nb0RCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBtb25nb2RiOiAnbW9uZ29kYicsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ1J4REInXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIFJ4REI6ICdyeGRiJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnRXhjZWwnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIFhMU1g6ICd4bHN4JywNCjwlIH0lPg0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgbWlzc2luZ0dsb2JhbE1vZHVsZXMgPSBPYmplY3QuZW50cmllcyhnbG9iYWxNb2R1bGVzKS5tYXAoZSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbFtlWzBdXSA9IHJlcXVpcmUoZVsxXSk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlWzFdOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSkuZmlsdGVyKGUgPT4gZSk7DQogICAgICAgICAgICAgICAgaWYobWlzc2luZ0dsb2JhbE1vZHVsZXMubGVuZ3RoKSA8JT13YXJuKCklPiJucG0gaW5zdGFsbCAiICsgbWlzc2luZ0dsb2JhbE1vZHVsZXMuam9pbignICcpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgIAkJPCU9bG9nKCklPmBTdGFydGluZyBbJHs8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCk6Jyd9XS4uLmApOw0KDQoJCQlpZiAob3B0aW9ucy5sb2FkVG9vbHMpIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpIHx8IF9jTmFtZSgpJT4oKS5fbG9hZFRvb2xzKG9wdGlvbnMuc2F2ZVRvb2xzKTsNCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyAgLyogVG9vbHMgZmlyc3Qgb3IgTm9kZXMgZmlyc3Q/Pz8gKi8lPg0KICAgICAgICAgICAgaWYob3B0aW9ucy5pbml0Tm9kZSl7DQogICAgICAgICAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUgPSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuc2VjdXJlKHNlY3VyZSkuaW5pdCh0aGlzLl9fY29uZmlnKCdpbml0Lmxvb3AnLCAwLjUpKTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9bnNjb3BlJT4uX25vZGUpPT09J3VuZGVmaW5lZCcpIHJldHVybiA8JT1lcnJvcigpJT4iPCU9bnNjb3BlJT4uX25vZGUgaXMgdW5kZWZpbmVkISIpOw0KICAgICAgICAgICAgfQ0KPCUgfSU+DQoNCiAgICAJCWlmICh0eXBlb2YodGhpcy5pbml0KT09PSdmdW5jdGlvbicgJiYgb3B0aW9ucy5pbml0U2VsZikgew0KICAgIAkJCWF3YWl0IHRoaXMuaW5pdCgpOw0KICAgIA0KICAgIAkJCWxldCBzcWxUb29sID0gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Ll9fZG1sU3RhdGVtZW50cyk7DQogICAgCQkJaWYgKG9wdGlvbnMuY29weURNTCAmJiBzcWxUb29sKSB7DQogICAgCQkJCWxldCBkbWxzID0gc3FsVG9vbC5fX2RtbFN0YXRlbWVudHM7DQogICAgCQkJCWlmIChzcWxUb29sLnR5cGUubmFtZSA9PSAnU3FsREInKSBkbWxzID0gWyAvKiJDdXN0b21lcnMiLCAiT3JkZXJzIiwgIlNoaXBwaW5ncyIsICovICJkZW1vIl0ubWFwKHQgPT4gYGRyb3AgdGFibGUgaWYgZXhpc3RzICR7dH1gKS5jb25jYXQoZG1scyk7DQogICAgCQkJCV9GckVNRC5fY29weVRleHRUb0NsaXBib2FyZChkbWxzLmpvaW4oJztcbicpKTsNCiAgICAJCQl9DQogICAgCQl9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZSBUeXBlJykpeyAvKnRvZG86IHJlcGxhY2UgdGhpcyB3aXRoIGFuIE9UQVVwZGF0ZSBjb25jZXB0ICovJT4NCiAgICAgICAgICAgIC8vIHJlZnJlc2ggc2NyaXB0DQogICAgICAgICAgICB0aGlzLnNldEludGVydmFsKG51bGwsIGFzeW5jICgvKnZlcnNpb24qLykgPT4gew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuc3IoKS5iTG9jYWwpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc2N0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlIFR5cGUnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCg8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+IHx8IHtuYW1lOiAnTm9kZUpTJ30pOw0KICAgICAgICAgICAgICAgIGxldCBjdCA9IGF3YWl0IHNjdC5maW5kKCk7DQogICAgICAgICAgICAgICAgaWYoIWN0IHx8ICFjdC5hY3RpdmUoKSB8fCAhY3QuZW5hYmxlZCgpKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYoICFzY3QuZGF0ZSgpIHx8ICgoY3QuZGF0ZSgpLmdldFRpbWUoKSAtIHNjdC5kYXRlKCkuZ2V0VGltZSgpKS8xMDAwKSA+IDUgKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBOZXdlciB2ZXJzaW9uIGZvdW5kOiBbZGF0ZTogJHtjdC5kYXRlKCkudG9JU09TdHJpbmcoKX0sIHRvb2w6ICR7Y3QuVG9vbC5uYW1lfV0sIHN0b3JpbmcuLi5gKTsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB3YW50IHRvIHN0b3JlIHRoZSBjb250ZW50IGRpcmVjdGx5IHRvIHRoZSBub2RlanMuanMgZmlsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgY3QuX2ZpbGVzeXN0ZW0oY3QuY29kZSgpICsgJy5qcycsIHRoaXMuX2F0b2IoY3QucmVtYXJrKCkpKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYod2luZG93LnNlbGYgIT09IHdpbmRvdy50b3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ImlGcmFtZSBzaG91bGQgYmUgcmVzdGFydGVkLi4uIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4id2luZG93IGxvY2F0aW9uIHJlbG9hZGluZy4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3dpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJmcmFtZSBjaGVjayIsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fPCU9X2NOYW1lKCdOb2RlIFR5cGUnKSU+ID0gc2N0LmRhdGUoY3QuZGF0ZSgpKS5uYW1lKGN0Lm5hbWUoKSkuY29kZShjdC5jb2RlKCkpLl90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9LCAwLjUpOw0KPCUgfSU+DQogICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5sb2FkQ29udGVudCAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSB3aW5kb3cub25oYXNoY2hhbmdlID0gYXN5bmMgKCkgPT4gZG9jdW1lbnQuYm9keSA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7dG1wOiBsb2NhdGlvbi5oYXNoLnBhZ2V9KTsNCiAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGNvcnMoKSk7DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHtleHRlbmRlZDogdHJ1ZSwgbGltaXQ6ICc1MG1iJ30pKTsNCiAgICAgICAgICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7DQogICAgICAgICAgICAgICAgICAgIHZlcmlmeTogKHJlcSwgcmVzLCBidWYpID0+IHJlcS5yYXdCb2R5ID0gYnVmDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVyc1snYXV0aG9yaXphdGlvbiddOw0KICAgICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAganNvbndlYnRva2VuLnZlcmlmeSh0b2tlbiwgdGhpcy5fX2NvbmZpZygnc2VjcmV0JyksIChlcnIsIG9iaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQo8JSBpZihfY05hbWUoJ29BdXRoIFRva2VuJykpeyU+DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoID0gbmV3IE9BdXRoU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgZGVidWc6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIHVzZUVycm9ySGFuZGxlcjogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWVNaWRkbGV3YXJlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyByZXF1aXJlQ2xpZW50QXV0aGVudGljYXRpb246IHsgcGFzc3dvcmQ6IGZhbHNlIH0sDQogICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBtb2RlbDogKCgpID0+ICh7DQogICAgICAgICAgICAgICAgCQlnZXRBY2Nlc3NUb2tlbjogYmVhcmVyVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5hY2Nlc3NUb2tlbihiZWFyZXJUb2tlbikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0QWNjZXNzVG9rZW4nKSkudGhlbih0ID0+IHt0LmFjY2Vzc1Rva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5hY2Nlc3NUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICBnZXRDbGllbnQ6IChjbGllbnRJZCwgY2xpZW50U2VjcmV0KSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pbml0KCkuZmluYWxseSgoKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZChjbGllbnRJZCkuc2VjcmV0KGNsaWVudFNlY3JldCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldENsaWVudCcpKSwNCiAgICAgICAgICAgICAgICAJICAgIGdldFVzZXI6ICh1c2VybmFtZSwgcGFzc3dvcmQpID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGF1dGhDbGFzcyklPigpLmF1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnZ2V0VXNlcicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHNhdmVUb2tlbjogKHRva2VuLCBjbGllbnQsIHVzZXIpID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuX2Zyb21Eb2N1bWVudCh0b2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLl9mcm9tRG9jdW1lbnQoY2xpZW50KSkudXNlcih1c2VyKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdG9yZSgpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAnc2F2ZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgcmV2b2tlVG9rZW46IHRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkucmVmcmVzaFRva2VuKHRva2VuLnJlZnJlc2hUb2tlbikuY2xpZW50KG5ldyA8JT1zY29wZSU+Lk9BdXRoX0NsaWVudCgpLmlkKHRva2VuLmNsaWVudC5pZCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkpLmZpbmQoKS50aGVuKHQgPT4gdC5lbmFibGVkKGZhbHNlKS5hY3RpdmUoZmFsc2UpLnN0b3JlKCkpLnRoZW4odCA9PiBhcHAub2F1dGguaGFuZGxlcih0LCAncmV2b2tlVG9rZW4nKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRSZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoMi8qd2h5Ki8pLnRoZW4odCA9PiB0Ll90b0RvY3VtZW50KCkpLnRoZW4odCA9PiB7dC5yZWZyZXNoVG9rZW5FeHBpcmVzQXQgPSBuZXcgRGF0ZSh0LnJlZnJlc2hUb2tlbkV4cGlyZXNPbik7IHJldHVybiB0fSksDQogICAgICAgIAkgICAgICAgIH0pKSgpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgYXBwLm9hdXRoLmhhbmRsZXIgPSAodCwgbSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtKSA8JT1sb2coKSU+bSwgdC5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Ll90b0RvY3VtZW50KCk7DQogICAgICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPm0sIGV4LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9vYXV0aC90b2tlbicsIGFwcC5vYXV0aC50b2tlbigpKTsNCiAgICAgICAgICAgICAgICBnbG9iYWwuYXV0aGVudGljYXRlID0gYXBwLm9hdXRoLmF1dGhlbnRpY2F0ZSgpOw0KPCUgfSU+DQoNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gbS5Jc1B1YmxpYykuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzwlPW5OYW1lKF9jKSU+LzwlPW5OYW1lKG0pJT4nLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiPCU9bk5hbWUoX2MpJT4iLCAiPCU9bk5hbWUobSklPiIpKTsNCjwlIH0pKSU+DQoNCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgICAgICAgICBhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOw0KICAgICAgICANCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydncmFwaHFsJ10peyU+DQogICAgICAgICAgICAgICAgYXBwLnVzZSgnL2dyYXBocWwnLCBncmFwaHFsSFRUUC5ncmFwaHFsSFRUUCh7DQogICAgICAgICAgICAgICAgICAgIHNjaGVtYTogZ3JhcGhxbC5idWlsZFNjaGVtYSh0aGlzLl90b0dRTFNjaGVtYSgpKSwNCiAgICAgICAgICAgICAgICAgICAgcm9vdFZhbHVlOiB0aGlzLl9xbFJlc29sdmVyKCksDQogICAgICAgICAgICAgICAgICAgIGdyYXBoaXFsOiB0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIiksDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoInBsYXlncm91bmQiKSAmJiB0eXBlb2YocGxheWdyb3VuZCkhPT0idW5kZWZpbmVkIikgYXBwLmdldCgnL3BsYXlncm91bmQnLCBwbGF5Z3JvdW5kLmRlZmF1bHQoeyBlbmRwb2ludDogJy9ncmFwaHFsJyB9KSkNCjwlIH0lPg0KDQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6IHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKT97DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksDQogICAgICAgICAgICAgICAgICAgICAgICB9OnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAgICBhd2FpdCA8JT1zY29wZSU+LnRyYW5zcG9ydGVyLnNlbmRNYWlsKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdG8sDQogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwb3J0ID0gPCU9bnNjb3BlJT4uX25vZGU/KDwlPW5zY29wZSU+Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKTozMDAwOw0KICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gIjAuMC4wLjAiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiA8JT1sb2coKSU+YDwlPXNjb3BlJT5bJHt0aGlzLmlwQWRkcmVzcygpfV0gbGlzdGVuaW5nIGF0IGh0dHAke3NlY3VyZT8ncyc6Jyd9Oi8vJHthZGRyZXNzfToke3BvcnR9YCk7DQogICAgICAgICAgICAgICAgaWYoc2VjdXJlKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNlcnQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZTogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gc2VsZnNpZ25lZC5nZW5lcmF0ZShbeyBuYW1lOiAnY29tbW9uTmFtZScsIHZhbHVlOiAnbmFtbW91ci5jb20nIH1dLCB7IGRheXM6IDM2NSB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwcy5jcmVhdGVTZXJ2ZXIoew0KICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBjZXJ0LnByaXZhdGUsDQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0OiBjZXJ0LmNlcnQNCiAgICAgICAgICAgICAgICAgICAgfSwgYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW5ib3VuZENhbGwnJT4ocmVxLCByZXMsIGNOYW1lLCBtTmFtZSl7DQogICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IDwlPXNjb3BlJT5bcmVxLnBhcmFtcy5jbGFzcyB8fCBjTmFtZV0oKS5faW52b2tlKHJlcS5wYXJhbXMubWV0aG9kIHx8IG1OYW1lLCByZXEuYm9keSwgcmVxLnF1ZXJ5LCByZXEuX19hdXRob3JpemF0aW9uKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBFeGNlcHRpb246ICJFeGNlcHRpb246ICIgKyBleCwNCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgdHlwZW9mKHJldCk9PT0ibnVtYmVyIikgcmV0ID0gcmV0LnRvU3RyaW5nKCk7DQogICAgICAgIHJlcy5zZW5kKHJldCk7DQogICAgfQ0KDQo8JSBpZihjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgIDwlPW1OYW1lPSdfcWxTZWxlY3Rpb25zJyU+KHNTZXQpew0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIGlmKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7DQogICAgICAgIA0KICAgICAgICBzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHMubmFtZS52YWx1ZT09IjwlPW5OYW1lKGVhKSU+Iil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPidSZWZlcmVuY2UgZm9yIDwlPW5OYW1lKGVhKSU+Jywgcyk7DQogICAgICAgICAgICAgICAgbGV0IHNPYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bk5hbWUoZWEpJT5fPCU9Yy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpJT4odGhpcyk7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goc09iaik7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19xbFJlc29sdmVyJyU+KCl7DQogICAgICAgIHJldHVybiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKF9jKSU+OiBhc3luYyAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXBhcmVudC5kYXRhKSBwYXJlbnQucXVlcnkgPSBwYXJlbnQucXVlcnkgfHwge307DQogICAgICAgICAgICAgICAgbGV0IG9iaiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuX2Zyb21Eb2N1bWVudChwYXJlbnQucXVlcnkgfHwgcGFyZW50LmRhdGEpOw0KICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKHBhcmVudC5xdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZHMgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouZmluZEFsbChudWxsLCBvYmouX3FsU2VsZWN0aW9ucyhjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0KSwgbnVsbCwgbnVsbCwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0uY29uY2F0KGNvbnRleHQuZmllbGROb2Rlc1swXS5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucy5tYXAocyA9PiBzLm5hbWUudmFsdWUpKSk7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYocGFyZW50LmRhdGEpew0KICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBvYmouc3RvcmUoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYob2JqLl9fYXNzZXJ0RXJyb3IpIHRocm93IG9iai5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0Lm1hcChyID0+IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ/cmV0Ll90b0RvY3VtZW50KCk6cmV0Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5mb3JFYWNoKF9tID0+IHslPg0KICAgICAgICAgICAgLy8gPCU9bk5hbWUoX20pJT46IChwYXJlbnQsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKF9jKSU+KCkuPCU9bk5hbWUoX20pJT4oIjwlPW5OYW1lKF9tKSU+IiwgcGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSwNCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgIH07DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9HUUxTY2hlbWEnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IGANCnR5cGUgUXVlcnkgew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgRmluZCBhbGwgbWF0Y2hlcyBmb3IgPCU9bk5hbWUoX2MpJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihxdWVyeTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IFs8JT1uTmFtZShfYyklPl0NCjwlIH0pJT4NCn0NCg0KdHlwZSBNdXRhdGlvbiB7DQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAiIiINCiAgICBTdG9yZSBhIHNpbmdsZSA8JT1uTmFtZShfYyklPiBvYmplY3QNCiAgICAiIiINCiAgICA8JT1uTmFtZShfYyklPihkYXRhOiA8JT1uTmFtZShfYyklPklucHV0KTogPCU9bk5hbWUoX2MpJT4NCjwlIH0pJT4NCn0NCiAgICANCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiIiIg0KSW5wdXQgdHlwZSBmb3IgPCU9bk5hbWUoX2MpJT4NCiIiIg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5JbnB1dHsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEsIHRydWUpJT4NCiAgICA8JSB9KSU+DQogICAgPCUgX2MuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kICYmIHRhLkVudGl0eVR5cGUpLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsgJT4NCiAgICA8JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjogWzwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+SW5wdXRdDQogICAgPCUgfSklPg0KICAgIE9QRVJBVE9SUzogPCU9bk5hbWUoX2MpJT5PcGVyYXRvcg0KfQ0KDQppbnB1dCA8JT1uTmFtZShfYyklPk9wZXJhdG9yew0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bk5hbWUoZWEpJT46IFN0cmluZw0KICAgIDwlIH0pJT4NCn0NCg0KIiIiDQo8JT1fYy5SZW1hcmslPg0KIiIiDQp0eXBlIDwlPW5OYW1lKF9jKSU+ew0KICAgIF9pZDogSUQhDQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1lYS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKGVhKSU+OiA8JT1xbFR5cGUoZWEpJT48JT1lYS5Jc1JlcXVpcmVkPychJzonJyU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPl0NCiAgICA8JSB9KSU+DQoNCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiAhX20uTWV0aG9kUGFyYW1ldGVycy5sZW5ndGgpLmZvckVhY2goX20gPT4geyU+DQogICAgIiIiDQogICAgPCU9X20uUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShfbSklPjogPCU9cWxUeXBlKF9tLlJlc3BvbnNlQXR0cmlidXRlLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZmlsdGVyKF9tID0+IF9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT4oPCU9X20uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuTmFtZShwKSArICc6ICcgKyBxbFR5cGUocCwgdHJ1ZSkpLmpvaW4oJywgJyklPik6IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSklPg0KICAgIDwlIH0pJT4NCn0NCiAgICA8JSB9KSU+DQogICAgICAgIGA7DQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gLy8gZ3JhcGglPg0KDQo8JSB9IC8vIElzTWFpbiAlPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2VOb2RlJyU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsNCiAgICAgICAgLy8gaWYoIW4pIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKDwlPW5zY29wZSU+Ll9ub2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5zY29wZSU+Ll9ub2RlIG5vdCBkZWZpbmVkIik7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoZXZlbnQpew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkhPSc8JT1uTmFtZShjKSU+Jyl7DQogICAgICAgICAgICAgICAgbGV0IG9DbGFzcyA9IG51bGw7DQogICAgICAgICAgICAgICAgaWYoZmFsc2Upew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkrJy4nK21ldGhvZCsnIC4uLi4nKTsNCiAgICA8JSBzci5ncm91cEJ5KGFyQ2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLmZvckVhY2goZW0gPT4geyU+DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoWyI8JT1lbS52YWx1ZXMubWFwKG1jID0+IG5OYW1lKG1jKSkuam9pbignIiwgIicpJT4iXS5pbmRleE9mKGV2ZW50LmNsYXNzTmFtZSgpKT49MCl7DQogICAgICAgICAgICAgICAgICAgIG9DbGFzcyA9IG5ldyA8JT1zY29wZSU+PCU9ZW0ua2V5PygnLicrZW0ua2V5LkFsaWFzKTonJyU+W2V2ZW50LmNsYXNzTmFtZSgpXSgpOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG9DbGFzcy48JT1tTmFtZSU+KG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOw0KICAgICAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIDwlPWVycm9yKCklPiJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQoNCiAgICAgICAgZGF0YSA9IGRhdGEgfHwge307DQoNCiAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0pTT04oe3BhcnNlOiAxfSk7DQogICAgICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCiAgICA8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIGRhdGEuPCU9bk5hbWUocCklPiA9IGRhdGEuPCU9bk5hbWUocCklPj9kYXRhLjwlPW5OYW1lKHApJT4NCiAgICAgICAgICAgIDwlaWYocC5Jc0FycmF5KXslPi5tYXAoX3AgPT4gX3A8JX0lPg0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPi5fdG9Eb2N1bWVudCgpDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihwLklzRGF0ZSl7JT4udG9JU09TdHJpbmcoKQ0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4pPCV9JT46dW5kZWZpbmVkOw0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgIGlmKHR5cGVvZihuKT09PSdzdHJpbmcnKSBuID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLmNvZGUobik7DQo8JSB9JT4NCg0KICAgICAgICBpZighbiB8fCA8JT1uc2NvcGUlPi5fbm9kZS5fc2FtZUVudGl0eShuKSl7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iTG9jYWwgbm9kZSIsIHJldCk7DQoNCiAgICAgICAgfWVsc2UgaWYobi5hZGRyZXNzKCkpew0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5uLmFkZHJlc3MoKSwgbi5wb3J0KCksIG1ldGhvZCk7DQogICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdCh1bmRlZmluZWQsIGRhdGEsIG51bGwsIG51bGwsIHtwYXRoOiBgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvPCU9bk5hbWUoYyklPi8ke21ldGhvZH1gLCBoZWFkZXJzOiB7fX0pOw0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICB9DQogICAgICAgIH1lbHNlew0KPCUgaWYoX2NOYW1lKCdFdmVudCcpICYmIGMuTmFtZSE9PSdFdmVudCcpeyU+DQogICAgICAgICAgICBpZih0eXBlb2YoZGF0YSk9PT0ib2JqZWN0Iil7DQogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOw0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/Pw0KICAgICAgICAgICAgPCUgLyp1blJlY3Vyc2UoJ2RhdGEnLCAnbWV0aG9kJywgJ3t9JywgJycsIDUsICdfX3RoaXMuY29kZScpKi8gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGV2ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICc8JT1zY29wZSU+LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnPCU9bk5hbWUoYyklPicpLnNlbmRlcig8JT1uc2NvcGUlPi5fbm9kZSkuY2Fycmllcig8JT1uc2NvcGUlPi5fbm9kZSkucGF5bG9hZCh0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7DQogICAgICAgICAgICBpZihldmVudCl7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7DQogICAgICAgICAgICAgICAgaWYoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gSlNPTi5wYXJzZShyZXQpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2UgaWYocmV0ICYmIHR5cGVvZihyZXQucGF5bG9hZCk9PT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICAvLyByZXQgaXMgYW4gZXZlbnQNCiAgICAgICAgICAgICAgICByZXQgPSByZXQucGF5bG9hZCgpOw0KICAgICAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShyZXQpICYmIHJldFswXSAmJiB0eXBlb2YocmV0WzBdLnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0Lm1hcChyID0+IHIucGF5bG9hZCgpKTsNCiAgICAgICAgICAgICAgICBpZihyZXQubGVuZ3RoPT0xKSByZXQgPSByZXRbMF07DQogICAgICAgICAgICB9DQo8JSB9JT4NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoIXJldCkgcmV0dXJuIG51bGw7DQogICAgICAgIHJldCA9IHJldC5kYXRhIHx8IHJldDsNCg0KICAgICAgICBpZihyZXQuX19leGNlcHRpb24pew0KICAgICAgICAgICAgLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXINCiAgICAgICAgICAgIDwlPWVycm9yKCklPmBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9DQoNCiAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgY2FzZSAiPCU9bkNvZGUobSklPiI6IHsNCiAgICA8JSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgIDwlIH0gJT4NCiAgICA8JSBpZihtLk5hbWU9PSdhdXRob3JpemUnKXslPg0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190b2tlbiA9IHt0b2tlbl90eXBlOiAiQmVhcmVyIiwgYWNjZXNzX3Rva2VuOiByZXR9Ow0KICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyAlPg0KDQogICAgICAgICAgICBjYXNlICJpbnNlcnQiOg0KICAgICAgICAgICAgY2FzZSAidXBkYXRlIjoNCiAgICAgICAgICAgIGNhc2UgInN0b3JlIjoNCiAgICAgICAgICAgIGNhc2UgImRlbGV0ZSI6DQogICAgICAgICAgICBjYXNlICJmaW5kIjogDQogICAgICAgICAgICBjYXNlICJmaW5kQWxsIjogew0KICAgICAgICAgICAgICAgIGlmKCFiUmF3KSByZXQgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChyZXQpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KPCUgaWYobWFpbkNsYXNzKCkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19pbnZva2UnJT4obWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iail7DQogICAgICAgIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMpJT4uJyArIG1ldGhvZCk7DQogICAgICAgIDwlPWxvZygpJT5tZXRob2QsIHF1ZXJ5LCBib2R5KTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihib2R5KT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdib2R5JyklPil7IC8vIGJhc2U2ND8NCiAgICAgICAgICAgICAgICBib2R5ID0gdGhpcy5fYXRvYihib2R5KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoL1teLDp7fVxbXF0wLTkuXC0rRWFlZmxuci11IFxuXHJcdF0vLnRlc3QoYm9keSkpeyAvLyBqc29uDQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IF9wYXJhbXMgPSBxdWVyeT9PYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KTpib2R5Ow0KICAgICAgICBpZih0eXBlb2YoX3BhcmFtcyk9PT0nc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7DQogICAgICAgIA0KICAgICAgICBpZihfcGFyYW1zKXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIF9wYXJhbXMgPSB7fTsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPWxvZygpJT4iX3BhcmFtcyIsIF9wYXJhbXMpOw0KDQogICAgPCUgaWYoX2NOYW1lKCdOb2RlJykgJiYgYy5OYW1lIT0nTm9kZScpeyU+DQogICAgICAgIGlmKF9wYXJhbXMuX19ub2RlKXsNCiAgICAgICAgICAgIC8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/DQogICAgICAgICAgICBsZXQgdG4gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkvKi5fZGVSZWZlcmVuY2UoKSovOw0KICAgICAgICAgICAgZGVsZXRlIF9wYXJhbXMuX19ub2RlOw0KICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCg0KICAgICAgICBpZihfcGFyYW1zLl9fdGhpcykgew0KICAgICAgICAgICAgX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsNCiAgICAgICAgICAgIGxldCBfX3RoaXMgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLyouX2RlUmVmZXJlbmNlKCkqLzsNCiAgICAgICAgICAgIGRlbGV0ZSBfcGFyYW1zLl9fdGhpczsNCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBfX3RoaXMuPCU9bU5hbWUlPihtZXRob2QsIF9wYXJhbXMsIG51bGwsIGF1dGhPYmopOw0KICAgICAgICB9DQoNCiAgICAgICAgbGV0IGFyQXJncyA9IFtdOw0KICAgICAgICBzd2l0Y2gobWV0aG9kKXsNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KPCUgaWYoX2NOYW1lKCdUcmFuc2FjdGlvbicpICYmIF9jTmFtZSgnQ29udGVudCcpICYmIGMuTmFtZSE9J1RyYW5zYWN0aW9uJyAmJiAhbS5Jc1N5bmMpeyU+DQogICAgICAgIGlmKCFfcGFyYW1zLlN5bmMpew0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29udGVudCcsIHRydWUpJT4oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zY29wZSgiPCU9c2NvcGUlPiIpLmNsYXNzKCI8JT1jLk5hbWUlPiIpLm1ldGhvZChtZXRob2QpLmF1dGhvcml6YXRpb24oYXV0aE9iaikuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucGF5bG9hZCh0aGlzLl9idG9hKF9wYXJhbXMpKS50cmFuc2FjdGlvbl9UcmFuc2FjdGlvbkxvZ3MoW25ldyA8JT1zY29wZSU+LlRyYW5zYWN0aW9uTG9nKCkuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkuc3RhdGUobmV3IDwlPXNjb3BlJT4uVHJhbnNhY3Rpb25TdGF0ZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoImxvYWRlZCIpKV0pLnN0b3JlKCkpLklkKS5fdG9Eb2N1bWVudCgpOw0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgIDwlIG0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSAmJiBwLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgX3BhcmFtcy48JT1uQ29kZShwKSU+ID0gX3BhcmFtcy48JT1uQ29kZShwKSU+Lm1hcChwID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQocCkuX2RlUmVmZXJlbmNlKCkpOw0KICAgICAgICA8JSB9ZWxzZSBpZihwLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIF9wYXJhbXMuPCU9bkNvZGUocCklPiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy48JT1uQ29kZShwKSU+KS5fZGVSZWZlcmVuY2UoKTsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuPCU9bkNvZGUocCklPik7DQogICAgPCUgfSk7JT4NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCjwlIH0pOyU+DQoNCiAgICAgICAgICAgIGNhc2UgImZpbmRBbGwiOnsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOw0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgImZpbmQiOiB7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IG9iaiA9IHRoaXM7DQogICAgICAgIA0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgaWYoIW9iail7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgJy0xJzogYDwlPW5OYW1lKGMpJT4uPCU9bU5hbWUlPjogb2JqIGlzIHVuZGVmaW5lZGANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZSBpZighb2JqW21ldGhvZF0pew0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICctMic6IGA8JT1uTmFtZShjKSU+LjwlPW1OYW1lJT46IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsDQogICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7DQogICAgICAgIH0NCiAgICAgICAgDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgIGlmKGZhbHNlICYmIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiAmJiAhPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCl7DQogICAgICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAgICAgJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICdvYmonOiBvYmoNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIGlmKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZSA9IHt9Ow0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICBsZXQgX3JldCA9IFtdOw0KICAgICAgICAgICAgICAgIGZvciBhd2FpdChjb25zdCByIG9mIHJldCl7DQogICAgICAgICAgICAgICAgICAgIGlmKHIgJiYgci5fdG9Eb2N1bWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPikgZGVsZXRlIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+Ll90b0RvY3VtZW50Ow0KICAgICAgICAgICAgICAgICAgICAgICAgX3JldC5wdXNoKGF3YWl0IHIuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIF9yZXQucHVzaChyKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0ID0gX3JldDsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KT9hd2FpdCByZXQuX3RvRG9jdW1lbnQoKTpyZXQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT4ncmV0JywgcmV0KTsNCiAgICAgICAgPCU9bG9nKCklPmAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYyklPi4nICsgbWV0aG9kKX1gKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgIDwlPW1OYW1lPSdfcGFyc2VDb2RlU3RhdGUnJT4odCl7DQogICAgPCUgaWYobWFpbkNsYXNzKCk9PWMpeyU+DQogICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuX19jb25maWcodGhpcy5fX2NvbmZpZygnb2F1dGgucmVkaXJlY3Quc3RhdGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgbGV0IGNvZGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKTsNCiAgICAgICAgaWYoIXN0YXRlIHx8ICFjb2RlKSByZXR1cm47DQogICAgICAgIHN0YXRlID0gSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHN0YXRlKSk7DQogICAgICAgIGlmKHN0YXRlLnRvb2whPT10Lm5hbWUpIHJldHVybjsNCg0KICAgICAgICA8JT1sb2coKSU+IkdPVCBDT0RFICIgKyBjb2RlICsgIiBmb3Igbm9kZSAiICsgc3RhdGUubmNvZGUgKyAiIHdpdGggdG9vbCAiICsgc3RhdGUudG9vbCk7DQogICAgICAgIGlmKCE8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSB8fCAhPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudC5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSkpew0KICAgICAgICAgICAgPCU9bG9nKCklPiduZXcgcGFyZW50Jywgc3RhdGUubmNvZGUpOw0KICAgICAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKHN0YXRlLm5jb2RlKSk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bnNjb3BlJT4uX25vZGUuYXV0aENvZGUoY29kZSwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUoc3RhdGUudG9vbCkpOw0KICAgICAgICB3aW5kb3cuY2xvc2UoKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHQpOw0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19sb2FkVG9vbHMnJT4oYlN0b3JlKXsNCiAgICAgICAgaWYoPCU9c2NvcGUlPi5Ub29scyAmJiA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFscmVhZHkgbG9hZGVkYCk7DQogICAgICAgICAgICByZXR1cm4gPCU9c2NvcGUlPi5Ub29sczsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmBMb2FkaW5nIHRvb2xzLi4uYCk7DQogICAgICAgIA0KICAgICAgICBsZXQgdG9vbHMgPSBbXTsNCiAgICAgICAgdG9vbHMgPSA8JT1zY29wZSU+Ll9fVG9vbHMgfHwgdG9vbHM7DQogICAgICAgIGRlbGV0ZSA8JT1zY29wZSU+Ll9fVG9vbHM7DQoNCiAgICAgICAgbGV0IGFyVG9vbHMgPSA8JT1fRnJFTUQuX3RvSlMoWy4uLm5ldyBTZXQoYXJDbGFzc2VzLm1hcChfYyA9PiBfYy5Ub29scykuZmxhdCgpKV0pJT47DQogICAgICAgIGxldCB0b29sTmFtZXMgPSBhclRvb2xzLm1hcCh0ID0+IHQubmFtZSB8fCAodC50eXBlP3QudHlwZS5uYW1lOnQpKTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodG9vbHMubGVuZ3RoIT09dG9vbE5hbWVzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgLy8gY2Fubm90IHVzZSByZXF1aXJlIHlldCwgbm8gdG9vbHMgcHJvcGVybHkgbG9hZGVkIHRvIHVzZSBhIGxvYWRlciBmdW5jdGlvbg0KICAgICAgICAgICAgICAgIHRvb2xzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHtOYW1lOiAnQVBJU0VSVkVSPCU9bU5hbWUlPicsIEFjdGl2ZTogdHJ1ZSwgRW5hYmxlZDogdHJ1ZX0pIHx8IHRvb2xzOw0KICAgICAgICAgICAgfQ0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgICAgIGlmKCF0b29scy5sZW5ndGgpIHRvb2xzID0gKGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVG9vbCcsIHRydWUpJT4oKS5USElTKHRvb2xOYW1lcy5tYXAodCA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkubmFtZSh0KSkpLmZpbmRBbGwoMikpLm1hcCh0ID0+IHQuX3RvSlNPTih7cGFyc2U6IDF9KSkgfHwgdG9vbHM7DQo8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBsZXQgZml4VG9vbHMgPSB0b29scyA9PiB7DQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0Lm5hbWUnLCAndC50eXBlLm5hbWUnKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuZW5hYmxlZCcsIHRydWUpJT4NCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuZW5hYmxlZCcsIHRydWUpJT4NCg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfQ29uZmlncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUudHlwZV9NYXBwaW5ncycsICdbXScpJT47DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnRvb2xfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgIA0KICAgICAgICAgICAgICAgIFtdLmNvbmNhdCh0LnRvb2xfQ29uZmlncywgdC50eXBlLnR5cGVfQ29uZmlncywgdC50eXBlLnR5cGVfTWFwcGluZ3MsIHQudG9vbF9NYXBwaW5ncykuZm9yRWFjaChjID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmFjdGl2ZScsIHRydWUpJT4NCiAgICAgICAgICAgICAgICAgICAgPCVfZGVmKCdjLmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5JZCcsICd0aGlzLl91dWlkKCknKSU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIHRvb2xzLmZpbHRlcih0ID0+IHR5cGVvZih0KT09PSdvYmplY3QnICYmIHQpLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpIT09Im9iamVjdCIpLmNvbmNhdChEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5maWx0ZXIoYyA9PiB0eXBlb2YoYy52YWx1ZSk9PT0ib2JqZWN0IiAmJiBjLnZhbHVlKS5tYXAoYyA9PiBPYmplY3Qua2V5cyhjLnZhbHVlKS5tYXAobmNvZGUgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IF9jID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGMubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYy52YWx1ZVtuY29kZV0sDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobmNvZGUhPSJkZWZhdWx0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Mubm9kZSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogbmNvZGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UsIDwlLy8gb3RoZXJ3aXNlIGl0IHN0YXJ0cyBnZXR0aW5nIGV2ZW50cyU+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJOb2RlSlMiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfYzsNCiAgICAgICAgICAgICAgICAgICAgfSkuZmxhdCgpKS5mbGF0KCkpLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZm9yRWFjaChjID0+IGMudmFsdWUgPSBKU09OLnN0cmluZ2lmeShjLnZhbHVlKSk7DQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICk7DQogICAgICAgIH07DQoNCg0KICAgICAgICBmaXhUb29scyh0b29scyk7DQogICAgICAgIHRvb2xzID0gdG9vbHMuZmlsdGVyKHQgPT4gdC5hY3RpdmUpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHRvb2xOYW1lcy5maW5kKF90ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KDQogICAgICAgIDwlPWxvZygpJT5gVG9vbHMgYXJlICR7dG9vbHMubGVuZ3RofWApOw0KDQogICAgICAgIDwlPXNjb3BlJT4uVG9vbHMgPSB0b29sczsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zICYmIDwlPUpTT04uc3RyaW5naWZ5KF9yZXN0VG9vbHMpJT4uaW5kZXhPZih0LnR5cGUubmFtZSk+PTApLmZvckVhY2godCA9PiB7DQogICAgICAgICAgICB0LmF4aW9zID0gdHlwZW9mKGF4aW9zLmNyZWF0ZSk9PT0nZnVuY3Rpb24nP2F4aW9zLmNyZWF0ZSgpOmF4aW9zOw0KICAgICAgICAgICAgdC5heGlvcy5pbnRlcmNlcHRvcnMucmVxdWVzdC51c2UocmVxdWVzdCA9PiB0aGlzLl9yZXF1ZXN0SW50ZXJjZXB0b3IocmVxdWVzdCwgdCksIGVycm9yID0+IHt9KTsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShyZXNwb25zZSA9PiByZXNwb25zZSwgZXJyb3IgPT4gdGhpcy5fcmVzcG9uc2VJbnRlcmNlcHRvcihlcnJvciwgdCkpOw0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIC8vIGNvbm5lY3QgdG8gdGhlIGxvYWRlZCB0b29scyEhIQ0KICAgICAgICBsZXQgdG9vbCA9IHRoaXMuVG9vbDsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4uVG9vbHMpew0KPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHtlbS52YWx1ZXMgPSBlbS52YWx1ZXMuc29ydCgoYSwgYikgPT4gYi5SYW5rIC0gYS5SYW5rKTsgJT4NCiAgICAgICAgICAgIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlbS52YWx1ZXNbMF0sIHRydWUpJT4odW5kZWZpbmVkLCB0KS5fc3RvcmVFbnRpdHlDbGFzcyg8JT1lbS52YWx1ZXNbMF0uUmFuayU+KTsNCjwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLlRvb2wgPSB0b29sOw0KICAgICAgICANCiAgICAgICAgYXJUb29scyA9IGFyVG9vbHMuZmlsdGVyKF90ID0+ICF0b29scy5maW5kKHQgPT4gKHR5cGVvZihfdCk9PT0nc3RyaW5nJz9fdDpfdC5uYW1lKT09dC5uYW1lKSk7DQogICAgICAgIGZpeFRvb2xzKGFyVG9vbHMpOw0KDQo8JSBpZihfY05hbWUoJ1Rvb2wnKSl7JT4NCiAgICAgICAgPCU9c2NvcGUlPi5vVG9vbHMgPSA8JT1zY29wZSU+LlRvb2xzLmNvbmNhdChhclRvb2xzKS5maWx0ZXIodCA9PiB0LmFjdGl2ZSkubWFwKHQgPT4gew0KICAgICAgICAgICAgdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50b29sKTsNCiAgICAgICAgICAgIHQudHlwZS50eXBlX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50eXBlKTsNCiAgICANCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudCh0KTsNCiAgICAgICAgfSk7DQogICAgICAgIGlmKGJTdG9yZSl7DQogICAgICAgICAgICA8JT1sb2coKSU+YFNhdmluZyB0b29scy4uLmApOw0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCB0IG9mIDwlPXNjb3BlJT4ub1Rvb2xzKXsNCiAgICAgICAgICAgICAgICBhd2FpdCB0LnN0b3JlKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCjwlIH0lPg0KDQogICAgICAgIDwlPWxvZygpJT5gRXhpdGluZ2ApOw0KICAgICAgICByZXR1cm4gdG9vbHM7DQogICAgfQ0KICAgIA0KPCUgfSAvLyBtYWluQ2xhc3MgJT4NCg0KCTwlPW1OYW1lPSdfcGFyYW1ldHJpemUnJT4oc3RyLCBmdW4sIG9wdGlvbnM9e30sIHByZWZpeD0ne3snLCBwb3N0Zml4PSd9fScpIHsNCjwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2Yoc3RyKSE9PSdzdHJpbmcnKSByZXR1cm4gc3RyOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV4ID0gYCR7cHJlZml4fShbXiR7cG9zdGZpeH1dKykke3Bvc3RmaXh9YDsNCiAgICAgICAgICAgIChzdHIubWF0Y2gobmV3IFJlZ0V4cChyZXgsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gc3RyID0gc3RyLnJlcGxhY2UobSwgbSA9PiBmdW4obS5yZXBsYWNlKHByZWZpeCwgJycpLnJlcGxhY2UocG9zdGZpeCwgJycpKSkpOw0KDQogICAgICAgICAgICByZXR1cm4gc3RyOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKCkpJT4oKS48JT1tTmFtZSU+KHN0ciwgZnVuLCBvcHRpb25zLCBwcmVmaXgsIHBvc3RmaXgpOw0KPCUgfSU+DQoJfQ0KDQogICAgPCU9bU5hbWU9J19fc3luY19vbiclPihkKXsNCiAgICAgICAgdGhpcy5fPCU9bU5hbWUlPiA9IHRoaXMuXzwlPW1OYW1lJT4gfHwge307DQogICAgDQogICAgICAgIGlmKGQpeyAvLyBzZXQgdGhlIHZhbHVlDQogICAgICAgICAgICB0aGlzLl88JT1tTmFtZSU+W3RoaXMuVG9vbC5uYW1lXSA9IGQ7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KHRoaXMsIHsNCiAgICAgICAgICAgICAgICBDeWNsaWM6IHRydWUsDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk6dW5kZWZpbmVkLA0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICAvLzwlPXRhTmFtZSU+OiB0aGlzLjwlPXRhTmFtZSU+KCkuZm9yRWFjaCh0ID0+IHQuPCU9bU5hbWUlPihkKSksDQo8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGQpOw0KDQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSkgdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4oZCk7DQo8JSB9KSU+DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgLy8gdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpOw0KPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV07IC8vIGdldCB0aGUgdmFsdWUNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19jbG9uZSclPihiVHlwZUF0dHJpYnV0ZXMpew0KICAgICAgICA8JT13YXJuKCklPiJERVBSRUNBVEVEOiB1c2UgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodGhpcy5fdG9KU09OKCkpIik7DQoNCiAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIA0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCksIHsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4odjwlaWYoZWEuRW50aXR5VHlwZSl7JT4uPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpPCV9JT4pLA0KPCUgfSk7JT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IGJUeXBlQXR0cmlidXRlcz9vYmouPCU9dGFOYW1lJT4odi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihiVHlwZUF0dHJpYnV0ZXMpKSk6bnVsbCwNCjwlIH0pOyU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19tYXAnJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsNCiAgICAgICAgdG9vbCA9IHRvb2wgfHwgX3RoaXMuVG9vbDsNCiAgICAgICAgY29kZVR5cGUgPSBjb2RlVHlwZSB8fCA8JT1fZWFUeXBlcygpJT5bY29kZV07DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQogICAgICAgIG1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lIHx8ICI8JT1jLkVudGl0eU1vZHVsZT9jLkVudGl0eU1vZHVsZS5OYW1lOicnJT4iOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBfbG9nID0gYCR7bW9kdWxlTmFtZX0uJHtjbGFzc05hbWV9LiR7Y29udGV4dH0ke2JSZXZlcnNlPyc8PSc6Jz0+J30ke2NvZGV9YDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy9pZihBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLjwlPW1OYW1lJT4oY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBlYUNvZGUsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIF90aGlzLCBtb2R1bGVOYW1lKSk7DQogICAgICAgIA0KICAgICAgICAgICAgPCUgLyogdGVtcHRlZCB0byB1c2UganNvbmF0YSBpbiBRdWVyeSBmaWVsZHMsIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBqc29uYXRhLmV2YWx1YXRlIHJldHVybiBhIHByb21pc2UhISEgKi8lPg0KICAgICAgICAgICAgbGV0IHNGaWVsZCA9IGJSZXZlcnNlPyd0YXJnZXQnOidzb3VyY2UnOw0KICAgICAgICAgICAgbGV0IHNTY3JpcHQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgc0NvbmQgPSAoYlJldmVyc2U/J291dCc6J2luJykrJ0NvbmRpdGlvbic7DQogICAgICAgICAgICBsZXQgc1BhdGggPSAoYlJldmVyc2U/J291dCc6J2luJykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRGaWVsZCA9IGJSZXZlcnNlPydzb3VyY2UnOid0YXJnZXQnOw0KICAgICAgICAgICAgbGV0IHRTY3JpcHQgPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1NjcmlwdCc7DQogICAgICAgICAgICBsZXQgdFBhdGggPSAoYlJldmVyc2U/J2luJzonb3V0JykrJ1BhdGgnOw0KICAgICAgICAgICAgbGV0IHRDb25kID0gKGJSZXZlcnNlPydpbic6J291dCcpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IHdhcm4gPSAoLi4ucykgPT4gPCU9d2FybigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPmNsYXNzTmFtZSwgX2xvZywgLi4ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvcHRpb25zID0ge19jbGFzczogY2xhc3NOYW1lLCBfdGhpczogX3RoaXMsIHRvb2w6IHRvb2x9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX3NjcmlwdCA9IChzLCBtKSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW5TY3JpcHQoYChvU2NvcGUsIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcikgPT4gJHtzfWApKDwlPXNjb3BlJT4sIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSwgZWFDb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgd2FybihtLnRlc3RzLmxvZywgZXgpOyANCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgX21hdGNoID0gKHMsIHIpID0+IHsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yocyk9PT0ndW5kZWZpbmVkJyB8fCBzPT09bnVsbCB8fCB0eXBlb2Yocy5tYXRjaCkhPT0nZnVuY3Rpb24nKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IHMubWF0Y2gobmV3IFJlZ0V4cChyLCAnZycpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gcz09ciB8fCAoKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKT90cnVlOmZhbHNlKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY29uc3QgY2xvbmUgPSBpdGVtcyA9PiBpdGVtcy5tYXAoaXRlbSA9PiBBcnJheS5pc0FycmF5KGl0ZW0pID8gY2xvbmUoaXRlbSkgOiBpdGVtKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG1zID0gY2xvbmUoIFsuLi4odG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pXSApOyAvLyBkbyBub3QgdGFtcGVyIHdpdGggdGhlIG1hcHBpbmdzLCBkZWVwIGNsb25lDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gT2JqZWN0LmtleXMobSkuZm9yRWFjaChrID0+IG1ba10gPSB0aGlzLl9wYXJhbWV0cml6ZShtW2tdLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpKSk7DQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gbS50ZXN0cyA9IHsNCiAgICAgICAgICAgICAgICBhY3RpdmU6IDwldmFsdWVPZigibS5hY3RpdmUiKSU+LCAvL19zY3JpcHQobS5hY3RpdmUsIG0pLA0KICAgICAgICAgICAgICAgIGVuYWJsZWQ6IDwldmFsdWVPZigibS5lbmFibGVkIiklPiwgLy9fc2NyaXB0KG0uZW5hYmxlZCwgbSksDQogICAgICAgICAgICAgICAgY29udGV4dDogX21hdGNoKGNvbnRleHQsIG0uY29udGV4dCksDQogICAgICAgICAgICAgICAgY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwNCiAgICAgICAgICAgICAgICBtb2R1bGU6IF9tYXRjaChtb2R1bGVOYW1lLCBtLm1vZHVsZU5hbWUpLA0KICAgICAgICAgICAgICAgIHNGaWVsZDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSksDQogICAgICAgICAgICAgICAgc1NjcmlwdDogdHlwZW9mKGNvZGUpPT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgc1BhdGg6IHR5cGVvZihtW3NQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHR5cGVvZihtW3RGaWVsZF0gfHwgbVt0U2NyaXB0XSB8fCBtW3RQYXRoXSkhPT0ndW5kZWZpbmVkJywNCiAgICAgICAgICAgICAgICB0ZXh0OiBgJHtjb2RlfToke3NGaWVsZH09PT4ke3RGaWVsZH1gLA0KICAgICAgICAgICAgICAgIGxvZzogYCR7X2xvZ31bJHttLmNvbnRleHR9LyR7bS5jbGFzc05hbWV9XWAsDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIG1zID0gbXMuZmlsdGVyKG0gPT4gbS50ZXN0cy5hY3RpdmUgJiYgbS50ZXN0cy5lbmFibGVkICYmIG0udGVzdHMuY29udGV4dCAmJiBtLnRlc3RzLmNsYXNzICYmIG0udGVzdHMubW9kdWxlICYmIChtLnRlc3RzLnNGaWVsZCB8fCBtLnRlc3RzLnNTY3JpcHQgfHwgbS50ZXN0cy5zUGF0aCkgJiYgbS50ZXN0cy50YXJnZXQpLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCUgLyogd2UgbWlnaHQgbm90IHdvcmsgd2l0aCBhbGwgbXMgZW50cmllcy4gbG9nIGhlcmUgaXMgb25seSBhIHByZXZpZXcgb2Ygd2hhdCBtaWdodCB3b3JrISAqLyAlPg0KICAgICAgICAgICAgLy9pZihtcy5maWx0ZXIobSA9PiBtLmRlYnVnKS5sZW5ndGgpIGxvZyh0aGlzLl9iZWF1dGlmeShtcy5maWx0ZXIobSA9PiBtLmRlYnVnKSwgJ2phdmFzY3JpcHQnKSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiB7DQogICAgICAgICAgICAgICAgaWYobVt0U2NyaXB0XSl7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RDb25kXSk9PT0ndW5kZWZpbmVkJyB8fCA8JXZhbHVlT2YoIm1bdENvbmRdIiwgJ190aGlzJyklPil7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnKSBsb2cobS50ZXN0cy5sb2cgKyAnOiAnICsgdFNjcmlwdCwgJzwlPW1OYW1lJT4nLCBtW3RTY3JpcHRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSA8JXZhbHVlT2YoIm1bdFNjcmlwdF0iLCAnX3RoaXMnKSU+DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0gam1lc3BhdGguc2VhcmNoKG9iakZyb20sIG1bc1BhdGhdKTsNCiAgICAgICAgICAgICAgICBpZihtW3NQYXRoXSAmJiB0eXBlb2YoanNvbnBhdGgpIT09J3VuZGVmaW5lZCcpIGNvZGUgPSBqc29ucGF0aC5xdWVyeShvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0RmllbGRdKXsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGRQYXRoID0gJyc7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtW3RGaWVsZF0pPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5yZXBsYWNlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAobVtzRmllbGRdLCAnZycpLCBtW3RGaWVsZF0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9jb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoY29kZSkhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoX21hdGNoKGNvZGUsIG1bc0ZpZWxkXSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGAke2NvZGV9LmNvZGVgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gbVt0RmllbGRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYGRvdGNvcHlgOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgPSBEb3RPYmplY3QuY29weShtW3NGaWVsZF0sIG1bdEZpZWxkXSwgb2JqRnJvbSwgb2JqVG8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZihtLmRlYnVnICYmIGRQYXRoKSBsb2coYCR7bS50ZXN0cy5sb2d9LyR7ZFBhdGh9W2NvZGU9JHtjb2RlfV06ICR7bVtzRmllbGRdfSA9PiAke21bdEZpZWxkXX1gKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGptZXNwYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwgam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0gam1lc3BhdGguc2VhcmNoKG9ialRvLCBtW3RQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVt0UGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnICYmICghbVt0Q29uZF0gfHwganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdENvbmRdKSkpIG9ialRvW21bdEZpZWxkXV0gPSBqc29ucGF0aC5xdWVyeShvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIG1zLmZvckVhY2gobSA9PiBkZWxldGUgbS50ZXN0cyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gb2JqVG87DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoY29udGV4dD09J0VudGl0eUNsYXNzJyAmJiBjbGFzc05hbWU9PSdVc2VyJykgPCU9d2FybigpJT4iR09UIEhFUkUiLCBjb2RlLCBjb250ZXh0LCBvcHRpb25zKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJhbWV0cml6ZShjb2RlLCBwID0+IHRoaXMuX19jb25maWcocCkgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19uQ29kZSclPihjb2RlLCBvQ29kZSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgICAgICBpZighY29kZSAmJiAhb0NvZGUpew0KICAgICAgICAgICAgICAgIGNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOw0KICAgICAgICAgICAgICAgIGNvZGUgPSAiPCU9bkNvZGUoYyklPiI7DQogICAgICAgICAgICAgICAgb0NvZGUgPSA8JT1fRnJFTUQuX3RvSlMoYy5Db2RlKSU+Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgcmV0ID0gY29kZTsNCiAgICAgICAgICAgIGlmKG9Db2RlICYmIHR5cGVvZihvQ29kZSk9PT0nb2JqZWN0Jyl7DQogICAgICAgICAgICAgICAgcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IG9Db2RlW3RoaXMuVG9vbC50eXBlLm5hbWVdIHx8IHJldDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21hcChyZXQsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgICAgIHJldHVybiBjb2RlOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfX2NvbmZpZyclPihuLCBudWxsVmFsdWUsIG9wdGlvbnMpew0KICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCiAgICAgICAgb3B0aW9ucy5fdGhpcyA9IG9wdGlvbnMuX3RoaXMgfHwgdGhpczsNCiAgICAgICAgb3B0aW9ucy5fY2xhc3MgPSBvcHRpb25zLl9jbGFzcyB8fCAnPCU9bk5hbWUoYyklPic7DQogICAgICAgIG9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCBvcHRpb25zLl90aGlzLlRvb2wgfHwgdGhpcy5Ub29sOw0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdvYmplY3QnICYmIG9wdGlvbnMudG9vbC5jb25zdHJ1Y3Rvci5uYW1lPT0nVG9vbCcpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wubmFtZSgpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpPT09J3N0cmluZycpIG9wdGlvbnMudG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lPT1vcHRpb25zLnRvb2wgfHwgdC50eXBlLm5hbWU9PW9wdGlvbnMudG9vbCk7DQoNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe190aGlzOiB0aGlzLCB0b29sOiB0aGlzLlRvb2wsIF9jbGFzczogJzwlPW5OYW1lKGMpJT4nfSwgb3B0aW9ucyB8fCB7fSkpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCkhPT0nb2JqZWN0JykgPCU9d2FybigpJT5vcHRpb25zLnRvb2wpOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMudG9vbCkgPCU9d2FybigpJT4idG9vbCBub3QgZGVmaW5lZCIsIG9wdGlvbnMuX3RoaXMuVG9vbCwgPCU9c2NvcGUlPi5Ub29scywgb3B0aW9ucy5fdGhpcy5Ub29scyk7DQogICAgICAgICAgICAvL29wdGlvbnMubm9DYWNoZSA9IHRydWU7DQogICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlKSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gPSA8JT1zY29wZSU+LjwlPW1OYW1lJT4gfHwge307DQoNCiAgICAgICAgICAgIGxldCBuSUQgPSA8JT1uc2NvcGUlPi5fbm9kZT88JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCk6J2RlZmF1bHQnOw0KDQogICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9uc1tuXSkhPT0ndW5kZWZpbmVkJykgbnVsbFZhbHVlID0gbnVsbFZhbHVlIHx8IG9wdGlvbnNbbl07DQogICAgICAgICAgICBsZXQgcmV0ID0gbnVsbFZhbHVlOw0KICAgICAgICAgICAgaWYodHlwZW9mKHJldCk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyB1c2Ugc2NvcGUgY2FjaGUgKGltcHJvdmVzIHBlcmZvcm1hbmNlPz8/KQ0KICAgICAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUgJiYgT2JqZWN0Lmhhc093big8JT1zY29wZSU+LjwlPW1OYW1lJT4sIGAke29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWApKSByZXR1cm4gPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyB0b29sX0NvbmZpZ3MsIHR5cGVfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lDQogICAgICAgICAgICBsZXQgdGNvbmYgPSBbXS5jb25jYXQob3B0aW9ucy50b29sLnR5cGUudHlwZV9Db25maWdzIHx8IFtdLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjICYmIGMubmFtZT09biAmJiAoIWMubm9kZSB8fCBjLm5vZGUuY29kZT09bklEKSkuc29ydChjID0+IGMubm9kZT8oYy5ub2RlLmNvZGU9PSdkZWZhdWx0Jz8wOi0xKToxKTsNCiAgICAgICAgICAgIGlmKHRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgaWYodGNvbmZbMF0uc2NyaXB0KXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGNvbmZbMF0uc2NyaXB0Ow0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IF9zYyA9IHRoaXMuX3BhcmFtZXRyaXplKHRjb25mWzBdLnNjcmlwdCwgcCA9PiB0aGlzLjwlPW1OYW1lJT4ocCwgbnVsbCwgb3B0aW9ucykgfHwgRG90T2JqZWN0LnBpY2socCwgb3B0aW9ucyksIG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoIl9zYyIpJT47DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnZhbHVlOw0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBbMSwyLDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goamV4KXt9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYob3B0aW9ucy5uZXdWYWx1ZSl7DQogICAgICAgICAgICAgICAgbGV0IHRjID0gdGNvbmYubGVuZ3RoP3Rjb25mWzBdOnt9Ow0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubm9kZSkgdGMubm9kZSA9IHtjb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpfTsNCiAgICAgICAgICAgICAgICB0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICAgICAgdGMubmFtZSA9IG47DQogICAgICAgICAgICAgICAgaWYoIXRjb25mLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncykucHVzaCh0Yyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldCA9IG9wdGlvbnMubmV3VmFsdWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcNCiAgICAgICAgICAgIGxldCBtY29uZiA9IG9wdGlvbnMuX3RoaXMuQ29uZmlnP29wdGlvbnMuX3RoaXMuQ29uZmlnW25dOnVuZGVmaW5lZDsNCiAgICAgICAgICAgIG1jb25mID0gdGhpcy5fcGFyYW1ldHJpemUobWNvbmYsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIG1jb25mID0gPCV2YWx1ZU9mKCJtY29uZiIpJT47DQogICAgICAgICAgICBpZih0eXBlb2YobWNvbmYpIT09InVuZGVmaW5lZCIpIHJldCA9IG1jb25mOw0KDQogICAgICAgICAgICAvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3Qpew0KICAgICAgICAgICAgICAgIHJldCA9IERvdE9iamVjdC5waWNrKG4sIGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpKSB8fCByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZw0KICAgICAgICAgICAgaWYodGhpcy4kX1JFUVVFU1QpIHJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gY29uZmlnIHJlcGxhY2VtZW50DQogICAgICAgICAgICByZXQgPSB0aGlzLl9wYXJhbWV0cml6ZShyZXQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+W2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdID0gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSA8JXZhbHVlT2YoInJldCIpJT47DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPm4sIG51bGxWYWx1ZSwgb3B0aW9ucy5fY2xhc3MsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQoNCjwlIGMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4geyU+DQogICAgLyoqDQogICAgICogU3VtbWFyeS4gPCU9bS5OYW1lJT4uDQogICAgICoNCiAgICAgKiBEZXNjcmlwdGlvbi4gPCU9bS5SZW1hcmslPi4NCiAgICAgKg0KICAgICAqIEBzaW5jZSAgICAgIHgueC54DQogICAgICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4NCiAgICAgKiBAYWNjZXNzICAgICBwdWJsaWMNCiAgICAgKg0KICAgICAqIEBjbGFzcw0KICAgICAqIEBhdWdtZW50cyBwYXJlbnQNCiAgICAgKiBAbWl4ZXMgICAgbWl4aW4NCiAgICAgKg0KICAgICAqIEBhbGlhcyAgICByZWFsTmFtZQ0KICAgICAqIEBtZW1iZXJvZiBuYW1lc3BhY2UNCiAgICAgKg0KICAgICAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbg0KICAgICAqIEBsaW5rIFVSTA0KICAgICAqIEBnbG9iYWwNCiAgICAgKg0KICAgICAqIEBmaXJlcyAgIGV2ZW50TmFtZQ0KICAgICAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUNCiAgICAgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuDQogICAgICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLg0KICAgICAqDQogICAgICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqDQogICAgICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLg0KICAgICAqLw0KICAgIDwlIGlmKCFtLklzU3luYyl7JT5hc3luYyA8JX0lPjwlPW1OYW1lPW5Db2RlKG0pJT4oPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IG5Db2RlKHApKS5qb2luKCcsICcpJT4pew0KDQogICAgCWxldCBsb2cgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCU9bkNvZGUobSklPiIsIG51bGwsIDAsIC4uLm1zZyk7DQogICAgCWxldCB3YXJuID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCU9bkNvZGUobSklPiIsIG51bGwsIDIsIC4uLm1zZyk7DQogICAgCWxldCBvU2NvcGUgPSA8JT1hbGlhcygpJT47DQogICAgCWxldCBwU2NvcGUgPSA8JT1zY29wZSU+Ow0KICAgICAgICANCiAgICANCjwlIGlmKCFtLklzU3luYyl7JT4NCiAgICA8JSBpZighbS5SZXNwb25zZUF0dHJpYnV0ZSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBudWxsOw0KICAgIDwlIH1lbHNlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLCB0cnVlKSU+KCk7DQogICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0Jvb2wpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gZmFsc2U7DQogICAgPCUgfWVsc2UgaWYobS5Jc0FycmF5KXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IFtdOw0KICAgIDwlIH1lbHNleyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbnVsbDsNCiAgICA8JSB9ICU+DQogICAgDQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1uQ29kZShtKSU+IiwgPCVtUm91dGluZyhjLCBtKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIA0KPCUgfSU+DQo8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5EZWZhdWx0KS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgIGlmKHR5cGVvZig8JT1uTmFtZShwKSU+KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIDwlPW5OYW1lKHApJT4gPSA8JXZhbHVlT2YocC5EZWZhdWx0KSU+Ow0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgdmFyIGVycm9ycyA9IHsNCiAgICAgICAgPCUgIFtdLmNvbmNhdChtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5SZXF1aXJlZCkubWFwKHAgPT4gKHsNCiAgICAgICAgICAgICAgICBDb2RlOiBgJHtuTmFtZShwKX0tcmVxdWlyZWRgLA0KICAgICAgICAgICAgICAgIEVycm9yOiBgJHtuTmFtZShwKX0gaXMgYSByZXF1aXJlZCBQYXJhbWV0ZXJgLA0KICAgICAgICAgICAgICAgIFNjcmlwdDogYHR5cGVvZigke25OYW1lKHApfSk9PT0ndW5kZWZpbmVkJ2AsDQogICAgICAgICAgICB9KSkpLmNvbmNhdChtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlKS5tYXAocCA9PiAoew0KICAgICAgICAgICAgICAgIENvZGU6IGAke25OYW1lKHApfWAsDQogICAgICAgICAgICAgICAgRXJyb3I6IGAke25OYW1lKHApfSBpcyBub3Qgb2YgdHlwZSAke25OYW1lKHAuRW50aXR5VHlwZSl9YCwNCiAgICAgICAgICAgICAgICBTY3JpcHQ6IGAoISR7bk5hbWUocCl9ICYmICR7cC5SZXF1aXJlZD8ndHJ1ZSc6J2ZhbHNlJ30pIHx8ICgke25OYW1lKHApfSAmJiAoJHtuTmFtZShwKX0uY29uc3RydWN0b3IubmFtZSE9JyR7bk5hbWUocC5FbnRpdHlUeXBlKX0nIHx8ICR7bk5hbWUocCl9LkVudGl0eUNsYXNzLk5hbWUhPScke25OYW1lKHAuRW50aXR5VHlwZSl9JykpYCwNCiAgICAgICAgICAgIH0pKSkuY29uY2F0KG0uVmFsaWRhdG9ycyB8fCBbXSkuZmlsdGVyKHYgPT4gIXYuSWdub3JlKS5mb3JFYWNoKHYgPT4geyAlPg0KICAgICAgICAgICAgIjwlPXYuQ29kZSU+IjogKCg8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lKS5qb2luKCcsICcpJT4pID0+IHsNCiAgICAgICAgICAgICAgICB0cnl7DQoNCiAgICAgICAgICAgICAgICA8JSBpZih2LlNjcmlwdC5pbmRleE9mKCdyZXR1cm4gJyk8MCl7JT4NCiAgICAgICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IA0KICAgICAgICAgICAgICAgIDwlfSU+DQogICAgICAgICAgICAgICAgICAgIDwlPXYuU2NyaXB0JT4NCiAgICAgICAgICAgICAgICAgICAgLy88JT1sb2coKSU+ImFuc3dlciIsICI8JT12LkNvZGUlPiIsIGFuc3dlcik7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhbnN3ZXI7DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4idmFsaWRhdG9yIiwgIjwlPXYuQ29kZSU+IiwgZXgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBwLk5hbWUpLmpvaW4oJywgJyklPik/KCc8JT12LkVycm9yJT4nIHx8ICdWYWxpZGF0aW9uIEVycm9yJyk6JycsDQogICAgICAgIDwlIH0pICU+DQogICAgICAgIH07DQogICAgICAgIE9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOw0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCl7DQogICAgICAgICAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT57W2tdOiBlcnJvcnNba119KTsNCiAgICAgICAgICAgICAgICBkZWxldGUgZXJyb3JzW2tdOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBpZihPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogZXJyb3JzLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICA8JT1tLlNjcmlwdCU+DQogICAgICAgIA0KPCUgaWYoIW0uSXNTeW5jKXslPg0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKG0uTWV0aG9kUnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKG0uTWV0aG9kUnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IG5Db2RlKHApICsgIjogIiArIG5Db2RlKHApKS5qb2luKCcsICcpJT59KTsNCiAgICAgICAgDQogICAgICAgIA0KICAgICAgICAvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMNCiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7DQoNCiAgICAgICAgLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPw0KICAgICAgICBsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsNCiAgICAgICAgaWYoX19leCkgcmV0dXJuIF9fZXgucmV0Ow0KDQogICAgICAgIDwlPW0uUmVkdWNlJT4NCg0KICAgICAgICA8JSBpZihtLklzQXJyYXkgfHwgbS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5KXslPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAociA9PiByLnJldCkuZmxhdCgpOw0KICAgICAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aD9yZXN1bHRzWzBdLnJldDpudWxsOw0KICAgICAgICA8JSB9JT4NCjwlIH0lPg0KICAgIH0NCjwlIH0pOyU+DQoNCjwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX3Jlc3BvbnNlSW50ZXJjZXB0b3InJT4oZXJyb3IsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGVycm9yLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSBlcnJvci5jb25maWc7DQogICAgICAgICAgICBpZiAodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSAmJiBlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KSk+MCkgew0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOw0KICAgICAgICAgICAgICAgIC8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190eXBlIiwgIkJlYXJlciIsIHt0b29sOiB0fSkgKyAiICIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgICAgIHJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIDwlPWxvZygpJT5jb25maWcpOw0KICAgICAgICByZXR1cm4gY29uZmlnOw0KICAgIDwlIH0lPg0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfcmVxdWVzdEludGVyY2VwdG9yJyU+KGNvbmZpZywgdCl7DQogICAgPCUgaWYobWFpbkNsYXNzKF9yZXN0VG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcyhfcmVzdFRvb2xzKSklPigpLjwlPW1OYW1lJT4oY29uZmlnLCB0KTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0ID0gdCB8fCB0aGlzLlRvb2w7DQogICAgICAgICAgICBjb25maWcgPSBjb25maWcgfHwge2hlYWRlcnM6IHt9fTsNCiAgICAgICAgICAgIGNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307DQogICAgICAgICAgICBjb25maWcubWV0YS5jb3VudGVyID0gNDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRva2VuVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW4udXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVHlwZSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pOw0KICAgICAgICAgICAgbGV0IHRva2VuID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuLiIrY29uZmlnLm1ldGhvZCwgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlfSksIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgaWYoIWNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gJiYgW3Rva2VuVXJpLCByZWZyZXNoVXJpLCBhdXRoVXJpXS5pbmRleE9mKGNvbmZpZy51cmwpPDApew0KICAgICAgICAgICAgICAgIGlmKCF0b2tlbil7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoQ29kZSA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5jb2RlJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGF1dGhNZXRob2QgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUubWV0aG9kJywgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKCF0b2tlblVyaSAmJiAhYXV0aENvZGUgJiYgIWF1dGhNZXRob2QgJiYgdGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVHlwZSA9ICdCYXNpYyc7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygndXNlcm5hbWUnKSArICI6IiArIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJykpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KPCVpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSJnZXQiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBvciBsb2FkIGEgbmV3IG9hdXRoIHN0YXRlDQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUuc3RhdGUiLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHt0b29sOiB0Lm5hbWUsIG5jb2RlOiA8JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCl9KSl9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF1dGhvcml6ZSBhbmQgZ2V0IHRoZSBhdXRoIGNvZGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHthdXRoVXJpfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4oYXV0aFVyaSk7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNldEludGVydmFsKG51bGwsIHRvb2wgPT4gPCU9bnNjb3BlJT4uX25vZGUgJiYgY29uZmlnLm1ldGEuY291bnRlci0tICYmICEoYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSkpLCAwLjEsIHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBEb25lIExvb3Bpbmc6ICR7YXV0aENvZGV9YCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZighYXV0aENvZGUpIGF1dGhNZXRob2Q9dW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICB9DQo8JX0lPg0KDQogICAgICAgICAgICAgICAgICAgIGlmKGF1dGhNZXRob2Qpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZsb3cgPSAoIWF1dGhDb2RlICYmIGF1dGhNZXRob2Q9PSdwb3N0Jyk/J2F1dGhvcml6ZSc6J3Rva2VuJzsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdldCB0aGUgdG9rZW4NCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB0b2tlblVyaSBtaWdodCBoYXZlIGEgZGVwZW5kZW5jeSBvbiB0aGUgYXV0aG9yaXphdGlvbiBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30udXJpYCwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0Y29uZmlnID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdG9rZW5VcmksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0Jywge3Rvb2w6IHR9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uY29udGVudF90eXBlYCwgInRleHQvanNvbiIsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBdXRob3JpemF0aW9uIjogIkJhc2ljICIrdGhpcy5fYnRvYSh0aGlzLl9fY29uZmlnKCJvYXV0aC5sb2dpbiIsIG51bGwsIHt0b29sOiB0fSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHt0b29sOiB0fSkpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uYm9keWAsIG51bGwsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmBUb2tlbiBmZXRjaGVkIC0gJHtmbG93fWAsIHRjb25maWcsIHRyZXMuZGF0YSk7DQogICAgICAgICAgICAgICAgICAgICAgICBbJ2FjY2Vzc190b2tlbicsICd0b2tlbl90eXBlJywgJ2V4cGlyZXNfaW4nLCAncmVmcmVzaF90b2tlbiddLmZvckVhY2godGEgPT4gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHt0YX1gLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGUsIG5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwge3Rvb2w6IHR9KV19KSk7DQogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBhdXRoVHlwZSArICIgIiArIHRva2VuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXN0JyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyl7DQogICAgICAgIC8qIHROYW1lIG5vIGxvbmdlciByZXF1aXJlZCEhICovDQogICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge190aGlzOiB0aGlzfTsNCiAgICAgICAgb3B0aW9ucy50TmFtZSA9IG9wdGlvbnMudE5hbWUgfHwgdE5hbWU7DQogICAgICAgIA0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307DQogICAgICAgIG1ldGhvZCA9IG1ldGhvZCB8fCAoZGF0YT8icG9zdCI6ImdldCIpOw0KICAgICAgICANCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KC8qbnVsbCwgdGhpcy5Ub29sKi8pLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmZvcm0pew0KICAgICAgICAgICAgICAgIGxldCBmZCA9IG5ldyBGb3JtRGF0YSgpOw0KICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goayA9PiBmZC5hcHBlbmQoaywgZGF0YVtrXSkpOw0KICAgICAgICAgICAgICAgIGRhdGEgPSBmZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgYHJlc3RhcGkudXJsLiR7bWV0aG9kfWAsIHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgJ3Jlc3RhcGkudXJsJywgKG9wdGlvbnMucGF0aHx8JycpICsgb3B0aW9ucy5maWxlLCBvcHRpb25zKSwgb3B0aW9ucyksDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsDQogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMuJyttZXRob2QsIHRoaXMuX19jb25maWcoJ3Jlc3RhcGkuaGVhZGVycycsIHt9LCBvcHRpb25zKSwgb3B0aW9ucyksIG9wdGlvbnMuaGVhZGVycyB8fCB7fSksDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICB2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1czw0MDAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICA8JT1sb2coKSU+YFtMSVZFOiR7dGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpfV1gLCBjb25maWcsIG9wdGlvbnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzLlRvb2wuYXhpb3MpIT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKGF4aW9zKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gKGF3YWl0ICgodGhpcy5Ub29sLmF4aW9zIHx8IGF4aW9zKSkoY29uZmlnKSkuZGF0YTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgKGF3YWl0IGZldGNoKGNvbmZpZy51cmwsIGNvbmZpZykpLmpzb24oKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iYXhpb3Mgbm90IGRlZmluZWQhLCB1c2luZyBmZXRjaCIsIHJldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9IC8vIG1haW5DbGFzcyhfcmVzdFRvb2xzKSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU1FMVGFibGUnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCBkZXBzOiB7fSwgc3FsOiBgYCwgZmllbGRzOiBgYH0sIHsNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgX19oZWFkZXI6IG9iaiA9PiBvYmouc3FsID0gYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKCR7b2JqLmZpZWxkc30vKjwlPW5OYW1lKGMpJT4qLyk7XG5gLA0KICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e3NxbDogdi5vYmouc3FsICs9IGAvKjwlPW5OYW1lKGMpJT46IHJldXNlZDogJHt2LnJldXNlZH0qL1xuXG5gLCBJZDogdi5vYmouSWR9LA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLmZpZWxkcyArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAsJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIjwlPV9GckVNRC5fYXR0cihlYSklPiIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQuZGVwcyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldC5kZXBzW2tdKT09PSdzdHJpbmcnKS5tYXAoayA9PiByZXQuZGVwc1trXSkuam9pbignXG5cbicpICsgcmV0LnNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tU1FMVGFibGUnJT4odGFibGUsIGZpZWxkcyl7DQogICAgICAgIC8vIHRhYmxlIGlzIGEganNvbiBhcnJheQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9bk5hbWUoZWEpJT4iKSkgfHwgIWZpZWxkcyl7DQogICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHRhYmxlWyI8JT1uQ29kZShlYSklPiJdKTsNCiAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3NxbCclPihzcWwsIF90aGlzKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgIDwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9zcWxUb29scykpJT4oKS48JT1tTmFtZSU+KHNxbCwgX3RoaXMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+c3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoc3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIHNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGlmKChzcWwubWF0Y2goL1woL2cpIHx8IFtdKS5sZW5ndGghPShzcWwubWF0Y2goL1wpL2cpIHx8IFtdKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJpbmNvcnJlY3Qgc3FsIiwgc3FsKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgICAgIGxldCBfb2sgPSAoX3JldCwgX3NxbCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoX3JldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRiID0gdGhpcy5Ub29sLmRiOw0KICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOw0KICAgIA0KICAgICAgICAgICAgICAgIGxldCBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgICAgIHFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKT49MDsNCg0KICAgICAgICAgICAgICAgIGlmKGJRdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIC8vIHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ2FsbCc7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIERNTA0KICAgICAgICAgICAgICAgICAgICBpZihbJ215c3FsJywgJ3Bvc3RncmVzJ10uaW5kZXhPZih0eXBlKT49MCkgZnVuID0gJ3F1ZXJ5JzsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZT09J3NxbGl0ZScpIGZ1biA9ICdydW4nOw0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfb2soMCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICBpZihmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7dHlwZX0uJHtmdW59YCwgc3FsKTsNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChmdW4pIHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0icG9zdGdyZXMiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsKS50aGVuKHJvd3MgPT4gX29rKHJvd3MsIHNxbCkpLmNhdGNoKHJldEV4ID0+IHJlamVjdChyZXRFeCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3Nub3dmbGFrZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRiLmV4ZWN1dGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgc3FsVGV4dDogc3FsLA0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3NxbGl0ZScpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIHRoZSBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGIuZXhlYyhzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgICAgICAgICBfb2socmV0LCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlPT0ncXVlc3RkYicpew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0KG51bGwsIHtxdWVyeTogc3FsfSkudGhlbihyID0+IF9vayhyLCBzcWwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmANCkVSUk9SOg0KJHtleH0NCg0KV2hpbGUgU2VuZGluZyBRdWVyeSANCiR7c3FsfQ0KYCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgcmV0LnJvd3MpIHJldCA9IHJldC5yb3dzOyAgICAgICAgDQogICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSl7JT4NCjwlDQpsZXQgX3RvVHlwZUFUID0gZWEgPT4gew0KICAgIGxldCByZXQgPSB7bmFtZTogbk5hbWUoZWEpLCBkZXNjcmlwdGlvbjogZWEuTmFtZSwgdHlwZTogInNpbmdsZUxpbmVUZXh0In07DQogICAgaWYoZWEuSXNCb29sKXsNCiAgICAgICAgcmV0LnR5cGUgPSAiY2hlY2tib3giOw0KICAgICAgICByZXQub3B0aW9ucyA9IHsNCiAgICAgICAgICAgIGNvbG9yOiAiZ3JlZW5CcmlnaHQiLA0KICAgICAgICAgICAgaWNvbjogImNoZWNrIg0KICAgICAgICB9Ow0KICAgIH0NCiAgICBpZihlYS5Jc0RhdGUpew0KICAgICAgICByZXQudHlwZSA9ICJkYXRlVGltZSI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgZGF0ZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICdpc28nDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICcyNGhvdXInLA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRpbWVab25lOiAndXRjJywNCiAgICAgICAgfTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJldDsNCn07DQolPg0KICAgIDwlPW1OYW1lPSdfdG9BVFRhYmxlJyU+KGxldmVsKXsNCiAgICAgICAgbGV0IHJldCA9IFt7DQogICAgICAgICAgICBuYW1lOiAnPCU9bk5hbWUoYyklPicsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICBmaWVsZHM6IFsNCiAgICAgICAgICAgICAgICB7bmFtZTogdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCBkZXNjcmlwdGlvbjogJ0lEJywgdHlwZTogJ3NpbmdsZUxpbmVUZXh0J30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPjwlPV9GckVNRC5fdG9KUyhfdG9UeXBlQVQoZWEpKSU+LDwlIH0pJT5dLA0KICAgICAgICB9XTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQucHVzaChuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5zcWwpOw0KICAgICAgICByZXR1cm4gcmV0LnNxbDsNCg0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKCh0YWcsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KHQgPT4gdC5uYW1lID09IHRhZy5uYW1lKSA9PSBpbmRleCk7DQogICAgICAgIDwlPWxvZygpJT5yZXQsIGxldmVsKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0FURnVuY3Rpb24nJT4oKXsNCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0uYDsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2Z1bjogIiJ9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSIsDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgKCR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIgYW5kIC8qPCU9dGFOYW1lJT4qLyAiOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJOT1QgRVhJU1RTIjsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke3RoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgIklOIn1gOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIgKCIgKyAodiB8fCBbXSkubWFwKHQgPT4gKHQgJiYgdC48JT1tTmFtZSU+KT90LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIik6KHQgfHwgJ05VTEwnKSkuam9pbignIFVOSU9OIEFMTC8qTTJNKi8gJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2FpcnRhYmxlJyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQWlyVGFibGUnXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydBaXJUYWJsZSddKSklPigpLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0TmFtZSA9IHROYW1lIHx8IDwlPV9uQ29kZSgpJT47DQogICAgICAgICAgICBsZXQgcmV0ID0gKGF3YWl0IGF4aW9zLnJlcXVlc3Qoew0KICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5fX2NvbmZpZygnZW5kcG9pbnRVcmwnKX0ke3ROYW1lfWAsDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2Q/bWV0aG9kOihkYXRhPyJwb3N0IjoiZ2V0IiksDQogICAgICAgICAgICAgICAgcGFyYW1zOiB7DQogICAgICAgICAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogcGFyYW1zLA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXgucmVzcG9uc2UuZGF0YSwgbnVsbCwgNCkpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19maWxlc3lzdGVtJyU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmo9dGhpcyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWxlLCBjb250ZW50LCBpZCwgb2JqKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighZmlsZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIGxldCBwYXRoID0gb2JqLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJz8nLi9kYi8nOidodHRwczovL3t7b3duZXJ9fS5naXRodWIuaW8vJykpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAvLyB3cml0ZQ0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKChwYXRoICsgZmlsZSkucmVwbGFjZSgvKC4qXC8pLiovZywgJyQxJyksIHsgcmVjdXJzaXZlOiB0cnVlIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmMocGF0aCArIGZpbGUsIHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnPy8qdGhpcy5fYnRvYSgqL0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpLyopKi86Y29udGVudCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihmYWxzZSAmJiBmaWxlLmVuZHNXaXRoKCcvJykpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJzaW11bGF0ZWQgZGlyZWN0b3J5IGxpc3RpbmcuLi4uIiwgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IFsiRU1TIFdlYiJdOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyByZWFkDQogICAgICAgICAgICAgICAgICAgIGlmKHBhdGguc3RhcnRzV2l0aCgnaHR0cCcpICYmIHBhdGguaW5kZXhPZignOi8vJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgbnVsbCwgbnVsbCwge3VybDogJ3BhdGgucmVhZCcsIGZpbGUsIHBhdGh9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuZnMuZXhpc3RzU3luYyhwYXRoICsgZmlsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyhwYXRoICsgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD8ocmV0LmRhdGEgfHwgcmV0KTpyZXQ7DQogICAgICAgICAgICA8JT1sb2coKSU+YFske29iai5fX2NvbmZpZygnbGl2ZScsIHRydWUpPycnOidOT1QgJ31MSVZFfCR7dHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCc/J3dyaXRlJzoncmVhZCd9XSR7cGF0aCArIGZpbGV9OiAkeyhyZXQgfHwgJycpLmxlbmd0aH1gKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIDwlPW1OYW1lPSdnZXQgX1RvU3RyaW5nJyU+KCl7IDwlIC8qQmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIEJJU2VydmVyICovICU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KFtdLCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBVbmlxdWU6IHRydWUsDQoJPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wdXNoKHY/djwlaWYoZWEuRW50aXR5VHlwZSl7JT4uX1RvU3RyaW5nPCV9JT46bnVsbCksDQoJPCUgfSklPg0KCSAgICAgICAgfSwgIjwlPW1OYW1lJT4iKS5mbGF0KCkuam9pbignLScpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQo8JSBpZihtYWluQ2xhc3MoX2ZpbGVUb29scykpeyU+DQogICAgPCU9bU5hbWU9J190b0ZpbGVOYW1lJyU+KHNQYXRoPSIiLCBleHQ9Jy5qc29uJyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBmTmFtZSA9IHRoaXMuX19leHBvcnQoW10sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIFVuaXF1ZTogdHJ1ZSwNCgk8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnB1c2godj92PCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGAke3NQYXRofS4ke2VhQ29kZX1gLCBleHQpPCV9JT46J251bGwnKSwNCgk8JSB9KSU+DQoJICAgICAgICB9LCAiPCU9bU5hbWUlPiIpLmpvaW4oJ19fJyk7DQoJICAgICAgICANCgkgICAgICAgIGlmKCFzUGF0aCl7DQogICAgICAgICAgICAgICAgZk5hbWUgPSAodGhpcy5fX2NvbmZpZygnc3RvcmUucm9vdCcsICc8JT1zY29wZSU+LycpICsgYCR7IjwlPWFsaWFzKCklPiIuc3BsaXQoJy4nKS5zbGljZSgxKS5qb2luKCcvJyl9LyR7PCU9X25Db2RlKCklPn0vJHtmTmFtZSArIGV4dH1gKS5yZXBsYWNlKC9cL1wvL2csICcvJyk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmTmFtZSA9ICdbJyArIGZOYW1lICsgJ10nOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gZk5hbWU7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tRmlsZU5hbWUnJT4oZk5hbWUsIHNQYXRoPSIiLCBleHQ9Jy5qc29uJyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihmTmFtZSkhPT0nc3RyaW5nJykgPCU9d2FybigpJT4iZk5hbWUgbm90IGEgc3RyaW5nIiwgZk5hbWUsIHNQYXRoLCBleHQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihmTmFtZS5pbmRleE9mKCcvJyk+PTApIGZOYW1lID0gZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnJldmVyc2UoKS5yZWR1Y2UoKHYsIGUpID0+IHYgKyAnX19bJyArIGUpICsgZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnNsaWNlKDEpLnJlZHVjZSh2ID0+IHYgKyAnXScsICdfX251bGwnKSArICgoZk5hbWUuc3BsaXQoJy4nKS5sZW5ndGg+MSk/KCcuJytmTmFtZS5zcGxpdCgnLicpWzFdKTpleHQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydCh7bmFtZTogZk5hbWUucmVwbGFjZShleHQsICcnKX0sIHsNCiAgICAgICAgICAgICAgICBVbmlxdWU6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGxldCB2ID0gb2JqLm5hbWUuc3BsaXQoJ19fJylbMF07DQogICAgICAgICAgICAgICAgICAgIG9iai5uYW1lID0gb2JqLm5hbWUuc3BsaXQoJ19fJykuc2xpY2UoMSkuam9pbignX18nKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmVhQ29kZSwgdiwgb2JqLm5hbWUsIHNQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPih2LCAnPScpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5lYUNvZGUsIG9iai5uYW1lLnNsaWNlKDEsIC0xKSwgc1BhdGgpOw0KICAgICAgICAgICAgICAgICAgICBpZihvYmoubmFtZT09J251bGwnIHx8ICFvYmoubmFtZSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvYmoubmFtZS5zbGljZSgxLCAtMSksIGAke3NQYXRofS4ke2VhQ29kZX1gLCBleHQpKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+IiwgZk5hbWUsIHNQYXRoKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydHaXRIdWInXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19naXRodWInJT4oZmlsZSwgY29udGVudCwgaWQsIG9iaj10aGlzKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydHaXRIdWInXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydHaXRIdWInXSkpJT4obnVsbCwgdGhpcy5Ub29sKS48JT1tTmFtZSU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmopOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFmaWxlKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHNoYTEgPSBhc3luYyBzdHIgPT4gdHlwZW9mKGNyeXB0by5zdWJ0bGUpIT09J3VuZGVmaW5lZCc/QXJyYXkuZnJvbShuZXcgVWludDhBcnJheShhd2FpdCBjcnlwdG8uc3VidGxlLmRpZ2VzdCgnU0hBLTEnLCBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoJ2Jsb2IgJyArIG5ldyBCbG9iKFtzdHJdKS5zaXplICsgJ1x4MDAnICsgc3RyKSkpKS5tYXAodiA9PiB2LnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpKS5qb2luKCcnKTpzdHIuc3Vic3RyaW5nKDAsIDEwKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPiJmaWxlIiwgZmlsZSwgY29udGVudD8ncHV0JzonZ2V0Jyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgY29udGVudD9KU09OLnN0cmluZ2lmeSh7DQogICAgCQkJbWVzc2FnZTogImRlcGxveWVkIGJ5IDwlPW1OYW1lJT4oKSIsDQogICAgCQkJc2hhOiBpZCB8fCBjb250ZW50W3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sDQogICAgCQkJY29udGVudDogdGhpcy5fYnRvYSh0eXBlb2YoY29udGVudCk9PT0nb2JqZWN0Jz9KU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCAnXHQnKTpjb250ZW50KSwNCiAgICAJCX0pOm51bGwsIGNvbnRlbnQ/J3B1dCc6bnVsbCwgew0KICAgIAkJICAgIGZpbGU6IChmaWxlICsgKChjb250ZW50IHx8IGZpbGUuZW5kc1dpdGgoJy8nKSk/Jyc6KCc/cmFuZD0nK01hdGgucmFuZG9tKCkpKSksDQogICAgCQl9KTsNCiAgICAJCQ0KICAgIAkJaWYoIXJldCkgcmV0dXJuIHJldDsNCiAgICAJCQ0KICAgIAkJcmV0ID0gY29udGVudD9yZXQuY29udGVudDpyZXQ7DQoNCiAgICAgICAgICAgIGxldCBpZHhGaWxlID0gJ2luZGV4Lmh0bSc7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+InJldCIsIHJldCk7DQogICAgCQlpZihBcnJheS5pc0FycmF5KHJldCkpew0KICAgIAkJICAgIC8vIGluIGNhc2Ugd2UgYXJlIGxpc3RpbmcgdGhlIGNvbnRlbnRzIG9mIGEgZm9sZGVyIHJlc291cmNlDQogICAgCQkgICAgcmV0dXJuIHJldC5maWx0ZXIociA9PiAodHlwZW9mKHIudHlwZSk9PT0ndW5kZWZpbmVkJyB8fCByLnR5cGU9PSdmaWxlJykgJiYgci5uYW1lIT1pZHhGaWxlKS5tYXAociA9PiAoe1t0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldOiByLnNoYSB8fCByW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sIG5hbWU6IHIubmFtZS5yZXBsYWNlKCcuanNvbicsICcnKX0pKTsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJbGV0IF90aGlzID0ge307DQogICAgCQlpZihyZXQuc2hhKXsNCiAgICAJCSAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIF90aGlzID0gcmV0LmNvbnRlbnQ/SlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSk6e307DQogICAgICAgICAgICAgICAgfWNhdGNoKF9leCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+Im5vdCBhIHZhbGlkIEpTT04gb2JqZWN0IiwgZmlsZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIAkJICANCiAgICAJCSAgICBfdGhpc1tvYmouX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0gPSByZXQuc2hhOyAvLz8/DQogICAgCQl9ZWxzZSBpZihyZXRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSl7DQogICAgCQkgICAgLy88JT13YXJuKCklPidzaGExJywgZmlsZSwgYXdhaXQgc2hhMShKU09OLnN0cmluZ2lmeShyZXQpKSk7DQogICAgCQkgICAgX3RoaXMgPSByZXQ7DQogICAgCQl9DQogICAgCQkNCiAgICAJCTwlPWxvZygpJT5maWxlLCBjb250ZW50PydwdXQnOidnZXQnLCBfdGhpcyk7DQogICAgCQkNCiAgICAgICAgICAgIGxldCBmUm9vdCA9IGZpbGUuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSkuam9pbignLycpOw0KICAgICAgICAgICAgaWYoZmlsZS5pbmRleE9mKGlkeEZpbGUpPj0wKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgaWR4RmlsZSA9IGZSb290ICsgJy8nICsgaWR4RmlsZTsNCiAgICAJCQ0KICAgIAkJaWYoLyohb2JqLl9fc3luY19vbigpICYmICovY29udGVudCl7DQogICAgCQkgICAgLy8gbmV3IGNvbnRlbnQgc3RvcmVkDQogICAgCQkgICAgbGV0IGlkeFJldCA9IGF3YWl0IG9iai48JT1tTmFtZSU+KGlkeEZpbGUpOw0KICAgIAkJICAgIGxldCBpZHhMaXN0ID0gYXdhaXQgb2JqLjwlPW1OYW1lJT4oZlJvb3QpOw0KICAgIAkJICAgIGF3YWl0IG9iai48JT1tTmFtZSU+KGlkeEZpbGUsIGlkeExpc3QsIGlkeFJldD9pZHhSZXQuc2hhOm51bGwpOw0KICAgIAkJICAgIDwlPWxvZygpJT4iZmlsZSBjb250ZW50IiwgZmlsZSwgaWR4RmlsZSwgcmV0LCBpZHhMaXN0KTsNCiAgICAJCX0NCiAgICAJCQ0KICAgICAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NhbGVzRm9yY2UnXSkpeyU+DQogICAgPCU9bU5hbWU9J190b1NGUXVlcnknJT4oZmllbGRzLCBvYmpzLCBiU3RyaW5nKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe1s8JT1fbkNvZGUoKSU+XToge3BhcmFtczoge3doZXJlOiB7YW5kOiBbXSwgb3I6IFtdfX0sIGVkZ2VzOiB7bm9kZToge319fX0sIHsNCiAgICAgICAgICAgIC8vT1BFUkFUT1JTOiB0cnVlLA0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqWzwlPV9uQ29kZSgpJT5dLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7SWQ6IHtlcTogdn19KSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBvcCA9ICdlcSc7DQogICAgICAgICAgICAgICAgbGV0IGNvbmQgPSB7W2VhQ29kZV06IHtbb3BdOiANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5xOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXBpTmFtZTogJ0lkJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT5dOiB2P3YuPCU9bU5hbWUlPigpWzwlPV9uQ29kZShlYS5FbnRpdHlUeXBlKSU+XS5wYXJhbXMud2hlcmUuYW5kOltdLA0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgICh2P3YudG9JU09TdHJpbmcoKTpudWxsKQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICB2DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH19Ow0KICAgICAgICAgICAgICAgIG9ials8JT1fbkNvZGUoKSU+XS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICANCiAgICAgICAgLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsNCiAgICAgICAgDQogICAgICAgIGlmKGJTdHJpbmcpew0KICAgICAgICAgICAgcmV0ID0ge3F1ZXJ5OiB7WzwlPV9uQ29kZSgpJT4gKyAnUXVlcnknXToge3VpYXBpOiB7cXVlcnk6IHJldH19fX07DQogICAgICAgICAgICByZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1NlcnZpY2VOb3cnXSkpeyU+DQogICAgPCUNCiAgICBsZXQgX2lkID0gcyA9PiAvKnM/czoqL2B0aGlzLl91dWlkKCR7c3x8dW5kZWZpbmVkfSkucmVwbGFjZSgvLS9nLCAnJylgOw0KICAgIGxldCBfdGlkID0gX2MgPT4gX2lkKCInIitzY29wZSsiLiIrIChfYyB8fCBjKS5OYW1lICsgIiciKTsNCiAgICBsZXQgYXBwID0gKCkgPT4geyU+YXBwbGljYXRpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBcHBsaWNhdGlvbicsIHRydWUpJT4oKS5jb2RlKHRoaXMuX19jb25maWcoJ3Njb3BlJywgJzwlPXNjb3BlJT4nKSkpPCV9Ow0KICAgIA0KICAgIGxldCBsYWJlbCA9ICh0LCBuLCBjLCBwKSA9PiB7bj1zci5FbmdsaXNoTmFtZShuKTsgJT4uPCU9dCU+X0ZpZWxkX0xhYmVscyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGaWVsZCBMYWJlbCcsIHRydWUpJT4oPCU9X2lkKCklPikucmVtYXJrKCc8JT1uJT4nKS5uYW1lKCc8JT1uJT4nKS5jb2RlKDwlPWMlPikubGFuZ3VhZ2UoJ2VuJykucGx1cmFsKCc8JT0ocCB8fCAobiArICdzJykpJT4nKS48JWFwcCgpJT5dKTwlfTslPg0KDQogICAgPCU9bU5hbWU9J190b1NOVGFibGUnJT4oKXsNCiAgICAgICAgLy90aGlzLl9kZWZhdWx0cygpOw0KDQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RhYmxlJywgdHJ1ZSklPig8JT1fdGlkKCklPikuY29kZSg8JT1fbkNvZGUoKSU+KS48JWFwcCgpJT4ubmFtZSgnPCU9Yy5OYW1lJT4nKS5yZW1hcmsoYDwlPWMuUmVtYXJrJT5gKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKSwgew0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoudGFibGVfQ29sdW1ucyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbHVtbicsIHRydWUpJT4oPCU9X2lkKCInIitzY29wZSsiLiIrYy5OYW1lKyInK2VhQ29kZSIpJT4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4iKS5jb2RlKGVhQ29kZSkudHlwZSgnPCU9X0ZyRU1ELl9hdHRyKGVhKSU+JykucmVmZXJlbmNlKDwlaWYoZWEuRW50aXR5VHlwZSl7JT4odiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KCk8JX1lbHNleyU+bnVsbDwlfSU+KS8qPCVsYWJlbCgnY29sdW1uJywgZWEuTmFtZSwgJ2VhQ29kZScsIGVhLlBsdXJhbCklPiovKSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucmVmZXJlbmNlX0NvbHVtbnMobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdDb2x1bW4nLCB0cnVlKSU+KCkuYWN0aXZlKGZhbHNlKS5lbmFibGVkKHRydWUpLmNvZGUoZWFDb2RlKS50eXBlKCdMaXN0JykubmFtZSgiPCU9bk5hbWUodGEpJT4gPCU9dGEuRW50aXR5Q2xhc3MuUGx1cmFsJT4iKS5yZWZlcmVuY2UobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKS8qPCVsYWJlbCgnY29sdW1uJywgdGEuTmFtZSsnICcrdGEuRW50aXR5Q2xhc3MuUGx1cmFsLCAnZWFDb2RlJywgdGEuRW50aXR5Q2xhc3MuUGx1cmFsKSU+Ki8pLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU05GbG93JyU+KGJEcmFmdCwgYkhlYWRlcil7DQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgIDwlIGxldCBiT3JkZXIgPSAxOyBsZXQgX2ZpZCA9IF9jID0+IF9pZCgiJyIrc2NvcGUrIi4nICsgKGJEcmFmdD8nZCc6J3MnKSArICdsIisgKF9jIHx8IGMpLk5hbWUgKyAiJyIpOw0KICAgICAgICBsZXQgbG9naWMgPSAobiwgdCwgbWFwPVtdKSA9PiB7JT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBMb2dpYycsIHRydWUpJT4oPCU9X2lkKCklPikub3JkZXIoPCU9Yk9yZGVyKyslPikuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUoJzwlPW4lPicpLnJlbWFyaygnPCU9biU+JykNCiAgICAgICAgICAgICAgICAuYmxvY2sobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IEJsb2NrJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKDwlPV9pZCgpJT4pLm5hbWUoJzwlPW4lPicpDQogICAgICAgICAgICAgICAgICAgIC5ibG9ja19FbGVtZW50X01hcHBpbmdzKFs8JSBtYXAuZmlsdGVyKG0gPT4gbSkuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoIjwlPW4lPiAtICIgKyA8JT1tLmNkJT4pLmNvZGUoPCU9bS5jZCU+KS52YWx1ZSg8JT1tLnYlPik8JXBDb21wb3VuZChtLnYsIG0udHJuKSU+LA0KICAgICAgICAgICAgICAgICAgICA8JX0pJT5dKQ0KICAgICAgICAgICAgICAgICkuZGVmaW5pdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0xvZ2ljIERlZmluaXRpb24nLCB0cnVlKSU+KCc8JT10JT4gPCU9biU+JykuY29kZSgnPCU9dCU+JykubmFtZSgnPCU9dCU+JykpLjwlYXBwKCklPg0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IGFjdGlvbiA9IChhQ29kZSwgcGFyYW1zPXt9KSA9PiB7ICU+DQogICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FjdGlvbiBJbnN0YW5jZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSh0aGlzLl91dWlkKCkpLmFjdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FjdGlvbiBUeXBlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT1hQ29kZSU+JykpLm9yZGVyKDwlPWJPcmRlcisrJT4pLjwlYXBwKCklPg0KICAgICAgICAgICAgLmFjdGlvbl9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgPCUgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikuYWN0aW9uSW5wdXQoDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIElucHV0JywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpDQogICAgICAgICAgICAgICAgKS5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKCIiKSksDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKQ0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IHN1YmZsb3cgPSAoZmxvdywgcGFyYW1zPXt9LCBiTm9XYWl0KSA9PiB7ICU+DQogICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5zdGFuY2UnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUodGhpcy5fdXVpZCgpKS5zdWJmbG93KDwlPWZsb3clPikub3JkZXIoPCU9Yk9yZGVyKyslPikuPCVhcHAoKSU+DQogICAgICAgICAgICA8JSBpZighYk5vV2FpdCl7JT4NCiAgICAgICAgICAgIC5pbnN0YW5jZV9GbG93X0luc3RhbmNlX0lucHV0cyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IEluc3RhbmNlIElucHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykubmFtZSgnV2FpdCBmb3IgQ29tcGxldGlvbicpLnR5cGUoJ0Jvb2wnKV0pDQogICAgICAgICAgICAuaW5zdGFuY2VfVmFyaWFibGVfVmFsdWVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykudmFsdWUoJzEnKQ0KICAgICAgICAgICAgICAgICAgICAubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCd3YWl0X2Zvcl9jb21wbGV0aW9uJykpDQogICAgICAgICAgICBdKQ0KICAgICAgICAgICAgPCV9JT4NCiAgICAgICAgICAgIC5pbnN0YW5jZV9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgPCUgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKHAgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdWYXJpYWJsZSBWYWx1ZScsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikuZmxvd0lucHV0KA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykNCiAgICAgICAgICAgICAgICApLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoPCU9cGFyYW1zW3BdJT4pKQ0KICAgICAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgXSkNCiAgICAgICAgPCV9DQogICAgICAgIGxldCBwQ29tcG91bmQgPSAodiwgdHJuKSA9PiB7aWYoIXRybikgcmV0dXJuOyAlPi5lbGVtZW50TWFwcGluZ19QaWxsX0NvbXBvdW5kcyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdQaWxsIENvbXBvdW5kJywgdHJ1ZSklPih0aGlzLl91dWlkKCkpLmNvZGUoJycpLm5hbWUoPCU9diU+KS5vcmRlcigwKS8qLnJlbWFyayh0aGlzLl9idG9hKGA8JT1KU09OLnN0cmluZ2lmeShbXSklPmApKSovLjwlYXBwKCklPg0KICAgICAgICAgICAgLnBhcmVudF9QaWxsX0NvbXBvdW5kcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyh0cm4pLmZvckVhY2goKHQsIGkpID0+IHslPiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1BpbGwgQ29tcG91bmQnLCB0cnVlKSU+KHRoaXMuX3V1aWQoKSkuY29kZSgiPCU9dCU+Iikub3JkZXIoPCU9aSsxJT4pLm5hbWUoPCU9diU+KS5yZW1hcmsodGhpcy5fYnRvYShgPCU9SlNPTi5zdHJpbmdpZnkodHJuW3RdKSU+YCkpLjwlYXBwKCklPi8qLnRyYW5zZm9ybShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RyYW5zZm9ybScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnPCU9dCU+JykudHJhbnNmb3JtX1RyYW5zZm9ybV9Db21wb3NpdGlvbnMoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVHJhbnNmb3JtIENvbXBvc2l0aW9uJywgdHJ1ZSklPigpLmNvZGUoJycpXSkpKi8sDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKV0pDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgDQogICAgICAgICAgICANCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgKiBPT0IgRW5kcG9pbnQ6IGh0dHBzOi8vZGV2MTYyNTcwLnNlcnZpY2Utbm93LmNvbS9hcGkvbm93L3Byb2Nlc3NmbG93L2Zsb3dvYmplY3Qvc3RhcnQvc3ViZmxvdw0KICAgICAgICAgICAgICogUGF5bG9hZDogeyJuYW1lIjoieF83ODYxMV9zY2hvb2xfbWFuLlVzZXJfbG9va3VwIiwiaW5wdXRzIjp7Impzb24iOnsibmFtZSI6InRlc3QiLCJnZW5kZXIiOnsiY29kZSI6Ik0iLCAiT1BFUkFUT1JTIjogeyJjb2RlIjogIiE9In19LCJ1c2VyX1N0dWRlbnRzIjpbeyJuYW1lIjoiU1RBIiwiZ2VuZGVyIjp7ImNvZGUiOiJNIn19XX19fQ0KICAgICAgICAgICAgKi8NCg0KICAgICAgICAgICAgbGV0IGZsb3cgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cnLCB0cnVlKSU+KDwlPV9maWQoKSU+KS5uYW1lKCc8JT1jLk5hbWUlPiBMb29rdXAnKS5jb2RlKDwlPV9uQ29kZSgpJT4gKyAnX2xvb2t1cCcpLjwlYXBwKCklPi5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKTsNCiAgICAgICAgICAgIGlmKGJIZWFkZXIpIHJldHVybiBmbG93Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChmbG93LyouX2RlZmF1bHRzKCkqLw0KICAgICAgICAgICAgICAgIC5mbG93X0Zsb3dfU2V0dGluZ3MoW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBTZXR0aW5nJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCdBQ1RJT04nKV0pDQogICAgICAgICAgICAgICAgLmZsb3dfRmxvd19JbnB1dHMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKCdqc29uJykubmFtZSgnSlNPTicpLnR5cGUoJ0pTT04nKTwlbGFiZWwoJ2lucHV0JywgJ0pTT04nLCAiJ2pzb24nIiklPg0KICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19PdXRwdXRzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IE91dHB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoPCU9X25Db2RlKCklPiArICdfbGlzdCcpLm5hbWUoJzwlPW5OYW1lKGMpJT4gTGlzdCcpLnR5cGUoJ0xpc3QnKS5yZWZlcmVuY2UobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUYWJsZScsIHRydWUpJT4oIjwlPW5OYW1lKGMpJT4iKS5uYW1lKCc8JT1jLk5hbWUlPicpLmNvZGUoPCU9X25Db2RlKCklPikuPCVhcHAoKSU+KQ0KICAgICAgICAgICAgICAgICAgICA8JWxhYmVsKCdvdXRwdXQnLCBjLk5hbWUgKyAnIExpc3QnLCBfbkNvZGUoKSArICIrICdfbGlzdCciKSU+DQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X1ZhcmlhYmxlcyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2pzb24nKS5uYW1lKCdKU09OJykudHlwZSgnSlNPTicpPCVsYWJlbCgndmFyaWFibGUnLCAnSlNPTicsICcianNvbiInKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmFjdGl2ZSh0cnVlKS5jb2RlKCdlcXVlcnknKS5uYW1lKCdFUXVlcnknKS50eXBlKCdTdHJpbmcnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgJ0VRdWVyeScsICciZXF1ZXJ5IicpJT4sDQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ1NldCAnICsgYy5OYW1lICsgJyBKU09OJywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInanNvbiciLCB2OiAiJ3t7c3ViZmxvdy5qc29ufX0nIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICA8JSAvLyAsIHRybjoge3JlcGxhY2Vfc3RyaW5nOiB7cmVnZXg6ICIvL2ciLCByZXBsYWNlX3N0cmluZzogIiJ9fSU+DQogICAgICAgICAgICAgICAgXSkuc2VjdXJpdHlDb250cm9sKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnU2VjdXJpdHkgQ29udHJvbCcsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnc3lzX2h1Yl9mbG93JykubmFtZShgc3lzX3Njb3BlLnNjb3BlPSR7dGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpfWApLnR5cGUobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBUeXBlJywgdHJ1ZSklPigpLmNvZGUoJ2NsaWVudF9jYWxsYWJsZV9mbG93X29iamVjdCcpKS5vcGVyYXRpb24obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBPcGVyYXRpb24nLCB0cnVlKSU+KCkuY29kZSgnZXhlY3V0ZScpKS48JWFwcCgpJT4pLCB7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy9leHBvcnRlcjogdiA9PiB2Lm9iaiA9IHYucmV1c2VkP25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdycsIHRydWUpJT4odi5vYmouSWQpOnYub2JqLCAvKmluZm9ybWF0aW9uIGxvc3MqLw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIE51bGw6ICFiSGVhZGVyLA0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgDQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqPCVpZigwIHx8IChbJ25hbWUnLCAncmVtYXJrJywgJ2RhdGUnLCAnb3JkZXInLCAnYWN0aXZlJywgJ2VuYWJsZWQnXS5pbmRleE9mKGVhLk5hbWUpPDApKXslPi5mbG93X0Zsb3dfVmFyaWFibGVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKGVhQ29kZSkubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPicpLnR5cGUoPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4nSlNPTic8JSB9ZWxzZXslPic8JT1fRnJFTUQuX2F0dHIoZWEpJT4nPCV9JT4pPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lLCAiZWFDb2RlIiklPiwNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCc8JT1uTmFtZShjKSU+LjwlPWVhLk5hbWUlPi5TZXQnKS5jb2RlKGVhQ29kZSArICdfc2V0JykubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiBTZXQnKS50eXBlKCdCb29sJyk8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUgKyAnIFNldCcsICJlYUNvZGUgKyAnX3NldCciKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoZWFDb2RlICsgJ19vcCcpLm5hbWUoJzwlPXNyLkVuZ2xpc2hOYW1lKGVhLk5hbWUpJT4gT3BlcmF0b3InKS50eXBlKCdTdHJpbmcnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSArICcgT3BlcmF0b3InLCAiZWFDb2RlICsgJ19vcCciKSU+LA0KICAgICAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnU2V0ICcrZWEuTmFtZSwgJ1NldCBGbG93IFZhcmlhYmxlcycsIFsNCiAgICAgICAgICAgICAgICAgICAgICAgIGVhLkVudGl0eVR5cGU/bnVsbDp7Y2Q6ICJlYUNvZGUiLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5qc29ufX0nIiwgdHJuOiBPYmplY3QuYXNzaWduKHt9LCB7dmFsdWVfbWFwOiB7a2V5OiAiJHtlYUNvZGV9IiwgZGVmYXVsdDogIiJ9fSwgZWEuX0lzRGF0ZT97c3RyaW5nX3RvX2RhdGU6IHtkYXRlX2Zvcm1hdDogInl5eXktTU0tZGRcJ1RcJ0hIOm1tOnNzXCdaXCciLCBjdXN0b21fZm9ybWF0OiAiIn19Ont9KX0sDQogICAgICAgICAgICAgICAgICAgICAgICAvL3tjZDogImVhQ29kZSsnX3NldCciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX19JyIsIHRybjoge2lzX251bGw6IHt9fX0sDQogICAgICAgICAgICAgICAgICAgICAgICAvL3tjZDogImVhQ29kZSsnX29wJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLm9wZXJhdG9yc319JyIsIHRybjoge3ZhbHVlX21hcDoge2tleTogIiR7ZWFDb2RlfSJ9fX0sDQogICAgICAgICAgICAgICAgICAgIF0pJT4ubG9naWNfRmxvd19JbnB1dF9TY3JpcHRzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT5uZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCdTZXQgPCU9ZWEuTmFtZSU+JykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlKS5yZW1hcmsoYHJldHVybiBmZF9kYXRhLmZsb3dfdmFyLmpzb24uJHtlYUNvZGV9O2ApLDwlfSU+DQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5uYW1lKCdTZXQgPCU9ZWEuTmFtZSU+IFNldCcpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSArICdfc2V0JykucmVtYXJrKGByZXR1cm4gdHlwZW9mKGZkX2RhdGEuZmxvd192YXIuanNvbi4ke2VhQ29kZX0pIVx1MDAzZFx1MDAzZFx1MDAyN3VuZGVmaW5lZFx1MDAyNztgKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4gT3BlcmF0b3InKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUgKyAnX29wJykucmVtYXJrKGByZXR1cm4gKGZkX2RhdGEuZmxvd192YXIuanNvbi5PUEVSQVRPUlMgfHwge30pLiR7ZWFDb2RlfTtgKSwNCiAgICAgICAgICAgICAgICAgICAgXSksDQoNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnSWYgJyArIGMuTmFtZSArICcgJytlYS5OYW1lKycgU2V0JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuJyArIGVhQ29kZSArICdfc2V0fX09dHJ1ZScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPi5wYXJlbnRfRmxvd19JbnN0YW5jZXMoPCVzdWJmbG93KCduZXcgJytzY29wZSsnLicrX2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpKycoKS4nK21OYW1lKycoZmFsc2UsIHRydWUpJywge2pzb246ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fScifSklPik8JX0lPg0KICAgICAgICAgICAgICAgICAgICAucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FkZCAnK2VhLk5hbWUrJyB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX1eJytlYUNvZGUifV0pJT4sDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdJZiAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBPcGVyYXRvciBpcyBub3QgZW1wdHknLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnX29wfX0hPScifV0pJT4ucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgJytlYS5OYW1lKycgT3BlcmF0b3IgdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5JywgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19e3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKydfb3B9fScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnRWxzZSAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBub3QgU2V0JywgJ0Vsc2UnKSU+LnBhcmVudF9GbG93X0xvZ2ljcyhbDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kID0gdG8gJyArIGMuTmFtZSArICcgRVF1ZXJ5IGZvciAnK2VhLk5hbWUsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fT0nIn1dKSU+DQogICAgICAgICAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT48JWxvZ2ljKCdGb3IgZWFjaCAnK2MuTmFtZSsnICcrZWEuTmFtZSwgJ0ZvciBFYWNoJywgW3tjZDogIidpdGVtcyciLCB2OiAiJ3t7MDE5NWQ3MDJlNWUwNzMzYzkwYzA1YjM1MDVjMDY2ZGYuIitlYS5FbnRpdHlUeXBlLk5hbWUrIl9saXN0fX0nIn1dKSU+LnBhcmVudF9GbG93X0xvZ2ljcyhbPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCAnK2VhLk5hbWUrJyB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX17e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319JyJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlaWYoZWEuRW50aXR5VHlwZSl7JT5dKTwlfSU+LA0KICAgICAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICBdKTwlfSU+DQogICAgICAgICAgICAgICAgLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iajwlaWYoMCB8fCBbJ1VzZXInLCAnR2VuZGVyJywgJ19TdHVkZW50JywgJ19UZWFjaGVyJ10uaW5kZXhPZih0YS5FbnRpdHlDbGFzcy5OYW1lKT49MCl7JT4uZmxvd19GbG93X0xvZ2ljcyhbPCVsb2dpYygnSWYgJyt0YU5hbWUrJyBub3QgZW1wdHknLCAnSWYnKSU+LnBhcmVudF9GbG93X0luc3RhbmNlcyg8JXN1YmZsb3coJ25ldyAnK3Njb3BlKycuJytfY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpKycoKS4nK21OYW1lKycoYkRyYWZ0LCB0cnVlKScsIHtqc29uOiAiJ3Rlc3QnIn0pJT4pXSk8JX0lPiwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF9sb29rdXA6IG9iaiA9PiBvYmouZmxvd19GbG93X0xvZ2ljcyhbPCVsb2dpYygnSWYgRVF1ZXJ5IG5vdCBlbXB0eScsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19IT0nIn1dKSU+DQogICAgICAgICAgICAgICAgICAgIC5wYXJlbnRfQWN0aW9uX0luc3RhbmNlcyhbDQogICAgICAgICAgICAgICAgICAgICAgICA8JWFjdGlvbignbG9va191cF9yZWNvcmRzJywge3RhYmxlOiAnIjAxOTVkNzAyZTVlMTczZmZiYjg0N2Q3OGNkZTJhOTIyXyIrKCcrX25Db2RlKCkrJykudG9Mb3dlckNhc2UoKSd9KSU+LA0KICAgICAgICAgICAgICAgICAgICBdKS5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oKS5uYW1lKCdTZXQgQ29uZGl0aW9uJykuYWN0aXZlKHRydWUpLmNvZGUoJ2NvbmRpdGlvbnMnKS5yZW1hcmsoYHJldHVybiBmZF9kYXRhLmZsb3dfdmFyLmVxdWVyeTtgKSwNCiAgICAgICAgICAgICAgICAgICAgXSkNCiAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICBfc25hcHNob3Q6IG9iaiA9PiBiRHJhZnQ/bnVsbDpvYmouZmxvd19GbG93X1NuYXBzaG90cyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgU25hcHNob3QnLCB0cnVlKSU+KDwlPV9maWQoKSU+KS5zbmFwc2hvdF9GbG93X1BsYW5zKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFBsYW4nLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWMuTmFtZSU+X1BsYW4nKS5uYW1lKCc8JT1jLk5hbWUlPiBQbGFuJykNCiAgICAgICAgICAgICAgICAgICAgXSkuZnJvbUZsb3codGhpcy48JT1tTmFtZSU+KHRydWUpKSksDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGJEcmFmdCwgYkhlYWRlcik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3RvU05TY3JpcHQnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgPCUgaWYoX2NOYW1lKCdBcHBsaWNhdGlvbicpKXslPg0KICAgICAgICAgICAgbGV0IGV4cCA9IG9wdGlvbnMucmF3PyJfdG9KU09OIjoiX3RvRG9jdW1lbnQiOw0KICAgICAgICAgICAgbGV0IHJvbGxiYWNrID0gKG9wdGlvbnMuYXBwICYmIG9wdGlvbnMucm9sbGJhY2spP2F3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUm9sbGJhY2sgQ29udGV4dCcsIHRydWUpJT4oKS5jb2RlKCdsYXN0JylbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBkYiA9IG9wdGlvbnMuZGI/YXdhaXQgb3B0aW9ucy5fdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlRhYmxlKClbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBmbG93ID0gb3B0aW9ucy5mbG93P2F3YWl0IG9wdGlvbnMuX3RoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05GbG93KG9wdGlvbnMuZHJhZnQpW2V4cF0oT2JqZWN0LmFzc2lnbih7YkpTT046IHRydWV9LCBvcHRpb25zKSk6IiI7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKG9wdGlvbnMuZ3ppcCl7DQogICAgICAgICAgICAgICAgaWYoZmxvdykgZmxvdyA9IHRoaXMuVXRmOEFycmF5VG9TdHIoYXdhaXQgdGhpcy5fY29tcHJlc3MoZmxvdykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdGVzdCA9IChvcHRpb25zLnRlc3QgJiYgb3B0aW9ucy5mbG93ICYmICFvcHRpb25zLmRyYWZ0KT9gXG4vKmdzLmNhY2hlRmx1c2goKTsgKi9ncy5pbmZvKHNuX2ZkLkZsb3dBUEkuZ2V0UnVubmVyKCkuc3ViZmxvdygnJHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9LlVzZXJfbG9va3VwJykuaW5Gb3JlZ3JvdW5kKCkud2l0aElucHV0cyh7anNvbjoge2NvZGU6InRlc3QiLGRhdGU6JzIwMjQtMDUtMDNUMTg6NDQ6MDMuMTc3WicsZ2VuZGVyOntjb2RlOiJNIiwgT1BFUkFUT1JTOiB7Y29kZTogIiE9In19LHVzZXJfU3R1ZGVudHM6W3tjb2RlOiJTVEEiLGdlbmRlcjp7Y29kZToiTSJ9fV0sIE9QRVJBVE9SUzoge2RhdGU6ICc8J319fSkucnVuKCkuZ2V0T3V0cHV0cygpWyJVc2VyX2xpc3QiXSk7XG5gOicnOw0KICAgICAgICAgICAgbGV0IGFwcCA9IG9wdGlvbnMuYXBwPyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOU2F2ZShvcHRpb25zKSArIGBcbiB2YXIgY29uZmlnID0ge0FwcGxpY2F0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBUYWJsZToge2lkS2V5OiAnbmFtZScsIExvZ1NldDogMH0sIENvbHVtbjoge0xvZ1NldDogMH0sIEVsZW1lbnRfTWFwcGluZzoge0xvZ1NldDogMH0sIEFjdGlvbl9JbnB1dDoge3JlYWRPbmx5OiB0cnVlfSwgQWN0aW9uX1R5cGU6IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICdtYXN0ZXJfc25hcHNob3QnfSwgQWN0aW9uX0luc3RhbmNlOiB7TG9nU2V0OiAwfSwgU2VjdXJpdHlfVHlwZToge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ25hbWUnfSwgU2VjdXJpdHlfT3BlcmF0aW9uOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbmFtZSd9LCBMb2dpY19EZWZpbml0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBGbG93OiB7TG9nU2V0OiAwfSwgVHJhbnNmb3JtOiB7cmVhZE9ubHk6IHRydWV9LCBUcmFuc2Zvcm1fQ29tcG9zaXRpb246IHtyZWFkT25seTogdHJ1ZX0sIFJvbGxiYWNrX0NvbnRleHQ6IHtyZWFkT25seTogdHJ1ZX19OyBcbmAgKyAob3B0aW9ucy5yb2xsYmFjaz8oInZhciBjaWQgPSBzYXZlUm9sbGJhY2tfQ29udGV4dCgiK3JvbGxiYWNrK2ApOyBpZihjaWQpe3ZhciBydyA9IG5ldyBHbGlkZVJvbGxiYWNrV29ya2VyKCk7IHJ3LnNldFJvbGxiYWNrQ29udGV4dElEKGNpZC5zeXNfaWQpOyBydy5zdGFydCgpO30gXG5gKToiIikrIChvcHRpb25zLmRiPygic2F2ZVRhYmxlKCIrZGIrIik7IFxuIik6IiIpICsgKG9wdGlvbnMuZmxvdz8oInNhdmVGbG93KCIrZmxvdysiKTsgXG4iKToiIikgKyB0ZXN0KToocm9sbGJhY2sgKyBkYiArIGZsb3cpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2NyaXB0ID0gdGhpcy5fYmVhdXRpZnkoYXBwLCAnamF2YXNjcmlwdCcpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5kZXBsb3kpIHJldHVybiBzY3JpcHQ7DQogICAgPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TTlNhdmUnJT4ob3B0aW9ucyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIDwlIHZhciBfZlJlZ0V4cCA9IC9fZntbXn1dK30vZ207ICU+DQogICAgICAgICAgICBsZXQgX2YgPSAodiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gdjsNCiAgICAgICAgICAgICAgICAgICAgLy9pZih2LnN0YXJ0c1dpdGgoImYoIikgJiYgdi5lbmRzV2l0aCgiKSIpKSByZXQgPSAnKCcrdi5zbGljZSgyLC0xKSsnKSc7DQogICAgICAgICAgICAgICAgICAgIGlmKHYuc3RhcnRzV2l0aCgicygiKSAmJiB2LmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gYChmdW5jdGlvbiAob2JqLCAke2VhQ29kZX0pe2Ardi5zbGljZSgyLC0xKStgfSkob2JqLCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYocmV0ICYmIHJldC5tYXRjaCAmJiByZXQubWF0Y2goPCU9X2ZSZWdFeHAlPikpIHJldCA9IGAoZnVuY3Rpb24gKG9iaiwgJHtlYUNvZGV9KXske3JldC5pbmRleE9mKCJyZXR1cm4iKTwwPyJyZXR1cm4gIjoiIn0gJ2ArcmV0LnJlcGxhY2UoPCU9X2ZSZWdFeHAlPiwgbSA9PiBgJyArICR7bS5zbGljZSgzLCAtMSl9ICsgJ2ApK2AnO30pKG9iaiwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgICAgIGlmKHJldCAmJiByZXQubWF0Y2ggJiYgcmV0Lm1hdGNoKC8wMTk1ZDcwMmU1ZTE3M2ZmYmI4NDgxNGMyZWUwMDU3MF0rPj4vZ20pKSByZXQgPSAnIiInOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYChmdW5jdGlvbih2KXsgdHJ5eyByZXR1cm4gKHYgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoPCU9X2ZSZWdFeHAlPiwgZnVuY3Rpb24obSl7cmV0dXJuIGV2YWwobS5zbGljZSgzLCAtMSkpO30pOnY7ICB9Y2F0Y2goZXgpe2dzLmluZm8oJ19me0V4Y2VwdGlvbn06ICR7ZWFDb2RlfTogJyArIGV4KTsgcmV0dXJuIHY7fSB9KSgke3JldH0gfHwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBlYUNvZGU7DQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7SWQ6ICI8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+IiwgdmFyczogYGAsIGNvZGU6IGBgLCBxdWVyeTogYGAsIHNldDogYGAsIGVzZXQ6IGBgLCBkc2V0OiBgYCwgdGFzOiBgYCwgZGVwczoge319LCB7DQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e2NvZGU6IHYub2JqLmNvZGUgKyBgXG5cbi8qKiByZXVzZWQ6IHYub2JqLklkKiovXG5cbmAsIGRlcHM6ICcnLCBJZDogdi5vYmouSWR9LA0KDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLklkID0gYGlmKG9iai4ke2lkQ29kZX0gJiYgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKS5sZW5ndGg9PTMyKXtfdG9TdHJpbmcrPSdfJytvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpOyBnci5nZXQoJ3N5c19pZCcsIG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykpO31cbmA7DQogICAgICAgICAgICAgICAgICAgIG9iai5pZFRvU3RyaW5nID0gYF90b1N0cmluZyArPSAob2JqP29iai4ke2lkQ29kZX06KCdncl8nK2dyLnN5c19pZCkpICsgJzogJzsgYDsNCiAgICAgICAgICAgICAgICAgICAgb2JqLm5ld1VVSUQgPSBgaWYoIW9iai4ke2lkQ29kZX0gfHwgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKS5sZW5ndGghPTMyKXtvYmouJHtpZENvZGV9ID0gZ3Iuc2V0TmV3R3VpZCgpO31lbHNle2dyLnNldE5ld0d1aWRWYWx1ZShvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpKTt9fVxuYDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUhPWMpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICA8JSB9JT4NCg0KICAgICAgICAgICAgICAgICAgICBvYmoudmFycyArPSBgdmFyICR7ZWFDb2RlfSA9IDwlaWYoZWEuRW50aXR5VHlwZSl7JT4oKChyZWZzLjwlPW5OYW1lKGVhKSU+ID0gKHR5cGVvZihvYmouJHtlYUNvZGV9KSE9PSd1bmRlZmluZWQnPy8qdGhpcy4qL3NhdmU8JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+KG9iai4ke2VhQ29kZX0sIHs8JT1uTmFtZShjKSU+OiBvYmosIDwlPW5OYW1lKGMvKmVhKi8pJT5SZWZzOiByZWZzLCA8JT1uTmFtZShjKS50b0xvd2VyQ2FzZSgpJT46IGdyfSwgIjwlPW5OYW1lKGMpJT4iLCByZWZzLjwlPW5OYW1lKGVhKSU+IHx8IC8qRVhQOiByZWZzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpLnRvTG93ZXJDYXNlKCklPiB8fCAqLygke19mKDwldmFsdWVPZihlYS5EZWZhdWx0KSU+LCBlYUNvZGUpfSkpOnJlZnMuPCU9bk5hbWUoZWEpJT4pKSB8fCB7c3lzX2lkOiAnJ30pWy8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+LmlkS2V5IHx8ICJzeXNfaWQiXSkudG9TdHJpbmcoKTwlfWVsc2V7JT5vYmouJHtlYUNvZGV9PCV9JT47YDsNCiAgICAgICAgPCUgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5xdWVyeSArPSBgX3RvU3RyaW5nKz0nXycrJHtlYUNvZGV9OyBfdG9RdWVyeS4ke2VhQ29kZX0gPSAke19mKHYsIGVhQ29kZSl9OyBgOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnNldCArPSBgaWYodHlwZW9mKF90b1NldC4ke2VhQ29kZX0gPSAke19mKHYsIGVhQ29kZSl9KSE9PSd1bmRlZmluZWQnPCVpZihlYS5FbnRpdHlUeXBlKXslPiYmIF90b1NldC4ke2VhQ29kZX08JX0lPikgZ3Iuc2V0VmFsdWUoJyR7ZWFDb2RlfScsIF90b1NldC4ke2VhQ29kZX0pO2A7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmouZXNldCArPSBgaWYodHlwZW9mKF90b1NldC4ke2VmQ29kZX0gPSAke19mKEpTT04uc3RyaW5naWZ5KHYpLCAnb2JqLicrZWZDb2RlKX0pIT09J3VuZGVmaW5lZCcpIGdyLnNldFZhbHVlKCcke2VmQ29kZX0nLCBfdG9TZXQuJHtlZkNvZGV9KTtgLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai50YXMgKz0gYHJlZnMuPCU9dGFOYW1lJT4gPSAoKG9iaj9vYmouJHtlYUNvZGV9OltdKSB8fCBbXSkubWFwKGZ1bmN0aW9uKG8pe2dzLmluZm8oX3RvU3RyaW5nICsgJyA9PiBzYXZlPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4oJHtlYUNvZGV9W10pJyk7IHJldHVybiAvKnRoaXMuKi9zYXZlPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4obywgezwlPW5OYW1lKGMpJT46IG9iaiwgPCU9bk5hbWUoYykudG9Mb3dlckNhc2UoKSU+OiBnciwgbWFueVJlZnM6IHJlZnN9LCAiPCU9bk5hbWUoYyklPiIpO30pO2ANCiAgICAgICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIXJldC5kc2V0KSByZXQuZHNldCArPSBgXG5pZih0eXBlb2Yob2JqKT09PSJvYmplY3QiKSBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihmdW5jdGlvbihrKXtyZXR1cm4gIWsuc3RhcnRzV2l0aCgnX18nKSAmJiBbJ3N5c19pZCcsICdJZCcsICdPUEVSQVRPUlMnXS5pbmRleE9mKGspPDAgJiYgdHlwZW9mKF90b1NldFtrXSk9PT0ndW5kZWZpbmVkJyAmJiAhQXJyYXkuaXNBcnJheShvYmpba10pO30pLmZvckVhY2goZnVuY3Rpb24oayl7X3RvU2V0W2tdID0gJHtfZigib2JqW2tdIiwgIm51bGwiKX07IGlmKF90b1NldFtrXSAmJiBfdG9TZXRba10uX19jbGFzcyl7X3RvU2V0W2tdID0gX3RvU2V0W2tdW2NvbmZpZ1tfdG9TZXRba10uX19jbGFzc10uaWRGaWVsZCB8fCAnSWQnXTsgfSBnci5zZXRWYWx1ZShrLCBfdG9TZXRba10gKTsgfSlcbmA7DQoNCiAgICAgICAgICAgIHJldC5jb2RlICs9IGAke09iamVjdC52YWx1ZXMocmV0LmRlcHMpLmpvaW4oJ1xuJyl9ZnVuY3Rpb24gc2F2ZTwlPW5OYW1lKGMpJT4ob2JqLCByZWZzLCBzb3VyY2UsIGdyKXtyZWZzID0gcmVmcyB8fCB7fTsgLyp0aGlzLiovY29uZmlnLnNhdmVfJHs8JT1fbkNvZGUoKSU+fSA9IHNhdmU8JT1uTmFtZShjKSU+OyAvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPiA9IC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+IHx8IHt9OyAvKnRoaXMuKi9jb25maWcuX2lkTWFwID0gLyp0aGlzLiovY29uZmlnLl9pZE1hcCB8fCBbXTsgdmFyIF90b1N0cmluZyA9IHNvdXJjZSArICdbJyArIChyZWZzW3NvdXJjZV0uc3lzX2lkKSArICddPT4gc2F2ZTwlPW5OYW1lKGMpJT4oJzsgaWYodHlwZW9mKG9iaik9PT0nc3RyaW5nJyAmJiBvYmoubGVuZ3RoPj0zMil7dmFyIHJldCA9IHt9OyByZXRbLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uaWRLZXkgfHwgInN5c19pZCJdPW9iajsgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnKTogb2JqIGlzIHV1aWQsIHJldHVybmluZyB7JytvYmorJ30nKTsgcmV0dXJuIHJldDt9IGlmKCFvYmogJiYgIWdyKXtncy5pbmZvKF90b1N0cmluZyArICcpOiBvYmogaXMgbnVsbCcpOyByZXR1cm4gbnVsbDt9ICR7cmV0LmlkVG9TdHJpbmd9IHZhciBiU2F2ZSA9ICEvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5yZWFkT25seTsgaWYoIWdyKXsgZ3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTtcbiR7cmV0LklkfVxuJHtyZXQudmFyc31cbmlmKCFnci5pc1ZhbGlkUmVjb3JkKCkpe2dyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7IHZhciBfdG9RdWVyeT17fTsgJHtyZXQucXVlcnl9IFxuX3RvU3RyaW5nICs9ICcpOiAnOyBpZihvYmouX19rZXlzICYmIChiU2F2ZSB8fCBjb25maWcuPCU9bk5hbWUoYyklPi5yZWFkT25seSkpe2lmKF90b1F1ZXJ5Ll9fZW5jb2RlZFF1ZXJ5KXtnci5hZGRFbmNvZGVkUXVlcnkoX3RvUXVlcnkuX19lbmNvZGVkUXVlcnkpO31lbHNle29iai5fX2tleXMuZm9yRWFjaChmdW5jdGlvbihrKXtnci5hZGRRdWVyeShrLCBfdG9RdWVyeVtrXSB8fCBvYmpba10pO30pO30gZ3Iuc2V0TGltaXQoMSk7IGlmKCFnci5nZXRFbmNvZGVkUXVlcnkoKSkgZ3IuYWRkUXVlcnkoJ3N5c19pZCcsICctMScpOyBncy5pbmZvKF90b1N0cmluZyArICdFbmNvZGVkIFF1ZXJ5OiAnICsgZ3IuZ2V0RW5jb2RlZFF1ZXJ5KCkpOyBnci5xdWVyeSgpO2lmKCFnci5uZXh0KCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ25vdCBmb3VuZCcpO31lbHNle2dzLmluZm8oX3RvU3RyaW5nICsgJ2ZvdW5kIFskezwlPV9uQ29kZSgpJT59LycgKyBnci5zeXNfaWQgKyAnXSAtIGlzIHZhbGlkOiAnICsgZ3IuaXNWYWxpZFJlY29yZCgpKTsgb2JqLklkID0gZ3Iuc3lzX2lkLnRvU3RyaW5nKCk7IGlmKG9iai5fX3JldXNlZCl7Lypncy5pbmZvKF90b1N0cmluZyArICc6IF9fcmV1c2VkOiBbJHs8JT1fbkNvZGUoKSU+fS8nICsgZ3Iuc3lzX2lkICsgJ10gLSBpcyB2YWxpZDogJyArIGdyLmlzVmFsaWRSZWNvcmQoKSk7ICovcmV0dXJuIGdyO30gfX19fWVsc2V7YlNhdmU9ZmFsc2U7fSBpZihiU2F2ZSAmJiAhZ3IuaXNWYWxpZFJlY29yZCgpKXtncy5pbmZvKF90b1N0cmluZyArICdpbnNlcnRpbmcuLi4nKTsgZ3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTsgZ3IuaW5pdGlhbGl6ZSgpOyAke3JldC5uZXdVVUlEfSBpZihiU2F2ZSAmJiBvYmope3ZhciBfdG9TZXQgPSB7fTsgLypzZXQqLyR7cmV0LnNldH0gLyplc2V0Ki8ke3JldC5lc2V0fSAgJHtyZXQuZHNldH0gaWYoLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uTm9Xb3JrZmxvdykgZ3Iuc2V0V29ya2Zsb3coZmFsc2UpOyBpZigvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5Mb2dTZXQpIGdzLmluZm8oX3RvU3RyaW5nICsgJ190b1NldDogJyArIEpTT04uc3RyaW5naWZ5KF90b1NldCkpOyB9ZWxzZSBpZighZ3IuaXNWYWxpZFJlY29yZCgpKXtncy5pbmZvKF90b1N0cmluZyArICdbYlNhdmU9JyArIGJTYXZlICsgJ10gLSByZXR1cm5pbmcgbnVsbC4nKTsgcmV0dXJuIG51bGw7fVxuaWYoIWJTYXZlIHx8IGdyLnVwZGF0ZSgpKXsgaWYoZmFsc2UgJiYgYlNhdmUpe2NvbmZpZy5faWRNYXAucHVzaCh7dGFibGU6ICckezwlPV9uQ29kZSgpJT59Jywgc3lzX2lkOiBnci5zeXNfaWQudG9TdHJpbmcoKSwga2V5czogb2JqLl9fa2V5cy5tYXAoZnVuY3Rpb24oayl7cmV0dXJuIHtrOiBrLCB2OiBfdG9RdWVyeVtrXSB8fCBvYmpba119O30pfSk7fSAke3JldC50YXN9XG5ncy5pbmZvKF90b1N0cmluZyArICdbYlNhdmU9JyArIGJTYXZlICsgJ10gLSByZXR1cm5pbmcgJyArIGdyLnN5c19pZCk7IHJldHVybiBncjt9fVxuYDsNCg0KICAgICAgICAgICAgLypyZXR1cm4gT2JqZWN0LnZhbHVlcyhPYmplY3QuYXNzaWduKHt9LCAuLi5yZXQuY29kZS5zcGxpdCgnZnVuY3Rpb24gc2F2ZScpLmZpbHRlcihzID0+IHMpLnNvcnQoKGEsIGIpID0+IGEubGVuZ3RoIC0gYi5sZW5ndGgpLm1hcChzID0+ICh7W3Muc3BsaXQoJyhvYmosIHJlZnMsIHNvdXJjZSwgZ3IpJylbMF1dOiAnZnVuY3Rpb24gc2F2ZScrc30pKSkpLmpvaW4oJ1xuJyk7ICovDQogICAgICAgICAgICByZXR1cm4gcmV0LmNvZGU7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NOUXVlcnknJT4oZmllbGRzLCBvYmpzLCBiVVJMKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgIE9QRVJBVE9SUzogdHJ1ZSwNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gdiwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdj92LjwlPW1OYW1lJT4oKTpudWxsOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsNCiAgICAgICAgICAgICAgICBsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOw0KICAgICAgICAgICAgICAgIGlmKCh2LmdldEhvdXJzKCk9PTAgJiYgdi5nZXRNaW51dGVzKCk9PTAgJiYgdi5nZXRTZWNvbmRzKCk9PTApIHx8IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSc9JyB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCl7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCE9PSdCRVRXRUVOJyl7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgIG9iai5PUEVSQVRPUlMuPCU9bk5hbWUoZWEpJT4gPSAnPSc7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICANCiAgICAgICAgT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkhPT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YocmV0W2tdKSE9PSdvYmplY3QnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7DQoNCiAgICAgICAgZGVsZXRlIHJldC5PUEVSQVRPUlM7DQogICAgICAgIE9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOw0KDQogICAgICAgIHJldCA9IERvdE9iamVjdC5kb3QocmV0KTsNCg0KICAgICAgICAvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMNCiAgICAgICAgT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KDQogICAgICAgIGlmKGJVUkwpIHJldCA9IE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KCTwlPW1OYW1lPSdfX2V4cG9ydCclPihvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsNCgkgICAgdHJ5ew0KICAgIAkgICAgaWYoIW9iaikgcmV0dXJuIHRoaXM7DQogICAgCSAgICANCiAgICAJICAgIGlmKG9wdGlvbnMuT1BFUkFUT1JTKSBvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsNCiAgICAJICAgIA0KICAgIAkgICAgPCUgLyogSU1QT1JUQU5UOiB0aGlzLklkPT10aGlzLklkIG1ha2VzIHN1cmUgdGhlIElkIGlzIGZpeGVkIGZvciB0aGUgdG9vbCwgbm90IGdldHRpbmcgZ2VuZXJhdGVkIGV2ZXJ5IHRpbWUgd2UgY2FsbCBpdCAqLyAlPg0KICAgIAkgICAgDQogICAgCSAgICBsZXQgZWFDb2RlcyA9IHsNCiAgICAJICAgICAgICBleHBvcnRlcjogIiIsDQogICAgCSAgICAgICAgSWQ6ICIiLA0KICAgIAkgICAgfTsNCiAgICAJICAgIA0KICAgIAkJaWYgKCFvcHRpb25zLlVuaXF1ZSAmJiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCkpIHRoaXMuX19vcHRpb25zKCJJZCIsIG9iaiwgZWFDb2Rlcy5JZCA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ0lkJyk6J0lkJyksIHRoaXMuSWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQogICAgCQkNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVmLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoImVmXzwlPW5OYW1lKGVmKSU+Iiwgb2JqLCBlYUNvZGVzLmVmXzwlPW5OYW1lKGVmKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWYpJT46PCVfdkNvZGUoZWYpJT4pLCA8JXZhbHVlT2YoZWYuVmFsdWUpJT4sIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQo8JSB9KSU+DQoNCgkJICAgIDwlIHVuUmVjdXJzZSgnb2JqJywgJ2Z1bicsICdmQXJncycsICdpZih0eXBlb2Yob3B0aW9ucy5leHBvcnRlcik9PT0iZnVuY3Rpb24iKSBvcHRpb25zLmV4cG9ydGVyKHYpJyklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiAhZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiX1RISVMiLCBvYmosIGVhQ29kZXMuX1RISVMgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdfVEhJUycpOiJfVEhJUyIpLCB0aGlzLl9USElTLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT10YU5hbWUlPiIsIG9iaiwgZWFDb2Rlcy48JT10YU5hbWUlPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKHRhLCB0cnVlKSU+OiI8JT10YU5hbWUlPiIpLCB0aGlzLjwlPXRhTmFtZSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQodGEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pPT09J2Z1bmN0aW9uJyAmJiAhT2JqZWN0LmtleXMoZWFDb2RlcykuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiB0aGlzLl9fb3B0aW9ucyhrLCBvYmosIGssIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKSk7DQogICAgICAgIA0KICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gfHwge307DQogICAgICAgICAgICAoPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgfHwgW10pLmZvckVhY2gobiA9PiBuLl9jW24uZWFGaWVsZF0obi5fY1tuLmVhRmllbGRdKCkuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiB0cnVlLCBub0FyZ3M6IHRydWUsIF9tYXA6IG9wdGlvbnMuX21hcH0sIGZ1bikpKTsNCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljID0gW107IC8vPz8NCiAgICAgICAgICAgIA0KICAgIAkJcmV0dXJuIG9iajsNCiAgICAJfWNhdGNoKGV4KXsNCiAgICAJICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAJfQ0KCX0NCgkNCgk8JT1tTmFtZT0nX19vcHRpb25zJyU+KGZpZWxkLCBvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzPXRoaXMsIG9wdGlvbnM9e30sIGZ1biwgZWFGaWVsZCl7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZmllbGQsIG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXMsIG9wdGlvbnMsIGZ1biwgZWFGaWVsZCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsNCiAgICAgICAgICAgIGlmKCFvYmopIHJldHVybjsNCiAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkhPT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZWFPYmopIT09J3VuZGVmaW5lZCcgJiYgIW9wdGlvbnMuTnVsbCl7DQogICAgICAgICAgICAgICAgaWYoZmllbGQhPSdJZCcgJiYgdHlwZW9mKF90aGlzW2ZpZWxkXSk9PT0nZnVuY3Rpb24nICYmICFfdGhpc1snXycrZmllbGQrJ19zZXQnXSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpIT09J3VuZGVmaW5lZCcpIGVhT2JqID0gZWFPYmouZmlsdGVyKHYgPT4gdik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLk51bGwgJiYgQXJyYXkuaXNBcnJheShlYU9iaikgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOw0KDQogICAgICAgICAgICBsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXMpOw0KICAgICAgICAgICAgaWYob3B0aW9ucy5PUEVSQVRPUlMgJiYgX3RoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwge1tmaWVsZF06IF90aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ119KTsNCg0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuQ3ljbGljICYmIGVhRmllbGQgJiYgb2JqICYmIG9iai5FbnRpdHlDbGFzcyAmJiB0eXBlb2Yob2JqW2ZpZWxkXSk9PT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSB8fCB7fTsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljIHx8IFtdOw0KICAgICAgICAgICAgICAgIGxldCBfY3ljbGVzID0gb2JqW2ZpZWxkXSgpOw0KICAgICAgICAgICAgICAgIGlmKCFBcnJheS5pc0FycmF5KF9jeWNsZXMpKSBfY3ljbGVzID0gW19jeWNsZXNdOw0KICAgICAgICAgICAgICAgIF9jeWNsZXMgPSBfY3ljbGVzLmZpbHRlcihfYyA9PiBfYyAmJiB0eXBlb2YoX2NbZWFGaWVsZF0pPT09J2Z1bmN0aW9uJyAmJiBfY1snXycgKyBlYUZpZWxkICsgJ19zZXQnXSAmJiBvYmouX3NhbWVFbnRpdHkoX2NbZWFGaWVsZF0oKSkpLm1hcChfYyA9PiAoew0KICAgICAgICAgICAgICAgICAgICAvKm1hcmsgX2NbZWFGaWVsZF1fc2V0IHRvIG51bGwgaW5zdGVhZCovDQogICAgICAgICAgICAgICAgICAgIF9jLA0KICAgICAgICAgICAgICAgICAgICBlYUZpZWxkLA0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgICAgICAgICBpZihfY3ljbGVzLmxlbmd0aCkgPCU9d2FybigpJT5mdW4gKyAiL19jeWNsZXMiLCBfY3ljbGVzKTsNCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYy5wdXNoKC4uLl9jeWNsZXMpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZihvcHRpb25zLl9tYXApIF90aGlzLl9tYXAoZmllbGQsIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJywgZnVuLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCc/b2JqOmVhT2JqLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCc/X3RoaXM6b2JqLCBlYUNvZGUpOw0KDQogICAgICAgICAgICByZXR1cm4gX3JldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmZ1biwgZmllbGQsIGV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQoJfQ0KCQ0KCTwlPW1OYW1lPSdfX2ltcG9ydCclPihvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsNCiAgICAgICAgaWYodHlwZW9mKG9iaikhPT0nb2JqZWN0Jyl7DQogICAgICAgICAgICA8JT13YXJuKCklPmAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQoJICAgIA0KICAgICAgICBsZXQgZWFDb2RlcyA9IHt9Ow0KDQoJCWlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCJJZCIsIG9iaiwgZWFDb2Rlcy5JZCA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ0lkJyk6J0lkJyksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCgkJDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KCQk8JSB1blJlY3Vyc2UoJ3RoaXMnLCAnZnVuJywgJ2ZBcmdzJywgJ2lmKHR5cGVvZihvcHRpb25zLmltcG9ydGVyKT09PSJmdW5jdGlvbiIpIG9wdGlvbnMuaW1wb3J0ZXIodiknKSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmICFlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCgkJaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIl9USElTIiwgb2JqLCBlYUNvZGVzLl9USElTID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnX1RISVMnKTonX1RISVMnKSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7DQogICAgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7DQolPg0KICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiPCU9dGFOYW1lJT4iLCBvYmosIGVhQ29kZXMuPCU9dGFOYW1lJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZSh0YSwgdHJ1ZSklPjoiPCU9dGFOYW1lJT4iKSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKHRhKSU+Iik7DQo8JSB9KSU+DQoNCiAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pPT09J2Z1bmN0aW9uJyAmJiAhT2JqZWN0LmtleXMoZWFDb2RlcykuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiB0aGlzLl9fb3B0aW9ucyhrLCBvYmosIGssIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKSk7DQoNCgkJcmV0dXJuIHRoaXM7DQoJfQ0KDQo8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvQ3lUYWJsZSclPigpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7Y3FsOiBgDQpDUkVBVEUgQ09OU1RSQUlOVCBJRiBOT1QgRVhJU1RTIEZPUiAobzokezwlPV9uQ29kZSgpJT59KSBSRVFVSVJFIG8uJHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9IElTIFVOSVFVRTsNCkNSRUFURSBDT05TVFJBSU5UIElGIE5PVCBFWElTVFMgRk9SIChvOiR7PCU9X25Db2RlKCklPn0pIFJFUVVJUkUgby4ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0gSVMgTk9UIE5VTEw7DQogICAgICAgIGB9LCB7DQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmouY3FsICs9IHY/di48JT1tTmFtZSU+KCk6Jyc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgIG9iai5jcWwgKz0gYENSRUFURSBDT05TVFJBSU5UIElGIE5PVCBFWElTVFMgRk9SIChvOiR7PCU9X25Db2RlKCklPn0pIFJFUVVJUkUgby4ke2VhQ29kZX0gSVMgVU5JUVVFOw0KYA0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouY3FsICs9IHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4oKSkuam9pbignXG4nKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5jcWwpOw0KICAgICAgICByZXR1cm4gcmV0LmNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0N5TWVyZ2UnJT4oZmllbGRzLCBiUmF3KXsNCiAgICAgICAgbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzLCB0cnVlKTsNCiAgICAgICAgbGV0IHVrZXlzID0gW107DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICBpZig8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pIHVrZXlzLnB1c2goPCU9X25Db2RlKGVhKSU+KTsNCiAgICA8JSB9KSU+DQogICAgICAgIGxldCBjcWwgPSBgOiR7PCU9X25Db2RlKCklPn0ge2AgKyBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHVrZXlzLmluY2x1ZGVzKGspKS5tYXAoayA9PiBrICsgIjogIiArIG9ialtrXSkuam9pbignLCAnKSArIGB9KWA7DQogICAgICAgIA0KICAgICAgICBpZighYlJhdyl7DQogICAgICAgICAgICBsZXQgbWF0Y2ggPSAnXG5NQVRDSCAobycgKyBjcWw7DQogICAgICAgICAgICBjcWwgPSAnTUVSR0UgKG8nICsgY3FsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb25TZXQgPSBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+ICF1a2V5cy5pbmNsdWRlcyhrKSkubWFwKGsgPT4gIm8uIiArIGsgKyAiPSIgKyBvYmpba10pLmpvaW4oJywgJykNCiAgICAgICAgICAgIGNxbCArPSAnXG5PTiBDUkVBVEUgU0VUICcgKyBvblNldCArICdcbk9OIE1BVENIIFNFVCAnICsgb25TZXQ7DQogICAgICAgICAgICBjcWwgKz0gJ1xuUkVUVVJOIG87JzsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBjcWwgKz0gbWF0Y2ggKyAnLCAnICsgdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4obnVsbCwgdHJ1ZSkucmVwbGFjZSgnKDonLCAnKDwlPW5OYW1lKGVhKSU+OicpICsgJyBNRVJHRSAobyktWzo8JT1uTmFtZShjKSU+XzwlPW5OYW1lKGVhKSU+XS0+KDwlPW5OYW1lKGVhKSU+KTsnOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBjcWwgPSAnKCcgKyBjcWw7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5jcWwpOw0KICAgICAgICByZXR1cm4gY3FsOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9DeVF1ZXJ5JyU+KGZpZWxkcywgb2Jqcyl7DQogICAgICAgIGxldCBzcWwgPSAiTUFUQ0ggIjsNCiAgICAgICAgDQogICAgICAgIGxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKX0ke3RoaXMuX1EoKX1gOw0KDQogICAgICAgIGxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOw0KDQogICAgICAgIHNxbCArPSBgICgke3RQcmVmfToke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9KWA7DQogICAgICAgIA0KICAgICAgICBPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYCBPUFRJT05BTCBNQVRDSCAoJHt0aGlzLl9RKCl9JHtrfSR7dGhpcy5fUSgpfToke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0pIE9QVElPTkFMIE1BVENIICgke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKX0ke3RoaXMuX1EoKX0pLVs6JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX1dLT4oJHt0aGlzLl9RKCl9JHtrfSR7dGhpcy5fUSgpfSlgKTsNCiAgICAgICAgDQoNCiAgICAgICAgLy9zcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7DQogICAgICAgIC8vT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7DQogICAgICAgIA0KICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKXsNCiAgICAgICAgICAgIC8vIHtmaWVsZDogZnVuY3Rpb259DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPn0oJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9KWA7DQogICAgPCUgfSklPg0KICAgICAgICB9DQoNCiAgICAgICAgc3FsICs9IGAgd2hlcmUgMT0xYDsNCg0KICAgICAgICBzcWwgPSB0aGlzLl9fZXhwb3J0KHtzcWw6IHNxbH0sIHsNCiAgICAgICAgICAgIF9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpP1snSWQnXTp1bmRlZmluZWQsDQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4odC5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJOT1QgIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIiI7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIiI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7Y29vcH0gRVhJU1RTIHske3YuPCU9bU5hbWUlPigpfX1gOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgPCVpZihlYS5Jc0Jvb2wpeyU+Ij0iPCV9ZWxzZXslPih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIHx8ICJDT05UQUlOUyIpPCV9JT4gKyAiICI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYudG9JU09TdHJpbmcpew0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5fPCU9dGFOYW1lJT5fc2V0KSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuPCU9bU5hbWUlPigiPCU9bk5hbWUodGEpJT4uaWQiKSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGpPUCA9ICdVTklPTiBBTEwnOw0KICAgICAgICAgICAgICAgIGxldCBpbk9QID0gJ0lOJzsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBgOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J05PVCBJTicpew0KICAgICAgICAgICAgICAgICAgICBpbk9QID0gJ05PVCBJTic7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdJTicpew0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9PScpew0KICAgICAgICAgICAgICAgICAgICBqT1AgPSAnSU5URVJTRUNUJzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYW5kIC8qPCU9dGFOYW1lJT4qLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+IiwgZmllbGRzKS5zcWw7DQoNCiAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzKXsNCiAgICAgICAgICAgIGlmKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+PCU9KGVhLkVudGl0eVR5cGU/JysiaWQiJzonJyklPn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT59YDsNCiAgICA8JSB9KSU+DQogICAgICAgIH0NCg0KICAgICAgICBpZihzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKXsNCiAgICAgICAgICAgIC8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzcWwgKz0gJyByZXR1cm4gJyArIFt0UHJlZl0uY29uY2F0KE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykubWFwKGsgPT4gYCR7dGhpcy5fUSgpfSR7a30ke3RoaXMuX1EoKX1gKSkuam9pbignLCAnKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNxbDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX25lbzRqJyU+KGNxbCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnTmVvNGonXSk9PWMpeyU+DQogICAgICAgIGxldCBzZXNzaW9uID0gbnVsbDsNCiAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiIHx8ICFjcWwgfHwgIWNxbC50cmltKCkpew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIpIDwlPWxvZygpJT5jcWwsICIgPD09U0tJUFBFRD09PiIpOw0KICAgICAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgIGlmKGNxbC5pbmRleE9mKCc7XG4nKT4wKXsNCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHNxbFMgb2YgY3FsLnNwbGl0KCc7XG4nKSl7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGJTdG9yZSA9IFsiTUVSR0UiLCAiQ1JFQVRFIiwgIlVQREFURSJdLmZpbHRlcihuID0+IGNxbC5pbmRleE9mKG4pPj0wKS5maW5kKG4gPT4gbik7DQogICAgICAgICAgICBsZXQgYkRNTCA9IFsiQ09OU1RSQUlOVCJdLmZpbHRlcihuID0+IGNxbC5pbmRleE9mKG4pPj0wKS5maW5kKG4gPT4gbik7DQoNCiAgICAgICAgICAgIGlmKGJETUwpew0KICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShjcWwpXSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKGNxbCldID0gY3FsOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBzZXNzaW9uID0gdGhpcy5Ub29sLmRiLnNlc3Npb24oeyBkYXRhYmFzZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSB9KTsNCiAgICAgICAgICAgIGxldCBmdW4gPSAnUmVhZCc7DQogICAgICAgICAgICBpZihiU3RvcmUgfHwgYkRNTCkgZnVuID0gJ1dyaXRlJzsNCiAgICAgICAgICAgIGlmKGZ1bj09J1dyaXRlJykgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGNxbCk7DQogICAgICAgICAgICA8JT1sb2coKSU+Y3FsKTsNCiAgICAgICAgICAgIC8vcmV0ID0gKGF3YWl0IHNlc3Npb25bJ2V4ZWN1dGUnK2Z1bl0odHggPT4gdHgucnVuKGNxbCkpKS5yZWNvcmRzOw0KICAgICAgICAgICAgLy88JT1sb2coKSU+cmV0KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICBpZihzZXNzaW9uKSBhd2FpdCBzZXNzaW9uLmNsb3NlKCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ05lbzRqJ10pKSU+KCkuPCU9bU5hbWUlPihjcWwpOw0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydSeERCJywgJ01vbmdvREInXSkpeyU+DQogICAgPCU9bU5hbWU9J190b0pTT05TY2hlbWEnJT4oKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHR5cGUgPSB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUnLCAndHlwZScpOw0KICAgICAgICAgICAgbGV0IHNjaGVtYSA9IHsNCiAgICAgICAgICAgICAgICAkaWQ6ICc8JT1jLklkJT4nLA0KICAgICAgICAgICAgICAgICRzY2hlbWE6ICJodHRwczovL2pzb24tc2NoZW1hLm9yZy9kcmFmdC8yMDIwLTEyL3NjaGVtYSIsDQogICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICc8JT1jLlJlbWFyayU+JywNCiAgICAgICAgICAgICAgICB0aXRsZTogPCU9X25Db2RlKCklPiwNCiAgICAgICAgICAgICAgICBbdHlwZV06ICdvYmplY3QnLA0KICAgICAgICAgICAgICAgIHZlcnNpb246IDAsDQogICAgICAgICAgICAgICAgcHJvcGVydGllczogew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIFs8JT1fbkNvZGUoZWEpJT5dOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIjwlPWVhLlJlbWFyayU+IiwNCiAgICAgICAgICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5hcnJheScsICdhcnJheScpLA0KICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXM6IHsNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgICRyZWY6ICc8JT1lYS5FbnRpdHlDbGFzcy5JZCU+JywNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuc3RyaW5nJywgJ3N0cmluZycpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUudGV4dCcsICdzdHJpbmcnKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmJvb2wnLCAnYm9vbGVhbicpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbnQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5pbnQnLCAnaW50ZWdlcicpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNGbG9hdCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmZsb2F0JywgJ251bWJlcicpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbWFnZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmltYWdlJywgJ29iamVjdCcpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuZmlsZScsICdvYmplY3QnKSwNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IFs8JWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkubWFwKGVhID0+IHslPjwlPV9uQ29kZShlYSklPjwlfSkuam9pbignLCcpJT5dLA0KICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgPCU9bG9nKCklPnNjaGVtYSk7DQogICAgICAgICAgICByZXR1cm4gc2NoZW1hOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ01vbmdvREInLCAnUnhEQicsICdaYW5nb0RCJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9TZWxlY3RNZGInJT4oKXsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4gb2JqLl9pZCA9IHskaW46IHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KCkpfSwNCiAgICAgICAgICAgIElkOiBvYmogPT4gb2JqLl9pZCA9IHRoaXMuSWQsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgaWYoIXYuPCU9bU5hbWUlPikgcmV0dXJuOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHt9Ow0KICAgICAgICAgICAgICAgIGxldCBvcCA9ICIkZSI7DQogICAgICAgICAgICAgICAgc3dpdGNoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3Apew0KICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRlIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI+IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRndCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPCI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkbHQiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj49IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRndGUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIjw9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRsdGUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRuZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiSU4iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGluIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdW29wXSA9IHYuPCU9bU5hbWUlPigpLnRvSVNPU3RyaW5nKCk7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2LjwlPW1OYW1lJT4oKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9IHskaW46IHYubWFwKHQgPT4gdC48JT1tTmFtZSU+KCkpfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpKXslPg0KICAgIDwlPW1OYW1lPSdfdG9EQk9iamVjdCclPihmaWVsZHMsIGJOb1JlZil7DQogICAgICAgIGlmKCF0aGlzLklkKXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPiJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOw0KICAgICAgICB9DQogICAgICAgIGxldCByZXQgPSB7DQogICAgICAgICAgICBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXTogIiciICsgdGhpcy5JZCArICInIg0KICAgICAgICB9Ow0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgIGlmKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCI8JT1lYS5OYW1lJT4iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmICghYk5vUmVmIHx8IDwlPWVhLkVudGl0eVR5cGU/J2ZhbHNlJzondHJ1ZSclPikpew0KICAgICAgICAgICAgbGV0IGZWYWx1ZSA9IG51bGw7DQogICAgICAgICAgICBsZXQgdiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZD09di5JZCkpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiTlVMTCI7DQogICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9IHY/MTowOw0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09J05lbzRqJykgZlZhbHVlID0gZlZhbHVlPydUcnVlJzonRmFsc2UnOw0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09J1NxbERCJykgZlZhbHVlID0gIiciICsgZlZhbHVlICsgIiciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCB8fCBlYS5Jc0xvbmcgfHwgZWEuSXNGbG9hdCl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9IHYgfHwgJzAnOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgKHY/di50b0lTT1N0cmluZygpOiIxOTcwLTEtMSIpICsgIiciOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J215c3FsJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09J05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzT2JqZWN0KXslPg0KICAgICAgICAgICAgZlZhbHVlID0gIiciICsgSlNPTi5zdHJpbmdpZnkodiwgbnVsbCwgJ1x0JykgKyAiJyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdj09PW51bGw/Ik5VTEwiOigiJyIgKyAoKGZhbHNlICYmIHYgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoL1xcbi9nLCAiXFxcXG4iKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwnL2csICJcXFxcJyIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJ1xcXFwiJykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcJi9nLCAiXFxcXCYiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFxyL2csICJcXFxcciIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXHQvZywgIlxcXFx0IikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcYi9nLCAiXFxcXGIiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFxmL2csICJcXFxcZiIpICA6dikgKyAiJyIpOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICBpZih2PT09bnVsbCl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIk5VTEwiOw0KICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09J1NxbERCJyl7DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYEZST01fQkFTRTY0KCcke3RoaXMuX2J0b2Eodil9JylgOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgY2FzdCh1bmhleCgnJHt2LnNwbGl0KCIiKS5tYXAoeCA9PiAoMjU2ICsgeC5jaGFyQ29kZUF0KCkpLnRvU3RyaW5nKDE2KS5zdWJzdHIoLTIpKS5qb2luKCIiKX0nKSBhcyB2YXJjaGFyKWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IHY7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldFs8JT1fbkNvZGUoZWEpJT4gKyAiPCU9KGVhLkVudGl0eVR5cGU/J2lkJzonJyklPiJdID0gZlZhbHVlOw0KICAgICAgICB9DQogICAgPCUgfSk7ICU+DQogICAgDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydCSVNlcnZlciddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nZ2V0JyU+KG5hbWUpIHsNCiAgICAgICAgaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsNCiAgICAgICAgdmFyIHQgPSBudWxsOw0KICAgICAgICAkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gew0KICAgICAgICAgICAgdCA9IHsNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHQgPyB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3RdDQogICAgICAgICAgICAgICAgfSA6IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBJZDogdGhpcy5JZA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgIE5hbWU6IGYsDQogICAgICAgICAgICAgICAgICAgIE9QRVJBVE9SUzogew0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIj0iDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gew0KICAgICAgICAgICAgPCU9bG9nKCklPmV2KTsNCiAgICAgICAgICAgIGlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOw0KDQogICAgICAgICAgICBpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsNCg0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+WyQuZ3JlcCg8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOw0KICAgICAgICB9KTsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKF9zcWxUb29scykpeyU+DQogICAgPCU9bU5hbWU9J19RJyU+KCl7DQogICAgICAgIGxldCBfbyA9ICciJzsNCiAgICAgICAgbGV0IF9xID0gX287DQoNCiAgICAgICAgaWYoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKT09MCl7DQogICAgICAgICAgICBfbyA9IF9xID0gIiI7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSAnYCc7DQogICAgICAgIH1lbHNlIGlmKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk9PTApew0KICAgICAgICAgICAgX28gPSBfcSA9IGAnYDsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3Fsc2VydmVyJyl7DQogICAgICAgICAgICBfbyA9ICdbJzsNCiAgICAgICAgICAgIF9xID0gJ10nOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCdhcGlLZXknKT09J2FpcnRhYmxlJyl7DQogICAgICAgICAgICBfbyA9ICd7JzsNCiAgICAgICAgICAgIF9xID0gJ30nOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBfbz9fcTpfbzsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19maWVsZEdyb3VwcyclPihmZ3MgPSB7fSl7DQogICAgICAgIHRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmllbGRBZ2dyZWdhdGVzJyU+KGZhcyA9IHt9KXsNCiAgICAgICAgdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9GaWVsZHNTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgDQogICAgICAgIGZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCA8JT1jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBfbkNvZGUoZWEpICsgKGVhLkVudGl0eVR5cGU/JysiLmlkIic6JycpKS5qb2luKCcsJyklPl07DQogICAgICAgIGZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKT9maWVsZHM6W2ZpZWxkc107DQoNCiAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzKXsNCiAgICAgICAgICAgIC8vIHtmaWVsZDogb3JkZXJ9DQogICAgICAgICAgICBmaWVsZHMgPSBbXTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPikgZmllbGRzLnB1c2goYCR7PCU9X25Db2RlKGVhKSU+PCU9KGVhLkVudGl0eVR5cGU/JysiaWQiJzonJyklPn1gKTsNCiAgICA8JSB9KSU+DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZpZWxkczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tREJPYmplY3QnJT4ocj17fSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsNCiAgICAgICAgICAgICAgICBJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPihvYmpbZWFDb2RlXSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TZWxlY3RIZWFkZXInJT4oZmllbGRzKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IHsNCiAgICAgICAgICAgICAgICB0YWJsZTogPCU9X25Db2RlKCklPiwNCiAgICAgICAgICAgICAgICBmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwNCiAgICAgICAgICAgICAgICBqb2luczoge30sDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihmaWVsZHMpIHJldHVybiByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KCksDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvU2VsZWN0U1FMJyU+KGZpZWxkcyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCBzcWwgPSAic2VsZWN0ICI7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9YDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7DQoNCiAgICAgICAgICAgIHNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsNCiAgICAgICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOw0KICAgIA0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcyl7DQogICAgICAgICAgICAgICAgLy8ge2ZpZWxkOiBmdW5jdGlvbn0NCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPn0oJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9KWA7DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc3FsICs9IGAgd2hlcmUgMT0xYDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc3FsID0gdGhpcy5fX2V4cG9ydCh7c3FsOiBzcWx9LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodi5yZXVzZWQ+Mil7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyA8JT13YXJuKCklPiJSZXVzZWQ6ICIsIHYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdi5vYmouc3FsID0gYC8qUkVTVUVEOiAke3YucmV1c2VkfSovYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgX1RISVM6IG9iaiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIC8qYW5kICovJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnKXx8J0lkJykudGhpcykuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9iai5zcWwgKz0gKHRoaXMuSWQ9PXRoaXMuSWQpP2AgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOicnLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJOT1QgSU4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJJTiI7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICIiOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2LjwlPW1OYW1lJT4odi5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpKX0pYDsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQgfHwgZWEuSXNJbWFnZSB8fCBlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArIDwlaWYoZWEuSXNCb29sKXslPiI9IjwlfWVsc2V7JT4odGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCB8fCAiTElLRSIpPCV9JT4gKyAiICI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArIHYgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0iYm9vbGVhbiIpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAodj8iMSI6IjAiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5fPCU9dGFOYW1lJT5fc2V0KSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBsZXQgak9QID0gJ1VOSU9OIEFMTCc7DQogICAgICAgICAgICAgICAgICAgIGxldCBpbk9QID0gJ0lOJzsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J05PVCBJTicpew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5PUCA9ICdOT1QgSU4nOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J0lOJyl7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9PScpew0KICAgICAgICAgICAgICAgICAgICAgICAgak9QID0gJ0lOVEVSU0VDVCc7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGFuZCAvKjwlPXRhTmFtZSU+Ki8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC48JT1tTmFtZSU+KCI8JT1uTmFtZSh0YSklPi5pZCIpKS5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+IiwgZmllbGRzKS5zcWw7DQoNCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcyl7DQogICAgICAgICAgICAgICAgaWYoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+PCU9KGVhLkVudGl0eVR5cGU/JysiaWQiJzonJyklPn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT59YDsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCFzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKXsNCiAgICAgICAgICAgICAgICBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gc3FsOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9QYXRocyclPigpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiB7fSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4gPSB2LjwlPW1OYW1lJT4oKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4oKSksDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAvLyByZXR1cm4gcmV0Ow0KICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoe1trXTogcmV0W2tdfSkpOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9VcGRhdGVTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7DQogICAgICAgIGxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsNCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIHJldHVybiBzcWw7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b0luc2VydFNRTCclPihmaWVsZHMpew0KICAgICAgICBsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOw0KICAgICAgICBsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOw0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgcmV0dXJuIHNxbDsNCiAgICB9DQo8JSB9ICU+DQogICAgDQogICAgPCU9bU5hbWU9J19jb3B5RnJvbSclPihvYmopew0KICAgICAgICBpZighb2JqKSByZXR1cm4gbnVsbDsNCiAgICAgICAgcmV0dXJuIHRoaXMuX3JldmVydChvYmopOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvT2JqVHJlZSclPihiQ3ljbGljKXsNCiAgICAgICAgPCU9d2FybigpJT4iZGVwcmVjYXRlZCIpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgDQogICAgICAgIHRoaXMuX2RlZmF1bHRzKCk7DQoNCiAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPignPCU9Yy5OYW1lJT4nKSwgew0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIEN5Y2xpYzogYkN5Y2xpYywNCiAgICAgICAgICAgIC8vZXhwb3J0ZXI6IHYgPT4gPCU9d2FybigpJT52LnJldXNlZCksDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KDwlaWYoZWEuRW50aXR5VHlwZSl7JT5uZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oYkN5Y2xpYyk8JX1lbHNleyU+djwlfSU+KSwNCiAgICA8JSB9KTslPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPXRhTmFtZSU+KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oYkN5Y2xpYykpLA0KICAgIDwlIH0pOyU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdW5DeWNsZSclPihzb3VyY2U9dGhpcyl7DQogICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHRoaXMsIHsNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4oc291cmNlPT1vYmouPCU9bk5hbWUoZWEpJT4oKT9udWxsOnVuZGVmaW5lZCksDQogICAgPCUgfSk7JT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHRydWUsDQogICAgPCUgfSk7JT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQogICAgYXN5bmMgPCU9bU5hbWU9J19zdG9yZUVudGl0eUNsYXNzJyU+KGRlcHRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKGRlcHRoKT09PSJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOw0KICAgICAgICAgICAgaWYoIWRlcHRoKSByZXR1cm47DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuVG9vbC48JT1tTmFtZSU+ID0gdGhpcy5Ub29sLjwlPW1OYW1lJT4gfHwge307DQogICAgICAgICAgICBpZih0aGlzLlRvb2wuPCU9bU5hbWUlPi48JT1uTmFtZShjKSU+KSByZXR1cm47DQogICAgICAgICAgICB0aGlzLlRvb2wuPCU9bU5hbWUlPi48JT1uTmFtZShjKSU+ID0gdHJ1ZTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPmBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7DQogICAgICAgICAgICANCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuRFNDb25uZWN0KCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iTmVvNGoiKXslPg0KICAgICAgICAgICAgICAgIGxldCBjcWwgPSB0aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b0N5VGFibGUoZGVwdGgpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5jcWwpOw0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX25lbzRqKGNxbCk7DQogICAgPCUgfWVsc2UgaWYodD09IkFpclRhYmxlIil7JT4NCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS9iYXNlcycsIG51bGwsIHtuYW1lOiAnPCU9c2NvcGUlPicsIHdvcmtzcGFjZUlkOiB0aGlzLlRvb2wuZGIud29ya3NwYWNlSWQsIHRhYmxlczogdGhpcy5fdG9BVFRhYmxlKGRlcHRoKX0pOw0KICAgIDwlIH1lbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKXslPg0KICAgICAgICAgICAgICAgIGxldCBzcWwgPSB0aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NRTFRhYmxlKHtyZXVzZWQ6IDN9KTsgPCUvKmRlcHRoOiBjaGFsbGVuZ2UgLSB0b28gbG93IGRvZXMgbm90IGNvdmVyIGFsbCB0YWJsZXMsIHRvbyBoaWdoIChtYXggZGVwdGgpIHJlc3VsdHMgaW4gb3V0LW9mLW1lbW9yeSBvbiBicm93c2VyKi8lPg0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChzcWwpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7JT4NCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT50aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOVGFibGUoKSk7DQogICAgPCUgfWVsc2UgaWYodD09IkVNUyIpeyU+DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fdG9FTVNDbGFzcyhkZXB0aCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQklTZXJ2ZXIiKXslPg0KICAgICAgICAgICAgICAgIC8vIG9ubHkgZG8gdGhpcyBpZiB0aGUgbW9kdWxlIGlzIG5vdCBsb2FkZWQgZnJvbSANCiAgICAgICAgICAgICAgICAoYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIENvbXBhbnk6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29kZTogdGhpcy5fX2NvbmZpZygnY29tcGFueScsICc8JT1zY29wZSU+JyksDQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgfSkpLmZvckVhY2goZWEgPT4gLyogdHJ5ZSBfZWFUeXBlcyAqLzwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKHNlYSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHNlYS5JZCE9PWVhLklkICYmIHNlYS5OYW1lPT1lYS5OYW1lICYmIChzZWEuRW50aXR5Q2xhc3MuSWQ9PWVhLkVudGl0eUNsYXNzLklkIHx8IHNlYS5FbnRpdHlDbGFzcy5OYW1lPT1lYS5FbnRpdHlDbGFzcy5OYW1lKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWEuSWQgPT0gZWEuSWQ7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWEuRW50aXR5Q2xhc3MuSWQgPSBlYS5FbnRpdHlDbGFzcy5JZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lPT1zZWEuRW50aXR5Q2xhc3MuTmFtZSkuRW50aXR5QXR0cmlidXRlcy5maW5kKHNjZWEgPT4gc2NlYS5OYW1lPT1lYS5OYW1lKS5JZCA9IGVhLklkOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSkpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNb25nb0RCIiB8fCB0PT0iWmFuZ29EQiIpeyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRiKSBhd2FpdCB0aGlzLlRvb2wuZGIuY3JlYXRlQ29sbGVjdGlvbig8JT1fbkNvZGUoKSU+LCB7dmFsaWRhdG9yOiB7JGpzb25TY2hlbWE6IHRoaXMuX3RvSlNPTlNjaGVtYSgpfX0pOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJSeERCIil7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIGF3YWl0IHRoaXMuVG9vbC5kYi5hZGRDb2xsZWN0aW9ucyh7WzwlPV9uQ29kZSgpJT5dOiB7c2NoZW1hOiB0aGlzLl90b0pTT05TY2hlbWEoKX19KTsNCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX2xvZyclPihvYmo9dGhpcyl7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob2JqKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkob2JqKSkgcmV0dXJuIG9iai5tYXAobyA9PiB0aGlzLl9sb2cobykpOw0KICAgICAgICAgICAgaWYob2JqLkVudGl0eUNsYXNzKSBvYmogPSBvYmouX3RvSlNPTih7Yk1hcDogdHJ1ZX0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPm9iaik7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J0RTQ29ubmVjdCclPih0b29sPXRoaXMuVG9vbCl7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4odG9vbCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighdG9vbCl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IlRvb2wgaXMgbnVsbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYoIXRvb2wudHlwZSl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IlRvb2wudHlwZSBpcyBudWxsIiwgdG9vbCwgdGhpcy5Ub29scy5sZW5ndGgsIDwlPXNjb3BlJT4uVG9vbHMubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YodG9vbC5kYikhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJUb29sIGFscmVhZHkgY29ubmVjdGVkISIpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKDwlPW5zY29wZSU+Ll9ub2RlICYmIC8qPCU9bnNjb3BlJT4uX25vZGUuX3BhcmVudF9zZXQgJiYgKi88JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSkpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iTm9kZSBoYXMgYSB2YWxpZCBwYXJlbnQsIG5vIGxvY2FsIFNRTCBwb3NzaWJsZSIpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdG9vbC5fX2RtbFN0YXRlbWVudHMgPSB0b29sLl9fZG1sU3RhdGVtZW50cyB8fCBbXTsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIDwlPWxvZygpJT4iWzwlPXQlPl06IENvbm5lY3RpbmcuLi4iKTsNCg0KICAgICAgICAgICAgaWYodG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iRU1TIil7JT4NCiAgICA8JSB9ZWxzZSBpZih0PT0iTW9uZ29EQiIpeyU+DQogICAgICAgICAgICAgICAgLy88JT1sb2coKSU+dGhpcy5fX2NvbmZpZygndXJpJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygnY29uZmlnJywgbnVsbCwge3Rvb2w6IHRvb2x9KSk7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKG1vbmdvZGIpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gKGF3YWl0IG5ldyBtb25nb2RiLk1vbmdvQ2xpZW50KHRoaXMuX19jb25maWcoJ3VyaScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ2NvbmZpZycsIG51bGwsIHt0b29sOiB0b29sfSkpLmNvbm5lY3QoKSkuZGIodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCAiPCU9c2NvcGUlPiIsIHt0b29sOiB0b29sfSkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9ZWxzZSBpZih0PT0nUnhEQicpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IGF3YWl0IFJ4REIuY3JlYXRlUnhEYXRhYmFzZSh7bmFtZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCAiPCU9c2NvcGUlPiIsIHt0b29sOiB0b29sfSksIHN0b3JhZ2U6IG51bGx9KTsNCiAgICA8JSB9ZWxzZSBpZih0PT0nWmFuZ29EQicpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyB6YW5nby5EYih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSwgew0KICAgICAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChlYyA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgPCU9bk5hbWUoZWMpJT46IFsiPCU9ZWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IG5OYW1lKGVhKSkuam9pbignXCIsIFwiJyklPiJdLA0KICAgICAgICA8JSB9KSAlPg0KICAgICAgICAgICAgICAgIH0pOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSdLYWZrYScpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGthZmthanMpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGthZmthanMuS2Fma2Eoew0KICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50SWQ6IHRoaXMuX19jb25maWcoJ2NsaWVudElkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyb2tlcnM6IFt0aGlzLl9fY29uZmlnKCdicm9rZXJzJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0sDQogICAgICAgICAgICAgICAgICAgICAgICBzc2w6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBzYXNsOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuX19jb25maWcoJ2NsaWVudElkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygnc2FzbF9wYXNzd29yZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVjaGFuaXNtOiB0aGlzLl9fY29uZmlnKCdzYXNsX21lY2hhbmlzbXMnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25UaW1lb3V0OiAzMDAwLA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5wcm9kdWNlciA9IHRvb2wuZGIucHJvZHVjZXIoKTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5wcm9kdWNlci5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICB0b29sLmNvbnN1bWVyID0gdG9vbC5kYi5jb25zdW1lcih7Z3JvdXBJZDogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pfSk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wuY29uc3VtZXIuY29ubmVjdCgpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLmNvbnN1bWVyLnN1YnNjcmliZSh7DQogICAgICAgICAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgICAgICAgICBmcm9tQmVnaW5uaW5nOiBmYWxzZSwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgIDwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgdG9vbC5jb25zdW1lci5ydW4oe2VhY2hNZXNzYWdlOiBhc3luYyAoeyB0b3BpYywgcGFydGl0aW9uLCBtZXNzYWdlIH0pID0+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRXZlbnQnLCB0cnVlKSU+KCkuX2Zyb21Eb2N1bWVudChtZXNzYWdlLnZhbHVlLnRvU3RyaW5nKCkpLnByb2Nlc3MoKX0pOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQogICAgPCV9ZWxzZSBpZih0PT0nTWVtb3J5Jyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gew0KICAgICAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChlYyA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgJzwlPW5OYW1lKGVjKSU+JzogW10sDQogICAgICAgIDwlIH0pOyAlPg0KICAgICAgICAgICAgICAgIH07DQogICAgPCV9ZWxzZSBpZih0PT0iRXhjZWwiKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih3aW5kb3cpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+LmRiID0gPCU9c2NvcGUlPi54bHN4RGF0YT9YTFNYLnJlYWQoPCU9c2NvcGUlPi54bHN4RGF0YSk6WExTWC51dGlscy5ib29rX25ldygpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+LmRiID0gWExTWC5yZWFkKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ2ZpbGVuYW1lJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJTbm93Rmxha2UiKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsLnNub3dmbGFrZSl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBnbG9iYWwuc25vd2ZsYWtlLmNyZWF0ZUNvbm5lY3Rpb24oew0KICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudDogdGhpcy5fX2NvbmZpZygiYWNjb3VudCIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy5fX2NvbmZpZygidXNlcm5hbWUiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoInBhc3N3b3JkIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uOiB0aGlzLl9fY29uZmlnKCJzY29wZSIsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIjwlPXNjb3BlJT4iLA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiLmNvbm5lY3QoKGVyciwgY29ubik9PnsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+J1VuYWJsZSB0byBjb25uZWN0OiAnICsgZXJyLm1lc3NhZ2UpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWooZXJyKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiLmNvbm5lY3Rpb25fSUQgPSBjb25uLmdldElkKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcygpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCV9ZWxzZSBpZih0PT0iTmVvNGoiKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZW80ai5kcml2ZXIoDQogICAgICAgICAgICAgICAgICAgIHRoaXMuX19jb25maWcoJ3VybCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgIG5lbzRqLmF1dGguYmFzaWModGhpcy5fX2NvbmZpZygndXNlcm5hbWUnLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcsIG51bGwsIHt0b29sOiB0b29sfSkpDQogICAgICAgICAgICAgICAgKTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJBaXJUYWJsZSIpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IHsNCiAgICAgICAgICAgICAgICAgICAgYmFzZUlkOiAnJywNCiAgICAgICAgICAgICAgICAgICAgd29ya3NwYWNlSWQ6IHRoaXMuX19jb25maWcoJ3dvcmtzcGFjZUlkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogJycsDQogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJywNCiAgICAgICAgICAgICAgICAgICAgdXNlcklkOiAoYXdhaXQgdGhpcy5fYWlydGFibGUoJ21ldGEvd2hvYW1pJykpLmlkLA0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICBsZXQgYmFzZXMgPSAoYXdhaXQgdGhpcy5fYWlydGFibGUoJ21ldGEvYmFzZXMnKSkuYmFzZXM7DQogICAgICAgICAgICAgICAgaWYoYmFzZXMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYi5iYXNlSWQgPSBiYXNlcy5maWx0ZXIoYiA9PiBiLm5hbWU9PSc8JT1zY29wZSU+JykuaWQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIuYmFzZUlkKSB0b29sLmRiLmJhc2VJZCA9ICdhcHAnICsgdGhpcy5fdXVpZCgpLnNwbGl0KCctJykuc2xpY2UoLTEpWzBdOw0KICAgIDwlfWVsc2UgaWYodD09IlNxbERCIil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnICYmIGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0pew0KICAgICAgICAgICAgICAgICAgICBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLkRhdGFiYXNlKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB0b29sKV0uRGF0YWJhc2UodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICIuLzwlPXNjb3BlJT4uZGIiKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5jcmVhdGVDb25uZWN0aW9uKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLmNyZWF0ZUNvbm5lY3Rpb24oew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3Q6IHRoaXMuX19jb25maWcoJ3NlcnZlcicsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogdGhpcy5fX2NvbmZpZygndXNlcm5hbWUnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YWJhc2U6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiPCU9c2NvcGUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5DbGllbnQpew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLkNsaWVudCh7Y29ubmVjdGlvblN0cmluZzogdGhpcy5fX2NvbmZpZygnY29ubnN0cicsIG51bGwsIHt0b29sOiB0b29sfSl9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wuZGIuY29ubmVjdCgpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCk9PT0ndW5kZWZpbmVkJyAmJiB0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KT09PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIGJyb3dzZXINCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBTUUwuRGF0YWJhc2UoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCV9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRvb2wuc3lzX3Njb3BlKT09PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICAgICAgLy8gdG9vbC5zeXNfc2NvcGUgPSAoYXdhaXQgdGhpcy5fcmVzdCgic3lzX2FwcCIsIHtzeXNfc2NvcGU6IHRoaXMuX19jb25maWcoInNjb3BlIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiZ2xvYmFsIn0pKVswXS5zeXNfaWQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0b29sLnN5c19wcm9wZXJ0aWVzKT09PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICAgICAgLy8gbG9hZGluZyBzb21lIHBsYXRmb3JtIHN0dWZmDQogICAgICAgICAgICAgICAgICAgIHRvb2wuc3lzX3Byb3BlcnRpZXMgPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbmRpdGlvbiA9IE9iamVjdC5rZXlzKHRvb2wuc3lzX3Byb3BlcnRpZXMpLmZpbHRlcihrID0+ICF0b29sLnN5c19wcm9wZXJ0aWVzW2tdKS5qb2luKCcsJyk7DQogICAgICAgICAgICAgICAgICAgIGlmKGNvbmRpdGlvbil7DQogICAgICAgICAgICAgICAgICAgICAgICAoYXdhaXQgdGhpcy5fcmVzdCgic3lzX3Byb3BlcnRpZXMiLCB7bmFtZTogIklOIitjb25kaXRpb259KSkuZm9yRWFjaChyID0+IHRvb2wuc3lzX3Byb3BlcnRpZXNbci5uYW1lXSA9IHIudmFsdWUpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfSU+DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQo8JSB9JT4NCiAgICB9DQogICAgLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLw0KICAgIA0KICAgIDwlPW1OYW1lPSdfbWF0Y2hlcyclPihxdWVyeSwgb3B0aW9ucyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFvcHRpb25zKSBvcHRpb25zID0ge307DQogICAgICAgICAgICBpZighcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUhPSI8JT1uTmFtZShjKSU+IikgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YobWljcm9kaWZmKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICBsZXQgdEhhc2ggPSB0aGlzLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogb3B0aW9ucy5vbmx5VW5pcXVlfSwgJzwlPW1OYW1lJT4nKS5fdGhpczsNCiAgICAgICAgICAgICAgICBsZXQgcUhhc2ggPSBxdWVyeS5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IG9wdGlvbnMub25seVVuaXF1ZX0sICc8JT1tTmFtZSU+JykuX3RoaXM7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRpZmYgPSBtaWNyb2RpZmYocUhhc2gsIHRIYXNoKS5maWx0ZXIoZCA9PiBkLnR5cGUhPSdDUkVBVEUnICYmIFsnT1BFUkFUT1JTJywgJ0lkJ10uaW5kZXhPZihkLnBhdGhbMF0pPDApOw0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPidbdC9xXScsIHRIYXNoLCBxSGFzaCwgZGlmZik7DQogICAgICAgICAgICAgICAgbGV0IHJldCA9IGRpZmYuZmlsdGVyKGQgPT4gZC50eXBlPT0nQ0hBTkdFJykucmVkdWNlKCh2LCBkKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGxldCBjb29wID0gcXVlcnlbJ18nICsgZC5wYXRoWzBdICsgJ19jb29wJ10gfHwgKHR5cGVvZihkLnZhbHVlKT09PSdzdHJpbmcnPydMSUtFJzonPScpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IG9sZFZhbHVlID0gdHlwZW9mKGQub2xkVmFsdWUpPT09J3N0cmluZyc/ZC5vbGRWYWx1ZS5zcGxpdCgnLycpLnNsaWNlKC0xKVswXTpkLm9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmQucGF0aFswXSwgZC5vbGRWYWx1ZSwgZC52YWx1ZSwgY29vcCwgb2xkVmFsdWUsIGQpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnTElLRSc6IHJldHVybiB2ICYmIChvbGRWYWx1ZT09PW51bGwgfHwgZC52YWx1ZS5pbmRleE9mKG9sZFZhbHVlKT49MCk7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc9JzogcmV0dXJuIHYgJiYgKG9sZFZhbHVlPT09bnVsbCB8fCAhZC52YWx1ZSB8fCBkLnZhbHVlPT1vbGRWYWx1ZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICchPSc6IHJldHVybiB2ICYmIGQudmFsdWUhPW9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPj0nOiByZXR1cm4gdiAmJiBkLnZhbHVlPj1vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJzw9JzogcmV0dXJuIHYgJiYgZC52YWx1ZTw9b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc+JzogcmV0dXJuIHYgJiYgZC52YWx1ZT5vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJzwnOiByZXR1cm4gdiAmJiBkLnZhbHVlPG9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwgdHJ1ZSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgPCU9bG9nKCklPidbdC9xXScsIHJldCwgZGlmZik7DQogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgICAgICAvL0Z1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgLy9OdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5faWQgPSB0aGlzLklkPT1xdWVyeS5JZCwNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY/di48JT1tTmFtZSU+KHF1ZXJ5P3F1ZXJ5LjwlPW5OYW1lKGVhKSU+KCk6bnVsbCk6dHJ1ZTsNCiAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY9PXF1ZXJ5LjwlPW5OYW1lKGVhKSU+KCk7DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoDQogICAgICAgICAgICAgICAgICAgICAgICAodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmICFxdWVyeS5fPCU9bk5hbWUoZWEpJT5fc2V0KSB8fA0KICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UNCiAgICAgICAgICAgICAgICAgICAgKSBvYmouPCU9bk5hbWUoZWEpJT4gPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYoDQogICAgICAgICAgICAgICAgICAgICAgICAoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiBxdWVyeS5fPCU9bk5hbWUoZWEpJT5fc2V0KSB8fA0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIXRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KHF1ZXJ5LjwlPW5OYW1lKGVhKSU+KCkpKSB8fA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICAgICAgICApIG9iai48JT1uTmFtZShlYSklPiA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pOyAlPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IHF1ZXJ5LjwlPXRhTmFtZSU+KCkuYW55KHEgPT4gX3YuPCU9bU5hbWUlPihxKSkpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5vTWF0Y2gpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX21hdGNoaW5nJyU+KHF1ZXJ5KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IkZvciA8JT1uTmFtZShlYSklPiIpOw0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9bk5hbWUoZWEpJT4gPSB2P1t2LjwlPW1OYW1lJT4ocXVlcnkpP3Y6bnVsbF0uY29uY2F0KHYuPCU9bU5hbWUlPihxdWVyeSkpLmZpbHRlcihtID0+IG0pOltdOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9dGFOYW1lJT4gPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KHF1ZXJ5KSkuZmxhdCgpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT4ibWF0Y2hlcyIsIG1hdGNoZXMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtIT1xdWVyeSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19kZVJlZmVyZW5jZSclPihyb290KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXJvb3QpIHJvb3Q9dGhpczsNCg0KICAgICAgICAgICAgaWYocm9vdCE9dGhpcyAmJiB0aGlzLlNldF9Pbikgew0KICAgICAgICAgICAgICAgIGxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsNCiAgICAgICAgICAgICAgICBpZighbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIG15TWF0Y2hlc1swXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB2LjwlPW1OYW1lJT4ocm9vdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXQhPXYpIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmV0KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pOyAlPg0KICAgICAgICANCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICB2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB0YS48JT1tTmFtZSU+KHJvb3QpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocmV0IT10YSkgdGhpcy48JT10YU5hbWUlPigpW2ldID0gcmV0Ow0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21Eb2N1bWVudCclPihvYmosIGJUb29sKXsNCiAgICAgICAgaWYoIW9iaikgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmKG9iai48JT1tTmFtZSU+KSByZXR1cm4gb2JqOw0KICAgICAgICANCiAgICAgICAgaWYodHlwZW9mKG9iaik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICBpZig8JT1fYjY0dGVzdCgnb2JqJyklPikgb2JqID0gdGhpcy5fYXRvYihvYmopOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaWYob2JqLmxlbmd0aDwzMyAmJiAhb2JqLm1hdGNoKC9ccy9nKSl7DQogICAgICAgICAgICAgICAgICAgIG9iaiA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJywge3Rvb2w6IG9iai5fX3Rvb2x9KV06IG9iag0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmogPSBKU09OLnBhcnNlKG9iaik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJJbnZhbGlkIEpTT04gb3IgVVVJRCIsIG9iaik7DQogICAgICAgICAgICB9DQogICAgICAgIH1lbHNlIGlmKEFycmF5LmlzQXJyYXkob2JqKSl7DQogICAgICAgICAgICByZXR1cm4gb2JqLm1hcChvID0+IHRoaXMuPCU9bU5hbWUlPihvLCBiVG9vbCkpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZihvYmouX190b29sKSB0aGlzLlRvb2wgPSBvYmouX190b29sOw0KICAgICAgICANCiAgICAgICAgaWYoIU9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSkhPT0ndW5kZWZpbmVkJyAmJiBvYmpba10hPT1udWxsKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJFbXB0eSBvYmplY3Qgb3Igb2JqZWN0IG9mIG51bGxzIiwgb2JqKTsNCiAgICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bG9nKCklPm9iaik7DQogICAgICAgIHJldHVybiB0aGlzLl9faW1wb3J0KG9iaiwgew0KICAgICAgICAgICAgX21hcDogYlRvb2wsDQogICAgICAgICAgICBpbXBvcnRlcjogdiA9PiB2Lm9iaiA9ICh2Lm9iaiYmdi5vYmouU2V0X0NvdW50PHRoaXMuU2V0X0NvdW50KT90aGlzOnYub2JqLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlM/b2JqLk9QRVJBVE9SUy5USElTOnVuZGVmaW5lZCksDQogICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYoaWRDb2RlPT0nSWQnKSBpZENvZGUgPSB0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyk7DQogICAgICAgICAgICAgICAgaWYob2JqW2lkQ29kZV0pIHRoaXMuSWQgPSBvYmpbaWRDb2RlXTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZihvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSl7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCByZWYgPSBvYmpbZWFDb2RlXTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YocmVmKT09PSd1bmRlZmluZWQnKSByZXR1cm47DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICA8JSBpZighZWEuSXNBcnJheSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IlJlc3REQklPIikgcmVmID0gcmVmWzBdOw0KICAgICAgICAgICAgICAgIGlmKCFyZWYpIHJldHVybjsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQoNCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KCh0aGlzLjwlPW5OYW1lKGVhKSU+KCkgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPihyZWYsIGJUb29sKSk7DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSJTcWxEQiIpew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobW9tZW50KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IG5ldyBEYXRlKHJlZik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHJlZik9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZWYuaW5kZXhPZignVCcpPjApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IERhdGUucGFyc2UocmVmKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IERhdGUucGFyc2UocmVmICsgIiBHTVQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZWYgPSBuZXcgRGF0ZShyZWYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHJlZik7DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPigoPCU9X2I2NHRlc3QoJ3JlZicpJT4pP3RoaXMuX2F0b2IocmVmKToocmVmIHx8ICcnKSk7DQogICAgICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHJlZik7DQogICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSkgPT4gb2JqW2VhQ29kZV0/dGhpcy48JT10YU5hbWUlPihvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KF92LCBiVG9vbCkpLCBvYmouT1BFUkFUT1JTP29iai5PUEVSQVRPUlNbZWFDb2RlXTp1bmRlZmluZWQsIHRydWUpOnVuZGVmaW5lZCwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KICAgIA0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgIDwlPW1OYW1lPSdfdG9Qcm90byclPihvcHRpb25zPXt9LCBzUGF0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogPCU9X25Db2RlKCklPiwgcHJvdG86IGBcblxubWVzc2FnZSAkezwlPV9uQ29kZSgpJT59IHtgLCBpbmRleDogMX0sIHsNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLmJNYXAsDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHYub2JqPSh2LnJldXNlZD4xKT97cHJvdG86IGBcblxuLy8gcmV1c2VkWyR7di5yZXVzZWR9XTogJHs8JT1fbkNvZGUoKSU+fVxuXG5gfTp2Lm9iaiwNCiAgICAgICAgICAgICAgICBfVEhJUzogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRyZXBlYXRlZCAkezwlPV9uQ29kZSgpJT59ICR7ZWFDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0c3RyaW5nICR7aWRDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSBgXG5cdGAgKyBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfWApOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGBcblx0YDsNCiAgICAgICAgPCUgaWYoZWEuUmVxdWlyZWQpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwldmFsdWVPZihlYS5SZXF1aXJlZCklPikgb2JqLnByb3RvICs9ICdyZXF1aXJlZCAnOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICdyZXBlYXRlZCAnOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgPCUgaWYoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gInN0cmluZyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJib29sIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbnQpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiaW50MzIiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0xvbmcpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiaW50NjQiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Zsb3QpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiZmxvYXQiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJkb3VibGUiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAic3RyaW5nIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IDwlPV9uQ29kZShlYS5FbnRpdHlUeXBlKSU+Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGAgJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRgICsgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9W11gKSArIGBcblx0cmVwZWF0ZWQgJHs8JT1fbkNvZGUodGEuRW50aXR5Q2xhc3MpJT59ICR7ZWFDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0c3RyaW5nICR7ZWZDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2AsDQogICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF9fY2xvc2U6IG9iaiA9PiBvYmoucHJvdG8gKz0gJ1xufVxuXG4nLA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBvcHRpb25zLCBzUGF0aCkucHJvdG87DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHJldCAmJiAhc1BhdGgpew0KICAgICAgICAgICAgICAgIHJldCA9IGBwYWNrYWdlIDwlPXNjb3BlJT47XG5cbnN5bnRheCA9ICJwcm90bzMiO1xuXG5gICsgcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlfSU+DQoNCiAgICA8JT1tTmFtZT0nX3RvSlNPTiclPihvcHRpb25zPXt9LCBzUGF0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHNQYXRoID0gc1BhdGggfHwgIiI7DQogICAgICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgICAgICByZXQuX19rZXlzID0gW107IC8vISENCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuYk1hcCl7DQogICAgICAgICAgICAgICAgcmV0Ll9fZ2VuZXJhdGVkID0gJyInICsgbmV3IERhdGUoKS50b0lTT1N0cmluZygpICsgJyInOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5uYW1lKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fdG9vbCA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbC5uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIHJldC5fX2NsYXNzID0gJyI8JT1uTmFtZShjKSU+Iic7DQogICAgICAgICAgICAgICAgICAgIHJldC5fX3R5cGUgPSAnIicrPCU9X25Db2RlKCklPisnIic7DQogICAgICAgICAgICAgICAgICAgIC8vcmV0Ll9fcGF0aCA9ICciJytzUGF0aCsnIic7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKDwlPW5zY29wZSU+Ll9ub2RlKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fbm9kZSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IDwlPW5zY29wZSU+Ll9ub2RlLmNvZGUoKQ0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHRoaXMuX2RlZmF1bHRzKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0ck1hcCA9IChvYmosIGVhQ29kZSwgdiwgc1BhdGgpID0+ICh2ICYmIHR5cGVvZih2KT09PSdzdHJpbmcnICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKC8wMTk1ZDcwMmU1ZTE3M2ZmYmI4NDgxNGMyZWUwMDU3MF0rPj4vZ20sIG0gPT4gew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX190ck1hcCA9IDwlPXNjb3BlJT4uX190ck1hcCB8fCBbXTsNCg0KICAgICAgICAgICAgICAgIGxldCB0cmlkID0gdGhpcy5fdXVpZCgpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBwUGF0aCA9ICcuJysoc1BhdGguc3BsaXQoJy4nKS5zbGljZSgxLCAtMSkuam9pbignLicpKTsNCiAgICAgICAgICAgICAgICBpZihwUGF0aD09Ii4iKSBwUGF0aCA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCB0ciA9IG0ucmVwbGFjZSgnMDE5NWQ3MDJlNWUxNzNmZmJiODQ4OTQ0Y2M5Nzc5ZWYnLCAnJykucmVwbGFjZSgve3tucn19L2dtLCAnJG5vdCgkZXhpc3RzKF9fcmV1c2VkKSknKS5yZXBsYWNlKC97e3ZmfX0vZywgb2JqW2VhQ29kZV0pOw0KICAgICAgICAgICAgICAgIGlmKHRyLnN0YXJ0c1dpdGgoJ3MoJykgJiYgdHIuZW5kc1dpdGgoJyknKSl7DQogICAgICAgICAgICAgICAgICAgIHRyID0gdHIucmVwbGFjZSgve3tfX319L2dtLCAnb0pTT04nK3NQYXRoKS5yZXBsYWNlKC97e3BwYXRofX0vZ20sICdvSlNPTicrcFBhdGgpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICB0ciA9IHRyLnJlcGxhY2UoL3t7X199fS9nbSwgYCoqW0lkPSR7b2JqLklkfV1bMF1gKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyA8JT13YXJuKCklPmVhQ29kZSwgdHJpZCwgdHIpOw0KDQogICAgICAgICAgICAgICAgdHIgPSB0aGlzLl9idG9hKHRyKTsNCiAgICAgICAgICAgICAgICBsZXQgbWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwLmZpbmQobyA9PiBvLnRyYW5zZm9ybT09dHIpOw0KICAgICAgICAgICAgICAgIHJldHVybiAobWFwP21hcC5pZDo8JT1zY29wZSU+Ll9fdHJNYXBbPCU9c2NvcGUlPi5fX3RyTWFwLnB1c2goe2lkOiB0cmlkLCB0cmFuc2Zvcm06IHRyfSktMV0uaWQpOw0KICAgICAgICAgICAgfSk6djsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLmJNYXAsDQogICAgICAgICAgICAgICAgRnVsbDogb3B0aW9ucy5iRnVsbCwNCiAgICAgICAgICAgICAgICBOdWxsOiBvcHRpb25zLmJOdWxsLA0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2Lm9iaiAmJiB0eXBlb2Yodi5vYmouX3JldHVybik9PT0nc3RyaW5nJyAmJiB2Lm9iai5fcmV0dXJuLmluZGV4T2YoJ19fcmV1c2VkOiAxJyk+MCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IG9IYXNoID0gb3B0aW9ucy5iSGFzaD9bdGhpcy5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vQXJnczogdHJ1ZSwgX21hcDogb3B0aW9ucy5iTWFwLCBub1R5cGVzOiBmYWxzZX0sICI8JT1tTmFtZSU+IildOk9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gaz09J0lkJyB8fCBrLmluZGV4T2YoJ19fJyk9PTApLm1hcChrID0+IHt0cnl7cmV0dXJuIHsgW2tdOiBKU09OLnBhcnNlKHJldFtrXSkgfTsgfWNhdGNoKGV4KXtyZXR1cm4ge1trXTogcmV0W2tdfTsgfSB9KTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGVSZXQgPSBPYmplY3QuYXNzaWduKC4uLm9IYXNoLCB7X19yZXVzZWQ6IHYucmV1c2VkfSApOw0KICAgICAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGVSZXQuX19rZXlzKSkgZVJldC5fX2tleXMuZm9yRWFjaChlayA9PiB7dHJ5eyBlUmV0W2VrXSA9IEpTT04ucGFyc2UocmV0W2VrXSk7fWNhdGNoKGV4KXtlUmV0W2VrXSA9IHJldFtla107IH0gfSk7DQoNCiAgICAgICAgICAgICAgICAgICAgdi5vYmogPSB7X3JldHVybjogSlNPTi5zdHJpbmdpZnkoZVJldCl9Ow0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgX1RISVM6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmJNYXApIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCkpOw0KICAgICAgICAgICAgICAgICAgICBvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9ialtpZENvZGVdID0gYCIke3Z9ImAsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgICAgICBpZihvYmouX19rZXlzKSBvYmouX19rZXlzLnB1c2goZWFDb2RlKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKCE8JT1fYjY0dGVzdCgndicpJT4peyAvLyBpcyBub3QgYmFzZTY0Pw0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHRoaXMuX2J0b2Eodik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICB2ID0gdiYmdi50b0lTT1N0cmluZz92LnRvSVNPU3RyaW5nKCk6djsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY/di48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKTonbnVsbCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCB8fCBlYS5Jc0ludCB8fCBlYS5Jc0xvbmcgfHwgZWEuSXNGbG9hdCB8fCBlYS5Jc0RvdWJsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpIHx8ICdudWxsJzsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSAnIicgKyB0ck1hcChvYmosIGVhQ29kZSwgdiwgc1BhdGgpICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9ICdbJyArICh2IHx8IFtdKS5tYXAoKF92LCBfaSkgPT4gX3YuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9WyR7X2l9XWApKS5maWx0ZXIoX3YgPT4gX3YpLmpvaW4oKSArICddJywNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodikpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSBKU09OLnN0cmluZ2lmeSh2KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdHJNYXAob2JqLCBlZkNvZGUsIHYsIHNQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSd1bmRlZmluZWQnKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWYpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBpZighPCU9X2I2NHRlc3QoJ3YnKSU+KXsgLy8gaXMgbm90IGJhc2U2ND8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gdGhpcy5fYnRvYSh2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWYuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHYmJnYudG9JU09TdHJpbmc/di50b0lTT1N0cmluZygpOnY7DQogICAgICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9IHY7DQogICAgICAgIDwlIGlmKCFlZi5Jc0Jvb2wgJiYgIWVmLklzSW50ICYmICFlZi5Jc0xvbmcgJiYgIWVmLklzRmxvYXQgJiYgIWVmLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2VmQ29kZV0gPSAnIicgKyBvYmpbZWZDb2RlXSArICciJzsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCg0KICAgICAgICAgICAgICAgIF9fdHJNYXA6IG9iaiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCFzUGF0aCl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouX190ck1hcCA9IDwlPXNjb3BlJT4uX190ck1hcCB8fCBbXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSA8JT1zY29wZSU+Ll9fdHJNYXA7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAgICAgX3JldHVybjogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYob2JqKSBvYmouX3JldHVybiA9IChPYmplY3Qua2V5cyhvYmp8fHt9KS5sZW5ndGgpPygneycgKyBPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHR5cGVvZihvYmpba10pPT09InN0cmluZyIpLm1hcChrID0+IGAiJHtrfSI6ICR7b2JqW2tdfWApLmNvbmNhdChPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHR5cGVvZihvYmpba10pIT09InN0cmluZyIpLm1hcChrID0+IGAiJHtrfSI6ICR7SlNPTi5zdHJpbmdpZnkob2JqW2tdKX1gKSkuam9pbigpICsgJ30nKTonbnVsbCc7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iiwgb3B0aW9ucywgc1BhdGgpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSByZXQ/cmV0Ll9yZXR1cm46cmV0Ow0KICAgICAgICAgICAgcmV0ID0gdHlwZW9mKHJldCk9PT0ndW5kZWZpbmVkJz9udWxsOnJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIXNQYXRoICYmIHJldCl7DQogICAgICAgICAgICAgICAgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCAnamF2YXNjcmlwdCcpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHJldCk7DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5nemlwKSByZXR1cm4gdGhpcy5VdGY4QXJyYXlUb1N0cih0aGlzLl9jb21wcmVzcyhyZXQpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfdG9Eb2N1bWVudCclPihvcHRpb25zPXt9KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IGpzb24gPSB0aGlzLl90b0pTT04ob3B0aW9ucyk7DQogICAgICAgICAgICBsZXQgb0pTT04gPSBKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICAgICAgbGV0IHRyTWFwID0gb0pTT04uX190ck1hcCB8fCBbXTsNCiAgICAgICAgICAgIGRlbGV0ZSBvSlNPTi5fX3RyTWFwOw0KICAgICAgICAgICAganNvbiA9IEpTT04uc3RyaW5naWZ5KG9KU09OKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Li4ucyk7DQogICAgICAgICAgICBsZXQgd2FybiA9ICguLi5zKSA9PiA8JT13YXJuKCklPi4uLnMpOw0KICAgICAgICAgICAgbGV0IGVycm9yID0gKC4uLnMpID0+IDwlPWVycm9yKCklPi4uLnMpOw0KDQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHQgb2YgdHJNYXApew0KICAgICAgICAgICAgICAgIGlmKCFuZXcgUmVnRXhwKHQuaWQpLnRlc3QoanNvbikpIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCB0cm4gPSB0aGlzLl9hdG9iKHQudHJhbnNmb3JtKTsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIG9KU09OID0gSlNPTi5wYXJzZShqc29uKTsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJlcyA9IHVuZGVmaW5lZDsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHRybi5zdGFydHNXaXRoKCJzKCIpICYmIHRybi5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IHRoaXMucnVuU2NyaXB0KGAob0pTT04sIG9TY29wZSwgbG9nLCB3YXJuLCBlcnJvcikgPT4gJHt0cm4uc3Vic3RyaW5nKDIsIHRybi5sZW5ndGgtMSl9YCkob0pTT04sIDwlPXNjb3BlJT4sIGxvZywgd2FybiwgZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vcmVzID0gYXdhaXQganNvbmF0YSh0cm4pLmV2YWx1YXRlKG9KU09OKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgLy88JT13YXJuKCklPnQuaWQsIHJlcywgdHJuKTsNCiAgICAgICAgICAgICAgICAgICAganNvbiA9IGpzb24ucmVwbGFjZShuZXcgUmVnRXhwKHQuaWQsICJnIiksICghQXJyYXkuaXNBcnJheShyZXMpICYmIHR5cGVvZihyZXMpIT09J29iamVjdCcpP3Jlczp0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJlcykpKTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPnQuaWQsIHRybiwgZXgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8ganNvbiA9IGpzb24ucmVwbGFjZSgvIl9fdHJNYXAiOlxzXFtce1tePj5dK1x9XF0vZ20sICciX190ck1hcCI6ICIiJyk7DQoNCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmJKU09OP3RoaXMuX2JlYXV0aWZ5KGpzb24sICdqYXZhc2NyaXB0Jyk6SlNPTi5wYXJzZShqc29uKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KPCUNCl9jbG9uZUZ1bmN0aW9uID0gKG8sIGYsIHNjb3BlLCBjKSA9PiB7DQoNCiAgICBsZXQgb2JqID0gbnVsbDsNCiAgICBpZihvPT0nc3InICYmIHR5cGVvZihzcikhPT0ndW5kZWZpbmVkJykgb2JqID0gc3I7DQogICAgaWYobz09J19GckVNRCcgJiYgdHlwZW9mKF9GckVNRCkhPT0ndW5kZWZpbmVkJykgb2JqID0gX0ZyRU1EOw0KICAgIA0KICAgIGxldCBjb2RlID0gb2JqW2ZdID8gb2JqW2ZdLnRvU3RyaW5nKCkgOiBgICAgJHtmfSgpew0KICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgaW4gX2Nsb25lRnVuY3Rpb24oJHtvfSwgJHtmfSk6IEludmFsaWQgRnVuY3Rpb24gTmFtZScpOw0KICAgIH1gOw0KICAgIGxldCBzID0gY29kZS5yZXBsYWNlKCcpJywgJykgPT4gJyk7DQogICAgaWYgKHMuaW5kZXhPZignZnVuY3Rpb24nKSA9PSAwIHx8IHMuaW5kZXhPZignYXN5bmMgZnVuY3Rpb24nKSA9PSAwKSB7DQogICAgCXMgPSBzLnJlcGxhY2UoJ2Z1bmN0aW9uJywgJyAnKTsNCiAgICB9IGVsc2Ugew0KICAgIAlzID0gcy5yZXBsYWNlKGYsICcnKTsNCiAgICB9DQoNCiAgICBpZiAoYy5Jc01haW4gJiYgIW9ialtmXSkgew0KICAgIAljb25zb2xlLmxvZygnRXJyb3IgaW4gX2Nsb25lRnVuY3Rpb24oKTogSW52YWxpZCBGdW5jdGlvbiBOYW1lICcgKyBmKTsNCiAgICB9DQoNCiAgICByZXR1cm4gYA0KICAgICR7Zn0oLi4ucGFyYW1zKXsNCiAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LiR7b30pIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy4ke299LiR7Zn0oLi4ucGFyYW1zKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBgICsgKGMuSXNNYWluID8gYHJldHVybiAoJHtzfSkoLi4ucGFyYW1zKTtgIDogYHJldHVybiBuZXcgJHtzY29wZX0uJHtuTmFtZShtYWluQ2xhc3MoKSl9KCkuJHtmfSguLi5wYXJhbXMpO2ApICsgYA0KICAgICAgICB9DQoJfQ0KICAgIGA7DQp9Ow0KDQoNClt7DQogICAgd09iajogJ3NyJywNCiAgICBmdW5jdGlvbnM6IFsnaGFzaENvZGUnLCAnRXF1YWxzJywgJ3NlcnZlckRhdGUnLCAnX19zY29wZScsICdhZGRNU2Vjb25kcycsICdpcEFkZHJlc3MnXS5jb25jYXQobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSk/WydfJywgJ2J1aWxkVVJMJywgJyRfUkVRVUVTVCcsICdwYXJhbScsICdfdG9YTUwnLCAnY29vcCcsICdPUicsICdteVJlcGxhY2UnLCAnc2VuZFhNTCcsICdwcm9jZXNzUmVzcG9uc2UnLCAncHJvY2Vzc1Jlc3VsdCcsICdydW5TUlNjcmlwdCcsICdncm91cEJ5JywgJ1Nob3dEZWJ1ZycsICdjYWNoZVJlc3VsdCcsICd0b0hleCcsICdTaG93RXJyb3InXTpbXSksDQp9LCB7DQogICAgd09iajogJ19GckVNRCcsDQogICAgZnVuY3Rpb25zOiBbJ19hdHRyJywgJ3J1blNjcmlwdCcsICdfdW5pcXVlJywgJ3NyJywgJ19hdG9iJywgJ19nZXRTdG9yZWRTY3JpcHQnLCAnX2J0b2EnLCAnX190aW1lJywgJ193YWl0JywgJ19zcWxUeXBlJywgJ191dWlkJywgJ3JlcXVpcmUnLCAnX2luY2x1ZGUnLCAnX2JlYXV0aWZ5JywgJ19pbmplY3QnLCAnX2NvbXByZXNzJywgJ19kZWNvbXByZXNzJywgJ1V0ZjhBcnJheVRvU3RyJywgJ3JhbmRVUkwnXSwNCn1dLmZvckVhY2goY2MgPT4geyAlPg0KLyogU1RBUlQ6IDwlPWNjLndPYmolPiBmdW5jdGlvbiBjb3BpZXMgKi8NCjwlIGNjLmZ1bmN0aW9ucy5mb3JFYWNoKGYgPT4geyU+DQoNCi8qIENMT05FOjpTVEFSVDogPCU9Y2Mud09iaiU+LjwlPWYlPigpICovPCU9X2Nsb25lRnVuY3Rpb24oY2Mud09iaiwgZiwgc2NvcGUsIGMpICU+LyogQ0xPTkU6OkVORCAgOiA8JT1jYy53T2JqJT4uPCU9ZiU+KCkgKi8NCjwlIH0pJT4NCi8qIEVORDogPCU9Y2Mud09iaiU+IGZ1bmN0aW9uIGNvcGllcyAqLw0KPCUgfSk7ICU+DQogICAgDQogICAgPCU9bU5hbWU9J2kxOG4nJT4oZXYsIHYpew0KICAgICAgICBpZih0eXBlb2Yod2luZG93KT09PSJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSk9PT0idW5kZWZpbmVkIikgcmV0dXJuIHY7DQogICAgICAgIA0KICAgICAgICBpZighZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKXsNCiAgICAgICAgICAgIHJldHVybiB2Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7DQogICAgICAgIH0NCiAgICB9DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW1OYW1lPSdieScgKyBuTmFtZShlYS5FbnRpdHlUeXBlKSU+KGFyKSB7DQogICAgICAgIHZhciByZXQgPSBbXTsNCiAgICAgICAgYXIuZm9yRWFjaChhID0+IHsNCiAgICAgICAgICAgIHJldC5mb3JFYWNoKHIgPT4gew0KICAgICAgICAgICAgICAgIGlmIChhWyJfPCU9bk5hbWUoZWEpJT4iXSAmJiAoYVsiXzwlPW5OYW1lKGVhKSU+Il0uRXF1YWxzP2FbIl88JT1uTmFtZShlYSklPiJdLkVxdWFscyhyKTpzci5FcXVhbHMoYVsiXzwlPW5OYW1lKGVhKSU+Il0sIHIpKSkgew0KICAgICAgICAgICAgICAgICAgICByLl88JT1uTmFtZShlYSklPl88JT1jLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyklPi5wdXNoKGEpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9KSU+DQoNCiAgICA8JT1tTmFtZT0nRW50aXR5VmFsdWUnJT4oYU5hbWUpIHsNCiAgICAgICAgbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7DQogICAgICAgIA0KICAgICAgICBpZighcmV0KXsNCiAgICAgICAgICAgIC8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlDQogICAgICAgICAgICByZXQgPSB7QWN0aXZlOiB0cnVlLCBPUEVSQVRPUlM6IHt9LCBFbnRpdHlBdHRyaWJ1dGU6IHtOYW1lOiBhTmFtZSwgQWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczoge0lkOiB0aGlzLkVudGl0eUNsYXNzLklkfX19Ow0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfX2Fzc2VydFZhbGlkJyU+KGJTeW5jKXsNCjwlIGlmKCFjLlRvb2xzLmxlbmd0aCl7JT4NCiAgICAgICAgcmV0dXJuIHRydWU7DQo8JSB9ZWxzZXslPg0KICAgICAgICBsZXQgZXJyb3IgPSB7fTsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KXsNCiAgICAgICAgICAgIGVycm9yLjwlPW5OYW1lKGVhKSU+ID0ge307DQogICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBlcnJvci48JT1uTmFtZShlYSklPlsiMDEiXSA9ICJOb3QgU2V0IjsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKCF0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIGVycm9yLjwlPW5OYW1lKGVhKSU+WyIwMiJdID0gIkVtcHR5IFZhbHVlIjsNCiAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiBiU3luYyAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLl9fc3luY19vbigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDMiXSA9ICJOb3QgaW4gU3luYyI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKGVycm9yLjwlPW5OYW1lKGVhKSU+KS5sZW5ndGgpIGRlbGV0ZSBlcnJvci48JT1uTmFtZShlYSklPjsNCiAgICAgICAgfQ0KICAgIDwlIH0pJT4NCg0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKXsNCiAgICAgICAgICAgIHRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOw0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXJyb3IsbnVsbCw0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfcmFuayclPihfPCU9bU5hbWUlPj0wKXsNCgkJdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHtfPCU9bU5hbWUlPjogXzwlPW1OYW1lJT59LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2LnJldXNlZD92Lm9iai5fX3JldXNlZCA9IHYucmV1c2VkOjAsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSAiPCU9X2NOYW1lKGMsIHRydWUpJT4iLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5fPCU9bU5hbWUlPiArPSAob2JqW2VhQ29kZV0gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKS5fPCU9bU5hbWUlPiwNCgk8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIHRhQ29kZSwgdikgPT4gKG9ialt0YUNvZGVdID0gW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlUeXBlLCB0cnVlKSU+KCldLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKSkuZm9yRWFjaCh2ID0+IHYuXzwlPW1OYW1lJT4pLA0KICAgIDwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCgl9DQoNCiAgICA8JT1tTmFtZT0nX2lzUXVlcnknJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoLypfX3R5cGUqL3tJZDogIjwlPW5OYW1lKGMpJT4iLCA8JT1tTmFtZSU+Q291bnQ6IDB9LCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgdW5kZWZpbmVkfTsNCiAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IHR5cGVvZihvYmpbZWFDb2RlXS5fY29vcCk9PT0idW5kZWZpbmVkIj8wOjE7DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LjwlPW1OYW1lJT4pew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXS5fb2JqZWN0ID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1tTmFtZSU+Q291bnQgKz0gb2JqW2VhQ29kZV0uX29iamVjdC48JT1tTmFtZSU+Q291bnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmpbdGFDb2RlXSA9IHtfY29vcDogdGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCB1bmRlZmluZWQsIF9vYmplY3RzOiAodnx8W10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpfTsNCiAgICAgICAgICAgICAgICBpZihvYmpbdGFDb2RlXS5fb2JqZWN0cy5sZW5ndGgpIG9ialt0YUNvZGVdLjwlPW1OYW1lJT5Db3VudCArPSBvYmpbdGFDb2RlXS5fb2JqZWN0cy5yZWR1Y2UoKHYsIG8pID0+IHYgKz0gby48JT1tTmFtZSU+Q291bnQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX25ldyclPihjbE5hbWUsIHRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsTmFtZSwgdG9vbCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzd2l0Y2goY2xOYW1lKXsNCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uTmFtZShfYyklPiI6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoX2MsIHRydWUpJT4odW5kZWZpbmVkLCB0b29sKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nc3RvcmUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAvKioqIFNUQVJUIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgICAgICANCiAgICAgICAgbGV0IGJVcGRhdGUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGJJbnNlcnQgPSBmYWxzZTsNCg0KICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+InN0b3JpbmcgZGlzYWJsZWQiKTsNCiAgICAgICAgfWVsc2UgaWYoZmFsc2UgJiYgdGhpcy5faXNRdWVyeSgpLl9pc1F1ZXJ5Q291bnQpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHN0b3JlIGEgcXVlcnkhIik7DQogICAgICAgIH1lbHNlIGlmKCF0aGlzLl9fc3luY19vbigpIHx8IDwlPV9GckVNRC5fdG9KUyhfZmlsZVRvb2xzKSU+LmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk+PTApew0KICAgICAgICAgICAgbGV0IF90aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYkZpbmQgPSBmYWxzZTsNCiAgICAgICAgICAgIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgIGJGaW5kID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBfdGhpcy5JZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICB9DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KXsNCiAgICAgICAgICAgICAgICBiRmluZCA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuPCU9bk5hbWUoZWEpJT4odGhpcy48JT1uTmFtZShlYSklPigpLCAnPScpOw0KICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGlmKGJGaW5kKXsNCiAgICAgICAgICAgICAgICBfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsNCiAgICAgICAgICAgIH1lbHNlIF90aGlzID0gbnVsbDsNCiAgICAgICAgICAgIGlmKF90aGlzKXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gX3RoaXMuSWQ7DQogICAgICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24oX3RoaXMuX19zeW5jX29uKCkpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7DQogICAgICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUNCiAgICAgICAgICAgICAgICBiSW5zZXJ0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsiPCIrdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICBpZighYlVwZGF0ZSAmJiAhYkluc2VydCl7DQogICAgICAgICAgICA8JT1sb2coKSU+Ik5vIGRhdGEgY2hhbmdlcyIpOw0KICAgICAgICB9ZWxzZXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uKT09PSJ1bmRlZmluZWQiIHx8IDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiA9IHtPd25lcjogdGhpcywgc3FsczogW10sIHN0YXJ0OiBuZXcgRGF0ZSgpLCBlbmQ6IG51bGx9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIShhd2FpdCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPigpKSkgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YD09PT4gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIGlmKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7DQogICAgICAgICAgICBpZihiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmA8PT09IEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSl7DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU3luY2luZy4uLjwlPXRhTmFtZSU+IiwgdGEpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0YS48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGJVcGRhdGUgfHwgYkluc2VydCl7DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLk93bmVyPT10aGlzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdpbnNlcnQnJT4oKXsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLlRvb2wuZGIuZ2V0Q29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikuaW5zZXJ0T25lKHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS5pbnNlcnRPbmUoJHt0aGlzLl90b0pTT04oe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uPCU9bU5hbWUlPih0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJLYWZrYSIpIHslPg0KICAgICAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJyk7DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5wdXNoKHRoaXMpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJOZW80aiIpIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2FsZXNGb3JjZSIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+LklkOw0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgICAgIGxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7DQogICAgDQogICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIjwlPW5OYW1lKGMpJT4iKS5jcmVhdGUob2JqKTsNCiAgICAgICAgICAgIHRoaXMuSWQgPSByZXMuaWQ7DQogICAgPCUgfSBlbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKSB7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlNlcnZpY2VOb3ciKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIGF3YWl0IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKSk7DQogICAgPCUgfSBlbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuSWQgPSAoYXdhaXQgdGhpcy5fdG9FTVNPYmplY3QoKS5zdG9yZSgpKS5JZDsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIGxldCBvYmogPSB7fTsNCiAgICAgICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQvKl9pZCgpKi87DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5Db2RlKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgbG9nKCI8JT10JT4gVVJMIiwgdXJsKTsNCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbG9nKCJyZXN1bHQiLCByZXMuZGF0YSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmVzLmRhdGEpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCBpbnNPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0SW5zZXJ0IiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCBudWxsLCAyKTsNCiAgICAgICAgICAgIGlmKCFpbnNPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5JZCA9IGluc09iai5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gaW5zT2JqLkVudGl0eVZhbHVlczsNCiAgICAgICAgICAgIHRoaXMuX3JldmVydCgpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSAlPg0KDQogICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSd1cGRhdGUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KDQogICAgPCUgaWYodCA9PSAiTW9uZ29EQiIpIHslPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLnVwZGF0ZU9uZSh7X2lkOiB0aGlzLklkfSwgeyRzZXQ6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pOw0KICAgICAgICAgICAgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGBkYi5nZXRDb2xsZWN0aW9uKCckezwlPV9uQ29kZSgpJT59JykudXBkYXRlT25lKHtfaWQ6ICcke3JldC5faWR9J30sIHskc2V0OiAke3RoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPlt0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5maW5kSW5kZXgobyA9PiBvLklkPT10aGlzLklkKV0gPSB0aGlzOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5wcm9kdWNlci5zZW5kKHsNCiAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7DQogICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KQ0KICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nY2FsbDogJyArIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ncmVzcG9uc2U6ICcsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5TWVyZ2UoKSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOw0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07DQogICAgPCUgfWVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksICdwdXQnKSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TT2JqZWN0KCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZW5kaW5nIHVwZGF0ZSB0byBSRVNUREJJTyB0byBzYXZlIik7DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICIvIiArIHRoaXMuSWQ7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+IlVwZGF0ZSB0byBSRVNUREJJTyIsIHVybCk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MucHV0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IHVwZE9iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RVcGRhdGUiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIDIpOw0KICAgICAgICAgICAgaWYoIXVwZE9iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb3B5RnJvbSh1cGRPYmopOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOw0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KDQogICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kJyU+KGRlcHRoID0gMSwgb2JqcywgZmllbGRzKSB7DQogICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoLCBvYmpzLCBudWxsLCBudWxsLCBmaWVsZHMpKVswXTsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nZmluZEFsbCclPihkZXB0aCA9IDEsIG9ianM9W10sIHN0YXJ0LCBlbmQsIGZpZWxkcykgew0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bU5hbWUlPiIsIDwlbVJvdXRpbmcoYyklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5DQoNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJNb25nb0RCIil7ICU+DQogICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5kYi5jb2xsZWN0aW9uKDwlPV9uQ29kZShjKSU+KS5maW5kKHRoaXMuX3RvU2VsZWN0TW9uZ29EQihmaWVsZHMsIG9ianMpKS50b0FycmF5KCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uZmluZCh0aGlzLl90b1NlbGVjdFJ4REIoZmllbGRzLCBvYmpzKSkuZXhlYygpOw0KICAgIDwlIH1lbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKXsgJT4NCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7ICU+DQogICAgICAgICAgICBsZXQgbyA9IHRoaXMuX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgbyA9IG5ldyA8JT1zY29wZSU+LkVudGl0eU9iamVjdCgpLlRISVMoW29dLmNvbmNhdChvYmpzLm1hcChfbyA9PiBfby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkpKSk7DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eU9iamVjdChvKS48JT1tTmFtZSU+KCkpOw0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnZW1zLmRlZXAucXVlcnknKSkgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iTWVtb3J5Iil7ICU+DQogICAgICAgICAgICByZXR1cm4gdGhpcy5Ub29sLmRiWzwlPV9uQ29kZSgpJT5dLmZpbHRlcihvID0+IG8gJiYgdGhpcy5fc2FtZUVudGl0eShvKSk7DQogICAgPCUgfWVsc2UgaWYodD09Ikh1YlNwb3QiKXsgJT4NCiAgICA8JSB9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwge3N5c3Bhcm1fcXVlcnk6IHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMsIHRydWUpfSkpLnJlc3VsdDsNCiAgICA8JSB9ZWxzZSBpZih0PT0iU2FsZXNGb3JjZSIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwge3VybDogJ3Jlc3QudXJsLmdxbCd9KTsNCiAgICA8JSB9ZWxzZSBpZihfZmlsZVRvb2xzLmluZGV4T2YodCk+LTEpeyAlPg0KICAgICAgICAgICAgbGV0IGROYW1lID0gdGhpcy5fdG9GaWxlTmFtZSgpLnNwbGl0KCcvJykuc2xpY2UoMCwgLTEpLmpvaW4oJy8nKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGRMaXN0ID0gYXdhaXQgdGhpcy5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oZE5hbWUpOw0KDQogICAgICAgICAgICA8JT1sb2coKSU+ImROYW1lIiwgZE5hbWUsIHRoaXMuX3RvRmlsZU5hbWUoKSwgImRMaXN0IiwgZExpc3QpOw0KICAgICAgICAgICAgbGV0IGlkeExpc3QgPSAoZExpc3QgfHwgW10pLmZpbHRlcihyID0+IHR5cGVvZihyLm5hbWUpIT09J3VuZGVmaW5lZCcpLm1hcChyID0+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLCB0cnVlKSU+KCkuX2Zyb21GaWxlTmFtZShyLm5hbWUpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iaWR4TGlzdCIsIGlkeExpc3QsIGlkeExpc3QubWFwKHIgPT4gci5fdG9GaWxlTmFtZSgpKSk7DQogICAgICAgICAgICBpZHhMaXN0ID0gaWR4TGlzdC5maWx0ZXIociA9PiByLl9tYXRjaGVzKHRoaXMsIHtvbmx5VW5pcXVlOiB0cnVlfSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJpZHhMaXN0IGZpbHRlcmVkIiwgaWR4TGlzdCk7IA0KDQogICAgICAgICAgICBpZihpZHhMaXN0Lmxlbmd0aD09MSl7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgdGhpcy5fPCU9dC50b0xvd2VyQ2FzZSgpJT4oZE5hbWUgKyAnLycgKyBpZHhMaXN0WzBdLl90b0ZpbGVOYW1lKCkuc3BsaXQoJy8nKS5zbGljZSgtMSkuam9pbignLycpKSk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZXQgPSBpZHhMaXN0Ow0KICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSJOZW80aiIpeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fbmVvNGoodGhpcy5fdG9DeVF1ZXJ5KGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJSZXN0REJJTyIpeyAlPg0KICAgICAgICAgICAgbGV0IHRoaXNEb2MgPSB0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICBsZXQgZWFDb2RlID0gIiI7DQogICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgZWFDb2RlID0gPCU9X25Db2RlKGVhKSU+Ow0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNBcnJheSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IiE9Iil7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJG5pbiI6IHRoaXNEb2NbZWFDb2RlXX07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJGluIjogdGhpc0RvY1tlYUNvZGVdfTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyAlPg0KICAgICAgICAgICAgICAgIGlmKFtudWxsLCAnJScsICdMSUtFJ10uaW5kZXhPZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT4tMSl7DQogICAgICAgICAgICAgICAgICAgIHRoaXNEb2NbZWFDb2RlXSA9IHsiJHJlZ2V4IjogdGhpc0RvY1tlYUNvZGVdIHx8ICIuKiJ9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICI/cT0iICsgSlNPTi5zdHJpbmdpZnkoY29uZGl0aW9ucyk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MuZ2V0KHVybCwgew0KICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsNCiAgICAgICAgICAgICAgICAgICAgImNhY2hlLWNvbnRyb2wiOiAibm8tY2FjaGUiLA0KICAgICAgICAgICAgICAgICAgICAieC1hcGlrZXkiOiB0aGlzLl9fY29uZmlnKCdhcGlrZXknKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSkuZGF0YTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQklTZXJ2ZXIiKXsgJT4NCiAgICAgICAgICAgIGxldCBxID0gew0KICAgICAgICAgICAgICAgIFRISVM6IHRoaXMuX2J1aWxkVGhpcyhkZXB0aCkuY29uY2F0KChvYmpzIHx8IFtdKS5tYXAob2JqID0+IG9iai50b0VudGl0eU9iamVjdD97DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgICAgICAgICAgfTpvYmopKSwNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7IC8vIGFic29sdXRlbHkgcmVxdWlyZWQgZm9yIGluZGV4aW5nDQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgPCU9bG9nKCklPnEpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FzT2JqZWN0cygoYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZGFsbCIsIG51bGwsIHEpKSk7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSU+DQoNCiAgICAgICAgPCU9bG9nKCklPiJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgZGVwdGgsIHJldCk7DQogICAgICAgIA0KICAgICAgICBpZighQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSBbcmV0XTsNCiAgICAgICAgcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHIsIHRydWUpKS5maWx0ZXIociA9PiByKS5tYXAociA9PiByLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7DQoNCiAgICAgICAgaWYoZGVwdGg+MSl7DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2YgcmV0KXsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHIuXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9bk5hbWUoZWEpJT4iLCByLjwlPW5OYW1lKGVhKSU+KCkuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9bk5hbWUoZWEpJT4oYXdhaXQgci5fPCU9bk5hbWUoZWEpJT4uZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgICAgIDwlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT49MCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGxldCByXzwlPXRhTmFtZSU+ID0gW107DQogICAgICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgX3RhIG9mIHIuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IjwlPXRhTmFtZSU+IiwgX3RhKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJfPCU9dGFOYW1lJT4ucHVzaChhd2FpdCBfdGEuZmluZChkZXB0aC0xKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgci5jbGVhcl88JT10YU5hbWUlPigpOw0KICAgICAgICAgICAgICAgICAgICByLjwlPXRhTmFtZSU+KHJfPCU9dGFOYW1lJT4pOw0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT10YU5hbWUlPiIsIHIuPCU9dGFOYW1lJT4oKSk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9dGFOYW1lJT4oYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bk5hbWUodGEpJT4ocikNCiAgICAgICAgICAgIDwlIGlmKGZhbHNlICYmIFsnU3FsREInXS5pbmRleE9mKHQpPj0wKXsgLy8gc3FsIHN0YXRlbWVudHMgZG8gbm90IGluY2x1ZGUgbGVmdCBqb2lucyB3aXRob3V0IGV4cGxpY2l0IHJlZmVyZW5jZXMgJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwldGEuRW50aXR5Q2xhc3MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhIT10YSkuZm9yRWFjaChlYSA9PiB7JT4uPCU9bk5hbWUoZWEpJT4obmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKTwlfSklPg0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgICAgICAuPCU9bU5hbWUlPihkZXB0aC0xKSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9KSU+DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgcmVmcyA9IHJldC5maWx0ZXIociA9PiByLkVudGl0eUNsYXNzKTsNCiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBvIG9mIChvYmpzIHx8IFtdKS5maWx0ZXIoX28gPT4gIV9vLl9fc3luY19vbigpKSl7DQogICAgICAgICAgICBpZihvLl90b0VNU09iamVjdCl7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG8uX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpLjwlPW1OYW1lJT4oZGVwdGgpKSkpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmVmcy5wdXNoKC4uLihhd2FpdCBvLjwlPW1OYW1lJT4oZGVwdGgpKSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmVmcyA9IHJlZnMuZmlsdGVyKHIgPT4gcik7DQogICAgICAgIA0KICAgICAgICByZWZzLmZvckVhY2gociA9PiByLl9yZXNvbHZlKHJlZnMpKTsNCg0KICAgICAgICA8JT1sb2coKSU+Ik91dHB1dCIsIHJldCk7DQoNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7ZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcywgX19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IFtdfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXNvbHZlJyU+KHJlZnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcmVmcy5sZW5ndGgpIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLl9faW1wb3J0KHt9LCB7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAoKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPW5OYW1lKGVhKSU+IiwgdGhpcy48JT1uTmFtZShlYSklPigpLklkLCByZWZzLm1hcChyID0+ICh7aWQ6IHIuSWQsIGNvZGU6IHIuY29kZSgpfSkpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmcy5maW5kKG8gPT4gby5JZD09dGhpcy48JT1uTmFtZShlYSklPigpLklkKSB8fCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihyZWZzKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLjwlPXRhTmFtZSU+KCkubGVuZ3RoKSB0aGlzLjwlPXRhTmFtZSU+KHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodGEgPT4gcmVmcy5maW5kKG8gPT4gby5JZD09dGEuSWQpIHx8IHRhLjwlPW1OYW1lJT4ocmVmcykpLCBudWxsLCB0cnVlKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KPCUgaWYobWFpbkNsYXNzKFsnRU1TJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU1ZhbHVlcyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0VNUyddKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMoZXZzLCBbLi4ubmV3IFNldChldnMubWFwKHYgPT4gdi5lbnRpdHlBdHRyaWJ1dGUoKS5JZCkuZmxhdCgpKV0ubWFwKGlkID0+IG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZShpZCkpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5ldnMpOw0KICAgICAgICANCiAgICAgICAgICAgIGxldCBvYmpzID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiX2VudGl0eU9iamVjdCIpLmZvckVhY2goZXZnID0+IHsNCiAgICAgICAgICAgICAgICBldmcua2V5LmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXZnLnZhbHVlcyk7DQogICAgICAgICAgICAgICAgb2Jqcy5wdXNoKGV2Zy5rZXkpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIG9ianMuZm9yRWFjaChyID0+IHIuZW50aXR5Q2xhc3Moci5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKClbMF0uZW50aXR5QXR0cmlidXRlKCkuZW50aXR5Q2xhc3MoKSkpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygb2Jqcyl7DQogICAgICAgICAgICAgICAgcmV0LnB1c2goYXdhaXQgbmV3IDwlPXNjb3BlJT5bci5lbnRpdHlDbGFzcygpLm5hbWUoKV0oKS5fZnJvbUVNU09iamVjdChyKSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIDwlfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0VNUyddLGMpKSU+KCkuPCU9bU5hbWUlPihldnMpOw0KICAgIDwlfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9FTVNDbGFzcyclPihkZXB0aCl7DQogICAgICAgIC8vIHdoeSBub3QgX19leHBvcnQgPw0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3MoJzwlPWMuSWQlPicpLm5hbWUoIjwlPWMuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoYyklPiIpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmRhdGUobmV3IERhdGUoKSkuY29tcGFueShuZXcgPCU9c2NvcGUlPi5Db21wYW55KCkubmFtZSgiPCU9c2NvcGUlPiIpLmNvZGUoIjwlPXNjb3BlJT4iKSkuZW50aXR5TW9kdWxlKG5ldyA8JT1zY29wZSU+LkVudGl0eU1vZHVsZSgpLmNvZGUoIjwlPXNjb3BlJT4iKS5uYW1lKCI8JT1zY29wZSU+IikpOw0KICAgICAgICAgICAgaWYoIWRlcHRoKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQuZW50aXR5Q2xhc3NfRW50aXR5TWV0aG9kcyhbDQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlNZXRob2QoJzwlPW0uSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPW0uTmFtZSU+IikuY29kZSgiPCU9bk5hbWUobSklPiIpLmVudGl0eU1ldGhvZF9FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICAgICAgPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1wLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1wLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKHApJT4iKS5pc0FycmF5KDwlPXAuSXNBcnJheT8ndHJ1ZSc6J2ZhbHNlJyU+KS5yZW1hcmsoIjwlPWMuTmFtZSU+LjwlPW0uTmFtZSU+KCkiKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKQ0KICAgICAgICAgICAgPCUgaWYocC5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS48JT1tTmFtZSU+KGRlcHRoLTEpKQ0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKHApJT4odHJ1ZSkNCiAgICAgICAgICAgIDwlIH0lPiwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgIF0pLnJlc3BvbnNlQXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9bS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShtLlJlc3BvbnNlQXR0cmlidXRlKSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSkNCiAgICAgICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKG0uUmVzcG9uc2VBdHRyaWJ1dGUpJT4odHJ1ZSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKS5lbnRpdHlDbGFzc19FbnRpdHlBdHRyaWJ1dGVzKFsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1lYS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9ZWEuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUoZWEpJT4iKS5yZW1hcmsoJzwlPWMuTmFtZSU+LjwlPWVhLk5hbWUlPicpDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgLmlzPCU9X0ZyRU1ELl9hdHRyKGVhKSU+KHRydWUpDQogICAgICAgIDwlIH0lPiwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICBdKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfZnJvbUVNU09iamVjdCclPihvYmopew0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0aGlzLklkID0gb2JqLklkOw0KICAgICAgICAgICAgbGV0IGV2ID0gbnVsbDsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBldiA9IG9iai5lbnRpdHlPYmplY3RfRW50aXR5VmFsdWVzKCkuZmluZChldiA9PiBldi5lbnRpdHlBdHRyaWJ1dGUoKS5jb2RlKCk9PTwlPV9uQ29kZShlYSklPik7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihldi5vYmplY3RWYWx1ZSgpKSk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBpZihldikgdGhpcy48JT1uTmFtZShlYSklPihldi48JT1fRnJFTUQuX2F0dHIoZWEpLnRvTG93ZXJDYXNlKCklPlZhbHVlKCkpOw0KICAgICAgICA8JSB9JT4NCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgPCUgfSklPg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvRU1TT2JqZWN0JyU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyl7DQogICAgICAgIGxldCByZXQgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlPYmplY3QoKS5hY3RpdmUodHJ1ZSkuZW50aXR5Q2xhc3ModGhpcy5fdG9FTVNDbGFzcygpKTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIC8vTnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5JZCA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LkVudGl0eVZhbHVlKCkuYWN0aXZlKHRydWUpLmVudGl0eUF0dHJpYnV0ZShuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPWVhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1lYS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShlYSklPiIpLmVudGl0eUNsYXNzKHRoaXMuX3RvRU1TQ2xhc3MoKSkpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGV2Lm9iamVjdFZhbHVlKHY/di48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyk6bnVsbCwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKS50b0xvd2VyQ2FzZSgpJT5WYWx1ZSh2LCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoZXYsICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBpZih2ICYmIGJUeXBlZEF0dHJpYnV0ZXMpIG9iai5vYmplY3RWYWx1ZV9FbnRpdHlWYWx1ZXModi5tYXAoX3YgPT4gbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5QXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9dGEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUoIjwlPW5OYW1lKHRhKSU+IikubmFtZSgiPCU9dGEuTmFtZSU+IikuZW50aXR5Q2xhc3MobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdG9FTVNDbGFzcygpKSkub2JqZWN0VmFsdWUoX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpKSksICc9PScpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoWydCSVNlcnZlciddKSl7JT4NCiAgICA8JT1tTmFtZT0nX2FzT2JqZWN0cyclPihldnMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pIT1jKXslPg0KICAgICAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10sYykpJT4oKS48JT1tTmFtZSU+KGV2cyk7DQogICAgPCV9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZXZzKT09PSJ1bmRlZmluZWQiIHx8ICFldnMgfHwgIUFycmF5LmlzQXJyYXkoZXZzKSB8fCAhZXZzLmxlbmd0aCkgcmV0dXJuIFtdOw0KDQogICAgICAgICAgICBldnMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgZXYuRW50aXR5QXR0cmlidXRlID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSWQ9PWV2LkVudGl0eUF0dHJpYnV0ZWlkKTsNCiAgICAgICAgICAgICAgICBldi5FbnRpdHlPYmplY3QuRW50aXR5Q2xhc3MgPSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgaWYoZXYuT2JqZWN0VmFsdWUpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcyA9IDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcy5maW5kKGVjID0+IGVjLklkPT1ldi5PYmplY3RWYWx1ZS5FbnRpdHlDbGFzcy5JZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICBsZXQgb2JqID0gW107DQogICAgICAgICAgICB0aGlzLmdyb3VwQnkoZXZzLCAiRW50aXR5T2JqZWN0IikuZm9yRWFjaChldmcgPT4gew0KICAgICAgICAgICAgICAgIGxldCBjID0gbmV3IDwlPXNjb3BlJT5bZXZnLmtleS5FbnRpdHlDbGFzcy5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKTsNCiAgICAgICAgICAgICAgICBjLkVudGl0eVZhbHVlcyA9IGV2Zy52YWx1ZXM7DQogICAgICAgICAgICAgICAgYy5WYWx1ZUVudGl0aWVzID0gW107DQogICAgICAgICAgICAgICAgLy8gYy5FbnRpdHlDbGFzcyA9IGV2Zy5rZXkuRW50aXR5Q2xhc3M7DQogICAgICAgICAgICAgICAgYy5JZCA9IGV2Zy5rZXkuSWQ7DQogICAgICAgICAgICAgICAgZXZnLnZhbHVlcy5mb3JFYWNoKHYgPT4gdi5FbnRpdHlPYmplY3QgPSBjKTsNCiAgICAgICAgICAgICAgICBvYmoucHVzaChjKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBldnMuZmlsdGVyKGV2ID0+IGV2Lk9iamVjdFZhbHVlKS5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgX2YgPSBvYmouZmluZChvID0+IG8uSWQgPT0gZXYuT2JqZWN0VmFsdWUuSWQpOw0KICAgICAgICAgICAgICAgIGlmKF9mKSBfZi5WYWx1ZUVudGl0aWVzLnB1c2goZXYpOw0KICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gX2Y7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICBvYmouZm9yRWFjaChvID0+IHsNCiAgICAgICAgICAgICAgICBpZihvLkVudGl0eUNsYXNzICYmIG8uRW50aXR5Q2xhc3MuSWQhPXRoaXMuRW50aXR5Q2xhc3MuSWQpIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKG8pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQubWFwKG8gPT4gby5fcmV2ZXJ0KCkpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCV9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19yZXZlcnQnJT4oZW8pIHsNCiAgICAgICAgaWYgKGVvKSB7DQogICAgICAgICAgICAvLyByZXZlcnQgZnJvbSBzb3VyY2UgZGF0YQ0KICAgICAgICAgICAgaWYoZW8uRW50aXR5Q2xhc3MgJiYgKCh0aGlzLkVudGl0eUNsYXNzLklkICYmIGVvLkVudGl0eUNsYXNzLklkIT10aGlzLkVudGl0eUNsYXNzLklkKSB8fCAodGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIGVvLkVudGl0eUNsYXNzLk5hbWUhPXRoaXMuRW50aXR5Q2xhc3MuTmFtZSkpKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iQ2Fubm90IHJldmVydCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcy5FbnRpdHlDbGFzcykgKyAiIGZyb20gIiArIGVvLkVudGl0eUNsYXNzLk5hbWUsIGVvKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuSWQgPSBlby5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gZW8uRW50aXR5VmFsdWVzIHx8IFtdOw0KICAgICAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzID0gZW8uVmFsdWVFbnRpdGllcyB8fCBbXTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLjwlPW1OYW1lJT4oKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmKHRoaXMuX19zeW5jX29uKCkgJiYgTWF0aC5hYnMoKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCA1KXsNCiAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJPYmplY3QgYWxyZWFkeSByZXZlcnRlZCIsIHRoaXMuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgDQogICAgICAgICAgICAvLyB1c2UgRW50aXR5VmFsdWVzIGFuZCBWYWx1ZUVudGl0aWVzIHRvIHJldmVydCB0aGUgYXR0cmlidXRlIHZhbHVlcw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMuZm9yRWFjaChldiA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGVhID0gbnVsbDsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIGVhID0gPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihfZWEgPT4gX2VhLkVudGl0eUNsYXNzLk5hbWU9PSc8JT1jLk5hbWUlPicpLmZpbmQoX2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZWlkPT1fZWEuSWQpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihldi5FbnRpdHlBdHRyaWJ1dGUpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5JZD09X2VhLklkKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lPT1fZWEuTmFtZSkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBpZighZWEpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4idW5hYmxlIHRvIGRldGVjdCBhdHRyaWJ1dGUgZnJvbSB2YWx1ZSIsIGV2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXYsIGV4KTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGxldCB2ID0gZXZbKHRoaXNbIl9hdHRyIl0/dGhpczpfRnJFTUQpLl9hdHRyKGVhKSArICJWYWx1ZSJdOw0KICAgICAgICAgICAgICAgIGxldCBwID0gZWEuTmFtZS5yZXBsYWNlKC8gL2csICdfJyk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRoaXNbcF0pIT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImludmFsaWQgdHlwZSIsIGVhLCBwLCB2KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZih2ICYmIGVhLkVudGl0eVR5cGUgJiYgdHlwZW9mKHYpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+InJldmVydGluZyAiICsgZWEuTmFtZSwgdiwgbmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXYuRW50aXR5VmFsdWVzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+ImVtcHR5IHZhbHVlcyBmb3IgIiArIGVhLk5hbWUsIHYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bZWEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3BdKHYpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHRoaXMuVmFsdWVFbnRpdGllcy5maWx0ZXIodmUgPT4gdmUuRW50aXR5QXR0cmlidXRlKS5mb3JFYWNoKHZlID0+IHsNCiAgICAgICAgICAgICAgICB2YXIgdGEgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5JZD09dmUuRW50aXR5QXR0cmlidXRlLklkKTsNCiAgICAgICAgICAgICAgICBpZighdGEpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHZhciB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOw0KDQogICAgICAgICAgICAgICAgbGV0IHYgPSB2ZS5FbnRpdHlPYmplY3Q7DQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIHYgPSB2LjwlPW1OYW1lJT4/di48JT1tTmFtZSU+KCk6bmV3IDwlPXNjb3BlJT5bdGEuRW50aXR5VHlwZS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oKS48JT1tTmFtZSU+KHYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzW3RhLk5hbWUucmVwbGFjZSgvIC9nLCAiXyIpICsgIl8iICsgdGFOYW1lXSh2KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3ZhbHVlQ2xhc3MnJT4oKXsNCiAgICAgICAgbGV0IF9jbGFzcyA9IHtBY3RpdmU6IHRydWV9Ow0KICAgICAgICBpZih0aGlzLkVudGl0eUNsYXNzLkVudGl0eU1vZHVsZSl7DQogICAgICAgICAgICBfY2xhc3MuRW50aXR5TW9kdWxlID0gdGhpcy5FbnRpdHlDbGFzcy5FbnRpdHlNb2R1bGU7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgX2NsYXNzID0gew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBDb21wYW55OiB7QWN0aXZlOiB0cnVlLCBFbmFibGVkOiB0cnVlLCBFbnRpdHlDbGFzc2VzOiBbdGhpcy5FbnRpdHlDbGFzc119DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgICAgIHJldHVybiBfY2xhc3M7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1hNTCclPigpew0KICAgICAgICAvLyBhbiBvdmVybG9hZCBvZiB0aGUgc3IuX3RvWE1MDQogICAgICAgIGxldCByZXQgPSB7eG1sOiBgYH07DQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQueG1sICs9IGA8JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCd9PiR7dn08LyR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnfT5gLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8JHtlYUNvZGV9PmA7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSB2P3YuPCU9bU5hbWUlPigpOm51bGw7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCFbQ0RBVEFbJHt2fV1dPmA7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwvJHtlYUNvZGV9PmA7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwke2VhQ29kZX0+YCArIHYubWFwKF92ID0+ICc8T2JqZWN0PicgKyBfdi48JT1tTmFtZSU+KCkgKyAiPC9PYmplY3Q+Iikuam9pbignJykgKyBgPC8ke2VhQ29kZX0+YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0LnhtbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX2J1aWxkVGhpcyclPihkZXB0aD0xKXsNCiAgICAgICAgLy8gY2FuZGlkYXRlIGZvciBfX2V4cG9ydA0KICAgICAgICB2YXIgcmV0ID0gW3sNCiAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZToge0FjdGl2ZTogdHJ1ZSwgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKX0sDQogICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHRoaXMudG9FbnRpdHlPYmplY3QodHJ1ZSksDQogICAgICAgIH1dOw0KICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSBkZXB0aDsgaSsrKSB7DQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFtyZXRbaSAtIDFdXQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIA0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4geyU+DQogICAgICAgIGlmKGRlcHRoPjEpew0KICAgICAgICAgICAgbGV0IHYgPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgcmV0LnB1c2goew0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHY/di50b0VudGl0eU9iamVjdCh0cnVlKTpudWxsLA0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3sNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdj92LnRvRW50aXR5T2JqZWN0KHRydWUpOm51bGwsDQogICAgICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSd0b0VudGl0eU9iamVjdCclPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpIHsNCiAgICAgICAgbGV0IHJldCA9IHtBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB0aGlzLl92YWx1ZUNsYXNzKCksIEVudGl0eVZhbHVlczogW10sIFZhbHVlRW50aXRpZXM6IFtdfTsNCiAgICAgICAgaWYoIWJRdWVyeSkgcmV0LkRhdGUgPSB0aGlzLnNlcnZlckRhdGUoKTsgDQoNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIEZ1bGw6ICFiUXVlcnksDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouSWQgPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAiPCU9bk5hbWUoZWEpJT4iOiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZXYgPSB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCkuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWU9PSc8JT1lYS5OYW1lJT4nKS5JZCwNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI8JT1lYS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7fSwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICBldi5PYmplY3RWYWx1ZSA9IHYuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpOw0KICAgICAgICAgICAgICAgICAgICBldi5PUEVSQVRPUlMuT2JqZWN0VmFsdWUgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IHY7DQogICAgICAgICAgICAgICAgZXYuT1BFUkFUT1JTLjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqLlZhbHVlRW50aXRpZXMucHVzaChldik7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKHYgJiYgYlR5cGVkQXR0cmlidXRlcykgb2JqLkVudGl0eVZhbHVlcy5wdXNoKHYubWFwKF92ID0+ICh7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBJZDogJzwlPXRhLklkJT4nLA0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIjwlPXRhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBPYmplY3RWYWx1ZTogX3YuPCU9bU5hbWUlPihiUXVlcnksIGJUeXBlZEF0dHJpYnV0ZXMpLA0KICAgICAgICAgICAgICAgIH0pKSk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9ICU+DQp9DQo=",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195d702e5e0733c90c05b3505c066df",
		"transform": "KiojJGZbaW50ZXJuYWxfbmFtZT1cXCciK2MuTmFtZSsiX2xvb2t1cFxcJyBhbmQgJG5vdCgkZXhpc3RzKGZsb3dfRmxvd19TbmFwc2hvdHMpKV0uc25hcHNob3RfRmxvd19Mb2dpY3MuKioucGFyZW50X0Zsb3dfSW5zdGFuY2VzIyRmaVskbnVtYmVyKG9yZGVyKTw9IitiT3JkZXIrIiBhbmQgc3ViZmxvdy5pbnRlcm5hbF9uYW1lPVxcJyIrZWEuRW50aXR5VHlwZS5OYW1lKyJfbG9va3VwXFwnXS51aV9pZA=="
	}, {
		"id": "0195d702e5e173ffbb847d78cde2a922",
		"transform": "JC5zeXNfc2NvcGUuc2NvcGU="
	}, {
		"id": "0195d702e5e173ffbb84814c2ee00570",
		"transform": "W14="
	}, {
		"id": "0195d702e5e173ffbb848944cc9779ef",
		"transform": "JywgJycpLnJlcGxhY2UoJw=="
	}]
}
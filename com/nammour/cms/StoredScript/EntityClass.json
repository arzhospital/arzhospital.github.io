{
	"Id": "aef89fdd0589108010c06bcaaf7d74895908eddd",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "EntityClass",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCgke3N9fHwnLicpYDsNCg0KbGV0IF9kZWYgPSAocywgdikgPT4gJT48JT1zJT4gPSB0eXBlb2YoPCU9cyU+KSE9PSd1bmRlZmluZWQnPzwlPXMlPjo8JT12JT47PCUNCg0KbGV0IF9kZWZhdWx0cyA9IChvYmo9J3RoaXMnLCBfYz1jKSA9PiBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkRlZmF1bHQpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighPCU9b2JqJT4uXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgPCU9b2JqJT4uPCU9bk5hbWUoZWEpJT4oPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4pOw0KICAgICAgICAgICAgfQ0KPCUgfSk7DQoNCmxldCBsb2cgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMCwgYDsNCmxldCB3YXJuID0gKG4sIF90aGlzPSd0aGlzJykgPT4gYCR7X3RoaXN9LmxvZyhudWxsLCB1bmRlZmluZWQsICcke24gfHwgbU5hbWV9JywgJ0VudGl0eU9iamVjdCcsIDEsIGA7DQpsZXQgZXJyb3IgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMiwgYDsNCg0KbGV0IHFsVHlwZSA9IChlYSwgYklucHV0KSA9PiB7DQogICAgaWYoZWEuSXNCb29sKSByZXR1cm4gJ0Jvb2xlYW4nOw0KICAgIC8vaWYoZWEuSXNEYXRlKSByZXR1cm4gJ0RhdGVUaW1lJzsNCiAgICBpZihlYS5Jc0ludCB8fCBlYS5Jc0Zsb2F0KSByZXR1cm4gJ0ludCc7DQogICAgaWYoZWEuRW50aXR5VHlwZSkgcmV0dXJuIG5OYW1lKGVhLkVudGl0eVR5cGUpKyhiSW5wdXQ/IklucHV0IjoiIik7DQogICAgcmV0dXJuICdTdHJpbmcnOw0KfTsNCg0KLy8gd2h5IGhhcmQgY29kZWQ/Pz8NCmxldCBfcmVzdFRvb2xzID0gWydTZXJ2aWNlTm93JywgJ1NhbGVzRm9yY2UnLCAnUmVzdERCSU8nLCAnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCmxldCBfc3FsVG9vbHMgPSBbJ1NxbERCJywgJ1NhbGVzRm9yY2UnLCAnU25vd0ZsYWtlJ107DQpsZXQgX2ZpbGVUb29scyA9IFsnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCg0KbGV0IGNsc1Rvb2xzID0gX2MgPT4gX2MuVG9vbHMubWFwKHQgPT4gdC50eXBlP3QudHlwZS5uYW1lOih0Lm5hbWUgfHwgdCkpOw0KbGV0IG1haW5DbGFzcyA9IChfYXJUb29scywgX2M9YykgPT4gYXJDbGFzc2VzLmZpbmQoX19jID0+IChfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmZpbmQodCA9PiBjbHNUb29scyhfX2MpLmluY2x1ZGVzKHQpKSkgfHwgKCEoX2FyVG9vbHMgfHwgY2xzVG9vbHMoX2MpKS5sZW5ndGggJiYgYXJDbGFzc2VzWzBdKTsNCg0KbGV0IF9lYVR5cGVzID0gKF9jPWMsIGJBbGwpID0+IF9GckVNRC5fdG9KUyhPYmplY3QuYXNzaWduKHt9LCAuLi5fYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGJBbGw/dHJ1ZTplYS5FbnRpdHlUeXBlKS5tYXAoZWEgPT4gKHtbbk5hbWUoZWEpXTogbk5hbWUoZWEuRW50aXR5VHlwZSkgfHwgX0ZyRU1ELl9hdHRyKGVhKX0pKSkpOw0KDQpsZXQgX2NGaWVsZCA9IChlYSwgX2M9ZWEuRW50aXR5Q2xhc3MpID0+ICgoZWEuRW50aXR5VHlwZT8oZWEuRW50aXR5VHlwZS5UeXBlZEF0dHJpYnV0ZXMuZmluZCh0YSA9PiB0YS5FbnRpdHlDbGFzcz09X2MpIHx8IGVhLkVudGl0eUNsYXNzLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLkVudGl0eVR5cGU9PV9jKSk6bnVsbCkgfHwge05hbWU6ICIifSkuTmFtZTsNCg0KbGV0IF9jTmFtZSA9IChjbj1jLk5hbWUsIGJBbGlhcykgPT4gew0KICAgIGlmKGNuLk5hbWUpIGNuID0gY24uTmFtZTsNCiAgICBsZXQgX2MgPSBhckNsYXNzZXMuZmluZChlYyA9PiBlYy5OYW1lPT1jbik7DQogICAgaWYoIV9jKSByZXR1cm4gJyc7DQogICAgcmV0dXJuIG5OYW1lKF9jLCBiQWxpYXMpOw0KfTsNCg0KbGV0IGFsaWFzID0gKGNuLCBqPScuJykgPT4gKHNjb3BlICsgJy4nICsgX2NOYW1lKGNuLCB0cnVlKS5yZXBsYWNlKF9jTmFtZShjbiksICcnKSkuc3BsaXQoJy4nKS5maWx0ZXIobiA9PiBuKS5qb2luKGopOw0KbGV0IG5zY29wZSA9IGFsaWFzKCdOb2RlJyk7DQoNCmxldCBfdkNvZGUgPSBrID0+IHslPig8JXZhbHVlT2Yoay5Db2RlKSU+IHx8ICgiPCU9bkNvZGUoayklPiIpKTwlfTsNCmxldCBfbkNvZGUgPSAoZWEsIGJUeXBlZCkgPT4gZWE/KCJ0aGlzLl9uQ29kZSgnIiArIG5Db2RlKGVhKSArIChiVHlwZWQ/KCdfJyArIGVhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJykpOiIiKSAgKyAiJywgIiArIChiVHlwZWQ/bnVsbDpfRnJFTUQuX3RvSlMoZWEuQ29kZSkpICsgIikiKToidGhpcy5fbkNvZGUoKSI7DQpsZXQgbVJvdXRpbmcgPSAoYywgbSkgPT4gew0KICAgIGlmICghYyAmJiBtKSBjID0gbS5FbnRpdHlDbGFzczsNCiAgICBpZiAoIW0gJiYgIWMpIHJldHVybiAiIjsNCiAgICBpZiAoIW0pIG0gPSBjOw0KICAgIGlmICghbS5Sb3V0aW5nICYmICFjLlJvdXRpbmcpIHJldHVybiAiIjsNCg0KJT4oX25vZGUsIG1ldGhvZCkgPT4gew0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlbT9tLk5hbWU6JyclPiIgfHwgbWV0aG9kLCAiUm91dGVyIiwgMCwgLi4ubXNnKTsNCiAgICAJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAJbGV0IG5TY29wZSA9IDwlPW5zY29wZSU+Ow0KDQogICAgICAgIHRyeXsNCiAgICAgICAgPCVmdW5jdGlvbk9mKG0uUm91dGluZyklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgd2FybihleCk7DQogICAgICAgIH0NCn0NCjwlfTsNCg0KbGV0IG1OYW1lID0gJyc7DQoNCmxldCBmdW5jdGlvbk9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4NCiAgICAgICAgbGV0IF9fcmV0ID0gdW5kZWZpbmVkOw0KICAgIDwlIGlmKGZ1bil7JT4NCiAgICAgICAgPCUgaWYodHlwZW9mKGZ1bik9PT0nb2JqZWN0Jyl7JT4NCiAgICAgICAgICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYoPCU9X3RoaXMlPi5Ub29sICYmIDwlPV90aGlzJT4uVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgICAgICAgICA8JSBpZih0eXBlb2YoZnVuW3RdKT09PSdmdW5jdGlvbicpeyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPWZ1blt0XSU+Ow0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPShKU09OLnN0cmluZ2lmeShmdW5bdF0pIHx8ICciIicpJT47DQogICAgICAgICAgICAgICAgPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuJT47DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0lPg0KICAgICAgICBpZih0eXBlb2YoX19yZXQpPT09J3N0cmluZycgJiYgX19yZXQuc3RhcnRzV2l0aCgicygiKSAmJiBfX3JldC5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgIF9fcmV0ID0gdGhpcy5ydW5TY3JpcHQoX19yZXQuc2xpY2UoMiwtMSkpOw0KICAgICAgICB9DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgIF9fcmV0ID0gX19yZXQoPCU9X3RoaXMlPik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9fcmV0Ow0KPCV9Ow0KDQpsZXQgdmFsdWVPZiA9IChmdW4sIF90aGlzPSd0aGlzJykgPT4geyU+KCgNCihvU2NvcGUpID0+IHsNCiAgICB0cnl7DQo8JWZ1bmN0aW9uT2YoZnVuLCBfdGhpcyklPg0KICAgIH1jYXRjaChfdk9mRXgpew0KICAgICAgICA8JT13YXJuKCklPid2YWx1ZU9mJywgX3ZPZkV4LCA8JT1fRnJFTUQuX3RvSlMoZnVuKSU+KTsNCiAgICB9DQp9DQopKDwlPWFsaWFzKCklPikpPCV9Ow0KDQpsZXQgdW5SZWN1cnNlID0gKG9iaiwgZnVuLCBmQXJncz0nYXJndW1lbnRzJywgc1JldCwgdmFsaWRpdHk9YHRoaXMuX19jb25maWcoJ3VuUmVjdXJzZS52YWxpZGl0eScsIDAuNSlgLCBpZGYpID0+IHsNCiAgICBpZGYgPSBpZGYgfHwgYCh0aGlzP3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTonSWQnKWA7DQogICAgZnVuID0gZnVuIHx8IGAiJHttTmFtZX0iYDsNCiAgICBzUmV0ID0gYA0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICB2LmRhdGUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgICAgICAgICAgICAgICB2LnJldXNlZCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAke3NSZXR9DQogICAgICAgIH1jYXRjaChzUmV0X2V4KXsNCiAgICAgICAgICAgIHRoaXMubG9nKG51bGwsIHVuZGVmaW5lZCwgJHtmdW59LCAnJHttTmFtZX0udW5SZWN1cnNlJywgMSwgJ3NSZXQnLCBzUmV0X2V4KTsNCiAgICAgICAgfWZpbmFsbHl7DQogICAgICAgICAgICBpZih2ICYmIHYucmV1c2VkPjEpIHJldHVybiB2P3Yub2JqOnY7DQogICAgICAgIH0NCiAgICBgOw0KICAgIGxldCBiRGFuZ2VyID0gKCkgPT4gJT4oWyJfdG9IYXNoIl0uaW5kZXhPZig8JT1mdW4lPik+PTApPCU7DQolPg0KICAgICAgICBsZXQgdiA9IHVuZGVmaW5lZDsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCA9IDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnQgfHwge307DQogICAgICAgICAgICBpZig8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPmBBYm9ydGluZyBhcyBwZXIgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydC4kezwlPWZ1biU+fWApOw0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgX2lkID0gbnVsbDsNCiAgICAgICAgICAgIGlmKHR5cGVvZig8JT1vYmolPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPiJOdWxsIGlucHV0IiwgPCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gPCU9b2JqJT47DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoPCU9b2JqJT4pPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuaGFzaENvZGUoPCU9b2JqJT4pOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKDwlPW9iaiU+WzwlPWlkZiU+XSkhPT0ndW5kZWZpbmVkJyAmJiA8JT1vYmolPls8JT1pZGYlPl09PTwlPW9iaiU+WzwlPWlkZiU+XSl7DQogICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT5bPCU9aWRmJT5dOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoX2lkKT09PSd1bmRlZmluZWQnIHx8ICFfaWQpew0KICAgICAgICAgICAgICAgIGlmKDwlPW9iaiU+LklkICYmIDwlPW9iaiU+LklkPT08JT1vYmolPi5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IDwlPW9iaiU+LklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtvbmx5VW5pcXVlOiB0cnVlfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4idGhpcy5oYXNoZWRfaWQiLCBfaWQsIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihvYmouU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gb2JqLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJvYmouaGFzaGVkX2lkIiwgX2lkLCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPik7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoPCU9b2JqJT4uRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPi5FbnRpdHlDbGFzcy5JZCB8fCA8JT1vYmolPi5FbnRpdHlDbGFzcy5OYW1lIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjwlPWMuSWQlPiIgfHwgdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtkZXB0aDogPCViRGFuZ2VyKCklPj8zOnVuZGVmaW5lZH0sIDwlPWZ1biU+KSB8fCAiTlVMTCI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL2lmKCI8JT1uTmFtZShjKSU+Ij09IkhUTUxQYWdlIiAmJiA8JT1mdW4lPj09Il9mcm9tRmlsZU5hbWUiKSA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Il9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4sIDwlPW9iaiU+KTsNCiAgICAgICAgICAgIA0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT4gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiB8fCB7fTsNCiAgICAgICAgCTwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XSB8fCB7fTsNCiAgICAgICAgCTwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gfHwge307DQogICAgICAgIAkNCiAgICAgICAgICAgIHYgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXTsNCg0KICAgICAgICAgICAgaWYodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCo8JT12YWxpZGl0eSU+KSl7DQogICAgICAgICAgICAgICAgaWYoKDwlYkRhbmdlcigpJT4/bmV3IERhdGUoMCk6KHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSkuZ2V0VGltZSgpID4gdi5kYXRlKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+YFNwYXduaW5nIGluICR7PCU9ZnVuJT59YCwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4sIHYucmV1c2VkLCA8JT12YWxpZGl0eSU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+IlNlbGVjdGVkIGhhc2giLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICA8JT1zUmV0JT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+IlB1c2hpbmcgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+KTsNCiAgICAgICAgCXYgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSA9IHsNCiAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwNCiAgICAgICAgICAgICAgICBhcmdzOiBKU09OLnN0cmluZ2lmeSg8JT1mQXJncyU+KSwNCiAgICAgICAgICAgICAgICBvYmo6IDwlPW9iaiU+LA0KICAgICAgICAgICAgICAgIHJldXNlZDogMCwNCiAgICAgICAgICAgICAgICBwYXRoOiAnJywNCiAgICAgICAgICAgICAgICBfaWQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JS8qZXhwZXJpbWVudGFsOiByZW1vdmUgdGhpcyBpZiBhbGwgZ29lcyB3cm9uZyovJT4NCiAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgIAl9Y2F0Y2godW5SZWNFeCl7DQogICAgCSAgICBpZighdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKXsNCiAgICAJICAgICAgICA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSA9IHRydWU7DQogICAgCSAgICB9DQogICAgCSAgICA8JT1lcnJvcihgJHttTmFtZX0udW5SZWN1cnNlYCklPjwlPW9iaiU+LCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPiwgdW5SZWNFeC50b1N0cmluZygpKTsNCiAgICAJICAgIDwlPXNSZXQlPg0KICAgIAl9DQo8JQ0KfTsNCg0KbGV0IGludm9rZVJ1bGUgPSByID0+IHsNCiU+DQphd2FpdCAoYXN5bmMgKGF1dGhPYmopID0+IHsNCiAgICBsZXQgX3J1bGUgPSA8JT1fRnJFTUQuX3RvSlMociklPjsNCiAgICBkZWxldGUgX3J1bGUuU2NyaXB0Ow0KICAgIC8vIHJ1bGVSdW5zLnB1c2goX3J1bGUpOw0KICAgIHRyeXsNCiAgICAgICAgPCU9ci5TY3JpcHQlPg0KICAgIH1jYXRjaChleCl7DQogICAgICAgIF9ydWxlLkV4Y2VwdGlvbiA9IGV4Ow0KICAgIH0NCn0pKGF1dGhPYmopOw0KPCUNCn0NCiU+DQoNCmNsYXNzIDwlPW5OYW1lKGMpJT4gew0KICAgIDwlPW1OYW1lPSdjb25zdHJ1Y3RvciclPihpZCwgdG9vbCkgew0KICAgICAgICAvL3N1cGVyKGlkLCB0b29sKTsNCg0KICAgICAgICB0aGlzLlNjb3BlID0gIjwlPXNjb3BlJT4iOw0KICAgICAgICB0aGlzLkRlYnVnID0gPCU9X0ZyRU1ELl90b0pTKGMuRGVidWcpJT47DQogICAgICAgIHRoaXMuQ29uZmlnID0gPCU9X0ZyRU1ELl90b0pTKGMuQ29uZmlnKSU+Ow0KICAgICAgICB0aGlzLlRlc3QgPSA8JT1fRnJFTUQuX3RvSlMoYy5UZXN0KSU+Ow0KICAgICAgICB0aGlzLlRvb2xzID0gPCU9X0ZyRU1ELl90b0pTKGMuVG9vbHMpJT47DQogICAgICAgIHRoaXMuTWFwcGluZ3MgPSA8JT1fRnJFTUQuX3RvSlMoYy5NYXBwaW5ncyklPjsNCg0KICAgICAgICAvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUNCiAgICAgICAgdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9Ow0KICAgICAgICB0aGlzLlRvb2wgPSB0b29sOw0KICAgICAgICB0aGlzLklkID0gaWQ7DQoNCiAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzID0gW107DQoNCiAgICAgICAgdGhpcy5EYXRlID0gbnVsbDsNCg0KICAgICAgICB0aGlzLmNsZWFyX1RISVMoKTsNCiAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7DQogICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCjwlIGlmKE51bWJlcihlYS5JZCkpeyU+DQogICAgICAgICAgICAgICAgSWQ6ICI8JT1lYS5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgICAgIE5hbWU6ICI8JT1lYS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgT1BFUkFUT1JTOiB7fQ0KICAgICAgICB9KTsNCiAgICAgICAgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHslPg0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyklPigpOw0KPCUgfSk7ICU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZGVmYXVsdHMnJT4oKXsNCjwlX2RlZmF1bHRzKCklPg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBFbnRpdHlDbGFzcyclPigpew0KICAgICAgICBsZXQgZWMgPSB7DQo8JSBpZihOdW1iZXIoYy5JZCkpeyU+DQogICAgICAgICAgICBJZDogIjwlPWMuSWQlPiIsDQo8JSB9JT4NCiAgICAgICAgICAgIE5hbWU6ICI8JT1jLk5hbWUlPiIsDQogICAgICAgICAgICBPUEVSQVRPUlM6IHtOYW1lOiAiPSJ9LA0KICAgICAgICB9Ow0KDQo8JSBpZihjLkVudGl0eU1vZHVsZWlkKXsgJT4NCiAgICAgICAgZWMuRW50aXR5TW9kdWxlID0gew0KICAgICAgICAgICAgSWQ6IDwlPWMuRW50aXR5TW9kdWxlaWQlPg0KICAgICAgICB9Ow0KPCUgfSU+DQoNCiAgICAgICAgLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyDQogICAgICAgIGlmKCFOdW1iZXIoZWMuSWQpICYmIDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcyl7DQogICAgICAgICAgICBsZXQgY2lkID0gPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lPT1lYy5OYW1lKTsNCiAgICAgICAgICAgIGlmKGNpZCkgZWMuSWQgPSBjaWQuSWQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGVjOw0KICAgIH0NCg0KCTwlPW1OYW1lPSdnZXQgSWQnJT4oKSB7DQoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsNCgl9DQoNCgk8JT1tTmFtZT0nc2V0IElkJyU+KGlkKSB7DQoJCWlmICghdGhpcy5Ub29sKSB7DQoJCQk8JT1sb2coKSU+IkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmKHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV09PWlkKSByZXR1cm47DQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsNCgl9DQoNCiAgICA8JT1tTmFtZT0nZ2V0IFRvb2wnJT4oKSB7DQogICAgICAgIGlmKHR5cGVvZih0aGlzLl9fVG9vbCkhPT0ndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOw0KICAgICAgICBsZXQgbm9Ub29sID0gew0KICAgICAgICAgICAgbmFtZTogJycsDQogICAgICAgICAgICB0eXBlOiB7bmFtZTogJyd9LA0KICAgICAgICB9Ow0KICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5Ub29scykhPT0idW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheSg8JT1zY29wZSU+LlRvb2xzKSl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iPCU9c2NvcGUlPi5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIDwlPXNjb3BlJT4uVG9vbHMpOw0KICAgICAgICAgICAgcmV0dXJuIG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9ICg8JT1zY29wZSU+Ll9fbGFzdFRvb2w/WzwlPXNjb3BlJT4uX19sYXN0VG9vbF06W10pLmNvbmNhdCh0aGlzLlRvb2xzKS5maW5kKHQgPT4gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZT09X3QubmFtZSkpOw0KICAgICAgICBpZih0eXBlb2YocmV0KSE9PSd1bmRlZmluZWQnKSByZXQgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09cmV0IHx8IHQubmFtZT09cmV0Lm5hbWUpOw0KICAgICAgICBpZih0eXBlb2YocmV0KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbHMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbHNbMF0sDQogICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbHNbMF0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9ZWxzZSByZXQgPSBub1Rvb2w7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nc2V0IFRvb2wnJT4odG9vbCkgew0KICAgICAgICBpZiAodHlwZW9mKHRvb2wpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgaWYodHlwZW9mKHRvb2wpPT09InN0cmluZyIpew0KICAgICAgICAgICAgdG9vbCA9IHtuYW1lOiB0b29sfTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0b29sLkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgIHRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7DQogICAgICAgIH0NCiAgICAgICAgaWYodHlwZW9mKHRvb2wubmFtZSk9PT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHtuYW1lOiB0b29sLm5hbWV9Ow0KICAgICAgICANCiAgICAgICAgaWYoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IkVtcHR5IFRvb2wgb2JqZWN0Iik7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgdCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOw0KICAgICAgICBpZiAoIXQpIHsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIDwlPXNjb3BlJT4uVG9vbHMpOw0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1zY29wZSU+Ll9fbGFzdFRvb2wgPSB0aGlzLl9fVG9vbCA9IHQ7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nVEhJUyclPih2LCBjbyl7DQogICAgICAgIGlmKHR5cGVvZih2KT09PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsNCiAgICAgICAgaWYoIXYpIHJldHVybiB0aGlzOw0KICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdik9PT0nb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lPT10aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGU9PXRoaXMuU2NvcGUpOw0KICAgICAgICBpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2NsZWFyX1RISVMnJT4oKSB7DQogICAgICAgIHRoaXMuX1RISVMgPSBbXTsNCiAgICAgICAgdGhpcy5fVEhJU19jb29wID0gJyc7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPWVhLk5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT1uTmFtZShlYSklPih2LCBjbywgaWQpIHsNCiAgICAgICAgaWYgKGNvKSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gY287DQoNCiAgICAgICAgdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiPCU9ZWEuTmFtZSU+Iik7DQogICAgICAgIGlmICghZXYpew0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoaWQpIGV2LklkID0gaWQ7DQoNCiAgICAgICAgaWYgKHR5cGVvZih2KSE9PSd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyDQoNCiAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgdiA9IEFycmF5LmlzQXJyYXkodik/djpbdl07DQogICAgICAgICAgICB2ID0gdi5tYXAoX3YgPT4gew0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICB2ID0gKF92ID0+IHsNCiAgICA8JSB9JT4NCg0KICAgIDwlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICBfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJz9fdjoobmV3IERhdGUoX3YpKTsNCiAgICAgICAgICAgICAgICBpZihpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgIF92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOw0KICAgIDwlIH0lPg0KICAgIDwlIGlmKGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92KSkgX3YgPSAwOw0KICAgIDwlIH0lPg0KICAgIDwlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoX3YpPT09J29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOw0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZihfdiAmJiAhX3YuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+InVzaW5nIF90b0RvY3VtZW50IGZvciBpbnZhbGlkIHNldHRlciB2YWx1ZSIsIF92KTsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3YpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKF92ICYmIF92LkVudGl0eUNsYXNzLklkIT09JzwlPWVhLkVudGl0eVR5cGUuSWQlPicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSE9PSc8JT1lYS5FbnRpdHlUeXBlLk5hbWUlPicpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJJbnZhbGlkIFNldHRlciB2YWx1ZSIsIF92LCAiPCU9ZWEuRW50aXR5VHlwZS5JZCU+IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIjwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Iik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF92ID0gKChfdiAmJiAhdGhpcy5JZCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCg0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgfSk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIH0pKHYpOw0KICAgIDwlIH0lPg0KICAgIA0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsNCiAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gdjsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKSU+VmFsdWUgPSB2Ow0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICBpZih0cnVlIHx8IHRoaXMuXzwlPW5OYW1lKGVhKSU+IT12KXsNCiAgICAgICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgPSA8JT1TZXRfT24lPjsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU2V0IGFmdGVyIiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4/dGhpcy5fPCU9bk5hbWUoZWEpJT4uU2V0X09uOm51bGwsIHY/di5TZXRfT246bnVsbCk7DQogICAgICAgICAgICAgICAgLyppZih2KSB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgPSB2LlNldF9PbjsqLw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPiA9IHY7DQogICAgICAgICAgICBpZiAoY28pIGV2Lk9QRVJBVE9SUy48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IGNvOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuXzwlPW5OYW1lKGVhKSU+KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdjbGVhcl8nK25OYW1lKGVhKSU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT47DQogICAgICAgIC8qDQogICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IG51bGw7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCA9ICIiOw0KICAgICAgICAqLw0KICAgICAgICANCiAgICAgICAgZGVsZXRlIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldDsNCiAgICAgICAgZGVsZXRlIHRoaXMuXzwlPW5OYW1lKGVhKSU+Ow0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICAvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT1lYS5OYW1lJT4gKiovDQo8JSB9KTsgJT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPXRhLk5hbWUlPl88JT10YU5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT1uTmFtZSh0YSkrJ18nK3RhTmFtZSU+KHYsIGNvLCBiQ2xlYXIpIHsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09InVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjsNCiAgICAgICAgDQogICAgICAgIGlmKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkIT09JzwlPXRhLkVudGl0eUNsYXNzLklkJT4nICYmIHYuRW50aXR5Q2xhc3MuTmFtZSE9PSc8JT10YS5FbnRpdHlDbGFzcy5OYW1lJT4nKSByZXR1cm4gdGhpczsNCiAgICAgICAgDQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICANCiAgICAgICAgdiA9IHYuZmlsdGVyKF92ID0+ICF2IHx8IF92Ll88JT1uTmFtZSh0YSklPl9zZXQpLmNvbmNhdCh2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuXzwlPW5OYW1lKHRhKSU+X3NldCkubWFwKF92ID0+IHsNCiAgICAgICAgICAgIGlmKCFfdi5jb25zdHJ1Y3Rvcil7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iPCU9bk5hbWUodGEpJT4gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOw0KICAgICAgICAgICAgfWVsc2UgaWYoX3YuY29uc3RydWN0b3IubmFtZT09Ik9iamVjdCIpew0KICAgICAgICAgICAgICAgIF92ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF92KQ0KICAgICAgICAgICAgICAgIF92LjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICAgICAgICAgIH1lbHNlIGlmKF92LmNvbnN0cnVjdG9yLm5hbWUhPSI8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiIpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5OYW1lKHRhKSU+IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4iKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIF92LjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSkuZmlsdGVyKF92ID0+IF92KSk7DQogICAgICAgIA0KICAgICAgICBpZihiQ2xlYXIpIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4oKTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4ucHVzaCguLi52KTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fc2V0ID0gPCU9U2V0X09uJT47DQogICAgICAgIGlmIChjbykgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fY29vcCA9IGNvOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICBjbGVhcl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPigpIHsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+Ow0KDQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X3NldCA9IG51bGw7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+ID0gbmV3IEFycmF5KCk7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X2Nvb3AgPSBudWxsOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICAvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPiAqKi8NCg0KPCUgfSkgJT4NCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgLyoqIHN0YXJ0OiBnZXR0ZXJzIGZvciA8JT1lZi5OYW1lJT4gKiovDQogICAgPCU9bU5hbWU9J2dldCAnK25OYW1lKGVmKSU+KCl7DQogICAgICAgIHJldHVybiA8JXZhbHVlT2YoZWYuVmFsdWUpJT47DQogICAgfQ0KICAgIC8qKiBlbmQ6IGdldHRlcnMgZm9yIDwlPWVmLk5hbWUlPiAqKi8NCjwlIH0pJT4NCg0KICAgIDwlPW1OYW1lPSdsb2cnJT4oY2xhc3NOYW1lLCBvYmosIG0sIHR5cGUsIGxldmVsLCAuLi5tc2cpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICB0eXBlID0gdHlwZSB8fCAiRW50aXR5T2JqZWN0IjsNCiAgICAgICAgDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBvYmosIG0sIHR5cGUsIGxldmVsLCAuLi5tc2cpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KCQkJbGV0IGRlYnVnID0gdGhpcy5EZWJ1ZzsNCgkJCWxldCBsZXZlbHMgPSBbImluZm8iLCAid2FybiIsICJlcnJvciIsICJjcml0aWNhbCJdOw0KDQoJCQlkZWJ1ZyA9IGRlYnVnIHx8IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKGxldmVscy5tYXAobCA9PiBbbCwgJyonXSkpKTsNCg0KCQkJbGV0IGZ1bmN0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIC4uLmxldmVscy5tYXAobCA9PiAoew0KCQkJCVtsXTogZGVidWdbbF0gPyBkZWJ1Z1tsXS5zcGxpdCgnLCcpIDogW10NCgkJCX0pKSk7DQoNCgkJCWxldCBjc3MgPSAnYmFja2dyb3VuZDogIzAwZmY5OTsgY29sb3I6ICMwMDgwMDAnOw0KCQkJbGV0IGZnID0gJ1x4MWJbMzJtJzsNCgkJCXN3aXRjaCAoTnVtYmVyKGxldmVsKSkgew0KCQkJCWNhc2UgMToNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNmZmZmMDA7IGNvbG9yOiAjMDAwMDgwJzsNCgkJCQkJZmcgPSAnXHgxYlszM20nOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIDI6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7DQoJCQkJCWZnID0gJ1x4MWJbMzFtJzsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAzOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOw0KCQkJCQlmZyA9ICdceDFiWzMxbVtDUklUSUNBTF0nOw0KCQkJCQlicmVhazsNCgkJCX0NCg0KCQkJaWYgKGZ1bmN0aW9uc1tsZXZlbHNbTnVtYmVyKGxldmVsKSB8fCAwXV0uZXZlcnkoZiA9PiAhWycqLionLCAnKi4nICsgbSwgJyonLCBtLCBjbGFzc05hbWUgKyAnLicgKyBtLCBjbGFzc05hbWUgKyAnLionXS5pbmNsdWRlcyhmKSkpIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsNCgkJCQljb25zb2xlLmxvZyhmZyArICIlc1x4MWJbMG0iLCBgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke2NsYXNzTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOw0KCQkJfSBlbHNlIHsNCgkJCQljb25zb2xlLmxvZyhgJWMgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke2NsYXNzTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCBjc3MsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7DQoJCQl9DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQljb25zb2xlLmxvZyhleCk7DQoJCX0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdzZXRJbnRlcnZhbCclPihjbGFzc05hbWUsIGZ1biwgbWludXRlcywgLi4uYXJncyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOw0KPCUgfWVsc2V7JT4NCgkJdHJ5IHsNCiAgICAJCWxldCBmTmFtZSA9IGZ1bi50b1N0cmluZygpLnNwbGl0KCcpJylbMF0gKyAnKSc7DQogICAgCQl0cnkgew0KICAgIAkJCS8vIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCk7DQogICAgDQogICAgCQkJdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKTsNCiAgICAJCQlsZXQgcmV0ID0gYXdhaXQgZnVuKC4uLmFyZ3MuY29uY2F0KFtuZXcgRGF0ZSgpXSkpOw0KICAgIA0KICAgIAkJCTwlPWxvZygpJT5ge0NhbGw6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApICsgYCwgTG9vcDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCkgKyAnfScpOw0KICAgIAkJCWlmICghcmV0KSB7DQogICAgCQkJCTwlPWxvZygpJT5gZGlkIG5vdCByZXR1cm4gdHJ1ZSwgZXhpdGluZyBsb29wZXIgKCR7dGhpcy5fX3RpbWUoZk5hbWUpfSlgKTsNCiAgICAJCQkJcmV0dXJuOw0KICAgIAkJCX0NCiAgICAJCX0gY2F0Y2ggKGV4KSB7DQogICAgCQkJPCU9ZXJyb3IoKSU+dGhpcy5fX3RpbWUoZk5hbWUpLCBleCk7DQogICAgCQkJY29uc29sZS50cmFjZSgpOw0KICAgIAkJfQ0KICAgIAkJaWYgKCFOdW1iZXIobWludXRlcykpIHsNCiAgICAJCQk8JT1sb2coKSU+dGhpcy5fX3RpbWUoZk5hbWUpLCAiTm90IHJlcGVhdGluZy4gTWludXRlcyBpcyAiICsgbWludXRlcyk7DQogICAgCQkJcmV0dXJuOw0KICAgIAkJfQ0KICAgIAkJYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIG1pbnV0ZXMgKiA2MCAqIDEwMDApKTsNCiAgICAJCWF3YWl0IHRoaXMuPCU9bU5hbWUlPihudWxsLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOw0KCQl9IGNhdGNoIChleCkgew0KCQkJPCU9ZXJyb3IoKSU+ZXgpOw0KCQl9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2V4ZWN1dGUnJT4oY2xhc3NOYW1lLCBzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcyA9IHt9LCBzb3VyY2Upew0KCQl0aGlzLl9fdGltZShgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4uJHttfWApOw0KCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KCQlzY29wZSA9IHNjb3BlIHx8IDwlPXNjb3BlJT47DQoJCXNvdXJjZSA9IHNvdXJjZSB8fCB0aGlzOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcywgdGhpcyk7DQo8JSB9ZWxzZXslPg0KCQlkZWxldGUgPCU9c2NvcGUlPi5fdW5SZWN1cnNlOyAvLyBleHBlcmltZW50YWwNCgkJDQogICAgCWxldCBfX2JlZm9yZVJ1bGVzID0gb1BhcmFtcy5fX2JlZm9yZVJ1bGVzIHx8IFtdOw0KICAgIAlsZXQgX19hZnRlclJ1bGVzID0gb1BhcmFtcy5fX2FmdGVyUnVsZXMgfHwgW107DQogICAgCWRlbGV0ZSBvUGFyYW1zLl9fYmVmb3JlUnVsZXM7DQogICAgCWRlbGV0ZSBvUGFyYW1zLl9fYWZ0ZXJSdWxlczsNCg0KICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICBsZXQgd2FybiA9ICguLi5zKSA9PiA8JT13YXJuKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICAgICAgDQogICAgICAgIHRyeXsNCiAgICAJCWxldCBsUGFyYW1zID0gT2JqZWN0LmVudHJpZXMob1BhcmFtcykubWFwKHggPT4geFsxXSk7DQogICAgCQlsZXQgcmVzdWx0cyA9IFtdOw0KICAgIA0KICAgIAkJbGV0IG5vZGVzID0gW107DQogICAgCQkNCiAgICAJCWlmICg8JT1uc2NvcGUlPi5fbm9kZSAmJiBhd2FpdCBmUm91dGVyKDwlPW5zY29wZSU+Ll9ub2RlLCBtKSkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJaWYgKDwlPW5zY29wZSU+Ll9ub2RlICYmIDwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnQgJiYgYXdhaXQgZlJvdXRlcig8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSwgbSkpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKTsNCiAgICAJCX0NCiAgICANCiAgICAJCWZvciBhd2FpdCAoY29uc3QgY24gb2YgKDwlPW5zY29wZSU+Ll9ub2RlPzwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudF9Ob2RlcygpOltdKSkgew0KICAgICAgICAgICAgICAgIGlmIChhd2FpdCBmUm91dGVyKGNuLCBtKSkgew0KICAgICAgICAgICAgICAgIAlsb2coJ2FkZGluZyBjaGlsZCBub2RlJywgY24pOw0KICAgICAgICAgICAgICAgIAlub2Rlcy5wdXNoKGNuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgCQl9DQogICAgDQogICAgCQkvLyByZW1vdmUgYW55IG51bGxzDQogICAgCQlub2RlcyA9IG5vZGVzLmZsYXQoKS5maWx0ZXIobiA9PiBuKTsNCiAgICAJCQ0KICAgIAkJaWYgKCFub2Rlcy5sZW5ndGgpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlKTsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJbm9kZXMgPSB0aGlzLl91bmlxdWUobm9kZXMsICdfY29kZScpOw0KICAgIAkJbG9nKCdub2Rlcy5sZW5ndGgnLCBub2Rlcy5sZW5ndGgpOw0KDQogICAgCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2Ygbm9kZXMpIHsNCiAgICAJCQlsZXQgblJldCA9IG51bGw7DQogICAgCQkJbG9nKGAke219IEAgJHtuPy5jb2RlKCkgfHwgJ0xPQ0FMJ31gKTsNCiAgICAJCQlpZiAoIW4gfHwgdGhpcy5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZSwgbikpIHsNCiAgICAJCQkJLy8gbG9jYWwgc2NyaXB0DQogICAgCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2JlZm9yZVJ1bGVzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICA8JXZhbHVlT2YoInIuU2NyaXB0IiklPg0KICAgIAkJCQkJLy9hd2FpdCB0aGlzLl9TY3JpcHQoY2xhc3NOYW1lLCByLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdCZWZvcmVSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOw0KICAgIAkJCQl9DQoNCiAgICAJCQkJblJldCA9IGF3YWl0IGZTY3JpcHQoKTsNCg0KICAgIAkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19hZnRlclJ1bGVzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICA8JXZhbHVlT2YoInIuU2NyaXB0IiklPg0KICAgIAkJCQkJLy9hd2FpdCB0aGlzLl9TY3JpcHQoY2xhc3NOYW1lLCByLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdBZnRlclJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7DQogICAgCQkJCX0NCiAgICAJCQl9IGVsc2Ugew0KICAgIAkJCQluUmV0ID0gYXdhaXQgc291cmNlLl9pbnZva2VOb2RlKG4sIG0sIG9QYXJhbXMpOw0KICAgIAkJCX0NCiAgICANCiAgICAJCQlyZXN1bHRzLnB1c2goew0KICAgIAkJCQlub2RlOiBuLA0KICAgIAkJCQlyZXQ6IG5SZXQNCiAgICAJCQl9KTsNCiAgICAJCX0NCiAgICAJCWxvZyhyZXN1bHRzLCAiX2V4ZWN1dGUiLCAnUmVzdWx0cycpOw0KICAgIA0KICAgIAkJbGV0IGVycm9ycyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5yZXQgJiYgci5yZXQuX19leGNlcHRpb24pLm1hcChyID0+ICh7DQogICAgCQkJbm9kZTogci5ub2RlID8gew0KICAgIAkJCQljb2RlOiByLm5vZGUuY29kZSgpLA0KICAgIAkJCQlhZGRyZXNzOiByLm5vZGUuYWRkcmVzcygpDQogICAgCQkJfSA6IG51bGwsDQogICAgCQkJX19leGNlcHRpb246IHIucmV0Ll9fZXhjZXB0aW9uDQogICAgCQl9KSk7DQoNCiAgICAJCWlmIChlcnJvcnMubGVuZ3RoKSB7DQogICAgCQkJd2FybigiZXJyb3JzIiwgZXJyb3JzKTsNCiAgICAJCX0NCiAgICANCiAgICAJCXJldHVybiByZXN1bHRzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgZXJyb3IoZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX1NjcmlwdCclPihjbGFzc05hbWUsIHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIF9ub2RlLCAuLi5zZkFyZ3Mpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICBzY29wZSA9IHNjb3BlIHx8IDwlPXNjb3BlJT47DQogICAgICAgIA0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgX25vZGUsIC4uLnNmQXJncyk7DQo8JSB9ZWxzZXslPg0KICAgIAlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47DQogICAgCQ0KICAgICAgICB0cnl7DQogICAgCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdzdHJpbmcnKSBzY3JpcHQgPSB0aGlzLnJ1blNjcmlwdChgKCkgPT4geyR7c2NyaXB0fX1gKTsNCiAgICANCiAgICAJCWxldCByZXQgPSBudWxsOw0KICAgIAkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnZnVuY3Rpb24nKSB7DQogICAgCQkJcmV0ID0gYXdhaXQgc2NyaXB0KCk7DQogICAgCQl9DQogICAgDQogICAgCQlyZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5jbGFzc05hbWUsIG0sIHR5cGUsIHNjcmlwdCwgZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoNCiAgICA8JT1tTmFtZT0nX3NhbWVFbnRpdHknJT4oLi4uYXJFbnRpdGllcyl7DQogICAgICAgIGlmKGFyRW50aXRpZXMubGVuZ3RoPT0wKSByZXR1cm4gZmFsc2U7DQogICAgICAgIGlmKGFyRW50aXRpZXMubGVuZ3RoPT0xKSBhckVudGl0aWVzLnB1c2godGhpcyk7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oLi4uYXJFbnRpdGllcyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gYXJFbnRpdGllcy5zbGljZSgxKS5ldmVyeShlID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgdiA9IGFyRW50aXRpZXNbMF07DQogICAgICAgICAgICAgICAgbGV0IG5lZ1Rlc3QgPSB7DQogICAgICAgICAgICAgICAgICAgIHZOdWxsOiB2PT1udWxsLA0KICAgICAgICAgICAgICAgICAgICBlTnVsbDogZT09bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgdk9iamVjdDogdHlwZW9mKHYpIT09J29iamVjdCcsDQogICAgICAgICAgICAgICAgICAgIGVPYmplY3Q6IHR5cGVvZihlKSE9PSdvYmplY3QnLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjEsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIGlmKE9iamVjdC5rZXlzKE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5rZXlzKG5lZ1Rlc3QpLmZpbHRlcihrID0+IG5lZ1Rlc3Rba10pLm1hcChrID0+ICh7diwgZSwgW2tdOiB0cnVlfSkpKSkubGVuZ3RoKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgLy8gcGFzc2VkIGluaXRpYWwgY29uc2lzdGVuY3kgY2hlY2sNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2PT1lKSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBuZWdUZXN0ID0gew0KICAgICAgICAgICAgICAgICAgICBldkNvbnN0cjogdi5jb25zdHJ1Y3Rvci5uYW1lIT1lLmNvbnN0cnVjdG9yLm5hbWUsDQogICAgICAgICAgICAgICAgICAgIGVFbnRpdHk6ICFlLkVudGl0eUNsYXNzLA0KICAgICAgICAgICAgICAgICAgICB2RW50aXR5OiAhdi5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgICAgICAgICAgZXZFbnRpdHlOYW1lczogdHlwZW9mKGUuRW50aXR5Q2xhc3MuTmFtZSkhPT0ndW5kZWZpbmVkJyAmJiBlLkVudGl0eUNsYXNzLk5hbWUhPXYuRW50aXR5Q2xhc3MuTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgZXZFbnRpdHlJZHM6IHR5cGVvZihlLkVudGl0eUNsYXNzLklkKSE9PSd1bmRlZmluZWQnICYmIGUuRW50aXR5Q2xhc3MuSWQhPXYuRW50aXR5Q2xhc3MuSWQsDQogICAgICAgICAgICAgICAgICAgIGV2SURzOiB2LklkPT12LklkICYmIGUuSWQ9PWUuSWQgJiYgdi5JZCE9ZS5JZCwNCiAgICAgICAgICAgICAgICAgICAgZXZIYXNoOiB2Ll90b0hhc2gobnVsbCwge29ubHlVbmlxdWU6IHRydWV9LCAnPCU9bU5hbWUlPicpIT1lLl90b0hhc2gobnVsbCwge29ubHlVbmlxdWU6IHRydWV9LCAnPCU9bU5hbWUlPicpLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjIsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIG5lZ1Rlc3QgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3Qua2V5cyhuZWdUZXN0KS5maWx0ZXIoayA9PiBuZWdUZXN0W2tdKS5tYXAoayA9PiAoe3YsIGUsIFtrXTogdHJ1ZX0pKSk7DQogICAgICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKG5lZ1Rlc3QpLmxlbmd0aCkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjMsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nZ2V0IFNldF9PbiclPigpIHsNCiAgICAgICAgbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0IHx8IG51bGwsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCB8fCBudWxsLA0KPCUgfSklPg0KICAgICAgICApKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBTZXRfQ291bnQnJT4oKSB7DQogICAgICAgIHJldHVybiBbDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCwNCjwlIH0pJT4NCiAgICAgICAgXS5maWx0ZXIocyA9PiBzKS5sZW5ndGg7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmxhdHRlbiclPihkZXB0aCl7DQogICAgICAgIDwlPXdhcm4oKSU+IkRFUFJFQ0FURUQiKTsNCiAgICAgICAgbGV0IHJldCA9IHt9Ow0KICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICByZXQuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXQuPCU9bk5hbWUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGRlcHRoLTEpPCV9JT46dGhpcy48JT1uTmFtZShlYSklPigpOw0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgIHJldC48JT10YU5hbWUlPiA9IHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodCA9PiB0P3QuPCU9bU5hbWUlPihkZXB0aC0xKTp0KTsNCjwlIH0pJT4NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0hhc2gnJT4oYXJncywgb3B0aW9ucywgZlNvdXJjZSl7DQogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgICAgICANCiAgICAgICAgbGV0IG9IYXNoID0gew0KICAgICAgICAgICAgY2xhc3M6ICI8JT1uTmFtZShjKSU+IiwNCiAgICAgICAgICAgIHNvdXJjZTogZlNvdXJjZSwNCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MsDQogICAgICAgICAgICBfdGhpczoge30NCiAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgIGlmKCFvcHRpb25zLm5vVGhpcyAmJiBmU291cmNlIT0iPCU9bU5hbWUlPiIgJiYgKHR5cGVvZihvcHRpb25zLmRlcHRoKT09PSd1bmRlZmluZWQnIHx8IC0tb3B0aW9ucy5kZXB0aD4wKSl7DQogICAgICAgICAgICB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7DQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiAhb3B0aW9ucy5ub09wZXJhdG9ycywNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLl9tYXAsDQogICAgICAgICAgICAgICAgVW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmpbaWRDb2RlXSA9IHYsDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPmlmKG9wdGlvbnMubm9UeXBlcykgcmV0dXJuOzwlfSU+DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gPCUgaWYoZWEuRW50aXR5VHlwZSl7JT52P3YuPCU9bU5hbWUlPihudWxsLCBvcHRpb25zLCBmU291cmNlKTo8JX0lPigob3B0aW9ucy5vbmx5VW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPik/KHZ8fG51bGwpOnYpOw0KICAgICAgICAgICAgICAgIH0sDQo8JSB9KSU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihudWxsLCBvcHRpb25zLCBmU291cmNlKSksDQo8JSB9KSU+DQo8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IG9ialtlZkNvZGVdID0gdiwNCjwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKG9wdGlvbnMubm9BcmdzKSBvSGFzaCA9IG9IYXNoLl90aGlzOw0KICAgICAgICByZXR1cm4gb3B0aW9ucy5ub0NvZGU/b0hhc2g6dGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfYXV0aG9yaXplJyU+KHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcil7DQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiAhPCU9c2NvcGUlPi5fX3Rva2VuICYmIHRoaXMuVGVzdFsnPCU9bU5hbWUlPi51c2VybmFtZSddKXsNCiAgICAgICAgICAgIHVzZXJuYW1lID0gdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnVzZXJuYW1lJ107DQogICAgICAgICAgICBwYXNzd29yZCA9IHRoaXMuVGVzdFsnPCU9bU5hbWUlPi5wYXNzd29yZCddOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYoYlNlcnZlcil7DQogICAgICAgICAgICBpZih1c2VybmFtZSAmJiAhPCU9c2NvcGUlPi5fdGVzdFVzZXIgJiYgdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnRlc3RVc2VyJ10pew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3Rlc3RVc2VyID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnRlc3RVc2VyJ10pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuc3RvcmUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLnVzZXJuYW1lKHVzZXJuYW1lLCAnPScpLnBhc3N3b3JkKHBhc3N3b3JkLCAnPScpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iU2VydmVyOiAiICsgYlNlcnZlcisiLCBPYmo6IiwgcmV0KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0KXsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoanNvbndlYnRva2VuKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0ganNvbndlYnRva2VuLnNpZ24ocmV0Ll90b0RvY3VtZW50KCksIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCB7IGV4cGlyZXNJbjogJzE4MDBzJyB9KTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShyZXQuX3RvRG9jdW1lbnQoKSkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIGFjY2Vzc190b2tlbjogcmV0LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iU2VydmVyOiAiICsgYlNlcnZlcisiLCB0b2tlbjogIiwgcmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgbGV0IGNsaWVudF9pZCA9IHRoaXMuX19jb25maWcoJ2NsaWVudF9pZCcpOw0KICAgICAgICAgICAgbGV0IGNsaWVudF9zZWNyZXQgPSB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKTsNCiAgICANCiAgICAgICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgPCU9c2NvcGUlPi5fX3Rva2VuKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Ik5vIHVzZXJuYW1lL3Bhc3N3b3JkIGFuZCB0b2tlbiBhbHJlYWR5IGV4aXN0cyIpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgIDwlaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgbGV0IGRhdGEgPSB7DQogICAgICAgICAgICAgICAgZ3JhbnRfdHlwZTogJ3Bhc3N3b3JkJywNCiAgICAgICAgICAgICAgICB1c2VybmFtZSwNCiAgICAgICAgICAgICAgICBwYXNzd29yZCwNCiAgICAgICAgICAgICAgICBjbGllbnRfaWQsDQogICAgICAgICAgICAgICAgY2xpZW50X3NlY3JldCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBjb25maWcgPSB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiA8JT1zY29wZSU+Ll9fdG9rZW4gJiYgPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4pew0KICAgICAgICAgICAgICAgIGRhdGEgPSB7DQogICAgICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICJyZWZyZXNoX3Rva2VuIiwNCiAgICAgICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbjogPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4sDQogICAgICAgICAgICAgICAgICAgIGNsaWVudF9pZCwNCiAgICAgICAgICAgICAgICAgICAgY2xpZW50X3NlY3JldCwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHs8JT1zY29wZSU+Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHs8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5hZGRyZXNzKCl9OiR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkucG9ydCgpIHx8IDMwMDB9L29hdXRoL3Rva2VuYCwgT2JqZWN0LmtleXMoZGF0YSkubWFwKGtleSA9PiBrZXkgKyAnPScgKyBkYXRhW2tleV0pLmpvaW4oJyYnKSwgY29uZmlnKTsNCiAgICAgICAgICAgIGlmKHJldC5kYXRhLmFjY2Vzc190b2tlbil7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3Rva2VuID0gcmV0LmRhdGE7DQoNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbil7DQogICAgICAgICAgICAgICAgICAgIGlmKGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS5jbGVhcikgYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLmNsZWFyKCk7DQogICAgICAgICAgICAgICAgICAgIGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gcmVzcG9uc2UsIGFzeW5jIGVycm9yID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVxdWVzdCA9IGVycm9yLmNvbmZpZzsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YoPCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbik+MCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2F1dGhvcml6ZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyA8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VuOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBheGlvcyhvcmlnaW5hbFJlcXVlc3QpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKGF1dGhDbGFzcyl7JT4NCiAgICAJPCU9c2NvcGUlPi5fX3Rva2VuID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYXV0aENsYXNzKSU+KCkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS48JT1tTmFtZS5yZXBsYWNlKCdfJywgJycpJT4oKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICA8JT13YXJuKCklPiJObyBhdXRob3JpemF0aW9uIGRlZmluZWQiKTsNCiAgICA8JSB9JT4NCiAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPih1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOw0KPCV9JT4NCiAgICB9DQogICAgDQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX3NlcnZlciclPihvcHRpb25zPXt9KSB7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuY2xlYXJDb25zb2xlKSBjb25zb2xlLmNsZWFyKCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX19Ub29scykgPCU9c2NvcGUlPi5Ub29scyA9IDwlPXNjb3BlJT4uX19Ub29sczsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCk9PT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YoPCU9c2NvcGUlPi5ocmVmcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgIAkJZm9yIGF3YWl0IChjb25zdCBsIG9mIDwlPXNjb3BlJT4uaHJlZnMpIHsNCiAgICAgICAgCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwubGliLCA8JT1zY29wZSU+LmhyZWZzLCBhc3luYyBfbCA9PiB7DQogICAgPCUgaWYoX2NOYW1lKCdTdG9yZWRTY3JpcHQnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoX2wuc2NyaXB0ICYmIDwlPXNjb3BlJT4uVG9vbHMpIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1N0b3JlZFNjcmlwdCcsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF9sLnNjcmlwdCkubG9hZFNjcmlwdCgpOw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBsZXQgc2VjdXJlID0gdGhpcy5fX2NvbmZpZygnc2VjdXJlJyk7DQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAvLyBnbG9iYWxzDQogICAgICAgICAgICAgICAgdmFyIGdsb2JhbE1vZHVsZXMgPSB7DQogICAgICAgICAgICAgICAgICAgIGV4cHJlc3M6ICdleHByZXNzJywNCiAgICAgICAgICAgICAgICAgICAgaHR0cHM6ICdodHRwcycsDQogICAgICAgICAgICAgICAgICAgIGh0dHA6ICdodHRwJywNCiAgICAgICAgICAgICAgICAgICAgc2VsZnNpZ25lZDogJ3NlbGZzaWduZWQnLA0KICAgICAgICAgICAgICAgICAgICB1dGlsOiAndXRpbCcsDQogICAgICAgICAgICAgICAgICAgIGNvcnM6ICdjb3JzJywNCiAgICAgICAgICAgICAgICAgICAgYm9keVBhcnNlcjogJ2JvZHktcGFyc2VyJywNCiAgICAgICAgICAgICAgICAgICAgYXhpb3M6ICdheGlvcycsDQogICAgICAgICAgICAgICAgICAgIC8vY3J5cHRvOiAnY3J5cHRvJywNCiAgICAgICAgICAgICAgICAgICAgb3M6ICdvcycsDQogICAgICAgICAgICAgICAgICAgIC8vam1lc3BhdGg6ICdqbWVzcGF0aCcsDQogICAgICAgICAgICAgICAgICAgIGpzb25wYXRoOiAnanNvbnBhdGgnLA0KICAgICAgICAgICAgICAgICAgICBqc29uYXRhOiAnanNvbmF0YScsDQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdDogJ2RvdC1vYmplY3QnLA0KICAgICAgICAgICAgICAgICAgICBtYWNoaW5laWQ6ICdub2RlLW1hY2hpbmUtaWQnLA0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbWluaW1pc3Q6ICdtaW5pbWlzdCcsDQogICAgICAgICAgICAgICAgDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgICAgICAgICAgICAgICAgICBncmFwaHFsSFRUUDogJ2V4cHJlc3MtZ3JhcGhxbCcsDQogICAgICAgICAgICAgICAgICAgIGdyYXBocWw6ICdncmFwaHFsJywNCiAgICAgICAgICAgICAgICAgICAgcGxheWdyb3VuZDogJ2dyYXBocWwtcGxheWdyb3VuZC1taWRkbGV3YXJlLWV4cHJlc3MnLA0KPCUgfSU+DQoNCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydlbWFpbC5ob3N0J10peyU+DQogICAgICAgICAgICAgICAgICAgIG5vZGVtYWlsZXI6ICdub2RlbWFpbGVyJywNCjwlIH0lPg0KDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1sndG90cC5zZWNyZXQnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb3RwYXV0aDogJ290cGF1dGgnLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgICAgICAgICAgICAgICAgICBjaGlsZF9wcm9jZXNzOiAnY2hpbGRfcHJvY2VzcycsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgICAgICAgICBldmVudHM6ICdldmVudHMnLA0KICAgICAgICAgICAgICAgICAgICBzb2NrZXRpbzogJ3NvY2tldC5pbycsDQogICAgICAgICAgICAgICAgICAgIG1xdHQ6ICdtcXR0JywNCiAgICAgICAgICAgICAgICAgICAgYW1xcGxpYjogJ2FtcXBsaWInLA0KICAgICAgICAgICAgICAgICAgICBwcm90b2J1ZmpzOiAncHJvdG9idWZqcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZnM6ICdmcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnS2Fma2EnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIGthZmthanM6ICdrYWZrYWpzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbmVvNGo6ICduZW80ai1kcml2ZXInLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnb0F1dGggVG9rZW4nKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgT0F1dGhTZXJ2ZXI6ICdleHByZXNzLW9hdXRoLXNlcnZlcicsDQo8JSB9ZWxzZSBpZihhdXRoQ2xhc3MpeyU+DQogICAgICAgICAgICAgICAgICAgIGpzb253ZWJ0b2tlbjogJ2pzb253ZWJ0b2tlbicsDQo8JSB9JT4NCg0KDQo8JSBpZihtYWluQ2xhc3MoWydTcWxEQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgc3FsaXRlOiAnc3FsaXRlMycsDQogICAgICAgICAgICAgICAgICAgIG15c3FsOiAnbXlzcWwnLA0KICAgICAgICAgICAgICAgICAgICBwb3N0Z3JlczogJ3BnJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnU25vd0ZsYWtlJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBzbm93Zmxha2U6ICdzbm93Zmxha2Utc2RrJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnTW9uZ29EQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbW9uZ29kYjogJ21vbmdvZGInLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydSeERCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBSeERCOiAncnhkYicsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ0V4Y2VsJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBYTFNYOiAneGxzeCcsDQo8JSB9JT4NCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IG1pc3NpbmdHbG9iYWxNb2R1bGVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsTW9kdWxlcykubWFwKGUgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxbZVswXV0gPSByZXF1aXJlKGVbMV0pOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT5leCk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVsxXTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pLmZpbHRlcihlID0+IGUpOw0KICAgICAgICAgICAgICAgIGlmKG1pc3NpbmdHbG9iYWxNb2R1bGVzLmxlbmd0aCkgPCU9d2FybigpJT4ibnBtIGluc3RhbGwgIiArIG1pc3NpbmdHbG9iYWxNb2R1bGVzLmpvaW4oJyAnKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAJCTwlPWxvZygpJT5gU3RhcnRpbmcgWyR7PCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUuY29kZSgpOicnfV0uLi5gKTsNCg0KCQkJaWYgKG9wdGlvbnMubG9hZFRvb2xzKSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSB8fCBfY05hbWUoKSU+KCkuX2xvYWRUb29scyhvcHRpb25zLnNhdmVUb29scyk7DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXsgIC8qIFRvb2xzIGZpcnN0IG9yIE5vZGVzIGZpcnN0Pz8/ICovJT4NCiAgICAgICAgICAgIGlmKG9wdGlvbnMuaW5pdE5vZGUpew0KICAgICAgICAgICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLnNlY3VyZShzZWN1cmUpLmluaXQodGhpcy5fX2NvbmZpZygnaW5pdC5sb29wJywgMC41KSk7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKDwlPW5zY29wZSU+Ll9ub2RlKT09PSd1bmRlZmluZWQnKSByZXR1cm4gPCU9ZXJyb3IoKSU+IjwlPW5zY29wZSU+Ll9ub2RlIGlzIHVuZGVmaW5lZCEiKTsNCiAgICAgICAgICAgIH0NCjwlIH0lPg0KDQogICAgCQlpZiAodHlwZW9mKHRoaXMuaW5pdCk9PT0nZnVuY3Rpb24nICYmIG9wdGlvbnMuaW5pdFNlbGYpIHsNCiAgICAJCQlhd2FpdCB0aGlzLmluaXQoKTsNCiAgICANCiAgICAJCQlsZXQgc3FsVG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5fX2RtbFN0YXRlbWVudHMpOw0KICAgIAkJCWlmIChvcHRpb25zLmNvcHlETUwgJiYgc3FsVG9vbCkgew0KICAgIAkJCQlsZXQgZG1scyA9IHNxbFRvb2wuX19kbWxTdGF0ZW1lbnRzOw0KICAgIAkJCQlpZiAoc3FsVG9vbC50eXBlLm5hbWUgPT0gJ1NxbERCJykgZG1scyA9IFsgLyoiQ3VzdG9tZXJzIiwgIk9yZGVycyIsICJTaGlwcGluZ3MiLCAqLyAiZGVtbyJdLm1hcCh0ID0+IGBkcm9wIHRhYmxlIGlmIGV4aXN0cyAke3R9YCkuY29uY2F0KGRtbHMpOw0KICAgIAkJCQlfRnJFTUQuX2NvcHlUZXh0VG9DbGlwYm9hcmQoZG1scy5qb2luKCc7XG4nKSk7DQogICAgCQkJfQ0KICAgIAkJfQ0KDQo8JSBpZihfY05hbWUoJ05vZGUgVHlwZScpKXsgLyp0b2RvOiByZXBsYWNlIHRoaXMgd2l0aCBhbiBPVEFVcGRhdGUgY29uY2VwdCAqLyU+DQogICAgICAgICAgICAvLyByZWZyZXNoIHNjcmlwdA0KICAgICAgICAgICAgdGhpcy5zZXRJbnRlcnZhbChudWxsLCBhc3luYyAoLyp2ZXJzaW9uKi8pID0+IHsNCiAgICAgICAgICAgICAgICBpZih0aGlzLnNyKCkuYkxvY2FsKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHNjdCA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZSBUeXBlJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoPCU9c2NvcGUlPi5fXzwlPV9jTmFtZSgnTm9kZSBUeXBlJyklPiB8fCB7bmFtZTogJ05vZGVKUyd9KTsNCiAgICAgICAgICAgICAgICBsZXQgY3QgPSBhd2FpdCBzY3QuZmluZCgpOw0KICAgICAgICAgICAgICAgIGlmKCFjdCB8fCAhY3QuYWN0aXZlKCkgfHwgIWN0LmVuYWJsZWQoKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKCAhc2N0LmRhdGUoKSB8fCAoKGN0LmRhdGUoKS5nZXRUaW1lKCkgLSBzY3QuZGF0ZSgpLmdldFRpbWUoKSkvMTAwMCkgPiA1ICl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gTmV3ZXIgdmVyc2lvbiBmb3VuZDogW2RhdGU6ICR7Y3QuZGF0ZSgpLnRvSVNPU3RyaW5nKCl9LCB0b29sOiAke2N0LlRvb2wubmFtZX1dLCBzdG9yaW5nLi4uYCk7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugd2FudCB0byBzdG9yZSB0aGUgY29udGVudCBkaXJlY3RseSB0byB0aGUgbm9kZWpzLmpzIGZpbGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGN0Ll9maWxlc3lzdGVtKGN0LmNvZGUoKSArICcuanMnLCB0aGlzLl9hdG9iKGN0LnJlbWFyaygpKSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZih3aW5kb3cpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5zZWxmICE9PSB3aW5kb3cudG9wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJpRnJhbWUgc2hvdWxkIGJlIHJlc3RhcnRlZC4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IndpbmRvdyBsb2NhdGlvbiByZWxvYWRpbmcuLi4iKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy93aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iZnJhbWUgY2hlY2siLCBleCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fXzwlPV9jTmFtZSgnTm9kZSBUeXBlJyklPiA9IHNjdC5kYXRlKGN0LmRhdGUoKSkubmFtZShjdC5uYW1lKCkpLmNvZGUoY3QuY29kZSgpKS5fdG9Eb2N1bWVudCgpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfSwgMC41KTsNCjwlIH0lPg0KICAgICAgICANCiAgICAgICAgICAgIGlmKG9wdGlvbnMubG9hZENvbnRlbnQgJiYgdHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJykgd2luZG93Lm9uaGFzaGNoYW5nZSA9IGFzeW5jICgpID0+IGRvY3VtZW50LmJvZHkgPSBhd2FpdCB0aGlzLl9leHBvcnQoe3RtcDogbG9jYXRpb24uaGFzaC5wYWdlfSk7DQogICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICBjb25zdCBhcHAgPSBleHByZXNzKCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnVzZShjb3JzKCkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IHRydWUsIGxpbWl0OiAnNTBtYid9KSk7DQogICAgICAgICAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oew0KICAgICAgICAgICAgICAgICAgICB2ZXJpZnk6IChyZXEsIHJlcywgYnVmKSA9PiByZXEucmF3Qm9keSA9IGJ1Zg0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyICYmIGF1dGhIZWFkZXIuc3BsaXQoJyAnKVsxXTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbiA9PSBudWxsKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAxKTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGpzb253ZWJ0b2tlbi52ZXJpZnkodG9rZW4sIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCAoZXJyLCBvYmopID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDMpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5fX2F1dGhvcml6YXRpb24gPSBvYmo7DQogICAgICAgICAgICAgICAgICAgICAgICBuZXh0KCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIA0KPCUgaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgICAgIGFwcC5vYXV0aCA9IG5ldyBPQXV0aFNlcnZlcih7DQogICAgICAgICAgICAgICAgICAgIGRlYnVnOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyB1c2VFcnJvckhhbmRsZXI6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIGNvbnRpbnVlTWlkZGxld2FyZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gcmVxdWlyZUNsaWVudEF1dGhlbnRpY2F0aW9uOiB7IHBhc3N3b3JkOiBmYWxzZSB9LA0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbW9kZWw6ICgoKSA9PiAoew0KICAgICAgICAgICAgICAgIAkJZ2V0QWNjZXNzVG9rZW46IGJlYXJlclRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuYWNjZXNzVG9rZW4oYmVhcmVyVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldEFjY2Vzc1Rva2VuJykpLnRoZW4odCA9PiB7dC5hY2Nlc3NUb2tlbkV4cGlyZXNBdCA9IG5ldyBEYXRlKHQuYWNjZXNzVG9rZW5FeHBpcmVzT24pOyByZXR1cm4gdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q2xpZW50OiAoY2xpZW50SWQsIGNsaWVudFNlY3JldCkgPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfQ2xpZW50KCkuaW5pdCgpLmZpbmFsbHkoKCkgPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfQ2xpZW50KCkuaWQoY2xpZW50SWQpLnNlY3JldChjbGllbnRTZWNyZXQpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKSkudGhlbih0ID0+IGFwcC5vYXV0aC5oYW5kbGVyKHQsICdnZXRDbGllbnQnKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRVc2VyOiAodXNlcm5hbWUsIHBhc3N3b3JkKSA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShhdXRoQ2xhc3MpJT4oKS5hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldFVzZXInKSksDQogICAgICAgICAgICAgICAgCSAgICBzYXZlVG9rZW46ICh0b2tlbiwgY2xpZW50LCB1c2VyKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLl9mcm9tRG9jdW1lbnQodG9rZW4pLmNsaWVudChuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5fZnJvbURvY3VtZW50KGNsaWVudCkpLnVzZXIodXNlcikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc3RvcmUoKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ3NhdmVUb2tlbicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHJldm9rZVRva2VuOiB0b2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbih0b2tlbi5yZWZyZXNoVG9rZW4pLmNsaWVudChuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZCh0b2tlbi5jbGllbnQuaWQpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpKS5maW5kKCkudGhlbih0ID0+IHQuZW5hYmxlZChmYWxzZSkuYWN0aXZlKGZhbHNlKS5zdG9yZSgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ3Jldm9rZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgZ2V0UmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5yZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5maW5kKDIvKndoeSovKS50aGVuKHQgPT4gdC5fdG9Eb2N1bWVudCgpKS50aGVuKHQgPT4ge3QucmVmcmVzaFRva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5yZWZyZXNoVG9rZW5FeHBpcmVzT24pOyByZXR1cm4gdH0pLA0KICAgICAgICAJICAgICAgICB9KSkoKQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIGFwcC5vYXV0aC5oYW5kbGVyID0gKHQsIG0pID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobSkgPCU9bG9nKCklPm0sIHQuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5fdG9Eb2N1bWVudCgpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT5tLCBleC50b1N0cmluZygpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvb2F1dGgvdG9rZW4nLCBhcHAub2F1dGgudG9rZW4oKSk7DQogICAgICAgICAgICAgICAgZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFwcC5vYXV0aC5hdXRoZW50aWNhdGUoKTsNCjwlIH0lPg0KDQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+IG0uSXNQdWJsaWMpLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC88JT1uTmFtZShfYyklPi88JT1uTmFtZShtKSU+JywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIjwlPW5OYW1lKF9jKSU+IiwgIjwlPW5OYW1lKG0pJT4iKSk7DQogICAgICAgICAgICAgICAgYXBwLmdldCgnL21ldGhvZC88JT1uTmFtZShfYyklPi88JT1uTmFtZShtKSU+JywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIjwlPW5OYW1lKF9jKSU+IiwgIjwlPW5OYW1lKG0pJT4iKSk7DQo8JSB9KSklPg0KDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7DQogICAgICAgICAgICAgICAgYXBwLmdldCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgICAgICAgICAgICAgIGFwcC51c2UoJy9ncmFwaHFsJywgZ3JhcGhxbEhUVFAuZ3JhcGhxbEhUVFAoew0KICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IGdyYXBocWwuYnVpbGRTY2hlbWEodGhpcy5fdG9HUUxTY2hlbWEoKSksDQogICAgICAgICAgICAgICAgICAgIHJvb3RWYWx1ZTogdGhpcy5fcWxSZXNvbHZlcigpLA0KICAgICAgICAgICAgICAgICAgICBncmFwaGlxbDogdGhpcy5fX2NvbmZpZygicGxheWdyb3VuZCIpLA0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIikgJiYgdHlwZW9mKHBsYXlncm91bmQpIT09InVuZGVmaW5lZCIpIGFwcC5nZXQoJy9wbGF5Z3JvdW5kJywgcGxheWdyb3VuZC5kZWZhdWx0KHsgZW5kcG9pbnQ6ICcvZ3JhcGhxbCcgfSkpDQo8JSB9JT4NCg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4udHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7DQogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JyksDQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLl9fY29uZmlnKCdlbWFpbC51c2VyJyk/ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXI6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5wYXNzd29yZCcpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTp1bmRlZmluZWQsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgPCU9c2NvcGUlPi50cmFuc3BvcnRlci5zZW5kTWFpbCh7DQogICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5zZW5kZXInKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvLA0KICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdCwNCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgcG9ydCA9IDwlPW5zY29wZSU+Ll9ub2RlPyg8JT1uc2NvcGUlPi5fbm9kZS5wb3J0KCkgfHwgMzAwMCk6MzAwMDsNCiAgICAgICAgICAgICAgICBsZXQgYWRkcmVzcyA9ICIwLjAuMC4wIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgbGlzdGVuID0gYXN5bmMgKCkgPT4gPCU9bG9nKCklPmA8JT1zY29wZSU+WyR7dGhpcy5pcEFkZHJlc3MoKX1dIGxpc3RlbmluZyBhdCBodHRwJHtzZWN1cmU/J3MnOicnfTovLyR7YWRkcmVzc306JHtwb3J0fWApOw0KICAgICAgICAgICAgICAgIGlmKHNlY3VyZSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBjZXJ0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGU6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydDogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5jZXJ0JykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgY2VydCA9IHNlbGZzaWduZWQuZ2VuZXJhdGUoW3sgbmFtZTogJ2NvbW1vbk5hbWUnLCB2YWx1ZTogJ25hbW1vdXIuY29tJyB9XSwgeyBkYXlzOiAzNjUgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cHMuY3JlYXRlU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogY2VydC5wcml2YXRlLA0KICAgICAgICAgICAgICAgICAgICAgICAgY2VydDogY2VydC5jZXJ0DQogICAgICAgICAgICAgICAgICAgIH0sIGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGdsb2JhbC5leFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2luYm91bmRDYWxsJyU+KHJlcSwgcmVzLCBjTmFtZSwgbU5hbWUpew0KICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG5ldyA8JT1zY29wZSU+W3JlcS5wYXJhbXMuY2xhc3MgfHwgY05hbWVdKCkuX2ludm9rZShyZXEucGFyYW1zLm1ldGhvZCB8fCBtTmFtZSwgcmVxLmJvZHksIHJlcS5xdWVyeSwgcmVxLl9fYXV0aG9yaXphdGlvbik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgRXhjZXB0aW9uOiAiRXhjZXB0aW9uOiAiICsgZXgsDQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYocmV0ICYmIHR5cGVvZihyZXQpPT09Im51bWJlciIpIHJldCA9IHJldC50b1N0cmluZygpOw0KICAgICAgICByZXMuc2VuZChyZXQpOw0KICAgIH0NCg0KPCUgaWYoYy5Db25maWdbJ2dyYXBocWwnXSl7JT4NCiAgICA8JT1tTmFtZT0nX3FsU2VsZWN0aW9ucyclPihzU2V0KXsNCiAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICBpZighc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0Ow0KICAgICAgICANCiAgICAgICAgc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gew0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZihzLm5hbWUudmFsdWU9PSI8JT1uTmFtZShlYSklPiIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4nUmVmZXJlbmNlIGZvciA8JT1uTmFtZShlYSklPicsIHMpOw0KICAgICAgICAgICAgICAgIGxldCBzT2JqID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKHNPYmopOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOw0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfcWxSZXNvbHZlciclPigpew0KICAgICAgICByZXR1cm4gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShfYyklPjogYXN5bmMgKHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbykgPT4gew0KICAgICAgICAgICAgICAgIGlmKCFwYXJlbnQuZGF0YSkgcGFyZW50LnF1ZXJ5ID0gcGFyZW50LnF1ZXJ5IHx8IHt9Ow0KICAgICAgICAgICAgICAgIGxldCBvYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLl9mcm9tRG9jdW1lbnQocGFyZW50LnF1ZXJ5IHx8IHBhcmVudC5kYXRhKTsNCiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICBpZihwYXJlbnQucXVlcnkpew0KICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGRzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLmZpbmRBbGwobnVsbCwgb2JqLl9xbFNlbGVjdGlvbnMoY29udGV4dC5maWVsZE5vZGVzWzBdLnNlbGVjdGlvblNldCksIG51bGwsIG51bGwsIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLmNvbmNhdChjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMubWFwKHMgPT4gcy5uYW1lLnZhbHVlKSkpOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmVudC5kYXRhKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLnN0b3JlKCk7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5fX2Fzc2VydEVycm9yKSB0aHJvdyBvYmouX19hc3NlcnRFcnJvcjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldC5tYXAociA9PiByLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0P3JldC5fdG9Eb2N1bWVudCgpOnJldDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAgICAgICAgIC8vIDwlPW5OYW1lKF9tKSU+OiAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLjwlPW5OYW1lKF9tKSU+KCI8JT1uTmFtZShfbSklPiIsIHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbyksDQogICAgPCUgfSklPg0KPCUgfSklPg0KICAgICAgICB9Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvR1FMU2NoZW1hJyU+KCl7DQogICAgICAgIGxldCByZXQgPSBgDQp0eXBlIFF1ZXJ5IHsNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IHslPg0KICAgICIiIg0KICAgIEZpbmQgYWxsIG1hdGNoZXMgZm9yIDwlPW5OYW1lKF9jKSU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4ocXVlcnk6IDwlPW5OYW1lKF9jKSU+SW5wdXQpOiBbPCU9bk5hbWUoX2MpJT5dDQo8JSB9KSU+DQp9DQoNCnR5cGUgTXV0YXRpb24gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgU3RvcmUgYSBzaW5nbGUgPCU9bk5hbWUoX2MpJT4gb2JqZWN0DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4oZGF0YTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IDwlPW5OYW1lKF9jKSU+DQo8JSB9KSU+DQp9DQogICAgDQogICAgPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQoiIiINCklucHV0IHR5cGUgZm9yIDwlPW5OYW1lKF9jKSU+DQoiIiINCmlucHV0IDwlPW5OYW1lKF9jKSU+SW5wdXR7DQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPklucHV0XQ0KICAgIDwlIH0pJT4NCiAgICBPUEVSQVRPUlM6IDwlPW5OYW1lKF9jKSU+T3BlcmF0b3INCn0NCg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5PcGVyYXRvcnsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiBTdHJpbmcNCiAgICA8JSB9KSU+DQp9DQoNCiIiIg0KPCU9X2MuUmVtYXJrJT4NCiIiIg0KdHlwZSA8JT1uTmFtZShfYyklPnsNCiAgICBfaWQ6IElEIQ0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgIiIiDQogICAgPCU9ZWEuUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhKSU+PCU9ZWEuSXNSZXF1aXJlZD8nISc6JyclPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QgJiYgdGEuRW50aXR5VHlwZSkuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+OiBbPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT5dDQogICAgPCUgfSklPg0KDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5maWx0ZXIoX20gPT4gIV9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT46IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSwgdHJ1ZSklPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiBfbS5NZXRob2RQYXJhbWV0ZXJzLmxlbmd0aCkuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1fbS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKF9tKSU+KDwlPV9tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gbk5hbWUocCkgKyAnOiAnICsgcWxUeXBlKHAsIHRydWUpKS5qb2luKCcsICcpJT4pOiA8JT1xbFR5cGUoX20uUmVzcG9uc2VBdHRyaWJ1dGUpJT4NCiAgICA8JSB9KSU+DQp9DQogICAgPCUgfSklPg0KICAgICAgICBgOw0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9IC8vIGdyYXBoJT4NCg0KPCUgfSAvLyBJc01haW4gJT4NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW52b2tlTm9kZSclPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7DQogICAgICAgIC8vIGlmKCFuKSByZXR1cm4gbnVsbDsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZig8JT1uc2NvcGUlPi5fbm9kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uc2NvcGUlPi5fbm9kZSBub3QgZGVmaW5lZCIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKGV2ZW50KXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpIT0nPCU9bk5hbWUoYyklPicpew0KICAgICAgICAgICAgICAgIGxldCBvQ2xhc3MgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKGZhbHNlKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKycuJyttZXRob2QrJyAuLi4uJyk7DQogICAgPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHslPg0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKFsiPCU9ZW0udmFsdWVzLm1hcChtYyA9PiBuTmFtZShtYykpLmpvaW4oJyIsICInKSU+Il0uaW5kZXhPZihldmVudC5jbGFzc05hbWUoKSk+PTApew0KICAgICAgICAgICAgICAgICAgICBvQ2xhc3MgPSBuZXcgPCU9c2NvcGUlPjwlPWVtLmtleT8oJy4nK2VtLmtleS5BbGlhcyk6JyclPltldmVudC5jbGFzc05hbWUoKV0oKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBvQ2xhc3MuPCU9bU5hbWUlPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsNCiAgICAgICAgICAgIH0NCjwlIH1lbHNleyU+DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsNCiAgICAgICAgICAgIHJldHVybiBudWxsOw0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGRhdGEgPSBkYXRhIHx8IHt9Ow0KDQogICAgICAgIGlmKHR5cGVvZihkYXRhKT09PSJvYmplY3QiKXsNCiAgICAgICAgICAgIGRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9KU09OKHtwYXJzZTogMX0pOw0KICAgICAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KICAgICAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBkYXRhLjwlPW5OYW1lKHApJT4gPSBkYXRhLjwlPW5OYW1lKHApJT4/ZGF0YS48JT1uTmFtZShwKSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4ubWFwKF9wID0+IF9wPCV9JT4NCiAgICAgICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSl7JT4uX3RvRG9jdW1lbnQoKQ0KICAgICAgICAgICAgPCUgfWVsc2UgaWYocC5Jc0RhdGUpeyU+LnRvSVNPU3RyaW5nKCkNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgPCVpZihwLklzQXJyYXkpeyU+KTwlfSU+OnVuZGVmaW5lZDsNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgICAgICBpZih0eXBlb2Yobik9PT0nc3RyaW5nJykgbiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKG4pOw0KPCUgfSU+DQoNCiAgICAgICAgaWYoIW4gfHwgPCU9bnNjb3BlJT4uX25vZGUuX3NhbWVFbnRpdHkobikpew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7DQogICAgICAgICAgICA8JT1sb2coKSU+IkxvY2FsIG5vZGUiLCByZXQpOw0KDQogICAgICAgIH1lbHNlIGlmKG4uYWRkcmVzcygpKXsNCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+bi5hZGRyZXNzKCksIG4ucG9ydCgpLCBtZXRob2QpOw0KICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBkYXRhLCBudWxsLCBudWxsLCB7cGF0aDogYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kLzwlPW5OYW1lKGMpJT4vJHttZXRob2R9YCwgaGVhZGVyczoge319KTsNCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9ZWxzZXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSAmJiBjLk5hbWUhPT0nRXZlbnQnKXslPg0KICAgICAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsNCiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8NCiAgICAgICAgICAgIDwlIC8qdW5SZWN1cnNlKCdkYXRhJywgJ21ldGhvZCcsICd7fScsICcnLCA1LCAnX190aGlzLmNvZGUnKSovICU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRXZlbnQnLCB0cnVlKSU+KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnPCU9c2NvcGUlPi5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJzwlPW5OYW1lKGMpJT4nKS5zZW5kZXIoPCU9bnNjb3BlJT4uX25vZGUpLmNhcnJpZXIoPCU9bnNjb3BlJT4uX25vZGUpLnBheWxvYWQodGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShkYXRhKSkpOw0KICAgICAgICAgICAgaWYoZXZlbnQpew0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YocmV0KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlIGlmKHJldCAmJiB0eXBlb2YocmV0LnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgLy8gcmV0IGlzIGFuIGV2ZW50DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0LnBheWxvYWQoKTsNCiAgICAgICAgICAgIH1lbHNlIGlmKEFycmF5LmlzQXJyYXkocmV0KSAmJiByZXRbMF0gJiYgdHlwZW9mKHJldFswXS5wYXlsb2FkKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgIHJldCA9IHJldC5tYXAociA9PiByLnBheWxvYWQoKSk7DQogICAgICAgICAgICAgICAgaWYocmV0Lmxlbmd0aD09MSkgcmV0ID0gcmV0WzBdOw0KICAgICAgICAgICAgfQ0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpIHJldHVybiBudWxsOw0KICAgICAgICByZXQgPSByZXQuZGF0YSB8fCByZXQ7DQoNCiAgICAgICAgaWYocmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIC8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyDQogICAgICAgICAgICA8JT1lcnJvcigpJT5gRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfQ0KDQogICAgICAgIHN3aXRjaChtZXRob2Qpew0KPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBpZighYlJhdykgcmV0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQocmV0KTsNCiAgICA8JSB9ICU+DQogICAgPCUgaWYobS5OYW1lPT0nYXV0aG9yaXplJyl7JT4NCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fdG9rZW4gPSB7dG9rZW5fdHlwZTogIkJlYXJlciIsIGFjY2Vzc190b2tlbjogcmV0fTsNCiAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQo8JSB9KTsgJT4NCg0KICAgICAgICAgICAgY2FzZSAiaW5zZXJ0IjoNCiAgICAgICAgICAgIGNhc2UgInVwZGF0ZSI6DQogICAgICAgICAgICBjYXNlICJzdG9yZSI6DQogICAgICAgICAgICBjYXNlICJkZWxldGUiOg0KICAgICAgICAgICAgY2FzZSAiZmluZCI6IA0KICAgICAgICAgICAgY2FzZSAiZmluZEFsbCI6IHsNCiAgICAgICAgICAgICAgICBpZighYlJhdykgcmV0ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQocmV0KTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCjwlIGlmKG1haW5DbGFzcygpKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW52b2tlJyU+KG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopew0KICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjKSU+LicgKyBtZXRob2QpOw0KICAgICAgICA8JT1sb2coKSU+bWV0aG9kLCBxdWVyeSwgYm9keSk7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2YoYm9keSk9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICBpZig8JT1fYjY0dGVzdCgnYm9keScpJT4peyAvLyBiYXNlNjQ/DQogICAgICAgICAgICAgICAgYm9keSA9IHRoaXMuX2F0b2IoYm9keSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKC9bXiw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdLy50ZXN0KGJvZHkpKXsgLy8ganNvbg0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGxldCBfcGFyYW1zID0gcXVlcnk/T2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSk6Ym9keTsNCiAgICAgICAgaWYodHlwZW9mKF9wYXJhbXMpPT09J3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOw0KICAgICAgICANCiAgICAgICAgaWYoX3BhcmFtcyl7DQogICAgICAgICAgICBfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBfcGFyYW1zID0ge307DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+Il9wYXJhbXMiLCBfcGFyYW1zKTsNCg0KICAgIDwlIGlmKF9jTmFtZSgnTm9kZScpICYmIGMuTmFtZSE9J05vZGUnKXslPg0KICAgICAgICBpZihfcGFyYW1zLl9fbm9kZSl7DQogICAgICAgICAgICAvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPw0KICAgICAgICAgICAgbGV0IHRuID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLyouX2RlUmVmZXJlbmNlKCkqLzsNCiAgICAgICAgICAgIGRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsNCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQoNCiAgICAgICAgaWYoX3BhcmFtcy5fX3RoaXMpIHsNCiAgICAgICAgICAgIF9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7DQogICAgICAgICAgICBsZXQgX190aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS8qLl9kZVJlZmVyZW5jZSgpKi87DQogICAgICAgICAgICBkZWxldGUgX3BhcmFtcy5fX3RoaXM7DQogICAgICAgICAgICByZXR1cm4gYXdhaXQgX190aGlzLjwlPW1OYW1lJT4obWV0aG9kLCBfcGFyYW1zLCBudWxsLCBhdXRoT2JqKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCBhckFyZ3MgPSBbXTsNCiAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgY2FzZSAiPCU9bkNvZGUobSklPiI6IHsNCjwlIGlmKF9jTmFtZSgnVHJhbnNhY3Rpb24nKSAmJiBfY05hbWUoJ0NvbnRlbnQnKSAmJiBjLk5hbWUhPSdUcmFuc2FjdGlvbicgJiYgIW0uSXNTeW5jKXslPg0KICAgICAgICBpZighX3BhcmFtcy5TeW5jKXsNCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbnRlbnQnLCB0cnVlKSU+KChhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbnRlbnQnLCB0cnVlKSU+KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2NvcGUoIjwlPXNjb3BlJT4iKS5jbGFzcygiPCU9Yy5OYW1lJT4iKS5tZXRob2QobWV0aG9kKS5hdXRob3JpemF0aW9uKGF1dGhPYmopLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnBheWxvYWQodGhpcy5fYnRvYShfcGFyYW1zKSkudHJhbnNhY3Rpb25fVHJhbnNhY3Rpb25Mb2dzKFtuZXcgPCU9c2NvcGUlPi5UcmFuc2FjdGlvbkxvZygpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnN0YXRlKG5ldyA8JT1zY29wZSU+LlRyYW5zYWN0aW9uU3RhdGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCJsb2FkZWQiKSldKS5zdG9yZSgpKS5JZCkuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KPCUgfSU+DQoNCiAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICA8JSBpZihwLkVudGl0eVR5cGUgJiYgcC5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgIF9wYXJhbXMuPCU9bkNvZGUocCklPiA9IF9wYXJhbXMuPCU9bkNvZGUocCklPi5tYXAocCA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS5fZnJvbURvY3VtZW50KHApLl9kZVJlZmVyZW5jZSgpKTsNCiAgICAgICAgPCUgfWVsc2UgaWYocC5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBfcGFyYW1zLjwlPW5Db2RlKHApJT4gPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuPCU9bkNvZGUocCklPikuX2RlUmVmZXJlbmNlKCk7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLjwlPW5Db2RlKHApJT4pOw0KICAgIDwlIH0pOyU+DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQo8JSB9KTslPg0KDQogICAgICAgICAgICBjYXNlICJmaW5kQWxsIjp7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlICJmaW5kIjogew0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCBvYmogPSB0aGlzOw0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQogICAgICAgIGlmKCFvYmopew0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICctMSc6IGA8JT1uTmFtZShjKSU+LjwlPW1OYW1lJT46IG9iaiBpcyB1bmRlZmluZWRgDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfWVsc2UgaWYoIW9ialttZXRob2RdKXsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAnLTInOiBgPCU9bk5hbWUoYyklPi48JT1tTmFtZSU+OiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLA0KICAgICAgICAgICAgICAgICAgICAnb2JqJzogb2JqDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICByZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOw0KICAgICAgICB9DQogICAgICAgIA0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09IlNxbERCIil7ICU+DQogICAgICAgICAgICBpZihmYWxzZSAmJiA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsDQogICAgICAgICAgICAgICAgICAgICAgICAnb2JqJzogb2JqDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgPCUgfSU+DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICBpZihyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbil7DQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSB7fTsNCiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSl7DQogICAgICAgICAgICAgICAgbGV0IF9yZXQgPSBbXTsNCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQoY29uc3QgciBvZiByZXQpew0KICAgICAgICAgICAgICAgICAgICBpZihyICYmIHIuX3RvRG9jdW1lbnQpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT4pIGRlbGV0ZSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPi5fdG9Eb2N1bWVudDsNCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXQucHVzaChhd2FpdCByLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBfcmV0LnB1c2gocik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldCA9IF9yZXQ7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCk/YXdhaXQgcmV0Ll90b0RvY3VtZW50KCk6cmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+J3JldCcsIHJldCk7DQogICAgICAgIDwlPWxvZygpJT5gJHttZXRob2R9OiAke3RoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMpJT4uJyArIG1ldGhvZCl9YCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICA8JT1tTmFtZT0nX3BhcnNlQ29kZVN0YXRlJyU+KHQpew0KICAgIDwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICBsZXQgc3RhdGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LnN0YXRlJywgbnVsbCwge3Rvb2w6IHR9KSk7DQogICAgICAgIGxldCBjb2RlID0gdGhpcy5fX2NvbmZpZyh0aGlzLl9fY29uZmlnKCdvYXV0aC5yZWRpcmVjdC5jb2RlJywgbnVsbCwge3Rvb2w6IHR9KSk7DQogICAgICAgIGlmKCFzdGF0ZSB8fCAhY29kZSkgcmV0dXJuOw0KICAgICAgICBzdGF0ZSA9IEpTT04ucGFyc2UodGhpcy5fYXRvYihzdGF0ZSkpOw0KICAgICAgICBpZihzdGF0ZS50b29sIT09dC5uYW1lKSByZXR1cm47DQoNCiAgICAgICAgPCU9bG9nKCklPiJHT1QgQ09ERSAiICsgY29kZSArICIgZm9yIG5vZGUgIiArIHN0YXRlLm5jb2RlICsgIiB3aXRoIHRvb2wgIiArIHN0YXRlLnRvb2wpOw0KICAgICAgICBpZighPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkgfHwgITwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnQuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpKXsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nbmV3IHBhcmVudCcsIHN0YXRlLm5jb2RlKTsNCiAgICAgICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuY29kZShzdGF0ZS5uY29kZSkpOw0KICAgICAgICB9DQogICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlLmF1dGhDb2RlKGNvZGUsIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVG9vbCcsIHRydWUpJT4oKS5uYW1lKHN0YXRlLnRvb2wpKTsNCiAgICAgICAgd2luZG93LmNsb3NlKCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPih0KTsNCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfbG9hZFRvb2xzJyU+KGJTdG9yZSl7DQogICAgICAgIGlmKDwlPXNjb3BlJT4uVG9vbHMgJiYgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPmBUb29scyBhbHJlYWR5IGxvYWRlZGApOw0KICAgICAgICAgICAgcmV0dXJuIDwlPXNjb3BlJT4uVG9vbHM7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5gTG9hZGluZyB0b29scy4uLmApOw0KICAgICAgICANCiAgICAgICAgbGV0IHRvb2xzID0gW107DQogICAgICAgIHRvb2xzID0gPCU9c2NvcGUlPi5fX1Rvb2xzIHx8IHRvb2xzOw0KICAgICAgICBkZWxldGUgPCU9c2NvcGUlPi5fX1Rvb2xzOw0KDQogICAgICAgIGxldCBhclRvb2xzID0gPCU9X0ZyRU1ELl90b0pTKFsuLi5uZXcgU2V0KGFyQ2xhc3Nlcy5tYXAoX2MgPT4gX2MuVG9vbHMpLmZsYXQoKSldKSU+Ow0KICAgICAgICBsZXQgdG9vbE5hbWVzID0gYXJUb29scy5tYXAodCA9PiB0Lm5hbWUgfHwgKHQudHlwZT90LnR5cGUubmFtZTp0KSk7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHRvb2xzLmxlbmd0aCE9PXRvb2xOYW1lcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIC8vIGNhbm5vdCB1c2UgcmVxdWlyZSB5ZXQsIG5vIHRvb2xzIHByb3Blcmx5IGxvYWRlZCB0byB1c2UgYSBsb2FkZXIgZnVuY3Rpb24NCiAgICAgICAgICAgICAgICB0b29scyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7TmFtZTogJ0FQSVNFUlZFUjwlPW1OYW1lJT4nLCBBY3RpdmU6IHRydWUsIEVuYWJsZWQ6IHRydWV9KSB8fCB0b29sczsNCiAgICAgICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgICAgICBpZighdG9vbHMubGVuZ3RoKSB0b29scyA9IChhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuVEhJUyh0b29sTmFtZXMubWFwKHQgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUodCkpKS5maW5kQWxsKDIpKS5tYXAodCA9PiB0Ll90b0pTT04oe3BhcnNlOiAxfSkpIHx8IHRvb2xzOw0KPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IGZpeFRvb2xzID0gdG9vbHMgPT4gew0KICAgICAgICAgICAgdG9vbHMuZmlsdGVyKHQgPT4gdHlwZW9mKHQpPT09J29iamVjdCcgJiYgdCkuZm9yRWFjaCh0ID0+IHsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5uYW1lJywgJ3QudHlwZS5uYW1lJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuYWN0aXZlJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLmVuYWJsZWQnLCB0cnVlKSU+DQoNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudG9vbF9Db25maWdzJywgJ1tdJyklPjsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS50eXBlX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX01hcHBpbmdzJywgJ1tdJyklPjsNCiAgICANCiAgICAgICAgICAgICAgICBbXS5jb25jYXQodC50b29sX0NvbmZpZ3MsIHQudHlwZS50eXBlX0NvbmZpZ3MsIHQudHlwZS50eXBlX01hcHBpbmdzLCB0LnRvb2xfTWFwcGluZ3MpLmZvckVhY2goYyA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5lbmFibGVkJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgICAgICA8JV9kZWYoJ2MuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gWyd0b29sX0NvbmZpZ3MnLCAndHlwZS50eXBlX0NvbmZpZ3MnXS5mb3JFYWNoKHNDb25maWcgPT4gew0KICAgICAgICAgICAgICAgICAgICBEb3RPYmplY3Quc2V0KHNDb25maWcsIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSE9PSJvYmplY3QiKS5jb25jYXQoRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpPT09Im9iamVjdCIgJiYgYy52YWx1ZSkubWFwKGMgPT4gT2JqZWN0LmtleXMoYy52YWx1ZSkubWFwKG5jb2RlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfYyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBjLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGMudmFsdWVbbmNvZGVdLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5jb2RlIT0iZGVmYXVsdCIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jLm5vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IG5jb2RlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLCA8JS8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMlPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiTm9kZUpTIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2M7DQogICAgICAgICAgICAgICAgICAgIH0pLmZsYXQoKSkuZmxhdCgpKSwgdCk7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZvckVhY2goYyA9PiBjLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoYy52YWx1ZSkpOw0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICApOw0KICAgICAgICB9Ow0KDQoNCiAgICAgICAgZml4VG9vbHModG9vbHMpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHQuYWN0aXZlKTsNCiAgICAgICAgdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiB0b29sTmFtZXMuZmluZChfdCA9PiAodHlwZW9mKF90KT09PSdzdHJpbmcnP190Ol90Lm5hbWUpPT10Lm5hbWUpKTsNCg0KICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFyZSAke3Rvb2xzLmxlbmd0aH1gKTsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzID0gdG9vbHM7DQoNCiAgICAgICAgPCU9c2NvcGUlPi5Ub29scy5maWx0ZXIodCA9PiAhdC5heGlvcyAmJiA8JT1KU09OLnN0cmluZ2lmeShfcmVzdFRvb2xzKSU+LmluZGV4T2YodC50eXBlLm5hbWUpPj0wKS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgdC5heGlvcyA9IHR5cGVvZihheGlvcy5jcmVhdGUpPT09J2Z1bmN0aW9uJz9heGlvcy5jcmVhdGUoKTpheGlvczsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKHJlcXVlc3QgPT4gdGhpcy5fcmVxdWVzdEludGVyY2VwdG9yKHJlcXVlc3QsIHQpLCBlcnJvciA9PiB7fSk7DQogICAgICAgICAgICB0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gcmVzcG9uc2UsIGVycm9yID0+IHRoaXMuX3Jlc3BvbnNlSW50ZXJjZXB0b3IoZXJyb3IsIHQpKTsNCiAgICAgICAgfSk7DQogICAgICAgIA0KICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBsb2FkZWQgdG9vbHMhISENCiAgICAgICAgbGV0IHRvb2wgPSB0aGlzLlRvb2w7DQogICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+LlRvb2xzKXsNCjwlIHNyLmdyb3VwQnkoYXJDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykuZm9yRWFjaChlbSA9PiB7ZW0udmFsdWVzID0gZW0udmFsdWVzLnNvcnQoKGEsIGIpID0+IGIuUmFuayAtIGEuUmFuayk7ICU+DQogICAgICAgICAgICBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZW0udmFsdWVzWzBdLCB0cnVlKSU+KHVuZGVmaW5lZCwgdCkuX3N0b3JlRW50aXR5Q2xhc3MoPCU9ZW0udmFsdWVzWzBdLlJhbmslPik7DQo8JSB9KSU+DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5Ub29sID0gdG9vbDsNCiAgICAgICAgDQogICAgICAgIGFyVG9vbHMgPSBhclRvb2xzLmZpbHRlcihfdCA9PiAhdG9vbHMuZmluZCh0ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KICAgICAgICBmaXhUb29scyhhclRvb2xzKTsNCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgIDwlPXNjb3BlJT4ub1Rvb2xzID0gPCU9c2NvcGUlPi5Ub29scy5jb25jYXQoYXJUb29scykuZmlsdGVyKHQgPT4gdC5hY3RpdmUpLm1hcCh0ID0+IHsNCiAgICAgICAgICAgIHQudG9vbF9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udG9vbCk7DQogICAgICAgICAgICB0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udHlwZSk7DQogICAgDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodCk7DQogICAgICAgIH0pOw0KICAgICAgICBpZihiU3RvcmUpew0KICAgICAgICAgICAgPCU9bG9nKCklPmBTYXZpbmcgdG9vbHMuLi5gKTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+Lm9Ub29scyl7DQogICAgICAgICAgICAgICAgYXdhaXQgdC5zdG9yZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgICAgICA8JT1sb2coKSU+YEV4aXRpbmdgKTsNCiAgICAgICAgcmV0dXJuIHRvb2xzOw0KICAgIH0NCiAgICANCjwlIH0gLy8gbWFpbkNsYXNzICU+DQoNCgk8JT1tTmFtZT0nX3BhcmFtZXRyaXplJyU+KHN0ciwgZnVuLCBvcHRpb25zPXt9LCBwcmVmaXg9J3t7JywgcG9zdGZpeD0nfX0nKSB7DQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKHN0cikhPT0nc3RyaW5nJykgcmV0dXJuIHN0cjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJleCA9IGAke3ByZWZpeH0oW14ke3Bvc3RmaXh9XSspJHtwb3N0Zml4fWA7DQogICAgICAgICAgICAoc3RyLm1hdGNoKG5ldyBSZWdFeHAocmV4LCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHN0ciA9IHN0ci5yZXBsYWNlKG0sIG0gPT4gZnVuKG0ucmVwbGFjZShwcmVmaXgsICcnKS5yZXBsYWNlKHBvc3RmaXgsICcnKSkpKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHN0cjsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPihzdHIsIGZ1biwgb3B0aW9ucywgcHJlZml4LCBwb3N0Zml4KTsNCjwlIH0lPg0KCX0NCg0KICAgIDwlPW1OYW1lPSdfX3N5bmNfb24nJT4oZCl7DQogICAgICAgIHRoaXMuXzwlPW1OYW1lJT4gPSB0aGlzLl88JT1tTmFtZSU+IHx8IHt9Ow0KICAgIA0KICAgICAgICBpZihkKXsgLy8gc2V0IHRoZSB2YWx1ZQ0KICAgICAgICAgICAgdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV0gPSBkOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydCh0aGlzLCB7DQogICAgICAgICAgICAgICAgQ3ljbGljOiB0cnVlLA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gdGhpcy48JT1uTmFtZShlYSklPigpP3RoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOnVuZGVmaW5lZCwNCjwlIH0pJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgLy88JT10YU5hbWUlPjogdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpLA0KPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBkKTsNCg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiB0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOw0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIC8vIHRoaXMuPCU9dGFOYW1lJT4oKS5mb3JFYWNoKHQgPT4gdC48JT1tTmFtZSU+KGQpKTsNCjwlIH0pJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHRoaXMuXzwlPW1OYW1lJT5bdGhpcy5Ub29sLm5hbWVdOyAvLyBnZXQgdGhlIHZhbHVlDQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfY2xvbmUnJT4oYlR5cGVBdHRyaWJ1dGVzKXsNCiAgICAgICAgPCU9d2FybigpJT4iREVQUkVDQVRFRDogdXNlIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLk5hbWUsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHRoaXMuX3RvSlNPTigpKSIpOw0KDQogICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLCB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KHY8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKTwlfSU+KSwNCjwlIH0pOyU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBiVHlwZUF0dHJpYnV0ZXM/b2JqLjwlPXRhTmFtZSU+KHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKSkpOm51bGwsDQo8JSB9KTslPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWFwJyU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSl7DQogICAgICAgIF90aGlzID0gX3RoaXMgfHwgdGhpczsNCiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgIHRvb2wgPSB0b29sIHx8IF90aGlzLlRvb2w7DQogICAgICAgIGNvZGVUeXBlID0gY29kZVR5cGUgfHwgPCU9X2VhVHlwZXMoKSU+W2NvZGVdOw0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZSB8fCAiPCU9Yy5FbnRpdHlNb2R1bGU/Yy5FbnRpdHlNb2R1bGUuTmFtZTonJyU+IjsNCg0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgX2xvZyA9IGAke21vZHVsZU5hbWV9LiR7Y2xhc3NOYW1lfS4ke2NvbnRleHR9JHtiUmV2ZXJzZT8nPD0nOic9Pid9JHtjb2RlfWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoQXJyYXkuaXNBcnJheShvYmpGcm9tKSkgcmV0dXJuIG9iakZyb20ubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSkpOw0KICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHRlbXB0ZWQgdG8gdXNlIGpzb25hdGEgaW4gUXVlcnkgZmllbGRzLCBkb2VzIG5vdCB3b3JrIGJlY2F1c2UganNvbmF0YS5ldmFsdWF0ZSByZXR1cm4gYSBwcm9taXNlISEhICovJT4NCiAgICAgICAgICAgIGxldCBzRmllbGQgPSBiUmV2ZXJzZT8ndGFyZ2V0Jzonc291cmNlJzsNCiAgICAgICAgICAgIGxldCBzU2NyaXB0ID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHNDb25kID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgbGV0IHNQYXRoID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0RmllbGQgPSBiUmV2ZXJzZT8nc291cmNlJzondGFyZ2V0JzsNCiAgICAgICAgICAgIGxldCB0U2NyaXB0ID0gKGJSZXZlcnNlPydpbic6J291dCcpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHRQYXRoID0gKGJSZXZlcnNlPydpbic6J291dCcpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0Q29uZCA9IChiUmV2ZXJzZT8naW4nOidvdXQnKSsnQ29uZGl0aW9uJzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb3B0aW9ucyA9IHtfY2xhc3M6IGNsYXNzTmFtZSwgX3RoaXM6IF90aGlzLCB0b29sOiB0b29sfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9zY3JpcHQgPSAocywgbSkgPT4gew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVuU2NyaXB0KGAob1Njb3BlLCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpID0+ICR7c31gKSg8JT1zY29wZSU+LCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIHdhcm4obS50ZXN0cy5sb2csIGV4KTsgDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9tYXRjaCA9IChzLCByKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHMpPT09J3VuZGVmaW5lZCcgfHwgcz09PW51bGwgfHwgdHlwZW9mKHMubWF0Y2gpIT09J2Z1bmN0aW9uJykgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSBzLm1hdGNoKG5ldyBSZWdFeHAociwgJ2cnKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHM9PXIgfHwgKChhbnN3ZXIgJiYgYW5zd2VyLmxlbmd0aCk/dHJ1ZTpmYWxzZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGNvbnN0IGNsb25lID0gaXRlbXMgPT4gaXRlbXMubWFwKGl0ZW0gPT4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGNsb25lKGl0ZW0pIDogaXRlbSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtcyA9IGNsb25lKCBbLi4uKHRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKV0gKTsgLy8gZG8gbm90IHRhbXBlciB3aXRoIHRoZSBtYXBwaW5ncywgZGVlcCBjbG9uZQ0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IE9iamVjdC5rZXlzKG0pLmZvckVhY2goayA9PiBtW2tdID0gdGhpcy5fcGFyYW1ldHJpemUobVtrXSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKSkpOw0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IG0udGVzdHMgPSB7DQogICAgICAgICAgICAgICAgYWN0aXZlOiA8JXZhbHVlT2YoIm0uYWN0aXZlIiklPiwgLy9fc2NyaXB0KG0uYWN0aXZlLCBtKSwNCiAgICAgICAgICAgICAgICBlbmFibGVkOiA8JXZhbHVlT2YoIm0uZW5hYmxlZCIpJT4sIC8vX3NjcmlwdChtLmVuYWJsZWQsIG0pLA0KICAgICAgICAgICAgICAgIGNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLA0KICAgICAgICAgICAgICAgIGNsYXNzOiBfbWF0Y2goY2xhc3NOYW1lLCBtLmNsYXNzTmFtZSksDQogICAgICAgICAgICAgICAgbW9kdWxlOiBfbWF0Y2gobW9kdWxlTmFtZSwgbS5tb2R1bGVOYW1lKSwNCiAgICAgICAgICAgICAgICBzRmllbGQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pLA0KICAgICAgICAgICAgICAgIHNTY3JpcHQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IHR5cGVvZihtW3NTY3JpcHRdKSE9PSd1bmRlZmluZWQnLA0KICAgICAgICAgICAgICAgIHNQYXRoOiB0eXBlb2YobVtzUGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGFyZ2V0OiB0eXBlb2YobVt0RmllbGRdIHx8IG1bdFNjcmlwdF0gfHwgbVt0UGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGV4dDogYCR7Y29kZX06JHtzRmllbGR9PT0+JHt0RmllbGR9YCwNCiAgICAgICAgICAgICAgICBsb2c6IGAke19sb2d9WyR7bS5jb250ZXh0fS8ke20uY2xhc3NOYW1lfV1gLA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBtcyA9IG1zLmZpbHRlcihtID0+IG0udGVzdHMuYWN0aXZlICYmIG0udGVzdHMuZW5hYmxlZCAmJiBtLnRlc3RzLmNvbnRleHQgJiYgbS50ZXN0cy5jbGFzcyAmJiBtLnRlc3RzLm1vZHVsZSAmJiAobS50ZXN0cy5zRmllbGQgfHwgbS50ZXN0cy5zU2NyaXB0IHx8IG0udGVzdHMuc1BhdGgpICYmIG0udGVzdHMudGFyZ2V0KS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHdlIG1pZ2h0IG5vdCB3b3JrIHdpdGggYWxsIG1zIGVudHJpZXMuIGxvZyBoZXJlIGlzIG9ubHkgYSBwcmV2aWV3IG9mIHdoYXQgbWlnaHQgd29yayEgKi8gJT4NCiAgICAgICAgICAgIC8vaWYobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZykubGVuZ3RoKSBsb2codGhpcy5fYmVhdXRpZnkobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZyksICdqYXZhc2NyaXB0JykpOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gew0KICAgICAgICAgICAgICAgIGlmKG1bdFNjcmlwdF0pew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0Q29uZF0pPT09J3VuZGVmaW5lZCcgfHwgPCV2YWx1ZU9mKCJtW3RDb25kXSIsICdfdGhpcycpJT4pew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZykgbG9nKG0udGVzdHMubG9nICsgJzogJyArIHRTY3JpcHQsICc8JT1tTmFtZSU+JywgbVt0U2NyaXB0XSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gPCV2YWx1ZU9mKCJtW3RTY3JpcHRdIiwgJ190aGlzJyklPg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bc1BhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJykgY29kZSA9IGptZXNwYXRoLnNlYXJjaChvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0ganNvbnBhdGgucXVlcnkob2JqRnJvbSwgbVtzUGF0aF0pOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdEZpZWxkXSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBkUGF0aCA9ICcnOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0RmllbGRdKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYCR7Y29kZX0ucmVwbGFjZWA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKG1bc0ZpZWxkXSwgJ2cnKSwgbVt0RmllbGRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29kZSA9IERvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5jb2RlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IG1bdEZpZWxkXTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGBkb3Rjb3B5YDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZyAmJiBkUGF0aCkgbG9nKGAke20udGVzdHMubG9nfS8ke2RQYXRofVtjb2RlPSR7Y29kZX1dOiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0Q29uZF0pKSkgb2JqVG9bbVt0RmllbGRdXSA9IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqc29ucGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGpzb25wYXRoLnF1ZXJ5KG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0ganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdFBhdGhdKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udGVzdHMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoY29kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0dXJuIG9ialRvOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL2lmKGNvbnRleHQ9PSdFbnRpdHlDbGFzcycgJiYgY2xhc3NOYW1lPT0nVXNlcicpIDwlPXdhcm4oKSU+IkdPVCBIRVJFIiwgY29kZSwgY29udGV4dCwgb3B0aW9ucyk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyYW1ldHJpemUoY29kZSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfbkNvZGUnJT4oY29kZSwgb0NvZGUpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOw0KICAgICAgICAgICAgaWYoIWNvZGUgJiYgIW9Db2RlKXsNCiAgICAgICAgICAgICAgICBjb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsNCiAgICAgICAgICAgICAgICBjb2RlID0gIjwlPW5Db2RlKGMpJT4iOw0KICAgICAgICAgICAgICAgIG9Db2RlID0gPCU9X0ZyRU1ELl90b0pTKGMuQ29kZSklPjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgbGV0IHJldCA9IGNvZGU7DQogICAgICAgICAgICBpZihvQ29kZSAmJiB0eXBlb2Yob0NvZGUpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCBvQ29kZVt0aGlzLlRvb2wudHlwZS5uYW1lXSB8fCByZXQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tYXAocmV0LCBmYWxzZSwgY29udGV4dCkgfHwgcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5leCk7DQogICAgICAgICAgICByZXR1cm4gY29kZTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX19jb25maWcnJT4obiwgbnVsbFZhbHVlLCBvcHRpb25zKXsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQogICAgICAgIG9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJzwlPW5OYW1lKGMpJT4nOw0KICAgICAgICBvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwgb3B0aW9ucy5fdGhpcy5Ub29sIHx8IHRoaXMuVG9vbDsNCiAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCk9PT0nb2JqZWN0JyAmJiBvcHRpb25zLnRvb2wuY29uc3RydWN0b3IubmFtZT09J1Rvb2wnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sLm5hbWUoKSk7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdzdHJpbmcnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sIHx8IHQudHlwZS5uYW1lPT1vcHRpb25zLnRvb2wpOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4obiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHtfdGhpczogdGhpcywgdG9vbDogdGhpcy5Ub29sLCBfY2xhc3M6ICc8JT1uTmFtZShjKSU+J30sIG9wdGlvbnMgfHwge30pKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpIT09J29iamVjdCcpIDwlPXdhcm4oKSU+b3B0aW9ucy50b29sKTsNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLnRvb2wpIDwlPXdhcm4oKSU+InRvb2wgbm90IGRlZmluZWQiLCBvcHRpb25zLl90aGlzLlRvb2wsIDwlPXNjb3BlJT4uVG9vbHMsIG9wdGlvbnMuX3RoaXMuVG9vbHMpOw0KICAgICAgICAgICAgLy9vcHRpb25zLm5vQ2FjaGUgPSB0cnVlOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+ID0gPCU9c2NvcGUlPi48JT1tTmFtZSU+IHx8IHt9Ow0KDQogICAgICAgICAgICBsZXQgbklEID0gPCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUuY29kZSgpOidkZWZhdWx0JzsNCg0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnNbbl0pIT09J3VuZGVmaW5lZCcpIG51bGxWYWx1ZSA9IG51bGxWYWx1ZSB8fCBvcHRpb25zW25dOw0KICAgICAgICAgICAgbGV0IHJldCA9IG51bGxWYWx1ZTsNCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG51bGw7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy8gdXNlIHNjb3BlIGNhY2hlIChpbXByb3ZlcyBwZXJmb3JtYW5jZT8/PykNCiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlICYmIE9iamVjdC5oYXNPd24oPCU9c2NvcGUlPi48JT1tTmFtZSU+LCBgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gKSkgcmV0dXJuIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gdG9vbF9Db25maWdzLCB0eXBlX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQ0KICAgICAgICAgICAgbGV0IHRjb25mID0gW10uY29uY2F0KG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncyB8fCBbXSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYyAmJiBjLm5hbWU9PW4gJiYgKCFjLm5vZGUgfHwgYy5ub2RlLmNvZGU9PW5JRCkpLnNvcnQoYyA9PiBjLm5vZGU/KGMubm9kZS5jb2RlPT0nZGVmYXVsdCc/MDotMSk6MSk7DQogICAgICAgICAgICBpZih0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgIGlmKHRjb25mWzBdLnNjcmlwdCl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnNjcmlwdDsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBfc2MgPSB0aGlzLl9wYXJhbWV0cml6ZSh0Y29uZlswXS5zY3JpcHQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJfc2MiKSU+Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXQgPSB0Y29uZlswXS52YWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgWzEsMiwzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsNCiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGpleCl7fQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmKG9wdGlvbnMubmV3VmFsdWUpew0KICAgICAgICAgICAgICAgIGxldCB0YyA9IHRjb25mLmxlbmd0aD90Y29uZlswXTp7fTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLm5vZGUpIHRjLm5vZGUgPSB7Y29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKX07DQogICAgICAgICAgICAgICAgdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgICAgIHRjLm5hbWUgPSBuOw0KICAgICAgICAgICAgICAgIGlmKCF0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MpLnB1c2godGMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nDQogICAgICAgICAgICBsZXQgbWNvbmYgPSBvcHRpb25zLl90aGlzLkNvbmZpZz9vcHRpb25zLl90aGlzLkNvbmZpZ1tuXTp1bmRlZmluZWQ7DQogICAgICAgICAgICBtY29uZiA9IHRoaXMuX3BhcmFtZXRyaXplKG1jb25mLCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICBtY29uZiA9IDwldmFsdWVPZigibWNvbmYiKSU+Ow0KICAgICAgICAgICAgaWYodHlwZW9mKG1jb25mKSE9PSJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsNCg0KICAgICAgICAgICAgLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KXsNCiAgICAgICAgICAgICAgICByZXQgPSBEb3RPYmplY3QucGljayhuLCBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKSkgfHwgcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHRoaXMuJF9SRVFVRVNUKSByZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIGNvbmZpZyByZXBsYWNlbWVudA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fcGFyYW1ldHJpemUocmV0LCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUpIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXSA9IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJyZXQiKSU+Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5uLCBudWxsVmFsdWUsIG9wdGlvbnMuX2NsYXNzLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KDQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgIC8qKg0KICAgICAqIFN1bW1hcnkuIDwlPW0uTmFtZSU+Lg0KICAgICAqDQogICAgICogRGVzY3JpcHRpb24uIDwlPW0uUmVtYXJrJT4uDQogICAgICoNCiAgICAgKiBAc2luY2UgICAgICB4LngueA0KICAgICAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuDQogICAgICogQGFjY2VzcyAgICAgcHVibGljDQogICAgICoNCiAgICAgKiBAY2xhc3MNCiAgICAgKiBAYXVnbWVudHMgcGFyZW50DQogICAgICogQG1peGVzICAgIG1peGluDQogICAgICoNCiAgICAgKiBAYWxpYXMgICAgcmVhbE5hbWUNCiAgICAgKiBAbWVtYmVyb2YgbmFtZXNwYWNlDQogICAgICoNCiAgICAgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24NCiAgICAgKiBAbGluayBVUkwNCiAgICAgKiBAZ2xvYmFsDQogICAgICoNCiAgICAgKiBAZmlyZXMgICBldmVudE5hbWUNCiAgICAgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQ0KICAgICAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4NCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4NCiAgICAgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4NCiAgICAgKg0KICAgICAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKg0KICAgICAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKi8NCiAgICA8JSBpZighbS5Jc1N5bmMpeyU+YXN5bmMgPCV9JT48JT1tTmFtZT1uQ29kZShtKSU+KDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuQ29kZShwKSkuam9pbignLCAnKSU+KXsNCg0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAwLCAuLi5tc2cpOw0KICAgIAlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JT1uQ29kZShtKSU+IiwgbnVsbCwgMSwgLi4ubXNnKTsNCiAgICAJbGV0IGVycm9yID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAgICAgDQogICAgDQo8JSBpZighbS5Jc1N5bmMpeyU+DQogICAgPCUgaWYoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbnVsbDsNCiAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSwgdHJ1ZSklPigpOw0KICAgIDwlIH1lbHNlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNCb29sKXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IGZhbHNlOw0KICAgIDwlIH1lbHNlIGlmKG0uSXNBcnJheSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBbXTsNCiAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IG51bGw7DQogICAgPCUgfSAlPg0KICAgIA0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bkNvZGUobSklPiIsIDwlbVJvdXRpbmcoYywgbSklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICANCjwlIH0lPg0KPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRGVmYXVsdCkuZm9yRWFjaChwID0+IHslPg0KICAgICAgICBpZih0eXBlb2YoPCU9bk5hbWUocCklPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT1uTmFtZShwKSU+ID0gPCV2YWx1ZU9mKHAuRGVmYXVsdCklPjsNCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIHZhciBlcnJvcnMgPSB7DQogICAgICAgIDwlICBbXS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuUmVxdWlyZWQpLm1hcChwID0+ICh7DQogICAgICAgICAgICAgICAgQ29kZTogYCR7bk5hbWUocCl9LXJlcXVpcmVkYCwNCiAgICAgICAgICAgICAgICBFcnJvcjogYCR7bk5hbWUocCl9IGlzIGEgcmVxdWlyZWQgUGFyYW1ldGVyYCwNCiAgICAgICAgICAgICAgICBTY3JpcHQ6IGB0eXBlb2YoJHtuTmFtZShwKX0pPT09J3VuZGVmaW5lZCdgLA0KICAgICAgICAgICAgfSkpKS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSkubWFwKHAgPT4gKHsNCiAgICAgICAgICAgICAgICBDb2RlOiBgJHtuTmFtZShwKX1gLA0KICAgICAgICAgICAgICAgIEVycm9yOiBgJHtuTmFtZShwKX0gaXMgbm90IG9mIHR5cGUgJHtuTmFtZShwLkVudGl0eVR5cGUpfWAsDQogICAgICAgICAgICAgICAgU2NyaXB0OiBgKCEke25OYW1lKHApfSAmJiAke3AuUmVxdWlyZWQ/J3RydWUnOidmYWxzZSd9KSB8fCAoJHtuTmFtZShwKX0gJiYgKCR7bk5hbWUocCl9LmNvbnN0cnVjdG9yLm5hbWUhPScke25OYW1lKHAuRW50aXR5VHlwZSl9JyB8fCAke25OYW1lKHApfS5FbnRpdHlDbGFzcy5OYW1lIT0nJHtuTmFtZShwLkVudGl0eVR5cGUpfScpKWAsDQogICAgICAgICAgICB9KSkpLmNvbmNhdChtLlZhbGlkYXRvcnMgfHwgW10pLmZpbHRlcih2ID0+ICF2Lklnbm9yZSkuZm9yRWFjaCh2ID0+IHsgJT4NCiAgICAgICAgICAgICI8JT12LkNvZGUlPiI6ICgoPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IHAuTmFtZSkuam9pbignLCAnKSU+KSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KDQogICAgICAgICAgICAgICAgPCUgaWYodi5TY3JpcHQuaW5kZXhPZigncmV0dXJuICcpPDApeyU+DQogICAgICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSANCiAgICAgICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgICAgICAgICA8JT12LlNjcmlwdCU+DQogICAgICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPiJhbnN3ZXIiLCAiPCU9di5Db2RlJT4iLCBhbnN3ZXIpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5zd2VyOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+InZhbGlkYXRvciIsICI8JT12LkNvZGUlPiIsIGV4KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSg8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lKS5qb2luKCcsICcpJT4pPygnPCU9di5FcnJvciU+JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpOicnLA0KICAgICAgICA8JSB9KSAlPg0KICAgICAgICB9Ow0KICAgICAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsNCiAgICAgICAgaWYoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpew0KICAgICAgICAgICAgT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+e1trXTogZXJyb3JzW2tdfSk7DQogICAgICAgICAgICAgICAgZGVsZXRlIGVycm9yc1trXTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICAgICAgX19leGNlcHRpb246IGVycm9ycywNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bS5TY3JpcHQlPg0KICAgICAgICANCjwlIGlmKCFtLklzU3luYyl7JT4NCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuQ29kZShwKSArICI6ICIgKyBuQ29kZShwKSkuam9pbignLCAnKSU+fSk7DQogICAgICAgIA0KICAgICAgICANCiAgICAgICAgLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzDQogICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOw0KDQogICAgICAgIC8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8NCiAgICAgICAgbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgIGlmKF9fZXgpIHJldHVybiBfX2V4LnJldDsNCg0KICAgICAgICA8JT1tLlJlZHVjZSU+DQoNCiAgICAgICAgPCUgaWYobS5Jc0FycmF5IHx8IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheSl7JT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKHIgPT4gci5yZXQpLmZsYXQoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoP3Jlc3VsdHNbMF0ucmV0Om51bGw7DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfSU+DQo8JSB9JT4NCiAgICB9DQo8JSB9KTslPg0KDQo8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXNwb25zZUludGVyY2VwdG9yJyU+KGVycm9yLCB0KXsNCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KCkuPCU9bU5hbWUlPihlcnJvciwgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOw0KICAgICAgICAgICAgaWYgKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkgJiYgZXJyb3IucmVzcG9uc2UgJiYgZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgJiYgIW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgJiYgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbi5pbmRleE9mKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkpPjApIHsNCiAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAvLyBhd2FpdCAoZ2V0IHRoZSB0b2tlbiBvciByZWZyZXNoIGl0KQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pICsgIiAiICsgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdC5heGlvcyhvcmlnaW5hbFJlcXVlc3QpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3JlcXVlc3RJbnRlcmNlcHRvciclPihjb25maWcsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGNvbmZpZywgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHtoZWFkZXJzOiB7fX07DQogICAgICAgICAgICBjb25maWcubWV0YSA9IGNvbmZpZy5tZXRhIHx8IHt9Ow0KICAgICAgICAgICAgY29uZmlnLm1ldGEuY291bnRlciA9IDQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgcmVmcmVzaFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnJlZnJlc2gudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgYXV0aFR5cGUgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRoX3R5cGUiLCAiQmVhcmVyIiwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbi4iK2NvbmZpZy5tZXRob2QsIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgIGlmKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKTwwKXsNCiAgICAgICAgICAgICAgICBpZighdG9rZW4pew0KICAgICAgICAgICAgICAgICAgICBsZXQgYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoTWV0aG9kID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLm1ldGhvZCcsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZighdG9rZW5VcmkgJiYgIWF1dGhDb2RlICYmICFhdXRoTWV0aG9kICYmIHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFR5cGUgPSAnQmFzaWMnOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9idG9hKHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCjwlaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwlPW5zY29wZSU+Ll9ub2RlICYmICFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0iZ2V0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgb3IgbG9hZCBhIG5ldyBvYXV0aCBzdGF0ZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnN0YXRlIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeSh7dG9vbDogdC5uYW1lLCBuY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpfSkpfSk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBhdXRob3JpemUgYW5kIGdldCB0aGUgYXV0aCBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7YXV0aFVyaX1gKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGF1dGhVcmkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChudWxsLCB0b29sID0+IDwlPW5zY29wZSU+Ll9ub2RlICYmIGNvbmZpZy5tZXRhLmNvdW50ZXItLSAmJiAhKGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKSwgMC4xLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gRG9uZSBMb29waW5nOiAke2F1dGhDb2RlfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWF1dGhDb2RlKSBhdXRoTWV0aG9kPXVuZGVmaW5lZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KPCV9JT4NCg0KICAgICAgICAgICAgICAgICAgICBpZihhdXRoTWV0aG9kKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmbG93ID0gKCFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0ncG9zdCcpPydhdXRob3JpemUnOid0b2tlbic7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIHRva2VuDQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdG9rZW5VcmkgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5VcmkgPSB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LnVyaWAsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHRva2VuVXJpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5tZXRob2RgLCAncG9zdCcsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb250ZW50LVR5cGUiOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmNvbnRlbnRfdHlwZWAsICJ0ZXh0L2pzb24iLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQXV0aG9yaXphdGlvbiI6ICJCYXNpYyAiK3RoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7dG9vbDogdH0pICsgIjoiICsgdGhpcy5fX2NvbmZpZygib2F1dGgucGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmhlYWRlcnNgLCAie30iLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0cmVzID0gYXdhaXQgdC5heGlvcyh0Y29uZmlnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gVG9rZW4gZmV0Y2hlZCAtICR7Zmxvd31gLCB0Y29uZmlnLCB0cmVzLmRhdGEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgWydhY2Nlc3NfdG9rZW4nLCAndG9rZW5fdHlwZScsICdleHBpcmVzX2luJywgJ3JlZnJlc2hfdG9rZW4nXS5mb3JFYWNoKHRhID0+IHRoaXMuX19jb25maWcoYG9hdXRoLiR7dGF9YCwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdHJlcy5kYXRhW3RoaXMuX19jb25maWcoYG9hdXRoLnRva2VuLnJlc3BvbnNlLiR7dGF9YCwgdGEsIHt0b29sOiB0fSldfSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYXV0aFR5cGUgKyAiICIgKyB0b2tlbjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bG9nKCklPmNvbmZpZyk7DQogICAgICAgIHJldHVybiBjb25maWc7DQogICAgPCUgfSU+DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXN0JyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyl7DQogICAgICAgIC8qIHROYW1lIG5vIGxvbmdlciByZXF1aXJlZCEhICovDQogICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge190aGlzOiB0aGlzfTsNCiAgICAgICAgb3B0aW9ucy50TmFtZSA9IG9wdGlvbnMudE5hbWUgfHwgdE5hbWU7DQogICAgICAgIA0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307DQogICAgICAgIG1ldGhvZCA9IG1ldGhvZCB8fCAoZGF0YT8icG9zdCI6ImdldCIpOw0KICAgICAgICANCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KC8qbnVsbCwgdGhpcy5Ub29sKi8pLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmZvcm0pew0KICAgICAgICAgICAgICAgIGxldCBmZCA9IG5ldyBGb3JtRGF0YSgpOw0KICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goayA9PiBmZC5hcHBlbmQoaywgZGF0YVtrXSkpOw0KICAgICAgICAgICAgICAgIGRhdGEgPSBmZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgYHJlc3RhcGkudXJsLiR7bWV0aG9kfWAsIHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgJ3Jlc3RhcGkudXJsJywgKG9wdGlvbnMucGF0aHx8JycpICsgb3B0aW9ucy5maWxlLCBvcHRpb25zKSwgb3B0aW9ucyksDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsDQogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMuJyttZXRob2QsIHRoaXMuX19jb25maWcoJ3Jlc3RhcGkuaGVhZGVycycsIHt9LCBvcHRpb25zKSwgb3B0aW9ucyksIG9wdGlvbnMuaGVhZGVycyB8fCB7fSksDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICB2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1czw0MDAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICA8JT1sb2coKSU+YFtMSVZFOiR7dGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpfV1gLCBjb25maWcsIG9wdGlvbnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzLlRvb2wuYXhpb3MpIT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKGF4aW9zKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gKGF3YWl0ICgodGhpcy5Ub29sLmF4aW9zIHx8IGF4aW9zKSkoY29uZmlnKSkuZGF0YTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgKGF3YWl0IGZldGNoKGNvbmZpZy51cmwsIGNvbmZpZykpLmpzb24oKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iYXhpb3Mgbm90IGRlZmluZWQhLCB1c2luZyBmZXRjaCIsIHJldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9IC8vIG1haW5DbGFzcyhfcmVzdFRvb2xzKSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU1FMVGFibGUnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCBkZXBzOiB7fSwgc3FsOiBgYCwgZmllbGRzOiBgYH0sIHsNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgX19oZWFkZXI6IG9iaiA9PiBvYmouc3FsID0gYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKCR7b2JqLmZpZWxkc30vKjwlPW5OYW1lKGMpJT4qLyk7XG5gLA0KICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e3NxbDogdi5vYmouc3FsICs9IGAvKjwlPW5OYW1lKGMpJT46IHJldXNlZDogJHt2LnJldXNlZH0qL1xuXG5gLCBJZDogdi5vYmouSWR9LA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLmZpZWxkcyArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAsJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIjwlPV9GckVNRC5fYXR0cihlYSklPiIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQuZGVwcyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldC5kZXBzW2tdKT09PSdzdHJpbmcnKS5tYXAoayA9PiByZXQuZGVwc1trXSkuam9pbignXG5cbicpICsgcmV0LnNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tU1FMVGFibGUnJT4odGFibGUsIGZpZWxkcyl7DQogICAgICAgIC8vIHRhYmxlIGlzIGEganNvbiBhcnJheQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9bk5hbWUoZWEpJT4iKSkgfHwgIWZpZWxkcyl7DQogICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHRhYmxlWyI8JT1uQ29kZShlYSklPiJdKTsNCiAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3NxbCclPihzcWwsIF90aGlzKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgIDwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9zcWxUb29scykpJT4oKS48JT1tTmFtZSU+KHNxbCwgX3RoaXMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+c3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoc3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIHNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGlmKChzcWwubWF0Y2goL1woL2cpIHx8IFtdKS5sZW5ndGghPShzcWwubWF0Y2goL1wpL2cpIHx8IFtdKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJpbmNvcnJlY3Qgc3FsIiwgc3FsKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgICAgIGxldCBfb2sgPSAoX3JldCwgX3NxbCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoX3JldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRiID0gdGhpcy5Ub29sLmRiOw0KICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOw0KICAgIA0KICAgICAgICAgICAgICAgIGxldCBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgICAgIHFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKT49MDsNCg0KICAgICAgICAgICAgICAgIGlmKGJRdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIC8vIHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ2FsbCc7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIERNTA0KICAgICAgICAgICAgICAgICAgICBpZihbJ215c3FsJywgJ3Bvc3RncmVzJ10uaW5kZXhPZih0eXBlKT49MCkgZnVuID0gJ3F1ZXJ5JzsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZT09J3NxbGl0ZScpIGZ1biA9ICdydW4nOw0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfb2soMCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICBpZihmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7dHlwZX0uJHtmdW59YCwgc3FsKTsNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChmdW4pIHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0icG9zdGdyZXMiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsKS50aGVuKHJvd3MgPT4gX29rKHJvd3MsIHNxbCkpLmNhdGNoKHJldEV4ID0+IHJlamVjdChyZXRFeCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3Nub3dmbGFrZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRiLmV4ZWN1dGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgc3FsVGV4dDogc3FsLA0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3NxbGl0ZScpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIHRoZSBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGIuZXhlYyhzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgICAgICAgICBfb2socmV0LCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlPT0ncXVlc3RkYicpew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0KG51bGwsIHtxdWVyeTogc3FsfSkudGhlbihyID0+IF9vayhyLCBzcWwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmANCkVSUk9SOg0KJHtleH0NCg0KV2hpbGUgU2VuZGluZyBRdWVyeSANCiR7c3FsfQ0KYCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgcmV0LnJvd3MpIHJldCA9IHJldC5yb3dzOyAgICAgICAgDQogICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSl7JT4NCjwlDQpsZXQgX3RvVHlwZUFUID0gZWEgPT4gew0KICAgIGxldCByZXQgPSB7bmFtZTogbk5hbWUoZWEpLCBkZXNjcmlwdGlvbjogZWEuTmFtZSwgdHlwZTogInNpbmdsZUxpbmVUZXh0In07DQogICAgaWYoZWEuSXNCb29sKXsNCiAgICAgICAgcmV0LnR5cGUgPSAiY2hlY2tib3giOw0KICAgICAgICByZXQub3B0aW9ucyA9IHsNCiAgICAgICAgICAgIGNvbG9yOiAiZ3JlZW5CcmlnaHQiLA0KICAgICAgICAgICAgaWNvbjogImNoZWNrIg0KICAgICAgICB9Ow0KICAgIH0NCiAgICBpZihlYS5Jc0RhdGUpew0KICAgICAgICByZXQudHlwZSA9ICJkYXRlVGltZSI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgZGF0ZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICdpc28nDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICcyNGhvdXInLA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRpbWVab25lOiAndXRjJywNCiAgICAgICAgfTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJldDsNCn07DQolPg0KICAgIDwlPW1OYW1lPSdfdG9BVFRhYmxlJyU+KGxldmVsKXsNCiAgICAgICAgbGV0IHJldCA9IFt7DQogICAgICAgICAgICBuYW1lOiAnPCU9bk5hbWUoYyklPicsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICBmaWVsZHM6IFsNCiAgICAgICAgICAgICAgICB7bmFtZTogdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCBkZXNjcmlwdGlvbjogJ0lEJywgdHlwZTogJ3NpbmdsZUxpbmVUZXh0J30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPjwlPV9GckVNRC5fdG9KUyhfdG9UeXBlQVQoZWEpKSU+LDwlIH0pJT5dLA0KICAgICAgICB9XTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQucHVzaChuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5zcWwpOw0KICAgICAgICByZXR1cm4gcmV0LnNxbDsNCg0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKCh0YWcsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KHQgPT4gdC5uYW1lID09IHRhZy5uYW1lKSA9PSBpbmRleCk7DQogICAgICAgIDwlPWxvZygpJT5yZXQsIGxldmVsKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0FURnVuY3Rpb24nJT4oKXsNCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0uYDsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2Z1bjogIiJ9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSIsDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgKCR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIgYW5kIC8qPCU9dGFOYW1lJT4qLyAiOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJOT1QgRVhJU1RTIjsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke3RoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgIklOIn1gOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIgKCIgKyAodiB8fCBbXSkubWFwKHQgPT4gKHQgJiYgdC48JT1tTmFtZSU+KT90LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIik6KHQgfHwgJ05VTEwnKSkuam9pbignIFVOSU9OIEFMTC8qTTJNKi8gJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2FpcnRhYmxlJyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQWlyVGFibGUnXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydBaXJUYWJsZSddKSklPigpLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0TmFtZSA9IHROYW1lIHx8IDwlPV9uQ29kZSgpJT47DQogICAgICAgICAgICBsZXQgcmV0ID0gKGF3YWl0IGF4aW9zLnJlcXVlc3Qoew0KICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5fX2NvbmZpZygnZW5kcG9pbnRVcmwnKX0ke3ROYW1lfWAsDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2Q/bWV0aG9kOihkYXRhPyJwb3N0IjoiZ2V0IiksDQogICAgICAgICAgICAgICAgcGFyYW1zOiB7DQogICAgICAgICAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogcGFyYW1zLA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXgucmVzcG9uc2UuZGF0YSwgbnVsbCwgNCkpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19maWxlc3lzdGVtJyU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmo9dGhpcyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWxlLCBjb250ZW50LCBpZCwgb2JqKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighZmlsZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIGxldCBwYXRoID0gb2JqLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJz8nLi9kYi8nOidodHRwczovL3t7b3duZXJ9fS5naXRodWIuaW8vJykpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAvLyB3cml0ZQ0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKChwYXRoICsgZmlsZSkucmVwbGFjZSgvKC4qXC8pLiovZywgJyQxJyksIHsgcmVjdXJzaXZlOiB0cnVlIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmMocGF0aCArIGZpbGUsIHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnPy8qdGhpcy5fYnRvYSgqL0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpLyopKi86Y29udGVudCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihmYWxzZSAmJiBmaWxlLmVuZHNXaXRoKCcvJykpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJzaW11bGF0ZWQgZGlyZWN0b3J5IGxpc3RpbmcuLi4uIiwgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IFsiRU1TIFdlYiJdOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyByZWFkDQogICAgICAgICAgICAgICAgICAgIGlmKHBhdGguc3RhcnRzV2l0aCgnaHR0cCcpICYmIHBhdGguaW5kZXhPZignOi8vJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgbnVsbCwgbnVsbCwge3VybDogJ3BhdGgucmVhZCcsIGZpbGUsIHBhdGh9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuZnMuZXhpc3RzU3luYyhwYXRoICsgZmlsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyhwYXRoICsgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD8ocmV0LmRhdGEgfHwgcmV0KTpyZXQ7DQogICAgICAgICAgICA8JT1sb2coKSU+YFske29iai5fX2NvbmZpZygnbGl2ZScsIHRydWUpPycnOidOT1QgJ31MSVZFfCR7dHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCc/J3dyaXRlJzoncmVhZCd9XSR7cGF0aCArIGZpbGV9OiAkeyhyZXQgfHwgJycpLmxlbmd0aH1gKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9WaWV3JyU+KGNvbHVtbnMsIHNQYXRoPSIiKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQoe3RvU3RyaW5nOiBmdW5jdGlvbigpe3JldHVybiBPYmplY3Qua2V5cyh0aGlzKS5maWx0ZXIoayA9PiB0eXBlb2YodGhpc1trXSkhPT0nZnVuY3Rpb24nKS5tYXAoayA9PiAodGhpc1trXSYmdGhpc1trXS50b1N0cmluZyk/dGhpc1trXS50b1N0cmluZygpOnRoaXNba10pLmpvaW4oJywgJyl9fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9IHY/djwlaWYoZWEuRW50aXR5VHlwZSl7JT4uPCU9bU5hbWUlPihudWxsLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk8JX0lPjp2LA0KCTwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCjwlIGlmKG1haW5DbGFzcyhfZmlsZVRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvRmlsZU5hbWUnJT4oc1BhdGg9IiIsIGV4dD0nLmpzb24nKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IGZOYW1lID0gdGhpcy5fX2V4cG9ydChbXSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHVzaCh2P3Y8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oYCR7c1BhdGh9LiR7ZWFDb2RlfWAsIGV4dCk8JX0lPjonbnVsbCcpLA0KCTwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iikuam9pbignX18nKTsNCgkgICAgICAgIA0KCSAgICAgICAgaWYoIXNQYXRoKXsNCiAgICAgICAgICAgICAgICBmTmFtZSA9ICh0aGlzLl9fY29uZmlnKCdzdG9yZS5yb290JywgJzwlPXNjb3BlJT4vJykgKyBgJHsiPCU9YWxpYXMoKSU+Ii5zcGxpdCgnLicpLnNsaWNlKDEpLmpvaW4oJy8nKX0vJHs8JT1fbkNvZGUoKSU+fS8ke2ZOYW1lICsgZXh0fWApLnJlcGxhY2UoL1wvXC8vZywgJy8nKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZOYW1lID0gJ1snICsgZk5hbWUgKyAnXSc7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiBmTmFtZTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21GaWxlTmFtZSclPihmTmFtZSwgc1BhdGg9IiIsIGV4dD0nLmpzb24nKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQoe25hbWU6IGZOYW1lLnJlcGxhY2UoZXh0LCAnJyl9LCB7DQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgICAgICBsZXQgdiA9IG9iai5uYW1lLnNwbGl0KCdfXycpWzBdOw0KICAgICAgICAgICAgICAgICAgICBvYmoubmFtZSA9IG9iai5uYW1lLnNwbGl0KCdfXycpLnNsaWNlKDEpLmpvaW4oJ19fJyk7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5lYUNvZGUsIHYsIG9iai5uYW1lLCBzUGF0aCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4odik7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmVhQ29kZSwgb2JqLm5hbWUuc2xpY2UoMSwgLTEpLCBzUGF0aCk7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5uYW1lPT0nbnVsbCcgfHwgIW9iai5uYW1lKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9iai5uYW1lLnNsaWNlKDEsIC0xKSwgYCR7c1BhdGh9LiR7ZWFDb2RlfWAsIGV4dCkpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmTmFtZSwgc1BhdGgpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2dpdGh1YiclPihmaWxlLCBjb250ZW50LCBpZCwgb2JqPXRoaXMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0dpdEh1YiddKSklPihudWxsLCB0aGlzLlRvb2wpLjwlPW1OYW1lJT4oZmlsZSwgY29udGVudCwgaWQsIG9iaik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIWZpbGUpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2hhMSA9IGFzeW5jIHN0ciA9PiB0eXBlb2YoY3J5cHRvLnN1YnRsZSkhPT0ndW5kZWZpbmVkJz9BcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCdTSEEtMScsIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgnYmxvYiAnICsgbmV3IEJsb2IoW3N0cl0pLnNpemUgKyAnXHgwMCcgKyBzdHIpKSkpLm1hcCh2ID0+IHYudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJykpLmpvaW4oJycpOnN0ci5zdWJzdHJpbmcoMCwgMTApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+ImZpbGUiLCBmaWxlLCBjb250ZW50PydwdXQnOidnZXQnKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBudWxsLCBjb250ZW50P0pTT04uc3RyaW5naWZ5KHsNCiAgICAJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgPCU9bU5hbWUlPigpIiwNCiAgICAJCQlzaGE6IGlkIHx8IGNvbnRlbnRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwNCiAgICAJCQljb250ZW50OiB0aGlzLl9idG9hKHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnP0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpOmNvbnRlbnQpLA0KICAgIAkJfSk6bnVsbCwgY29udGVudD8ncHV0JzpudWxsLCB7DQogICAgCQkgICAgZmlsZTogKGZpbGUgKyAoKGNvbnRlbnQgfHwgZmlsZS5lbmRzV2l0aCgnLycpKT8nJzooJz9yYW5kPScrTWF0aC5yYW5kb20oKSkpKSwNCiAgICAJCX0pOw0KICAgIAkJDQogICAgCQlpZighcmV0KSByZXR1cm4gcmV0Ow0KICAgIAkJDQogICAgCQlyZXQgPSBjb250ZW50P3JldC5jb250ZW50OnJldDsNCg0KICAgICAgICAgICAgbGV0IGlkeEZpbGUgPSAnaW5kZXguaHRtJzsNCiAgICAgICAgICAgIC8vIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAJCWlmKEFycmF5LmlzQXJyYXkocmV0KSl7DQogICAgCQkgICAgLy8gaW4gY2FzZSB3ZSBhcmUgbGlzdGluZyB0aGUgY29udGVudHMgb2YgYSBmb2xkZXIgcmVzb3VyY2UNCiAgICAJCSAgICByZXR1cm4gcmV0LmZpbHRlcihyID0+ICh0eXBlb2Yoci50eXBlKT09PSd1bmRlZmluZWQnIHx8IHIudHlwZT09J2ZpbGUnKSAmJiByLm5hbWUhPWlkeEZpbGUpLm1hcChyID0+ICh7W3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV06IHIuc2hhIHx8IHJbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwgbmFtZTogci5uYW1lLnJlcGxhY2UoJy5qc29uJywgJycpfSkpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgCQlsZXQgX3RoaXMgPSB7fTsNCiAgICAJCWlmKHJldC5zaGEpew0KICAgIAkJICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMgPSByZXQuY29udGVudD9KU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKTp7fTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goX2V4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4ibm90IGEgdmFsaWQgSlNPTiBvYmplY3QiLCBmaWxlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgCQkgIA0KICAgIAkJICAgIF90aGlzW29iai5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSA9IHJldC5zaGE7IC8vPz8NCiAgICAJCX1lbHNlIGlmKHJldFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldKXsNCiAgICAJCSAgICAvLzwlPXdhcm4oKSU+J3NoYTEnLCBmaWxlLCBhd2FpdCBzaGExKEpTT04uc3RyaW5naWZ5KHJldCkpKTsNCiAgICAJCSAgICBfdGhpcyA9IHJldDsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJPCU9bG9nKCklPmZpbGUsIGNvbnRlbnQ/J3B1dCc6J2dldCcsIF90aGlzKTsNCiAgICAJCQ0KICAgICAgICAgICAgbGV0IGZSb290ID0gZmlsZS5zcGxpdCgnLycpLnNsaWNlKDAsIC0xKS5qb2luKCcvJyk7DQogICAgICAgICAgICBpZihmaWxlLmluZGV4T2YoaWR4RmlsZSk+PTApIHJldHVybiByZXQ7DQogICAgICAgICAgICBpZHhGaWxlID0gZlJvb3QgKyAnLycgKyBpZHhGaWxlOw0KICAgIAkJDQogICAgCQlpZigvKiFvYmouX19zeW5jX29uKCkgJiYgKi9jb250ZW50KXsNCiAgICAJCSAgICAvLyBuZXcgY29udGVudCBzdG9yZWQNCiAgICAJCSAgICBsZXQgaWR4UmV0ID0gYXdhaXQgb2JqLjwlPW1OYW1lJT4oaWR4RmlsZSk7DQogICAgCQkgICAgbGV0IGlkeExpc3QgPSBhd2FpdCBvYmouPCU9bU5hbWUlPihmUm9vdCk7DQogICAgCQkgICAgYXdhaXQgb2JqLjwlPW1OYW1lJT4oaWR4RmlsZSwgaWR4TGlzdCwgaWR4UmV0P2lkeFJldC5zaGE6bnVsbCk7DQogICAgCQkgICAgPCU9bG9nKCklPiJmaWxlIGNvbnRlbnQiLCBmaWxlLCBpZHhGaWxlLCByZXQsIGlkeExpc3QpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2FsZXNGb3JjZSddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU0ZRdWVyeSclPihmaWVsZHMsIG9ianMsIGJTdHJpbmcpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7WzwlPV9uQ29kZSgpJT5dOiB7cGFyYW1zOiB7d2hlcmU6IHthbmQ6IFtdLCBvcjogW119fSwgZWRnZXM6IHtub2RlOiB7fX19fSwgew0KICAgICAgICAgICAgLy9PUEVSQVRPUlM6IHRydWUsDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbPCU9X25Db2RlKCklPl0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHtJZDoge2VxOiB2fX0pLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IG9wID0gJ2VxJzsNCiAgICAgICAgICAgICAgICBsZXQgY29uZCA9IHtbZWFDb2RlXToge1tvcF06IA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnE6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcGlOYW1lOiAnSWQnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFs8JT1fbkNvZGUoZWEuRW50aXR5VHlwZSklPl06IHY/di48JT1tTmFtZSU+KClbPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT5dLnBhcmFtcy53aGVyZS5hbmQ6W10sDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgKHY/di50b0lTT1N0cmluZygpOm51bGwpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIHYNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfX07DQogICAgICAgICAgICAgICAgb2JqWzwlPV9uQ29kZSgpJT5dLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICAvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOw0KICAgICAgICANCiAgICAgICAgaWYoYlN0cmluZyl7DQogICAgICAgICAgICByZXQgPSB7cXVlcnk6IHtbPCU9X25Db2RlKCklPiArICdRdWVyeSddOiB7dWlhcGk6IHtxdWVyeTogcmV0fX19fTsNCiAgICAgICAgICAgIHJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2VydmljZU5vdyddKSl7JT4NCiAgICA8JQ0KICAgIGxldCBfaWQgPSBzID0+IC8qcz9zOiovYHRoaXMuX3V1aWQoJHtzfHx1bmRlZmluZWR9KS5yZXBsYWNlKC8tL2csICcnKWA7DQogICAgbGV0IF90aWQgPSBfYyA9PiBfaWQoIiciK3Njb3BlKyIuIisgKF9jIHx8IGMpLk5hbWUgKyAiJyIpOw0KICAgIGxldCBhcHAgPSAoKSA9PiB7JT5hcHBsaWNhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLmNvZGUodGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpKSk8JX07DQogICAgDQogICAgbGV0IGxhYmVsID0gKHQsIG4sIGMsIHApID0+IHtuPXNyLkVuZ2xpc2hOYW1lKG4pOyAlPi48JT10JT5fRmllbGRfTGFiZWxzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0ZpZWxkIExhYmVsJywgdHJ1ZSklPig8JT1faWQoKSU+KS5yZW1hcmsoJzwlPW4lPicpLm5hbWUoJzwlPW4lPicpLmNvZGUoPCU9YyU+KS5sYW5ndWFnZSgnZW4nKS5wbHVyYWwoJzwlPShwIHx8IChuICsgJ3MnKSklPicpLjwlYXBwKCklPl0pPCV9OyU+DQoNCiAgICA8JT1tTmFtZT0nX3RvU05UYWJsZSclPigpew0KICAgICAgICAvL3RoaXMuX2RlZmF1bHRzKCk7DQoNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVGFibGUnLCB0cnVlKSU+KDwlPV90aWQoKSU+KS5jb2RlKDwlPV9uQ29kZSgpJT4pLjwlYXBwKCklPi5uYW1lKCc8JT1jLk5hbWUlPicpLnJlbWFyayhgPCU9Yy5SZW1hcmslPmApLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLCB7DQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai50YWJsZV9Db2x1bW5zKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29sdW1uJywgdHJ1ZSklPig8JT1faWQoIiciK3Njb3BlKyIuIitjLk5hbWUrIicrZWFDb2RlIiklPikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiIpLmNvZGUoZWFDb2RlKS50eXBlKCc8JT1fRnJFTUQuX2F0dHIoZWEpJT4nKS5yZWZlcmVuY2UoPCVpZihlYS5FbnRpdHlUeXBlKXslPih2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4oKTwlfWVsc2V7JT5udWxsPCV9JT4pLyo8JWxhYmVsKCdjb2x1bW4nLCBlYS5OYW1lLCAnZWFDb2RlJywgZWEuUGx1cmFsKSU+Ki8pLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5yZWZlcmVuY2VfQ29sdW1ucyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbHVtbicsIHRydWUpJT4oKS5hY3RpdmUoZmFsc2UpLmVuYWJsZWQodHJ1ZSkuY29kZShlYUNvZGUpLnR5cGUoJ0xpc3QnKS5uYW1lKCI8JT1uTmFtZSh0YSklPiA8JT10YS5FbnRpdHlDbGFzcy5QbHVyYWwlPiIpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpLyo8JWxhYmVsKCdjb2x1bW4nLCB0YS5OYW1lKycgJyt0YS5FbnRpdHlDbGFzcy5QbHVyYWwsICdlYUNvZGUnLCB0YS5FbnRpdHlDbGFzcy5QbHVyYWwpJT4qLyksDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TTkZsb3cnJT4oYkRyYWZ0LCBiSGVhZGVyKXsNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgPCUgbGV0IGJPcmRlciA9IDE7IGxldCBfZmlkID0gX2MgPT4gX2lkKCInIitzY29wZSsiLicgKyAoYkRyYWZ0PydkJzoncycpICsgJ2wiKyAoX2MgfHwgYykuTmFtZSArICInIik7DQogICAgICAgIGxldCBsb2dpYyA9IChuLCB0LCBtYXA9W10pID0+IHslPg0KICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IExvZ2ljJywgdHJ1ZSklPig8JT1faWQoKSU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSgnPCU9biU+JykucmVtYXJrKCc8JT1uJT4nKQ0KICAgICAgICAgICAgICAgIC5ibG9jayhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgQmxvY2snLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoPCU9X2lkKCklPikubmFtZSgnPCU9biU+JykNCiAgICAgICAgICAgICAgICAgICAgLmJsb2NrX0VsZW1lbnRfTWFwcGluZ3MoWzwlIG1hcC5maWx0ZXIobSA9PiBtKS5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgiPCU9biU+IC0gIiArIDwlPW0uY2QlPikuY29kZSg8JT1tLmNkJT4pLnZhbHVlKDwlPW0udiU+KTwlcENvbXBvdW5kKG0udiwgbS50cm4pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlfSklPl0pDQogICAgICAgICAgICAgICAgKS5kZWZpbml0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTG9naWMgRGVmaW5pdGlvbicsIHRydWUpJT4oJzwlPXQlPiA8JT1uJT4nKS5jb2RlKCc8JT10JT4nKS5uYW1lKCc8JT10JT4nKSkuPCVhcHAoKSU+DQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgYWN0aW9uID0gKGFDb2RlLCBwYXJhbXM9e30pID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIEluc3RhbmNlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKHRoaXMuX3V1aWQoKSkuYWN0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIFR5cGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWFDb2RlJT4nKSkub3JkZXIoPCU9Yk9yZGVyKyslPikuPCVhcHAoKSU+DQogICAgICAgICAgICAuYWN0aW9uX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5hY3Rpb25JbnB1dCgNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBY3Rpb24gSW5wdXQnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykNCiAgICAgICAgICAgICAgICApLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoIiIpKSwNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pDQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgc3ViZmxvdyA9IChmbG93LCBwYXJhbXM9e30sIGJOb1dhaXQpID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnN0YW5jZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSh0aGlzLl91dWlkKCkpLnN1YmZsb3coPCU9ZmxvdyU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS48JWFwcCgpJT4NCiAgICAgICAgICAgIDwlIGlmKCFiTm9XYWl0KXslPg0KICAgICAgICAgICAgLmluc3RhbmNlX0Zsb3dfSW5zdGFuY2VfSW5wdXRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5zdGFuY2UgSW5wdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS5uYW1lKCdXYWl0IGZvciBDb21wbGV0aW9uJykudHlwZSgnQm9vbCcpXSkNCiAgICAgICAgICAgIC5pbnN0YW5jZV9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS52YWx1ZSgnMScpDQogICAgICAgICAgICAgICAgICAgIC5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKSkNCiAgICAgICAgICAgIF0pDQogICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgLmluc3RhbmNlX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5mbG93SW5wdXQoDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKQ0KICAgICAgICAgICAgICAgICkubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikpDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKQ0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IHBDb21wb3VuZCA9ICh2LCB0cm4pID0+IHtpZighdHJuKSByZXR1cm47ICU+LmVsZW1lbnRNYXBwaW5nX1BpbGxfQ29tcG91bmRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1BpbGwgQ29tcG91bmQnLCB0cnVlKSU+KHRoaXMuX3V1aWQoKSkuY29kZSgnJykubmFtZSg8JT12JT4pLm9yZGVyKDApLyoucmVtYXJrKHRoaXMuX2J0b2EoYDwlPUpTT04uc3RyaW5naWZ5KFtdKSU+YCkpKi8uPCVhcHAoKSU+DQogICAgICAgICAgICAucGFyZW50X1BpbGxfQ29tcG91bmRzKFsNCiAgICAgICAgICAgIDwlIE9iamVjdC5rZXlzKHRybikuZm9yRWFjaCgodCwgaSkgPT4geyU+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUGlsbCBDb21wb3VuZCcsIHRydWUpJT4odGhpcy5fdXVpZCgpKS5jb2RlKCI8JT10JT4iKS5vcmRlcig8JT1pKzElPikubmFtZSg8JT12JT4pLnJlbWFyayh0aGlzLl9idG9hKGA8JT1KU09OLnN0cmluZ2lmeSh0cm5bdF0pJT5gKSkuPCVhcHAoKSU+LyoudHJhbnNmb3JtKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVHJhbnNmb3JtJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT10JT4nKS50cmFuc2Zvcm1fVHJhbnNmb3JtX0NvbXBvc2l0aW9ucyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUcmFuc2Zvcm0gQ29tcG9zaXRpb24nLCB0cnVlKSU+KCkuY29kZSgnJyldKSkqLywNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pXSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAqIE9PQiBFbmRwb2ludDogaHR0cHM6Ly9kZXYxNjI1NzAuc2VydmljZS1ub3cuY29tL2FwaS9ub3cvcHJvY2Vzc2Zsb3cvZmxvd29iamVjdC9zdGFydC9zdWJmbG93DQogICAgICAgICAgICAgKiBQYXlsb2FkOiB7Im5hbWUiOiJ4Xzc4NjExX3NjaG9vbF9tYW4uVXNlcl9sb29rdXAiLCJpbnB1dHMiOnsianNvbiI6eyJuYW1lIjoidGVzdCIsImdlbmRlciI6eyJjb2RlIjoiTSIsICJPUEVSQVRPUlMiOiB7ImNvZGUiOiAiIT0ifX0sInVzZXJfU3R1ZGVudHMiOlt7Im5hbWUiOiJTVEEiLCJnZW5kZXIiOnsiY29kZSI6Ik0ifX1dfX19DQogICAgICAgICAgICAqLw0KDQogICAgICAgICAgICBsZXQgZmxvdyA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdycsIHRydWUpJT4oPCU9X2ZpZCgpJT4pLm5hbWUoJzwlPWMuTmFtZSU+IExvb2t1cCcpLmNvZGUoPCU9X25Db2RlKCklPiArICdfbG9va3VwJykuPCVhcHAoKSU+LmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpOw0KICAgICAgICAgICAgaWYoYkhlYWRlcikgcmV0dXJuIGZsb3c7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KGZsb3cvKi5fZGVmYXVsdHMoKSovDQogICAgICAgICAgICAgICAgLmZsb3dfRmxvd19TZXR0aW5ncyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFNldHRpbmcnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ0FDVElPTicpXSkNCiAgICAgICAgICAgICAgICAuZmxvd19GbG93X0lucHV0cyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2pzb24nKS5uYW1lKCdKU09OJykudHlwZSgnSlNPTicpPCVsYWJlbCgnaW5wdXQnLCAnSlNPTicsICInanNvbiciKSU+DQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X091dHB1dHMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgT3V0cHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSg8JT1fbkNvZGUoKSU+ICsgJ19saXN0JykubmFtZSgnPCU9bk5hbWUoYyklPiBMaXN0JykudHlwZSgnTGlzdCcpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RhYmxlJywgdHJ1ZSklPigiPCU9bk5hbWUoYyklPiIpLm5hbWUoJzwlPWMuTmFtZSU+JykuY29kZSg8JT1fbkNvZGUoKSU+KS48JWFwcCgpJT4pDQogICAgICAgICAgICAgICAgICAgIDwlbGFiZWwoJ291dHB1dCcsIGMuTmFtZSArICcgTGlzdCcsIF9uQ29kZSgpICsgIisgJ19saXN0JyIpJT4NCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfVmFyaWFibGVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSgnanNvbicpLm5hbWUoJ0pTT04nKS50eXBlKCdKU09OJyk8JWxhYmVsKCd2YXJpYWJsZScsICdKU09OJywgJyJqc29uIicpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2VxdWVyeScpLm5hbWUoJ0VRdWVyeScpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCAnRVF1ZXJ5JywgJyJlcXVlcnkiJyklPiwNCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnU2V0ICcgKyBjLk5hbWUgKyAnIEpTT04nLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidqc29uJyIsIHY6ICIne3tzdWJmbG93Lmpzb259fScifV0pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlIC8vICwgdHJuOiB7cmVwbGFjZV9zdHJpbmc6IHtyZWdleDogIi8vZyIsIHJlcGxhY2Vfc3RyaW5nOiAiIn19JT4NCiAgICAgICAgICAgICAgICBdKS5zZWN1cml0eUNvbnRyb2wobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBDb250cm9sJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCdzeXNfaHViX2Zsb3cnKS5uYW1lKGBzeXNfc2NvcGUuc2NvcGU9JHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9YCkudHlwZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IFR5cGUnLCB0cnVlKSU+KCkuY29kZSgnY2xpZW50X2NhbGxhYmxlX2Zsb3dfb2JqZWN0JykpLm9wZXJhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IE9wZXJhdGlvbicsIHRydWUpJT4oKS5jb2RlKCdleGVjdXRlJykpLjwlYXBwKCklPiksIHsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvL2V4cG9ydGVyOiB2ID0+IHYub2JqID0gdi5yZXVzZWQ/bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93JywgdHJ1ZSklPih2Lm9iai5JZCk6di5vYmosIC8qaW5mb3JtYXRpb24gbG9zcyovDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgTnVsbDogIWJIZWFkZXIsDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmo8JWlmKDAgfHwgKFsnbmFtZScsICdyZW1hcmsnLCAnZGF0ZScsICdvcmRlcicsICdhY3RpdmUnLCAnZW5hYmxlZCddLmluZGV4T2YoZWEuTmFtZSk8MCkpeyU+LmZsb3dfRmxvd19WYXJpYWJsZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoZWFDb2RlKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+JykudHlwZSg8JSBpZihlYS5FbnRpdHlUeXBlKXslPidKU09OJzwlIH1lbHNleyU+JzwlPV9GckVNRC5fYXR0cihlYSklPic8JX0lPik8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUsICJlYUNvZGUiKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJzwlPW5OYW1lKGMpJT4uPCU9ZWEuTmFtZSU+LlNldCcpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+IFNldCcpLnR5cGUoJ0Jvb2wnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSArICcgU2V0JywgImVhQ29kZSArICdfc2V0JyIpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZShlYUNvZGUgKyAnX29wJykubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiBPcGVyYXRvcicpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lICsgJyBPcGVyYXRvcicsICJlYUNvZGUgKyAnX29wJyIpJT4sDQogICAgICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdTZXQgJytlYS5OYW1lLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgWw0KICAgICAgICAgICAgICAgICAgICAgICAgZWEuRW50aXR5VHlwZT9udWxsOntjZDogImVhQ29kZSIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmpzb259fSciLCB0cm46IE9iamVjdC5hc3NpZ24oe30sIHt2YWx1ZV9tYXA6IHtrZXk6ICIke2VhQ29kZX0iLCBkZWZhdWx0OiAiIn19LCBlYS5fSXNEYXRlP3tzdHJpbmdfdG9fZGF0ZToge2RhdGVfZm9ybWF0OiAieXl5eS1NTS1kZFwnVFwnSEg6bW06c3NcJ1pcJyIsIGN1c3RvbV9mb3JtYXQ6ICIifX06e30pfSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfc2V0JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fX0nIiwgdHJuOiB7aXNfbnVsbDoge319fSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfb3AnIiwgdjogIid7e2Zsb3dfdmFyaWFibGUub3BlcmF0b3JzfX0nIiwgdHJuOiB7dmFsdWVfbWFwOiB7a2V5OiAiJHtlYUNvZGV9In19fSwNCiAgICAgICAgICAgICAgICAgICAgXSklPi5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4nKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUpLnJlbWFyayhgcmV0dXJuIGZkX2RhdGEuZmxvd192YXIuanNvbi4ke2VhQ29kZX07YCksPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4gU2V0JykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5yZW1hcmsoYHJldHVybiB0eXBlb2YoZmRfZGF0YS5mbG93X3Zhci5qc29uLiR7ZWFDb2RlfSkhXHUwMDNkXHUwMDNkXHUwMDI3dW5kZWZpbmVkXHUwMDI3O2ApLA0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnU2V0IDwlPWVhLk5hbWUlPiBPcGVyYXRvcicpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSArICdfb3AnKS5yZW1hcmsoYHJldHVybiAoZmRfZGF0YS5mbG93X3Zhci5qc29uLk9QRVJBVE9SUyB8fCB7fSkuJHtlYUNvZGV9O2ApLA0KICAgICAgICAgICAgICAgICAgICBdKSwNCg0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdJZiAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBTZXQnLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nICsgZWFDb2RlICsgJ19zZXR9fT10cnVlJyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+LnBhcmVudF9GbG93X0luc3RhbmNlcyg8JXN1YmZsb3coJ25ldyAnK3Njb3BlKycuJytfY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSkrJygpLicrbU5hbWUrJyhmYWxzZSwgdHJ1ZSknLCB7anNvbjogIid7e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319JyJ9KSU+KTwlfSU+DQogICAgICAgICAgICAgICAgICAgIC5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQWRkICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fV4nK2VhQ29kZSJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0lmICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIE9wZXJhdG9yIGlzIG5vdCBlbXB0eScsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKydfb3B9fSE9JyJ9XSklPi5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCAnK2VhLk5hbWUrJyBPcGVyYXRvciB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX17e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ19vcH19JyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdFbHNlICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIG5vdCBTZXQnLCAnRWxzZScpJT4ucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgPSB0byAnICsgYy5OYW1lICsgJyBFUXVlcnkgZm9yICcrZWEuTmFtZSwgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19PScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPjwlbG9naWMoJ0ZvciBlYWNoICcrYy5OYW1lKycgJytlYS5OYW1lLCAnRm9yIEVhY2gnLCBbe2NkOiAiJ2l0ZW1zJyIsIHY6ICIne3s8PCoqIyRmW2ludGVybmFsX25hbWU9XFwnIitjLk5hbWUrIl9sb29rdXBcXCcgYW5kICRub3QoJGV4aXN0cyhmbG93X0Zsb3dfU25hcHNob3RzKSldLnNuYXBzaG90X0Zsb3dfTG9naWNzLioqLnBhcmVudF9GbG93X0luc3RhbmNlcyMkZmlbJG51bWJlcihvcmRlcik8PSIrYk9yZGVyKyIgYW5kIHN1YmZsb3cuaW50ZXJuYWxfbmFtZT1cXCciK2VhLkVudGl0eVR5cGUuTmFtZSsiX2xvb2t1cFxcJ10udWlfaWQ+Pi4iK2VhLkVudGl0eVR5cGUuTmFtZSsiX2xpc3R9fScifV0pJT4ucGFyZW50X0Zsb3dfTG9naWNzKFs8JX0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fXt7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX0nIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPl0pPCV9JT4sDQogICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgIF0pPCV9JT4NCiAgICAgICAgICAgICAgICAsDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqPCVpZigwIHx8IFsnVXNlcicsICdHZW5kZXInLCAnX1N0dWRlbnQnLCAnX1RlYWNoZXInXS5pbmRleE9mKHRhLkVudGl0eUNsYXNzLk5hbWUpPj0wKXslPi5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiAnK3RhTmFtZSsnIG5vdCBlbXB0eScsICdJZicpJT4ucGFyZW50X0Zsb3dfSW5zdGFuY2VzKDwlc3ViZmxvdygnbmV3ICcrc2NvcGUrJy4nK19jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSkrJygpLicrbU5hbWUrJyhiRHJhZnQsIHRydWUpJywge2pzb246ICIndGVzdCcifSklPildKTwlfSU+LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX2xvb2t1cDogb2JqID0+IG9iai5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiBFUXVlcnkgbm90IGVtcHR5JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX0hPScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgLnBhcmVudF9BY3Rpb25fSW5zdGFuY2VzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlYWN0aW9uKCdsb29rX3VwX3JlY29yZHMnLCB7dGFibGU6ICciPDwkLnN5c19zY29wZS5zY29wZT4+XyIrKCcrX25Db2RlKCkrJykudG9Mb3dlckNhc2UoKSd9KSU+LA0KICAgICAgICAgICAgICAgICAgICBdKS5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oKS5uYW1lKCdTZXQgQ29uZGl0aW9uJykuYWN0aXZlKHRydWUpLmNvZGUoJ2NvbmRpdGlvbnMnKS5yZW1hcmsoYHJldHVybiBmZF9kYXRhLmZsb3dfdmFyLmVxdWVyeTtgKSwNCiAgICAgICAgICAgICAgICAgICAgXSkNCiAgICAgICAgICAgICAgICBdKSwNCiAgICAgICAgICAgICAgICBfc25hcHNob3Q6IG9iaiA9PiBiRHJhZnQ/bnVsbDpvYmouZmxvd19GbG93X1NuYXBzaG90cyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgU25hcHNob3QnLCB0cnVlKSU+KDwlPV9maWQoKSU+KS5zbmFwc2hvdF9GbG93X1BsYW5zKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFBsYW4nLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWMuTmFtZSU+X1BsYW4nKS5uYW1lKCc8JT1jLk5hbWUlPiBQbGFuJykNCiAgICAgICAgICAgICAgICAgICAgXSkuZnJvbUZsb3codGhpcy48JT1tTmFtZSU+KHRydWUpKSksDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGJEcmFmdCwgYkhlYWRlcik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3RvU05TY3JpcHQnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgPCUgaWYoX2NOYW1lKCdBcHBsaWNhdGlvbicpKXslPg0KICAgICAgICAgICAgbGV0IGV4cCA9IG9wdGlvbnMucmF3PyJfdG9KU09OIjoiX3RvRG9jdW1lbnQiOw0KICAgICAgICAgICAgbGV0IHJvbGxiYWNrID0gKG9wdGlvbnMuYXBwICYmIG9wdGlvbnMucm9sbGJhY2spP2F3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUm9sbGJhY2sgQ29udGV4dCcsIHRydWUpJT4oKS5jb2RlKCdsYXN0JylbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBkYiA9IG9wdGlvbnMuZGI/YXdhaXQgb3B0aW9ucy5fdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlRhYmxlKClbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIGxldCBmbG93ID0gb3B0aW9ucy5mbG93P2F3YWl0IG9wdGlvbnMuX3RoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05GbG93KG9wdGlvbnMuZHJhZnQpW2V4cF0oT2JqZWN0LmFzc2lnbih7YkpTT046IHRydWV9LCBvcHRpb25zKSk6IiI7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKG9wdGlvbnMuZ3ppcCl7DQogICAgICAgICAgICAgICAgaWYoZmxvdykgZmxvdyA9IHRoaXMuVXRmOEFycmF5VG9TdHIoYXdhaXQgdGhpcy5fY29tcHJlc3MoZmxvdykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdGVzdCA9IChvcHRpb25zLnRlc3QgJiYgb3B0aW9ucy5mbG93ICYmICFvcHRpb25zLmRyYWZ0KT9gXG4vKmdzLmNhY2hlRmx1c2goKTsgKi9ncy5pbmZvKHNuX2ZkLkZsb3dBUEkuZ2V0UnVubmVyKCkuc3ViZmxvdygnJHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9LlVzZXJfbG9va3VwJykuaW5Gb3JlZ3JvdW5kKCkud2l0aElucHV0cyh7anNvbjoge2NvZGU6InRlc3QiLGRhdGU6JzIwMjQtMDUtMDNUMTg6NDQ6MDMuMTc3WicsZ2VuZGVyOntjb2RlOiJNIiwgT1BFUkFUT1JTOiB7Y29kZTogIiE9In19LHVzZXJfU3R1ZGVudHM6W3tjb2RlOiJTVEEiLGdlbmRlcjp7Y29kZToiTSJ9fV0sIE9QRVJBVE9SUzoge2RhdGU6ICc8J319fSkucnVuKCkuZ2V0T3V0cHV0cygpWyJVc2VyX2xpc3QiXSk7XG5gOicnOw0KICAgICAgICAgICAgbGV0IGFwcCA9IG9wdGlvbnMuYXBwPyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOU2F2ZShvcHRpb25zKSArIGBcbiB2YXIgY29uZmlnID0ge0FwcGxpY2F0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBUYWJsZToge2lkS2V5OiAnbmFtZScsIExvZ1NldDogMH0sIENvbHVtbjoge0xvZ1NldDogMH0sIEVsZW1lbnRfTWFwcGluZzoge0xvZ1NldDogMH0sIEFjdGlvbl9JbnB1dDoge3JlYWRPbmx5OiB0cnVlfSwgQWN0aW9uX1R5cGU6IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICdtYXN0ZXJfc25hcHNob3QnfSwgQWN0aW9uX0luc3RhbmNlOiB7TG9nU2V0OiAwfSwgU2VjdXJpdHlfVHlwZToge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ25hbWUnfSwgU2VjdXJpdHlfT3BlcmF0aW9uOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbmFtZSd9LCBMb2dpY19EZWZpbml0aW9uOiB7cmVhZE9ubHk6IHRydWV9LCBGbG93OiB7TG9nU2V0OiAwfSwgVHJhbnNmb3JtOiB7cmVhZE9ubHk6IHRydWV9LCBUcmFuc2Zvcm1fQ29tcG9zaXRpb246IHtyZWFkT25seTogdHJ1ZX0sIFJvbGxiYWNrX0NvbnRleHQ6IHtyZWFkT25seTogdHJ1ZX19OyBcbmAgKyAob3B0aW9ucy5yb2xsYmFjaz8oInZhciBjaWQgPSBzYXZlUm9sbGJhY2tfQ29udGV4dCgiK3JvbGxiYWNrK2ApOyBpZihjaWQpe3ZhciBydyA9IG5ldyBHbGlkZVJvbGxiYWNrV29ya2VyKCk7IHJ3LnNldFJvbGxiYWNrQ29udGV4dElEKGNpZC5zeXNfaWQpOyBydy5zdGFydCgpO30gXG5gKToiIikrIChvcHRpb25zLmRiPygic2F2ZVRhYmxlKCIrZGIrIik7IFxuIik6IiIpICsgKG9wdGlvbnMuZmxvdz8oInNhdmVGbG93KCIrZmxvdysiKTsgXG4iKToiIikgKyB0ZXN0KToocm9sbGJhY2sgKyBkYiArIGZsb3cpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2NyaXB0ID0gdGhpcy5fYmVhdXRpZnkoYXBwLCAnamF2YXNjcmlwdCcpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5kZXBsb3kpIHJldHVybiBzY3JpcHQ7DQogICAgPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TTlNhdmUnJT4ob3B0aW9ucyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIDwlIHZhciBfZlJlZ0V4cCA9IC9fZntbXn1dK30vZ207ICU+DQogICAgICAgICAgICBsZXQgX2YgPSAodiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gdjsNCiAgICAgICAgICAgICAgICAgICAgLy9pZih2LnN0YXJ0c1dpdGgoImYoIikgJiYgdi5lbmRzV2l0aCgiKSIpKSByZXQgPSAnKCcrdi5zbGljZSgyLC0xKSsnKSc7DQogICAgICAgICAgICAgICAgICAgIGlmKHYuc3RhcnRzV2l0aCgicygiKSAmJiB2LmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gYChmdW5jdGlvbiAob2JqLCAke2VhQ29kZX0pe2Ardi5zbGljZSgyLC0xKStgfSkob2JqLCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYocmV0ICYmIHJldC5tYXRjaCAmJiByZXQubWF0Y2goPCU9X2ZSZWdFeHAlPikpIHJldCA9IGAoZnVuY3Rpb24gKG9iaiwgJHtlYUNvZGV9KXske3JldC5pbmRleE9mKCJyZXR1cm4iKTwwPyJyZXR1cm4gIjoiIn0gJ2ArcmV0LnJlcGxhY2UoPCU9X2ZSZWdFeHAlPiwgbSA9PiBgJyArICR7bS5zbGljZSgzLCAtMSl9ICsgJ2ApK2AnO30pKG9iaiwgJHtlYUNvZGV9KWA7DQogICAgICAgICAgICAgICAgICAgIGlmKHJldCAmJiByZXQubWF0Y2ggJiYgcmV0Lm1hdGNoKC88PFtePj5dKz4+L2dtKSkgcmV0ID0gJyIiJzsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAoZnVuY3Rpb24odil7IHRyeXsgcmV0dXJuICh2ICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKDwlPV9mUmVnRXhwJT4sIGZ1bmN0aW9uKG0pe3JldHVybiBldmFsKG0uc2xpY2UoMywgLTEpKTt9KTp2OyAgfWNhdGNoKGV4KXtncy5pbmZvKCdfZntFeGNlcHRpb259OiAke2VhQ29kZX06ICcgKyBleCk7IHJldHVybiB2O30gfSkoJHtyZXR9IHx8ICR7ZWFDb2RlfSlgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gZWFDb2RlOw0KICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiAiPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPiIsIHZhcnM6IGBgLCBjb2RlOiBgYCwgcXVlcnk6IGBgLCBzZXQ6IGBgLCBlc2V0OiBgYCwgZHNldDogYGAsIHRhczogYGAsIGRlcHM6IHt9fSwgew0KICAgICAgICAgICAgICAgIGV4cG9ydGVyOiB2ID0+IHYub2JqID0gKHR5cGVvZihvcHRpb25zLnJldXNlZCk9PT0ndW5kZWZpbmVkJyB8fCBvcHRpb25zLnJldXNlZD49di5yZXVzZWQpP3Yub2JqOntjb2RlOiB2Lm9iai5jb2RlICsgYFxuXG4vKiogcmV1c2VkOiB2Lm9iai5JZCoqL1xuXG5gLCBkZXBzOiAnJywgSWQ6IHYub2JqLklkfSwNCg0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai5JZCA9IGBpZihvYmouJHtpZENvZGV9ICYmIG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykubGVuZ3RoPT0zMil7X3RvU3RyaW5nKz0nXycrb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKTsgZ3IuZ2V0KCdzeXNfaWQnLCBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpKTt9XG5gOw0KICAgICAgICAgICAgICAgICAgICBvYmouaWRUb1N0cmluZyA9IGBfdG9TdHJpbmcgKz0gKG9iaj9vYmouJHtpZENvZGV9OignZ3JfJytnci5zeXNfaWQpKSArICc6ICc7IGA7DQogICAgICAgICAgICAgICAgICAgIG9iai5uZXdVVUlEID0gYGlmKCFvYmouJHtpZENvZGV9IHx8IG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykubGVuZ3RoIT0zMil7b2JqLiR7aWRDb2RlfSA9IGdyLnNldE5ld0d1aWQoKTt9ZWxzZXtnci5zZXROZXdHdWlkVmFsdWUob2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKSk7fX1cbmA7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlIT1jKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouZGVwcy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKSU+ID0gKHYgfHwgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKSkuPCU9bU5hbWUlPihvcHRpb25zKTsNCiAgICAgICAgPCUgfSU+DQoNCiAgICAgICAgICAgICAgICAgICAgb2JqLnZhcnMgKz0gYHZhciAke2VhQ29kZX0gPSA8JWlmKGVhLkVudGl0eVR5cGUpeyU+KCgocmVmcy48JT1uTmFtZShlYSklPiA9ICh0eXBlb2Yob2JqLiR7ZWFDb2RlfSkhPT0ndW5kZWZpbmVkJz8vKnRoaXMuKi9zYXZlPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPihvYmouJHtlYUNvZGV9LCB7PCU9bk5hbWUoYyklPjogb2JqLCA8JT1uTmFtZShjLyplYSovKSU+UmVmczogcmVmcywgPCU9bk5hbWUoYykudG9Mb3dlckNhc2UoKSU+OiBncn0sICI8JT1uTmFtZShjKSU+IiwgcmVmcy48JT1uTmFtZShlYSklPiB8fCAvKkVYUDogcmVmcy48JT1uTmFtZShlYS5FbnRpdHlUeXBlKS50b0xvd2VyQ2FzZSgpJT4gfHwgKi8oJHtfZig8JXZhbHVlT2YoZWEuRGVmYXVsdCklPiwgZWFDb2RlKX0pKTpyZWZzLjwlPW5OYW1lKGVhKSU+KSkgfHwge3N5c19pZDogJyd9KVsvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPi5pZEtleSB8fCAic3lzX2lkIl0pLnRvU3RyaW5nKCk8JX1lbHNleyU+b2JqLiR7ZWFDb2RlfTwlfSU+O2A7DQogICAgICAgIDwlIGlmKGVhLklzVW5pcXVlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucXVlcnkgKz0gYF90b1N0cmluZys9J18nKyR7ZWFDb2RlfTsgX3RvUXVlcnkuJHtlYUNvZGV9ID0gJHtfZih2LCBlYUNvZGUpfTsgYDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIG9iai5zZXQgKz0gYGlmKHR5cGVvZihfdG9TZXQuJHtlYUNvZGV9ID0gJHtfZih2LCBlYUNvZGUpfSkhPT0ndW5kZWZpbmVkJzwlaWYoZWEuRW50aXR5VHlwZSl7JT4mJiBfdG9TZXQuJHtlYUNvZGV9PCV9JT4pIGdyLnNldFZhbHVlKCcke2VhQ29kZX0nLCBfdG9TZXQuJHtlYUNvZGV9KTtgOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICAgICAgZWZfPCU9bk5hbWUoZWYpJT46IChvYmosIGVmQ29kZSwgdikgPT4gb2JqLmVzZXQgKz0gYGlmKHR5cGVvZihfdG9TZXQuJHtlZkNvZGV9ID0gJHtfZihKU09OLnN0cmluZ2lmeSh2KSwgJ29iai4nK2VmQ29kZSl9KSE9PSd1bmRlZmluZWQnKSBnci5zZXRWYWx1ZSgnJHtlZkNvZGV9JywgX3RvU2V0LiR7ZWZDb2RlfSk7YCwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmoudGFzICs9IGByZWZzLjwlPXRhTmFtZSU+ID0gKChvYmo/b2JqLiR7ZWFDb2RlfTpbXSkgfHwgW10pLm1hcChmdW5jdGlvbihvKXtncy5pbmZvKF90b1N0cmluZyArICcgPT4gc2F2ZTwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+KCR7ZWFDb2RlfVtdKScpOyByZXR1cm4gLyp0aGlzLiovc2F2ZTwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+KG8sIHs8JT1uTmFtZShjKSU+OiBvYmosIDwlPW5OYW1lKGMpLnRvTG93ZXJDYXNlKCklPjogZ3IsIG1hbnlSZWZzOiByZWZzfSwgIjwlPW5OYW1lKGMpJT4iKTt9KTtgDQogICAgICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzKSU+ID0gKHYgJiYgdi5sZW5ndGgpP3ZbMF06bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFyZXQuZHNldCkgcmV0LmRzZXQgKz0gYFxuaWYodHlwZW9mKG9iaik9PT0ib2JqZWN0IikgT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoZnVuY3Rpb24oayl7cmV0dXJuICFrLnN0YXJ0c1dpdGgoJ19fJykgJiYgWydzeXNfaWQnLCAnSWQnLCAnT1BFUkFUT1JTJ10uaW5kZXhPZihrKTwwICYmIHR5cGVvZihfdG9TZXRba10pPT09J3VuZGVmaW5lZCcgJiYgIUFycmF5LmlzQXJyYXkob2JqW2tdKTt9KS5mb3JFYWNoKGZ1bmN0aW9uKGspe190b1NldFtrXSA9ICR7X2YoIm9ialtrXSIsICJudWxsIil9OyBpZihfdG9TZXRba10gJiYgX3RvU2V0W2tdLl9fY2xhc3Mpe190b1NldFtrXSA9IF90b1NldFtrXVtjb25maWdbX3RvU2V0W2tdLl9fY2xhc3NdLmlkRmllbGQgfHwgJ0lkJ107IH0gZ3Iuc2V0VmFsdWUoaywgX3RvU2V0W2tdICk7IH0pXG5gOw0KDQogICAgICAgICAgICByZXQuY29kZSArPSBgJHtPYmplY3QudmFsdWVzKHJldC5kZXBzKS5qb2luKCdcbicpfWZ1bmN0aW9uIHNhdmU8JT1uTmFtZShjKSU+KG9iaiwgcmVmcywgc291cmNlLCBncil7cmVmcyA9IHJlZnMgfHwge307IC8qdGhpcy4qL2NvbmZpZy5zYXZlXyR7PCU9X25Db2RlKCklPn0gPSBzYXZlPCU9bk5hbWUoYyklPjsgLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4gPSAvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPiB8fCB7fTsgLyp0aGlzLiovY29uZmlnLl9pZE1hcCA9IC8qdGhpcy4qL2NvbmZpZy5faWRNYXAgfHwgW107IHZhciBfdG9TdHJpbmcgPSBzb3VyY2UgKyAnWycgKyAocmVmc1tzb3VyY2VdLnN5c19pZCkgKyAnXT0+IHNhdmU8JT1uTmFtZShjKSU+KCc7IGlmKHR5cGVvZihvYmopPT09J3N0cmluZycgJiYgb2JqLmxlbmd0aD49MzIpe3ZhciByZXQgPSB7fTsgcmV0Wy8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LmlkS2V5IHx8ICJzeXNfaWQiXT1vYmo7IGdzLmluZm8oX3RvU3RyaW5nICsgJyk6IG9iaiBpcyB1dWlkLCByZXR1cm5pbmcgeycrb2JqKyd9Jyk7IHJldHVybiByZXQ7fSBpZighb2JqICYmICFncil7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnKTogb2JqIGlzIG51bGwnKTsgcmV0dXJuIG51bGw7fSAke3JldC5pZFRvU3RyaW5nfSB2YXIgYlNhdmUgPSAhLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4ucmVhZE9ubHk7IGlmKCFncil7IGdyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7XG4ke3JldC5JZH1cbiR7cmV0LnZhcnN9XG5pZighZ3IuaXNWYWxpZFJlY29yZCgpKXtnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpOyB2YXIgX3RvUXVlcnk9e307ICR7cmV0LnF1ZXJ5fSBcbl90b1N0cmluZyArPSAnKTogJzsgaWYob2JqLl9fa2V5cyAmJiAoYlNhdmUgfHwgY29uZmlnLjwlPW5OYW1lKGMpJT4ucmVhZE9ubHkpKXtpZihfdG9RdWVyeS5fX2VuY29kZWRRdWVyeSl7Z3IuYWRkRW5jb2RlZFF1ZXJ5KF90b1F1ZXJ5Ll9fZW5jb2RlZFF1ZXJ5KTt9ZWxzZXtvYmouX19rZXlzLmZvckVhY2goZnVuY3Rpb24oayl7Z3IuYWRkUXVlcnkoaywgX3RvUXVlcnlba10gfHwgb2JqW2tdKTt9KTt9IGdyLnNldExpbWl0KDEpOyBpZighZ3IuZ2V0RW5jb2RlZFF1ZXJ5KCkpIGdyLmFkZFF1ZXJ5KCdzeXNfaWQnLCAnLTEnKTsgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnRW5jb2RlZCBRdWVyeTogJyArIGdyLmdldEVuY29kZWRRdWVyeSgpKTsgZ3IucXVlcnkoKTtpZighZ3IubmV4dCgpKXtncy5pbmZvKF90b1N0cmluZyArICdub3QgZm91bmQnKTt9ZWxzZXtncy5pbmZvKF90b1N0cmluZyArICdmb3VuZCBbJHs8JT1fbkNvZGUoKSU+fS8nICsgZ3Iuc3lzX2lkICsgJ10gLSBpcyB2YWxpZDogJyArIGdyLmlzVmFsaWRSZWNvcmQoKSk7IG9iai5JZCA9IGdyLnN5c19pZC50b1N0cmluZygpOyBpZihvYmouX19yZXVzZWQpey8qZ3MuaW5mbyhfdG9TdHJpbmcgKyAnOiBfX3JldXNlZDogWyR7PCU9X25Db2RlKCklPn0vJyArIGdyLnN5c19pZCArICddIC0gaXMgdmFsaWQ6ICcgKyBnci5pc1ZhbGlkUmVjb3JkKCkpOyAqL3JldHVybiBncjt9IH19fX1lbHNle2JTYXZlPWZhbHNlO30gaWYoYlNhdmUgJiYgIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnaW5zZXJ0aW5nLi4uJyk7IGdyID0gbmV3IEdsaWRlUmVjb3JkKCckezwlPV9uQ29kZSgpJT59Jyk7IGdyLmluaXRpYWxpemUoKTsgJHtyZXQubmV3VVVJRH0gaWYoYlNhdmUgJiYgb2JqKXt2YXIgX3RvU2V0ID0ge307IC8qc2V0Ki8ke3JldC5zZXR9IC8qZXNldCovJHtyZXQuZXNldH0gICR7cmV0LmRzZXR9IGlmKC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+Lk5vV29ya2Zsb3cpIGdyLnNldFdvcmtmbG93KGZhbHNlKTsgaWYoLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4uTG9nU2V0KSBncy5pbmZvKF90b1N0cmluZyArICdfdG9TZXQ6ICcgKyBKU09OLnN0cmluZ2lmeShfdG9TZXQpKTsgfWVsc2UgaWYoIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnW2JTYXZlPScgKyBiU2F2ZSArICddIC0gcmV0dXJuaW5nIG51bGwuJyk7IHJldHVybiBudWxsO31cbmlmKCFiU2F2ZSB8fCBnci51cGRhdGUoKSl7IGlmKGZhbHNlICYmIGJTYXZlKXtjb25maWcuX2lkTWFwLnB1c2goe3RhYmxlOiAnJHs8JT1fbkNvZGUoKSU+fScsIHN5c19pZDogZ3Iuc3lzX2lkLnRvU3RyaW5nKCksIGtleXM6IG9iai5fX2tleXMubWFwKGZ1bmN0aW9uKGspe3JldHVybiB7azogaywgdjogX3RvUXVlcnlba10gfHwgb2JqW2tdfTt9KX0pO30gJHtyZXQudGFzfVxuZ3MuaW5mbyhfdG9TdHJpbmcgKyAnW2JTYXZlPScgKyBiU2F2ZSArICddIC0gcmV0dXJuaW5nICcgKyBnci5zeXNfaWQpOyByZXR1cm4gZ3I7fX1cbmA7DQoNCiAgICAgICAgICAgIC8qcmV0dXJuIE9iamVjdC52YWx1ZXMoT2JqZWN0LmFzc2lnbih7fSwgLi4ucmV0LmNvZGUuc3BsaXQoJ2Z1bmN0aW9uIHNhdmUnKS5maWx0ZXIocyA9PiBzKS5zb3J0KChhLCBiKSA9PiBhLmxlbmd0aCAtIGIubGVuZ3RoKS5tYXAocyA9PiAoe1tzLnNwbGl0KCcob2JqLCByZWZzLCBzb3VyY2UsIGdyKScpWzBdXTogJ2Z1bmN0aW9uIHNhdmUnK3N9KSkpKS5qb2luKCdcbicpOyAqLw0KICAgICAgICAgICAgcmV0dXJuIHJldC5jb2RlOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TTlF1ZXJ5JyU+KGZpZWxkcywgb2JqcywgYlVSTCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBPUEVSQVRPUlM6IHRydWUsDQogICAgICAgICAgICAvL19tYXA6IHRydWUsDQogICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmpbaWRDb2RlXSA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY/di48JT1tTmFtZSU+KCk6bnVsbDsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgIGxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7DQogICAgICAgICAgICAgICAgbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsNCiAgICAgICAgICAgICAgICBpZigodi5nZXRIb3VycygpPT0wICYmIHYuZ2V0TWludXRlcygpPT0wICYmIHYuZ2V0U2Vjb25kcygpPT0wKSB8fCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0nPScgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3Apew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AhPT0nQkVUV0VFTicpew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7JT4NCiAgICAgICAgICAgICAgICBvYmouT1BFUkFUT1JTLjwlPW5OYW1lKGVhKSU+ID0gJz0nOw0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgDQogICAgICAgIE9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pIT09J3VuZGVmaW5lZCcgJiYgdHlwZW9mKHJldFtrXSkhPT0nb2JqZWN0JykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOw0KDQogICAgICAgIGRlbGV0ZSByZXQuT1BFUkFUT1JTOw0KICAgICAgICBPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsNCg0KICAgICAgICByZXQgPSBEb3RPYmplY3QuZG90KHJldCk7DQoNCiAgICAgICAgLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzDQogICAgICAgIE9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCg0KICAgICAgICBpZihiVVJMKSByZXQgPSBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCgk8JT1tTmFtZT0nX19leHBvcnQnJT4ob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7DQoJICAgIHRyeXsNCiAgICAJICAgIGlmKCFvYmopIHJldHVybiB0aGlzOw0KICAgIAkgICAgDQogICAgCSAgICBpZihvcHRpb25zLk9QRVJBVE9SUykgb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307DQogICAgCSAgICANCiAgICAJICAgIDwlIC8qIElNUE9SVEFOVDogdGhpcy5JZD09dGhpcy5JZCBtYWtlcyBzdXJlIHRoZSBJZCBpcyBmaXhlZCBmb3IgdGhlIHRvb2wsIG5vdCBnZXR0aW5nIGdlbmVyYXRlZCBldmVyeSB0aW1lIHdlIGNhbGwgaXQgKi8gJT4NCiAgICAJICAgIA0KICAgIAkgICAgbGV0IGVhQ29kZXMgPSB7DQogICAgCSAgICAgICAgZXhwb3J0ZXI6ICIiLA0KICAgIAkgICAgICAgIElkOiAiIiwNCiAgICAJICAgIH07DQogICAgCSAgICANCiAgICAJCWlmICghb3B0aW9ucy5VbmlxdWUgJiYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpKSB0aGlzLl9fb3B0aW9ucygiSWQiLCBvYmosIGVhQ29kZXMuSWQgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdJZCcpOidJZCcpLCB0aGlzLklkLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KICAgIAkJDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSB8fCAob3B0aW9ucy5VbmlxdWUgJiYgPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlZi5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCJlZl88JT1uTmFtZShlZiklPiIsIG9iaiwgZWFDb2Rlcy5lZl88JT1uTmFtZShlZiklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVmKSU+OjwlX3ZDb2RlKGVmKSU+KSwgPCV2YWx1ZU9mKGVmLlZhbHVlKSU+LCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KPCUgfSklPg0KDQoJCSAgICA8JSB1blJlY3Vyc2UoJ29iaicsICdmdW4nLCAnZkFyZ3MnLCAnaWYodHlwZW9mKG9wdGlvbnMuZXhwb3J0ZXIpPT09ImZ1bmN0aW9uIikgb3B0aW9ucy5leHBvcnRlcih2KScpJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgIWVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCksIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIl9USElTIiwgb2JqLCBlYUNvZGVzLl9USElTID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnX1RISVMnKToiX1RISVMiKSwgdGhpcy5fVEhJUywgdGhpcywgb3B0aW9ucywgZnVuKTsNCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiPCU9dGFOYW1lJT4iLCBvYmosIGVhQ29kZXMuPCU9dGFOYW1lJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZSh0YSwgdHJ1ZSklPjoiPCU9dGFOYW1lJT4iKSwgdGhpcy48JT10YU5hbWUlPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKHRhKSU+Iik7DQo8JSB9KSU+DQoNCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIE9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKT09PSdmdW5jdGlvbicgJiYgIU9iamVjdC5rZXlzKGVhQ29kZXMpLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gdGhpcy5fX29wdGlvbnMoaywgb2JqLCBrLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bikpOw0KICAgICAgICANCiAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dIHx8IHt9Ow0KICAgICAgICAgICAgKDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljIHx8IFtdKS5mb3JFYWNoKG4gPT4gbi5fY1tuLmVhRmllbGRdKG4uX2Nbbi5lYUZpZWxkXSgpLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogdHJ1ZSwgbm9BcmdzOiB0cnVlLCBfbWFwOiBvcHRpb25zLl9tYXB9LCBmdW4pKSk7DQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyA9IFtdOyAvLz8/DQogICAgICAgICAgICANCiAgICAJCXJldHVybiBvYmo7DQogICAgCX1jYXRjaChleCl7DQogICAgCSAgICA8JT1lcnJvcigpJT5leCk7DQogICAgCX0NCgl9DQoJDQoJPCU9bU5hbWU9J19fb3B0aW9ucyclPihmaWVsZCwgb2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcz10aGlzLCBvcHRpb25zPXt9LCBmdW4sIGVhRmllbGQpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGZpZWxkLCBvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzLCBvcHRpb25zLCBmdW4sIGVhRmllbGQpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47DQogICAgICAgICAgICBpZighb2JqKSByZXR1cm47DQogICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9uc1tmaWVsZF0pIT09ImZ1bmN0aW9uIil7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPmAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodHlwZW9mKGVhT2JqKSE9PSd1bmRlZmluZWQnICYmICFvcHRpb25zLk51bGwpew0KICAgICAgICAgICAgICAgIGlmKGZpZWxkIT0nSWQnICYmIHR5cGVvZihfdGhpc1tmaWVsZF0pPT09J2Z1bmN0aW9uJyAmJiAhX3RoaXNbJ18nK2ZpZWxkKydfc2V0J10pIHJldHVybjsNCiAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSE9PSd1bmRlZmluZWQnKSBlYU9iaiA9IGVhT2JqLmZpbHRlcih2ID0+IHYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5OdWxsICYmIEFycmF5LmlzQXJyYXkoZWFPYmopICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsNCg0KICAgICAgICAgICAgbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhQ29kZSwgZWFPYmosIF90aGlzKTsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuT1BFUkFUT1JTICYmIF90aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHtbZmllbGRdOiBfdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddfSk7DQoNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLkN5Y2xpYyAmJiBlYUZpZWxkICYmIG9iaiAmJiBvYmouRW50aXR5Q2xhc3MgJiYgdHlwZW9mKG9ialtmaWVsZF0pPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gfHwge307DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyB8fCBbXTsNCiAgICAgICAgICAgICAgICBsZXQgX2N5Y2xlcyA9IG9ialtmaWVsZF0oKTsNCiAgICAgICAgICAgICAgICBpZighQXJyYXkuaXNBcnJheShfY3ljbGVzKSkgX2N5Y2xlcyA9IFtfY3ljbGVzXTsNCiAgICAgICAgICAgICAgICBfY3ljbGVzID0gX2N5Y2xlcy5maWx0ZXIoX2MgPT4gX2MgJiYgdHlwZW9mKF9jW2VhRmllbGRdKT09PSdmdW5jdGlvbicgJiYgX2NbJ18nICsgZWFGaWVsZCArICdfc2V0J10gJiYgb2JqLl9zYW1lRW50aXR5KF9jW2VhRmllbGRdKCkpKS5tYXAoX2MgPT4gKHsNCiAgICAgICAgICAgICAgICAgICAgLyptYXJrIF9jW2VhRmllbGRdX3NldCB0byBudWxsIGluc3RlYWQqLw0KICAgICAgICAgICAgICAgICAgICBfYywNCiAgICAgICAgICAgICAgICAgICAgZWFGaWVsZCwNCiAgICAgICAgICAgICAgICB9KSk7DQogICAgICAgICAgICAgICAgaWYoX2N5Y2xlcy5sZW5ndGgpIDwlPXdhcm4oKSU+ZnVuICsgIi9fY3ljbGVzIiwgX2N5Y2xlcyk7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMucHVzaCguLi5fY3ljbGVzKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5fbWFwKSBfdGhpcy5fbWFwKGZpZWxkLCB0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcsIGZ1biwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnP29iajplYU9iaiwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnP190aGlzOm9iaiwgZWFDb2RlKTsNCg0KICAgICAgICAgICAgcmV0dXJuIF9yZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5mdW4sIGZpZWxkLCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KCX0NCgkNCgk8JT1tTmFtZT0nX19pbXBvcnQnJT4ob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7DQogICAgICAgIGlmKHR5cGVvZihvYmopIT09J29iamVjdCcpew0KICAgICAgICAgICAgPCU9d2FybigpJT5gJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KCSAgICANCiAgICAgICAgbGV0IGVhQ29kZXMgPSB7fTsNCg0KCQlpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiSWQiLCBvYmosIGVhQ29kZXMuSWQgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdJZCcpOidJZCcpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoJCQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICBpZighb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmIGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICBpZighb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCgkJPCUgdW5SZWN1cnNlKCd0aGlzJywgJ2Z1bicsICdmQXJncycsICdpZih0eXBlb2Yob3B0aW9ucy5pbXBvcnRlcik9PT0iZnVuY3Rpb24iKSBvcHRpb25zLmltcG9ydGVyKHYpJyklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiAhZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpICB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQoJCWlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCJfVEhJUyIsIG9iaiwgZWFDb2Rlcy5fVEhJUyA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ19USElTJyk6J19USElTJyksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4gew0KICAgIGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOw0KJT4NCiAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIjwlPXRhTmFtZSU+Iiwgb2JqLCBlYUNvZGVzLjwlPXRhTmFtZSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUodGEsIHRydWUpJT46IjwlPXRhTmFtZSU+IiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZCh0YSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIE9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKT09PSdmdW5jdGlvbicgJiYgIU9iamVjdC5rZXlzKGVhQ29kZXMpLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gdGhpcy5fX29wdGlvbnMoaywgb2JqLCBrLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bikpOw0KDQoJCXJldHVybiB0aGlzOw0KCX0NCg0KPCUgaWYobWFpbkNsYXNzKFsnTmVvNGonXSkpeyU+DQogICAgPCU9bU5hbWU9J190b0N5VGFibGUnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2NxbDogYA0KQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSBJUyBVTklRVUU7DQpDUkVBVEUgQ09OU1RSQUlOVCBJRiBOT1QgRVhJU1RTIEZPUiAobzokezwlPV9uQ29kZSgpJT59KSBSRVFVSVJFIG8uJHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9IElTIE5PVCBOVUxMOw0KICAgICAgICBgfSwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgb2JqLmNxbCArPSB2P3YuPCU9bU5hbWUlPigpOicnOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1VuaXF1ZSl7JT4NCiAgICAgICAgICAgICAgICBvYmouY3FsICs9IGBDUkVBVEUgQ09OU1RSQUlOVCBJRiBOT1QgRVhJU1RTIEZPUiAobzokezwlPV9uQ29kZSgpJT59KSBSRVFVSVJFIG8uJHtlYUNvZGV9IElTIFVOSVFVRTsNCmANCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLmNxbCArPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpLmpvaW4oJ1xuJyksDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQuY3FsKTsNCiAgICAgICAgcmV0dXJuIHJldC5jcWw7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9DeU1lcmdlJyU+KGZpZWxkcywgYlJhdyl7DQogICAgICAgIGxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcywgdHJ1ZSk7DQogICAgICAgIGxldCB1a2V5cyA9IFtdOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KSB1a2V5cy5wdXNoKDwlPV9uQ29kZShlYSklPik7DQogICAgPCUgfSklPg0KICAgICAgICBsZXQgY3FsID0gYDokezwlPV9uQ29kZSgpJT59IHtgICsgT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB1a2V5cy5pbmNsdWRlcyhrKSkubWFwKGsgPT4gayArICI6ICIgKyBvYmpba10pLmpvaW4oJywgJykgKyBgfSlgOw0KICAgICAgICANCiAgICAgICAgaWYoIWJSYXcpew0KICAgICAgICAgICAgbGV0IG1hdGNoID0gJ1xuTUFUQ0ggKG8nICsgY3FsOw0KICAgICAgICAgICAgY3FsID0gJ01FUkdFIChvJyArIGNxbDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG9uU2V0ID0gT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiAhdWtleXMuaW5jbHVkZXMoaykpLm1hcChrID0+ICJvLiIgKyBrICsgIj0iICsgb2JqW2tdKS5qb2luKCcsICcpDQogICAgICAgICAgICBjcWwgKz0gJ1xuT04gQ1JFQVRFIFNFVCAnICsgb25TZXQgKyAnXG5PTiBNQVRDSCBTRVQgJyArIG9uU2V0Ow0KICAgICAgICAgICAgY3FsICs9ICdcblJFVFVSTiBvOyc7DQoNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgY3FsICs9IG1hdGNoICsgJywgJyArIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KG51bGwsIHRydWUpLnJlcGxhY2UoJyg6JywgJyg8JT1uTmFtZShlYSklPjonKSArICcgTUVSR0UgKG8pLVs6PCU9bk5hbWUoYyklPl88JT1uTmFtZShlYSklPl0tPig8JT1uTmFtZShlYSklPik7JzsNCiAgICA8JSB9KSU+DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgY3FsID0gJygnICsgY3FsOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+Y3FsKTsNCiAgICAgICAgcmV0dXJuIGNxbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvQ3lRdWVyeSclPihmaWVsZHMsIG9ianMpew0KICAgICAgICBsZXQgc3FsID0gIk1BVENIICI7DQogICAgICAgIA0KICAgICAgICBsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCl9JHt0aGlzLl9RKCl9YDsNCg0KICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsNCg0KICAgICAgICBzcWwgKz0gYCAoJHt0UHJlZn06JHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgICAgICANCiAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGAgT1BUSU9OQUwgTUFUQ0ggKCR7dGhpcy5fUSgpfSR7a30ke3RoaXMuX1EoKX06JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9KSBPUFRJT05BTCBNQVRDSCAoJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+LnRvTG93ZXJDYXNlKCl9JHt0aGlzLl9RKCl9KS1bOiR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9XS0+KCR7dGhpcy5fUSgpfSR7a30ke3RoaXMuX1EoKX0pYCk7DQogICAgICAgIA0KDQogICAgICAgIC8vc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOw0KICAgICAgICAvL09iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOw0KICAgICAgICANCiAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcyl7DQogICAgICAgICAgICAvLyB7ZmllbGQ6IGZ1bmN0aW9ufQ0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT59KCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KDQogICAgICAgIHNxbCArPSBgIHdoZXJlIDE9MWA7DQoNCiAgICAgICAgc3FsID0gdGhpcy5fX2V4cG9ydCh7c3FsOiBzcWx9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UICI7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICIiOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICIiOg0KICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICIiOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke2Nvb3B9IEVYSVNUUyB7JHt2LjwlPW1OYW1lJT4oKX19YDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCB8fCBlYS5Jc0ltYWdlIHx8IGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArIDwlaWYoZWEuSXNCb29sKXslPiI9IjwlfWVsc2V7JT4odGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCB8fCAiQ09OVEFJTlMiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArIHYgKyAoKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A9PSJMSUtFIiB8fCAhdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCk/IiUiOiIiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0iYm9vbGVhbiIpew0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICh2PyIxIjoiMCIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiKCIgKyB2LjwlPW1OYW1lJT4oKSArICIpIjsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPXRhTmFtZSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIikpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBqT1AgPSAnVU5JT04gQUxMJzsNCiAgICAgICAgICAgICAgICBsZXQgaW5PUCA9ICdJTic7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nIT0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdOT1QgSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgaW5PUCA9ICdOT1QgSU4nOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nSU4nKXsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPT0nKXsNCiAgICAgICAgICAgICAgICAgICAgak9QID0gJ0lOVEVSU0VDVCc7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGFuZCAvKjwlPXRhTmFtZSU+Ki8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGZpZWxkcykuc3FsOw0KDQogICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcyl7DQogICAgICAgICAgICBpZihPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+fWA7DQogICAgPCUgfSklPg0KICAgICAgICB9DQoNCiAgICAgICAgaWYoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSl7DQogICAgICAgICAgICAvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc3FsICs9ICcgcmV0dXJuICcgKyBbdFByZWZdLmNvbmNhdChPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLm1hcChrID0+IGAke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9YCkpLmpvaW4oJywgJyk7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzcWw7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19uZW80aiclPihjcWwpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pPT1jKXslPg0KICAgICAgICBsZXQgc2Vzc2lvbiA9IG51bGw7DQogICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYiB8fCAhY3FsIHx8ICFjcWwudHJpbSgpKXsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+Y3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gW107DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBpZihjcWwuaW5kZXhPZignO1xuJyk+MCl7DQogICAgICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIGNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLjwlPW1OYW1lJT4oc3FsUy50cmltKCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBiU3RvcmUgPSBbIk1FUkdFIiwgIkNSRUFURSIsICJVUERBVEUiXS5maWx0ZXIobiA9PiBjcWwuaW5kZXhPZihuKT49MCkuZmluZChuID0+IG4pOw0KICAgICAgICAgICAgbGV0IGJETUwgPSBbIkNPTlNUUkFJTlQiXS5maWx0ZXIobiA9PiBjcWwuaW5kZXhPZihuKT49MCkuZmluZChuID0+IG4pOw0KDQogICAgICAgICAgICBpZihiRE1MKXsNCiAgICAgICAgICAgICAgICB0aGlzLlRvb2wuZG1sQ2FjaGUgPSB0aGlzLlRvb2wuZG1sQ2FjaGUgfHwge307DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoY3FsKV0pIHJldHVybjsNCiAgICAgICAgICAgICAgICB0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShjcWwpXSA9IGNxbDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgc2Vzc2lvbiA9IHRoaXMuVG9vbC5kYi5zZXNzaW9uKHsgZGF0YWJhc2U6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJykgfSk7DQogICAgICAgICAgICBsZXQgZnVuID0gJ1JlYWQnOw0KICAgICAgICAgICAgaWYoYlN0b3JlIHx8IGJETUwpIGZ1biA9ICdXcml0ZSc7DQogICAgICAgICAgICBpZihmdW49PSdXcml0ZScpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChjcWwpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgICAgICAvL3JldCA9IChhd2FpdCBzZXNzaW9uWydleGVjdXRlJytmdW5dKHR4ID0+IHR4LnJ1bihjcWwpKSkucmVjb3JkczsNCiAgICAgICAgICAgIC8vPCU9bG9nKCklPnJldCk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgaWYoc2Vzc2lvbikgYXdhaXQgc2Vzc2lvbi5jbG9zZSgpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydOZW80aiddKSklPigpLjwlPW1OYW1lJT4oY3FsKTsNCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnUnhEQicsICdNb25nb0RCJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9KU09OU2NoZW1hJyU+KCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygnanNvbi50eXBlJywgJ3R5cGUnKTsNCiAgICAgICAgICAgIGxldCBzY2hlbWEgPSB7DQogICAgICAgICAgICAgICAgJGlkOiAnPCU9Yy5JZCU+JywNCiAgICAgICAgICAgICAgICAkc2NoZW1hOiAiaHR0cHM6Ly9qc29uLXNjaGVtYS5vcmcvZHJhZnQvMjAyMC0xMi9zY2hlbWEiLA0KICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnPCU9Yy5SZW1hcmslPicsDQogICAgICAgICAgICAgICAgdGl0bGU6IDwlPV9uQ29kZSgpJT4sDQogICAgICAgICAgICAgICAgW3R5cGVdOiAnb2JqZWN0JywNCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiAwLA0KICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHsNCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBbPCU9X25Db2RlKGVhKSU+XTogew0KICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICI8JT1lYS5SZW1hcmslPiIsDQogICAgICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuYXJyYXknLCAnYXJyYXknKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiB7DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICAkcmVmOiAnPCU9ZWEuRW50aXR5Q2xhc3MuSWQlPicsDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLnN0cmluZycsICdzdHJpbmcnKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLnRleHQnLCAnc3RyaW5nJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5ib29sJywgJ2Jvb2xlYW4nKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuaW50JywgJ2ludGVnZXInKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5mbG9hdCcsICdudW1iZXInKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW1hZ2UpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5pbWFnZScsICdvYmplY3QnKSwNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmZpbGUnLCAnb2JqZWN0JyksDQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBbPCVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuUmVxdWlyZWQpLm1hcChlYSA9PiB7JT48JT1fbkNvZGUoZWEpJT48JX0pLmpvaW4oJywnKSU+XSwNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT5zY2hlbWEpOw0KICAgICAgICAgICAgcmV0dXJuIHNjaGVtYTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydNb25nb0RCJywgJ1J4REInLCAnWmFuZ29EQiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU2VsZWN0TWRiJyU+KCl7DQogICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBfVEhJUzogb2JqID0+IG9iai5faWQgPSB7JGluOiB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPigpKX0sDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5faWQgPSB0aGlzLklkLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGlmKCF2LjwlPW1OYW1lJT4pIHJldHVybjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7fTsNCiAgICAgICAgICAgICAgICBsZXQgb3AgPSAiJGUiOw0KICAgICAgICAgICAgICAgIHN3aXRjaCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKXsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPiI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZ3QiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIjwiOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGx0IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI+PSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkZ3RlIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI8PSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkbHRlIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkbmUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIklOIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRpbiI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXVtvcF0gPSB2LjwlPW1OYW1lJT4oKS50b0lTT1N0cmluZygpOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSB7JGluOiB2Lm1hcCh0ID0+IHQuPCU9bU5hbWUlPigpKX0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvREJPYmplY3QnJT4oZmllbGRzLCBiTm9SZWYpew0KICAgICAgICBpZighdGhpcy5JZCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsNCiAgICAgICAgfQ0KICAgICAgICBsZXQgcmV0ID0gew0KICAgICAgICAgICAgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyINCiAgICAgICAgfTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICBpZigoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9ZWEuTmFtZSU+IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiAoIWJOb1JlZiB8fCA8JT1lYS5FbnRpdHlUeXBlPydmYWxzZSc6J3RydWUnJT4pKXsNCiAgICAgICAgICAgIGxldCBmVmFsdWUgPSBudWxsOw0KICAgICAgICAgICAgbGV0IHYgPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBpZih2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQ9PXYuSWQpKXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIk5VTEwiOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2PzE6MDsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZT8nVHJ1ZSc6J0ZhbHNlJzsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdTcWxEQicpIGZWYWx1ZSA9ICInIiArIGZWYWx1ZSArICInIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNJbnQgfHwgZWEuSXNMb25nIHx8IGVhLklzRmxvYXQpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2IHx8ICcwJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArICh2P3YudG9JU09TdHJpbmcoKToiMTk3MC0xLTEiKSArICInIjsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc09iamVjdCl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIEpTT04uc3RyaW5naWZ5KHYsIG51bGwsICdcdCcpICsgIiciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7JT4NCiAgICAgICAgICAgIGZWYWx1ZSA9IHY9PT1udWxsPyJOVUxMIjooIiciICsgKChmYWxzZSAmJiB2ICYmIHYucmVwbGFjZSk/di5yZXBsYWNlKC9cXG4vZywgIlxcXFxuIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcJy9nLCAiXFxcXCciKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICdcXFxcIicpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCYvZywgIlxcXFwmIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcci9nLCAiXFxcXHIiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFx0L2csICJcXFxcdCIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXGIvZywgIlxcXFxiIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcZi9nLCAiXFxcXGYiKSAgOnYpICsgIiciKTsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgaWYodj09PW51bGwpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICJOVUxMIjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSdTcWxEQicpew0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J215c3FsJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBGUk9NX0JBU0U2NCgnJHt0aGlzLl9idG9hKHYpfScpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYGNhc3QodW5oZXgoJyR7di5zcGxpdCgiIikubWFwKHggPT4gKDI1NiArIHguY2hhckNvZGVBdCgpKS50b1N0cmluZygxNikuc3Vic3RyKC0yKSkuam9pbigiIil9JykgYXMgdmFyY2hhcilgOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSB2Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdiArICInIjsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXRbPCU9X25Db2RlKGVhKSU+ICsgIjwlPShlYS5FbnRpdHlUeXBlPydpZCc6JycpJT4iXSA9IGZWYWx1ZTsNCiAgICAgICAgfQ0KICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J2dldCclPihuYW1lKSB7DQogICAgICAgIGlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7DQogICAgICAgIHZhciB0ID0gbnVsbDsNCiAgICAgICAgJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsNCiAgICAgICAgICAgIHQgPSB7DQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB0ID8gew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIFZhbHVlRW50aXRpZXM6IFt0XQ0KICAgICAgICAgICAgICAgIH0gOiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgSWQ6IHRoaXMuSWQNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIEVudGl0eUF0dHJpYnV0ZTogew0KICAgICAgICAgICAgICAgICAgICBOYW1lOiBmLA0KICAgICAgICAgICAgICAgICAgICBPUEVSQVRPUlM6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIE5hbWU6ICI9Ig0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsNCiAgICAgICAgICAgIDwlPWxvZygpJT5ldik7DQogICAgICAgICAgICBpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsNCg0KICAgICAgICAgICAgaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPlskLmdyZXAoPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsNCiAgICAgICAgfSk7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpKXslPg0KICAgIDwlPW1OYW1lPSdfUSclPigpew0KICAgICAgICBsZXQgX28gPSAnIic7DQogICAgICAgIGxldCBfcSA9IF9vOw0KDQogICAgICAgIGlmKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk9PTApew0KICAgICAgICAgICAgX28gPSBfcSA9ICIiOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZT09J05lbzRqJyl7DQogICAgICAgICAgICBfbyA9IF9xID0gJ2AnOw0KICAgICAgICB9ZWxzZSBpZihbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpPT0wKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSBgJ2A7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbHNlcnZlcicpew0KICAgICAgICAgICAgX28gPSAnWyc7DQogICAgICAgICAgICBfcSA9ICddJzsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygnYXBpS2V5Jyk9PSdhaXJ0YWJsZScpew0KICAgICAgICAgICAgX28gPSAneyc7DQogICAgICAgICAgICBfcSA9ICd9JzsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX28/X3E6X287DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmllbGRHcm91cHMnJT4oZmdzID0ge30pew0KICAgICAgICB0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2ZpZWxkQWdncmVnYXRlcyclPihmYXMgPSB7fSl7DQogICAgICAgIHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvRmllbGRzU1FMJyU+KGZpZWxkcyl7DQogICAgICAgIA0KICAgICAgICBmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSwgPCU9Yy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gX25Db2RlKGVhKSArIChlYS5FbnRpdHlUeXBlPycrIi5pZCInOicnKSkuam9pbignLCcpJT5dOw0KICAgICAgICBmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcyk/ZmllbGRzOltmaWVsZHNdOw0KDQogICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcyl7DQogICAgICAgICAgICAvLyB7ZmllbGQ6IG9yZGVyfQ0KICAgICAgICAgICAgZmllbGRzID0gW107DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIGZpZWxkcy5wdXNoKGAkezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59YCk7DQogICAgPCUgfSklPg0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmaWVsZHM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZnJvbURCT2JqZWN0JyU+KHI9e30pew0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7DQogICAgICAgICAgICAgICAgSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ob2JqW2VhQ29kZV0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU2VsZWN0SGVhZGVyJyU+KGZpZWxkcyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSB7DQogICAgICAgICAgICAgICAgdGFibGU6IDwlPV9uQ29kZSgpJT4sDQogICAgICAgICAgICAgICAgZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksDQogICAgICAgICAgICAgICAgam9pbnM6IHt9LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoZmllbGRzKSByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1NlbGVjdFNRTCclPihmaWVsZHMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgc3FsID0gInNlbGVjdCAiOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOw0KDQogICAgICAgICAgICBzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7DQogICAgICAgICAgICBPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsNCiAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpew0KICAgICAgICAgICAgICAgIC8vIHtmaWVsZDogZnVuY3Rpb259DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT59KCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKGVhKSU+fSR7dGhpcy5fUSgpfSlgOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgIHNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNxbCArPSBgIHdoZXJlIDE9MWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNxbCA9IHRoaXMuX19leHBvcnQoe3NxbDogc3FsfSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCk/WydJZCddOnVuZGVmaW5lZCwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHYucmV1c2VkPjIpew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9d2FybigpJT4iUmV1c2VkOiAiLCB2KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHYub2JqLnNxbCA9IGAvKlJFU1VFRDogJHt2LnJldXNlZH0qL2A7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIF9USElTOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCAvKmFuZCAqLyR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPih0Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCcpLnRoaXMpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmouc3FsICs9ICh0aGlzLklkPT10aGlzLklkKT9gIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDonJywNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHYgJiYgdi50b0lTT1N0cmluZyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiKCIgKyB2LjwlPW1OYW1lJT4oKSArICIpIjsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuXzwlPXRhTmFtZSU+X3NldCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbGV0IGpPUCA9ICdVTklPTiBBTEwnOw0KICAgICAgICAgICAgICAgICAgICBsZXQgaW5PUCA9ICdJTic7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nIT0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdOT1QgSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluT1AgPSAnTk9UIElOJzsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz0nIHx8IHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSdJTicpew0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPT0nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGpPUCA9ICdJTlRFUlNFQ1QnOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBhbmQgLyo8JT10YU5hbWUlPiovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuPCU9bU5hbWUlPigiPCU9bk5hbWUodGEpJT4uaWQiKSkuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIGZpZWxkcykuc3FsOw0KDQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgICAgIGlmKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPikgc3FsICs9IGAke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPjwlPShlYS5FbnRpdHlUeXBlPycrImlkIic6JycpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+fWA7DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZighc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSl7DQogICAgICAgICAgICAgICAgc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSE9PSd1bmRlZmluZWQnP3NxbEZvcm1hdHRlci5mb3JtYXQoc3FsKTpzcWw7DQogICAgICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHNxbDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvUGF0aHMnJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4ge30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+ID0gdi48JT1tTmFtZSU+KCksDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9dGFOYW1lJT4gPSB2Lm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgLy8gcmV0dXJuIHJldDsNCiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHtba106IHJldFtrXX0pKTsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvVXBkYXRlU1FMJyU+KGZpZWxkcyl7DQogICAgICAgIGxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOw0KICAgICAgICBsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7DQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9JbnNlcnRTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsNCiAgICAgICAgbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0kezwlPV9uQ29kZSgpJT59JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsNCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIHJldHVybiBzcWw7DQogICAgfQ0KPCUgfSAlPg0KICAgIA0KICAgIDwlPW1OYW1lPSdfY29weUZyb20nJT4ob2JqKXsNCiAgICAgICAgaWYoIW9iaikgcmV0dXJuIG51bGw7DQogICAgICAgIHJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b09ialRyZWUnJT4oYkN5Y2xpYyl7DQogICAgICAgIDwlPXdhcm4oKSU+ImRlcHJlY2F0ZWQiKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIA0KICAgICAgICB0aGlzLl9kZWZhdWx0cygpOw0KDQogICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLk5hbWUsIHRydWUpJT4oJzwlPWMuTmFtZSU+JyksIHsNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBDeWNsaWM6IGJDeWNsaWMsDQogICAgICAgICAgICAvL2V4cG9ydGVyOiB2ID0+IDwlPXdhcm4oKSU+di5yZXVzZWQpLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPig8JWlmKGVhLkVudGl0eVR5cGUpeyU+bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KGJDeWNsaWMpPCV9ZWxzZXslPnY8JX0lPiksDQogICAgPCUgfSk7JT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT10YU5hbWUlPihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KGJDeWNsaWMpKSwNCiAgICA8JSB9KTslPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3VuQ3ljbGUnJT4oc291cmNlPXRoaXMpew0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh0aGlzLCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KHNvdXJjZT09b2JqLjwlPW5OYW1lKGVhKSU+KCk/bnVsbDp1bmRlZmluZWQpLA0KICAgIDwlIH0pOyU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB0cnVlLA0KICAgIDwlIH0pOyU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdfc3RvcmVFbnRpdHlDbGFzcyclPihkZXB0aCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihkZXB0aCk9PT0idW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsNCiAgICAgICAgICAgIGlmKCFkZXB0aCkgcmV0dXJuOw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLlRvb2wuPCU9bU5hbWUlPiA9IHRoaXMuVG9vbC48JT1tTmFtZSU+IHx8IHt9Ow0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLjwlPW1OYW1lJT4uPCU9bk5hbWUoYyklPikgcmV0dXJuOw0KICAgICAgICAgICAgdGhpcy5Ub29sLjwlPW1OYW1lJT4uPCU9bk5hbWUoYyklPiA9IHRydWU7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlPWxvZygpJT5gc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOw0KICAgICAgICAgICAgDQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLkRTQ29ubmVjdCgpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik5lbzRqIil7JT4NCiAgICAgICAgICAgICAgICBsZXQgY3FsID0gdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9DeVRhYmxlKGRlcHRoKTsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Y3FsKTsNCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aihjcWwpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJBaXJUYWJsZSIpeyU+DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fYWlydGFibGUoJ21ldGEvYmFzZXMnLCBudWxsLCB7bmFtZTogJzwlPXNjb3BlJT4nLCB3b3Jrc3BhY2VJZDogdGhpcy5Ub29sLmRiLndvcmtzcGFjZUlkLCB0YWJsZXM6IHRoaXMuX3RvQVRUYWJsZShkZXB0aCl9KTsNCiAgICA8JSB9ZWxzZSBpZihfc3FsVG9vbHMuaW5kZXhPZih0KT49MCl7JT4NCiAgICAgICAgICAgICAgICBsZXQgc3FsID0gdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TUUxUYWJsZSh7cmV1c2VkOiAzfSk7IDwlLypkZXB0aDogY2hhbGxlbmdlIC0gdG9vIGxvdyBkb2VzIG5vdCBjb3ZlciBhbGwgdGFibGVzLCB0b28gaGlnaCAobWF4IGRlcHRoKSByZXN1bHRzIGluIG91dC1vZi1tZW1vcnkgb24gYnJvd3NlciovJT4NCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoc3FsKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iU2VydmljZU5vdyIpeyU+DQogICAgICAgICAgICAgICAgLy88JT1sb2coKSU+dGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTlRhYmxlKCkpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJFTVMiKXslPg0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TQ2xhc3MoZGVwdGgpLnN0b3JlKCk7DQogICAgPCUgfWVsc2UgaWYodD09IkJJU2VydmVyIil7JT4NCiAgICAgICAgICAgICAgICAvLyBvbmx5IGRvIHRoaXMgaWYgdGhlIG1vZHVsZSBpcyBub3QgbG9hZGVkIGZyb20gDQogICAgICAgICAgICAgICAgKGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBDb21wYW55OiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvZGU6IHRoaXMuX19jb25maWcoJ2NvbXBhbnknLCAnPCU9c2NvcGUlPicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIH0pKS5mb3JFYWNoKGVhID0+IC8qIHRyeWUgX2VhVHlwZXMgKi88JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChzZWEgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihzZWEuSWQhPT1lYS5JZCAmJiBzZWEuTmFtZT09ZWEuTmFtZSAmJiAoc2VhLkVudGl0eUNsYXNzLklkPT1lYS5FbnRpdHlDbGFzcy5JZCB8fCBzZWEuRW50aXR5Q2xhc3MuTmFtZT09ZWEuRW50aXR5Q2xhc3MuTmFtZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgc2VhLklkID09IGVhLklkOw0KICAgICAgICAgICAgICAgICAgICAgICAgc2VhLkVudGl0eUNsYXNzLklkID0gZWEuRW50aXR5Q2xhc3MuSWQ7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZT09c2VhLkVudGl0eUNsYXNzLk5hbWUpLkVudGl0eUF0dHJpYnV0ZXMuZmluZChzY2VhID0+IHNjZWEuTmFtZT09ZWEuTmFtZSkuSWQgPSBlYS5JZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iTW9uZ29EQiIgfHwgdD09IlphbmdvREIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgYXdhaXQgdGhpcy5Ub29sLmRiLmNyZWF0ZUNvbGxlY3Rpb24oPCU9X25Db2RlKCklPiwge3ZhbGlkYXRvcjogeyRqc29uU2NoZW1hOiB0aGlzLl90b0pTT05TY2hlbWEoKX19KTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iUnhEQiIpeyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRiKSBhd2FpdCB0aGlzLlRvb2wuZGIuYWRkQ29sbGVjdGlvbnMoe1s8JT1fbkNvZGUoKSU+XToge3NjaGVtYTogdGhpcy5fdG9KU09OU2NoZW1hKCl9fSk7DQogICAgPCUgfSU+DQogICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19sb2cnJT4ob2JqPXRoaXMpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KG9iaik7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KG9iaikpIHJldHVybiBvYmoubWFwKG8gPT4gdGhpcy5fbG9nKG8pKTsNCiAgICAgICAgICAgIGlmKG9iai5FbnRpdHlDbGFzcykgb2JqID0gb2JqLl90b0pTT04oe2JNYXA6IHRydWV9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5vYmopOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdEU0Nvbm5lY3QnJT4odG9vbD10aGlzLlRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KHRvb2wpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIXRvb2wpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJUb29sIGlzIG51bGwiLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKCF0b29sLnR5cGUpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJUb29sLnR5cGUgaXMgbnVsbCIsIHRvb2wsIHRoaXMuVG9vbHMubGVuZ3RoLCA8JT1zY29wZSU+LlRvb2xzLmxlbmd0aCk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKHRvb2wuZGIpIT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iVG9vbCBhbHJlYWR5IGNvbm5lY3RlZCEiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZig8JT1uc2NvcGUlPi5fbm9kZSAmJiAvKjwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnRfc2V0ICYmICovPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Ik5vZGUgaGFzIGEgdmFsaWQgcGFyZW50LCBubyBsb2NhbCBTUUwgcG9zc2libGUiKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRvb2wuX19kbWxTdGF0ZW1lbnRzID0gdG9vbC5fX2RtbFN0YXRlbWVudHMgfHwgW107DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICA8JT1sb2coKSU+Ils8JT10JT5dOiBDb25uZWN0aW5nLi4uIik7DQoNCiAgICAgICAgICAgIGlmKHRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09IkVNUyIpeyU+DQogICAgPCUgfWVsc2UgaWYodD09Ik1vbmdvREIiKXslPg0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPnRoaXMuX19jb25maWcoJ3VyaScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ2NvbmZpZycsIG51bGwsIHt0b29sOiB0b29sfSkpOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtb25nb2RiKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IChhd2FpdCBuZXcgbW9uZ29kYi5Nb25nb0NsaWVudCh0aGlzLl9fY29uZmlnKCd1cmknLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdjb25maWcnLCBudWxsLCB7dG9vbDogdG9vbH0pKS5jb25uZWN0KCkpLmRiKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pKTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYodD09J1J4REInKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBhd2FpdCBSeERCLmNyZWF0ZVJ4RGF0YWJhc2Uoe25hbWU6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pLCBzdG9yYWdlOiBudWxsfSk7DQogICAgPCUgfWVsc2UgaWYodD09J1phbmdvREInKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgemFuZ28uRGIodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCAiPCU9c2NvcGUlPiIsIHt0b29sOiB0b29sfSksIHsNCiAgICAgICAgPCUgYXJDbGFzc2VzLmZvckVhY2goZWMgPT4geyU+DQogICAgICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVjKSU+OiBbIjwlPWVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBuTmFtZShlYSkpLmpvaW4oJ1wiLCBcIicpJT4iXSwNCiAgICAgICAgPCUgfSkgJT4NCiAgICAgICAgICAgICAgICB9KTsNCiAgICA8JSB9ZWxzZSBpZih0PT0nS2Fma2EnKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihrYWZrYWpzKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBrYWZrYWpzLkthZmthKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudElkOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBicm9rZXJzOiBbdGhpcy5fX2NvbmZpZygnYnJva2VycycsIG51bGwsIHt0b29sOiB0b29sfSldLA0KICAgICAgICAgICAgICAgICAgICAgICAgc3NsOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgc2FzbDogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Nhc2xfcGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lY2hhbmlzbTogdGhpcy5fX2NvbmZpZygnc2FzbF9tZWNoYW5pc21zJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uVGltZW91dDogMzAwMCwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIHRvb2wucHJvZHVjZXIgPSB0b29sLmRiLnByb2R1Y2VyKCk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wucHJvZHVjZXIuY29ubmVjdCgpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgdG9vbC5jb25zdW1lciA9IHRvb2wuZGIuY29uc3VtZXIoe2dyb3VwSWQ6IHRoaXMuX19jb25maWcoJ2NsaWVudElkJywgbnVsbCwge3Rvb2w6IHRvb2x9KX0pOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLmNvbnN1bWVyLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5jb25zdW1lci5zdWJzY3JpYmUoew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICc8JT1zY29wZSU+LmNhbGwnLA0KICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUJlZ2lubmluZzogZmFsc2UsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICA8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgICAgICAgICAgICAgICAgIHRvb2wuY29uc3VtZXIucnVuKHtlYWNoTWVzc2FnZTogYXN5bmMgKHsgdG9waWMsIHBhcnRpdGlvbiwgbWVzc2FnZSB9KSA9PiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0V2ZW50JywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQobWVzc2FnZS52YWx1ZS50b1N0cmluZygpKS5wcm9jZXNzKCl9KTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09J01lbW9yeScpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IHsNCiAgICAgICAgPCUgYXJDbGFzc2VzLmZvckVhY2goZWMgPT4geyU+DQogICAgICAgICAgICAgICAgICAgICc8JT1uTmFtZShlYyklPic6IFtdLA0KICAgICAgICA8JSB9KTsgJT4NCiAgICAgICAgICAgICAgICB9Ow0KICAgIDwlfWVsc2UgaWYodD09IkV4Y2VsIil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5kYiA9IDwlPXNjb3BlJT4ueGxzeERhdGE/WExTWC5yZWFkKDwlPXNjb3BlJT4ueGxzeERhdGEpOlhMU1gudXRpbHMuYm9va19uZXcoKTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5kYiA9IFhMU1gucmVhZChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdmaWxlbmFtZScsIG51bGwsIHt0b29sOiB0b29sfSkpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgPCV9ZWxzZSBpZih0PT0iU25vd0ZsYWtlIil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnICYmIGdsb2JhbC5zbm93Zmxha2Upew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gZ2xvYmFsLnNub3dmbGFrZS5jcmVhdGVDb25uZWN0aW9uKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQ6IHRoaXMuX19jb25maWcoImFjY291bnQiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuX19jb25maWcoInVzZXJuYW1lIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCJwYXNzd29yZCIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbjogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICI8JT1zY29wZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYi5jb25uZWN0KChlcnIsIGNvbm4pPT57DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPidVbmFibGUgdG8gY29ubmVjdDogJyArIGVyci5tZXNzYWdlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqKGVycik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYi5jb25uZWN0aW9uX0lEID0gY29ubi5nZXRJZCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09Ik5lbzRqIil7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gbmVvNGouZHJpdmVyKA0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9fY29uZmlnKCd1cmwnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICBuZW80ai5hdXRoLmJhc2ljKHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygncGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pKQ0KICAgICAgICAgICAgICAgICk7DQogICAgPCV9ZWxzZSBpZih0PT0iQWlyVGFibGUiKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSB7DQogICAgICAgICAgICAgICAgICAgIGJhc2VJZDogJycsDQogICAgICAgICAgICAgICAgICAgIHdvcmtzcGFjZUlkOiB0aGlzLl9fY29uZmlnKCd3b3Jrc3BhY2VJZCcsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnLA0KICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICAgICAgICAgIHVzZXJJZDogKGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL3dob2FtaScpKS5pZCwNCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAgICAgbGV0IGJhc2VzID0gKGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL2Jhc2VzJykpLmJhc2VzOw0KICAgICAgICAgICAgICAgIGlmKGJhc2VzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuYmFzZUlkID0gYmFzZXMuZmlsdGVyKGIgPT4gYi5uYW1lPT0nPCU9c2NvcGUlPicpLmlkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiLmJhc2VJZCkgdG9vbC5kYi5iYXNlSWQgPSAnYXBwJyArIHRoaXMuX3V1aWQoKS5zcGxpdCgnLScpLnNsaWNlKC0xKVswXTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJTcWxEQiIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldKXsNCiAgICAgICAgICAgICAgICAgICAgaWYoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5EYXRhYmFzZSl7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgdG9vbCldLkRhdGFiYXNlKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiLi88JT1zY29wZSU+LmRiIik7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uY3JlYXRlQ29ubmVjdGlvbil7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5jcmVhdGVDb25uZWN0aW9uKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob3N0OiB0aGlzLl9fY29uZmlnKCdzZXJ2ZXInLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXI6IHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygncGFzc3dvcmQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIjwlPXNjb3BlJT4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uQ2xpZW50KXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXS5DbGllbnQoe2Nvbm5lY3Rpb25TdHJpbmc6IHRoaXMuX19jb25maWcoJ2Nvbm5zdHInLCBudWxsLCB7dG9vbDogdG9vbH0pfSk7DQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLmRiLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZihnbG9iYWwpPT09J3VuZGVmaW5lZCcgJiYgdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSk9PT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgIC8vIHNxbGl0ZSBpbiBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcgU1FMLkRhdGFiYXNlKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09IlNlcnZpY2VOb3ciKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0b29sLnN5c19zY29wZSk9PT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgIC8vIHRvb2wuc3lzX3Njb3BlID0gKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19hcHAiLCB7c3lzX3Njb3BlOiB0aGlzLl9fY29uZmlnKCJzY29wZSIsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgImdsb2JhbCJ9KSlbMF0uc3lzX2lkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodG9vbC5zeXNfcHJvcGVydGllcyk9PT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgIC8vIGxvYWRpbmcgc29tZSBwbGF0Zm9ybSBzdHVmZg0KICAgICAgICAgICAgICAgICAgICB0b29sLnN5c19wcm9wZXJ0aWVzID0ge307DQogICAgICAgICAgICAgICAgICAgIGxldCBjb25kaXRpb24gPSBPYmplY3Qua2V5cyh0b29sLnN5c19wcm9wZXJ0aWVzKS5maWx0ZXIoayA9PiAhdG9vbC5zeXNfcHJvcGVydGllc1trXSkuam9pbignLCcpOw0KICAgICAgICAgICAgICAgICAgICBpZihjb25kaXRpb24pew0KICAgICAgICAgICAgICAgICAgICAgICAgKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19wcm9wZXJ0aWVzIiwge25hbWU6ICJJTiIrY29uZGl0aW9ufSkpLmZvckVhY2gociA9PiB0b29sLnN5c19wcm9wZXJ0aWVzW3IubmFtZV0gPSByLnZhbHVlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KPCUgfSU+DQogICAgfQ0KICAgIC8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8NCiAgICANCiAgICA8JT1tTmFtZT0nX21hdGNoZXMnJT4ocXVlcnksIG9wdGlvbnMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighb3B0aW9ucykgb3B0aW9ucyA9IHt9Ow0KICAgICAgICAgICAgaWYoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lIT0iPCU9bk5hbWUoYyklPiIpIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodHlwZW9mKG1pY3JvZGlmZikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgbGV0IHRIYXNoID0gdGhpcy5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IG9wdGlvbnMub25seVVuaXF1ZX0sICc8JT1tTmFtZSU+JykuX3RoaXM7DQogICAgICAgICAgICAgICAgbGV0IHFIYXNoID0gcXVlcnkuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWV9LCAnPCU9bU5hbWUlPicpLl90aGlzOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGxldCBkaWZmID0gbWljcm9kaWZmKHFIYXNoLCB0SGFzaCkuZmlsdGVyKGQgPT4gZC50eXBlIT0nQ1JFQVRFJyAmJiBbJ09QRVJBVE9SUycsICdJZCddLmluZGV4T2YoZC5wYXRoWzBdKTwwKTsNCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT4nW3QvcV0nLCB0SGFzaCwgcUhhc2gsIGRpZmYpOw0KICAgICAgICAgICAgICAgIGxldCByZXQgPSBkaWZmLmZpbHRlcihkID0+IGQudHlwZT09J0NIQU5HRScpLnJlZHVjZSgodiwgZCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHF1ZXJ5WydfJyArIGQucGF0aFswXSArICdfY29vcCddIHx8ICh0eXBlb2YoZC52YWx1ZSk9PT0nc3RyaW5nJz8nTElLRSc6Jz0nKTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBvbGRWYWx1ZSA9IHR5cGVvZihkLm9sZFZhbHVlKT09PSdzdHJpbmcnP2Qub2xkVmFsdWUuc3BsaXQoJy8nKS5zbGljZSgtMSlbMF06ZC5vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5kLnBhdGhbMF0sIGQub2xkVmFsdWUsIGQudmFsdWUsIGNvb3AsIG9sZFZhbHVlLCBkKTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ0xJS0UnOiByZXR1cm4gdiAmJiAob2xkVmFsdWU9PT1udWxsIHx8IGQudmFsdWUuaW5kZXhPZihvbGRWYWx1ZSk+PTApOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6IHJldHVybiB2ICYmIChvbGRWYWx1ZT09PW51bGwgfHwgIWQudmFsdWUgfHwgZC52YWx1ZT09b2xkVmFsdWUpOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnIT0nOiByZXR1cm4gdiAmJiBkLnZhbHVlIT1vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz49JzogcmV0dXJuIHYgJiYgZC52YWx1ZT49b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc8PSc6IHJldHVybiB2ICYmIGQudmFsdWU8PW9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPic6IHJldHVybiB2ICYmIGQudmFsdWU+b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc8JzogcmV0dXJuIHYgJiYgZC52YWx1ZTxvbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sIHRydWUpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4nW3QvcV0nLCByZXQsIGRpZmYpOw0KICAgICAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICAgICAgLy9GdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIC8vTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZD09cXVlcnkuSWQsDQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9bk5hbWUoZWEpJT4gPSB2P3YuPCU9bU5hbWUlPihxdWVyeT9xdWVyeS48JT1uTmFtZShlYSklPigpOm51bGwpOnRydWU7DQogICAgICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9bk5hbWUoZWEpJT4gPSB2PT1xdWVyeS48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIGlmKA0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiAhcXVlcnkuXzwlPW5OYW1lKGVhKSU+X3NldCkgfHwNCiAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgICAgICAgICAgICkgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKA0KICAgICAgICAgICAgICAgICAgICAgICAgKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgcXVlcnkuXzwlPW5OYW1lKGVhKSU+X3NldCkgfHwNCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICAodGhpcy48JT1uTmFtZShlYSklPigpICYmICF0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihxdWVyeS48JT1uTmFtZShlYSklPigpKSkgfHwNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UNCiAgICAgICAgICAgICAgICAgICAgKSBvYmouPCU9bk5hbWUoZWEpJT4gPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KTsgJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmouPCU9dGFOYW1lJT4gPSB2Lm1hcChfdiA9PiBxdWVyeS48JT10YU5hbWUlPigpLmFueShxID0+IF92LjwlPW1OYW1lJT4ocSkpKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+b01hdGNoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J19tYXRjaGluZyclPihxdWVyeSl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJGb3IgPCU9bk5hbWUoZWEpJT4iKTsNCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj9bdi48JT1tTmFtZSU+KHF1ZXJ5KT92Om51bGxdLmNvbmNhdCh2LjwlPW1OYW1lJT4ocXVlcnkpKS5maWx0ZXIobSA9PiBtKTpbXTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihxdWVyeSkpLmZsYXQoKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgICAgICA8JT1sb2coKSU+Im1hdGNoZXMiLCBtYXRjaGVzKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSE9cXVlcnkpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+InJldCIsIHJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZGVSZWZlcmVuY2UnJT4ocm9vdCl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFyb290KSByb290PXRoaXM7DQoNCiAgICAgICAgICAgIGlmKHJvb3QhPXRoaXMgJiYgdGhpcy5TZXRfT24pIHsNCiAgICAgICAgICAgICAgICBsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7DQogICAgICAgICAgICAgICAgaWYoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybiBteU1hdGNoZXNbMF07DQogICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gdi48JT1tTmFtZSU+KHJvb3QpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocmV0IT12KSB0aGlzLjwlPW5OYW1lKGVhKSU+KHJldCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KTsgJT4NCiAgICAgICAgDQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmV0ID0gdGEuPCU9bU5hbWUlPihyb290KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJldCE9dGEpIHRoaXMuPCU9dGFOYW1lJT4oKVtpXSA9IHJldDsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tRG9jdW1lbnQnJT4ob2JqLCBiVG9vbCl7DQogICAgICAgIGlmKCFvYmopIHJldHVybiB0aGlzOw0KICAgICAgICBpZihvYmouPCU9bU5hbWUlPikgcmV0dXJuIG9iajsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZihvYmopPT09J3N0cmluZycpew0KICAgICAgICAgICAgaWYoPCU9X2I2NHRlc3QoJ29iaicpJT4pIG9iaiA9IHRoaXMuX2F0b2Iob2JqKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIGlmKG9iai5sZW5ndGg8MzMgJiYgIW9iai5tYXRjaCgvXHMvZykpew0KICAgICAgICAgICAgICAgICAgICBvYmogPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcsIHt0b29sOiBvYmouX190b29sfSldOiBvYmoNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqID0gSlNPTi5wYXJzZShvYmopOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iSW52YWxpZCBKU09OIG9yIFVVSUQiLCBvYmopOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9ZWxzZSBpZihBcnJheS5pc0FycmF5KG9iaikpew0KICAgICAgICAgICAgcmV0dXJuIG9iai5tYXAobyA9PiB0aGlzLjwlPW1OYW1lJT4obywgYlRvb2wpKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYob2JqLl9fdG9vbCkgdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsNCiAgICAgICAgDQogICAgICAgIGlmKCFPYmplY3Qua2V5cyhvYmopLmZpbHRlcihrID0+IHR5cGVvZihvYmpba10pIT09J3VuZGVmaW5lZCcgJiYgb2JqW2tdIT09bnVsbCkubGVuZ3RoKXsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iRW1wdHkgb2JqZWN0IG9yIG9iamVjdCBvZiBudWxscyIsIG9iaik7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KDQogICAgICAgIDwlPWxvZygpJT5vYmopOw0KICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydChvYmosIHsNCiAgICAgICAgICAgIF9tYXA6IGJUb29sLA0KICAgICAgICAgICAgaW1wb3J0ZXI6IHYgPT4gdi5vYmogPSAodi5vYmomJnYub2JqLlNldF9Db3VudDx0aGlzLlNldF9Db3VudCk/dGhpczp2Lm9iaiwNCiAgICAgICAgICAgIF9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTP29iai5PUEVSQVRPUlMuVEhJUzp1bmRlZmluZWQpLA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgIGlmKGlkQ29kZT09J0lkJykgaWRDb2RlID0gdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpOw0KICAgICAgICAgICAgICAgIGlmKG9ialtpZENvZGVdKSB0aGlzLklkID0gb2JqW2lkQ29kZV07DQogICAgICAgICAgICB9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlKSA9PiB7DQogICAgICAgICAgICAgICAgaWYob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgcmVmID0gb2JqW2VhQ29kZV07DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHJlZik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7ICU+DQogICAgICAgICAgICAgICAgPCUgaWYoIWVhLklzQXJyYXkpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsNCiAgICAgICAgICAgICAgICBpZighcmVmKSByZXR1cm47DQogICAgICAgICAgICAgICAgPCUgfSAlPg0KDQogICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPigodGhpcy48JT1uTmFtZShlYSklPigpIHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4ocmVmLCBiVG9vbCkpOw0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iU3FsREIiKXsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKG1vbWVudCkhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSE9PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBuZXcgRGF0ZShyZWYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihyZWYpPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVmLmluZGV4T2YoJ1QnKT4wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBEYXRlLnBhcnNlKHJlZik7DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBEYXRlLnBhcnNlKHJlZiArICIgR01UIik7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmVmID0gbmV3IERhdGUocmVmKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPihyZWYpOw0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0KXslPg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4oKDwlPV9iNjR0ZXN0KCdyZWYnKSU+KT90aGlzLl9hdG9iKHJlZik6KHJlZiB8fCAnJykpOw0KICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPihyZWYpOw0KICAgICAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUpID0+IG9ialtlYUNvZGVdP3RoaXMuPCU9dGFOYW1lJT4ob2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihfdiwgYlRvb2wpKSwgb2JqLk9QRVJBVE9SUz9vYmouT1BFUkFUT1JTW2VhQ29kZV06dW5kZWZpbmVkLCB0cnVlKTp1bmRlZmluZWQsDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvUHJvdG8nJT4ob3B0aW9ucz17fSwgc1BhdGgpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7SWQ6IDwlPV9uQ29kZSgpJT4sIHByb3RvOiBgXG5cbm1lc3NhZ2UgJHs8JT1fbkNvZGUoKSU+fSB7YCwgaW5kZXg6IDF9LCB7DQogICAgICAgICAgICAgICAgX21hcDogb3B0aW9ucy5iTWFwLA0KICAgICAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2Lm9iaj0odi5yZXVzZWQ+MSk/e3Byb3RvOiBgXG5cbi8vIHJldXNlZFske3YucmV1c2VkfV06ICR7PCU9X25Db2RlKCklPn1cblxuYH06di5vYmosDQogICAgICAgICAgICAgICAgX1RISVM6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0cmVwZWF0ZWQgJHs8JT1fbkNvZGUoKSU+fSAke2VhQ29kZX0gPSAke29iai5pbmRleCsrfTtgLA0KICAgICAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdHN0cmluZyAke2lkQ29kZX0gPSAke29iai5pbmRleCsrfTtgLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYFxuXHRgICsgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSBgXG5cdGA7DQogICAgICAgIDwlIGlmKGVhLlJlcXVpcmVkKXslPg0KICAgICAgICAgICAgICAgICAgICBpZig8JXZhbHVlT2YoZWEuUmVxdWlyZWQpJT4pIG9iai5wcm90byArPSAncmVxdWlyZWQgJzsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIDwlIGlmKGVhLklzQXJyYXkpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAncmVwZWF0ZWQgJzsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIDwlIGlmKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJzdHJpbmciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiYm9vbCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImludDMyIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNMb25nKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImludDY0IjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNGbG90KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImZsb2F0IjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEb3VibGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAiZG91YmxlIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNEYXRlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gInN0cmluZyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSA8JT1fbkNvZGUoZWEuRW50aXR5VHlwZSklPjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSBgICR7ZWFDb2RlfSA9ICR7b2JqLmluZGV4Kyt9O2A7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLnByb3RvICs9IGBcblx0YCArIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfVtdYCkgKyBgXG5cdHJlcGVhdGVkICR7PCU9X25Db2RlKHRhLkVudGl0eUNsYXNzKSU+fSAke2VhQ29kZX0gPSAke29iai5pbmRleCsrfTtgLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdHN0cmluZyAke2VmQ29kZX0gPSAke29iai5pbmRleCsrfTtgLA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgICAgICBfX2Nsb3NlOiBvYmogPT4gb2JqLnByb3RvICs9ICdcbn1cblxuJywNCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iiwgb3B0aW9ucywgc1BhdGgpLnByb3RvOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihyZXQgJiYgIXNQYXRoKXsNCiAgICAgICAgICAgICAgICByZXQgPSBgcGFja2FnZSA8JT1zY29wZSU+O1xuXG5zeW50YXggPSAicHJvdG8zIjtcblxuYCArIHJldDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQo8JX0lPg0KDQogICAgPCU9bU5hbWU9J190b0pTT04nJT4ob3B0aW9ucz17fSwgc1BhdGgpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzUGF0aCA9IHNQYXRoIHx8ICIiOw0KICAgICAgICAgICAgbGV0IHJldCA9IHt9Ow0KICAgICAgICAgICAgcmV0Ll9fa2V5cyA9IFtdOyAvLyEhDQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLmJNYXApew0KICAgICAgICAgICAgICAgIHJldC5fX2dlbmVyYXRlZCA9ICciJyArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSArICciJzsNCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wubmFtZSl7DQogICAgICAgICAgICAgICAgICAgIHJldC5fX3Rvb2wgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLlRvb2wubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICByZXQuX19jbGFzcyA9ICciPCU9bk5hbWUoYyklPiInOw0KICAgICAgICAgICAgICAgICAgICByZXQuX190eXBlID0gJyInKzwlPV9uQ29kZSgpJT4rJyInOw0KICAgICAgICAgICAgICAgICAgICAvL3JldC5fX3BhdGggPSAnIicrc1BhdGgrJyInOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZig8JT1uc2NvcGUlPi5fbm9kZSl7DQogICAgICAgICAgICAgICAgICAgIHJldC5fX25vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiA8JT1uc2NvcGUlPi5fbm9kZS5jb2RlKCkNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLl9kZWZhdWx0cygpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgdHJNYXAgPSAob2JqLCBlYUNvZGUsIHYsIHNQYXRoKSA9PiAodiAmJiB0eXBlb2Yodik9PT0nc3RyaW5nJyAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSgvPDxbXj4+XSs+Pi9nbSwgbSA9PiB7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3RyTWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwIHx8IFtdOw0KDQogICAgICAgICAgICAgICAgbGV0IHRyaWQgPSB0aGlzLl91dWlkKCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHBQYXRoID0gJy4nKyhzUGF0aC5zcGxpdCgnLicpLnNsaWNlKDEsIC0xKS5qb2luKCcuJykpOw0KICAgICAgICAgICAgICAgIGlmKHBQYXRoPT0iLiIpIHBQYXRoID0gIiI7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHRyID0gbS5yZXBsYWNlKCc8PCcsICcnKS5yZXBsYWNlKCc+PicsICcnKS5yZXBsYWNlKC97e25yfX0vZ20sICckbm90KCRleGlzdHMoX19yZXVzZWQpKScpLnJlcGxhY2UoL3t7dmZ9fS9nLCBvYmpbZWFDb2RlXSk7DQogICAgICAgICAgICAgICAgaWYodHIuc3RhcnRzV2l0aCgncygnKSAmJiB0ci5lbmRzV2l0aCgnKScpKXsNCiAgICAgICAgICAgICAgICAgICAgdHIgPSB0ci5yZXBsYWNlKC97e19ffX0vZ20sICdvSlNPTicrc1BhdGgpLnJlcGxhY2UoL3t7cHBhdGh9fS9nbSwgJ29KU09OJytwUGF0aCk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHRyID0gdHIucmVwbGFjZSgve3tfX319L2dtLCBgKipbSWQ9JHtvYmouSWR9XVswXWApOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIDwlPXdhcm4oKSU+ZWFDb2RlLCB0cmlkLCB0cik7DQoNCiAgICAgICAgICAgICAgICB0ciA9IHRoaXMuX2J0b2EodHIpOw0KICAgICAgICAgICAgICAgIGxldCBtYXAgPSA8JT1zY29wZSU+Ll9fdHJNYXAuZmluZChvID0+IG8udHJhbnNmb3JtPT10cik7DQogICAgICAgICAgICAgICAgcmV0dXJuIChtYXA/bWFwLmlkOjwlPXNjb3BlJT4uX190ck1hcFs8JT1zY29wZSU+Ll9fdHJNYXAucHVzaCh7aWQ6IHRyaWQsIHRyYW5zZm9ybTogdHJ9KS0xXS5pZCk7DQogICAgICAgICAgICB9KTp2Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuYk1hcCwNCiAgICAgICAgICAgICAgICBGdWxsOiBvcHRpb25zLmJGdWxsLA0KICAgICAgICAgICAgICAgIE51bGw6IG9wdGlvbnMuYk51bGwsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy5yZXVzZWQpPT09J3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZXVzZWQ+PXYucmV1c2VkKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYub2JqICYmIHR5cGVvZih2Lm9iai5fcmV0dXJuKT09PSdzdHJpbmcnICYmIHYub2JqLl9yZXR1cm4uaW5kZXhPZignX19yZXVzZWQ6IDEnKT4wKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBsZXQgb0hhc2ggPSBvcHRpb25zLmJIYXNoP1t0aGlzLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogdHJ1ZSwgbm9BcmdzOiB0cnVlLCBfbWFwOiBvcHRpb25zLmJNYXAsIG5vVHlwZXM6IGZhbHNlfSwgIjwlPW1OYW1lJT4iKV06T2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrPT0nSWQnIHx8IGsuaW5kZXhPZignX18nKT09MCkubWFwKGsgPT4ge3RyeXtyZXR1cm4geyBba106IEpTT04ucGFyc2UocmV0W2tdKSB9OyB9Y2F0Y2goZXgpe3JldHVybiB7W2tdOiByZXRba119OyB9IH0pOw0KICAgICAgICAgICAgICAgICAgICBsZXQgZVJldCA9IE9iamVjdC5hc3NpZ24oLi4ub0hhc2gsIHtfX3JldXNlZDogdi5yZXVzZWR9ICk7DQogICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZVJldC5fX2tleXMpKSBlUmV0Ll9fa2V5cy5mb3JFYWNoKGVrID0+IHt0cnl7IGVSZXRbZWtdID0gSlNPTi5wYXJzZShyZXRbZWtdKTt9Y2F0Y2goZXgpe2VSZXRbZWtdID0gcmV0W2VrXTsgfSB9KTsNCg0KICAgICAgICAgICAgICAgICAgICB2Lm9iaiA9IHtfcmV0dXJuOiBKU09OLnN0cmluZ2lmeShlUmV0KX07DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfVEhJUzogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuYk1hcCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICBvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKSk7DQogICAgICAgICAgICAgICAgICAgIG9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9Ow0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSBgIiR7dn0iYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5fX2tleXMpIG9iai5fX2tleXMucHVzaChlYUNvZGUpOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoITwlPV9iNjR0ZXN0KCd2JyklPil7IC8vIGlzIG5vdCBiYXNlNjQ/DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdGhpcy5fYnRvYSh2KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgIHYgPSB2JiZ2LnRvSVNPU3RyaW5nP3YudG9JU09TdHJpbmcoKTp2Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdj92LjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfWApOidudWxsJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sIHx8IGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0IHx8IGVhLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHRyTWFwKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgfHwgJ251bGwnOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9ICciJyArIHRyTWFwKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgKyAnIic7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gJ1snICsgKHYgfHwgW10pLm1hcCgoX3YsIF9pKSA9PiBfdi48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bJHtfaX1dYCkpLmZpbHRlcihfdiA9PiBfdikuam9pbigpICsgJ10nLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheSh2KSl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9IEpTT04uc3RyaW5naWZ5KHYpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0ck1hcChvYmosIGVmQ29kZSwgdiwgc1BhdGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlZil7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCE8JT1fYjY0dGVzdCgndicpJT4peyAvLyBpcyBub3QgYmFzZTY0Pw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLl9idG9hKHYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlZi5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdiYmdi50b0lTT1N0cmluZz92LnRvSVNPU3RyaW5nKCk6djsNCiAgICAgICAgPCUgfSU+DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtlZkNvZGVdID0gdjsNCiAgICAgICAgPCUgaWYoIWVmLklzQm9vbCAmJiAhZWYuSXNJbnQgJiYgIWVmLklzTG9uZyAmJiAhZWYuSXNGbG9hdCAmJiAhZWYuSXNEb3VibGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9ICciJyArIG9ialtlZkNvZGVdICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KDQogICAgICAgICAgICAgICAgX190ck1hcDogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXNQYXRoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5fX3RyTWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIDwlPXNjb3BlJT4uX190ck1hcDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICAgICBfcmV0dXJuOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvYmopIG9iai5fcmV0dXJuID0gKE9iamVjdC5rZXlzKG9ianx8e30pLmxlbmd0aCk/KCd7JyArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSk9PT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtvYmpba119YCkuY29uY2F0KE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSkhPT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtKU09OLnN0cmluZ2lmeShvYmpba10pfWApKS5qb2luKCkgKyAnfScpOidudWxsJzsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBvcHRpb25zLCBzUGF0aCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD9yZXQuX3JldHVybjpyZXQ7DQogICAgICAgICAgICByZXQgPSB0eXBlb2YocmV0KT09PSd1bmRlZmluZWQnP251bGw6cmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighc1BhdGggJiYgcmV0KXsNCiAgICAgICAgICAgICAgICByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsICdqYXZhc2NyaXB0Jyk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5wYXJzZSkgcmV0dXJuIEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmd6aXApIHJldHVybiB0aGlzLlV0ZjhBcnJheVRvU3RyKHRoaXMuX2NvbXByZXNzKHJldCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J190b0RvY3VtZW50JyU+KG9wdGlvbnM9e30pew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQganNvbiA9IHRoaXMuX3RvSlNPTihvcHRpb25zKTsNCiAgICAgICAgICAgIGxldCBvSlNPTiA9IEpTT04ucGFyc2UoanNvbik7DQogICAgICAgICAgICBsZXQgdHJNYXAgPSBvSlNPTi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgZGVsZXRlIG9KU09OLl9fdHJNYXA7DQogICAgICAgICAgICBqc29uID0gSlNPTi5zdHJpbmdpZnkob0pTT04pOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT4uLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Li4ucyk7DQogICAgICAgICAgICBsZXQgZXJyb3IgPSAoLi4ucykgPT4gPCU9ZXJyb3IoKSU+Li4ucyk7DQoNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiB0ck1hcCl7DQogICAgICAgICAgICAgICAgaWYoIW5ldyBSZWdFeHAodC5pZCkudGVzdChqc29uKSkgY29udGludWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHRybiA9IHRoaXMuX2F0b2IodC50cmFuc2Zvcm0pOw0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgb0pTT04gPSBKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICAgICAgICAgICAgICBsZXQgcmVzID0gdW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodHJuLnN0YXJ0c1dpdGgoInMoIikgJiYgdHJuLmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdGhpcy5ydW5TY3JpcHQoYChvSlNPTiwgb1Njb3BlLCBsb2csIHdhcm4sIGVycm9yKSA9PiAke3Rybi5zdWJzdHJpbmcoMiwgdHJuLmxlbmd0aC0xKX1gKShvSlNPTiwgPCU9c2NvcGUlPiwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXMgPSBhd2FpdCBqc29uYXRhKHRybikuZXZhbHVhdGUob0pTT04pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvLzwlPXdhcm4oKSU+dC5pZCwgcmVzLCB0cm4pOw0KICAgICAgICAgICAgICAgICAgICBqc29uID0ganNvbi5yZXBsYWNlKG5ldyBSZWdFeHAodC5pZCwgImciKSwgKCFBcnJheS5pc0FycmF5KHJlcykgJiYgdHlwZW9mKHJlcykhPT0nb2JqZWN0Jyk/cmVzOnRoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkocmVzKSkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+dC5pZCwgdHJuLCBleCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBqc29uID0ganNvbi5yZXBsYWNlKC8iX190ck1hcCI6XHNcW1x7W14+Pl0rXH1cXS9nbSwgJyJfX3RyTWFwIjogIiInKTsNCg0KICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYkpTT04/dGhpcy5fYmVhdXRpZnkoanNvbiwgJ2phdmFzY3JpcHQnKTpKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQo8JQ0KX2Nsb25lRnVuY3Rpb24gPSAobywgZiwgc2NvcGUsIGMpID0+IHsNCg0KICAgIGxldCBvYmogPSBudWxsOw0KICAgIGlmKG89PSdzcicgJiYgdHlwZW9mKHNyKSE9PSd1bmRlZmluZWQnKSBvYmogPSBzcjsNCiAgICBpZihvPT0nX0ZyRU1EJyAmJiB0eXBlb2YoX0ZyRU1EKSE9PSd1bmRlZmluZWQnKSBvYmogPSBfRnJFTUQ7DQogICAgDQogICAgbGV0IGNvZGUgPSBvYmpbZl0gPyBvYmpbZl0udG9TdHJpbmcoKSA6IGAgICAke2Z9KCl7DQogICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiBfY2xvbmVGdW5jdGlvbigke299LCAke2Z9KTogSW52YWxpZCBGdW5jdGlvbiBOYW1lJyk7DQogICAgfWA7DQogICAgbGV0IHMgPSBjb2RlLnJlcGxhY2UoJyknLCAnKSA9PiAnKTsNCiAgICBpZiAocy5pbmRleE9mKCdmdW5jdGlvbicpID09IDAgfHwgcy5pbmRleE9mKCdhc3luYyBmdW5jdGlvbicpID09IDApIHsNCiAgICAJcyA9IHMucmVwbGFjZSgnZnVuY3Rpb24nLCAnICcpOw0KICAgIH0gZWxzZSB7DQogICAgCXMgPSBzLnJlcGxhY2UoZiwgJycpOw0KICAgIH0NCg0KICAgIGlmIChjLklzTWFpbiAmJiAhb2JqW2ZdKSB7DQogICAgCWNvbnNvbGUubG9nKCdFcnJvciBpbiBfY2xvbmVGdW5jdGlvbigpOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUgJyArIGYpOw0KICAgIH0NCg0KICAgIHJldHVybiBgDQogICAgJHtmfSguLi5wYXJhbXMpew0KICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuJHtvfSkhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICByZXR1cm4gd2luZG93LiR7b30uJHtmfSguLi5wYXJhbXMpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGAgKyAoYy5Jc01haW4gPyBgcmV0dXJuICgke3N9KSguLi5wYXJhbXMpO2AgOiBgcmV0dXJuIG5ldyAke3Njb3BlfS4ke25OYW1lKG1haW5DbGFzcygpKX0oKS4ke2Z9KC4uLnBhcmFtcyk7YCkgKyBgDQogICAgICAgIH0NCgl9DQogICAgYDsNCn07DQoNCg0KW3sNCiAgICB3T2JqOiAnc3InLA0KICAgIGZ1bmN0aW9uczogWydoYXNoQ29kZScsICdFcXVhbHMnLCAnc2VydmVyRGF0ZScsICdfX3Njb3BlJywgJ2FkZE1TZWNvbmRzJywgJ2lwQWRkcmVzcyddLmNvbmNhdChtYWluQ2xhc3MoWydCSVNlcnZlciddKT9bJ18nLCAnYnVpbGRVUkwnLCAnJF9SRVFVRVNUJywgJ3BhcmFtJywgJ190b1hNTCcsICdjb29wJywgJ09SJywgJ215UmVwbGFjZScsICdzZW5kWE1MJywgJ3Byb2Nlc3NSZXNwb25zZScsICdwcm9jZXNzUmVzdWx0JywgJ3J1blNSU2NyaXB0JywgJ2dyb3VwQnknLCAnU2hvd0RlYnVnJywgJ2NhY2hlUmVzdWx0JywgJ3RvSGV4JywgJ1Nob3dFcnJvciddOltdKSwNCn0sIHsNCiAgICB3T2JqOiAnX0ZyRU1EJywNCiAgICBmdW5jdGlvbnM6IFsnX2F0dHInLCAncnVuU2NyaXB0JywgJ191bmlxdWUnLCAnc3InLCAnX2F0b2InLCAnX2dldFN0b3JlZFNjcmlwdCcsICdfYnRvYScsICdfX3RpbWUnLCAnX3dhaXQnLCAnX3NxbFR5cGUnLCAnX3V1aWQnLCAncmVxdWlyZScsICdfaW5jbHVkZScsICdfYmVhdXRpZnknLCAnX2luamVjdCcsICdfY29tcHJlc3MnLCAnX2RlY29tcHJlc3MnLCAnVXRmOEFycmF5VG9TdHInLCAncmFuZFVSTCddLA0KfV0uZm9yRWFjaChjYyA9PiB7ICU+DQovKiBTVEFSVDogPCU9Y2Mud09iaiU+IGZ1bmN0aW9uIGNvcGllcyAqLw0KPCUgY2MuZnVuY3Rpb25zLmZvckVhY2goZiA9PiB7JT4NCg0KLyogQ0xPTkU6OlNUQVJUOiA8JT1jYy53T2JqJT4uPCU9ZiU+KCkgKi88JT1fY2xvbmVGdW5jdGlvbihjYy53T2JqLCBmLCBzY29wZSwgYykgJT4vKiBDTE9ORTo6RU5EICA6IDwlPWNjLndPYmolPi48JT1mJT4oKSAqLw0KPCUgfSklPg0KLyogRU5EOiA8JT1jYy53T2JqJT4gZnVuY3Rpb24gY29waWVzICovDQo8JSB9KTsgJT4NCiAgICANCiAgICA8JT1tTmFtZT0naTE4biclPihldiwgdil7DQogICAgICAgIGlmKHR5cGVvZih3aW5kb3cpPT09InVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKT09PSJ1bmRlZmluZWQiKSByZXR1cm4gdjsNCiAgICAgICAgDQogICAgICAgIGlmKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpew0KICAgICAgICAgICAgcmV0dXJuIHY7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsNCiAgICAgICAgfQ0KICAgIH0NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bU5hbWU9J2J5JyArIG5OYW1lKGVhLkVudGl0eVR5cGUpJT4oYXIpIHsNCiAgICAgICAgdmFyIHJldCA9IFtdOw0KICAgICAgICBhci5mb3JFYWNoKGEgPT4gew0KICAgICAgICAgICAgcmV0LmZvckVhY2gociA9PiB7DQogICAgICAgICAgICAgICAgaWYgKGFbIl88JT1uTmFtZShlYSklPiJdICYmIChhWyJfPCU9bk5hbWUoZWEpJT4iXS5FcXVhbHM/YVsiXzwlPW5OYW1lKGVhKSU+Il0uRXF1YWxzKHIpOnNyLkVxdWFscyhhWyJfPCU9bk5hbWUoZWEpJT4iXSwgcikpKSB7DQogICAgICAgICAgICAgICAgICAgIHIuXzwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+LnB1c2goYSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0pJT4NCg0KICAgIDwlPW1OYW1lPSdnZXQgX1RvU3RyaW5nJyU+KCkgew0KICAgICAgICByZXR1cm4gdGhpcy50b1N0cmluZygpOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0ndG9TdHJpbmcnJT4oKSB7DQogICAgICAgIGxldCByZXQgPSBbXTsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikgcmV0LnB1c2godGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KCk8JX0lPik7DQo8JSB9KSU+DQogICAgICAgIHJldHVybiByZXQuam9pbignLScpOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdFbnRpdHlWYWx1ZSclPihhTmFtZSkgew0KICAgICAgICBsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpew0KICAgICAgICAgICAgLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUNCiAgICAgICAgICAgIHJldCA9IHtBY3RpdmU6IHRydWUsIE9QRVJBVE9SUzoge30sIEVudGl0eUF0dHJpYnV0ZToge05hbWU6IGFOYW1lLCBBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB7SWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWR9fX07DQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J2ZpbmQnJT4oZGVwdGggPSAxLCBvYmpzLCBmaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgsIG9ianMsIG51bGwsIG51bGwsIGZpZWxkcykpWzBdOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfX2Fzc2VydFZhbGlkJyU+KGJTeW5jKXsNCjwlIGlmKCFjLlRvb2xzLmxlbmd0aCl7JT4NCiAgICAgICAgcmV0dXJuIHRydWU7DQo8JSB9ZWxzZXslPg0KICAgICAgICBsZXQgZXJyb3IgPSB7fTsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KXsNCiAgICAgICAgICAgIGVycm9yLjwlPW5OYW1lKGVhKSU+ID0ge307DQogICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBlcnJvci48JT1uTmFtZShlYSklPlsiMDEiXSA9ICJOb3QgU2V0IjsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKCF0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIGVycm9yLjwlPW5OYW1lKGVhKSU+WyIwMiJdID0gIkVtcHR5IFZhbHVlIjsNCiAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiBiU3luYyAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLl9fc3luY19vbigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDMiXSA9ICJOb3QgaW4gU3luYyI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKGVycm9yLjwlPW5OYW1lKGVhKSU+KS5sZW5ndGgpIGRlbGV0ZSBlcnJvci48JT1uTmFtZShlYSklPjsNCiAgICAgICAgfQ0KICAgIDwlIH0pJT4NCg0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKXsNCiAgICAgICAgICAgIHRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOw0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXJyb3IsbnVsbCw0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfcmFuayclPihfPCU9bU5hbWUlPj0wKXsNCgkJdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHtfPCU9bU5hbWUlPjogXzwlPW1OYW1lJT59LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2LnJldXNlZD92Lm9iai5fX3JldXNlZCA9IHYucmV1c2VkOjAsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSAiPCU9X2NOYW1lKGMsIHRydWUpJT4iLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5fPCU9bU5hbWUlPiArPSAob2JqW2VhQ29kZV0gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKS5fPCU9bU5hbWUlPiwNCgk8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIHRhQ29kZSwgdikgPT4gKG9ialt0YUNvZGVdID0gW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlUeXBlLCB0cnVlKSU+KCldLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKSkuZm9yRWFjaCh2ID0+IHYuXzwlPW1OYW1lJT4pLA0KICAgIDwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCgl9DQoNCiAgICA8JT1tTmFtZT0nX2lzUXVlcnknJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoLypfX3R5cGUqL3tJZDogIjwlPW5OYW1lKGMpJT4iLCA8JT1tTmFtZSU+Q291bnQ6IDB9LCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgdW5kZWZpbmVkfTsNCiAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IHR5cGVvZihvYmpbZWFDb2RlXS5fY29vcCk9PT0idW5kZWZpbmVkIj8wOjE7DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LjwlPW1OYW1lJT4pew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXS5fb2JqZWN0ID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1tTmFtZSU+Q291bnQgKz0gb2JqW2VhQ29kZV0uX29iamVjdC48JT1tTmFtZSU+Q291bnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmpbdGFDb2RlXSA9IHtfY29vcDogdGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCB1bmRlZmluZWQsIF9vYmplY3RzOiAodnx8W10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpfTsNCiAgICAgICAgICAgICAgICBpZihvYmpbdGFDb2RlXS5fb2JqZWN0cy5sZW5ndGgpIG9ialt0YUNvZGVdLjwlPW1OYW1lJT5Db3VudCArPSBvYmpbdGFDb2RlXS5fb2JqZWN0cy5yZWR1Y2UoKHYsIG8pID0+IHYgKz0gby48JT1tTmFtZSU+Q291bnQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX25ldyclPihjbE5hbWUsIHRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsTmFtZSwgdG9vbCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzd2l0Y2goY2xOYW1lKXsNCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uTmFtZShfYyklPiI6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoX2MsIHRydWUpJT4odW5kZWZpbmVkLCB0b29sKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nc3RvcmUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAvKioqIFNUQVJUIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgICAgICANCiAgICAgICAgbGV0IGJVcGRhdGUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGJJbnNlcnQgPSBmYWxzZTsNCg0KICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+InN0b3JpbmcgZGlzYWJsZWQiKTsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5faXNRdWVyeSgpLl9pc1F1ZXJ5Q291bnQpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHN0b3JlIGEgcXVlcnkhIik7DQogICAgICAgIH1lbHNlIGlmKCF0aGlzLl9fc3luY19vbigpIHx8IDwlPV9GckVNRC5fdG9KUyhfZmlsZVRvb2xzKSU+LmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk+PTApew0KICAgICAgICAgICAgbGV0IF90aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYkZpbmQgPSBmYWxzZTsNCiAgICAgICAgICAgIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgIGJGaW5kID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBfdGhpcy5JZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICB9DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KXsNCiAgICAgICAgICAgICAgICBiRmluZCA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuPCU9bk5hbWUoZWEpJT4odGhpcy48JT1uTmFtZShlYSklPigpLCAnPScpOw0KICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGlmKGJGaW5kKXsNCiAgICAgICAgICAgICAgICBfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsNCiAgICAgICAgICAgIH1lbHNlIF90aGlzID0gbnVsbDsNCiAgICAgICAgICAgIGlmKF90aGlzKXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gX3RoaXMuSWQ7DQogICAgICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24oX3RoaXMuX19zeW5jX29uKCkpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7DQogICAgICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUNCiAgICAgICAgICAgICAgICBiSW5zZXJ0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsiPCIrdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICBpZighYlVwZGF0ZSAmJiAhYkluc2VydCl7DQogICAgICAgICAgICA8JT1sb2coKSU+Ik5vIGRhdGEgY2hhbmdlcyIpOw0KICAgICAgICB9ZWxzZXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uKT09PSJ1bmRlZmluZWQiIHx8IDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiA9IHtPd25lcjogdGhpcywgc3FsczogW10sIHN0YXJ0OiBuZXcgRGF0ZSgpLCBlbmQ6IG51bGx9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIShhd2FpdCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPigpKSkgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YD09PT4gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIGlmKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7DQogICAgICAgICAgICBpZihiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmA8PT09IEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSl7DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU3luY2luZy4uLjwlPXRhTmFtZSU+IiwgdGEpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0YS48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGJVcGRhdGUgfHwgYkluc2VydCl7DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLk93bmVyPT10aGlzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdpbnNlcnQnJT4oKXsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLlRvb2wuZGIuZ2V0Q29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikuaW5zZXJ0T25lKHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS5pbnNlcnRPbmUoJHt0aGlzLl90b0pTT04oe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uPCU9bU5hbWUlPih0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJLYWZrYSIpIHslPg0KICAgICAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJyk7DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5wdXNoKHRoaXMpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJOZW80aiIpIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2FsZXNGb3JjZSIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+LklkOw0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgICAgIGxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7DQogICAgDQogICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIjwlPW5OYW1lKGMpJT4iKS5jcmVhdGUob2JqKTsNCiAgICAgICAgICAgIHRoaXMuSWQgPSByZXMuaWQ7DQogICAgPCUgfSBlbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKSB7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlNlcnZpY2VOb3ciKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIGF3YWl0IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKSk7DQogICAgPCUgfSBlbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuSWQgPSAoYXdhaXQgdGhpcy5fdG9FTVNPYmplY3QoKS5zdG9yZSgpKS5JZDsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIGxldCBvYmogPSB7fTsNCiAgICAgICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQvKl9pZCgpKi87DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5Db2RlKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgbG9nKCI8JT10JT4gVVJMIiwgdXJsKTsNCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbG9nKCJyZXN1bHQiLCByZXMuZGF0YSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmVzLmRhdGEpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCBpbnNPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0SW5zZXJ0IiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCBudWxsLCAyKTsNCiAgICAgICAgICAgIGlmKCFpbnNPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5JZCA9IGluc09iai5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gaW5zT2JqLkVudGl0eVZhbHVlczsNCiAgICAgICAgICAgIHRoaXMuX3JldmVydCgpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSAlPg0KDQogICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSd1cGRhdGUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KDQogICAgPCUgaWYodCA9PSAiTW9uZ29EQiIpIHslPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLnVwZGF0ZU9uZSh7X2lkOiB0aGlzLklkfSwgeyRzZXQ6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pOw0KICAgICAgICAgICAgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGBkYi5nZXRDb2xsZWN0aW9uKCckezwlPV9uQ29kZSgpJT59JykudXBkYXRlT25lKHtfaWQ6ICcke3JldC5faWR9J30sIHskc2V0OiAke3RoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPlt0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5maW5kSW5kZXgobyA9PiBvLklkPT10aGlzLklkKV0gPSB0aGlzOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5wcm9kdWNlci5zZW5kKHsNCiAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7DQogICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KQ0KICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nY2FsbDogJyArIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ncmVzcG9uc2U6ICcsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5TWVyZ2UoKSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOw0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07DQogICAgPCUgfWVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksICdwdXQnKSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TT2JqZWN0KCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZW5kaW5nIHVwZGF0ZSB0byBSRVNUREJJTyB0byBzYXZlIik7DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICIvIiArIHRoaXMuSWQ7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+IlVwZGF0ZSB0byBSRVNUREJJTyIsIHVybCk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MucHV0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IHVwZE9iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RVcGRhdGUiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIDIpOw0KICAgICAgICAgICAgaWYoIXVwZE9iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb3B5RnJvbSh1cGRPYmopOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOw0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KDQogICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kQWxsJyU+KGRlcHRoID0gMSwgb2Jqcz1bXSwgc3RhcnQsIGVuZCwgZmllbGRzKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkNCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiKXsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLmZpbmQodGhpcy5fdG9TZWxlY3RNb25nb0RCKGZpZWxkcywgb2JqcykpLnRvQXJyYXkoKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUnhEQiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5Ub29sLmRiWzwlPV9uQ29kZShjKSU+XS5maW5kKHRoaXMuX3RvU2VsZWN0UnhEQihmaWVsZHMsIG9ianMpKS5leGVjKCk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJFTVMiKXsgJT4NCiAgICAgICAgICAgIGxldCBvID0gdGhpcy5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSBvID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5T2JqZWN0KCkuVEhJUyhbb10uY29uY2F0KG9ianMubWFwKF9vID0+IF9vLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKSkpKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5T2JqZWN0KG8pLjwlPW1OYW1lJT4oKSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNZW1vcnkiKXsgJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzLlRvb2wuZGJbPCU9X25Db2RlKCklPl0uZmlsdGVyKG8gPT4gbyAmJiB0aGlzLl9zYW1lRW50aXR5KG8pKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iSHViU3BvdCIpeyAlPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7ICU+DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7c3lzcGFybV9xdWVyeTogdGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSl9KSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTYWxlc0ZvcmNlIil7ICU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7dXJsOiAncmVzdC51cmwuZ3FsJ30pOw0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBsZXQgZE5hbWUgPSB0aGlzLl90b0ZpbGVOYW1lKCkuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSkuam9pbignLycpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgZExpc3QgPSBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPihkTmFtZSk7DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT4iZE5hbWUiLCBkTmFtZSwgdGhpcy5fdG9GaWxlTmFtZSgpLCAiZExpc3QiLCBkTGlzdCk7DQogICAgICAgICAgICBsZXQgaWR4TGlzdCA9IChkTGlzdCB8fCBbXSkuZmlsdGVyKHIgPT4gdHlwZW9mKHIubmFtZSkhPT0ndW5kZWZpbmVkJykubWFwKHIgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fZnJvbUZpbGVOYW1lKHIubmFtZSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJpZHhMaXN0IiwgaWR4TGlzdCwgaWR4TGlzdC5tYXAociA9PiByLl90b0ZpbGVOYW1lKCkpKTsNCiAgICAgICAgICAgIGlkeExpc3QgPSBpZHhMaXN0LmZpbHRlcihyID0+IHIuX21hdGNoZXModGhpcywge29ubHlVbmlxdWU6IHRydWV9KSk7DQogICAgICAgICAgICA8JT1sb2coKSU+ImlkeExpc3QgZmlsdGVyZWQiLCBpZHhMaXN0KTsgDQoNCiAgICAgICAgICAgIGlmKGlkeExpc3QubGVuZ3RoPT0xKXsNCiAgICAgICAgICAgICAgICByZXQucHVzaChhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPihkTmFtZSArICcvJyArIGlkeExpc3RbMF0uX3RvRmlsZU5hbWUoKS5zcGxpdCgnLycpLnNsaWNlKC0xKS5qb2luKCcvJykpKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldCA9IGlkeExpc3Q7DQogICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYodD09Ik5lbzRqIil7ICU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5UXVlcnkoZmllbGRzLCBvYmpzKSk7DQogICAgPCUgfWVsc2UgaWYodD09IlJlc3REQklPIil7ICU+DQogICAgICAgICAgICBsZXQgdGhpc0RvYyA9IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KTsNCiAgICAgICAgICAgIGxldCBlYUNvZGUgPSAiIjsNCiAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBlYUNvZGUgPSA8JT1fbkNvZGUoZWEpJT47DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7ICU+DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0FycmF5KXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iIT0iKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkbmluIjogdGhpc0RvY1tlYUNvZGVdfTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkaW4iOiB0aGlzRG9jW2VhQ29kZV19Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCl7ICU+DQogICAgICAgICAgICAgICAgaWYoW251bGwsICclJywgJ0xJS0UnXS5pbmRleE9mKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPi0xKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkcmVnZXgiOiB0aGlzRG9jW2VhQ29kZV0gfHwgIi4qIn07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9KTsgJT4NCg0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpICsgIj9xPSIgKyBKU09OLnN0cmluZ2lmeShjb25kaXRpb25zKTsNCiAgICAgICAgICAgIHJldCA9IChhd2FpdCBheGlvcy5nZXQodXJsLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJCSVNlcnZlciIpeyAlPg0KICAgICAgICAgICAgbGV0IHEgPSB7DQogICAgICAgICAgICAgICAgVEhJUzogdGhpcy5fYnVpbGRUaGlzKGRlcHRoKS5jb25jYXQoKG9ianMgfHwgW10pLm1hcChvYmogPT4gb2JqLnRvRW50aXR5T2JqZWN0P3sNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSwNCiAgICAgICAgICAgICAgICB9Om9iaikpLA0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHsgLy8gYWJzb2x1dGVseSByZXF1aXJlZCBmb3IgaW5kZXhpbmcNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgICAgICA8JT1sb2coKSU+cSk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXNPYmplY3RzKChhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kYWxsIiwgbnVsbCwgcSkpKTsNCiAgICA8JSB9ICU+DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICA8JT1sb2coKSU+IkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCBkZXB0aCwgcmV0KTsNCiAgICAgICAgDQogICAgICAgIGlmKCFBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IFtyZXRdOw0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSkpLmZpbHRlcihyID0+IHIpLm1hcChyID0+IHIuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsNCg0KICAgICAgICBpZihkZXB0aD4xKXsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgciBvZiByZXQpew0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgaWYoci5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT1uTmFtZShlYSklPiIsIHIuPCU9bk5hbWUoZWEpJT4oKS5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgci48JT1uTmFtZShlYSklPihhd2FpdCByLl88JT1uTmFtZShlYSklPi5maW5kKGRlcHRoLTEpKTsNCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgPCUgaWYoX2ZpbGVUb29scy5pbmRleE9mKHQpPj0wKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgbGV0IHJfPCU9dGFOYW1lJT4gPSBbXTsNCiAgICAgICAgICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBfdGEgb2Ygci48JT10YU5hbWUlPigpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iPCU9dGFOYW1lJT4iLCBfdGEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcl88JT10YU5hbWUlPi5wdXNoKGF3YWl0IF90YS5maW5kKGRlcHRoLTEpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByLmNsZWFyXzwlPXRhTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9dGFOYW1lJT4ocl88JT10YU5hbWUlPik7DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPXRhTmFtZSU+Iiwgci48JT10YU5hbWUlPigpKTsNCiAgICAgICAgICAgICAgICAgICAgci48JT10YU5hbWUlPihhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1uTmFtZSh0YSklPihyKQ0KICAgICAgICAgICAgPCUgaWYoZmFsc2UgJiYgWydTcWxEQiddLmluZGV4T2YodCk+PTApeyAvLyBzcWwgc3RhdGVtZW50cyBkbyBub3QgaW5jbHVkZSBsZWZ0IGpvaW5zIHdpdGhvdXQgZXhwbGljaXQgcmVmZXJlbmNlcyAlPg0KICAgICAgICAgICAgICAgICAgICAgICAgPCV0YS5FbnRpdHlDbGFzcy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgZWEhPXRhKS5mb3JFYWNoKGVhID0+IHslPi48JT1uTmFtZShlYSklPihuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpPCV9KSU+DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIC48JT1tTmFtZSU+KGRlcHRoLTEpKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0pJT4NCjwlIH0pJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGxldCByZWZzID0gcmV0LmZpbHRlcihyID0+IHIuRW50aXR5Q2xhc3MpOw0KICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IG8gb2YgKG9ianMgfHwgW10pLmZpbHRlcihfbyA9PiAhX28uX19zeW5jX29uKCkpKXsNCiAgICAgICAgICAgIGlmKG8uX3RvRU1TT2JqZWN0KXsNCiAgICAgICAgICAgICAgICByZWZzLnB1c2goLi4uKGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkuPCU9bU5hbWUlPihkZXB0aCkpKSk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZWZzLnB1c2goLi4uKGF3YWl0IG8uPCU9bU5hbWUlPihkZXB0aCkpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZWZzID0gcmVmcy5maWx0ZXIociA9PiByKTsNCiAgICAgICAgDQogICAgICAgIHJlZnMuZm9yRWFjaChyID0+IHIuX3Jlc29sdmUocmVmcykpOw0KDQogICAgICAgIDwlPWxvZygpJT4iT3V0cHV0IiwgcmV0KTsNCg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgICAgIC8qKiogRU5EIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgIH0sIHtkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzLCBfX2JlZm9yZVJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5CZWZvcmUpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgX19hZnRlclJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5BZnRlcikubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dfSk7DQoNCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogW119KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3Jlc29sdmUnJT4ocmVmcyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFyZWZzLmxlbmd0aCkgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuX19pbXBvcnQoe30sIHsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46ICgpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy48JT1uTmFtZShlYSklPigpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9bk5hbWUoZWEpJT4iLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQsIHJlZnMubWFwKHIgPT4gKHtpZDogci5JZCwgY29kZTogci5jb2RlKCl9KSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPihyZWZzLmZpbmQobyA9PiBvLklkPT10aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQpIHx8IHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KHJlZnMpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAoKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9dGFOYW1lJT4oKS5sZW5ndGgpIHRoaXMuPCU9dGFOYW1lJT4odGhpcy48JT10YU5hbWUlPigpLm1hcCh0YSA9PiByZWZzLmZpbmQobyA9PiBvLklkPT10YS5JZCkgfHwgdGEuPCU9bU5hbWUlPihyZWZzKSksIG51bGwsIHRydWUpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQo8JSBpZihtYWluQ2xhc3MoWydFTVMnXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19mcm9tRU1TVmFsdWVzJyU+KGV2cyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRU1TJ10pPT1jKXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhldnMsIFsuLi5uZXcgU2V0KGV2cy5tYXAodiA9PiB2LmVudGl0eUF0dHJpYnV0ZSgpLklkKS5mbGF0KCkpXS5tYXAoaWQgPT4gbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKGlkKSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmV2cyk7DQogICAgICAgIA0KICAgICAgICAgICAgbGV0IG9ianMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeShldnMsICJfZW50aXR5T2JqZWN0IikuZm9yRWFjaChldmcgPT4gew0KICAgICAgICAgICAgICAgIGV2Zy5rZXkuZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcyhldmcudmFsdWVzKTsNCiAgICAgICAgICAgICAgICBvYmpzLnB1c2goZXZnLmtleSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgb2Jqcy5mb3JFYWNoKHIgPT4gci5lbnRpdHlDbGFzcyhyLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoKVswXS5lbnRpdHlBdHRyaWJ1dGUoKS5lbnRpdHlDbGFzcygpKSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgciBvZiBvYmpzKXsNCiAgICAgICAgICAgICAgICByZXQucHVzaChhd2FpdCBuZXcgPCU9c2NvcGUlPltyLmVudGl0eUNsYXNzKCkubmFtZSgpXSgpLl9mcm9tRU1TT2JqZWN0KHIpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCV9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnRU1TJ10sYykpJT4oKS48JT1tTmFtZSU+KGV2cyk7DQogICAgPCV9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0VNU0NsYXNzJyU+KGRlcHRoKXsNCiAgICAgICAgLy8gd2h5IG5vdCBfX2V4cG9ydCA/DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlDbGFzcygnPCU9Yy5JZCU+JykubmFtZSgiPCU9Yy5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShjKSU+IikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZGF0ZShuZXcgRGF0ZSgpKS5jb21wYW55KG5ldyA8JT1zY29wZSU+LkNvbXBhbnkoKS5uYW1lKCI8JT1zY29wZSU+IikuY29kZSgiPCU9c2NvcGUlPiIpKS5lbnRpdHlNb2R1bGUobmV3IDwlPXNjb3BlJT4uRW50aXR5TW9kdWxlKCkuY29kZSgiPCU9c2NvcGUlPiIpLm5hbWUoIjwlPXNjb3BlJT4iKSk7DQogICAgICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldC5lbnRpdHlDbGFzc19FbnRpdHlNZXRob2RzKFsNCiAgICA8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LkVudGl0eU1ldGhvZCgnPCU9bS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9bS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShtKSU+IikuZW50aXR5TWV0aG9kX0VudGl0eUF0dHJpYnV0ZXMoWw0KICAgICAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPXAuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPXAuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUocCklPiIpLmlzQXJyYXkoPCU9cC5Jc0FycmF5Pyd0cnVlJzonZmFsc2UnJT4pLnJlbWFyaygiPCU9Yy5OYW1lJT4uPCU9bS5OYW1lJT4oKSIpLmVudGl0eUNsYXNzKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpDQogICAgICAgICAgICA8JSBpZihwLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIocCklPih0cnVlKQ0KICAgICAgICAgICAgPCUgfSU+LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgXSkucmVzcG9uc2VBdHRyaWJ1dGUobmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1tLlJlc3BvbnNlQXR0cmlidXRlLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1tLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUpJT4iKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKQ0KICAgICAgICA8JSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSU+KCkuPCU9bU5hbWUlPihkZXB0aC0xKSkNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIobS5SZXNwb25zZUF0dHJpYnV0ZSklPih0cnVlKQ0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICApLA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pLmVudGl0eUNsYXNzX0VudGl0eUF0dHJpYnV0ZXMoWw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPWVhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1lYS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShlYSklPiIpLnJlbWFyaygnPCU9Yy5OYW1lJT4uPCU9ZWEuTmFtZSU+JykNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihkZXB0aC0xKSkNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIoZWEpJT4odHJ1ZSkNCiAgICAgICAgPCUgfSU+LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19mcm9tRU1TT2JqZWN0JyU+KG9iail7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHRoaXMuSWQgPSBvYmouSWQ7DQogICAgICAgICAgICBsZXQgZXYgPSBudWxsOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGV2ID0gb2JqLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoKS5maW5kKGV2ID0+IGV2LmVudGl0eUF0dHJpYnV0ZSgpLmNvZGUoKT09PCU9X25Db2RlKGVhKSU+KTsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKGV2KSB0aGlzLjwlPW5OYW1lKGVhKSU+KGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KGV2Lm9iamVjdFZhbHVlKCkpKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIGlmKGV2KSB0aGlzLjwlPW5OYW1lKGVhKSU+KGV2LjwlPV9GckVNRC5fYXR0cihlYSkudG9Mb3dlckNhc2UoKSU+VmFsdWUoKSk7DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICA8JSB9KSU+DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9FTVNPYmplY3QnJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKXsNCiAgICAgICAgbGV0IHJldCA9IG5ldyA8JT1zY29wZSU+LkVudGl0eU9iamVjdCgpLmFjdGl2ZSh0cnVlKS5lbnRpdHlDbGFzcyh0aGlzLl90b0VNU0NsYXNzKCkpOw0KDQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBGdWxsOiAhYlF1ZXJ5LA0KICAgICAgICAgICAgLy9OdWxsOiAhYlF1ZXJ5LA0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLklkID0gdiwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGV2ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5QXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9ZWEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPWVhLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKGVhKSU+IikuZW50aXR5Q2xhc3ModGhpcy5fdG9FTVNDbGFzcygpKSk7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgZXYub2JqZWN0VmFsdWUodj92LjwlPW1OYW1lJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKTpudWxsLCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpLnRvTG93ZXJDYXNlKCklPlZhbHVlKHYsIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICBvYmouZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcyhldiwgJz09Jyk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKHYgJiYgYlR5cGVkQXR0cmlidXRlcykgb2JqLm9iamVjdFZhbHVlX0VudGl0eVZhbHVlcyh2Lm1hcChfdiA9PiBuZXcgPCU9c2NvcGUlPi5FbnRpdHlWYWx1ZSgpLmFjdGl2ZSh0cnVlKS5lbnRpdHlBdHRyaWJ1dGUobmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT10YS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSgiPCU9bk5hbWUodGEpJT4iKS5uYW1lKCI8JT10YS5OYW1lJT4iKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl90b0VNU0NsYXNzKCkpKS5vYmplY3RWYWx1ZShfdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcykpKSwgJz09Jyk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9ICU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfYXNPYmplY3RzJyU+KGV2cyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSkhPWMpeyU+DQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSxjKSklPigpLjwlPW1OYW1lJT4oZXZzKTsNCiAgICA8JX1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihldnMpPT09InVuZGVmaW5lZCIgfHwgIWV2cyB8fCAhQXJyYXkuaXNBcnJheShldnMpIHx8ICFldnMubGVuZ3RoKSByZXR1cm4gW107DQoNCiAgICAgICAgICAgIGV2cy5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICBldi5FbnRpdHlBdHRyaWJ1dGUgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5JZD09ZXYuRW50aXR5QXR0cmlidXRlaWQpOw0KICAgICAgICAgICAgICAgIGV2LkVudGl0eU9iamVjdC5FbnRpdHlDbGFzcyA9IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlDbGFzczsNCiAgICAgICAgICAgICAgICBpZihldi5PYmplY3RWYWx1ZSl7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlLkVudGl0eUNsYXNzID0gPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoZWMgPT4gZWMuSWQ9PWV2Lk9iamVjdFZhbHVlLkVudGl0eUNsYXNzLklkKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIGxldCBvYmogPSBbXTsNCiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeShldnMsICJFbnRpdHlPYmplY3QiKS5mb3JFYWNoKGV2ZyA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGMgPSBuZXcgPCU9c2NvcGUlPltldmcua2V5LkVudGl0eUNsYXNzLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpOw0KICAgICAgICAgICAgICAgIGMuRW50aXR5VmFsdWVzID0gZXZnLnZhbHVlczsNCiAgICAgICAgICAgICAgICBjLlZhbHVlRW50aXRpZXMgPSBbXTsNCiAgICAgICAgICAgICAgICAvLyBjLkVudGl0eUNsYXNzID0gZXZnLmtleS5FbnRpdHlDbGFzczsNCiAgICAgICAgICAgICAgICBjLklkID0gZXZnLmtleS5JZDsNCiAgICAgICAgICAgICAgICBldmcudmFsdWVzLmZvckVhY2godiA9PiB2LkVudGl0eU9iamVjdCA9IGMpOw0KICAgICAgICAgICAgICAgIG9iai5wdXNoKGMpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIGV2cy5maWx0ZXIoZXYgPT4gZXYuT2JqZWN0VmFsdWUpLmZvckVhY2goZXYgPT4gew0KICAgICAgICAgICAgICAgIHZhciBfZiA9IG9iai5maW5kKG8gPT4gby5JZCA9PSBldi5PYmplY3RWYWx1ZS5JZCk7DQogICAgICAgICAgICAgICAgaWYoX2YpIF9mLlZhbHVlRW50aXRpZXMucHVzaChldik7DQogICAgICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSBfZjsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgICAgIG9iai5mb3JFYWNoKG8gPT4gew0KICAgICAgICAgICAgICAgIGlmKG8uRW50aXR5Q2xhc3MgJiYgby5FbnRpdHlDbGFzcy5JZCE9dGhpcy5FbnRpdHlDbGFzcy5JZCkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgcmV0LnB1c2gobyk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldC5tYXAobyA9PiBvLl9yZXZlcnQoKSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JX0lPg0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3JldmVydCclPihlbykgew0KICAgICAgICBpZiAoZW8pIHsNCiAgICAgICAgICAgIC8vIHJldmVydCBmcm9tIHNvdXJjZSBkYXRhDQogICAgICAgICAgICBpZihlby5FbnRpdHlDbGFzcyAmJiAoKHRoaXMuRW50aXR5Q2xhc3MuSWQgJiYgZW8uRW50aXR5Q2xhc3MuSWQhPXRoaXMuRW50aXR5Q2xhc3MuSWQpIHx8ICh0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgZW8uRW50aXR5Q2xhc3MuTmFtZSE9dGhpcy5FbnRpdHlDbGFzcy5OYW1lKSkpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJDYW5ub3QgcmV2ZXJ0ICIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLkVudGl0eUNsYXNzKSArICIgZnJvbSAiICsgZW8uRW50aXR5Q2xhc3MuTmFtZSwgZW8pOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5JZCA9IGVvLklkOw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMgPSBlby5FbnRpdHlWYWx1ZXMgfHwgW107DQogICAgICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBlby5WYWx1ZUVudGl0aWVzIHx8IFtdOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuPCU9bU5hbWUlPigpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaWYodGhpcy5fX3N5bmNfb24oKSAmJiBNYXRoLmFicygobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IDUpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+Ik9iamVjdCBhbHJlYWR5IHJldmVydGVkIiwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KICAgICAgICANCiAgICAgICAgICAgIC8vIHVzZSBFbnRpdHlWYWx1ZXMgYW5kIFZhbHVlRW50aXRpZXMgdG8gcmV2ZXJ0IHRoZSBhdHRyaWJ1dGUgdmFsdWVzDQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZWEgPSBudWxsOw0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgZWEgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKF9lYSA9PiBfZWEuRW50aXR5Q2xhc3MuTmFtZT09JzwlPWMuTmFtZSU+JykuZmluZChfZWEgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlaWQ9PV9lYS5JZCkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlLklkPT1fZWEuSWQpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlLk5hbWU9PV9lYS5OYW1lKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIGlmKCFlYSl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJ1bmFibGUgdG8gZGV0ZWN0IGF0dHJpYnV0ZSBmcm9tIHZhbHVlIiwgZXYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT5ldiwgZXgpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgbGV0IHYgPSBldlsodGhpc1siX2F0dHIiXT90aGlzOl9GckVNRCkuX2F0dHIoZWEpICsgIlZhbHVlIl07DQogICAgICAgICAgICAgICAgbGV0IHAgPSBlYS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodGhpc1twXSkhPT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iaW52YWxpZCB0eXBlIiwgZWEsIHAsIHYpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgZWEuRW50aXR5VHlwZSAmJiB0eXBlb2Yodik9PT0nb2JqZWN0Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4icmV2ZXJ0aW5nICIgKyBlYS5OYW1lLCB2LCBuZXcgPCU9c2NvcGUlPltlYS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odikpOw0KICAgICAgICAgICAgICAgICAgICBpZighdi5FbnRpdHlWYWx1ZXMpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iZW1wdHkgdmFsdWVzIGZvciAiICsgZWEuTmFtZSwgdik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdiA9IHYuPCU9bU5hbWUlPj92LjwlPW1OYW1lJT4oKTpuZXcgPCU9c2NvcGUlPltlYS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXNbcF0odik7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzLmZpbHRlcih2ZSA9PiB2ZS5FbnRpdHlBdHRyaWJ1dGUpLmZvckVhY2godmUgPT4gew0KICAgICAgICAgICAgICAgIHZhciB0YSA9IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklkPT12ZS5FbnRpdHlBdHRyaWJ1dGUuSWQpOw0KICAgICAgICAgICAgICAgIGlmKCF0YSkgcmV0dXJuIG51bGw7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgdmFyIHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7DQoNCiAgICAgICAgICAgICAgICBsZXQgdiA9IHZlLkVudGl0eU9iamVjdDsNCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgdiA9IHYuPCU9bU5hbWUlPj92LjwlPW1OYW1lJT4oKTpuZXcgPCU9c2NvcGUlPlt0YS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXNbdGEuTmFtZS5yZXBsYWNlKC8gL2csICJfIikgKyAiXyIgKyB0YU5hbWVdKHYpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdmFsdWVDbGFzcyclPigpew0KICAgICAgICBsZXQgX2NsYXNzID0ge0FjdGl2ZTogdHJ1ZX07DQogICAgICAgIGlmKHRoaXMuRW50aXR5Q2xhc3MuRW50aXR5TW9kdWxlKXsNCiAgICAgICAgICAgIF9jbGFzcy5FbnRpdHlNb2R1bGUgPSB0aGlzLkVudGl0eUNsYXNzLkVudGl0eU1vZHVsZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBfY2xhc3MgPSB7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIENvbXBhbnk6IHtBY3RpdmU6IHRydWUsIEVuYWJsZWQ6IHRydWUsIEVudGl0eUNsYXNzZXM6IFt0aGlzLkVudGl0eUNsYXNzXX0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9jbGFzczsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvWE1MJyU+KCl7DQogICAgICAgIC8vIGFuIG92ZXJsb2FkIG9mIHRoZSBzci5fdG9YTUwNCiAgICAgICAgbGV0IHJldCA9IHt4bWw6IGBgfTsNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC54bWwgKz0gYDwke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J0lkJ30+JHt2fTwvJHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCd9PmAsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwke2VhQ29kZX0+YDsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICByZXQueG1sICs9IHY/di48JT1tTmFtZSU+KCk6bnVsbDsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8IVtDREFUQVske3Z9XV0+YDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPC8ke2VhQ29kZX0+YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCR7ZWFDb2RlfT5gICsgdi5tYXAoX3YgPT4gJzxPYmplY3Q+JyArIF92LjwlPW1OYW1lJT4oKSArICI8L09iamVjdD4iKS5qb2luKCcnKSArIGA8LyR7ZWFDb2RlfT5gOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQueG1sOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfYnVpbGRUaGlzJyU+KGRlcHRoPTEpew0KICAgICAgICAvLyBjYW5kaWRhdGUgZm9yIF9fZXhwb3J0DQogICAgICAgIHZhciByZXQgPSBbew0KICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7QWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpfSwNCiAgICAgICAgICAgIEVudGl0eU9iamVjdDogdGhpcy50b0VudGl0eU9iamVjdCh0cnVlKSwNCiAgICAgICAgfV07DQogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IGRlcHRoOyBpKyspIHsNCiAgICAgICAgICAgIHJldC5wdXNoKHsNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3JldFtpIC0gMV1dDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7JT4NCiAgICAgICAgaWYoZGVwdGg+MSl7DQogICAgICAgICAgICBsZXQgdiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdj92LnRvRW50aXR5T2JqZWN0KHRydWUpOm51bGwsDQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIHJldC5wdXNoKHsNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbew0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB2P3YudG9FbnRpdHlPYmplY3QodHJ1ZSk6bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J3RvRW50aXR5T2JqZWN0JyU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcykgew0KICAgICAgICBsZXQgcmV0ID0ge0FjdGl2ZTogdHJ1ZSwgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwgRW50aXR5VmFsdWVzOiBbXSwgVmFsdWVFbnRpdGllczogW119Ow0KICAgICAgICBpZighYlF1ZXJ5KSByZXQuRGF0ZSA9IHRoaXMuc2VydmVyRGF0ZSgpOyANCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5JZCA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBldiA9IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIElkOiA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPSB0aGlzLkVudGl0eUNsYXNzLklkKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZT09JzwlPWVhLk5hbWUlPicpLklkLA0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBPUEVSQVRPUlM6IHt9LA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyk7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9QRVJBVE9SUy5PYmplY3RWYWx1ZSA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIGV2LjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gdjsNCiAgICAgICAgICAgICAgICBldi5PUEVSQVRPUlMuPCU9X0ZyRU1ELl9hdHRyKGVhKSU+VmFsdWUgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICBvYmouVmFsdWVFbnRpdGllcy5wdXNoKGV2KTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYodiAmJiBiVHlwZWRBdHRyaWJ1dGVzKSBvYmouRW50aXR5VmFsdWVzLnB1c2godi5tYXAoX3YgPT4gKHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIElkOiAnPCU9dGEuSWQlPicsDQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPCU9dGEuTmFtZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl92YWx1ZUNsYXNzKCksDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIE9iamVjdFZhbHVlOiBfdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyksDQogICAgICAgICAgICAgICAgfSkpKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gJT4NCn0NCg==",
	"Name": "RW50aXR5Q2xhc3M=",
	"Script": "PCUNCmxldCBhdXRoQ2xhc3MgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWU9PSdhdXRob3JpemUnICYmIG0uSXNQdWJsaWMpKTsNCmxldCBlbXMgPSBhckNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lPT0nRW50aXR5Q2xhc3MnKTsNCg0KLy8gdGhlIGRlZmF1bHQgU2V0X09uIGRhdGUgdG8gdXNlDQpsZXQgU2V0X09uID0gYG5ldyBEYXRlKClgOw0KDQpsZXQgX2I2NHRlc3QgPSBzID0+IGAvXihbMC05YS16QS1aK1wvXXs0fSkqKChbMC05YS16QS1aK1wvXXsyfT09KXwoWzAtOWEtekEtWitcL117M309KSk/JC8udGVzdCgke3N9fHwnLicpYDsNCg0KbGV0IF9kZWYgPSAocywgdikgPT4gJT48JT1zJT4gPSB0eXBlb2YoPCU9cyU+KSE9PSd1bmRlZmluZWQnPzwlPXMlPjo8JT12JT47PCUNCg0KbGV0IF9kZWZhdWx0cyA9IChvYmo9J3RoaXMnLCBfYz1jKSA9PiBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkRlZmF1bHQpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZighPCU9b2JqJT4uXzwlPW5OYW1lKGVhKSU+X3NldCl7DQogICAgICAgICAgICAgICAgPCU9b2JqJT4uPCU9bk5hbWUoZWEpJT4oPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4pOw0KICAgICAgICAgICAgfQ0KPCUgfSk7DQoNCmxldCBsb2cgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMCwgYDsNCmxldCB3YXJuID0gKG4sIF90aGlzPSd0aGlzJykgPT4gYCR7X3RoaXN9LmxvZyhudWxsLCB1bmRlZmluZWQsICcke24gfHwgbU5hbWV9JywgJ0VudGl0eU9iamVjdCcsIDEsIGA7DQpsZXQgZXJyb3IgPSAobiwgX3RoaXM9J3RoaXMnKSA9PiBgJHtfdGhpc30ubG9nKG51bGwsIHVuZGVmaW5lZCwgJyR7biB8fCBtTmFtZX0nLCAnRW50aXR5T2JqZWN0JywgMiwgYDsNCg0KbGV0IHFsVHlwZSA9IChlYSwgYklucHV0KSA9PiB7DQogICAgaWYoZWEuSXNCb29sKSByZXR1cm4gJ0Jvb2xlYW4nOw0KICAgIC8vaWYoZWEuSXNEYXRlKSByZXR1cm4gJ0RhdGVUaW1lJzsNCiAgICBpZihlYS5Jc0ludCB8fCBlYS5Jc0Zsb2F0KSByZXR1cm4gJ0ludCc7DQogICAgaWYoZWEuRW50aXR5VHlwZSkgcmV0dXJuIG5OYW1lKGVhLkVudGl0eVR5cGUpKyhiSW5wdXQ/IklucHV0IjoiIik7DQogICAgcmV0dXJuICdTdHJpbmcnOw0KfTsNCg0KLy8gd2h5IGhhcmQgY29kZWQ/Pz8NCmxldCBfcmVzdFRvb2xzID0gWydTZXJ2aWNlTm93JywgJ1NhbGVzRm9yY2UnLCAnUmVzdERCSU8nLCAnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCmxldCBfc3FsVG9vbHMgPSBbJ1NxbERCJywgJ1NhbGVzRm9yY2UnLCAnU25vd0ZsYWtlJ107DQpsZXQgX2ZpbGVUb29scyA9IFsnR2l0SHViJywgJ0ZpbGVTeXN0ZW0nXTsNCg0KbGV0IGNsc1Rvb2xzID0gX2MgPT4gX2MuVG9vbHMubWFwKHQgPT4gdC50eXBlP3QudHlwZS5uYW1lOih0Lm5hbWUgfHwgdCkpOw0KbGV0IG1haW5DbGFzcyA9IChfYXJUb29scywgX2M9YykgPT4gYXJDbGFzc2VzLmZpbmQoX19jID0+IChfYXJUb29scyB8fCBjbHNUb29scyhfYykpLmZpbmQodCA9PiBjbHNUb29scyhfX2MpLmluY2x1ZGVzKHQpKSkgfHwgKCEoX2FyVG9vbHMgfHwgY2xzVG9vbHMoX2MpKS5sZW5ndGggJiYgYXJDbGFzc2VzWzBdKTsNCg0KbGV0IF9lYVR5cGVzID0gKF9jPWMsIGJBbGwpID0+IF9GckVNRC5fdG9KUyhPYmplY3QuYXNzaWduKHt9LCAuLi5fYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGJBbGw/dHJ1ZTplYS5FbnRpdHlUeXBlKS5tYXAoZWEgPT4gKHtbbk5hbWUoZWEpXTogbk5hbWUoZWEuRW50aXR5VHlwZSkgfHwgX0ZyRU1ELl9hdHRyKGVhKX0pKSkpOw0KDQpsZXQgX2NGaWVsZCA9IChlYSwgX2M9ZWEuRW50aXR5Q2xhc3MpID0+ICgoZWEuRW50aXR5VHlwZT8oZWEuRW50aXR5VHlwZS5UeXBlZEF0dHJpYnV0ZXMuZmluZCh0YSA9PiB0YS5FbnRpdHlDbGFzcz09X2MpIHx8IGVhLkVudGl0eUNsYXNzLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLkVudGl0eVR5cGU9PV9jKSk6bnVsbCkgfHwge05hbWU6ICIifSkuTmFtZTsNCg0KbGV0IF9jTmFtZSA9IChjbj1jLk5hbWUsIGJBbGlhcykgPT4gew0KICAgIGlmKGNuLk5hbWUpIGNuID0gY24uTmFtZTsNCiAgICBsZXQgX2MgPSBhckNsYXNzZXMuZmluZChlYyA9PiBlYy5OYW1lPT1jbik7DQogICAgaWYoIV9jKSByZXR1cm4gJyc7DQogICAgcmV0dXJuIG5OYW1lKF9jLCBiQWxpYXMpOw0KfTsNCg0KbGV0IGFsaWFzID0gKGNuLCBqPScuJykgPT4gKHNjb3BlICsgJy4nICsgX2NOYW1lKGNuLCB0cnVlKS5yZXBsYWNlKF9jTmFtZShjbiksICcnKSkuc3BsaXQoJy4nKS5maWx0ZXIobiA9PiBuKS5qb2luKGopOw0KbGV0IG5zY29wZSA9IGFsaWFzKCdOb2RlJyk7DQoNCmxldCBfdkNvZGUgPSBrID0+IHslPig8JXZhbHVlT2Yoay5Db2RlKSU+IHx8ICgiPCU9bkNvZGUoayklPiIpKTwlfTsNCmxldCBfbkNvZGUgPSAoZWEsIGJUeXBlZCkgPT4gZWE/KCJ0aGlzLl9uQ29kZSgnIiArIG5Db2RlKGVhKSArIChiVHlwZWQ/KCdfJyArIGVhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJykpOiIiKSAgKyAiJywgIiArIChiVHlwZWQ/bnVsbDpfRnJFTUQuX3RvSlMoZWEuQ29kZSkpICsgIikiKToidGhpcy5fbkNvZGUoKSI7DQpsZXQgbVJvdXRpbmcgPSAoYywgbSkgPT4gew0KICAgIGlmICghYyAmJiBtKSBjID0gbS5FbnRpdHlDbGFzczsNCiAgICBpZiAoIW0gJiYgIWMpIHJldHVybiAiIjsNCiAgICBpZiAoIW0pIG0gPSBjOw0KICAgIGlmICghbS5Sb3V0aW5nICYmICFjLlJvdXRpbmcpIHJldHVybiAiIjsNCg0KJT4oX25vZGUsIG1ldGhvZCkgPT4gew0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlbT9tLk5hbWU6JyclPiIgfHwgbWV0aG9kLCAiUm91dGVyIiwgMCwgLi4ubXNnKTsNCiAgICAJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAxLCAuLi5tc2cpOw0KICAgIAlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKCI8JT1uTmFtZShjKSU+Iiwgb2JqLCAiPCVtP20uTmFtZTonJyU+IiB8fCBtZXRob2QsICJSb3V0ZXIiLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAJbGV0IG5TY29wZSA9IDwlPW5zY29wZSU+Ow0KDQogICAgICAgIHRyeXsNCiAgICAgICAgPCVmdW5jdGlvbk9mKG0uUm91dGluZyklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgd2FybihleCk7DQogICAgICAgIH0NCn0NCjwlfTsNCg0KbGV0IG1OYW1lID0gJyc7DQoNCmxldCBmdW5jdGlvbk9mID0gKGZ1biwgX3RoaXM9J3RoaXMnKSA9PiB7JT4NCiAgICAgICAgbGV0IF9fcmV0ID0gdW5kZWZpbmVkOw0KICAgIDwlIGlmKGZ1bil7JT4NCiAgICAgICAgPCUgaWYodHlwZW9mKGZ1bik9PT0nb2JqZWN0Jyl7JT4NCiAgICAgICAgICAgIDwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYoPCU9X3RoaXMlPi5Ub29sICYmIDwlPV90aGlzJT4uVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgICAgICAgICA8JSBpZih0eXBlb2YoZnVuW3RdKT09PSdmdW5jdGlvbicpeyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPWZ1blt0XSU+Ow0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICBfX3JldCA9IDwlPShKU09OLnN0cmluZ2lmeShmdW5bdF0pIHx8ICciIicpJT47DQogICAgICAgICAgICAgICAgPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIF9fcmV0ID0gPCU9ZnVuJT47DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0lPg0KICAgICAgICBpZih0eXBlb2YoX19yZXQpPT09J3N0cmluZycgJiYgX19yZXQuc3RhcnRzV2l0aCgicygiKSAmJiBfX3JldC5lbmRzV2l0aCgiKSIpKXsNCiAgICAgICAgICAgIF9fcmV0ID0gdGhpcy5ydW5TY3JpcHQoX19yZXQuc2xpY2UoMiwtMSkpOw0KICAgICAgICB9DQogICAgICAgIGlmKHR5cGVvZihfX3JldCk9PT0iZnVuY3Rpb24iKXsNCiAgICAgICAgICAgIF9fcmV0ID0gX19yZXQoPCU9X3RoaXMlPik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9fcmV0Ow0KPCV9Ow0KDQpsZXQgdmFsdWVPZiA9IChmdW4sIF90aGlzPSd0aGlzJykgPT4geyU+KCgNCihvU2NvcGUpID0+IHsNCiAgICB0cnl7DQo8JWZ1bmN0aW9uT2YoZnVuLCBfdGhpcyklPg0KICAgIH1jYXRjaChfdk9mRXgpew0KICAgICAgICA8JT13YXJuKCklPid2YWx1ZU9mJywgX3ZPZkV4LCA8JT1fRnJFTUQuX3RvSlMoZnVuKSU+KTsNCiAgICB9DQp9DQopKDwlPWFsaWFzKCklPikpPCV9Ow0KDQpsZXQgdW5SZWN1cnNlID0gKG9iaiwgZnVuLCBmQXJncz0nYXJndW1lbnRzJywgc1JldCwgdmFsaWRpdHk9YHRoaXMuX19jb25maWcoJ3VuUmVjdXJzZS52YWxpZGl0eScsIDAuNSlgLCBpZGYpID0+IHsNCiAgICBpZGYgPSBpZGYgfHwgYCh0aGlzP3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTonSWQnKWA7DQogICAgZnVuID0gZnVuIHx8IGAiJHttTmFtZX0iYDsNCiAgICBzUmV0ID0gYA0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICB2LmRhdGUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgICAgICAgICAgICAgICB2LnJldXNlZCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAke3NSZXR9DQogICAgICAgIH1jYXRjaChzUmV0X2V4KXsNCiAgICAgICAgICAgIHRoaXMubG9nKG51bGwsIHVuZGVmaW5lZCwgJHtmdW59LCAnJHttTmFtZX0udW5SZWN1cnNlJywgMSwgJ3NSZXQnLCBzUmV0X2V4KTsNCiAgICAgICAgfWZpbmFsbHl7DQogICAgICAgICAgICBpZih2ICYmIHYucmV1c2VkPjEpIHJldHVybiB2P3Yub2JqOnY7DQogICAgICAgIH0NCiAgICBgOw0KICAgIGxldCBiRGFuZ2VyID0gKCkgPT4gJT4oWyJfdG9IYXNoIl0uaW5kZXhPZig8JT1mdW4lPik+PTApPCU7DQolPg0KICAgICAgICBsZXQgdiA9IHVuZGVmaW5lZDsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydCA9IDwlPXNjb3BlJT4udW5SZWN1cnNlQWJvcnQgfHwge307DQogICAgICAgICAgICBpZig8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPmBBYm9ydGluZyBhcyBwZXIgPCU9c2NvcGUlPi51blJlY3Vyc2VBYm9ydC4kezwlPWZ1biU+fWApOw0KICAgICAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsZXQgX2lkID0gbnVsbDsNCiAgICAgICAgICAgIGlmKHR5cGVvZig8JT1vYmolPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgPCU9d2FybihgJHttTmFtZX0udW5SZWN1cnNlYCklPiJOdWxsIGlucHV0IiwgPCU9b2JqJT4sIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gPCU9b2JqJT47DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoPCU9b2JqJT4pPT09J3N0cmluZycpew0KICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuaGFzaENvZGUoPCU9b2JqJT4pOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKDwlPW9iaiU+WzwlPWlkZiU+XSkhPT0ndW5kZWZpbmVkJyAmJiA8JT1vYmolPls8JT1pZGYlPl09PTwlPW9iaiU+WzwlPWlkZiU+XSl7DQogICAgICAgICAgICAgICAgX2lkID0gPCU9b2JqJT5bPCU9aWRmJT5dOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoX2lkKT09PSd1bmRlZmluZWQnIHx8ICFfaWQpew0KICAgICAgICAgICAgICAgIGlmKDwlPW9iaiU+LklkICYmIDwlPW9iaiU+LklkPT08JT1vYmolPi5JZCl7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IDwlPW9iaiU+LklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSB0aGlzLklkOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtvbmx5VW5pcXVlOiB0cnVlfSwgPCU9ZnVuJT4pOw0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coYCR7bU5hbWV9LnVuUmVjdXJzZWApJT4idGhpcy5oYXNoZWRfaWQiLCBfaWQsIDwlPWZ1biU+LCA8JT1mQXJncyU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihvYmouU2V0X09uKXsNCiAgICAgICAgICAgICAgICAgICAgX2lkID0gb2JqLl90b0hhc2goPCU9ZkFyZ3MlPiwge29ubHlVbmlxdWU6IHRydWV9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZyhgJHttTmFtZX0udW5SZWN1cnNlYCklPiJvYmouaGFzaGVkX2lkIiwgX2lkLCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPik7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYoPCU9b2JqJT4uRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBfaWQgPSA8JT1vYmolPi5FbnRpdHlDbGFzcy5JZCB8fCA8JT1vYmolPi5FbnRpdHlDbGFzcy5OYW1lIHx8IHRoaXMuX3RvSGFzaCg8JT1mQXJncyU+LCB7ZGVwdGg6IDwlYkRhbmdlcigpJT4/Mzp1bmRlZmluZWR9LCA8JT1mdW4lPik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjwlPWMuSWQlPiIgfHwgdGhpcy5fdG9IYXNoKDwlPWZBcmdzJT4sIHtkZXB0aDogPCViRGFuZ2VyKCklPj8zOnVuZGVmaW5lZH0sIDwlPWZ1biU+KSB8fCAiTlVMTCI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL2lmKCI8JT1uTmFtZShjKSU+Ij09IkhUTUxQYWdlIiAmJiA8JT1mdW4lPj09Il9mcm9tRmlsZU5hbWUiKSA8JT13YXJuKGAke21OYW1lfS51blJlY3Vyc2VgKSU+Il9pZCIsIF9pZCwgPCU9ZnVuJT4sIDwlPWZBcmdzJT4sIDwlPW9iaiU+KTsNCiAgICAgICAgICAgIA0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlIHx8IHt9Ow0KICAgICAgICAJPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT4gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPiB8fCB7fTsNCiAgICAgICAgCTwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XSA9IDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XSB8fCB7fTsNCiAgICAgICAgCTwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+WzwlPWZ1biU+XVtfaWRdID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bPCU9ZnVuJT5dW19pZF0gfHwge307DQogICAgICAgIAkNCiAgICAgICAgICAgIHYgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXTsNCg0KICAgICAgICAgICAgaWYodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCo8JT12YWxpZGl0eSU+KSl7DQogICAgICAgICAgICAgICAgaWYoKDwlYkRhbmdlcigpJT4/bmV3IERhdGUoMCk6KHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSkuZ2V0VGltZSgpID4gdi5kYXRlKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+YFNwYXduaW5nIGluICR7PCU9ZnVuJT59YCwgX2lkLCA8JT1mdW4lPiwgPCU9b2JqJT4sIHYucmV1c2VkLCA8JT12YWxpZGl0eSU+KTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+IlNlbGVjdGVkIGhhc2giLCBfaWQsIDwlPWZ1biU+LCA8JT1vYmolPiwgdi5yZXVzZWQsIDwlPXZhbGlkaXR5JT4pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICA8JT1zUmV0JT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgPCU9bG9nKGAke21OYW1lfS51blJlY3Vyc2VgKSU+IlB1c2hpbmcgaGFzaCIsIF9pZCwgPCU9ZnVuJT4sIDwlPW9iaiU+KTsNCiAgICAgICAgCXYgPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPls8JT1mdW4lPl1bX2lkXSA9IHsNCiAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwNCiAgICAgICAgICAgICAgICBhcmdzOiBKU09OLnN0cmluZ2lmeSg8JT1mQXJncyU+KSwNCiAgICAgICAgICAgICAgICBvYmo6IDwlPW9iaiU+LA0KICAgICAgICAgICAgICAgIHJldXNlZDogMCwNCiAgICAgICAgICAgICAgICBwYXRoOiAnJywNCiAgICAgICAgICAgICAgICBfaWQsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JS8qZXhwZXJpbWVudGFsOiByZW1vdmUgdGhpcyBpZiBhbGwgZ29lcyB3cm9uZyovJT4NCiAgICAgICAgICAgIDwlPXNSZXQlPg0KICAgIAl9Y2F0Y2godW5SZWNFeCl7DQogICAgCSAgICBpZighdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKXsNCiAgICAJICAgICAgICA8JT1zY29wZSU+LnVuUmVjdXJzZUFib3J0WzwlPWZ1biU+XSA9IHRydWU7DQogICAgCSAgICB9DQogICAgCSAgICA8JT1lcnJvcihgJHttTmFtZX0udW5SZWN1cnNlYCklPjwlPW9iaiU+LCA8JT1mdW4lPiwgPCU9ZkFyZ3MlPiwgdW5SZWNFeC50b1N0cmluZygpKTsNCiAgICAJICAgIDwlPXNSZXQlPg0KICAgIAl9DQo8JQ0KfTsNCg0KbGV0IGludm9rZVJ1bGUgPSByID0+IHsNCiU+DQphd2FpdCAoYXN5bmMgKGF1dGhPYmopID0+IHsNCiAgICBsZXQgX3J1bGUgPSA8JT1fRnJFTUQuX3RvSlMociklPjsNCiAgICBkZWxldGUgX3J1bGUuU2NyaXB0Ow0KICAgIC8vIHJ1bGVSdW5zLnB1c2goX3J1bGUpOw0KICAgIHRyeXsNCiAgICAgICAgPCU9ci5TY3JpcHQlPg0KICAgIH1jYXRjaChleCl7DQogICAgICAgIF9ydWxlLkV4Y2VwdGlvbiA9IGV4Ow0KICAgIH0NCn0pKGF1dGhPYmopOw0KPCUNCn0NCiU+DQoNCmNsYXNzIDwlPW5OYW1lKGMpJT4gew0KICAgIDwlPW1OYW1lPSdjb25zdHJ1Y3RvciclPihpZCwgdG9vbCkgew0KICAgICAgICAvL3N1cGVyKGlkLCB0b29sKTsNCg0KICAgICAgICB0aGlzLlNjb3BlID0gIjwlPXNjb3BlJT4iOw0KICAgICAgICB0aGlzLkRlYnVnID0gPCU9X0ZyRU1ELl90b0pTKGMuRGVidWcpJT47DQogICAgICAgIHRoaXMuQ29uZmlnID0gPCU9X0ZyRU1ELl90b0pTKGMuQ29uZmlnKSU+Ow0KICAgICAgICB0aGlzLlRlc3QgPSA8JT1fRnJFTUQuX3RvSlMoYy5UZXN0KSU+Ow0KICAgICAgICB0aGlzLlRvb2xzID0gPCU9X0ZyRU1ELl90b0pTKGMuVG9vbHMpJT47DQogICAgICAgIHRoaXMuTWFwcGluZ3MgPSA8JT1fRnJFTUQuX3RvSlMoYy5NYXBwaW5ncyklPjsNCg0KICAgICAgICAvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUNCiAgICAgICAgdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9Ow0KICAgICAgICB0aGlzLlRvb2wgPSB0b29sOw0KICAgICAgICB0aGlzLklkID0gaWQ7DQoNCiAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzID0gW107DQoNCiAgICAgICAgdGhpcy5EYXRlID0gbnVsbDsNCg0KICAgICAgICB0aGlzLmNsZWFyX1RISVMoKTsNCiAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7DQogICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCjwlIGlmKE51bWJlcihlYS5JZCkpeyU+DQogICAgICAgICAgICAgICAgSWQ6ICI8JT1lYS5JZCU+IiwNCjwlIH0lPg0KICAgICAgICAgICAgICAgIE5hbWU6ICI8JT1lYS5OYW1lJT4iLA0KICAgICAgICAgICAgICAgIE9QRVJBVE9SUzoge05hbWU6ICI9In0sDQogICAgICAgICAgICAgICAgRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgT1BFUkFUT1JTOiB7fQ0KICAgICAgICB9KTsNCiAgICAgICAgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHslPg0KICAgICAgICB0aGlzLmNsZWFyXzwlPW5OYW1lKHRhKSU+XzwlPXRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyklPigpOw0KPCUgfSk7ICU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZGVmYXVsdHMnJT4oKXsNCjwlX2RlZmF1bHRzKCklPg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBFbnRpdHlDbGFzcyclPigpew0KICAgICAgICBsZXQgZWMgPSB7DQo8JSBpZihOdW1iZXIoYy5JZCkpeyU+DQogICAgICAgICAgICBJZDogIjwlPWMuSWQlPiIsDQo8JSB9JT4NCiAgICAgICAgICAgIE5hbWU6ICI8JT1jLk5hbWUlPiIsDQogICAgICAgICAgICBPUEVSQVRPUlM6IHtOYW1lOiAiPSJ9LA0KICAgICAgICB9Ow0KDQo8JSBpZihjLkVudGl0eU1vZHVsZWlkKXsgJT4NCiAgICAgICAgZWMuRW50aXR5TW9kdWxlID0gew0KICAgICAgICAgICAgSWQ6IDwlPWMuRW50aXR5TW9kdWxlaWQlPg0KICAgICAgICB9Ow0KPCUgfSU+DQoNCiAgICAgICAgLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyDQogICAgICAgIGlmKCFOdW1iZXIoZWMuSWQpICYmIDwlPXNjb3BlJT4uRW50aXR5Q2xhc3Nlcyl7DQogICAgICAgICAgICBsZXQgY2lkID0gPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lPT1lYy5OYW1lKTsNCiAgICAgICAgICAgIGlmKGNpZCkgZWMuSWQgPSBjaWQuSWQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGVjOw0KICAgIH0NCg0KCTwlPW1OYW1lPSdnZXQgSWQnJT4oKSB7DQoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsNCgl9DQoNCgk8JT1tTmFtZT0nc2V0IElkJyU+KGlkKSB7DQoJCWlmICghdGhpcy5Ub29sKSB7DQoJCQk8JT1sb2coKSU+IkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmKHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV09PWlkKSByZXR1cm47DQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsNCgl9DQoNCiAgICA8JT1tTmFtZT0nZ2V0IFRvb2wnJT4oKSB7DQogICAgICAgIGlmKHR5cGVvZih0aGlzLl9fVG9vbCkhPT0ndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOw0KICAgICAgICBsZXQgbm9Ub29sID0gew0KICAgICAgICAgICAgbmFtZTogJycsDQogICAgICAgICAgICB0eXBlOiB7bmFtZTogJyd9LA0KICAgICAgICB9Ow0KICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5Ub29scykhPT0idW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheSg8JT1zY29wZSU+LlRvb2xzKSl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iPCU9c2NvcGUlPi5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIDwlPXNjb3BlJT4uVG9vbHMpOw0KICAgICAgICAgICAgcmV0dXJuIG5vVG9vbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9ICg8JT1zY29wZSU+Ll9fbGFzdFRvb2w/WzwlPXNjb3BlJT4uX19sYXN0VG9vbF06W10pLmNvbmNhdCh0aGlzLlRvb2xzKS5maW5kKHQgPT4gKDwlPXNjb3BlJT4uVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZT09X3QubmFtZSkpOw0KICAgICAgICBpZih0eXBlb2YocmV0KSE9PSd1bmRlZmluZWQnKSByZXQgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09cmV0IHx8IHQubmFtZT09cmV0Lm5hbWUpOw0KICAgICAgICBpZih0eXBlb2YocmV0KT09PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbHMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbHNbMF0sDQogICAgICAgICAgICAgICAgICAgIHR5cGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuVG9vbHNbMF0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9ZWxzZSByZXQgPSBub1Rvb2w7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nc2V0IFRvb2wnJT4odG9vbCkgew0KICAgICAgICBpZiAodHlwZW9mKHRvb2wpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgaWYodHlwZW9mKHRvb2wpPT09InN0cmluZyIpew0KICAgICAgICAgICAgdG9vbCA9IHtuYW1lOiB0b29sfTsNCiAgICAgICAgfQ0KICAgICAgICBpZih0b29sLkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgIHRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7DQogICAgICAgIH0NCiAgICAgICAgaWYodHlwZW9mKHRvb2wubmFtZSk9PT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHtuYW1lOiB0b29sLm5hbWV9Ow0KICAgICAgICANCiAgICAgICAgaWYoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+IkVtcHR5IFRvb2wgb2JqZWN0Iik7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBsZXQgdCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOw0KICAgICAgICBpZiAoIXQpIHsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIDwlPXNjb3BlJT4uVG9vbHMpOw0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1zY29wZSU+Ll9fbGFzdFRvb2wgPSB0aGlzLl9fVG9vbCA9IHQ7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nVEhJUyclPih2LCBjbyl7DQogICAgICAgIGlmKHR5cGVvZih2KT09PSd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsNCiAgICAgICAgaWYoIXYpIHJldHVybiB0aGlzOw0KICAgICAgICB2ID0gQXJyYXkuaXNBcnJheSh2KT92Olt2XTsNCiAgICAgICAgdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdik9PT0nb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lPT10aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGU9PXRoaXMuU2NvcGUpOw0KICAgICAgICBpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2NsZWFyX1RISVMnJT4oKSB7DQogICAgICAgIHRoaXMuX1RISVMgPSBbXTsNCiAgICAgICAgdGhpcy5fVEhJU19jb29wID0gJyc7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICANCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPWVhLk5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT1uTmFtZShlYSklPih2LCBjbywgaWQpIHsNCiAgICAgICAgaWYgKGNvKSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wID0gY287DQoNCiAgICAgICAgdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiPCU9ZWEuTmFtZSU+Iik7DQogICAgICAgIGlmICghZXYpew0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoaWQpIGV2LklkID0gaWQ7DQoNCiAgICAgICAgaWYgKHR5cGVvZih2KSE9PSd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyDQoNCiAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgdiA9IEFycmF5LmlzQXJyYXkodik/djpbdl07DQogICAgICAgICAgICB2ID0gdi5tYXAoX3YgPT4gew0KICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICB2ID0gKF92ID0+IHsNCiAgICA8JSB9JT4NCg0KICAgIDwlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICBfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJz9fdjoobmV3IERhdGUoX3YpKTsNCiAgICAgICAgICAgICAgICBpZihpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7DQogICAgPCUgfSU+DQogICAgPCUgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgIF92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOw0KICAgIDwlIH0lPg0KICAgIDwlIGlmKGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgICAgIGlmKGlzTmFOKF92KSkgX3YgPSAwOw0KICAgIDwlIH0lPg0KICAgIDwlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoX3YpPT09J29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOw0KICAgIDwlIH0lPg0KDQogICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZihfdiAmJiAhX3YuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+InVzaW5nIF90b0RvY3VtZW50IGZvciBpbnZhbGlkIHNldHRlciB2YWx1ZSIsIF92KTsNCiAgICAgICAgICAgICAgICAgICAgX3YgPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3YpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKF92ICYmIF92LkVudGl0eUNsYXNzLklkIT09JzwlPWVhLkVudGl0eVR5cGUuSWQlPicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSE9PSc8JT1lYS5FbnRpdHlUeXBlLk5hbWUlPicpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJJbnZhbGlkIFNldHRlciB2YWx1ZSIsIF92LCAiPCU9ZWEuRW50aXR5VHlwZS5JZCU+IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIjwlPWVhLkVudGl0eVR5cGUuTmFtZSU+Iik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIF92ID0gKChfdiAmJiAhdGhpcy5JZCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCg0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgfSk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIH0pKHYpOw0KICAgIDwlIH0lPg0KICAgIA0KICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICBkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsNCiAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gdjsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgZXYuPCU9X0ZyRU1ELl9hdHRyKGVhKSU+VmFsdWUgPSB2Ow0KICAgIDwlIH0lPg0KDQogICAgICAgICAgICBpZih0cnVlIHx8IHRoaXMuXzwlPW5OYW1lKGVhKSU+IT12KXsNCiAgICAgICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgPSA8JT1TZXRfT24lPjsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUNCiAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU2V0IGFmdGVyIiwgdGhpcy5fPCU9bk5hbWUoZWEpJT4/dGhpcy5fPCU9bk5hbWUoZWEpJT4uU2V0X09uOm51bGwsIHY/di5TZXRfT246bnVsbCk7DQogICAgICAgICAgICAgICAgLyppZih2KSB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgPSB2LlNldF9PbjsqLw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPiA9IHY7DQogICAgICAgICAgICBpZiAoY28pIGV2Lk9QRVJBVE9SUy48JT1fRnJFTUQuX2F0dHIoZWEpJT5WYWx1ZSA9IGNvOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuXzwlPW5OYW1lKGVhKSU+KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdjbGVhcl8nK25OYW1lKGVhKSU+KCkgew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT47DQogICAgICAgIC8qDQogICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCA9IG51bGw7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKGVhKSU+ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCA9ICIiOw0KICAgICAgICAqLw0KICAgICAgICANCiAgICAgICAgZGVsZXRlIHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldDsNCiAgICAgICAgZGVsZXRlIHRoaXMuXzwlPW5OYW1lKGVhKSU+Ow0KICAgICAgICBkZWxldGUgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICAvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT1lYS5OYW1lJT4gKiovDQo8JSB9KTsgJT4NCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIDwlPXRhLk5hbWUlPl88JT10YU5hbWUlPiAqKi8NCiAgICA8JT1tTmFtZT1uTmFtZSh0YSkrJ18nK3RhTmFtZSU+KHYsIGNvLCBiQ2xlYXIpIHsNCiAgICAgICAgaWYodHlwZW9mKHYpPT09InVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPjsNCiAgICAgICAgDQogICAgICAgIGlmKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkIT09JzwlPXRhLkVudGl0eUNsYXNzLklkJT4nICYmIHYuRW50aXR5Q2xhc3MuTmFtZSE9PSc8JT10YS5FbnRpdHlDbGFzcy5OYW1lJT4nKSByZXR1cm4gdGhpczsNCiAgICAgICAgDQogICAgICAgIHYgPSBBcnJheS5pc0FycmF5KHYpP3Y6W3ZdOw0KICAgICAgICANCiAgICAgICAgdiA9IHYuZmlsdGVyKF92ID0+ICF2IHx8IF92Ll88JT1uTmFtZSh0YSklPl9zZXQpLmNvbmNhdCh2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuXzwlPW5OYW1lKHRhKSU+X3NldCkubWFwKF92ID0+IHsNCiAgICAgICAgICAgIGlmKCFfdi5jb25zdHJ1Y3Rvcil7DQogICAgICAgICAgICAgICAgPCU9d2FybigpJT4iPCU9bk5hbWUodGEpJT4gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOw0KICAgICAgICAgICAgfWVsc2UgaWYoX3YuY29uc3RydWN0b3IubmFtZT09Ik9iamVjdCIpew0KICAgICAgICAgICAgICAgIF92ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF92KQ0KICAgICAgICAgICAgICAgIF92LjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICAgICAgICAgIH1lbHNlIGlmKF92LmNvbnN0cnVjdG9yLm5hbWUhPSI8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiIpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IjwlPW5OYW1lKHRhKSU+IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4iKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIF92LjwlPW5OYW1lKHRhKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldHVybiBfdjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSkuZmlsdGVyKF92ID0+IF92KSk7DQogICAgICAgIA0KICAgICAgICBpZihiQ2xlYXIpIHRoaXMuY2xlYXJfPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4oKTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT4ucHVzaCguLi52KTsNCiAgICAgICAgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fc2V0ID0gPCU9U2V0X09uJT47DQogICAgICAgIGlmIChjbykgdGhpcy5fPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT5fY29vcCA9IGNvOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCiAgICBjbGVhcl88JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPigpIHsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+Ow0KDQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X3NldCA9IG51bGw7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+ID0gbmV3IEFycmF5KCk7DQogICAgICAgIHRoaXMuXzwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+X2Nvb3AgPSBudWxsOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICAvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciA8JT1uTmFtZSh0YSklPl88JT10YU5hbWUlPiAqKi8NCg0KPCUgfSkgJT4NCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgLyoqIHN0YXJ0OiBnZXR0ZXJzIGZvciA8JT1lZi5OYW1lJT4gKiovDQogICAgPCU9bU5hbWU9J2dldCAnK25OYW1lKGVmKSU+KCl7DQogICAgICAgIHJldHVybiA8JXZhbHVlT2YoZWYuVmFsdWUpJT47DQogICAgfQ0KICAgIC8qKiBlbmQ6IGdldHRlcnMgZm9yIDwlPWVmLk5hbWUlPiAqKi8NCjwlIH0pJT4NCg0KICAgIDwlPW1OYW1lPSdsb2cnJT4oY2xhc3NOYW1lLCBvYmosIG0sIHR5cGUsIGxldmVsLCAuLi5tc2cpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICB0eXBlID0gdHlwZSB8fCAiRW50aXR5T2JqZWN0IjsNCiAgICAgICAgDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBvYmosIG0sIHR5cGUsIGxldmVsLCAuLi5tc2cpOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KCQkJbGV0IGRlYnVnID0gdGhpcy5EZWJ1ZzsNCgkJCWxldCBsZXZlbHMgPSBbImluZm8iLCAid2FybiIsICJlcnJvciIsICJjcml0aWNhbCJdOw0KDQoJCQlkZWJ1ZyA9IGRlYnVnIHx8IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKGxldmVscy5tYXAobCA9PiBbbCwgJyonXSkpKTsNCg0KCQkJbGV0IGZ1bmN0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIC4uLmxldmVscy5tYXAobCA9PiAoew0KCQkJCVtsXTogZGVidWdbbF0gPyBkZWJ1Z1tsXS5zcGxpdCgnLCcpIDogW10NCgkJCX0pKSk7DQoNCgkJCWxldCBjc3MgPSAnYmFja2dyb3VuZDogIzAwZmY5OTsgY29sb3I6ICMwMDgwMDAnOw0KCQkJbGV0IGZnID0gJ1x4MWJbMzJtJzsNCgkJCXN3aXRjaCAoTnVtYmVyKGxldmVsKSkgew0KCQkJCWNhc2UgMToNCgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNmZmZmMDA7IGNvbG9yOiAjMDAwMDgwJzsNCgkJCQkJZmcgPSAnXHgxYlszM20nOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIDI6DQoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7DQoJCQkJCWZnID0gJ1x4MWJbMzFtJzsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAzOg0KCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOw0KCQkJCQlmZyA9ICdceDFiWzMxbVtDUklUSUNBTF0nOw0KCQkJCQlicmVhazsNCgkJCX0NCg0KCQkJaWYgKGZ1bmN0aW9uc1tsZXZlbHNbTnVtYmVyKGxldmVsKSB8fCAwXV0uZXZlcnkoZiA9PiAhWycqLionLCAnKi4nICsgbSwgJyonLCBtLCBjbGFzc05hbWUgKyAnLicgKyBtLCBjbGFzc05hbWUgKyAnLionXS5pbmNsdWRlcyhmKSkpIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsNCgkJCQljb25zb2xlLmxvZyhmZyArICIlc1x4MWJbMG0iLCBgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke2NsYXNzTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOw0KCQkJfSBlbHNlIHsNCgkJCQljb25zb2xlLmxvZyhgJWMgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke2NsYXNzTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCBjc3MsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7DQoJCQl9DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQljb25zb2xlLmxvZyhleCk7DQoJCX0NCjwlIH0lPg0KCX0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdzZXRJbnRlcnZhbCclPihjbGFzc05hbWUsIGZ1biwgbWludXRlcywgLi4uYXJncyl7DQogICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAiPCU9bk5hbWUoYyklPiI7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOw0KPCUgfWVsc2V7JT4NCgkJdHJ5IHsNCiAgICAJCWxldCBmTmFtZSA9IGZ1bi50b1N0cmluZygpLnNwbGl0KCcpJylbMF0gKyAnKSc7DQogICAgCQl0cnkgew0KICAgIAkJCS8vIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCk7DQogICAgDQogICAgCQkJdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKTsNCiAgICAJCQlsZXQgcmV0ID0gYXdhaXQgZnVuKC4uLmFyZ3MuY29uY2F0KFtuZXcgRGF0ZSgpXSkpOw0KICAgIA0KICAgIAkJCTwlPWxvZygpJT5ge0NhbGw6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApICsgYCwgTG9vcDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCkgKyAnfScpOw0KICAgIAkJCWlmICghcmV0KSB7DQogICAgCQkJCTwlPWxvZygpJT5gZGlkIG5vdCByZXR1cm4gdHJ1ZSwgZXhpdGluZyBsb29wZXIgKCR7dGhpcy5fX3RpbWUoZk5hbWUpfSlgKTsNCiAgICAJCQkJcmV0dXJuOw0KICAgIAkJCX0NCiAgICAJCX0gY2F0Y2ggKGV4KSB7DQogICAgCQkJPCU9ZXJyb3IoKSU+dGhpcy5fX3RpbWUoZk5hbWUpLCBleCk7DQogICAgCQkJY29uc29sZS50cmFjZSgpOw0KICAgIAkJfQ0KICAgIAkJaWYgKCFOdW1iZXIobWludXRlcykpIHsNCiAgICAJCQk8JT1sb2coKSU+dGhpcy5fX3RpbWUoZk5hbWUpLCAiTm90IHJlcGVhdGluZy4gTWludXRlcyBpcyAiICsgbWludXRlcyk7DQogICAgCQkJcmV0dXJuOw0KICAgIAkJfQ0KICAgIAkJYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIG1pbnV0ZXMgKiA2MCAqIDEwMDApKTsNCiAgICAJCWF3YWl0IHRoaXMuPCU9bU5hbWUlPihudWxsLCBmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOw0KCQl9IGNhdGNoIChleCkgew0KCQkJPCU9ZXJyb3IoKSU+ZXgpOw0KCQl9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2V4ZWN1dGUnJT4oY2xhc3NOYW1lLCBzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcyA9IHt9LCBzb3VyY2Upew0KCQl0aGlzLl9fdGltZShgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4uJHttfWApOw0KCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KCQlzY29wZSA9IHNjb3BlIHx8IDwlPXNjb3BlJT47DQoJCXNvdXJjZSA9IHNvdXJjZSB8fCB0aGlzOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oY2xhc3NOYW1lLCBzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcywgdGhpcyk7DQo8JSB9ZWxzZXslPg0KCQlkZWxldGUgPCU9c2NvcGUlPi5fdW5SZWN1cnNlOyAvLyBleHBlcmltZW50YWwNCgkJDQogICAgCWxldCBfX2JlZm9yZVJ1bGVzID0gb1BhcmFtcy5fX2JlZm9yZVJ1bGVzIHx8IFtdOw0KICAgIAlsZXQgX19hZnRlclJ1bGVzID0gb1BhcmFtcy5fX2FmdGVyUnVsZXMgfHwgW107DQogICAgCWRlbGV0ZSBvUGFyYW1zLl9fYmVmb3JlUnVsZXM7DQogICAgCWRlbGV0ZSBvUGFyYW1zLl9fYWZ0ZXJSdWxlczsNCg0KICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICBsZXQgd2FybiA9ICguLi5zKSA9PiA8JT13YXJuKCklPmNsYXNzTmFtZSwgbSwgLi4ucyk7DQogICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT5jbGFzc05hbWUsIG0sIC4uLnMpOw0KICAgICAgICAgICAgDQogICAgICAgIHRyeXsNCiAgICAJCWxldCBsUGFyYW1zID0gT2JqZWN0LmVudHJpZXMob1BhcmFtcykubWFwKHggPT4geFsxXSk7DQogICAgCQlsZXQgcmVzdWx0cyA9IFtdOw0KICAgIA0KICAgIAkJbGV0IG5vZGVzID0gW107DQogICAgCQkNCiAgICAJCWlmICg8JT1uc2NvcGUlPi5fbm9kZSAmJiBhd2FpdCBmUm91dGVyKDwlPW5zY29wZSU+Ll9ub2RlLCBtKSkgew0KICAgIAkJCW5vZGVzLnB1c2goPCU9bnNjb3BlJT4uX25vZGUpOw0KICAgIAkJfQ0KICAgIA0KICAgIAkJaWYgKDwlPW5zY29wZSU+Ll9ub2RlICYmIDwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnQgJiYgYXdhaXQgZlJvdXRlcig8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKSwgbSkpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKTsNCiAgICAJCX0NCiAgICANCiAgICAJCWZvciBhd2FpdCAoY29uc3QgY24gb2YgKDwlPW5zY29wZSU+Ll9ub2RlPzwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudF9Ob2RlcygpOltdKSkgew0KICAgICAgICAgICAgICAgIGlmIChhd2FpdCBmUm91dGVyKGNuLCBtKSkgew0KICAgICAgICAgICAgICAgIAlsb2coJ2FkZGluZyBjaGlsZCBub2RlJywgY24pOw0KICAgICAgICAgICAgICAgIAlub2Rlcy5wdXNoKGNuKTsNCiAgICAgICAgICAgICAgICB9DQogICAgCQl9DQogICAgDQogICAgCQkvLyByZW1vdmUgYW55IG51bGxzDQogICAgCQlub2RlcyA9IG5vZGVzLmZsYXQoKS5maWx0ZXIobiA9PiBuKTsNCiAgICAJCQ0KICAgIAkJaWYgKCFub2Rlcy5sZW5ndGgpIHsNCiAgICAJCQlub2Rlcy5wdXNoKDwlPW5zY29wZSU+Ll9ub2RlKTsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJbm9kZXMgPSB0aGlzLl91bmlxdWUobm9kZXMsICdfY29kZScpOw0KICAgIAkJbG9nKCdub2Rlcy5sZW5ndGgnLCBub2Rlcy5sZW5ndGgpOw0KDQogICAgCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2Ygbm9kZXMpIHsNCiAgICAJCQlsZXQgblJldCA9IG51bGw7DQogICAgCQkJbG9nKGAke219IEAgJHtuPy5jb2RlKCkgfHwgJ0xPQ0FMJ31gKTsNCiAgICAJCQlpZiAoIW4gfHwgdGhpcy5fc2FtZUVudGl0eSg8JT1uc2NvcGUlPi5fbm9kZSwgbikpIHsNCiAgICAJCQkJLy8gbG9jYWwgc2NyaXB0DQogICAgCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2JlZm9yZVJ1bGVzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICA8JXZhbHVlT2YoInIuU2NyaXB0IiklPg0KICAgIAkJCQkJLy9hd2FpdCB0aGlzLl9TY3JpcHQoY2xhc3NOYW1lLCByLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdCZWZvcmVSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOw0KICAgIAkJCQl9DQoNCiAgICAJCQkJblJldCA9IGF3YWl0IGZTY3JpcHQoKTsNCg0KICAgIAkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19hZnRlclJ1bGVzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICA8JXZhbHVlT2YoInIuU2NyaXB0IiklPg0KICAgIAkJCQkJLy9hd2FpdCB0aGlzLl9TY3JpcHQoY2xhc3NOYW1lLCByLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdBZnRlclJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7DQogICAgCQkJCX0NCiAgICAJCQl9IGVsc2Ugew0KICAgIAkJCQluUmV0ID0gYXdhaXQgc291cmNlLl9pbnZva2VOb2RlKG4sIG0sIG9QYXJhbXMpOw0KICAgIAkJCX0NCiAgICANCiAgICAJCQlyZXN1bHRzLnB1c2goew0KICAgIAkJCQlub2RlOiBuLA0KICAgIAkJCQlyZXQ6IG5SZXQNCiAgICAJCQl9KTsNCiAgICAJCX0NCiAgICAJCWxvZyhyZXN1bHRzLCAiX2V4ZWN1dGUiLCAnUmVzdWx0cycpOw0KICAgIA0KICAgIAkJbGV0IGVycm9ycyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5yZXQgJiYgci5yZXQuX19leGNlcHRpb24pLm1hcChyID0+ICh7DQogICAgCQkJbm9kZTogci5ub2RlID8gew0KICAgIAkJCQljb2RlOiByLm5vZGUuY29kZSgpLA0KICAgIAkJCQlhZGRyZXNzOiByLm5vZGUuYWRkcmVzcygpDQogICAgCQkJfSA6IG51bGwsDQogICAgCQkJX19leGNlcHRpb246IHIucmV0Ll9fZXhjZXB0aW9uDQogICAgCQl9KSk7DQoNCiAgICAJCWlmIChlcnJvcnMubGVuZ3RoKSB7DQogICAgCQkJd2FybigiZXJyb3JzIiwgZXJyb3JzKTsNCiAgICAJCX0NCiAgICANCiAgICAJCXJldHVybiByZXN1bHRzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgZXJyb3IoZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX1NjcmlwdCclPihjbGFzc05hbWUsIHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIF9ub2RlLCAuLi5zZkFyZ3Mpew0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICBzY29wZSA9IHNjb3BlIHx8IDwlPXNjb3BlJT47DQogICAgICAgIA0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsYXNzTmFtZSwgc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgX25vZGUsIC4uLnNmQXJncyk7DQo8JSB9ZWxzZXslPg0KICAgIAlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47DQogICAgCQ0KICAgICAgICB0cnl7DQogICAgCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdzdHJpbmcnKSBzY3JpcHQgPSB0aGlzLnJ1blNjcmlwdChgKCkgPT4geyR7c2NyaXB0fX1gKTsNCiAgICANCiAgICAJCWxldCByZXQgPSBudWxsOw0KICAgIAkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnZnVuY3Rpb24nKSB7DQogICAgCQkJcmV0ID0gYXdhaXQgc2NyaXB0KCk7DQogICAgCQl9DQogICAgDQogICAgCQlyZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5jbGFzc05hbWUsIG0sIHR5cGUsIHNjcmlwdCwgZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoNCiAgICA8JT1tTmFtZT0nX3NhbWVFbnRpdHknJT4oLi4uYXJFbnRpdGllcyl7DQogICAgICAgIGlmKGFyRW50aXRpZXMubGVuZ3RoPT0wKSByZXR1cm4gZmFsc2U7DQogICAgICAgIGlmKGFyRW50aXRpZXMubGVuZ3RoPT0xKSBhckVudGl0aWVzLnB1c2godGhpcyk7DQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oLi4uYXJFbnRpdGllcyk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICByZXR1cm4gYXJFbnRpdGllcy5zbGljZSgxKS5ldmVyeShlID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgdiA9IGFyRW50aXRpZXNbMF07DQogICAgICAgICAgICAgICAgbGV0IG5lZ1Rlc3QgPSB7DQogICAgICAgICAgICAgICAgICAgIHZOdWxsOiB2PT1udWxsLA0KICAgICAgICAgICAgICAgICAgICBlTnVsbDogZT09bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgdk9iamVjdDogdHlwZW9mKHYpIT09J29iamVjdCcsDQogICAgICAgICAgICAgICAgICAgIGVPYmplY3Q6IHR5cGVvZihlKSE9PSdvYmplY3QnLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjEsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIGlmKE9iamVjdC5rZXlzKE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5rZXlzKG5lZ1Rlc3QpLmZpbHRlcihrID0+IG5lZ1Rlc3Rba10pLm1hcChrID0+ICh7diwgZSwgW2tdOiB0cnVlfSkpKSkubGVuZ3RoKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgLy8gcGFzc2VkIGluaXRpYWwgY29uc2lzdGVuY3kgY2hlY2sNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2PT1lKSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBuZWdUZXN0ID0gew0KICAgICAgICAgICAgICAgICAgICBldkNvbnN0cjogdi5jb25zdHJ1Y3Rvci5uYW1lIT1lLmNvbnN0cnVjdG9yLm5hbWUsDQogICAgICAgICAgICAgICAgICAgIGVFbnRpdHk6ICFlLkVudGl0eUNsYXNzLA0KICAgICAgICAgICAgICAgICAgICB2RW50aXR5OiAhdi5FbnRpdHlDbGFzcywNCiAgICAgICAgICAgICAgICAgICAgZXZFbnRpdHlOYW1lczogdHlwZW9mKGUuRW50aXR5Q2xhc3MuTmFtZSkhPT0ndW5kZWZpbmVkJyAmJiBlLkVudGl0eUNsYXNzLk5hbWUhPXYuRW50aXR5Q2xhc3MuTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgZXZFbnRpdHlJZHM6IHR5cGVvZihlLkVudGl0eUNsYXNzLklkKSE9PSd1bmRlZmluZWQnICYmIGUuRW50aXR5Q2xhc3MuSWQhPXYuRW50aXR5Q2xhc3MuSWQsDQogICAgICAgICAgICAgICAgICAgIGV2SURzOiB2LklkPT12LklkICYmIGUuSWQ9PWUuSWQgJiYgdi5JZCE9ZS5JZCwNCiAgICAgICAgICAgICAgICAgICAgZXZIYXNoOiB2Ll90b0hhc2gobnVsbCwge29ubHlVbmlxdWU6IHRydWV9LCAnPCU9bU5hbWUlPicpIT1lLl90b0hhc2gobnVsbCwge29ubHlVbmlxdWU6IHRydWV9LCAnPCU9bU5hbWUlPicpLA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjIsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIG5lZ1Rlc3QgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3Qua2V5cyhuZWdUZXN0KS5maWx0ZXIoayA9PiBuZWdUZXN0W2tdKS5tYXAoayA9PiAoe3YsIGUsIFtrXTogdHJ1ZX0pKSk7DQogICAgICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKG5lZ1Rlc3QpLmxlbmd0aCkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgPCU9bG9nKCklPjMsIG5lZ1Rlc3QpOw0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nZ2V0IFNldF9PbiclPigpIHsNCiAgICAgICAgbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0IHx8IG51bGwsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCB8fCBudWxsLA0KPCUgfSklPg0KICAgICAgICApKTsNCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J2dldCBTZXRfQ291bnQnJT4oKSB7DQogICAgICAgIHJldHVybiBbDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQsDQo8JSB9KSU+ICAgICAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIHRoaXMuXzwlPXRhTmFtZSU+X3NldCwNCjwlIH0pJT4NCiAgICAgICAgXS5maWx0ZXIocyA9PiBzKS5sZW5ndGg7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZmxhdHRlbiclPihkZXB0aCl7DQogICAgICAgIDwlPXdhcm4oKSU+IkRFUFJFQ0FURUQiKTsNCiAgICAgICAgbGV0IHJldCA9IHt9Ow0KICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIHJldC5fPCU9bk5hbWUoZWEpJT5fc2V0ID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0Ow0KICAgICAgICByZXQuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICByZXQuPCU9bk5hbWUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCk/dGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KGRlcHRoLTEpPCV9JT46dGhpcy48JT1uTmFtZShlYSklPigpOw0KPCUgfSklPg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgIHJldC48JT10YU5hbWUlPiA9IHRoaXMuPCU9dGFOYW1lJT4oKS5tYXAodCA9PiB0P3QuPCU9bU5hbWUlPihkZXB0aC0xKTp0KTsNCjwlIH0pJT4NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0hhc2gnJT4oYXJncywgb3B0aW9ucywgZlNvdXJjZSl7DQogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgICAgICANCiAgICAgICAgbGV0IG9IYXNoID0gew0KICAgICAgICAgICAgY2xhc3M6ICI8JT1uTmFtZShjKSU+IiwNCiAgICAgICAgICAgIHNvdXJjZTogZlNvdXJjZSwNCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MsDQogICAgICAgICAgICBfdGhpczoge30NCiAgICAgICAgfTsNCiAgICAgICAgDQogICAgICAgIGlmKCFvcHRpb25zLm5vVGhpcyAmJiBmU291cmNlIT0iPCU9bU5hbWUlPiIgJiYgKHR5cGVvZihvcHRpb25zLmRlcHRoKT09PSd1bmRlZmluZWQnIHx8IC0tb3B0aW9ucy5kZXB0aD4wKSl7DQogICAgICAgICAgICB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7DQogICAgICAgICAgICAgICAgT1BFUkFUT1JTOiAhb3B0aW9ucy5ub09wZXJhdG9ycywNCiAgICAgICAgICAgICAgICBfbWFwOiBvcHRpb25zLl9tYXAsDQogICAgICAgICAgICAgICAgVW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWUsDQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmpbaWRDb2RlXSA9IHYsDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPmlmKG9wdGlvbnMubm9UeXBlcykgcmV0dXJuOzwlfSU+DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gPCUgaWYoZWEuRW50aXR5VHlwZSl7JT52P3YuPCU9bU5hbWUlPihudWxsLCBvcHRpb25zLCBmU291cmNlKTo8JX0lPigob3B0aW9ucy5vbmx5VW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPik/KHZ8fG51bGwpOnYpOw0KICAgICAgICAgICAgICAgIH0sDQo8JSB9KSU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPihudWxsLCBvcHRpb25zLCBmU291cmNlKSksDQo8JSB9KSU+DQo8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IG9ialtlZkNvZGVdID0gdiwNCjwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKG9wdGlvbnMubm9BcmdzKSBvSGFzaCA9IG9IYXNoLl90aGlzOw0KICAgICAgICByZXR1cm4gb3B0aW9ucy5ub0NvZGU/b0hhc2g6dGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfYXV0aG9yaXplJyU+KHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcil7DQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiAhPCU9c2NvcGUlPi5fX3Rva2VuICYmIHRoaXMuVGVzdFsnPCU9bU5hbWUlPi51c2VybmFtZSddKXsNCiAgICAgICAgICAgIHVzZXJuYW1lID0gdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnVzZXJuYW1lJ107DQogICAgICAgICAgICBwYXNzd29yZCA9IHRoaXMuVGVzdFsnPCU9bU5hbWUlPi5wYXNzd29yZCddOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYoYlNlcnZlcil7DQogICAgICAgICAgICBpZih1c2VybmFtZSAmJiAhPCU9c2NvcGUlPi5fdGVzdFVzZXIgJiYgdGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnRlc3RVc2VyJ10pew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3Rlc3RVc2VyID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodGhpcy5UZXN0Wyc8JT1tTmFtZSU+LnRlc3RVc2VyJ10pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuc3RvcmUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLnVzZXJuYW1lKHVzZXJuYW1lLCAnPScpLnBhc3N3b3JkKHBhc3N3b3JkLCAnPScpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iU2VydmVyOiAiICsgYlNlcnZlcisiLCBPYmo6IiwgcmV0KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0KXsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoanNvbndlYnRva2VuKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0ganNvbndlYnRva2VuLnNpZ24ocmV0Ll90b0RvY3VtZW50KCksIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCB7IGV4cGlyZXNJbjogJzE4MDBzJyB9KTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShyZXQuX3RvRG9jdW1lbnQoKSkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIGFjY2Vzc190b2tlbjogcmV0LA0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4iU2VydmVyOiAiICsgYlNlcnZlcisiLCB0b2tlbjogIiwgcmV0KTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgbGV0IGNsaWVudF9pZCA9IHRoaXMuX19jb25maWcoJ2NsaWVudF9pZCcpOw0KICAgICAgICAgICAgbGV0IGNsaWVudF9zZWNyZXQgPSB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKTsNCiAgICANCiAgICAgICAgICAgIGlmKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgPCU9c2NvcGUlPi5fX3Rva2VuKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+Ik5vIHVzZXJuYW1lL3Bhc3N3b3JkIGFuZCB0b2tlbiBhbHJlYWR5IGV4aXN0cyIpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgIDwlaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgbGV0IGRhdGEgPSB7DQogICAgICAgICAgICAgICAgZ3JhbnRfdHlwZTogJ3Bhc3N3b3JkJywNCiAgICAgICAgICAgICAgICB1c2VybmFtZSwNCiAgICAgICAgICAgICAgICBwYXNzd29yZCwNCiAgICAgICAgICAgICAgICBjbGllbnRfaWQsDQogICAgICAgICAgICAgICAgY2xpZW50X3NlY3JldCwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBjb25maWcgPSB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgaWYoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiA8JT1zY29wZSU+Ll9fdG9rZW4gJiYgPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4pew0KICAgICAgICAgICAgICAgIGRhdGEgPSB7DQogICAgICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICJyZWZyZXNoX3Rva2VuIiwNCiAgICAgICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbjogPCU9c2NvcGUlPi5fX3Rva2VuLnJlZnJlc2hfdG9rZW4sDQogICAgICAgICAgICAgICAgICAgIGNsaWVudF9pZCwNCiAgICAgICAgICAgICAgICAgICAgY2xpZW50X3NlY3JldCwNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHs8JT1zY29wZSU+Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHs8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHs8JT1uc2NvcGUlPi5fbm9kZS5wYXJlbnQoKS5hZGRyZXNzKCl9OiR7PCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkucG9ydCgpIHx8IDMwMDB9L29hdXRoL3Rva2VuYCwgT2JqZWN0LmtleXMoZGF0YSkubWFwKGtleSA9PiBrZXkgKyAnPScgKyBkYXRhW2tleV0pLmpvaW4oJyYnKSwgY29uZmlnKTsNCiAgICAgICAgICAgIGlmKHJldC5kYXRhLmFjY2Vzc190b2tlbil7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3Rva2VuID0gcmV0LmRhdGE7DQoNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fdG9rZW4ucmVmcmVzaF90b2tlbil7DQogICAgICAgICAgICAgICAgICAgIGlmKGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS5jbGVhcikgYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLmNsZWFyKCk7DQogICAgICAgICAgICAgICAgICAgIGF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gcmVzcG9uc2UsIGFzeW5jIGVycm9yID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVxdWVzdCA9IGVycm9yLmNvbmZpZzsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YoPCU9c2NvcGUlPi5fX3Rva2VuLmFjY2Vzc190b2tlbik+MCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2F1dGhvcml6ZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSAnQmVhcmVyICcgKyA8JT1zY29wZSU+Ll9fdG9rZW4uYWNjZXNzX3Rva2VuOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBheGlvcyhvcmlnaW5hbFJlcXVlc3QpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKGF1dGhDbGFzcyl7JT4NCiAgICAJPCU9c2NvcGUlPi5fX3Rva2VuID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYXV0aENsYXNzKSU+KCkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS48JT1tTmFtZS5yZXBsYWNlKCdfJywgJycpJT4oKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICA8JT13YXJuKCklPiJObyBhdXRob3JpemF0aW9uIGRlZmluZWQiKTsNCiAgICA8JSB9JT4NCiAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPih1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOw0KPCV9JT4NCiAgICB9DQogICAgDQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX3NlcnZlciclPihvcHRpb25zPXt9KSB7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuY2xlYXJDb25zb2xlKSBjb25zb2xlLmNsZWFyKCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKDwlPXNjb3BlJT4uX19Ub29scykgPCU9c2NvcGUlPi5Ub29scyA9IDwlPXNjb3BlJT4uX19Ub29sczsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCk9PT0ndW5kZWZpbmVkJyAmJiB0eXBlb2YoPCU9c2NvcGUlPi5ocmVmcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgIAkJZm9yIGF3YWl0IChjb25zdCBsIG9mIDwlPXNjb3BlJT4uaHJlZnMpIHsNCiAgICAgICAgCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwubGliLCA8JT1zY29wZSU+LmhyZWZzLCBhc3luYyBfbCA9PiB7DQogICAgPCUgaWYoX2NOYW1lKCdTdG9yZWRTY3JpcHQnKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoX2wuc2NyaXB0ICYmIDwlPXNjb3BlJT4uVG9vbHMpIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1N0b3JlZFNjcmlwdCcsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF9sLnNjcmlwdCkubG9hZFNjcmlwdCgpOw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBsZXQgc2VjdXJlID0gdGhpcy5fX2NvbmZpZygnc2VjdXJlJyk7DQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAvLyBnbG9iYWxzDQogICAgICAgICAgICAgICAgdmFyIGdsb2JhbE1vZHVsZXMgPSB7DQogICAgICAgICAgICAgICAgICAgIGV4cHJlc3M6ICdleHByZXNzJywNCiAgICAgICAgICAgICAgICAgICAgaHR0cHM6ICdodHRwcycsDQogICAgICAgICAgICAgICAgICAgIGh0dHA6ICdodHRwJywNCiAgICAgICAgICAgICAgICAgICAgc2VsZnNpZ25lZDogJ3NlbGZzaWduZWQnLA0KICAgICAgICAgICAgICAgICAgICB1dGlsOiAndXRpbCcsDQogICAgICAgICAgICAgICAgICAgIGNvcnM6ICdjb3JzJywNCiAgICAgICAgICAgICAgICAgICAgYm9keVBhcnNlcjogJ2JvZHktcGFyc2VyJywNCiAgICAgICAgICAgICAgICAgICAgYXhpb3M6ICdheGlvcycsDQogICAgICAgICAgICAgICAgICAgIC8vY3J5cHRvOiAnY3J5cHRvJywNCiAgICAgICAgICAgICAgICAgICAgb3M6ICdvcycsDQogICAgICAgICAgICAgICAgICAgIC8vam1lc3BhdGg6ICdqbWVzcGF0aCcsDQogICAgICAgICAgICAgICAgICAgIGpzb25wYXRoOiAnanNvbnBhdGgnLA0KICAgICAgICAgICAgICAgICAgICBqc29uYXRhOiAnanNvbmF0YScsDQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdDogJ2RvdC1vYmplY3QnLA0KICAgICAgICAgICAgICAgICAgICBtYWNoaW5laWQ6ICdub2RlLW1hY2hpbmUtaWQnLA0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbWluaW1pc3Q6ICdtaW5pbWlzdCcsDQogICAgICAgICAgICAgICAgDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgICAgICAgICAgICAgICAgICBncmFwaHFsSFRUUDogJ2V4cHJlc3MtZ3JhcGhxbCcsDQogICAgICAgICAgICAgICAgICAgIGdyYXBocWw6ICdncmFwaHFsJywNCiAgICAgICAgICAgICAgICAgICAgcGxheWdyb3VuZDogJ2dyYXBocWwtcGxheWdyb3VuZC1taWRkbGV3YXJlLWV4cHJlc3MnLA0KPCUgfSU+DQoNCjwlIGlmKGMuQ29uZmlnICYmIGMuQ29uZmlnWydlbWFpbC5ob3N0J10peyU+DQogICAgICAgICAgICAgICAgICAgIG5vZGVtYWlsZXI6ICdub2RlbWFpbGVyJywNCjwlIH0lPg0KDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1sndG90cC5zZWNyZXQnXSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb3RwYXV0aDogJ290cGF1dGgnLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgICAgICAgICAgICAgICAgICBjaGlsZF9wcm9jZXNzOiAnY2hpbGRfcHJvY2VzcycsDQo8JSB9JT4NCg0KPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgICAgICAgICBldmVudHM6ICdldmVudHMnLA0KICAgICAgICAgICAgICAgICAgICBzb2NrZXRpbzogJ3NvY2tldC5pbycsDQogICAgICAgICAgICAgICAgICAgIG1xdHQ6ICdtcXR0JywNCiAgICAgICAgICAgICAgICAgICAgYW1xcGxpYjogJ2FtcXBsaWInLA0KICAgICAgICAgICAgICAgICAgICBwcm90b2J1ZmpzOiAncHJvdG9idWZqcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgZnM6ICdmcycsDQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnS2Fma2EnXSkpeyU+DQogICAgICAgICAgICAgICAgICAgIGthZmthanM6ICdrYWZrYWpzJywNCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbmVvNGo6ICduZW80ai1kcml2ZXInLA0KPCUgfSU+DQoNCjwlIGlmKF9jTmFtZSgnb0F1dGggVG9rZW4nKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgT0F1dGhTZXJ2ZXI6ICdleHByZXNzLW9hdXRoLXNlcnZlcicsDQo8JSB9ZWxzZSBpZihhdXRoQ2xhc3MpeyU+DQogICAgICAgICAgICAgICAgICAgIGpzb253ZWJ0b2tlbjogJ2pzb253ZWJ0b2tlbicsDQo8JSB9JT4NCg0KDQo8JSBpZihtYWluQ2xhc3MoWydTcWxEQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgc3FsaXRlOiAnc3FsaXRlMycsDQogICAgICAgICAgICAgICAgICAgIG15c3FsOiAnbXlzcWwnLA0KICAgICAgICAgICAgICAgICAgICBwb3N0Z3JlczogJ3BnJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnU25vd0ZsYWtlJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBzbm93Zmxha2U6ICdzbm93Zmxha2Utc2RrJywNCjwlIH0lPg0KPCUgaWYobWFpbkNsYXNzKFsnTW9uZ29EQiddKSl7JT4NCiAgICAgICAgICAgICAgICAgICAgbW9uZ29kYjogJ21vbmdvZGInLA0KPCUgfSU+DQo8JSBpZihtYWluQ2xhc3MoWydSeERCJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBSeERCOiAncnhkYicsDQo8JSB9JT4NCjwlIGlmKG1haW5DbGFzcyhbJ0V4Y2VsJ10pKXslPg0KICAgICAgICAgICAgICAgICAgICBYTFNYOiAneGxzeCcsDQo8JSB9JT4NCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IG1pc3NpbmdHbG9iYWxNb2R1bGVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsTW9kdWxlcykubWFwKGUgPT4gew0KICAgICAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxbZVswXV0gPSByZXF1aXJlKGVbMV0pOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT5leCk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVsxXTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pLmZpbHRlcihlID0+IGUpOw0KICAgICAgICAgICAgICAgIGlmKG1pc3NpbmdHbG9iYWxNb2R1bGVzLmxlbmd0aCkgPCU9d2FybigpJT4ibnBtIGluc3RhbGwgIiArIG1pc3NpbmdHbG9iYWxNb2R1bGVzLmpvaW4oJyAnKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAJCTwlPWxvZygpJT5gU3RhcnRpbmcgWyR7PCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUuY29kZSgpOicnfV0uLi5gKTsNCg0KCQkJaWYgKG9wdGlvbnMubG9hZFRvb2xzKSBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSB8fCBfY05hbWUoKSU+KCkuX2xvYWRUb29scyhvcHRpb25zLnNhdmVUb29scyk7DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXsgIC8qIFRvb2xzIGZpcnN0IG9yIE5vZGVzIGZpcnN0Pz8/ICovJT4NCiAgICAgICAgICAgIGlmKG9wdGlvbnMuaW5pdE5vZGUpew0KICAgICAgICAgICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlID0gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLnNlY3VyZShzZWN1cmUpLmluaXQodGhpcy5fX2NvbmZpZygnaW5pdC5sb29wJywgMC41KSk7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKDwlPW5zY29wZSU+Ll9ub2RlKT09PSd1bmRlZmluZWQnKSByZXR1cm4gPCU9ZXJyb3IoKSU+IjwlPW5zY29wZSU+Ll9ub2RlIGlzIHVuZGVmaW5lZCEiKTsNCiAgICAgICAgICAgIH0NCjwlIH0lPg0KDQogICAgCQlpZiAodHlwZW9mKHRoaXMuaW5pdCk9PT0nZnVuY3Rpb24nICYmIG9wdGlvbnMuaW5pdFNlbGYpIHsNCiAgICAJCQlhd2FpdCB0aGlzLmluaXQoKTsNCiAgICANCiAgICAJCQlsZXQgc3FsVG9vbCA9ICg8JT1zY29wZSU+LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5fX2RtbFN0YXRlbWVudHMpOw0KICAgIAkJCWlmIChvcHRpb25zLmNvcHlETUwgJiYgc3FsVG9vbCkgew0KICAgIAkJCQlsZXQgZG1scyA9IHNxbFRvb2wuX19kbWxTdGF0ZW1lbnRzOw0KICAgIAkJCQlpZiAoc3FsVG9vbC50eXBlLm5hbWUgPT0gJ1NxbERCJykgZG1scyA9IFsgLyoiQ3VzdG9tZXJzIiwgIk9yZGVycyIsICJTaGlwcGluZ3MiLCAqLyAiZGVtbyJdLm1hcCh0ID0+IGBkcm9wIHRhYmxlIGlmIGV4aXN0cyAke3R9YCkuY29uY2F0KGRtbHMpOw0KICAgIAkJCQlfRnJFTUQuX2NvcHlUZXh0VG9DbGlwYm9hcmQoZG1scy5qb2luKCc7XG4nKSk7DQogICAgCQkJfQ0KICAgIAkJfQ0KDQo8JSBpZihfY05hbWUoJ05vZGUgVHlwZScpKXsgLyp0b2RvOiByZXBsYWNlIHRoaXMgd2l0aCBhbiBPVEFVcGRhdGUgY29uY2VwdCAqLyU+DQogICAgICAgICAgICAvLyByZWZyZXNoIHNjcmlwdA0KICAgICAgICAgICAgdGhpcy5zZXRJbnRlcnZhbChudWxsLCBhc3luYyAoLyp2ZXJzaW9uKi8pID0+IHsNCiAgICAgICAgICAgICAgICBpZih0aGlzLnNyKCkuYkxvY2FsKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHNjdCA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZSBUeXBlJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoPCU9c2NvcGUlPi5fXzwlPV9jTmFtZSgnTm9kZSBUeXBlJyklPiB8fCB7bmFtZTogJ05vZGVKUyd9KTsNCiAgICAgICAgICAgICAgICBsZXQgY3QgPSBhd2FpdCBzY3QuZmluZCgpOw0KICAgICAgICAgICAgICAgIGlmKCFjdCB8fCAhY3QuYWN0aXZlKCkgfHwgIWN0LmVuYWJsZWQoKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKCAhc2N0LmRhdGUoKSB8fCAoKGN0LmRhdGUoKS5nZXRUaW1lKCkgLSBzY3QuZGF0ZSgpLmdldFRpbWUoKSkvMTAwMCkgPiA1ICl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gTmV3ZXIgdmVyc2lvbiBmb3VuZDogW2RhdGU6ICR7Y3QuZGF0ZSgpLnRvSVNPU3RyaW5nKCl9LCB0b29sOiAke2N0LlRvb2wubmFtZX1dLCBzdG9yaW5nLi4uYCk7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugd2FudCB0byBzdG9yZSB0aGUgY29udGVudCBkaXJlY3RseSB0byB0aGUgbm9kZWpzLmpzIGZpbGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGN0Ll9maWxlc3lzdGVtKGN0LmNvZGUoKSArICcuanMnLCB0aGlzLl9hdG9iKGN0LnJlbWFyaygpKSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZih3aW5kb3cpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5zZWxmICE9PSB3aW5kb3cudG9wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJpRnJhbWUgc2hvdWxkIGJlIHJlc3RhcnRlZC4uLiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+IndpbmRvdyBsb2NhdGlvbiByZWxvYWRpbmcuLi4iKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy93aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iZnJhbWUgY2hlY2siLCBleCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICANCiAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fXzwlPV9jTmFtZSgnTm9kZSBUeXBlJyklPiA9IHNjdC5kYXRlKGN0LmRhdGUoKSkubmFtZShjdC5uYW1lKCkpLmNvZGUoY3QuY29kZSgpKS5fdG9Eb2N1bWVudCgpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfSwgMC41KTsNCjwlIH0lPg0KICAgICAgICANCiAgICAgICAgICAgIGlmKG9wdGlvbnMubG9hZENvbnRlbnQgJiYgdHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJykgd2luZG93Lm9uaGFzaGNoYW5nZSA9IGFzeW5jICgpID0+IGRvY3VtZW50LmJvZHkgPSBhd2FpdCB0aGlzLl9leHBvcnQoe3RtcDogbG9jYXRpb24uaGFzaC5wYWdlfSk7DQogICAgDQogICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICBjb25zdCBhcHAgPSBleHByZXNzKCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgYXBwLnVzZShjb3JzKCkpOw0KICAgICAgICANCiAgICAgICAgICAgICAgICBhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IHRydWUsIGxpbWl0OiAnNTBtYid9KSk7DQogICAgICAgICAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oew0KICAgICAgICAgICAgICAgICAgICB2ZXJpZnk6IChyZXEsIHJlcywgYnVmKSA9PiByZXEucmF3Qm9keSA9IGJ1Zg0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyICYmIGF1dGhIZWFkZXIuc3BsaXQoJyAnKVsxXTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbiA9PSBudWxsKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAxKTsNCiAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGpzb253ZWJ0b2tlbi52ZXJpZnkodG9rZW4sIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCAoZXJyLCBvYmopID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDMpOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5fX2F1dGhvcml6YXRpb24gPSBvYmo7DQogICAgICAgICAgICAgICAgICAgICAgICBuZXh0KCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIA0KPCUgaWYoX2NOYW1lKCdvQXV0aCBUb2tlbicpKXslPg0KICAgICAgICAgICAgICAgIGFwcC5vYXV0aCA9IG5ldyBPQXV0aFNlcnZlcih7DQogICAgICAgICAgICAgICAgICAgIGRlYnVnOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAvLyB1c2VFcnJvckhhbmRsZXI6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIC8vIGNvbnRpbnVlTWlkZGxld2FyZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgLy8gcmVxdWlyZUNsaWVudEF1dGhlbnRpY2F0aW9uOiB7IHBhc3N3b3JkOiBmYWxzZSB9LA0KICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgbW9kZWw6ICgoKSA9PiAoew0KICAgICAgICAgICAgICAgIAkJZ2V0QWNjZXNzVG9rZW46IGJlYXJlclRva2VuID0+IG5ldyA8JT1zY29wZSU+Lk9BdXRoX1Rva2VuKCkuYWNjZXNzVG9rZW4oYmVhcmVyVG9rZW4pLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldEFjY2Vzc1Rva2VuJykpLnRoZW4odCA9PiB7dC5hY2Nlc3NUb2tlbkV4cGlyZXNBdCA9IG5ldyBEYXRlKHQuYWNjZXNzVG9rZW5FeHBpcmVzT24pOyByZXR1cm4gdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q2xpZW50OiAoY2xpZW50SWQsIGNsaWVudFNlY3JldCkgPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfQ2xpZW50KCkuaW5pdCgpLmZpbmFsbHkoKCkgPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfQ2xpZW50KCkuaWQoY2xpZW50SWQpLnNlY3JldChjbGllbnRTZWNyZXQpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKSkudGhlbih0ID0+IGFwcC5vYXV0aC5oYW5kbGVyKHQsICdnZXRDbGllbnQnKSksDQogICAgICAgICAgICAgICAgCSAgICBnZXRVc2VyOiAodXNlcm5hbWUsIHBhc3N3b3JkKSA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShhdXRoQ2xhc3MpJT4oKS5hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ2dldFVzZXInKSksDQogICAgICAgICAgICAgICAgCSAgICBzYXZlVG9rZW46ICh0b2tlbiwgY2xpZW50LCB1c2VyKSA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLl9mcm9tRG9jdW1lbnQodG9rZW4pLmNsaWVudChuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5fZnJvbURvY3VtZW50KGNsaWVudCkpLnVzZXIodXNlcikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc3RvcmUoKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ3NhdmVUb2tlbicpKSwNCiAgICAgICAgICAgICAgICAJICAgIHJldm9rZVRva2VuOiB0b2tlbiA9PiBuZXcgPCU9c2NvcGUlPi5PQXV0aF9Ub2tlbigpLnJlZnJlc2hUb2tlbih0b2tlbi5yZWZyZXNoVG9rZW4pLmNsaWVudChuZXcgPCU9c2NvcGUlPi5PQXV0aF9DbGllbnQoKS5pZCh0b2tlbi5jbGllbnQuaWQpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpKS5maW5kKCkudGhlbih0ID0+IHQuZW5hYmxlZChmYWxzZSkuYWN0aXZlKGZhbHNlKS5zdG9yZSgpKS50aGVuKHQgPT4gYXBwLm9hdXRoLmhhbmRsZXIodCwgJ3Jldm9rZVRva2VuJykpLA0KICAgICAgICAgICAgICAgIAkgICAgZ2V0UmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4gPT4gbmV3IDwlPXNjb3BlJT4uT0F1dGhfVG9rZW4oKS5yZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5maW5kKDIvKndoeSovKS50aGVuKHQgPT4gdC5fdG9Eb2N1bWVudCgpKS50aGVuKHQgPT4ge3QucmVmcmVzaFRva2VuRXhwaXJlc0F0ID0gbmV3IERhdGUodC5yZWZyZXNoVG9rZW5FeHBpcmVzT24pOyByZXR1cm4gdH0pLA0KICAgICAgICAJICAgICAgICB9KSkoKQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIGFwcC5vYXV0aC5oYW5kbGVyID0gKHQsIG0pID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobSkgPCU9bG9nKCklPm0sIHQuX3RvRG9jdW1lbnQoKSk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5fdG9Eb2N1bWVudCgpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT5tLCBleC50b1N0cmluZygpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIA0KICAgICAgICAgICAgICAgIGFwcC5wb3N0KCcvb2F1dGgvdG9rZW4nLCBhcHAub2F1dGgudG9rZW4oKSk7DQogICAgICAgICAgICAgICAgZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFwcC5vYXV0aC5hdXRoZW50aWNhdGUoKTsNCjwlIH0lPg0KDQo8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+IG0uSXNQdWJsaWMpLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBhcHAucG9zdCgnL21ldGhvZC88JT1uTmFtZShfYyklPi88JT1uTmFtZShtKSU+JywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIjwlPW5OYW1lKF9jKSU+IiwgIjwlPW5OYW1lKG0pJT4iKSk7DQogICAgICAgICAgICAgICAgYXBwLmdldCgnL21ldGhvZC88JT1uTmFtZShfYyklPi88JT1uTmFtZShtKSU+JywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIjwlPW5OYW1lKF9jKSU+IiwgIjwlPW5OYW1lKG0pJT4iKSk7DQo8JSB9KSklPg0KDQogICAgICAgICAgICAgICAgYXBwLnBvc3QoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7DQogICAgICAgICAgICAgICAgYXBwLmdldCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsNCiAgICAgICAgDQo8JSBpZihjLkNvbmZpZyAmJiBjLkNvbmZpZ1snZ3JhcGhxbCddKXslPg0KICAgICAgICAgICAgICAgIGFwcC51c2UoJy9ncmFwaHFsJywgZ3JhcGhxbEhUVFAuZ3JhcGhxbEhUVFAoew0KICAgICAgICAgICAgICAgICAgICBzY2hlbWE6IGdyYXBocWwuYnVpbGRTY2hlbWEodGhpcy5fdG9HUUxTY2hlbWEoKSksDQogICAgICAgICAgICAgICAgICAgIHJvb3RWYWx1ZTogdGhpcy5fcWxSZXNvbHZlcigpLA0KICAgICAgICAgICAgICAgICAgICBncmFwaGlxbDogdGhpcy5fX2NvbmZpZygicGxheWdyb3VuZCIpLA0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCJwbGF5Z3JvdW5kIikgJiYgdHlwZW9mKHBsYXlncm91bmQpIT09InVuZGVmaW5lZCIpIGFwcC5nZXQoJy9wbGF5Z3JvdW5kJywgcGxheWdyb3VuZC5kZWZhdWx0KHsgZW5kcG9pbnQ6ICcvZ3JhcGhxbCcgfSkpDQo8JSB9JT4NCg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4udHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7DQogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JyksDQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLl9fY29uZmlnKCdlbWFpbC51c2VyJyk/ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXI6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5wYXNzd29yZCcpLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTp1bmRlZmluZWQsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgPCU9c2NvcGUlPi50cmFuc3BvcnRlci5zZW5kTWFpbCh7DQogICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5zZW5kZXInKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvLA0KICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdCwNCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgcG9ydCA9IDwlPW5zY29wZSU+Ll9ub2RlPyg8JT1uc2NvcGUlPi5fbm9kZS5wb3J0KCkgfHwgMzAwMCk6MzAwMDsNCiAgICAgICAgICAgICAgICBsZXQgYWRkcmVzcyA9ICIwLjAuMC4wIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgbGlzdGVuID0gYXN5bmMgKCkgPT4gPCU9bG9nKCklPmA8JT1zY29wZSU+WyR7dGhpcy5pcEFkZHJlc3MoKX1dIGxpc3RlbmluZyBhdCBodHRwJHtzZWN1cmU/J3MnOicnfTovLyR7YWRkcmVzc306JHtwb3J0fWApOw0KICAgICAgICAgICAgICAgIGlmKHNlY3VyZSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBjZXJ0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGU6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydDogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5jZXJ0JykpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgY2VydCA9IHNlbGZzaWduZWQuZ2VuZXJhdGUoW3sgbmFtZTogJ2NvbW1vbk5hbWUnLCB2YWx1ZTogJ25hbW1vdXIuY29tJyB9XSwgeyBkYXlzOiAzNjUgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLmV4U2VydmVyID0gaHR0cHMuY3JlYXRlU2VydmVyKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogY2VydC5wcml2YXRlLA0KICAgICAgICAgICAgICAgICAgICAgICAgY2VydDogY2VydC5jZXJ0DQogICAgICAgICAgICAgICAgICAgIH0sIGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGdsb2JhbC5leFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2luYm91bmRDYWxsJyU+KHJlcSwgcmVzLCBjTmFtZSwgbU5hbWUpew0KICAgICAgICBsZXQgcmV0ID0ge307DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IG5ldyA8JT1zY29wZSU+W3JlcS5wYXJhbXMuY2xhc3MgfHwgY05hbWVdKCkuX2ludm9rZShyZXEucGFyYW1zLm1ldGhvZCB8fCBtTmFtZSwgcmVxLmJvZHksIHJlcS5xdWVyeSwgcmVxLl9fYXV0aG9yaXphdGlvbik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgICAgICByZXQgPSB7DQogICAgICAgICAgICAgICAgRXhjZXB0aW9uOiAiRXhjZXB0aW9uOiAiICsgZXgsDQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYocmV0ICYmIHR5cGVvZihyZXQpPT09Im51bWJlciIpIHJldCA9IHJldC50b1N0cmluZygpOw0KICAgICAgICByZXMuc2VuZChyZXQpOw0KICAgIH0NCg0KPCUgaWYoYy5Db25maWdbJ2dyYXBocWwnXSl7JT4NCiAgICA8JT1tTmFtZT0nX3FsU2VsZWN0aW9ucyclPihzU2V0KXsNCiAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICBpZighc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0Ow0KICAgICAgICANCiAgICAgICAgc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gew0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZihzLm5hbWUudmFsdWU9PSI8JT1uTmFtZShlYSklPiIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4nUmVmZXJlbmNlIGZvciA8JT1uTmFtZShlYSklPicsIHMpOw0KICAgICAgICAgICAgICAgIGxldCBzT2JqID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+KHRoaXMpOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKHNPYmopOw0KICAgICAgICAgICAgICAgIHJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOw0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfcWxSZXNvbHZlciclPigpew0KICAgICAgICByZXR1cm4gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShfYyklPjogYXN5bmMgKHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbykgPT4gew0KICAgICAgICAgICAgICAgIGlmKCFwYXJlbnQuZGF0YSkgcGFyZW50LnF1ZXJ5ID0gcGFyZW50LnF1ZXJ5IHx8IHt9Ow0KICAgICAgICAgICAgICAgIGxldCBvYmogPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLl9mcm9tRG9jdW1lbnQocGFyZW50LnF1ZXJ5IHx8IHBhcmVudC5kYXRhKTsNCiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCiAgICAgICAgICAgICAgICBpZihwYXJlbnQucXVlcnkpew0KICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGRzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLmZpbmRBbGwobnVsbCwgb2JqLl9xbFNlbGVjdGlvbnMoY29udGV4dC5maWVsZE5vZGVzWzBdLnNlbGVjdGlvblNldCksIG51bGwsIG51bGwsIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLmNvbmNhdChjb250ZXh0LmZpZWxkTm9kZXNbMF0uc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMubWFwKHMgPT4gcy5uYW1lLnZhbHVlKSkpOw0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmVudC5kYXRhKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgb2JqLnN0b3JlKCk7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5fX2Fzc2VydEVycm9yKSB0aHJvdyBvYmouX19hc3NlcnRFcnJvcjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldC5tYXAociA9PiByLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0P3JldC5fdG9Eb2N1bWVudCgpOnJldDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIF9jLkVudGl0eU1ldGhvZHMuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAgICAgICAgIC8vIDwlPW5OYW1lKF9tKSU+OiAocGFyZW50LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShfYyklPigpLjwlPW5OYW1lKF9tKSU+KCI8JT1uTmFtZShfbSklPiIsIHBhcmVudCwgYXJncywgY29udGV4dCwgaW5mbyksDQogICAgPCUgfSklPg0KPCUgfSklPg0KICAgICAgICB9Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvR1FMU2NoZW1hJyU+KCl7DQogICAgICAgIGxldCByZXQgPSBgDQp0eXBlIFF1ZXJ5IHsNCjwlIGFyQ2xhc3Nlcy5mb3JFYWNoKF9jID0+IHslPg0KICAgICIiIg0KICAgIEZpbmQgYWxsIG1hdGNoZXMgZm9yIDwlPW5OYW1lKF9jKSU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4ocXVlcnk6IDwlPW5OYW1lKF9jKSU+SW5wdXQpOiBbPCU9bk5hbWUoX2MpJT5dDQo8JSB9KSU+DQp9DQoNCnR5cGUgTXV0YXRpb24gew0KPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQogICAgIiIiDQogICAgU3RvcmUgYSBzaW5nbGUgPCU9bk5hbWUoX2MpJT4gb2JqZWN0DQogICAgIiIiDQogICAgPCU9bk5hbWUoX2MpJT4oZGF0YTogPCU9bk5hbWUoX2MpJT5JbnB1dCk6IDwlPW5OYW1lKF9jKSU+DQo8JSB9KSU+DQp9DQogICAgDQogICAgPCUgYXJDbGFzc2VzLmZvckVhY2goX2MgPT4geyU+DQoiIiINCklucHV0IHR5cGUgZm9yIDwlPW5OYW1lKF9jKSU+DQoiIiINCmlucHV0IDwlPW5OYW1lKF9jKSU+SW5wdXR7DQogICAgPCUgX2MuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhLCB0cnVlKSU+DQogICAgPCUgfSklPg0KICAgIDwlIF9jLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCAmJiB0YS5FbnRpdHlUeXBlKS5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCU9bk5hbWUodGEpJT5fPCU9dGFOYW1lJT46IFs8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPklucHV0XQ0KICAgIDwlIH0pJT4NCiAgICBPUEVSQVRPUlM6IDwlPW5OYW1lKF9jKSU+T3BlcmF0b3INCn0NCg0KaW5wdXQgPCU9bk5hbWUoX2MpJT5PcGVyYXRvcnsNCiAgICA8JSBfYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPg0KICAgIDwlPW5OYW1lKGVhKSU+OiBTdHJpbmcNCiAgICA8JSB9KSU+DQp9DQoNCiIiIg0KPCU9X2MuUmVtYXJrJT4NCiIiIg0KdHlwZSA8JT1uTmFtZShfYyklPnsNCiAgICBfaWQ6IElEIQ0KICAgIDwlIF9jLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgIiIiDQogICAgPCU9ZWEuUmVtYXJrJT4NCiAgICAiIiINCiAgICA8JT1uTmFtZShlYSklPjogPCU9cWxUeXBlKGVhKSU+PCU9ZWEuSXNSZXF1aXJlZD8nISc6JyclPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QgJiYgdGEuRW50aXR5VHlwZSkuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyAlPg0KICAgIDwlPW5OYW1lKHRhKSU+XzwlPXRhTmFtZSU+OiBbPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT5dDQogICAgPCUgfSklPg0KDQogICAgPCUgX2MuRW50aXR5TWV0aG9kcy5maWx0ZXIoX20gPT4gIV9tLk1ldGhvZFBhcmFtZXRlcnMubGVuZ3RoKS5mb3JFYWNoKF9tID0+IHslPg0KICAgICIiIg0KICAgIDwlPV9tLlJlbWFyayU+DQogICAgIiIiDQogICAgPCU9bk5hbWUoX20pJT46IDwlPXFsVHlwZShfbS5SZXNwb25zZUF0dHJpYnV0ZSwgdHJ1ZSklPg0KICAgIDwlIH0pJT4NCiAgICA8JSBfYy5FbnRpdHlNZXRob2RzLmZpbHRlcihfbSA9PiBfbS5NZXRob2RQYXJhbWV0ZXJzLmxlbmd0aCkuZm9yRWFjaChfbSA9PiB7JT4NCiAgICAiIiINCiAgICA8JT1fbS5SZW1hcmslPg0KICAgICIiIg0KICAgIDwlPW5OYW1lKF9tKSU+KDwlPV9tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gbk5hbWUocCkgKyAnOiAnICsgcWxUeXBlKHAsIHRydWUpKS5qb2luKCcsICcpJT4pOiA8JT1xbFR5cGUoX20uUmVzcG9uc2VBdHRyaWJ1dGUpJT4NCiAgICA8JSB9KSU+DQp9DQogICAgPCUgfSklPg0KICAgICAgICBgOw0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9IC8vIGdyYXBoJT4NCg0KPCUgfSAvLyBJc01haW4gJT4NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW52b2tlTm9kZSclPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7DQogICAgICAgIC8vIGlmKCFuKSByZXR1cm4gbnVsbDsNCiAgICAgICAgDQogICAgICAgIGlmKHR5cGVvZig8JT1uc2NvcGUlPi5fbm9kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT13YXJuKCklPiI8JT1uc2NvcGUlPi5fbm9kZSBub3QgZGVmaW5lZCIpOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKGV2ZW50KXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSl7JT4NCiAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpIT0nPCU9bk5hbWUoYyklPicpew0KICAgICAgICAgICAgICAgIGxldCBvQ2xhc3MgPSBudWxsOw0KICAgICAgICAgICAgICAgIGlmKGZhbHNlKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPiJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKycuJyttZXRob2QrJyAuLi4uJyk7DQogICAgPCUgc3IuZ3JvdXBCeShhckNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5mb3JFYWNoKGVtID0+IHslPg0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKFsiPCU9ZW0udmFsdWVzLm1hcChtYyA9PiBuTmFtZShtYykpLmpvaW4oJyIsICInKSU+Il0uaW5kZXhPZihldmVudC5jbGFzc05hbWUoKSk+PTApew0KICAgICAgICAgICAgICAgICAgICBvQ2xhc3MgPSBuZXcgPCU9c2NvcGUlPjwlPWVtLmtleT8oJy4nK2VtLmtleS5BbGlhcyk6JyclPltldmVudC5jbGFzc05hbWUoKV0oKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBvQ2xhc3MuPCU9bU5hbWUlPihuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsNCiAgICAgICAgICAgIH0NCjwlIH1lbHNleyU+DQogICAgICAgICAgICA8JT1lcnJvcigpJT4iRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsNCiAgICAgICAgICAgIHJldHVybiBudWxsOw0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGRhdGEgPSBkYXRhIHx8IHt9Ow0KDQogICAgICAgIGlmKHR5cGVvZihkYXRhKT09PSJvYmplY3QiKXsNCiAgICAgICAgICAgIGRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9KU09OKHtwYXJzZTogMX0pOw0KICAgICAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQogICAgPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uQ29kZShtKSU+Ijogew0KICAgICAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBkYXRhLjwlPW5OYW1lKHApJT4gPSBkYXRhLjwlPW5OYW1lKHApJT4/ZGF0YS48JT1uTmFtZShwKSU+DQogICAgICAgICAgICA8JWlmKHAuSXNBcnJheSl7JT4ubWFwKF9wID0+IF9wPCV9JT4NCiAgICAgICAgICAgIDwlIGlmKHAuRW50aXR5VHlwZSl7JT4uX3RvRG9jdW1lbnQoKQ0KICAgICAgICAgICAgPCUgfWVsc2UgaWYocC5Jc0RhdGUpeyU+LnRvSVNPU3RyaW5nKCkNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgPCVpZihwLklzQXJyYXkpeyU+KTwlfSU+OnVuZGVmaW5lZDsNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgPCUgfSklPg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCjwlIGlmKF9jTmFtZSgnTm9kZScpKXslPg0KICAgICAgICBpZih0eXBlb2Yobik9PT0nc3RyaW5nJykgbiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTm9kZScsIHRydWUpJT4oKS5jb2RlKG4pOw0KPCUgfSU+DQoNCiAgICAgICAgaWYoIW4gfHwgPCU9bnNjb3BlJT4uX25vZGUuX3NhbWVFbnRpdHkobikpew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7DQogICAgICAgICAgICA8JT1sb2coKSU+IkxvY2FsIG5vZGUiLCByZXQpOw0KDQogICAgICAgIH1lbHNlIGlmKG4uYWRkcmVzcygpKXsNCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+bi5hZGRyZXNzKCksIG4ucG9ydCgpLCBtZXRob2QpOw0KICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBkYXRhLCBudWxsLCBudWxsLCB7cGF0aDogYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kLzwlPW5OYW1lKGMpJT4vJHttZXRob2R9YCwgaGVhZGVyczoge319KTsNCiAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9ZWxzZXsNCjwlIGlmKF9jTmFtZSgnRXZlbnQnKSAmJiBjLk5hbWUhPT0nRXZlbnQnKXslPg0KICAgICAgICAgICAgaWYodHlwZW9mKGRhdGEpPT09Im9iamVjdCIpew0KICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsNCiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8NCiAgICAgICAgICAgIDwlIC8qdW5SZWN1cnNlKCdkYXRhJywgJ21ldGhvZCcsICd7fScsICcnLCA1LCAnX190aGlzLmNvZGUnKSovICU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBldiA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRXZlbnQnLCB0cnVlKSU+KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnPCU9c2NvcGUlPi5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJzwlPW5OYW1lKGMpJT4nKS5zZW5kZXIoPCU9bnNjb3BlJT4uX25vZGUpLmNhcnJpZXIoPCU9bnNjb3BlJT4uX25vZGUpLnBheWxvYWQodGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShkYXRhKSkpOw0KICAgICAgICAgICAgaWYoZXZlbnQpew0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOw0KICAgICAgICAgICAgICAgIGlmKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YocmV0KT09PSJzdHJpbmciKXsNCiAgICAgICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlIGlmKHJldCAmJiB0eXBlb2YocmV0LnBheWxvYWQpPT09J2Z1bmN0aW9uJyl7DQogICAgICAgICAgICAgICAgLy8gcmV0IGlzIGFuIGV2ZW50DQogICAgICAgICAgICAgICAgcmV0ID0gcmV0LnBheWxvYWQoKTsNCiAgICAgICAgICAgIH1lbHNlIGlmKEFycmF5LmlzQXJyYXkocmV0KSAmJiByZXRbMF0gJiYgdHlwZW9mKHJldFswXS5wYXlsb2FkKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgIHJldCA9IHJldC5tYXAociA9PiByLnBheWxvYWQoKSk7DQogICAgICAgICAgICAgICAgaWYocmV0Lmxlbmd0aD09MSkgcmV0ID0gcmV0WzBdOw0KICAgICAgICAgICAgfQ0KPCUgfSU+DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpIHJldHVybiBudWxsOw0KICAgICAgICByZXQgPSByZXQuZGF0YSB8fCByZXQ7DQoNCiAgICAgICAgaWYocmV0Ll9fZXhjZXB0aW9uKXsNCiAgICAgICAgICAgIC8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyDQogICAgICAgICAgICA8JT1lcnJvcigpJT5gRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfQ0KDQogICAgICAgIHN3aXRjaChtZXRob2Qpew0KPCUgYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7JT4NCiAgICAgICAgICAgIGNhc2UgIjwlPW5Db2RlKG0pJT4iOiB7DQogICAgPCUgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBpZighYlJhdykgcmV0ID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSwgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQocmV0KTsNCiAgICA8JSB9ICU+DQogICAgPCUgaWYobS5OYW1lPT0nYXV0aG9yaXplJyl7JT4NCiAgICAgICAgICAgICAgICA8JT1zY29wZSU+Ll9fdG9rZW4gPSB7dG9rZW5fdHlwZTogIkJlYXJlciIsIGFjY2Vzc190b2tlbjogcmV0fTsNCiAgICA8JSB9ICU+DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQo8JSB9KTsgJT4NCg0KICAgICAgICAgICAgY2FzZSAiaW5zZXJ0IjoNCiAgICAgICAgICAgIGNhc2UgInVwZGF0ZSI6DQogICAgICAgICAgICBjYXNlICJzdG9yZSI6DQogICAgICAgICAgICBjYXNlICJkZWxldGUiOg0KICAgICAgICAgICAgY2FzZSAiZmluZCI6IA0KICAgICAgICAgICAgY2FzZSAiZmluZEFsbCI6IHsNCiAgICAgICAgICAgICAgICBpZighYlJhdykgcmV0ID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQocmV0KTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCjwlIGlmKG1haW5DbGFzcygpKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfaW52b2tlJyU+KG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopew0KICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjKSU+LicgKyBtZXRob2QpOw0KICAgICAgICA8JT1sb2coKSU+bWV0aG9kLCBxdWVyeSwgYm9keSk7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2YoYm9keSk9PT0nc3RyaW5nJyl7DQogICAgICAgICAgICBpZig8JT1fYjY0dGVzdCgnYm9keScpJT4peyAvLyBiYXNlNjQ/DQogICAgICAgICAgICAgICAgYm9keSA9IHRoaXMuX2F0b2IoYm9keSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKC9bXiw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdLy50ZXN0KGJvZHkpKXsgLy8ganNvbg0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGxldCBfcGFyYW1zID0gcXVlcnk/T2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSk6Ym9keTsNCiAgICAgICAgaWYodHlwZW9mKF9wYXJhbXMpPT09J3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOw0KICAgICAgICANCiAgICAgICAgaWYoX3BhcmFtcyl7DQogICAgICAgICAgICBfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBfcGFyYW1zID0ge307DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+Il9wYXJhbXMiLCBfcGFyYW1zKTsNCg0KICAgIDwlIGlmKF9jTmFtZSgnTm9kZScpICYmIGMuTmFtZSE9J05vZGUnKXslPg0KICAgICAgICBpZihfcGFyYW1zLl9fbm9kZSl7DQogICAgICAgICAgICAvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPw0KICAgICAgICAgICAgbGV0IHRuID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdOb2RlJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLyouX2RlUmVmZXJlbmNlKCkqLzsNCiAgICAgICAgICAgIGRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsNCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYywgdHJ1ZSklPigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQoNCiAgICAgICAgaWYoX3BhcmFtcy5fX3RoaXMpIHsNCiAgICAgICAgICAgIF9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7DQogICAgICAgICAgICBsZXQgX190aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS8qLl9kZVJlZmVyZW5jZSgpKi87DQogICAgICAgICAgICBkZWxldGUgX3BhcmFtcy5fX3RoaXM7DQogICAgICAgICAgICByZXR1cm4gYXdhaXQgX190aGlzLjwlPW1OYW1lJT4obWV0aG9kLCBfcGFyYW1zLCBudWxsLCBhdXRoT2JqKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGxldCBhckFyZ3MgPSBbXTsNCiAgICAgICAgc3dpdGNoKG1ldGhvZCl7DQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgY2FzZSAiPCU9bkNvZGUobSklPiI6IHsNCjwlIGlmKF9jTmFtZSgnVHJhbnNhY3Rpb24nKSAmJiBfY05hbWUoJ0NvbnRlbnQnKSAmJiBjLk5hbWUhPSdUcmFuc2FjdGlvbicgJiYgIW0uSXNTeW5jKXslPg0KICAgICAgICBpZighX3BhcmFtcy5TeW5jKXsNCiAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbnRlbnQnLCB0cnVlKSU+KChhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbnRlbnQnLCB0cnVlKSU+KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2NvcGUoIjwlPXNjb3BlJT4iKS5jbGFzcygiPCU9Yy5OYW1lJT4iKS5tZXRob2QobWV0aG9kKS5hdXRob3JpemF0aW9uKGF1dGhPYmopLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnBheWxvYWQodGhpcy5fYnRvYShfcGFyYW1zKSkudHJhbnNhY3Rpb25fVHJhbnNhY3Rpb25Mb2dzKFtuZXcgPCU9c2NvcGUlPi5UcmFuc2FjdGlvbkxvZygpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnN0YXRlKG5ldyA8JT1zY29wZSU+LlRyYW5zYWN0aW9uU3RhdGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCJsb2FkZWQiKSldKS5zdG9yZSgpKS5JZCkuX3RvRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KPCUgfSU+DQoNCiAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICA8JSBpZihwLkVudGl0eVR5cGUgJiYgcC5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgIF9wYXJhbXMuPCU9bkNvZGUocCklPiA9IF9wYXJhbXMuPCU9bkNvZGUocCklPi5tYXAocCA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS5fZnJvbURvY3VtZW50KHApLl9kZVJlZmVyZW5jZSgpKTsNCiAgICAgICAgPCUgfWVsc2UgaWYocC5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBfcGFyYW1zLjwlPW5Db2RlKHApJT4gPSBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShwLkVudGl0eVR5cGUpJT4oKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuPCU9bkNvZGUocCklPikuX2RlUmVmZXJlbmNlKCk7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLjwlPW5Db2RlKHApJT4pOw0KICAgIDwlIH0pOyU+DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQo8JSB9KTslPg0KDQogICAgICAgICAgICBjYXNlICJmaW5kQWxsIjp7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7DQogICAgICAgICAgICAgICAgYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsNCiAgICAgICAgICAgICAgICBhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlICJmaW5kIjogew0KICAgICAgICAgICAgICAgIGFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCBvYmogPSB0aGlzOw0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IG51bGw7DQogICAgICAgIGlmKCFvYmopew0KICAgICAgICAgICAgcmV0ID0gew0KICAgICAgICAgICAgICAgIF9fZXhjZXB0aW9uOiB7DQogICAgICAgICAgICAgICAgICAgICctMSc6IGA8JT1uTmFtZShjKSU+LjwlPW1OYW1lJT46IG9iaiBpcyB1bmRlZmluZWRgDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfWVsc2UgaWYoIW9ialttZXRob2RdKXsNCiAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICBfX2V4Y2VwdGlvbjogew0KICAgICAgICAgICAgICAgICAgICAnLTInOiBgPCU9bk5hbWUoYyklPi48JT1tTmFtZSU+OiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLA0KICAgICAgICAgICAgICAgICAgICAnb2JqJzogb2JqDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICByZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOw0KICAgICAgICB9DQogICAgICAgIA0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09IlNxbERCIil7ICU+DQogICAgICAgICAgICBpZihmYWxzZSAmJiA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgIHJldCA9IHsNCiAgICAgICAgICAgICAgICAgICAgX19leGNlcHRpb246IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyA8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsDQogICAgICAgICAgICAgICAgICAgICAgICAnb2JqJzogb2JqDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgPCUgfSU+DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICBpZihyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbil7DQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UgPSB7fTsNCiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSl7DQogICAgICAgICAgICAgICAgbGV0IF9yZXQgPSBbXTsNCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQoY29uc3QgciBvZiByZXQpew0KICAgICAgICAgICAgICAgICAgICBpZihyICYmIHIuX3RvRG9jdW1lbnQpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT4pIGRlbGV0ZSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPi5fdG9Eb2N1bWVudDsNCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXQucHVzaChhd2FpdCByLl90b0RvY3VtZW50KCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBfcmV0LnB1c2gocik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldCA9IF9yZXQ7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCk/YXdhaXQgcmV0Ll90b0RvY3VtZW50KCk6cmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+J3JldCcsIHJldCk7DQogICAgICAgIDwlPWxvZygpJT5gJHttZXRob2R9OiAke3RoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMpJT4uJyArIG1ldGhvZCl9YCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQo8JSBpZihfY05hbWUoJ05vZGUnKSl7JT4NCiAgICA8JT1tTmFtZT0nX3BhcnNlQ29kZVN0YXRlJyU+KHQpew0KICAgIDwlIGlmKG1haW5DbGFzcygpPT1jKXslPg0KICAgICAgICBsZXQgc3RhdGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LnN0YXRlJywgbnVsbCwge3Rvb2w6IHR9KSk7DQogICAgICAgIGxldCBjb2RlID0gdGhpcy5fX2NvbmZpZyh0aGlzLl9fY29uZmlnKCdvYXV0aC5yZWRpcmVjdC5jb2RlJywgbnVsbCwge3Rvb2w6IHR9KSk7DQogICAgICAgIGlmKCFzdGF0ZSB8fCAhY29kZSkgcmV0dXJuOw0KICAgICAgICBzdGF0ZSA9IEpTT04ucGFyc2UodGhpcy5fYXRvYihzdGF0ZSkpOw0KICAgICAgICBpZihzdGF0ZS50b29sIT09dC5uYW1lKSByZXR1cm47DQoNCiAgICAgICAgPCU9bG9nKCklPiJHT1QgQ09ERSAiICsgY29kZSArICIgZm9yIG5vZGUgIiArIHN0YXRlLm5jb2RlICsgIiB3aXRoIHRvb2wgIiArIHN0YXRlLnRvb2wpOw0KICAgICAgICBpZighPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkgfHwgITwlPW5zY29wZSU+Ll9ub2RlLl9wYXJlbnQuX3NhbWVFbnRpdHkoPCU9bnNjb3BlJT4uX25vZGUucGFyZW50KCkpKXsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nbmV3IHBhcmVudCcsIHN0YXRlLm5jb2RlKTsNCiAgICAgICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ05vZGUnLCB0cnVlKSU+KCkuY29kZShzdGF0ZS5uY29kZSkpOw0KICAgICAgICB9DQogICAgICAgIDwlPW5zY29wZSU+Ll9ub2RlLmF1dGhDb2RlKGNvZGUsIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVG9vbCcsIHRydWUpJT4oKS5uYW1lKHN0YXRlLnRvb2wpKTsNCiAgICAgICAgd2luZG93LmNsb3NlKCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPih0KTsNCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfbG9hZFRvb2xzJyU+KGJTdG9yZSl7DQogICAgICAgIGlmKDwlPXNjb3BlJT4uVG9vbHMgJiYgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPmBUb29scyBhbHJlYWR5IGxvYWRlZGApOw0KICAgICAgICAgICAgcmV0dXJuIDwlPXNjb3BlJT4uVG9vbHM7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIDwlPWxvZygpJT5gTG9hZGluZyB0b29scy4uLmApOw0KICAgICAgICANCiAgICAgICAgbGV0IHRvb2xzID0gW107DQogICAgICAgIHRvb2xzID0gPCU9c2NvcGUlPi5fX1Rvb2xzIHx8IHRvb2xzOw0KICAgICAgICBkZWxldGUgPCU9c2NvcGUlPi5fX1Rvb2xzOw0KDQogICAgICAgIGxldCBhclRvb2xzID0gPCU9X0ZyRU1ELl90b0pTKFsuLi5uZXcgU2V0KGFyQ2xhc3Nlcy5tYXAoX2MgPT4gX2MuVG9vbHMpLmZsYXQoKSldKSU+Ow0KICAgICAgICBsZXQgdG9vbE5hbWVzID0gYXJUb29scy5tYXAodCA9PiB0Lm5hbWUgfHwgKHQudHlwZT90LnR5cGUubmFtZTp0KSk7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHRvb2xzLmxlbmd0aCE9PXRvb2xOYW1lcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgIC8vIGNhbm5vdCB1c2UgcmVxdWlyZSB5ZXQsIG5vIHRvb2xzIHByb3Blcmx5IGxvYWRlZCB0byB1c2UgYSBsb2FkZXIgZnVuY3Rpb24NCiAgICAgICAgICAgICAgICB0b29scyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7TmFtZTogJ0FQSVNFUlZFUjwlPW1OYW1lJT4nLCBBY3RpdmU6IHRydWUsIEVuYWJsZWQ6IHRydWV9KSB8fCB0b29sczsNCiAgICAgICAgICAgIH0NCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgICAgICBpZighdG9vbHMubGVuZ3RoKSB0b29scyA9IChhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1Rvb2wnLCB0cnVlKSU+KCkuVEhJUyh0b29sTmFtZXMubWFwKHQgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLm5hbWUodCkpKS5maW5kQWxsKDIpKS5tYXAodCA9PiB0Ll90b0pTT04oe3BhcnNlOiAxfSkpIHx8IHRvb2xzOw0KPCUgfSU+DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT13YXJuKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgbGV0IGZpeFRvb2xzID0gdG9vbHMgPT4gew0KICAgICAgICAgICAgdG9vbHMuZmlsdGVyKHQgPT4gdHlwZW9mKHQpPT09J29iamVjdCcgJiYgdCkuZm9yRWFjaCh0ID0+IHsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5uYW1lJywgJ3QudHlwZS5uYW1lJyklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LmVuYWJsZWQnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgPCVfZGVmKCd0LnR5cGUuYWN0aXZlJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLmVuYWJsZWQnLCB0cnVlKSU+DQoNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudG9vbF9Db25maWdzJywgJ1tdJyklPjsNCiAgICAgICAgICAgICAgICA8JV9kZWYoJ3QudHlwZS50eXBlX0NvbmZpZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50eXBlLnR5cGVfTWFwcGluZ3MnLCAnW10nKSU+Ow0KICAgICAgICAgICAgICAgIDwlX2RlZigndC50b29sX01hcHBpbmdzJywgJ1tdJyklPjsNCiAgICANCiAgICAgICAgICAgICAgICBbXS5jb25jYXQodC50b29sX0NvbmZpZ3MsIHQudHlwZS50eXBlX0NvbmZpZ3MsIHQudHlwZS50eXBlX01hcHBpbmdzLCB0LnRvb2xfTWFwcGluZ3MpLmZvckVhY2goYyA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5hY3RpdmUnLCB0cnVlKSU+DQogICAgICAgICAgICAgICAgICAgIDwlX2RlZignYy5lbmFibGVkJywgdHJ1ZSklPg0KICAgICAgICAgICAgICAgICAgICA8JV9kZWYoJ2MuSWQnLCAndGhpcy5fdXVpZCgpJyklPg0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgDQogICAgICAgICAgICB0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodCk9PT0nb2JqZWN0JyAmJiB0KS5mb3JFYWNoKHQgPT4gWyd0b29sX0NvbmZpZ3MnLCAndHlwZS50eXBlX0NvbmZpZ3MnXS5mb3JFYWNoKHNDb25maWcgPT4gew0KICAgICAgICAgICAgICAgICAgICBEb3RPYmplY3Quc2V0KHNDb25maWcsIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSE9PSJvYmplY3QiKS5jb25jYXQoRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpPT09Im9iamVjdCIgJiYgYy52YWx1ZSkubWFwKGMgPT4gT2JqZWN0LmtleXMoYy52YWx1ZSkubWFwKG5jb2RlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBfYyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBjLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGMudmFsdWVbbmNvZGVdLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5jb2RlIT0iZGVmYXVsdCIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jLm5vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IG5jb2RlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLCA8JS8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMlPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiTm9kZUpTIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2M7DQogICAgICAgICAgICAgICAgICAgIH0pLmZsYXQoKSkuZmxhdCgpKSwgdCk7DQogICAgICAgICAgICAgICAgICAgIERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZvckVhY2goYyA9PiBjLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoYy52YWx1ZSkpOw0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICApOw0KICAgICAgICB9Ow0KDQoNCiAgICAgICAgZml4VG9vbHModG9vbHMpOw0KICAgICAgICB0b29scyA9IHRvb2xzLmZpbHRlcih0ID0+IHQuYWN0aXZlKTsNCiAgICAgICAgdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiB0b29sTmFtZXMuZmluZChfdCA9PiAodHlwZW9mKF90KT09PSdzdHJpbmcnP190Ol90Lm5hbWUpPT10Lm5hbWUpKTsNCg0KICAgICAgICA8JT1sb2coKSU+YFRvb2xzIGFyZSAke3Rvb2xzLmxlbmd0aH1gKTsNCg0KICAgICAgICA8JT1zY29wZSU+LlRvb2xzID0gdG9vbHM7DQoNCiAgICAgICAgPCU9c2NvcGUlPi5Ub29scy5maWx0ZXIodCA9PiAhdC5heGlvcyAmJiA8JT1KU09OLnN0cmluZ2lmeShfcmVzdFRvb2xzKSU+LmluZGV4T2YodC50eXBlLm5hbWUpPj0wKS5mb3JFYWNoKHQgPT4gew0KICAgICAgICAgICAgdC5heGlvcyA9IHR5cGVvZihheGlvcy5jcmVhdGUpPT09J2Z1bmN0aW9uJz9heGlvcy5jcmVhdGUoKTpheGlvczsNCiAgICAgICAgICAgIHQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKHJlcXVlc3QgPT4gdGhpcy5fcmVxdWVzdEludGVyY2VwdG9yKHJlcXVlc3QsIHQpLCBlcnJvciA9PiB7fSk7DQogICAgICAgICAgICB0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gcmVzcG9uc2UsIGVycm9yID0+IHRoaXMuX3Jlc3BvbnNlSW50ZXJjZXB0b3IoZXJyb3IsIHQpKTsNCiAgICAgICAgfSk7DQogICAgICAgIA0KICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBsb2FkZWQgdG9vbHMhISENCiAgICAgICAgbGV0IHRvb2wgPSB0aGlzLlRvb2w7DQogICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+LlRvb2xzKXsNCjwlIHNyLmdyb3VwQnkoYXJDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykuZm9yRWFjaChlbSA9PiB7ZW0udmFsdWVzID0gZW0udmFsdWVzLnNvcnQoKGEsIGIpID0+IGIuUmFuayAtIGEuUmFuayk7ICU+DQogICAgICAgICAgICBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZW0udmFsdWVzWzBdLCB0cnVlKSU+KHVuZGVmaW5lZCwgdCkuX3N0b3JlRW50aXR5Q2xhc3MoPCU9ZW0udmFsdWVzWzBdLlJhbmslPik7DQo8JSB9KSU+DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5Ub29sID0gdG9vbDsNCiAgICAgICAgDQogICAgICAgIGFyVG9vbHMgPSBhclRvb2xzLmZpbHRlcihfdCA9PiAhdG9vbHMuZmluZCh0ID0+ICh0eXBlb2YoX3QpPT09J3N0cmluZyc/X3Q6X3QubmFtZSk9PXQubmFtZSkpOw0KICAgICAgICBmaXhUb29scyhhclRvb2xzKTsNCg0KPCUgaWYoX2NOYW1lKCdUb29sJykpeyU+DQogICAgICAgIDwlPXNjb3BlJT4ub1Rvb2xzID0gPCU9c2NvcGUlPi5Ub29scy5jb25jYXQoYXJUb29scykuZmlsdGVyKHQgPT4gdC5hY3RpdmUpLm1hcCh0ID0+IHsNCiAgICAgICAgICAgIHQudG9vbF9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udG9vbCk7DQogICAgICAgICAgICB0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udHlwZSk7DQogICAgDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUb29sJywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQodCk7DQogICAgICAgIH0pOw0KICAgICAgICBpZihiU3RvcmUpew0KICAgICAgICAgICAgPCU9bG9nKCklPmBTYXZpbmcgdG9vbHMuLi5gKTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiA8JT1zY29wZSU+Lm9Ub29scyl7DQogICAgICAgICAgICAgICAgYXdhaXQgdC5zdG9yZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQo8JSB9JT4NCg0KICAgICAgICA8JT1sb2coKSU+YEV4aXRpbmdgKTsNCiAgICAgICAgcmV0dXJuIHRvb2xzOw0KICAgIH0NCiAgICANCjwlIH0gLy8gbWFpbkNsYXNzICU+DQoNCgk8JT1tTmFtZT0nX3BhcmFtZXRyaXplJyU+KHN0ciwgZnVuLCBvcHRpb25zPXt9LCBwcmVmaXg9J3t7JywgcG9zdGZpeD0nfX0nKSB7DQo8JSBpZihtYWluQ2xhc3MoKT09Yyl7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYodHlwZW9mKHN0cikhPT0nc3RyaW5nJykgcmV0dXJuIHN0cjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJleCA9IGAke3ByZWZpeH0oW14ke3Bvc3RmaXh9XSspJHtwb3N0Zml4fWA7DQogICAgICAgICAgICAoc3RyLm1hdGNoKG5ldyBSZWdFeHAocmV4LCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHN0ciA9IHN0ci5yZXBsYWNlKG0sIG0gPT4gZnVuKG0ucmVwbGFjZShwcmVmaXgsICcnKS5yZXBsYWNlKHBvc3RmaXgsICcnKSkpKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHN0cjsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfWVsc2V7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcygpKSU+KCkuPCU9bU5hbWUlPihzdHIsIGZ1biwgb3B0aW9ucywgcHJlZml4LCBwb3N0Zml4KTsNCjwlIH0lPg0KCX0NCg0KICAgIDwlPW1OYW1lPSdfX3N5bmNfb24nJT4oZCl7DQogICAgICAgIHRoaXMuXzwlPW1OYW1lJT4gPSB0aGlzLl88JT1tTmFtZSU+IHx8IHt9Ow0KICAgIA0KICAgICAgICBpZihkKXsgLy8gc2V0IHRoZSB2YWx1ZQ0KICAgICAgICAgICAgdGhpcy5fPCU9bU5hbWUlPlt0aGlzLlRvb2wubmFtZV0gPSBkOw0KDQogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2ltcG9ydCh0aGlzLCB7DQogICAgICAgICAgICAgICAgQ3ljbGljOiB0cnVlLA0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gdGhpcy48JT1uTmFtZShlYSklPigpP3RoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOnVuZGVmaW5lZCwNCjwlIH0pJT4NCg0KPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgLy88JT10YU5hbWUlPjogdGhpcy48JT10YU5hbWUlPigpLmZvckVhY2godCA9PiB0LjwlPW1OYW1lJT4oZCkpLA0KPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBkKTsNCg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuXzwlPW5OYW1lKGVhKSU+X3NldCAmJiB0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KGQpOw0KPCUgfSklPg0KDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIC8vIHRoaXMuPCU9dGFOYW1lJT4oKS5mb3JFYWNoKHQgPT4gdC48JT1tTmFtZSU+KGQpKTsNCjwlIH0pJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHRoaXMuXzwlPW1OYW1lJT5bdGhpcy5Ub29sLm5hbWVdOyAvLyBnZXQgdGhlIHZhbHVlDQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfY2xvbmUnJT4oYlR5cGVBdHRyaWJ1dGVzKXsNCiAgICAgICAgPCU9d2FybigpJT4iREVQUkVDQVRFRDogdXNlIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShjLk5hbWUsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KHRoaXMuX3RvSlNPTigpKSIpOw0KDQogICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMuTmFtZSwgdHJ1ZSklPigpLCB7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPW5OYW1lKGVhKSU+KHY8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKTwlfSU+KSwNCjwlIH0pOyU+DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBiVHlwZUF0dHJpYnV0ZXM/b2JqLjwlPXRhTmFtZSU+KHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4oYlR5cGVBdHRyaWJ1dGVzKSkpOm51bGwsDQo8JSB9KTslPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWFwJyU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSl7DQogICAgICAgIF90aGlzID0gX3RoaXMgfHwgdGhpczsNCiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7DQogICAgICAgIHRvb2wgPSB0b29sIHx8IF90aGlzLlRvb2w7DQogICAgICAgIGNvZGVUeXBlID0gY29kZVR5cGUgfHwgPCU9X2VhVHlwZXMoKSU+W2NvZGVdOw0KICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgIjwlPW5OYW1lKGMpJT4iOw0KICAgICAgICBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZSB8fCAiPCU9Yy5FbnRpdHlNb2R1bGU/Yy5FbnRpdHlNb2R1bGUuTmFtZTonJyU+IjsNCg0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgX2xvZyA9IGAke21vZHVsZU5hbWV9LiR7Y2xhc3NOYW1lfS4ke2NvbnRleHR9JHtiUmV2ZXJzZT8nPD0nOic9Pid9JHtjb2RlfWA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vaWYoQXJyYXkuaXNBcnJheShvYmpGcm9tKSkgcmV0dXJuIG9iakZyb20ubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvLCBvYmpUbywgZWFDb2RlLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlLCBfdGhpcywgbW9kdWxlTmFtZSkpOw0KICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHRlbXB0ZWQgdG8gdXNlIGpzb25hdGEgaW4gUXVlcnkgZmllbGRzLCBkb2VzIG5vdCB3b3JrIGJlY2F1c2UganNvbmF0YS5ldmFsdWF0ZSByZXR1cm4gYSBwcm9taXNlISEhICovJT4NCiAgICAgICAgICAgIGxldCBzRmllbGQgPSBiUmV2ZXJzZT8ndGFyZ2V0Jzonc291cmNlJzsNCiAgICAgICAgICAgIGxldCBzU2NyaXB0ID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHNDb25kID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydDb25kaXRpb24nOw0KICAgICAgICAgICAgbGV0IHNQYXRoID0gKGJSZXZlcnNlPydvdXQnOidpbicpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0RmllbGQgPSBiUmV2ZXJzZT8nc291cmNlJzondGFyZ2V0JzsNCiAgICAgICAgICAgIGxldCB0U2NyaXB0ID0gKGJSZXZlcnNlPydpbic6J291dCcpKydTY3JpcHQnOw0KICAgICAgICAgICAgbGV0IHRQYXRoID0gKGJSZXZlcnNlPydpbic6J291dCcpKydQYXRoJzsNCiAgICAgICAgICAgIGxldCB0Q29uZCA9IChiUmV2ZXJzZT8naW4nOidvdXQnKSsnQ29uZGl0aW9uJzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGxvZyA9ICguLi5zKSA9PiA8JT1sb2coKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Y2xhc3NOYW1lLCBfbG9nLCAuLi5zKTsNCiAgICAgICAgICAgIGxldCBlcnJvciA9ICguLi5zKSA9PiA8JT1lcnJvcigpJT5jbGFzc05hbWUsIF9sb2csIC4uLnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb3B0aW9ucyA9IHtfY2xhc3M6IGNsYXNzTmFtZSwgX3RoaXM6IF90aGlzLCB0b29sOiB0b29sfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9zY3JpcHQgPSAocywgbSkgPT4gew0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVuU2NyaXB0KGAob1Njb3BlLCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpID0+ICR7c31gKSg8JT1zY29wZSU+LCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSwgX3RoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUsIGVhQ29kZSwgYlJldmVyc2UsIGNvbnRleHQsIGxvZywgd2FybiwgZXJyb3IpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIHdhcm4obS50ZXN0cy5sb2csIGV4KTsgDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IF9tYXRjaCA9IChzLCByKSA9PiB7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHMpPT09J3VuZGVmaW5lZCcgfHwgcz09PW51bGwgfHwgdHlwZW9mKHMubWF0Y2gpIT09J2Z1bmN0aW9uJykgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSBzLm1hdGNoKG5ldyBSZWdFeHAociwgJ2cnKSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHM9PXIgfHwgKChhbnN3ZXIgJiYgYW5zd2VyLmxlbmd0aCk/dHJ1ZTpmYWxzZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGNvbnN0IGNsb25lID0gaXRlbXMgPT4gaXRlbXMubWFwKGl0ZW0gPT4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGNsb25lKGl0ZW0pIDogaXRlbSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtcyA9IGNsb25lKCBbLi4uKHRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKV0gKTsgLy8gZG8gbm90IHRhbXBlciB3aXRoIHRoZSBtYXBwaW5ncywgZGVlcCBjbG9uZQ0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IE9iamVjdC5rZXlzKG0pLmZvckVhY2goayA9PiBtW2tdID0gdGhpcy5fcGFyYW1ldHJpemUobVtrXSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKSkpOw0KICAgICAgICAgICAgbXMuZm9yRWFjaChtID0+IG0udGVzdHMgPSB7DQogICAgICAgICAgICAgICAgYWN0aXZlOiA8JXZhbHVlT2YoIm0uYWN0aXZlIiklPiwgLy9fc2NyaXB0KG0uYWN0aXZlLCBtKSwNCiAgICAgICAgICAgICAgICBlbmFibGVkOiA8JXZhbHVlT2YoIm0uZW5hYmxlZCIpJT4sIC8vX3NjcmlwdChtLmVuYWJsZWQsIG0pLA0KICAgICAgICAgICAgICAgIGNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLA0KICAgICAgICAgICAgICAgIGNsYXNzOiBfbWF0Y2goY2xhc3NOYW1lLCBtLmNsYXNzTmFtZSksDQogICAgICAgICAgICAgICAgbW9kdWxlOiBfbWF0Y2gobW9kdWxlTmFtZSwgbS5tb2R1bGVOYW1lKSwNCiAgICAgICAgICAgICAgICBzRmllbGQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pLA0KICAgICAgICAgICAgICAgIHNTY3JpcHQ6IHR5cGVvZihjb2RlKT09PSd1bmRlZmluZWQnIHx8IHR5cGVvZihtW3NTY3JpcHRdKSE9PSd1bmRlZmluZWQnLA0KICAgICAgICAgICAgICAgIHNQYXRoOiB0eXBlb2YobVtzUGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGFyZ2V0OiB0eXBlb2YobVt0RmllbGRdIHx8IG1bdFNjcmlwdF0gfHwgbVt0UGF0aF0pIT09J3VuZGVmaW5lZCcsDQogICAgICAgICAgICAgICAgdGV4dDogYCR7Y29kZX06JHtzRmllbGR9PT0+JHt0RmllbGR9YCwNCiAgICAgICAgICAgICAgICBsb2c6IGAke19sb2d9WyR7bS5jb250ZXh0fS8ke20uY2xhc3NOYW1lfV1gLA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBtcyA9IG1zLmZpbHRlcihtID0+IG0udGVzdHMuYWN0aXZlICYmIG0udGVzdHMuZW5hYmxlZCAmJiBtLnRlc3RzLmNvbnRleHQgJiYgbS50ZXN0cy5jbGFzcyAmJiBtLnRlc3RzLm1vZHVsZSAmJiAobS50ZXN0cy5zRmllbGQgfHwgbS50ZXN0cy5zU2NyaXB0IHx8IG0udGVzdHMuc1BhdGgpICYmIG0udGVzdHMudGFyZ2V0KS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIDwlIC8qIHdlIG1pZ2h0IG5vdCB3b3JrIHdpdGggYWxsIG1zIGVudHJpZXMuIGxvZyBoZXJlIGlzIG9ubHkgYSBwcmV2aWV3IG9mIHdoYXQgbWlnaHQgd29yayEgKi8gJT4NCiAgICAgICAgICAgIC8vaWYobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZykubGVuZ3RoKSBsb2codGhpcy5fYmVhdXRpZnkobXMuZmlsdGVyKG0gPT4gbS5kZWJ1ZyksICdqYXZhc2NyaXB0JykpOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gew0KICAgICAgICAgICAgICAgIGlmKG1bdFNjcmlwdF0pew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0Q29uZF0pPT09J3VuZGVmaW5lZCcgfHwgPCV2YWx1ZU9mKCJtW3RDb25kXSIsICdfdGhpcycpJT4pew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZykgbG9nKG0udGVzdHMubG9nICsgJzogJyArIHRTY3JpcHQsICc8JT1tTmFtZSU+JywgbVt0U2NyaXB0XSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gPCV2YWx1ZU9mKCJtW3RTY3JpcHRdIiwgJ190aGlzJyklPg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bc1BhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJykgY29kZSA9IGptZXNwYXRoLnNlYXJjaChvYmpGcm9tLCBtW3NQYXRoXSk7DQogICAgICAgICAgICAgICAgaWYobVtzUGF0aF0gJiYgdHlwZW9mKGpzb25wYXRoKSE9PSd1bmRlZmluZWQnKSBjb2RlID0ganNvbnBhdGgucXVlcnkob2JqRnJvbSwgbVtzUGF0aF0pOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdEZpZWxkXSl7DQogICAgICAgICAgICAgICAgICAgIGxldCBkUGF0aCA9ICcnOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YobVt0RmllbGRdKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRQYXRoID0gYCR7Y29kZX0ucmVwbGFjZWA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKG1bc0ZpZWxkXSwgJ2cnKSwgbVt0RmllbGRdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29kZSA9IERvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvZGUpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZFBhdGggPSBgJHtjb2RlfS5jb2RlYDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IG1bdEZpZWxkXTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkUGF0aCA9IGBkb3Rjb3B5YDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYobS5kZWJ1ZyAmJiBkUGF0aCkgbG9nKGAke20udGVzdHMubG9nfS8ke2RQYXRofVtjb2RlPSR7Y29kZX1dOiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqbWVzcGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0Q29uZF0pKSkgb2JqVG9bbVt0RmllbGRdXSA9IGptZXNwYXRoLnNlYXJjaChvYmpUbywgbVt0UGF0aF0pOw0KICAgICAgICAgICAgICAgIGlmKG1bdFBhdGhdICYmIHR5cGVvZihqc29ucGF0aCkhPT0ndW5kZWZpbmVkJyAmJiAoIW1bdENvbmRdIHx8IGpzb25wYXRoLnF1ZXJ5KG9ialRvLCBtW3RDb25kXSkpKSBvYmpUb1ttW3RGaWVsZF1dID0ganNvbnBhdGgucXVlcnkob2JqVG8sIG1bdFBhdGhdKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBtcy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udGVzdHMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0eXBlb2YoY29kZSk9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgcmV0dXJuIG9ialRvOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL2lmKGNvbnRleHQ9PSdFbnRpdHlDbGFzcycgJiYgY2xhc3NOYW1lPT0nVXNlcicpIDwlPXdhcm4oKSU+IkdPVCBIRVJFIiwgY29kZSwgY29udGV4dCwgb3B0aW9ucyk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyYW1ldHJpemUoY29kZSwgcCA9PiB0aGlzLl9fY29uZmlnKHApIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfbkNvZGUnJT4oY29kZSwgb0NvZGUpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOw0KICAgICAgICAgICAgaWYoIWNvZGUgJiYgIW9Db2RlKXsNCiAgICAgICAgICAgICAgICBjb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsNCiAgICAgICAgICAgICAgICBjb2RlID0gIjwlPW5Db2RlKGMpJT4iOw0KICAgICAgICAgICAgICAgIG9Db2RlID0gPCU9X0ZyRU1ELl90b0pTKGMuQ29kZSklPjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgbGV0IHJldCA9IGNvZGU7DQogICAgICAgICAgICBpZihvQ29kZSAmJiB0eXBlb2Yob0NvZGUpPT09J29iamVjdCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCBvQ29kZVt0aGlzLlRvb2wudHlwZS5uYW1lXSB8fCByZXQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tYXAocmV0LCBmYWxzZSwgY29udGV4dCkgfHwgcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5leCk7DQogICAgICAgICAgICByZXR1cm4gY29kZTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX19jb25maWcnJT4obiwgbnVsbFZhbHVlLCBvcHRpb25zKXsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQogICAgICAgIG9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7DQogICAgICAgIG9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJzwlPW5OYW1lKGMpJT4nOw0KICAgICAgICBvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwgb3B0aW9ucy5fdGhpcy5Ub29sIHx8IHRoaXMuVG9vbDsNCiAgICAgICAgaWYodHlwZW9mKG9wdGlvbnMudG9vbCk9PT0nb2JqZWN0JyAmJiBvcHRpb25zLnRvb2wuY29uc3RydWN0b3IubmFtZT09J1Rvb2wnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sLm5hbWUoKSk7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy50b29sKT09PSdzdHJpbmcnKSBvcHRpb25zLnRvb2wgPSAoPCU9c2NvcGUlPi5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZT09b3B0aW9ucy50b29sIHx8IHQudHlwZS5uYW1lPT1vcHRpb25zLnRvb2wpOw0KDQo8JSBpZihtYWluQ2xhc3MoKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoKSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4obiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHtfdGhpczogdGhpcywgdG9vbDogdGhpcy5Ub29sLCBfY2xhc3M6ICc8JT1uTmFtZShjKSU+J30sIG9wdGlvbnMgfHwge30pKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zLnRvb2wpIT09J29iamVjdCcpIDwlPXdhcm4oKSU+b3B0aW9ucy50b29sKTsNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLnRvb2wpIDwlPXdhcm4oKSU+InRvb2wgbm90IGRlZmluZWQiLCBvcHRpb25zLl90aGlzLlRvb2wsIDwlPXNjb3BlJT4uVG9vbHMsIG9wdGlvbnMuX3RoaXMuVG9vbHMpOw0KICAgICAgICAgICAgLy9vcHRpb25zLm5vQ2FjaGUgPSB0cnVlOw0KICAgICAgICAgICAgaWYoIW9wdGlvbnMubm9DYWNoZSkgPCU9c2NvcGUlPi48JT1tTmFtZSU+ID0gPCU9c2NvcGUlPi48JT1tTmFtZSU+IHx8IHt9Ow0KDQogICAgICAgICAgICBsZXQgbklEID0gPCU9bnNjb3BlJT4uX25vZGU/PCU9bnNjb3BlJT4uX25vZGUuY29kZSgpOidkZWZhdWx0JzsNCg0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnNbbl0pIT09J3VuZGVmaW5lZCcpIG51bGxWYWx1ZSA9IG51bGxWYWx1ZSB8fCBvcHRpb25zW25dOw0KICAgICAgICAgICAgbGV0IHJldCA9IG51bGxWYWx1ZTsNCiAgICAgICAgICAgIGlmKHR5cGVvZihyZXQpPT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHJldCA9IG51bGw7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy8gdXNlIHNjb3BlIGNhY2hlIChpbXByb3ZlcyBwZXJmb3JtYW5jZT8/PykNCiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5ub0NhY2hlICYmIE9iamVjdC5oYXNPd24oPCU9c2NvcGUlPi48JT1tTmFtZSU+LCBgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gKSkgcmV0dXJuIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gdG9vbF9Db25maWdzLCB0eXBlX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQ0KICAgICAgICAgICAgbGV0IHRjb25mID0gW10uY29uY2F0KG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncyB8fCBbXSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYyAmJiBjLm5hbWU9PW4gJiYgKCFjLm5vZGUgfHwgYy5ub2RlLmNvZGU9PW5JRCkpLnNvcnQoYyA9PiBjLm5vZGU/KGMubm9kZS5jb2RlPT0nZGVmYXVsdCc/MDotMSk6MSk7DQogICAgICAgICAgICBpZih0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgIGlmKHRjb25mWzBdLnNjcmlwdCl7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IHRjb25mWzBdLnNjcmlwdDsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBfc2MgPSB0aGlzLl9wYXJhbWV0cml6ZSh0Y29uZlswXS5zY3JpcHQsIHAgPT4gdGhpcy48JT1tTmFtZSU+KHAsIG51bGwsIG9wdGlvbnMpIHx8IERvdE9iamVjdC5waWNrKHAsIG9wdGlvbnMpLCBvcHRpb25zKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJfc2MiKSU+Ow0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICByZXQgPSB0Y29uZlswXS52YWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgICAgICAgICAgWzEsMiwzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsNCiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGpleCl7fQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmKG9wdGlvbnMubmV3VmFsdWUpew0KICAgICAgICAgICAgICAgIGxldCB0YyA9IHRjb25mLmxlbmd0aD90Y29uZlswXTp7fTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLm5vZGUpIHRjLm5vZGUgPSB7Y29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKX07DQogICAgICAgICAgICAgICAgdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgICAgIHRjLm5hbWUgPSBuOw0KICAgICAgICAgICAgICAgIGlmKCF0Y29uZi5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MpLnB1c2godGMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLm5ld1ZhbHVlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nDQogICAgICAgICAgICBsZXQgbWNvbmYgPSBvcHRpb25zLl90aGlzLkNvbmZpZz9vcHRpb25zLl90aGlzLkNvbmZpZ1tuXTp1bmRlZmluZWQ7DQogICAgICAgICAgICBtY29uZiA9IHRoaXMuX3BhcmFtZXRyaXplKG1jb25mLCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICBtY29uZiA9IDwldmFsdWVPZigibWNvbmYiKSU+Ow0KICAgICAgICAgICAgaWYodHlwZW9mKG1jb25mKSE9PSJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsNCg0KICAgICAgICAgICAgLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KXsNCiAgICAgICAgICAgICAgICByZXQgPSBEb3RPYmplY3QucGljayhuLCBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKSkgfHwgcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcNCiAgICAgICAgICAgIGlmKHRoaXMuJF9SRVFVRVNUKSByZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIGNvbmZpZyByZXBsYWNlbWVudA0KICAgICAgICAgICAgcmV0ID0gdGhpcy5fcGFyYW1ldHJpemUocmV0LCBwID0+IHRoaXMuPCU9bU5hbWUlPihwLCBudWxsLCBvcHRpb25zKSB8fCBEb3RPYmplY3QucGljayhwLCBvcHRpb25zKSwgb3B0aW9ucyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLm5vQ2FjaGUpIDwlPXNjb3BlJT4uPCU9bU5hbWUlPltgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gXSA9IHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0ID0gPCV2YWx1ZU9mKCJyZXQiKSU+Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9d2FybigpJT5uLCBudWxsVmFsdWUsIG9wdGlvbnMuX2NsYXNzLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KDQo8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgIC8qKg0KICAgICAqIFN1bW1hcnkuIDwlPW0uTmFtZSU+Lg0KICAgICAqDQogICAgICogRGVzY3JpcHRpb24uIDwlPW0uUmVtYXJrJT4uDQogICAgICoNCiAgICAgKiBAc2luY2UgICAgICB4LngueA0KICAgICAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuDQogICAgICogQGFjY2VzcyAgICAgcHVibGljDQogICAgICoNCiAgICAgKiBAY2xhc3MNCiAgICAgKiBAYXVnbWVudHMgcGFyZW50DQogICAgICogQG1peGVzICAgIG1peGluDQogICAgICoNCiAgICAgKiBAYWxpYXMgICAgcmVhbE5hbWUNCiAgICAgKiBAbWVtYmVyb2YgbmFtZXNwYWNlDQogICAgICoNCiAgICAgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24NCiAgICAgKiBAbGluayBVUkwNCiAgICAgKiBAZ2xvYmFsDQogICAgICoNCiAgICAgKiBAZmlyZXMgICBldmVudE5hbWUNCiAgICAgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lDQogICAgICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQ0KICAgICAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLg0KICAgICAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4NCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4NCiAgICAgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4NCiAgICAgKg0KICAgICAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKg0KICAgICAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4NCiAgICAgKi8NCiAgICA8JSBpZighbS5Jc1N5bmMpeyU+YXN5bmMgPCV9JT48JT1tTmFtZT1uQ29kZShtKSU+KDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuQ29kZShwKSkuam9pbignLCAnKSU+KXsNCg0KICAgIAlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAwLCAuLi5tc2cpOw0KICAgIAlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2coIjwlPW5OYW1lKGMpJT4iLCBvYmosICI8JT1uQ29kZShtKSU+IiwgbnVsbCwgMSwgLi4ubXNnKTsNCiAgICAJbGV0IGVycm9yID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZygiPCU9bk5hbWUoYyklPiIsIG9iaiwgIjwlPW5Db2RlKG0pJT4iLCBudWxsLCAyLCAuLi5tc2cpOw0KICAgIAlsZXQgb1Njb3BlID0gPCU9YWxpYXMoKSU+Ow0KICAgIAlsZXQgcFNjb3BlID0gPCU9c2NvcGUlPjsNCiAgICAgICAgDQogICAgDQo8JSBpZighbS5Jc1N5bmMpeyU+DQogICAgPCUgaWYoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbnVsbDsNCiAgICA8JSB9ZWxzZSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICBsZXQgYW5zd2VyID0gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSwgdHJ1ZSklPigpOw0KICAgIDwlIH1lbHNlIGlmKG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNCb29sKXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IGZhbHNlOw0KICAgIDwlIH1lbHNlIGlmKG0uSXNBcnJheSl7ICU+DQogICAgICAgIGxldCBhbnN3ZXIgPSBbXTsNCiAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgbGV0IGFuc3dlciA9IG51bGw7DQogICAgPCUgfSAlPg0KICAgIA0KICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUobnVsbCwgPCU9YWxpYXMoKSU+LCAiPCU9bkNvZGUobSklPiIsIDwlbVJvdXRpbmcoYywgbSklPiwgYXN5bmMgKCkgPT4gew0KICAgICAgICANCjwlIH0lPg0KPCUgbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRGVmYXVsdCkuZm9yRWFjaChwID0+IHslPg0KICAgICAgICBpZih0eXBlb2YoPCU9bk5hbWUocCklPik9PT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICA8JT1uTmFtZShwKSU+ID0gPCV2YWx1ZU9mKHAuRGVmYXVsdCklPjsNCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgIHZhciBlcnJvcnMgPSB7DQogICAgICAgIDwlICBbXS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuUmVxdWlyZWQpLm1hcChwID0+ICh7DQogICAgICAgICAgICAgICAgQ29kZTogYCR7bk5hbWUocCl9LXJlcXVpcmVkYCwNCiAgICAgICAgICAgICAgICBFcnJvcjogYCR7bk5hbWUocCl9IGlzIGEgcmVxdWlyZWQgUGFyYW1ldGVyYCwNCiAgICAgICAgICAgICAgICBTY3JpcHQ6IGB0eXBlb2YoJHtuTmFtZShwKX0pPT09J3VuZGVmaW5lZCdgLA0KICAgICAgICAgICAgfSkpKS5jb25jYXQobS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSkubWFwKHAgPT4gKHsNCiAgICAgICAgICAgICAgICBDb2RlOiBgJHtuTmFtZShwKX1gLA0KICAgICAgICAgICAgICAgIEVycm9yOiBgJHtuTmFtZShwKX0gaXMgbm90IG9mIHR5cGUgJHtuTmFtZShwLkVudGl0eVR5cGUpfWAsDQogICAgICAgICAgICAgICAgU2NyaXB0OiBgKCEke25OYW1lKHApfSAmJiAke3AuUmVxdWlyZWQ/J3RydWUnOidmYWxzZSd9KSB8fCAoJHtuTmFtZShwKX0gJiYgKCR7bk5hbWUocCl9LmNvbnN0cnVjdG9yLm5hbWUhPScke25OYW1lKHAuRW50aXR5VHlwZSl9JyB8fCAke25OYW1lKHApfS5FbnRpdHlDbGFzcy5OYW1lIT0nJHtuTmFtZShwLkVudGl0eVR5cGUpfScpKWAsDQogICAgICAgICAgICB9KSkpLmNvbmNhdChtLlZhbGlkYXRvcnMgfHwgW10pLmZpbHRlcih2ID0+ICF2Lklnbm9yZSkuZm9yRWFjaCh2ID0+IHsgJT4NCiAgICAgICAgICAgICI8JT12LkNvZGUlPiI6ICgoPCU9bS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IHAuTmFtZSkuam9pbignLCAnKSU+KSA9PiB7DQogICAgICAgICAgICAgICAgdHJ5ew0KDQogICAgICAgICAgICAgICAgPCUgaWYodi5TY3JpcHQuaW5kZXhPZigncmV0dXJuICcpPDApeyU+DQogICAgICAgICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSANCiAgICAgICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgICAgICAgICA8JT12LlNjcmlwdCU+DQogICAgICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPiJhbnN3ZXIiLCAiPCU9di5Db2RlJT4iLCBhbnN3ZXIpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5zd2VyOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+InZhbGlkYXRvciIsICI8JT12LkNvZGUlPiIsIGV4KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KSg8JT1tLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gcC5OYW1lKS5qb2luKCcsICcpJT4pPygnPCU9di5FcnJvciU+JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpOicnLA0KICAgICAgICA8JSB9KSAlPg0KICAgICAgICB9Ow0KICAgICAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsNCiAgICAgICAgaWYoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpew0KICAgICAgICAgICAgT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+e1trXTogZXJyb3JzW2tdfSk7DQogICAgICAgICAgICAgICAgZGVsZXRlIGVycm9yc1trXTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICAgICAgX19leGNlcHRpb246IGVycm9ycywNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgPCU9bS5TY3JpcHQlPg0KICAgICAgICANCjwlIGlmKCFtLklzU3luYyl7JT4NCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShtLk1ldGhvZFJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIDwlPW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBuQ29kZShwKSArICI6ICIgKyBuQ29kZShwKSkuam9pbignLCAnKSU+fSk7DQogICAgICAgIA0KICAgICAgICANCiAgICAgICAgLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzDQogICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOw0KDQogICAgICAgIC8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8NCiAgICAgICAgbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7DQogICAgICAgIGlmKF9fZXgpIHJldHVybiBfX2V4LnJldDsNCg0KICAgICAgICA8JT1tLlJlZHVjZSU+DQoNCiAgICAgICAgPCUgaWYobS5Jc0FycmF5IHx8IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheSl7JT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKHIgPT4gci5yZXQpLmZsYXQoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoP3Jlc3VsdHNbMF0ucmV0Om51bGw7DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGg/cmVzdWx0c1swXS5yZXQ6bnVsbDsNCiAgICAgICAgPCUgfSU+DQo8JSB9JT4NCiAgICB9DQo8JSB9KTslPg0KDQo8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXNwb25zZUludGVyY2VwdG9yJyU+KGVycm9yLCB0KXsNCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KCkuPCU9bU5hbWUlPihlcnJvciwgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOw0KICAgICAgICAgICAgaWYgKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkgJiYgZXJyb3IucmVzcG9uc2UgJiYgZXJyb3IucmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgJiYgIW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgJiYgb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbi5pbmRleE9mKHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0fSkpPjApIHsNCiAgICAgICAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAvLyBhd2FpdCAoZ2V0IHRoZSB0b2tlbiBvciByZWZyZXNoIGl0KQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdHlwZSIsICJCZWFyZXIiLCB7dG9vbDogdH0pICsgIiAiICsgdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdC5heGlvcyhvcmlnaW5hbFJlcXVlc3QpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICA8JT1sb2coKSU+Y29uZmlnKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICA8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3JlcXVlc3RJbnRlcmNlcHRvciclPihjb25maWcsIHQpew0KICAgIDwlIGlmKG1haW5DbGFzcyhfcmVzdFRvb2xzKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoX3Jlc3RUb29scykpJT4oKS48JT1tTmFtZSU+KGNvbmZpZywgdCk7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgdCA9IHQgfHwgdGhpcy5Ub29sOw0KICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHtoZWFkZXJzOiB7fX07DQogICAgICAgICAgICBjb25maWcubWV0YSA9IGNvbmZpZy5tZXRhIHx8IHt9Ow0KICAgICAgICAgICAgY29uZmlnLm1ldGEuY291bnRlciA9IDQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgcmVmcmVzaFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnJlZnJlc2gudXJpIiwgbnVsbCwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICBsZXQgYXV0aFR5cGUgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRoX3R5cGUiLCAiQmVhcmVyIiwge3Rvb2w6IHR9KTsNCiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbi4iK2NvbmZpZy5tZXRob2QsIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHt0b29sOiB0LCBub2RlOiA8JT1uc2NvcGUlPi5fbm9kZX0pLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgIGlmKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKTwwKXsNCiAgICAgICAgICAgICAgICBpZighdG9rZW4pew0KICAgICAgICAgICAgICAgICAgICBsZXQgYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIGxldCBhdXRoTWV0aG9kID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLm1ldGhvZCcsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZighdG9rZW5VcmkgJiYgIWF1dGhDb2RlICYmICFhdXRoTWV0aG9kICYmIHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFR5cGUgPSAnQmFzaWMnOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9idG9hKHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJykgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCjwlaWYoX2NOYW1lKCdOb2RlJykpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKDwlPW5zY29wZSU+Ll9ub2RlICYmICFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0iZ2V0Iil7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgb3IgbG9hZCBhIG5ldyBvYXV0aCBzdGF0ZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnN0YXRlIiwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeSh7dG9vbDogdC5uYW1lLCBuY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpfSkpfSk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBhdXRob3JpemUgYW5kIGdldCB0aGUgYXV0aCBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7YXV0aFVyaX1gKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGF1dGhVcmkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChudWxsLCB0b29sID0+IDwlPW5zY29wZSU+Ll9ub2RlICYmIGNvbmZpZy5tZXRhLmNvdW50ZXItLSAmJiAhKGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7dG9vbDogdH0pKSwgMC4xLCB0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gRG9uZSBMb29waW5nOiAke2F1dGhDb2RlfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWF1dGhDb2RlKSBhdXRoTWV0aG9kPXVuZGVmaW5lZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KPCV9JT4NCg0KICAgICAgICAgICAgICAgICAgICBpZihhdXRoTWV0aG9kKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmbG93ID0gKCFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kPT0ncG9zdCcpPydhdXRob3JpemUnOid0b2tlbic7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIHRva2VuDQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdG9rZW5VcmkgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQ0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5VcmkgPSB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LnVyaWAsIG51bGwsIHt0b29sOiB0fSk7DQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgdGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHRva2VuVXJpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5tZXRob2RgLCAncG9zdCcsIHt0b29sOiB0fSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb250ZW50LVR5cGUiOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmNvbnRlbnRfdHlwZWAsICJ0ZXh0L2pzb24iLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQXV0aG9yaXphdGlvbiI6ICJCYXNpYyAiK3RoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7dG9vbDogdH0pICsgIjoiICsgdGhpcy5fX2NvbmZpZygib2F1dGgucGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmhlYWRlcnNgLCAie30iLCB7dG9vbDogdH0pKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7dG9vbDogdH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0cmVzID0gYXdhaXQgdC5heGlvcyh0Y29uZmlnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gVG9rZW4gZmV0Y2hlZCAtICR7Zmxvd31gLCB0Y29uZmlnLCB0cmVzLmRhdGEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgWydhY2Nlc3NfdG9rZW4nLCAndG9rZW5fdHlwZScsICdleHBpcmVzX2luJywgJ3JlZnJlc2hfdG9rZW4nXS5mb3JFYWNoKHRhID0+IHRoaXMuX19jb25maWcoYG9hdXRoLiR7dGF9YCwgbnVsbCwge3Rvb2w6IHQsIG5vZGU6IDwlPW5zY29wZSU+Ll9ub2RlLCBuZXdWYWx1ZTogdHJlcy5kYXRhW3RoaXMuX19jb25maWcoYG9hdXRoLnRva2VuLnJlc3BvbnNlLiR7dGF9YCwgdGEsIHt0b29sOiB0fSldfSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7dG9vbDogdCwgbm9kZTogPCU9bnNjb3BlJT4uX25vZGV9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYXV0aFR5cGUgKyAiICIgKyB0b2tlbjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICAgICAgPCU9bG9nKCklPmNvbmZpZyk7DQogICAgICAgIHJldHVybiBjb25maWc7DQogICAgPCUgfSU+DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19yZXN0JyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyl7DQogICAgICAgIC8qIHROYW1lIG5vIGxvbmdlciByZXF1aXJlZCEhICovDQogICAgICAgIHROYW1lID0gdE5hbWUgfHwgPCU9X25Db2RlKCklPjsNCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge190aGlzOiB0aGlzfTsNCiAgICAgICAgb3B0aW9ucy50TmFtZSA9IG9wdGlvbnMudE5hbWUgfHwgdE5hbWU7DQogICAgICAgIA0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307DQogICAgICAgIG1ldGhvZCA9IG1ldGhvZCB8fCAoZGF0YT8icG9zdCI6ImdldCIpOw0KICAgICAgICANCiAgICA8JSBpZihtYWluQ2xhc3MoX3Jlc3RUb29scykhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKF9yZXN0VG9vbHMpKSU+KC8qbnVsbCwgdGhpcy5Ub29sKi8pLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZihvcHRpb25zLmZvcm0pew0KICAgICAgICAgICAgICAgIGxldCBmZCA9IG5ldyBGb3JtRGF0YSgpOw0KICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goayA9PiBmZC5hcHBlbmQoaywgZGF0YVtrXSkpOw0KICAgICAgICAgICAgICAgIGRhdGEgPSBmZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgICAgICAgICAgICB1cmw6IHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgYHJlc3RhcGkudXJsLiR7bWV0aG9kfWAsIHRoaXMuX19jb25maWcob3B0aW9ucy51cmwgfHwgJ3Jlc3RhcGkudXJsJywgKG9wdGlvbnMucGF0aHx8JycpICsgb3B0aW9ucy5maWxlLCBvcHRpb25zKSwgb3B0aW9ucyksDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsDQogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsDQogICAgICAgICAgICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih0aGlzLl9fY29uZmlnKCdyZXN0YXBpLmhlYWRlcnMuJyttZXRob2QsIHRoaXMuX19jb25maWcoJ3Jlc3RhcGkuaGVhZGVycycsIHt9LCBvcHRpb25zKSwgb3B0aW9ucyksIG9wdGlvbnMuaGVhZGVycyB8fCB7fSksDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICB2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1czw0MDAsDQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICA8JT1sb2coKSU+YFtMSVZFOiR7dGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpfV1gLCBjb25maWcsIG9wdGlvbnMpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpew0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih0aGlzLlRvb2wuYXhpb3MpIT09J3VuZGVmaW5lZCcgfHwgdHlwZW9mKGF4aW9zKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gKGF3YWl0ICgodGhpcy5Ub29sLmF4aW9zIHx8IGF4aW9zKSkoY29uZmlnKSkuZGF0YTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgKGF3YWl0IGZldGNoKGNvbmZpZy51cmwsIGNvbmZpZykpLmpzb24oKTsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iYXhpb3Mgbm90IGRlZmluZWQhLCB1c2luZyBmZXRjaCIsIHJldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9IC8vIG1haW5DbGFzcyhfcmVzdFRvb2xzKSAlPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU1FMVGFibGUnJT4ob3B0aW9ucz17fSl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCBkZXBzOiB7fSwgc3FsOiBgYCwgZmllbGRzOiBgYH0sIHsNCiAgICAgICAgICAgIC8vX21hcDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgX19oZWFkZXI6IG9iaiA9PiBvYmouc3FsID0gYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0gKCR7b2JqLmZpZWxkc30vKjwlPW5OYW1lKGMpJT4qLyk7XG5gLA0KICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmogPSAodHlwZW9mKG9wdGlvbnMucmV1c2VkKT09PSd1bmRlZmluZWQnIHx8IG9wdGlvbnMucmV1c2VkPj12LnJldXNlZCk/di5vYmo6e3NxbDogdi5vYmouc3FsICs9IGAvKjwlPW5OYW1lKGMpJT46IHJldXNlZDogJHt2LnJldXNlZH0qL1xuXG5gLCBJZDogdi5vYmouSWR9LA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLmZpZWxkcyArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouZmllbGRzICs9IGAsJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT59JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiPCU9X0ZyRU1ELl9hdHRyKGVhKSU+IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIG9iai5kZXBzLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgICAgIG9iai5maWVsZHMgKz0gYCwke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIjwlPV9GckVNRC5fYXR0cihlYSklPiIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUodGEuRW50aXR5Q2xhc3MpJT4gPSAodiAmJiB2Lmxlbmd0aCk/dlswXTpuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQuZGVwcyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldC5kZXBzW2tdKT09PSdzdHJpbmcnKS5tYXAoayA9PiByZXQuZGVwc1trXSkuam9pbignXG5cbicpICsgcmV0LnNxbDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19mcm9tU1FMVGFibGUnJT4odGFibGUsIGZpZWxkcyl7DQogICAgICAgIC8vIHRhYmxlIGlzIGEganNvbiBhcnJheQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiPCU9bk5hbWUoZWEpJT4iKSkgfHwgIWZpZWxkcyl7DQogICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KHRhYmxlWyI8JT1uQ29kZShlYSklPiJdKTsNCiAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX3NxbCclPihzcWwsIF90aGlzKXsNCiAgICAgICAgX3RoaXMgPSBfdGhpcyB8fCB0aGlzOw0KICAgIDwlIGlmKG1haW5DbGFzcyhfc3FsVG9vbHMpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKF9zcWxUb29scykpJT4oKS48JT1tTmFtZSU+KHNxbCwgX3RoaXMpOw0KICAgIDwlIH1lbHNleyU+DQogICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSl7DQogICAgICAgICAgICBpZighdGhpcy5Ub29sLmRiKSA8JT1sb2coKSU+c3FsLCAiIDw9PVNLSVBQRUQ9PT4iKTsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYoc3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBzcWxTIG9mIHNxbC5zcGxpdCgnO1xuJykpew0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuPCU9bU5hbWUlPihzcWxTLnRyaW0oKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGxldCByZXQgPSBudWxsOw0KDQogICAgICAgIGlmKChzcWwubWF0Y2goL1woL2cpIHx8IFtdKS5sZW5ndGghPShzcWwubWF0Y2goL1wpL2cpIHx8IFtdKS5sZW5ndGgpew0KICAgICAgICAgICAgPCU9bG9nKCklPiJpbmNvcnJlY3Qgc3FsIiwgc3FsKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgICAgICAgICAgIGxldCBfb2sgPSAoX3JldCwgX3NxbCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoX3JldCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IGRiID0gdGhpcy5Ub29sLmRiOw0KICAgICAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOw0KICAgIA0KICAgICAgICAgICAgICAgIGxldCBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgICAgIHFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKT49MDsNCg0KICAgICAgICAgICAgICAgIGlmKGJRdWVyeSl7DQogICAgICAgICAgICAgICAgICAgIC8vIHF1ZXJ5DQogICAgICAgICAgICAgICAgICAgIGlmKFsnbXlzcWwnLCAncG9zdGdyZXMnXS5pbmRleE9mKHR5cGUpPj0wKSBmdW4gPSAncXVlcnknOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJykgZnVuID0gJ2FsbCc7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIERNTA0KICAgICAgICAgICAgICAgICAgICBpZihbJ215c3FsJywgJ3Bvc3RncmVzJ10uaW5kZXhPZih0eXBlKT49MCkgZnVuID0gJ3F1ZXJ5JzsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZT09J3NxbGl0ZScpIGZ1biA9ICdydW4nOw0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfb2soMCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZih0eXBlPT0nc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnKSBmdW4gPSAiIjsNCiAgICAgICAgICAgICAgICBpZihmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpIT09J3VuZGVmaW5lZCc/c3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpOnNxbDsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+YCR7dHlwZX0uJHtmdW59YCwgc3FsKTsNCiAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24pIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChmdW4pIHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IFtdOw0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT0icG9zdGdyZXMiKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsKS50aGVuKHJvd3MgPT4gX29rKHJvd3MsIHNxbCkpLmNhdGNoKHJldEV4ID0+IHJlamVjdChyZXRFeCkpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyb3Ipew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3Nub3dmbGFrZScpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRiLmV4ZWN1dGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgc3FsVGV4dDogc3FsLA0KICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb2socm93cywgc3FsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZT09J3NxbGl0ZScpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gc3FsaXRlIGluIHRoZSBicm93c2VyDQogICAgICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZGIuZXhlYyhzcWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9vayhyZXQsIHNxbCk7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgICAgICAgICBfb2socmV0LCBzcWwpOw0KICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlPT0ncXVlc3RkYicpew0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN0KG51bGwsIHtxdWVyeTogc3FsfSkudGhlbihyID0+IF9vayhyLCBzcWwpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmANCkVSUk9SOg0KJHtleH0NCg0KV2hpbGUgU2VuZGluZyBRdWVyeSANCiR7c3FsfQ0KYCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZihyZXQgJiYgcmV0LnJvd3MpIHJldCA9IHJldC5yb3dzOyAgICAgICAgDQogICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIDwlIH0lPg0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoWydBaXJUYWJsZSddKSl7JT4NCjwlDQpsZXQgX3RvVHlwZUFUID0gZWEgPT4gew0KICAgIGxldCByZXQgPSB7bmFtZTogbk5hbWUoZWEpLCBkZXNjcmlwdGlvbjogZWEuTmFtZSwgdHlwZTogInNpbmdsZUxpbmVUZXh0In07DQogICAgaWYoZWEuSXNCb29sKXsNCiAgICAgICAgcmV0LnR5cGUgPSAiY2hlY2tib3giOw0KICAgICAgICByZXQub3B0aW9ucyA9IHsNCiAgICAgICAgICAgIGNvbG9yOiAiZ3JlZW5CcmlnaHQiLA0KICAgICAgICAgICAgaWNvbjogImNoZWNrIg0KICAgICAgICB9Ow0KICAgIH0NCiAgICBpZihlYS5Jc0RhdGUpew0KICAgICAgICByZXQudHlwZSA9ICJkYXRlVGltZSI7DQogICAgICAgIHJldC5vcHRpb25zID0gew0KICAgICAgICAgICAgZGF0ZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICdpc28nDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdGltZUZvcm1hdDogew0KICAgICAgICAgICAgICAgIG5hbWU6ICcyNGhvdXInLA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRpbWVab25lOiAndXRjJywNCiAgICAgICAgfTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJldDsNCn07DQolPg0KICAgIDwlPW1OYW1lPSdfdG9BVFRhYmxlJyU+KGxldmVsKXsNCiAgICAgICAgbGV0IHJldCA9IFt7DQogICAgICAgICAgICBuYW1lOiAnPCU9bk5hbWUoYyklPicsDQogICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsDQogICAgICAgICAgICBmaWVsZHM6IFsNCiAgICAgICAgICAgICAgICB7bmFtZTogdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpLCBkZXNjcmlwdGlvbjogJ0lEJywgdHlwZTogJ3NpbmdsZUxpbmVUZXh0J30sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHslPjwlPV9GckVNRC5fdG9KUyhfdG9UeXBlQVQoZWEpKSU+LDwlIH0pJT5dLA0KICAgICAgICB9XTsNCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiByZXQucHVzaChuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC5wdXNoKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldC5zcWwpOw0KICAgICAgICByZXR1cm4gcmV0LnNxbDsNCg0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKCh0YWcsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuZmluZEluZGV4KHQgPT4gdC5uYW1lID09IHRhZy5uYW1lKSA9PSBpbmRleCk7DQogICAgICAgIDwlPWxvZygpJT5yZXQsIGxldmVsKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0FURnVuY3Rpb24nJT4oKXsNCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0uYDsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe2Z1bjogIiJ9LCB7DQogICAgICAgICAgICBfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKT9bJ0lkJ106dW5kZWZpbmVkLA0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KHQuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSkpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSIsDQogICAgICAgICAgICBJZDogb2JqID0+IG9iai5mdW4gKz0gYCBhbmQgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIGxldCBjb29wID0gdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcDsNCiAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiTk9UIElOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiSU4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSBgIGFuZCAke3RQcmVmfSR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di48JT1tTmFtZSU+KHYuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKSl9KWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gYCBhbmQgKCR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNUZXh0IHx8IGVhLklzSW1hZ2UgfHwgZWEuSXNGaWxlKXslPg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAgYW5kICR7dFByZWZ9JHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkxJS0UiKTwlfSU+ICsgIiAiOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LnRvSVNPU3RyaW5nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmZ1biArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1N0cmluZyl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09InN0cmluZyIpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5mdW4gKz0gIiciICsgKHY/IjEiOiIwIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICBpZih2ICYmIHYuRW50aXR5Q2xhc3Mpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIoIiArIHYuPCU9bU5hbWUlPigpICsgIikiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmouc3FsICs9ICIgYW5kIC8qPCU9dGFOYW1lJT4qLyAiOw0KICAgICAgICAgICAgICAgIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSchPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJOT1QgRVhJU1RTIjsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScpew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9ICJFWElTVFMiOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBvYmouZnVuICs9IGAke3RQcmVmfSR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke3RoaXMuXzwlPXRhTmFtZSU+X2Nvb3AgfHwgIklOIn1gOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouZnVuICs9ICIgKCIgKyAodiB8fCBbXSkubWFwKHQgPT4gKHQgJiYgdC48JT1tTmFtZSU+KT90LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIik6KHQgfHwgJ05VTEwnKSkuam9pbignIFVOSU9OIEFMTC8qTTJNKi8gJykgKyAiKSI7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nX2FpcnRhYmxlJyU+KHROYW1lLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQWlyVGFibGUnXSkhPWMpeyU+DQogICAgICAgIHJldHVybiBhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShtYWluQ2xhc3MoWydBaXJUYWJsZSddKSklPigpLjwlPW1OYW1lJT4odE5hbWUsIHBhcmFtcywgZGF0YSwgbWV0aG9kKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICB0TmFtZSA9IHROYW1lIHx8IDwlPV9uQ29kZSgpJT47DQogICAgICAgICAgICBsZXQgcmV0ID0gKGF3YWl0IGF4aW9zLnJlcXVlc3Qoew0KICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5fX2NvbmZpZygnZW5kcG9pbnRVcmwnKX0ke3ROYW1lfWAsDQogICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2Q/bWV0aG9kOihkYXRhPyJwb3N0IjoiZ2V0IiksDQogICAgICAgICAgICAgICAgcGFyYW1zOiB7DQogICAgICAgICAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogcGFyYW1zLA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGF0YTogZGF0YSwNCiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7DQogICAgICAgICAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXgucmVzcG9uc2UuZGF0YSwgbnVsbCwgNCkpOw0KICAgICAgICB9DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0ZpbGVTeXN0ZW0nXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19maWxlc3lzdGVtJyU+KGZpbGUsIGNvbnRlbnQsIGlkLCBvYmo9dGhpcyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRmlsZVN5c3RlbSddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShtYWluQ2xhc3MoWydGaWxlU3lzdGVtJ10pLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWxlLCBjb250ZW50LCBpZCwgb2JqKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighZmlsZSkgcmV0dXJuIG51bGw7DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIGxldCBwYXRoID0gb2JqLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJz8nLi9kYi8nOidodHRwczovL3t7b3duZXJ9fS5naXRodWIuaW8vJykpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZihvYmouX19jb25maWcoJ2xpdmUnLCB0cnVlKSl7DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAvLyB3cml0ZQ0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YoZ2xvYmFsKSE9PSd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKChwYXRoICsgZmlsZSkucmVwbGFjZSgvKC4qXC8pLiovZywgJyQxJyksIHsgcmVjdXJzaXZlOiB0cnVlIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmMocGF0aCArIGZpbGUsIHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnPy8qdGhpcy5fYnRvYSgqL0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpLyopKi86Y29udGVudCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZihmYWxzZSAmJiBmaWxlLmVuZHNXaXRoKCcvJykpew0KICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJzaW11bGF0ZWQgZGlyZWN0b3J5IGxpc3RpbmcuLi4uIiwgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIHJldCA9IFsiRU1TIFdlYiJdOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyByZWFkDQogICAgICAgICAgICAgICAgICAgIGlmKHBhdGguc3RhcnRzV2l0aCgnaHR0cCcpICYmIHBhdGguaW5kZXhPZignOi8vJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KHVuZGVmaW5lZCwgbnVsbCwgbnVsbCwgbnVsbCwge3VybDogJ3BhdGgucmVhZCcsIGZpbGUsIHBhdGh9KTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuZnMuZXhpc3RzU3luYyhwYXRoICsgZmlsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyhwYXRoICsgZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD8ocmV0LmRhdGEgfHwgcmV0KTpyZXQ7DQogICAgICAgICAgICA8JT1sb2coKSU+YFske29iai5fX2NvbmZpZygnbGl2ZScsIHRydWUpPycnOidOT1QgJ31MSVZFfCR7dHlwZW9mKGNvbnRlbnQpIT09J3VuZGVmaW5lZCc/J3dyaXRlJzoncmVhZCd9XSR7cGF0aCArIGZpbGV9OiAkeyhyZXQgfHwgJycpLmxlbmd0aH1gKTsNCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9WaWV3JyU+KGNvbHVtbnMsIHNQYXRoPSIiKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQoe3RvU3RyaW5nOiBmdW5jdGlvbigpe3JldHVybiBPYmplY3Qua2V5cyh0aGlzKS5maWx0ZXIoayA9PiB0eXBlb2YodGhpc1trXSkhPT0nZnVuY3Rpb24nKS5tYXAoayA9PiAodGhpc1trXSYmdGhpc1trXS50b1N0cmluZyk/dGhpc1trXS50b1N0cmluZygpOnRoaXNba10pLmpvaW4oJywgJyl9fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbZWFDb2RlXSA9IHY/djwlaWYoZWEuRW50aXR5VHlwZSl7JT4uPCU9bU5hbWUlPihudWxsLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk8JX0lPjp2LA0KCTwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQoNCjwlIGlmKG1haW5DbGFzcyhfZmlsZVRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvRmlsZU5hbWUnJT4oc1BhdGg9IiIsIGV4dD0nLmpzb24nKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IGZOYW1lID0gdGhpcy5fX2V4cG9ydChbXSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmoucHVzaCh2P3Y8JWlmKGVhLkVudGl0eVR5cGUpeyU+LjwlPW1OYW1lJT4oYCR7c1BhdGh9LiR7ZWFDb2RlfWAsIGV4dCk8JX0lPjonbnVsbCcpLA0KCTwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iikuam9pbignX18nKTsNCgkgICAgICAgIA0KCSAgICAgICAgaWYoIXNQYXRoKXsNCiAgICAgICAgICAgICAgICBmTmFtZSA9ICh0aGlzLl9fY29uZmlnKCdzdG9yZS5yb290JywgJzwlPXNjb3BlJT4vJykgKyBgJHsiPCU9YWxpYXMoKSU+Ii5zcGxpdCgnLicpLnNsaWNlKDEpLmpvaW4oJy8nKX0vJHs8JT1fbkNvZGUoKSU+fS8ke2ZOYW1lICsgZXh0fWApLnJlcGxhY2UoL1wvXC8vZywgJy8nKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZOYW1lID0gJ1snICsgZk5hbWUgKyAnXSc7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiBmTmFtZTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21GaWxlTmFtZSclPihmTmFtZSwgc1BhdGg9IiIsIGV4dD0nLmpzb24nKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQoe25hbWU6IGZOYW1lLnJlcGxhY2UoZXh0LCAnJyl9LCB7DQogICAgICAgICAgICAgICAgVW5pcXVlOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgICAgICBsZXQgdiA9IG9iai5uYW1lLnNwbGl0KCdfXycpWzBdOw0KICAgICAgICAgICAgICAgICAgICBvYmoubmFtZSA9IG9iai5uYW1lLnNwbGl0KCdfXycpLnNsaWNlKDEpLmpvaW4oJ19fJyk7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT5lYUNvZGUsIHYsIG9iai5uYW1lLCBzUGF0aCk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4odik7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgPCU9bG9nKCklPmVhQ29kZSwgb2JqLm5hbWUuc2xpY2UoMSwgLTEpLCBzUGF0aCk7DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5uYW1lPT0nbnVsbCcgfHwgIW9iai5uYW1lKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9iai5uYW1lLnNsaWNlKDEsIC0xKSwgYCR7c1BhdGh9LiR7ZWFDb2RlfWAsIGV4dCkpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmTmFtZSwgc1BhdGgpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSl7JT4NCiAgICBhc3luYyA8JT1tTmFtZT0nX2dpdGh1YiclPihmaWxlLCBjb250ZW50LCBpZCwgb2JqPXRoaXMpew0KICAgIDwlIGlmKG1haW5DbGFzcyhbJ0dpdEh1YiddKSE9Yyl7JT4NCiAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKG1haW5DbGFzcyhbJ0dpdEh1YiddKSklPihudWxsLCB0aGlzLlRvb2wpLjwlPW1OYW1lJT4oZmlsZSwgY29udGVudCwgaWQsIG9iaik7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIWZpbGUpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgc2hhMSA9IGFzeW5jIHN0ciA9PiB0eXBlb2YoY3J5cHRvLnN1YnRsZSkhPT0ndW5kZWZpbmVkJz9BcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCdTSEEtMScsIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgnYmxvYiAnICsgbmV3IEJsb2IoW3N0cl0pLnNpemUgKyAnXHgwMCcgKyBzdHIpKSkpLm1hcCh2ID0+IHYudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJykpLmpvaW4oJycpOnN0ci5zdWJzdHJpbmcoMCwgMTApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+ImZpbGUiLCBmaWxlLCBjb250ZW50PydwdXQnOidnZXQnKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX3Jlc3QodW5kZWZpbmVkLCBudWxsLCBjb250ZW50P0pTT04uc3RyaW5naWZ5KHsNCiAgICAJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgPCU9bU5hbWUlPigpIiwNCiAgICAJCQlzaGE6IGlkIHx8IGNvbnRlbnRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwNCiAgICAJCQljb250ZW50OiB0aGlzLl9idG9hKHR5cGVvZihjb250ZW50KT09PSdvYmplY3QnP0pTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpOmNvbnRlbnQpLA0KICAgIAkJfSk6bnVsbCwgY29udGVudD8ncHV0JzpudWxsLCB7DQogICAgCQkgICAgZmlsZTogKGZpbGUgKyAoKGNvbnRlbnQgfHwgZmlsZS5lbmRzV2l0aCgnLycpKT8nJzooJz9yYW5kPScrTWF0aC5yYW5kb20oKSkpKSwNCiAgICAJCX0pOw0KICAgIAkJDQogICAgCQlpZighcmV0KSByZXR1cm4gcmV0Ow0KICAgIAkJDQogICAgCQlyZXQgPSBjb250ZW50P3JldC5jb250ZW50OnJldDsNCg0KICAgICAgICAgICAgbGV0IGlkeEZpbGUgPSAnaW5kZXguaHRtJzsNCiAgICAgICAgICAgIC8vIDwlPWxvZygpJT4icmV0IiwgcmV0KTsNCiAgICAJCWlmKEFycmF5LmlzQXJyYXkocmV0KSl7DQogICAgCQkgICAgLy8gaW4gY2FzZSB3ZSBhcmUgbGlzdGluZyB0aGUgY29udGVudHMgb2YgYSBmb2xkZXIgcmVzb3VyY2UNCiAgICAJCSAgICByZXR1cm4gcmV0LmZpbHRlcihyID0+ICh0eXBlb2Yoci50eXBlKT09PSd1bmRlZmluZWQnIHx8IHIudHlwZT09J2ZpbGUnKSAmJiByLm5hbWUhPWlkeEZpbGUpLm1hcChyID0+ICh7W3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKV06IHIuc2hhIHx8IHJbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSwgbmFtZTogci5uYW1lLnJlcGxhY2UoJy5qc29uJywgJycpfSkpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgCQlsZXQgX3RoaXMgPSB7fTsNCiAgICAJCWlmKHJldC5zaGEpew0KICAgIAkJICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMgPSByZXQuY29udGVudD9KU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKTp7fTsNCiAgICAgICAgICAgICAgICB9Y2F0Y2goX2V4KXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4ibm90IGEgdmFsaWQgSlNPTiBvYmplY3QiLCBmaWxlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgCQkgIA0KICAgIAkJICAgIF90aGlzW29iai5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpXSA9IHJldC5zaGE7IC8vPz8NCiAgICAJCX1lbHNlIGlmKHJldFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldKXsNCiAgICAJCSAgICAvLzwlPXdhcm4oKSU+J3NoYTEnLCBmaWxlLCBhd2FpdCBzaGExKEpTT04uc3RyaW5naWZ5KHJldCkpKTsNCiAgICAJCSAgICBfdGhpcyA9IHJldDsNCiAgICAJCX0NCiAgICAJCQ0KICAgIAkJPCU9bG9nKCklPmZpbGUsIGNvbnRlbnQ/J3B1dCc6J2dldCcsIF90aGlzKTsNCiAgICAJCQ0KICAgICAgICAgICAgbGV0IGZSb290ID0gZmlsZS5zcGxpdCgnLycpLnNsaWNlKDAsIC0xKS5qb2luKCcvJyk7DQogICAgICAgICAgICBpZihmaWxlLmluZGV4T2YoaWR4RmlsZSk+PTApIHJldHVybiByZXQ7DQogICAgICAgICAgICBpZHhGaWxlID0gZlJvb3QgKyAnLycgKyBpZHhGaWxlOw0KICAgIAkJDQogICAgCQlpZigvKiFvYmouX19zeW5jX29uKCkgJiYgKi9jb250ZW50KXsNCiAgICAJCSAgICAvLyBuZXcgY29udGVudCBzdG9yZWQNCiAgICAJCSAgICBsZXQgaWR4UmV0ID0gYXdhaXQgb2JqLjwlPW1OYW1lJT4oaWR4RmlsZSk7DQogICAgCQkgICAgbGV0IGlkeExpc3QgPSBhd2FpdCBvYmouPCU9bU5hbWUlPihmUm9vdCk7DQogICAgCQkgICAgYXdhaXQgb2JqLjwlPW1OYW1lJT4oaWR4RmlsZSwgaWR4TGlzdCwgaWR4UmV0P2lkeFJldC5zaGE6bnVsbCk7DQogICAgCQkgICAgPCU9bG9nKCklPiJmaWxlIGNvbnRlbnQiLCBmaWxlLCBpZHhGaWxlLCByZXQsIGlkeExpc3QpOw0KICAgIAkJfQ0KICAgIAkJDQogICAgICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2FsZXNGb3JjZSddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvU0ZRdWVyeSclPihmaWVsZHMsIG9ianMsIGJTdHJpbmcpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7WzwlPV9uQ29kZSgpJT5dOiB7cGFyYW1zOiB7d2hlcmU6IHthbmQ6IFtdLCBvcjogW119fSwgZWRnZXM6IHtub2RlOiB7fX19fSwgew0KICAgICAgICAgICAgLy9PUEVSQVRPUlM6IHRydWUsDQogICAgICAgICAgICBJZDogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmpbPCU9X25Db2RlKCklPl0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHtJZDoge2VxOiB2fX0pLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IG9wID0gJ2VxJzsNCiAgICAgICAgICAgICAgICBsZXQgY29uZCA9IHtbZWFDb2RlXToge1tvcF06IA0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnE6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcGlOYW1lOiAnSWQnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFs8JT1fbkNvZGUoZWEuRW50aXR5VHlwZSklPl06IHY/di48JT1tTmFtZSU+KClbPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT5dLnBhcmFtcy53aGVyZS5hbmQ6W10sDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgKHY/di50b0lTT1N0cmluZygpOm51bGwpDQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgICAgIHYNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfX07DQogICAgICAgICAgICAgICAgb2JqWzwlPV9uQ29kZSgpJT5dLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICAvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOw0KICAgICAgICANCiAgICAgICAgaWYoYlN0cmluZyl7DQogICAgICAgICAgICByZXQgPSB7cXVlcnk6IHtbPCU9X25Db2RlKCklPiArICdRdWVyeSddOiB7dWlhcGk6IHtxdWVyeTogcmV0fX19fTsNCiAgICAgICAgICAgIHJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnU2VydmljZU5vdyddKSl7JT4NCiAgICA8JQ0KICAgIGxldCBfaWQgPSBzID0+IC8qcz9zOiovYHRoaXMuX3V1aWQoJHtzfHx1bmRlZmluZWR9KS5yZXBsYWNlKC8tL2csICcnKWA7DQogICAgbGV0IF90aWQgPSBfYyA9PiBfaWQoIiciK3Njb3BlKyIuIisgKF9jIHx8IGMpLk5hbWUgKyAiJyIpOw0KICAgIGxldCBhcHAgPSAoKSA9PiB7JT5hcHBsaWNhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0FwcGxpY2F0aW9uJywgdHJ1ZSklPigpLmNvZGUodGhpcy5fX2NvbmZpZygnc2NvcGUnLCAnPCU9c2NvcGUlPicpKSk8JX07DQogICAgDQogICAgbGV0IGxhYmVsID0gKHQsIG4sIGMsIHApID0+IHtuPXNyLkVuZ2xpc2hOYW1lKG4pOyAlPi48JT10JT5fRmllbGRfTGFiZWxzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0ZpZWxkIExhYmVsJywgdHJ1ZSklPig8JT1faWQoKSU+KS5yZW1hcmsoJzwlPW4lPicpLm5hbWUoJzwlPW4lPicpLmNvZGUoPCU9YyU+KS5sYW5ndWFnZSgnZW4nKS5wbHVyYWwoJzwlPShwIHx8IChuICsgJ3MnKSklPicpLjwlYXBwKCklPl0pPCV9OyU+DQoNCiAgICA8JT1tTmFtZT0nX3RvU05UYWJsZSclPigpew0KICAgICAgICAvL3RoaXMuX2RlZmF1bHRzKCk7DQoNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVGFibGUnLCB0cnVlKSU+KDwlPV90aWQoKSU+KS5jb2RlKDwlPV9uQ29kZSgpJT4pLjwlYXBwKCklPi5uYW1lKCc8JT1jLk5hbWUlPicpLnJlbWFyayhgPCU9Yy5SZW1hcmslPmApLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLCB7DQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai50YWJsZV9Db2x1bW5zKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQ29sdW1uJywgdHJ1ZSklPig8JT1faWQoIiciK3Njb3BlKyIuIitjLk5hbWUrIicrZWFDb2RlIiklPikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiIpLmNvZGUoZWFDb2RlKS50eXBlKCc8JT1fRnJFTUQuX2F0dHIoZWEpJT4nKS5yZWZlcmVuY2UoPCVpZihlYS5FbnRpdHlUeXBlKXslPih2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4oKTwlfWVsc2V7JT5udWxsPCV9JT4pLyo8JWxhYmVsKCdjb2x1bW4nLCBlYS5OYW1lLCAnZWFDb2RlJywgZWEuUGx1cmFsKSU+Ki8pLA0KICAgICAgICA8JSB9KSU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5yZWZlcmVuY2VfQ29sdW1ucyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0NvbHVtbicsIHRydWUpJT4oKS5hY3RpdmUoZmFsc2UpLmVuYWJsZWQodHJ1ZSkuY29kZShlYUNvZGUpLnR5cGUoJ0xpc3QnKS5uYW1lKCI8JT1uTmFtZSh0YSklPiA8JT10YS5FbnRpdHlDbGFzcy5QbHVyYWwlPiIpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpLyo8JWxhYmVsKCdjb2x1bW4nLCB0YS5OYW1lKycgJyt0YS5FbnRpdHlDbGFzcy5QbHVyYWwsICdlYUNvZGUnLCB0YS5FbnRpdHlDbGFzcy5QbHVyYWwpJT4qLyksDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiByZXQ7DQogICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9TTkZsb3cnJT4oYkRyYWZ0LCBiSGVhZGVyKXsNCiAgICAgICAgdHJ5ew0KICAgIDwlIGlmKF9jTmFtZSgnQXBwbGljYXRpb24nKSl7JT4NCiAgICAgICAgPCUgbGV0IGJPcmRlciA9IDE7IGxldCBfZmlkID0gX2MgPT4gX2lkKCInIitzY29wZSsiLicgKyAoYkRyYWZ0PydkJzoncycpICsgJ2wiKyAoX2MgfHwgYykuTmFtZSArICInIik7DQogICAgICAgIGxldCBsb2dpYyA9IChuLCB0LCBtYXA9W10pID0+IHslPg0KICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IExvZ2ljJywgdHJ1ZSklPig8JT1faWQoKSU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSgnPCU9biU+JykucmVtYXJrKCc8JT1uJT4nKQ0KICAgICAgICAgICAgICAgIC5ibG9jayhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgQmxvY2snLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoPCU9X2lkKCklPikubmFtZSgnPCU9biU+JykNCiAgICAgICAgICAgICAgICAgICAgLmJsb2NrX0VsZW1lbnRfTWFwcGluZ3MoWzwlIG1hcC5maWx0ZXIobSA9PiBtKS5mb3JFYWNoKG0gPT4geyU+DQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgiPCU9biU+IC0gIiArIDwlPW0uY2QlPikuY29kZSg8JT1tLmNkJT4pLnZhbHVlKDwlPW0udiU+KTwlcENvbXBvdW5kKG0udiwgbS50cm4pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlfSklPl0pDQogICAgICAgICAgICAgICAgKS5kZWZpbml0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnTG9naWMgRGVmaW5pdGlvbicsIHRydWUpJT4oJzwlPXQlPiA8JT1uJT4nKS5jb2RlKCc8JT10JT4nKS5uYW1lKCc8JT10JT4nKSkuPCVhcHAoKSU+DQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgYWN0aW9uID0gKGFDb2RlLCBwYXJhbXM9e30pID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIEluc3RhbmNlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKHRoaXMuX3V1aWQoKSkuYWN0aW9uKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQWN0aW9uIFR5cGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJzwlPWFDb2RlJT4nKSkub3JkZXIoPCU9Yk9yZGVyKyslPikuPCVhcHAoKSU+DQogICAgICAgICAgICAuYWN0aW9uX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5hY3Rpb25JbnB1dCgNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdBY3Rpb24gSW5wdXQnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykNCiAgICAgICAgICAgICAgICApLm1hcHBpbmcobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFbGVtZW50IE1hcHBpbmcnLCB0cnVlKSU+KCkuY29kZSgnPCU9cCU+JykudmFsdWUoIiIpKSwNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pDQogICAgICAgIDwlfQ0KICAgICAgICBsZXQgc3ViZmxvdyA9IChmbG93LCBwYXJhbXM9e30sIGJOb1dhaXQpID0+IHsgJT4NCiAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnN0YW5jZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSh0aGlzLl91dWlkKCkpLnN1YmZsb3coPCU9ZmxvdyU+KS5vcmRlcig8JT1iT3JkZXIrKyU+KS48JWFwcCgpJT4NCiAgICAgICAgICAgIDwlIGlmKCFiTm9XYWl0KXslPg0KICAgICAgICAgICAgLmluc3RhbmNlX0Zsb3dfSW5zdGFuY2VfSW5wdXRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5zdGFuY2UgSW5wdXQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS5uYW1lKCdXYWl0IGZvciBDb21wbGV0aW9uJykudHlwZSgnQm9vbCcpXSkNCiAgICAgICAgICAgIC5pbnN0YW5jZV9WYXJpYWJsZV9WYWx1ZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKS52YWx1ZSgnMScpDQogICAgICAgICAgICAgICAgICAgIC5tYXBwaW5nKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRWxlbWVudCBNYXBwaW5nJywgdHJ1ZSklPigpLmNvZGUoJ3dhaXRfZm9yX2NvbXBsZXRpb24nKSkNCiAgICAgICAgICAgIF0pDQogICAgICAgICAgICA8JX0lPg0KICAgICAgICAgICAgLmluc3RhbmNlX1ZhcmlhYmxlX1ZhbHVlcyhbDQogICAgICAgICAgICA8JSBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2gocCA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1ZhcmlhYmxlIFZhbHVlJywgdHJ1ZSklPigpLmNvZGUoJzwlPXAlPicpLnZhbHVlKDwlPXBhcmFtc1twXSU+KS5mbG93SW5wdXQoDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKQ0KICAgICAgICAgICAgICAgICkubWFwcGluZyhuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0VsZW1lbnQgTWFwcGluZycsIHRydWUpJT4oKS5jb2RlKCc8JT1wJT4nKS52YWx1ZSg8JT1wYXJhbXNbcF0lPikpDQogICAgICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICBdKQ0KICAgICAgICA8JX0NCiAgICAgICAgbGV0IHBDb21wb3VuZCA9ICh2LCB0cm4pID0+IHtpZighdHJuKSByZXR1cm47ICU+LmVsZW1lbnRNYXBwaW5nX1BpbGxfQ29tcG91bmRzKFtuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1BpbGwgQ29tcG91bmQnLCB0cnVlKSU+KHRoaXMuX3V1aWQoKSkuY29kZSgnJykubmFtZSg8JT12JT4pLm9yZGVyKDApLyoucmVtYXJrKHRoaXMuX2J0b2EoYDwlPUpTT04uc3RyaW5naWZ5KFtdKSU+YCkpKi8uPCVhcHAoKSU+DQogICAgICAgICAgICAucGFyZW50X1BpbGxfQ29tcG91bmRzKFsNCiAgICAgICAgICAgIDwlIE9iamVjdC5rZXlzKHRybikuZm9yRWFjaCgodCwgaSkgPT4geyU+IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnUGlsbCBDb21wb3VuZCcsIHRydWUpJT4odGhpcy5fdXVpZCgpKS5jb2RlKCI8JT10JT4iKS5vcmRlcig8JT1pKzElPikubmFtZSg8JT12JT4pLnJlbWFyayh0aGlzLl9idG9hKGA8JT1KU09OLnN0cmluZ2lmeSh0cm5bdF0pJT5gKSkuPCVhcHAoKSU+LyoudHJhbnNmb3JtKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnVHJhbnNmb3JtJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCc8JT10JT4nKS50cmFuc2Zvcm1fVHJhbnNmb3JtX0NvbXBvc2l0aW9ucyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdUcmFuc2Zvcm0gQ29tcG9zaXRpb24nLCB0cnVlKSU+KCkuY29kZSgnJyldKSkqLywNCiAgICAgICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pXSkNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICANCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAqIE9PQiBFbmRwb2ludDogaHR0cHM6Ly9kZXYxNjI1NzAuc2VydmljZS1ub3cuY29tL2FwaS9ub3cvcHJvY2Vzc2Zsb3cvZmxvd29iamVjdC9zdGFydC9zdWJmbG93DQogICAgICAgICAgICAgKiBQYXlsb2FkOiB7Im5hbWUiOiJ4Xzc4NjExX3NjaG9vbF9tYW4uVXNlcl9sb29rdXAiLCJpbnB1dHMiOnsianNvbiI6eyJuYW1lIjoidGVzdCIsImdlbmRlciI6eyJjb2RlIjoiTSIsICJPUEVSQVRPUlMiOiB7ImNvZGUiOiAiIT0ifX0sInVzZXJfU3R1ZGVudHMiOlt7Im5hbWUiOiJTVEEiLCJnZW5kZXIiOnsiY29kZSI6Ik0ifX1dfX19DQogICAgICAgICAgICAqLw0KDQogICAgICAgICAgICBsZXQgZmxvdyA9IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdycsIHRydWUpJT4oPCU9X2ZpZCgpJT4pLm5hbWUoJzwlPWMuTmFtZSU+IExvb2t1cCcpLmNvZGUoPCU9X25Db2RlKCklPiArICdfbG9va3VwJykuPCVhcHAoKSU+LmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpOw0KICAgICAgICAgICAgaWYoYkhlYWRlcikgcmV0dXJuIGZsb3c7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KGZsb3cvKi5fZGVmYXVsdHMoKSovDQogICAgICAgICAgICAgICAgLmZsb3dfRmxvd19TZXR0aW5ncyhbbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFNldHRpbmcnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoJ0FDVElPTicpXSkNCiAgICAgICAgICAgICAgICAuZmxvd19GbG93X0lucHV0cyhbDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCcsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2pzb24nKS5uYW1lKCdKU09OJykudHlwZSgnSlNPTicpPCVsYWJlbCgnaW5wdXQnLCAnSlNPTicsICInanNvbiciKSU+DQogICAgICAgICAgICAgICAgXSkuZmxvd19GbG93X091dHB1dHMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgT3V0cHV0JywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSg8JT1fbkNvZGUoKSU+ICsgJ19saXN0JykubmFtZSgnPCU9bk5hbWUoYyklPiBMaXN0JykudHlwZSgnTGlzdCcpLnJlZmVyZW5jZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1RhYmxlJywgdHJ1ZSklPigiPCU9bk5hbWUoYyklPiIpLm5hbWUoJzwlPWMuTmFtZSU+JykuY29kZSg8JT1fbkNvZGUoKSU+KS48JWFwcCgpJT4pDQogICAgICAgICAgICAgICAgICAgIDwlbGFiZWwoJ291dHB1dCcsIGMuTmFtZSArICcgTGlzdCcsIF9uQ29kZSgpICsgIisgJ19saXN0JyIpJT4NCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfVmFyaWFibGVzKFsNCiAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IFZhcmlhYmxlJywgdHJ1ZSklPig8JT1faWQoKSU+KS5hY3RpdmUodHJ1ZSkuY29kZSgnanNvbicpLm5hbWUoJ0pTT04nKS50eXBlKCdKU09OJyk8JWxhYmVsKCd2YXJpYWJsZScsICdKU09OJywgJyJqc29uIicpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuYWN0aXZlKHRydWUpLmNvZGUoJ2VxdWVyeScpLm5hbWUoJ0VRdWVyeScpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCAnRVF1ZXJ5JywgJyJlcXVlcnkiJyklPiwNCiAgICAgICAgICAgICAgICBdKS5mbG93X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnU2V0ICcgKyBjLk5hbWUgKyAnIEpTT04nLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidqc29uJyIsIHY6ICIne3tzdWJmbG93Lmpzb259fScifV0pJT4sDQogICAgICAgICAgICAgICAgICAgIDwlIC8vICwgdHJuOiB7cmVwbGFjZV9zdHJpbmc6IHtyZWdleDogIi8vZyIsIHJlcGxhY2Vfc3RyaW5nOiAiIn19JT4NCiAgICAgICAgICAgICAgICBdKS5zZWN1cml0eUNvbnRyb2wobmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdTZWN1cml0eSBDb250cm9sJywgdHJ1ZSklPig8JT1faWQoKSU+KS5jb2RlKCdzeXNfaHViX2Zsb3cnKS5uYW1lKGBzeXNfc2NvcGUuc2NvcGU9JHt0aGlzLl9fY29uZmlnKCdzY29wZScsICc8JT1zY29wZSU+Jyl9YCkudHlwZShuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IFR5cGUnLCB0cnVlKSU+KCkuY29kZSgnY2xpZW50X2NhbGxhYmxlX2Zsb3dfb2JqZWN0JykpLm9wZXJhdGlvbihuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ1NlY3VyaXR5IE9wZXJhdGlvbicsIHRydWUpJT4oKS5jb2RlKCdleGVjdXRlJykpLjwlYXBwKCklPiksIHsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvL2V4cG9ydGVyOiB2ID0+IHYub2JqID0gdi5yZXVzZWQ/bmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93JywgdHJ1ZSklPih2Lm9iai5JZCk6di5vYmosIC8qaW5mb3JtYXRpb24gbG9zcyovDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgTnVsbDogIWJIZWFkZXIsDQogICAgICAgICAgICAgICAgRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmo8JWlmKDAgfHwgKFsnbmFtZScsICdyZW1hcmsnLCAnZGF0ZScsICdvcmRlcicsICdhY3RpdmUnLCAnZW5hYmxlZCddLmluZGV4T2YoZWEuTmFtZSk8MCkpeyU+LmZsb3dfRmxvd19WYXJpYWJsZXMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLmNvZGUoZWFDb2RlKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+JykudHlwZSg8JSBpZihlYS5FbnRpdHlUeXBlKXslPidKU09OJzwlIH1lbHNleyU+JzwlPV9GckVNRC5fYXR0cihlYSklPic8JX0lPik8JWxhYmVsKCd2YXJpYWJsZScsIGVhLk5hbWUsICJlYUNvZGUiKSU+LA0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgVmFyaWFibGUnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJzwlPW5OYW1lKGMpJT4uPCU9ZWEuTmFtZSU+LlNldCcpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5uYW1lKCc8JT1zci5FbmdsaXNoTmFtZShlYS5OYW1lKSU+IFNldCcpLnR5cGUoJ0Jvb2wnKTwlbGFiZWwoJ3ZhcmlhYmxlJywgZWEuTmFtZSArICcgU2V0JywgImVhQ29kZSArICdfc2V0JyIpJT4sDQogICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBWYXJpYWJsZScsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZShlYUNvZGUgKyAnX29wJykubmFtZSgnPCU9c3IuRW5nbGlzaE5hbWUoZWEuTmFtZSklPiBPcGVyYXRvcicpLnR5cGUoJ1N0cmluZycpPCVsYWJlbCgndmFyaWFibGUnLCBlYS5OYW1lICsgJyBPcGVyYXRvcicsICJlYUNvZGUgKyAnX29wJyIpJT4sDQogICAgICAgICAgICAgICAgICAgIF0pLmZsb3dfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdTZXQgJytlYS5OYW1lLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgWw0KICAgICAgICAgICAgICAgICAgICAgICAgZWEuRW50aXR5VHlwZT9udWxsOntjZDogImVhQ29kZSIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmpzb259fSciLCB0cm46IE9iamVjdC5hc3NpZ24oe30sIHt2YWx1ZV9tYXA6IHtrZXk6ICIke2VhQ29kZX0iLCBkZWZhdWx0OiAiIn19LCBlYS5fSXNEYXRlP3tzdHJpbmdfdG9fZGF0ZToge2RhdGVfZm9ybWF0OiAieXl5eS1NTS1kZFwnVFwnSEg6bW06c3NcJ1pcJyIsIGN1c3RvbV9mb3JtYXQ6ICIifX06e30pfSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfc2V0JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKyd9fX0nIiwgdHJuOiB7aXNfbnVsbDoge319fSwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8ve2NkOiAiZWFDb2RlKydfb3AnIiwgdjogIid7e2Zsb3dfdmFyaWFibGUub3BlcmF0b3JzfX0nIiwgdHJuOiB7dmFsdWVfbWFwOiB7a2V5OiAiJHtlYUNvZGV9In19fSwNCiAgICAgICAgICAgICAgICAgICAgXSklPi5sb2dpY19GbG93X0lucHV0X1NjcmlwdHMoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4nKS5hY3RpdmUodHJ1ZSkuY29kZShlYUNvZGUpLnJlbWFyayhgcmV0dXJuIGZkX2RhdGEuZmxvd192YXIuanNvbi4ke2VhQ29kZX07YCksPCV9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBJbnB1dCBTY3JpcHQnLCB0cnVlKSU+KDwlPV9pZCgpJT4pLm5hbWUoJ1NldCA8JT1lYS5OYW1lJT4gU2V0JykuYWN0aXZlKHRydWUpLmNvZGUoZWFDb2RlICsgJ19zZXQnKS5yZW1hcmsoYHJldHVybiB0eXBlb2YoZmRfZGF0YS5mbG93X3Zhci5qc29uLiR7ZWFDb2RlfSkhXHUwMDNkXHUwMDNkXHUwMDI3dW5kZWZpbmVkXHUwMDI3O2ApLA0KICAgICAgICAgICAgICAgICAgICAgICAgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdGbG93IElucHV0IFNjcmlwdCcsIHRydWUpJT4oPCU9X2lkKCklPikubmFtZSgnU2V0IDwlPWVhLk5hbWUlPiBPcGVyYXRvcicpLmFjdGl2ZSh0cnVlKS5jb2RlKGVhQ29kZSArICdfb3AnKS5yZW1hcmsoYHJldHVybiAoZmRfZGF0YS5mbG93X3Zhci5qc29uLk9QRVJBVE9SUyB8fCB7fSkuJHtlYUNvZGV9O2ApLA0KICAgICAgICAgICAgICAgICAgICBdKSwNCg0KICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdJZiAnICsgYy5OYW1lICsgJyAnK2VhLk5hbWUrJyBTZXQnLCAnSWYnLCBbe2NkOiAiJ2NvbmRpdGlvbiciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS4nICsgZWFDb2RlICsgJ19zZXR9fT10cnVlJyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICA8JWlmKGVhLkVudGl0eVR5cGUpeyU+LnBhcmVudF9GbG93X0luc3RhbmNlcyg8JXN1YmZsb3coJ25ldyAnK3Njb3BlKycuJytfY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSkrJygpLicrbU5hbWUrJyhmYWxzZSwgdHJ1ZSknLCB7anNvbjogIid7e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ319JyJ9KSU+KTwlfSU+DQogICAgICAgICAgICAgICAgICAgIC5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQWRkICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fV4nK2VhQ29kZSJ9XSklPiwNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0lmICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIE9wZXJhdG9yIGlzIG5vdCBlbXB0eScsICdJZicsIFt7Y2Q6ICInY29uZGl0aW9uJyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLicrZWFDb2RlKydfb3B9fSE9JyJ9XSklPi5wYXJlbnRfRmxvd19Mb2dpY3MoWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwlbG9naWMoJ0FwcGVuZCAnK2VhLk5hbWUrJyBPcGVyYXRvciB0byAnICsgYy5OYW1lICsgJyBFUXVlcnknLCAnU2V0IEZsb3cgVmFyaWFibGVzJywgW3tjZDogIidlcXVlcnknIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX17e2Zsb3dfdmFyaWFibGUuJytlYUNvZGUrJ19vcH19JyJ9XSklPg0KICAgICAgICAgICAgICAgICAgICAgICAgXSksDQogICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdFbHNlICcgKyBjLk5hbWUgKyAnICcrZWEuTmFtZSsnIG5vdCBTZXQnLCAnRWxzZScpJT4ucGFyZW50X0Zsb3dfTG9naWNzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JWxvZ2ljKCdBcHBlbmQgPSB0byAnICsgYy5OYW1lICsgJyBFUXVlcnkgZm9yICcrZWEuTmFtZSwgJ1NldCBGbG93IFZhcmlhYmxlcycsIFt7Y2Q6ICInZXF1ZXJ5JyIsIHY6ICIne3tmbG93X3ZhcmlhYmxlLmVxdWVyeX19PScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPjwlbG9naWMoJ0ZvciBlYWNoICcrYy5OYW1lKycgJytlYS5OYW1lLCAnRm9yIEVhY2gnLCBbe2NkOiAiJ2l0ZW1zJyIsIHY6ICIne3swMTk1YjY1MzJlMmY3NjZmOWI4OWEyMzQxYWJiNDY1NS4iK2VhLkVudGl0eVR5cGUuTmFtZSsiX2xpc3R9fScifV0pJT4ucGFyZW50X0Zsb3dfTG9naWNzKFs8JX0lPg0KICAgICAgICAgICAgICAgICAgICAgICAgPCVsb2dpYygnQXBwZW5kICcrZWEuTmFtZSsnIHRvICcgKyBjLk5hbWUgKyAnIEVRdWVyeScsICdTZXQgRmxvdyBWYXJpYWJsZXMnLCBbe2NkOiAiJ2VxdWVyeSciLCB2OiAiJ3t7Zmxvd192YXJpYWJsZS5lcXVlcnl9fXt7Zmxvd192YXJpYWJsZS4nK2VhQ29kZSsnfX0nIn1dKSU+LA0KICAgICAgICAgICAgICAgICAgICAgICAgPCVpZihlYS5FbnRpdHlUeXBlKXslPl0pPCV9JT4sDQogICAgICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgIF0pPCV9JT4NCiAgICAgICAgICAgICAgICAsDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqPCVpZigwIHx8IFsnVXNlcicsICdHZW5kZXInLCAnX1N0dWRlbnQnLCAnX1RlYWNoZXInXS5pbmRleE9mKHRhLkVudGl0eUNsYXNzLk5hbWUpPj0wKXslPi5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiAnK3RhTmFtZSsnIG5vdCBlbXB0eScsICdJZicpJT4ucGFyZW50X0Zsb3dfSW5zdGFuY2VzKDwlc3ViZmxvdygnbmV3ICcrc2NvcGUrJy4nK19jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSkrJygpLicrbU5hbWUrJyhiRHJhZnQsIHRydWUpJywge2pzb246ICIndGVzdCcifSklPildKTwlfSU+LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX2xvb2t1cDogb2JqID0+IG9iai5mbG93X0Zsb3dfTG9naWNzKFs8JWxvZ2ljKCdJZiBFUXVlcnkgbm90IGVtcHR5JywgJ0lmJywgW3tjZDogIidjb25kaXRpb24nIiwgdjogIid7e2Zsb3dfdmFyaWFibGUuZXF1ZXJ5fX0hPScifV0pJT4NCiAgICAgICAgICAgICAgICAgICAgLnBhcmVudF9BY3Rpb25fSW5zdGFuY2VzKFsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlYWN0aW9uKCdsb29rX3VwX3JlY29yZHMnLCB7dGFibGU6ICciMDE5NWI2NTMyZTMwNzQ1YjhlYTM4ZDdmNWI4ZmM4Y2VfIisoJytfbkNvZGUoKSsnKS50b0xvd2VyQ2FzZSgpJ30pJT4sDQogICAgICAgICAgICAgICAgICAgIF0pLmxvZ2ljX0Zsb3dfSW5wdXRfU2NyaXB0cyhbDQogICAgICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgSW5wdXQgU2NyaXB0JywgdHJ1ZSklPigpLm5hbWUoJ1NldCBDb25kaXRpb24nKS5hY3RpdmUodHJ1ZSkuY29kZSgnY29uZGl0aW9ucycpLnJlbWFyayhgcmV0dXJuIGZkX2RhdGEuZmxvd192YXIuZXF1ZXJ5O2ApLA0KICAgICAgICAgICAgICAgICAgICBdKQ0KICAgICAgICAgICAgICAgIF0pLA0KICAgICAgICAgICAgICAgIF9zbmFwc2hvdDogb2JqID0+IGJEcmFmdD9udWxsOm9iai5mbG93X0Zsb3dfU25hcHNob3RzKG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnRmxvdyBTbmFwc2hvdCcsIHRydWUpJT4oPCU9X2ZpZCgpJT4pLnNuYXBzaG90X0Zsb3dfUGxhbnMoWw0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoJ0Zsb3cgUGxhbicsIHRydWUpJT4oPCU9X2lkKCklPikuY29kZSgnPCU9Yy5OYW1lJT5fUGxhbicpLm5hbWUoJzwlPWMuTmFtZSU+IFBsYW4nKQ0KICAgICAgICAgICAgICAgICAgICBdKS5mcm9tRmxvdyh0aGlzLjwlPW1OYW1lJT4odHJ1ZSkpKSwNCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+IiwgYkRyYWZ0LCBiSGVhZGVyKTsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgIDwlIH0lPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdfdG9TTlNjcmlwdCclPihvcHRpb25zPXt9KXsNCiAgICAgICAgb3B0aW9ucy5fdGhpcyA9IG9wdGlvbnMuX3RoaXMgfHwgdGhpczsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICA8JSBpZihfY05hbWUoJ0FwcGxpY2F0aW9uJykpeyU+DQogICAgICAgICAgICBsZXQgZXhwID0gb3B0aW9ucy5yYXc/Il90b0pTT04iOiJfdG9Eb2N1bWVudCI7DQogICAgICAgICAgICBsZXQgcm9sbGJhY2sgPSAob3B0aW9ucy5hcHAgJiYgb3B0aW9ucy5yb2xsYmFjayk/YXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdSb2xsYmFjayBDb250ZXh0JywgdHJ1ZSklPigpLmNvZGUoJ2xhc3QnKVtleHBdKE9iamVjdC5hc3NpZ24oe2JKU09OOiB0cnVlfSwgb3B0aW9ucykpOiIiOw0KICAgICAgICAgICAgbGV0IGRiID0gb3B0aW9ucy5kYj9hd2FpdCBvcHRpb25zLl90aGlzLyouX3RvT2JqVHJlZSh0cnVlKSovLl90b1NOVGFibGUoKVtleHBdKE9iamVjdC5hc3NpZ24oe2JKU09OOiB0cnVlfSwgb3B0aW9ucykpOiIiOw0KICAgICAgICAgICAgbGV0IGZsb3cgPSBvcHRpb25zLmZsb3c/YXdhaXQgb3B0aW9ucy5fdGhpcy8qLl90b09ialRyZWUodHJ1ZSkqLy5fdG9TTkZsb3cob3B0aW9ucy5kcmFmdClbZXhwXShPYmplY3QuYXNzaWduKHtiSlNPTjogdHJ1ZX0sIG9wdGlvbnMpKToiIjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYob3B0aW9ucy5nemlwKXsNCiAgICAgICAgICAgICAgICBpZihmbG93KSBmbG93ID0gdGhpcy5VdGY4QXJyYXlUb1N0cihhd2FpdCB0aGlzLl9jb21wcmVzcyhmbG93KSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCB0ZXN0ID0gKG9wdGlvbnMudGVzdCAmJiBvcHRpb25zLmZsb3cgJiYgIW9wdGlvbnMuZHJhZnQpP2Bcbi8qZ3MuY2FjaGVGbHVzaCgpOyAqL2dzLmluZm8oc25fZmQuRmxvd0FQSS5nZXRSdW5uZXIoKS5zdWJmbG93KCcke3RoaXMuX19jb25maWcoJ3Njb3BlJywgJzwlPXNjb3BlJT4nKX0uVXNlcl9sb29rdXAnKS5pbkZvcmVncm91bmQoKS53aXRoSW5wdXRzKHtqc29uOiB7Y29kZToidGVzdCIsZGF0ZTonMjAyNC0wNS0wM1QxODo0NDowMy4xNzdaJyxnZW5kZXI6e2NvZGU6Ik0iLCBPUEVSQVRPUlM6IHtjb2RlOiAiIT0ifX0sdXNlcl9TdHVkZW50czpbe2NvZGU6IlNUQSIsZ2VuZGVyOntjb2RlOiJNIn19XSwgT1BFUkFUT1JTOiB7ZGF0ZTogJzwnfX19KS5ydW4oKS5nZXRPdXRwdXRzKClbIlVzZXJfbGlzdCJdKTtcbmA6Jyc7DQogICAgICAgICAgICBsZXQgYXBwID0gb3B0aW9ucy5hcHA/KG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSgnQXBwbGljYXRpb24nLCB0cnVlKSU+KCkvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05TYXZlKG9wdGlvbnMpICsgYFxuIHZhciBjb25maWcgPSB7QXBwbGljYXRpb246IHtyZWFkT25seTogdHJ1ZX0sIFRhYmxlOiB7aWRLZXk6ICduYW1lJywgTG9nU2V0OiAwfSwgQ29sdW1uOiB7TG9nU2V0OiAwfSwgRWxlbWVudF9NYXBwaW5nOiB7TG9nU2V0OiAwfSwgQWN0aW9uX0lucHV0OiB7cmVhZE9ubHk6IHRydWV9LCBBY3Rpb25fVHlwZToge3JlYWRPbmx5OiB0cnVlLCBpZEtleTogJ21hc3Rlcl9zbmFwc2hvdCd9LCBBY3Rpb25fSW5zdGFuY2U6IHtMb2dTZXQ6IDB9LCBTZWN1cml0eV9UeXBlOiB7cmVhZE9ubHk6IHRydWUsIGlkS2V5OiAnbmFtZSd9LCBTZWN1cml0eV9PcGVyYXRpb246IHtyZWFkT25seTogdHJ1ZSwgaWRLZXk6ICduYW1lJ30sIExvZ2ljX0RlZmluaXRpb246IHtyZWFkT25seTogdHJ1ZX0sIEZsb3c6IHtMb2dTZXQ6IDB9LCBUcmFuc2Zvcm06IHtyZWFkT25seTogdHJ1ZX0sIFRyYW5zZm9ybV9Db21wb3NpdGlvbjoge3JlYWRPbmx5OiB0cnVlfSwgUm9sbGJhY2tfQ29udGV4dDoge3JlYWRPbmx5OiB0cnVlfX07IFxuYCArIChvcHRpb25zLnJvbGxiYWNrPygidmFyIGNpZCA9IHNhdmVSb2xsYmFja19Db250ZXh0KCIrcm9sbGJhY2srYCk7IGlmKGNpZCl7dmFyIHJ3ID0gbmV3IEdsaWRlUm9sbGJhY2tXb3JrZXIoKTsgcncuc2V0Um9sbGJhY2tDb250ZXh0SUQoY2lkLnN5c19pZCk7IHJ3LnN0YXJ0KCk7fSBcbmApOiIiKSsgKG9wdGlvbnMuZGI/KCJzYXZlVGFibGUoIitkYisiKTsgXG4iKToiIikgKyAob3B0aW9ucy5mbG93Pygic2F2ZUZsb3coIitmbG93KyIpOyBcbiIpOiIiKSArIHRlc3QpOihyb2xsYmFjayArIGRiICsgZmxvdyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBzY3JpcHQgPSB0aGlzLl9iZWF1dGlmeShhcHAsICdqYXZhc2NyaXB0Jyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKCFvcHRpb25zLmRlcGxveSkgcmV0dXJuIHNjcmlwdDsNCiAgICA8JSB9JT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KPCUgfSU+DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1NOU2F2ZSclPihvcHRpb25zKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgPCUgdmFyIF9mUmVnRXhwID0gL19me1tefV0rfS9nbTsgJT4NCiAgICAgICAgICAgIGxldCBfZiA9ICh2LCBlYUNvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIGxldCByZXQgPSB2Ow0KICAgICAgICAgICAgICAgICAgICAvL2lmKHYuc3RhcnRzV2l0aCgiZigiKSAmJiB2LmVuZHNXaXRoKCIpIikpIHJldCA9ICcoJyt2LnNsaWNlKDIsLTEpKycpJzsNCiAgICAgICAgICAgICAgICAgICAgaWYodi5zdGFydHNXaXRoKCJzKCIpICYmIHYuZW5kc1dpdGgoIikiKSl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBgKGZ1bmN0aW9uIChvYmosICR7ZWFDb2RlfSl7YCt2LnNsaWNlKDIsLTEpK2B9KShvYmosICR7ZWFDb2RlfSlgOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZihyZXQgJiYgcmV0Lm1hdGNoICYmIHJldC5tYXRjaCg8JT1fZlJlZ0V4cCU+KSkgcmV0ID0gYChmdW5jdGlvbiAob2JqLCAke2VhQ29kZX0peyR7cmV0LmluZGV4T2YoInJldHVybiIpPDA/InJldHVybiAiOiIifSAnYCtyZXQucmVwbGFjZSg8JT1fZlJlZ0V4cCU+LCBtID0+IGAnICsgJHttLnNsaWNlKDMsIC0xKX0gKyAnYCkrYCc7fSkob2JqLCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICAgICAgaWYocmV0ICYmIHJldC5tYXRjaCAmJiByZXQubWF0Y2goLzAxOTViNjUzMmUzMDc0NWI4ZWEzOTM5YjYxMmJkNGIyXSs+Pi9nbSkpIHJldCA9ICciIic7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBgKGZ1bmN0aW9uKHYpeyB0cnl7IHJldHVybiAodiAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSg8JT1fZlJlZ0V4cCU+LCBmdW5jdGlvbihtKXtyZXR1cm4gZXZhbChtLnNsaWNlKDMsIC0xKSk7fSk6djsgIH1jYXRjaChleCl7Z3MuaW5mbygnX2Z7RXhjZXB0aW9ufTogJHtlYUNvZGV9OiAnICsgZXgpOyByZXR1cm4gdjt9IH0pKCR7cmV0fSB8fCAke2VhQ29kZX0pYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGVhQ29kZTsNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtJZDogIjwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4iLCB2YXJzOiBgYCwgY29kZTogYGAsIHF1ZXJ5OiBgYCwgc2V0OiBgYCwgZXNldDogYGAsIGRzZXQ6IGBgLCB0YXM6IGBgLCBkZXBzOiB7fX0sIHsNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2Lm9iaiA9ICh0eXBlb2Yob3B0aW9ucy5yZXVzZWQpPT09J3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZXVzZWQ+PXYucmV1c2VkKT92Lm9iajp7Y29kZTogdi5vYmouY29kZSArIGBcblxuLyoqIHJldXNlZDogdi5vYmouSWQqKi9cblxuYCwgZGVwczogJycsIElkOiB2Lm9iai5JZH0sDQoNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgICAgICBvYmouSWQgPSBgaWYob2JqLiR7aWRDb2RlfSAmJiBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpLmxlbmd0aD09MzIpe190b1N0cmluZys9J18nK29iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJyk7IGdyLmdldCgnc3lzX2lkJywgb2JqLiR7aWRDb2RlfS5yZXBsYWNlKC8tL2csICcnKSk7fVxuYDsNCiAgICAgICAgICAgICAgICAgICAgb2JqLmlkVG9TdHJpbmcgPSBgX3RvU3RyaW5nICs9IChvYmo/b2JqLiR7aWRDb2RlfTooJ2dyXycrZ3Iuc3lzX2lkKSkgKyAnOiAnOyBgOw0KICAgICAgICAgICAgICAgICAgICBvYmoubmV3VVVJRCA9IGBpZighb2JqLiR7aWRDb2RlfSB8fCBvYmouJHtpZENvZGV9LnJlcGxhY2UoLy0vZywgJycpLmxlbmd0aCE9MzIpe29iai4ke2lkQ29kZX0gPSBnci5zZXROZXdHdWlkKCk7fWVsc2V7Z3Iuc2V0TmV3R3VpZFZhbHVlKG9iai4ke2lkQ29kZX0ucmVwbGFjZSgvLS9nLCAnJykpO319XG5gOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSE9Yyl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLmRlcHMuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSklPiA9ICh2IHx8IG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgIDwlIH0lPg0KDQogICAgICAgICAgICAgICAgICAgIG9iai52YXJzICs9IGB2YXIgJHtlYUNvZGV9ID0gPCVpZihlYS5FbnRpdHlUeXBlKXslPigoKHJlZnMuPCU9bk5hbWUoZWEpJT4gPSAodHlwZW9mKG9iai4ke2VhQ29kZX0pIT09J3VuZGVmaW5lZCc/Lyp0aGlzLiovc2F2ZTwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4ob2JqLiR7ZWFDb2RlfSwgezwlPW5OYW1lKGMpJT46IG9iaiwgPCU9bk5hbWUoYy8qZWEqLyklPlJlZnM6IHJlZnMsIDwlPW5OYW1lKGMpLnRvTG93ZXJDYXNlKCklPjogZ3J9LCAiPCU9bk5hbWUoYyklPiIsIHJlZnMuPCU9bk5hbWUoZWEpJT4gfHwgLypFWFA6IHJlZnMuPCU9bk5hbWUoZWEuRW50aXR5VHlwZSkudG9Mb3dlckNhc2UoKSU+IHx8ICovKCR7X2YoPCV2YWx1ZU9mKGVhLkRlZmF1bHQpJT4sIGVhQ29kZSl9KSk6cmVmcy48JT1uTmFtZShlYSklPikpIHx8IHtzeXNfaWQ6ICcnfSlbLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGVhLkVudGl0eVR5cGUpJT4uaWRLZXkgfHwgInN5c19pZCJdKS50b1N0cmluZygpPCV9ZWxzZXslPm9iai4ke2VhQ29kZX08JX0lPjtgOw0KICAgICAgICA8JSBpZihlYS5Jc1VuaXF1ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnF1ZXJ5ICs9IGBfdG9TdHJpbmcrPSdfJyske2VhQ29kZX07IF90b1F1ZXJ5LiR7ZWFDb2RlfSA9ICR7X2YodiwgZWFDb2RlKX07IGA7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmouc2V0ICs9IGBpZih0eXBlb2YoX3RvU2V0LiR7ZWFDb2RlfSA9ICR7X2YodiwgZWFDb2RlKX0pIT09J3VuZGVmaW5lZCc8JWlmKGVhLkVudGl0eVR5cGUpeyU+JiYgX3RvU2V0LiR7ZWFDb2RlfTwlfSU+KSBnci5zZXRWYWx1ZSgnJHtlYUNvZGV9JywgX3RvU2V0LiR7ZWFDb2RlfSk7YDsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IG9iai5lc2V0ICs9IGBpZih0eXBlb2YoX3RvU2V0LiR7ZWZDb2RlfSA9ICR7X2YoSlNPTi5zdHJpbmdpZnkodiksICdvYmouJytlZkNvZGUpfSkhPT0ndW5kZWZpbmVkJykgZ3Iuc2V0VmFsdWUoJyR7ZWZDb2RlfScsIF90b1NldC4ke2VmQ29kZX0pO2AsDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnRhcyArPSBgcmVmcy48JT10YU5hbWUlPiA9ICgob2JqP29iai4ke2VhQ29kZX06W10pIHx8IFtdKS5tYXAoZnVuY3Rpb24obyl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnID0+IHNhdmU8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPigke2VhQ29kZX1bXSknKTsgcmV0dXJuIC8qdGhpcy4qL3NhdmU8JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPihvLCB7PCU9bk5hbWUoYyklPjogb2JqLCA8JT1uTmFtZShjKS50b0xvd2VyQ2FzZSgpJT46IGdyLCBtYW55UmVmczogcmVmc30sICI8JT1uTmFtZShjKSU+Iik7fSk7YA0KICAgICAgICAgICAgICAgICAgICBvYmouZGVwcy48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcyklPiA9ICh2ICYmIHYubGVuZ3RoKT92WzBdOm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4ob3B0aW9ucyk7DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighcmV0LmRzZXQpIHJldC5kc2V0ICs9IGBcbmlmKHR5cGVvZihvYmopPT09Im9iamVjdCIpIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGZ1bmN0aW9uKGspe3JldHVybiAhay5zdGFydHNXaXRoKCdfXycpICYmIFsnc3lzX2lkJywgJ0lkJywgJ09QRVJBVE9SUyddLmluZGV4T2Yoayk8MCAmJiB0eXBlb2YoX3RvU2V0W2tdKT09PSd1bmRlZmluZWQnICYmICFBcnJheS5pc0FycmF5KG9ialtrXSk7fSkuZm9yRWFjaChmdW5jdGlvbihrKXtfdG9TZXRba10gPSAke19mKCJvYmpba10iLCAibnVsbCIpfTsgaWYoX3RvU2V0W2tdICYmIF90b1NldFtrXS5fX2NsYXNzKXtfdG9TZXRba10gPSBfdG9TZXRba11bY29uZmlnW190b1NldFtrXS5fX2NsYXNzXS5pZEZpZWxkIHx8ICdJZCddOyB9IGdyLnNldFZhbHVlKGssIF90b1NldFtrXSApOyB9KVxuYDsNCg0KICAgICAgICAgICAgcmV0LmNvZGUgKz0gYCR7T2JqZWN0LnZhbHVlcyhyZXQuZGVwcykuam9pbignXG4nKX1mdW5jdGlvbiBzYXZlPCU9bk5hbWUoYyklPihvYmosIHJlZnMsIHNvdXJjZSwgZ3Ipe3JlZnMgPSByZWZzIHx8IHt9OyAvKnRoaXMuKi9jb25maWcuc2F2ZV8kezwlPV9uQ29kZSgpJT59ID0gc2F2ZTwlPW5OYW1lKGMpJT47IC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+ID0gLyp0aGlzLiovY29uZmlnLjwlPW5OYW1lKGMpJT4gfHwge307IC8qdGhpcy4qL2NvbmZpZy5faWRNYXAgPSAvKnRoaXMuKi9jb25maWcuX2lkTWFwIHx8IFtdOyB2YXIgX3RvU3RyaW5nID0gc291cmNlICsgJ1snICsgKHJlZnNbc291cmNlXS5zeXNfaWQpICsgJ109PiBzYXZlPCU9bk5hbWUoYyklPignOyBpZih0eXBlb2Yob2JqKT09PSdzdHJpbmcnICYmIG9iai5sZW5ndGg+PTMyKXt2YXIgcmV0ID0ge307IHJldFsvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5pZEtleSB8fCAic3lzX2lkIl09b2JqOyBncy5pbmZvKF90b1N0cmluZyArICcpOiBvYmogaXMgdXVpZCwgcmV0dXJuaW5nIHsnK29iaisnfScpOyByZXR1cm4gcmV0O30gaWYoIW9iaiAmJiAhZ3Ipe2dzLmluZm8oX3RvU3RyaW5nICsgJyk6IG9iaiBpcyBudWxsJyk7IHJldHVybiBudWxsO30gJHtyZXQuaWRUb1N0cmluZ30gdmFyIGJTYXZlID0gIS8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LnJlYWRPbmx5OyBpZighZ3IpeyBnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpO1xuJHtyZXQuSWR9XG4ke3JldC52YXJzfVxuaWYoIWdyLmlzVmFsaWRSZWNvcmQoKSl7Z3IgPSBuZXcgR2xpZGVSZWNvcmQoJyR7PCU9X25Db2RlKCklPn0nKTsgdmFyIF90b1F1ZXJ5PXt9OyAke3JldC5xdWVyeX0gXG5fdG9TdHJpbmcgKz0gJyk6ICc7IGlmKG9iai5fX2tleXMgJiYgKGJTYXZlIHx8IGNvbmZpZy48JT1uTmFtZShjKSU+LnJlYWRPbmx5KSl7aWYoX3RvUXVlcnkuX19lbmNvZGVkUXVlcnkpe2dyLmFkZEVuY29kZWRRdWVyeShfdG9RdWVyeS5fX2VuY29kZWRRdWVyeSk7fWVsc2V7b2JqLl9fa2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGspe2dyLmFkZFF1ZXJ5KGssIF90b1F1ZXJ5W2tdIHx8IG9ialtrXSk7fSk7fSBnci5zZXRMaW1pdCgxKTsgaWYoIWdyLmdldEVuY29kZWRRdWVyeSgpKSBnci5hZGRRdWVyeSgnc3lzX2lkJywgJy0xJyk7IGdzLmluZm8oX3RvU3RyaW5nICsgJ0VuY29kZWQgUXVlcnk6ICcgKyBnci5nZXRFbmNvZGVkUXVlcnkoKSk7IGdyLnF1ZXJ5KCk7aWYoIWdyLm5leHQoKSl7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnbm90IGZvdW5kJyk7fWVsc2V7Z3MuaW5mbyhfdG9TdHJpbmcgKyAnZm91bmQgWyR7PCU9X25Db2RlKCklPn0vJyArIGdyLnN5c19pZCArICddIC0gaXMgdmFsaWQ6ICcgKyBnci5pc1ZhbGlkUmVjb3JkKCkpOyBvYmouSWQgPSBnci5zeXNfaWQudG9TdHJpbmcoKTsgaWYob2JqLl9fcmV1c2VkKXsvKmdzLmluZm8oX3RvU3RyaW5nICsgJzogX19yZXVzZWQ6IFskezwlPV9uQ29kZSgpJT59LycgKyBnci5zeXNfaWQgKyAnXSAtIGlzIHZhbGlkOiAnICsgZ3IuaXNWYWxpZFJlY29yZCgpKTsgKi9yZXR1cm4gZ3I7fSB9fX19ZWxzZXtiU2F2ZT1mYWxzZTt9IGlmKGJTYXZlICYmICFnci5pc1ZhbGlkUmVjb3JkKCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ2luc2VydGluZy4uLicpOyBnciA9IG5ldyBHbGlkZVJlY29yZCgnJHs8JT1fbkNvZGUoKSU+fScpOyBnci5pbml0aWFsaXplKCk7ICR7cmV0Lm5ld1VVSUR9IGlmKGJTYXZlICYmIG9iail7dmFyIF90b1NldCA9IHt9OyAvKnNldCovJHtyZXQuc2V0fSAvKmVzZXQqLyR7cmV0LmVzZXR9ICAke3JldC5kc2V0fSBpZigvKnRoaXMuKi9jb25maWcuPCU9bk5hbWUoYyklPi5Ob1dvcmtmbG93KSBnci5zZXRXb3JrZmxvdyhmYWxzZSk7IGlmKC8qdGhpcy4qL2NvbmZpZy48JT1uTmFtZShjKSU+LkxvZ1NldCkgZ3MuaW5mbyhfdG9TdHJpbmcgKyAnX3RvU2V0OiAnICsgSlNPTi5zdHJpbmdpZnkoX3RvU2V0KSk7IH1lbHNlIGlmKCFnci5pc1ZhbGlkUmVjb3JkKCkpe2dzLmluZm8oX3RvU3RyaW5nICsgJ1tiU2F2ZT0nICsgYlNhdmUgKyAnXSAtIHJldHVybmluZyBudWxsLicpOyByZXR1cm4gbnVsbDt9XG5pZighYlNhdmUgfHwgZ3IudXBkYXRlKCkpeyBpZihmYWxzZSAmJiBiU2F2ZSl7Y29uZmlnLl9pZE1hcC5wdXNoKHt0YWJsZTogJyR7PCU9X25Db2RlKCklPn0nLCBzeXNfaWQ6IGdyLnN5c19pZC50b1N0cmluZygpLCBrZXlzOiBvYmouX19rZXlzLm1hcChmdW5jdGlvbihrKXtyZXR1cm4ge2s6IGssIHY6IF90b1F1ZXJ5W2tdIHx8IG9ialtrXX07fSl9KTt9ICR7cmV0LnRhc31cbmdzLmluZm8oX3RvU3RyaW5nICsgJ1tiU2F2ZT0nICsgYlNhdmUgKyAnXSAtIHJldHVybmluZyAnICsgZ3Iuc3lzX2lkKTsgcmV0dXJuIGdyO319XG5gOw0KDQogICAgICAgICAgICAvKnJldHVybiBPYmplY3QudmFsdWVzKE9iamVjdC5hc3NpZ24oe30sIC4uLnJldC5jb2RlLnNwbGl0KCdmdW5jdGlvbiBzYXZlJykuZmlsdGVyKHMgPT4gcykuc29ydCgoYSwgYikgPT4gYS5sZW5ndGggLSBiLmxlbmd0aCkubWFwKHMgPT4gKHtbcy5zcGxpdCgnKG9iaiwgcmVmcywgc291cmNlLCBnciknKVswXV06ICdmdW5jdGlvbiBzYXZlJytzfSkpKSkuam9pbignXG4nKTsgKi8NCiAgICAgICAgICAgIHJldHVybiByZXQuY29kZTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvU05RdWVyeSclPihmaWVsZHMsIG9ianMsIGJVUkwpew0KICAgICAgICBsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgT1BFUkFUT1JTOiB0cnVlLA0KICAgICAgICAgICAgLy9fbWFwOiB0cnVlLA0KICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSB2LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2P3YuPCU9bU5hbWUlPigpOm51bGw7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOw0KICAgICAgICAgICAgICAgIGxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7DQogICAgICAgICAgICAgICAgaWYoKHYuZ2V0SG91cnMoKT09MCAmJiB2LmdldE1pbnV0ZXMoKT09MCAmJiB2LmdldFNlY29uZHMoKT09MCkgfHwgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09Jz0nIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIT09J0JFVFdFRU4nKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Jvb2wpeyU+DQogICAgICAgICAgICAgICAgb2JqLk9QRVJBVE9SUy48JT1uTmFtZShlYSklPiA9ICc9JzsNCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHY7DQogICAgICAgIDwlIH1lbHNleyU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB2Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICBPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSE9PSd1bmRlZmluZWQnICYmIHR5cGVvZihyZXRba10pIT09J29iamVjdCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsNCg0KICAgICAgICBkZWxldGUgcmV0Lk9QRVJBVE9SUzsNCiAgICAgICAgT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7DQoNCiAgICAgICAgcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOw0KDQogICAgICAgIC8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycw0KICAgICAgICBPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQoNCiAgICAgICAgaWYoYlVSTCkgcmV0ID0gT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0lPg0KDQoJPCU9bU5hbWU9J19fZXhwb3J0JyU+KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgew0KCSAgICB0cnl7DQogICAgCSAgICBpZighb2JqKSByZXR1cm4gdGhpczsNCiAgICAJICAgIA0KICAgIAkgICAgaWYob3B0aW9ucy5PUEVSQVRPUlMpIG9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9Ow0KICAgIAkgICAgDQogICAgCSAgICA8JSAvKiBJTVBPUlRBTlQ6IHRoaXMuSWQ9PXRoaXMuSWQgbWFrZXMgc3VyZSB0aGUgSWQgaXMgZml4ZWQgZm9yIHRoZSB0b29sLCBub3QgZ2V0dGluZyBnZW5lcmF0ZWQgZXZlcnkgdGltZSB3ZSBjYWxsIGl0ICovICU+DQogICAgCSAgICANCiAgICAJICAgIGxldCBlYUNvZGVzID0gew0KICAgIAkgICAgICAgIGV4cG9ydGVyOiAiIiwNCiAgICAJICAgICAgICBJZDogIiIsDQogICAgCSAgICB9Ow0KICAgIAkgICAgDQogICAgCQlpZiAoIW9wdGlvbnMuVW5pcXVlICYmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkPT10aGlzLklkKSkgdGhpcy5fX29wdGlvbnMoIklkIiwgb2JqLCBlYUNvZGVzLklkID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnSWQnKTonSWQnKSwgdGhpcy5JZCwgdGhpcywgb3B0aW9ucywgZnVuKTsNCiAgICAJCQ0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHRoaXMuPCU9bk5hbWUoZWEpJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUgfHwgKG9wdGlvbnMuVW5pcXVlICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCjwlIGMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4geyU+DQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWYuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiZWZfPCU9bk5hbWUoZWYpJT4iLCBvYmosIGVhQ29kZXMuZWZfPCU9bk5hbWUoZWYpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlZiklPjo8JV92Q29kZShlZiklPiksIDwldmFsdWVPZihlZi5WYWx1ZSklPiwgdGhpcywgb3B0aW9ucywgZnVuKTsNCjwlIH0pJT4NCg0KCQkgICAgPCUgdW5SZWN1cnNlKCdvYmonLCAnZnVuJywgJ2ZBcmdzJywgJ2lmKHR5cGVvZihvcHRpb25zLmV4cG9ydGVyKT09PSJmdW5jdGlvbiIpIG9wdGlvbnMuZXhwb3J0ZXIodiknKSU+DQoNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlICYmICFlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT1uTmFtZShlYSklPiIsIG9iaiwgZWFDb2Rlcy48JT1uTmFtZShlYSklPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKGVhKSU+OjwlX3ZDb2RlKGVhKSU+KSwgdGhpcy48JT1uTmFtZShlYSklPigpLCB0aGlzLCBvcHRpb25zLCBmdW4sICI8JT1fY0ZpZWxkKGVhKSU+Iik7DQo8JSB9KSU+DQoNCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCJfVEhJUyIsIG9iaiwgZWFDb2Rlcy5fVEhJUyA9IChvcHRpb25zLl9tYXA/dGhpcy5fbkNvZGUoJ19USElTJyk6Il9USElTIiksIHRoaXMuX1RISVMsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIjwlPXRhTmFtZSU+Iiwgb2JqLCBlYUNvZGVzLjwlPXRhTmFtZSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUodGEsIHRydWUpJT46IjwlPXRhTmFtZSU+IiksIHRoaXMuPCU9dGFOYW1lJT4oKSwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZCh0YSklPiIpOw0KPCUgfSklPg0KDQogICAgICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSBPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSk9PT0nZnVuY3Rpb24nICYmICFPYmplY3Qua2V5cyhlYUNvZGVzKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IHRoaXMuX19vcHRpb25zKGssIG9iaiwgaywgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pKTsNCiAgICAgICAgDQogICAgICAgICAgICA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXSB8fCB7fTsNCiAgICAgICAgICAgICg8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dLkN5Y2xpYyB8fCBbXSkuZm9yRWFjaChuID0+IG4uX2Nbbi5lYUZpZWxkXShuLl9jW24uZWFGaWVsZF0oKS5fdG9IYXNoKG51bGwsIHtub0NvZGU6IHRydWUsIG9ubHlVbmlxdWU6IHRydWUsIG5vQXJnczogdHJ1ZSwgX21hcDogb3B0aW9ucy5fbWFwfSwgZnVuKSkpOw0KICAgICAgICAgICAgPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgPSBbXTsgLy8/Pw0KICAgICAgICAgICAgDQogICAgCQlyZXR1cm4gb2JqOw0KICAgIAl9Y2F0Y2goZXgpew0KICAgIAkgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgIAl9DQoJfQ0KCQ0KCTwlPW1OYW1lPSdfX29wdGlvbnMnJT4oZmllbGQsIG9iaiwgZWFDb2RlLCBlYU9iaiwgX3RoaXM9dGhpcywgb3B0aW9ucz17fSwgZnVuLCBlYUZpZWxkKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihmaWVsZCwgb2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcywgb3B0aW9ucywgZnVuLCBlYUZpZWxkKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOw0KICAgICAgICAgICAgaWYoIW9iaikgcmV0dXJuOw0KICAgICAgICAgICAgaWYodHlwZW9mKG9wdGlvbnNbZmllbGRdKSE9PSJmdW5jdGlvbiIpew0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT5gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihlYU9iaikhPT0ndW5kZWZpbmVkJyAmJiAhb3B0aW9ucy5OdWxsKXsNCiAgICAgICAgICAgICAgICBpZihmaWVsZCE9J0lkJyAmJiB0eXBlb2YoX3RoaXNbZmllbGRdKT09PSdmdW5jdGlvbicgJiYgIV90aGlzWydfJytmaWVsZCsnX3NldCddKSByZXR1cm47DQogICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkhPT0ndW5kZWZpbmVkJykgZWFPYmogPSBlYU9iai5maWx0ZXIodiA9PiB2KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuTnVsbCAmJiBBcnJheS5pc0FycmF5KGVhT2JqKSAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47DQoNCiAgICAgICAgICAgIGxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYUNvZGUsIGVhT2JqLCBfdGhpcyk7DQogICAgICAgICAgICBpZihvcHRpb25zLk9QRVJBVE9SUyAmJiBfdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7W2ZpZWxkXTogX3RoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXX0pOw0KDQogICAgICAgICAgICBpZighb3B0aW9ucy5DeWNsaWMgJiYgZWFGaWVsZCAmJiBvYmogJiYgb2JqLkVudGl0eUNsYXNzICYmIHR5cGVvZihvYmpbZmllbGRdKT09PSdmdW5jdGlvbicpew0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0gPSA8JT1zY29wZSU+Ll91blJlY3Vyc2UuPCU9bk5hbWUoYyklPltmdW5dIHx8IHt9Ow0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljID0gPCU9c2NvcGUlPi5fdW5SZWN1cnNlLjwlPW5OYW1lKGMpJT5bZnVuXS5DeWNsaWMgfHwgW107DQogICAgICAgICAgICAgICAgbGV0IF9jeWNsZXMgPSBvYmpbZmllbGRdKCk7DQogICAgICAgICAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkoX2N5Y2xlcykpIF9jeWNsZXMgPSBbX2N5Y2xlc107DQogICAgICAgICAgICAgICAgX2N5Y2xlcyA9IF9jeWNsZXMuZmlsdGVyKF9jID0+IF9jICYmIHR5cGVvZihfY1tlYUZpZWxkXSk9PT0nZnVuY3Rpb24nICYmIF9jWydfJyArIGVhRmllbGQgKyAnX3NldCddICYmIG9iai5fc2FtZUVudGl0eShfY1tlYUZpZWxkXSgpKSkubWFwKF9jID0+ICh7DQogICAgICAgICAgICAgICAgICAgIC8qbWFyayBfY1tlYUZpZWxkXV9zZXQgdG8gbnVsbCBpbnN0ZWFkKi8NCiAgICAgICAgICAgICAgICAgICAgX2MsDQogICAgICAgICAgICAgICAgICAgIGVhRmllbGQsDQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGlmKF9jeWNsZXMubGVuZ3RoKSA8JT13YXJuKCklPmZ1biArICIvX2N5Y2xlcyIsIF9jeWNsZXMpOw0KICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX3VuUmVjdXJzZS48JT1uTmFtZShjKSU+W2Z1bl0uQ3ljbGljLnB1c2goLi4uX2N5Y2xlcyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuX21hcCkgX3RoaXMuX21hcChmaWVsZCwgdHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnLCBmdW4sIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJz9vYmo6ZWFPYmosIHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJz9fdGhpczpvYmosIGVhQ29kZSk7DQoNCiAgICAgICAgICAgIHJldHVybiBfcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZnVuLCBmaWVsZCwgZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCgl9DQoJDQoJPCU9bU5hbWU9J19faW1wb3J0JyU+KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgew0KICAgICAgICBpZih0eXBlb2Yob2JqKSE9PSdvYmplY3QnKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+YCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCgkgICAgDQogICAgICAgIGxldCBlYUNvZGVzID0ge307DQoNCgkJaWYgKCFvcHRpb25zLlVuaXF1ZSkgdGhpcy5fX29wdGlvbnMoIklkIiwgb2JqLCBlYUNvZGVzLklkID0gKG9wdGlvbnMuX21hcD90aGlzLl9uQ29kZSgnSWQnKTonSWQnKSwgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pOw0KCQkNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoIW9wdGlvbnMuVW5pcXVlIHx8IChvcHRpb25zLlVuaXF1ZSAmJiA8JXZhbHVlT2YoZWEuSXNVbmlxdWUpJT4pKSB0aGlzLl9fb3B0aW9ucygiPCU9bk5hbWUoZWEpJT4iLCBvYmosIGVhQ29kZXMuPCU9bk5hbWUoZWEpJT4gPSAob3B0aW9ucy5fbWFwPzwlPV9uQ29kZShlYSklPjo8JV92Q29kZShlYSklPiksIHVuZGVmaW5lZCwgdGhpcywgb3B0aW9ucywgZnVuLCAiPCU9X2NGaWVsZChlYSklPiIpOw0KPCUgfSklPg0KDQoJCTwlIHVuUmVjdXJzZSgndGhpcycsICdmdW4nLCAnZkFyZ3MnLCAnaWYodHlwZW9mKG9wdGlvbnMuaW1wb3J0ZXIpPT09ImZ1bmN0aW9uIikgb3B0aW9ucy5pbXBvcnRlcih2KScpJT4NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgIWVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSAgdGhpcy5fX29wdGlvbnMoIjwlPW5OYW1lKGVhKSU+Iiwgb2JqLCBlYUNvZGVzLjwlPW5OYW1lKGVhKSU+ID0gKG9wdGlvbnMuX21hcD88JT1fbkNvZGUoZWEpJT46PCVfdkNvZGUoZWEpJT4pLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQoZWEpJT4iKTsNCjwlIH0pJT4NCg0KCQlpZiAoIW9wdGlvbnMuVW5pcXVlKSB0aGlzLl9fb3B0aW9ucygiX1RISVMiLCBvYmosIGVhQ29kZXMuX1RISVMgPSAob3B0aW9ucy5fbWFwP3RoaXMuX25Db2RlKCdfVEhJUycpOidfVEhJUycpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1bik7DQoNCjwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHsNCiAgICBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTsNCiU+DQogICAgICAgIGlmICghb3B0aW9ucy5VbmlxdWUpIHRoaXMuX19vcHRpb25zKCI8JT10YU5hbWUlPiIsIG9iaiwgZWFDb2Rlcy48JT10YU5hbWUlPiA9IChvcHRpb25zLl9tYXA/PCU9X25Db2RlKHRhLCB0cnVlKSU+OiI8JT10YU5hbWUlPiIpLCB1bmRlZmluZWQsIHRoaXMsIG9wdGlvbnMsIGZ1biwgIjwlPV9jRmllbGQodGEpJT4iKTsNCjwlIH0pJT4NCg0KICAgICAgICBpZiAoIW9wdGlvbnMuVW5pcXVlKSBPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSk9PT0nZnVuY3Rpb24nICYmICFPYmplY3Qua2V5cyhlYUNvZGVzKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IHRoaXMuX19vcHRpb25zKGssIG9iaiwgaywgdW5kZWZpbmVkLCB0aGlzLCBvcHRpb25zLCBmdW4pKTsNCg0KCQlyZXR1cm4gdGhpczsNCgl9DQoNCjwlIGlmKG1haW5DbGFzcyhbJ05lbzRqJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfdG9DeVRhYmxlJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHtjcWw6IGANCkNSRUFURSBDT05TVFJBSU5UIElGIE5PVCBFWElTVFMgRk9SIChvOiR7PCU9X25Db2RlKCklPn0pIFJFUVVJUkUgby4ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0gSVMgVU5JUVVFOw0KQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSBJUyBOT1QgTlVMTDsNCiAgICAgICAgYH0sIHsNCiAgICAgICAgICAgIEZ1bGw6IHRydWUsDQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgIG9iai5jcWwgKz0gdj92LjwlPW1OYW1lJT4oKTonJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgb2JqLmNxbCArPSBgQ1JFQVRFIENPTlNUUkFJTlQgSUYgTk9UIEVYSVNUUyBGT1IgKG86JHs8JT1fbkNvZGUoKSU+fSkgUkVRVUlSRSBvLiR7ZWFDb2RlfSBJUyBVTklRVUU7DQpgDQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5jcWwgKz0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKS5qb2luKCdcbicpLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0LmNxbCk7DQogICAgICAgIHJldHVybiByZXQuY3FsOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3RvQ3lNZXJnZSclPihmaWVsZHMsIGJSYXcpew0KICAgICAgICBsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMsIHRydWUpOw0KICAgICAgICBsZXQgdWtleXMgPSBbXTsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuSXNVbmlxdWUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgIGlmKDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikgdWtleXMucHVzaCg8JT1fbkNvZGUoZWEpJT4pOw0KICAgIDwlIH0pJT4NCiAgICAgICAgbGV0IGNxbCA9IGA6JHs8JT1fbkNvZGUoKSU+fSB7YCArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdWtleXMuaW5jbHVkZXMoaykpLm1hcChrID0+IGsgKyAiOiAiICsgb2JqW2tdKS5qb2luKCcsICcpICsgYH0pYDsNCiAgICAgICAgDQogICAgICAgIGlmKCFiUmF3KXsNCiAgICAgICAgICAgIGxldCBtYXRjaCA9ICdcbk1BVENIIChvJyArIGNxbDsNCiAgICAgICAgICAgIGNxbCA9ICdNRVJHRSAobycgKyBjcWw7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBvblNldCA9IE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gIXVrZXlzLmluY2x1ZGVzKGspKS5tYXAoayA9PiAiby4iICsgayArICI9IiArIG9ialtrXSkuam9pbignLCAnKQ0KICAgICAgICAgICAgY3FsICs9ICdcbk9OIENSRUFURSBTRVQgJyArIG9uU2V0ICsgJ1xuT04gTUFUQ0ggU0VUICcgKyBvblNldDsNCiAgICAgICAgICAgIGNxbCArPSAnXG5SRVRVUk4gbzsnOw0KDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIGNxbCArPSBtYXRjaCArICcsICcgKyB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPihudWxsLCB0cnVlKS5yZXBsYWNlKCcoOicsICcoPCU9bk5hbWUoZWEpJT46JykgKyAnIE1FUkdFIChvKS1bOjwlPW5OYW1lKGMpJT5fPCU9bk5hbWUoZWEpJT5dLT4oPCU9bk5hbWUoZWEpJT4pOyc7DQogICAgPCUgfSklPg0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGNxbCA9ICcoJyArIGNxbDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgIHJldHVybiBjcWw7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b0N5UXVlcnknJT4oZmllbGRzLCBvYmpzKXsNCiAgICAgICAgbGV0IHNxbCA9ICJNQVRDSCAiOw0KICAgICAgICANCiAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfWA7DQoNCiAgICAgICAgbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7DQoNCiAgICAgICAgc3FsICs9IGAgKCR7dFByZWZ9OiR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICAgICAgDQogICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgIE9QVElPTkFMIE1BVENIICgke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9OiR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSkgT1BUSU9OQUwgTUFUQ0ggKCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpfSR7dGhpcy5fUSgpfSktWzoke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfV0tPigke3RoaXMuX1EoKX0ke2t9JHt0aGlzLl9RKCl9KWApOw0KICAgICAgICANCg0KICAgICAgICAvL3NxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsNCiAgICAgICAgLy9PYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsNCiAgICAgICAgDQogICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBmdW5jdGlvbn0NCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgIH0NCg0KICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KDQogICAgICAgIHNxbCA9IHRoaXMuX19leHBvcnQoe3NxbDogc3FsfSwgew0KICAgICAgICAgICAgX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZD09dGhpcy5JZCk/WydJZCddOnVuZGVmaW5lZCwNCiAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICBpZighdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuPCU9bU5hbWUlPih0Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIElkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgc3dpdGNoKGNvb3Apew0KICAgICAgICAgICAgICAgICAgICBjYXNlICIhPSI6DQogICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCAiOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb3AgPSAiIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHtjb29wfSBFWElTVFMgeyR7di48JT1tTmFtZSU+KCl9fWA7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQgfHwgZWEuSXNJbWFnZSB8fCBlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyA8JWlmKGVhLklzQm9vbCl7JT4iPSI8JX1lbHNleyU+KHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgIkNPTlRBSU5TIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi50b0lTT1N0cmluZyl7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyB2ICsgKCh0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iTElLRSIgfHwgIXRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPyIlIjoiIikgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09ImJvb2xlYW4iKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyAodj8iMSI6IjAiKSArICInIjsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgdi5FbnRpdHlDbGFzcyl7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIiciICsgdiArICInIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC48JT1tTmFtZSU+KCI8JT1uTmFtZSh0YSklPi5pZCIpKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgak9QID0gJ1VOSU9OIEFMTCc7DQogICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYGA7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgIGluT1AgPSAnTk9UIElOJzsNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nPScgfHwgdGhpcy5fPCU9dGFOYW1lJT5fY29vcD09J0lOJyl7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgIGpPUCA9ICdJTlRFUlNFQ1QnOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBvYmouc3FsICs9IGBhbmQgLyo8JT10YU5hbWUlPiovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdJZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgaWYoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5Jc1RleHQgJiYgIWVhLklzSW1hZ2UgJiYgIWVhLklzRmlsZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KDQogICAgICAgIGlmKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNxbCArPSAnIHJldHVybiAnICsgW3RQcmVmXS5jb25jYXQoT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5tYXAoayA9PiBgJHt0aGlzLl9RKCl9JHtrfSR7dGhpcy5fUSgpfWApKS5qb2luKCcsICcpOw0KICAgICAgICANCiAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdfbmVvNGonJT4oY3FsKXsNCiAgICA8JSBpZihtYWluQ2xhc3MoWydOZW80aiddKT09Yyl7JT4NCiAgICAgICAgbGV0IHNlc3Npb24gPSBudWxsOw0KICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0aGlzLlRvb2wuZGIgfHwgIWNxbCB8fCAhY3FsLnRyaW0oKSl7DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYikgPCU9bG9nKCklPmNxbCwgIiA8PT1TS0lQUEVEPT0+Iik7DQogICAgICAgICAgICAgICAgcmV0dXJuIFtdOw0KICAgICAgICAgICAgfQ0KICAgIA0KICAgICAgICAgICAgaWYoY3FsLmluZGV4T2YoJztcbicpPjApew0KICAgICAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3Qgc3FsUyBvZiBjcWwuc3BsaXQoJztcbicpKXsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy48JT1tTmFtZSU+KHNxbFMudHJpbSgpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYlN0b3JlID0gWyJNRVJHRSIsICJDUkVBVEUiLCAiVVBEQVRFIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCiAgICAgICAgICAgIGxldCBiRE1MID0gWyJDT05TVFJBSU5UIl0uZmlsdGVyKG4gPT4gY3FsLmluZGV4T2Yobik+PTApLmZpbmQobiA9PiBuKTsNCg0KICAgICAgICAgICAgaWYoYkRNTCl7DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlID0gdGhpcy5Ub29sLmRtbENhY2hlIHx8IHt9Ow0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKGNxbCldKSByZXR1cm47DQogICAgICAgICAgICAgICAgdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoY3FsKV0gPSBjcWw7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHNlc3Npb24gPSB0aGlzLlRvb2wuZGIuc2Vzc2lvbih7IGRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpIH0pOw0KICAgICAgICAgICAgbGV0IGZ1biA9ICdSZWFkJzsNCiAgICAgICAgICAgIGlmKGJTdG9yZSB8fCBiRE1MKSBmdW4gPSAnV3JpdGUnOw0KICAgICAgICAgICAgaWYoZnVuPT0nV3JpdGUnKSB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goY3FsKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT5jcWwpOw0KICAgICAgICAgICAgLy9yZXQgPSAoYXdhaXQgc2Vzc2lvblsnZXhlY3V0ZScrZnVuXSh0eCA9PiB0eC5ydW4oY3FsKSkpLnJlY29yZHM7DQogICAgICAgICAgICAvLzwlPWxvZygpJT5yZXQpOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIGlmKHNlc3Npb24pIGF3YWl0IHNlc3Npb24uY2xvc2UoKTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICA8JSB9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnTmVvNGonXSkpJT4oKS48JT1tTmFtZSU+KGNxbCk7DQogICAgPCUgfSU+DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ1J4REInLCAnTW9uZ29EQiddKSl7JT4NCiAgICA8JT1tTmFtZT0nX3RvSlNPTlNjaGVtYSclPigpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgdHlwZSA9IHRoaXMuX19jb25maWcoJ2pzb24udHlwZScsICd0eXBlJyk7DQogICAgICAgICAgICBsZXQgc2NoZW1hID0gew0KICAgICAgICAgICAgICAgICRpZDogJzwlPWMuSWQlPicsDQogICAgICAgICAgICAgICAgJHNjaGVtYTogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LzIwMjAtMTIvc2NoZW1hIiwNCiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJzwlPWMuUmVtYXJrJT4nLA0KICAgICAgICAgICAgICAgIHRpdGxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIFt0eXBlXTogJ29iamVjdCcsDQogICAgICAgICAgICAgICAgdmVyc2lvbjogMCwNCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7DQogICAgICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICAgICAgWzwlPV9uQ29kZShlYSklPl06IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiPCU9ZWEuUmVtYXJrJT4iLA0KICAgICAgICAgICAgPCUgaWYoZWEuSXNBcnJheSl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmFycmF5JywgJ2FycmF5JyksDQogICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogew0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgJHJlZjogJzwlPWVhLkVudGl0eUNsYXNzLklkJT4nLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5zdHJpbmcnLCAnc3RyaW5nJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS50ZXh0JywgJ3N0cmluZycpLA0KICAgICAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuYm9vbCcsICdib29sZWFuJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXTogdGhpcy5fX2NvbmZpZygnanNvbi50eXBlLmludCcsICdpbnRlZ2VyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuZmxvYXQnLCAnbnVtYmVyJyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ltYWdlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgW3R5cGVdOiB0aGlzLl9fY29uZmlnKCdqc29uLnR5cGUuaW1hZ2UnLCAnb2JqZWN0JyksDQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ZpbGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV06IHRoaXMuX19jb25maWcoJ2pzb24udHlwZS5maWxlJywgJ29iamVjdCcpLA0KICAgICAgICAgICAgPCUgfSU+DQogICAgICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICByZXF1aXJlZDogWzwlYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLlJlcXVpcmVkKS5tYXAoZWEgPT4geyU+PCU9X25Db2RlKGVhKSU+PCV9KS5qb2luKCcsJyklPl0sDQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICA8JT1sb2coKSU+c2NoZW1hKTsNCiAgICAgICAgICAgIHJldHVybiBzY2hlbWE7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKFsnTW9uZ29EQicsICdSeERCJywgJ1phbmdvREInXSkpeyU+DQogICAgPCU9bU5hbWU9J190b1NlbGVjdE1kYiclPigpew0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgX1RISVM6IG9iaiA9PiBvYmouX2lkID0geyRpbjogdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgICAgICAgICAgSWQ6IG9iaiA9PiBvYmouX2lkID0gdGhpcy5JZCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBpZighdi48JT1tTmFtZSU+KSByZXR1cm47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0ge307DQogICAgICAgICAgICAgICAgbGV0IG9wID0gIiRlIjsNCiAgICAgICAgICAgICAgICBzd2l0Y2godGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGUiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIj4iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICI8IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gIiRsdCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPj0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGd0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiPD0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJGx0ZSI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAiIT0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgb3AgPSAiJG5lIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICJJTiI6DQogICAgICAgICAgICAgICAgICAgICAgICBvcCA9ICIkaW4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV1bb3BdID0gdi48JT1tTmFtZSU+KCkudG9JU09TdHJpbmcoKTsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHYuPCU9bU5hbWUlPigpOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdjsNCiAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0geyRpbjogdi5tYXAodCA9PiB0LjwlPW1OYW1lJT4oKSl9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQo8JSB9JT4NCg0KPCUgaWYobWFpbkNsYXNzKF9zcWxUb29scykpeyU+DQogICAgPCU9bU5hbWU9J190b0RCT2JqZWN0JyU+KGZpZWxkcywgYk5vUmVmKXsNCiAgICAgICAgaWYoIXRoaXMuSWQpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+IkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7DQogICAgICAgIH0NCiAgICAgICAgbGV0IHJldCA9IHsNCiAgICAgICAgICAgIFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciDQogICAgICAgIH07DQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgaWYoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIjwlPWVhLk5hbWUlPiIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgKCFiTm9SZWYgfHwgPCU9ZWEuRW50aXR5VHlwZT8nZmFsc2UnOid0cnVlJyU+KSl7DQogICAgICAgICAgICBsZXQgZlZhbHVlID0gbnVsbDsNCiAgICAgICAgICAgIGxldCB2ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgaWYodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkPT12LklkKSl7DQogICAgICAgICAgICAgICAgZlZhbHVlID0gIiciICsgdi5JZCArICInIjsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICJOVUxMIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdj8xOjA7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSBmVmFsdWU/J1RydWUnOidGYWxzZSc7DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKSBmVmFsdWUgPSAiJyIgKyBmVmFsdWUgKyAiJyI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0KXslPg0KICAgICAgICAgICAgZlZhbHVlID0gdiB8fCAnMCc7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyAodj92LnRvSVNPU3RyaW5nKCk6IjE5NzAtMS0xIikgKyAiJyI7DQogICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnKXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNPYmplY3QpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyBKU09OLnN0cmluZ2lmeSh2LCBudWxsLCAnXHQnKSArICInIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyU+DQogICAgICAgICAgICBmVmFsdWUgPSB2PT09bnVsbD8iTlVMTCI6KCInIiArICgoZmFsc2UgJiYgdiAmJiB2LnJlcGxhY2UpP3YucmVwbGFjZSgvXFxuL2csICJcXFxcbiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCcvZywgIlxcXFwnIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnXFxcXCInKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwmL2csICJcXFxcJiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXHIvZywgIlxcXFxyIikNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcdC9nLCAiXFxcXHQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFxiL2csICJcXFxcYiIpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXGYvZywgIlxcXFxmIikgIDp2KSArICInIik7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgIGlmKHY9PT1udWxsKXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiTlVMTCI7DQogICAgICAgICAgICB9ZWxzZSBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0nU3FsREInKXsNCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdteXNxbCcpew0KICAgICAgICAgICAgICAgICAgICBmVmFsdWUgPSBgRlJPTV9CQVNFNjQoJyR7dGhpcy5fYnRvYSh2KX0nKWA7DQogICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgIGZWYWx1ZSA9IGBjYXN0KHVuaGV4KCcke3Yuc3BsaXQoIiIpLm1hcCh4ID0+ICgyNTYgKyB4LmNoYXJDb2RlQXQoKSkudG9TdHJpbmcoMTYpLnN1YnN0cigtMikpLmpvaW4oIiIpfScpIGFzIHZhcmNoYXIpYDsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgZlZhbHVlID0gdjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBmVmFsdWUgPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZXsgJT4NCiAgICAgICAgICAgIGZWYWx1ZSA9ICInIiArIHYgKyAiJyI7DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0WzwlPV9uQ29kZShlYSklPiArICI8JT0oZWEuRW50aXR5VHlwZT8naWQnOicnKSU+Il0gPSBmVmFsdWU7DQogICAgICAgIH0NCiAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KPCUgfSU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pKXslPg0KICAgIGFzeW5jIDwlPW1OYW1lPSdnZXQnJT4obmFtZSkgew0KICAgICAgICBpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOw0KICAgICAgICB2YXIgdCA9IG51bGw7DQogICAgICAgICQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7DQogICAgICAgICAgICB0ID0gew0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdCA/IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbdF0NCiAgICAgICAgICAgICAgICB9IDogew0KICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIElkOiB0aGlzLklkDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgTmFtZTogZiwNCiAgICAgICAgICAgICAgICAgICAgT1BFUkFUT1JTOiB7DQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPSINCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7DQogICAgICAgICAgICA8JT1sb2coKSU+ZXYpOw0KICAgICAgICAgICAgaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7DQogICAgICAgICAgICBpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsNCiAgICAgICAgICAgIGlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOw0KICAgICAgICAgICAgaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7DQoNCiAgICAgICAgICAgIGlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOw0KDQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT5bJC5ncmVwKDwlPXNjb3BlJT4uRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7DQogICAgICAgIH0pOw0KICAgIH0NCjwlIH0lPg0KDQo8JSBpZihtYWluQ2xhc3MoX3NxbFRvb2xzKSl7JT4NCiAgICA8JT1tTmFtZT0nX1EnJT4oKXsNCiAgICAgICAgbGV0IF9vID0gJyInOw0KICAgICAgICBsZXQgX3EgPSBfbzsNCg0KICAgICAgICBpZihbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpPT0wKXsNCiAgICAgICAgICAgIF9vID0gX3EgPSAiIjsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWU9PSdOZW80aicpew0KICAgICAgICAgICAgX28gPSBfcSA9ICdgJzsNCiAgICAgICAgfWVsc2UgaWYoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKT09MCl7DQogICAgICAgICAgICBfbyA9IF9xID0gYCdgOw0KICAgICAgICB9ZWxzZSBpZih0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxzZXJ2ZXInKXsNCiAgICAgICAgICAgIF9vID0gJ1snOw0KICAgICAgICAgICAgX3EgPSAnXSc7DQogICAgICAgIH1lbHNlIGlmKHRoaXMuX19jb25maWcoJ2FwaUtleScpPT0nYWlydGFibGUnKXsNCiAgICAgICAgICAgIF9vID0gJ3snOw0KICAgICAgICAgICAgX3EgPSAnfSc7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9vP19xOl9vOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2ZpZWxkR3JvdXBzJyU+KGZncyA9IHt9KXsNCiAgICAgICAgdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J19maWVsZEFnZ3JlZ2F0ZXMnJT4oZmFzID0ge30pew0KICAgICAgICB0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0ZpZWxkc1NRTCclPihmaWVsZHMpew0KICAgICAgICANCiAgICAgICAgZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyksIDwlPWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IF9uQ29kZShlYSkgKyAoZWEuRW50aXR5VHlwZT8nKyIuaWQiJzonJykpLmpvaW4oJywnKSU+XTsNCiAgICAgICAgZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpP2ZpZWxkczpbZmllbGRzXTsNCg0KICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMpew0KICAgICAgICAgICAgLy8ge2ZpZWxkOiBvcmRlcn0NCiAgICAgICAgICAgIGZpZWxkcyA9IFtdOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzLjwlPW5OYW1lKGVhKSU+KSBmaWVsZHMucHVzaChgJHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fWApOw0KICAgIDwlIH0pJT4NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmllbGRzOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2Zyb21EQk9iamVjdCclPihyPXt9KXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQociwgew0KICAgICAgICAgICAgICAgIElkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyldLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KG9ialtlYUNvZGVdKTsNCiAgICAgICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1NlbGVjdEhlYWRlciclPihmaWVsZHMpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gew0KICAgICAgICAgICAgICAgIHRhYmxlOiA8JT1fbkNvZGUoKSU+LA0KICAgICAgICAgICAgICAgIGZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLA0KICAgICAgICAgICAgICAgIGpvaW5zOiB7fSwNCiAgICAgICAgICAgIH07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKGZpZWxkcykgcmV0dXJuIHJldDsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqW2VhQ29kZV0gPSBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpLjwlPW1OYW1lJT4oKSwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9TZWxlY3RTUUwnJT4oZmllbGRzKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHNxbCA9ICJzZWxlY3QgIjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7PCU9X25Db2RlKCklPn0ke3RoaXMuX1EoKX1gOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsNCg0KICAgICAgICAgICAgc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOw0KICAgICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7DQogICAgDQogICAgICAgICAgICBpZih0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKXsNCiAgICAgICAgICAgICAgICAvLyB7ZmllbGQ6IGZ1bmN0aW9ufQ0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuSXNUZXh0ICYmICFlYS5Jc0ltYWdlICYmICFlYS5Jc0ZpbGUpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLjwlPW5OYW1lKGVhKSU+fSgke3RoaXMuX1EoKX0kezwlPV9uQ29kZShlYSklPn0ke3RoaXMuX1EoKX0pYDsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgDQogICAgICAgICAgICBzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7DQogICAgICAgICAgICANCiAgICAgICAgICAgIE9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9IGApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgKz0gYCB3aGVyZSAxPTFgOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzcWwgPSB0aGlzLl9fZXhwb3J0KHtzcWw6IHNxbH0sIHsNCiAgICAgICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIF9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQ9PXRoaXMuSWQpP1snSWQnXTp1bmRlZmluZWQsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih2LnJldXNlZD4yKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwlPXdhcm4oKSU+IlJldXNlZDogIiwgdik7DQogICAgICAgICAgICAgICAgICAgICAgICB2Lm9iai5zcWwgPSBgLypSRVNVRUQ6ICR7di5yZXVzZWR9Ki9gOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfVEhJUzogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgLyphbmQgKi8ke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0LjwlPW1OYW1lJT4odC5fX2NvbmZpZygnaWRGaWVsZCcpfHwnSWQnKS50aGlzKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqLnNxbCArPSAodGhpcy5JZD09dGhpcy5JZCk/YCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A6JycsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICBsZXQgY29vcCA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgICAgIHN3aXRjaChjb29wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiE9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIk5PVCBJTiI7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICI9IjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29wID0gIklOIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIiI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcCA9ICJJTiI7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuPCU9bU5hbWUlPih2Ll9fY29uZmlnKCdpZEZpZWxkJywgJ0lkJykpfSlgOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCB8fCBlYS5Jc0ltYWdlIHx8IGVhLklzRmlsZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgPCVpZihlYS5Jc0Jvb2wpeyU+Ij0iPCV9ZWxzZXslPih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wIHx8ICJMSUtFIik8JX0lPiArICIgIjsNCiAgICAgICAgPCUgfSU+DQogICAgICAgIA0KICAgICAgICA8JSBpZihlYS5Jc0RhdGUpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYudG9JU09TdHJpbmcpew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNTdHJpbmcpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yodik9PT0ic3RyaW5nIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgdiArICgodGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcD09IkxJS0UiIHx8ICF0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKT8iJSI6IiIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzQm9vbCl7ICU+DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZih2KT09PSJib29sZWFuIil7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmouc3FsICs9ICInIiArICh2PyIxIjoiMCIpICsgIiciOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgICAgICAgICAgaWYodiAmJiB2LkVudGl0eUNsYXNzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcWwgKz0gIigiICsgdi48JT1tTmFtZSU+KCkgKyAiKSI7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLl88JT10YU5hbWUlPl9zZXQpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIGxldCBqT1AgPSAnVU5JT04gQUxMJzsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGluT1AgPSAnSU4nOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09JyE9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nTk9UIElOJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpbk9QID0gJ05PVCBJTic7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuXzwlPXRhTmFtZSU+X2Nvb3A9PSc9JyB8fCB0aGlzLl88JT10YU5hbWUlPl9jb29wPT0nSU4nKXsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5fPCU9dGFOYW1lJT5fY29vcD09Jz09Jyl7DQogICAgICAgICAgICAgICAgICAgICAgICBqT1AgPSAnSU5URVJTRUNUJzsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgb2JqLnNxbCArPSBgYW5kIC8qPCU9dGFOYW1lJT4qLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0LjwlPW1OYW1lJT4oIjwlPW5OYW1lKHRhKSU+LmlkIikpLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBmaWVsZHMpLnNxbDsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2ZpZWxkR3JvdXBzKXsNCiAgICAgICAgICAgICAgICBpZihPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLklzVGV4dCAmJiAhZWEuSXNJbWFnZSAmJiAhZWEuSXNGaWxlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl9fZmllbGRHcm91cHMuPCU9bk5hbWUoZWEpJT4pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoZWEpJT48JT0oZWEuRW50aXR5VHlwZT8nKyJpZCInOicnKSU+fSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy48JT1uTmFtZShlYSklPn1gOw0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYoIXNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpew0KICAgICAgICAgICAgICAgIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikhPT0ndW5kZWZpbmVkJz9zcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCk6c3FsOw0KICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBzcWw7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b1BhdGhzJyU+KCl7DQogICAgICAgIGxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7DQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHt9LA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPiA9IHYuPCU9bU5hbWUlPigpLA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gX3YuPCU9bU5hbWUlPigpKSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIC8vIHJldHVybiByZXQ7DQogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7W2tdOiByZXRba119KSk7DQogICAgfQ0KDQogICAgPCU9bU5hbWU9J190b1VwZGF0ZVNRTCclPihmaWVsZHMpew0KICAgICAgICBsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsNCiAgICAgICAgbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOw0KICAgICAgICA8JT1sb2coKSU+c3FsKTsNCiAgICAgICAgcmV0dXJuIHNxbDsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvSW5zZXJ0U1FMJyU+KGZpZWxkcyl7DQogICAgICAgIGxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7DQogICAgICAgIGxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHs8JT1fbkNvZGUoKSU+fSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7DQogICAgICAgIDwlPWxvZygpJT5zcWwpOw0KICAgICAgICByZXR1cm4gc3FsOw0KICAgIH0NCjwlIH0gJT4NCiAgICANCiAgICA8JT1tTmFtZT0nX2NvcHlGcm9tJyU+KG9iail7DQogICAgICAgIGlmKCFvYmopIHJldHVybiBudWxsOw0KICAgICAgICByZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdG9PYmpUcmVlJyU+KGJDeWNsaWMpew0KICAgICAgICA8JT13YXJuKCklPiJkZXByZWNhdGVkIik7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICANCiAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICByZXR1cm4gdGhpcy5fX2V4cG9ydChuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoYy5OYW1lLCB0cnVlKSU+KCc8JT1jLk5hbWUlPicpLCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgICAgICAgICAgQ3ljbGljOiBiQ3ljbGljLA0KICAgICAgICAgICAgLy9leHBvcnRlcjogdiA9PiA8JT13YXJuKCklPnYucmV1c2VkKSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9bk5hbWUoZWEpJT4oPCVpZihlYS5FbnRpdHlUeXBlKXslPm5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKTwlfWVsc2V7JT52PCV9JT4pLA0KICAgIDwlIH0pOyU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiBvYmouPCU9dGFOYW1lJT4obmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihiQ3ljbGljKSksDQogICAgPCUgfSk7JT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J191bkN5Y2xlJyU+KHNvdXJjZT10aGlzKXsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19leHBvcnQodGhpcywgew0KICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai48JT1uTmFtZShlYSklPihzb3VyY2U9PW9iai48JT1uTmFtZShlYSklPigpP251bGw6dW5kZWZpbmVkKSwNCiAgICA8JSB9KTslPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gdHJ1ZSwNCiAgICA8JSB9KTslPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nX3N0b3JlRW50aXR5Q2xhc3MnJT4oZGVwdGgpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZih0eXBlb2YoZGVwdGgpPT09InVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7DQogICAgICAgICAgICBpZighZGVwdGgpIHJldHVybjsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5Ub29sLjwlPW1OYW1lJT4gPSB0aGlzLlRvb2wuPCU9bU5hbWUlPiB8fCB7fTsNCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4pIHJldHVybjsNCiAgICAgICAgICAgIHRoaXMuVG9vbC48JT1tTmFtZSU+LjwlPW5OYW1lKGMpJT4gPSB0cnVlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsNCiAgICAgICAgICAgIA0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5EU0Nvbm5lY3QoKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgbGV0IGNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvQ3lUYWJsZShkZXB0aCk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPmNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fbmVvNGooY3FsKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iQWlyVGFibGUiKXslPg0KICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2FpcnRhYmxlKCdtZXRhL2Jhc2VzJywgbnVsbCwge25hbWU6ICc8JT1zY29wZSU+Jywgd29ya3NwYWNlSWQ6IHRoaXMuVG9vbC5kYi53b3Jrc3BhY2VJZCwgdGFibGVzOiB0aGlzLl90b0FUVGFibGUoZGVwdGgpfSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyU+DQogICAgICAgICAgICAgICAgbGV0IHNxbCA9IHRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU1FMVGFibGUoe3JldXNlZDogM30pOyA8JS8qZGVwdGg6IGNoYWxsZW5nZSAtIHRvbyBsb3cgZG9lcyBub3QgY292ZXIgYWxsIHRhYmxlcywgdG9vIGhpZ2ggKG1heCBkZXB0aCkgcmVzdWx0cyBpbiBvdXQtb2YtbWVtb3J5IG9uIGJyb3dzZXIqLyU+DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnNxbCk7DQogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHNxbCk7DQogICAgPCUgfWVsc2UgaWYodD09IlNlcnZpY2VOb3ciKXslPg0KICAgICAgICAgICAgICAgIC8vPCU9bG9nKCklPnRoaXMvKi5fdG9PYmpUcmVlKHRydWUpKi8uX3RvU05UYWJsZSgpKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iRU1TIil7JT4NCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90b0VNU0NsYXNzKGRlcHRoKS5zdG9yZSgpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJCSVNlcnZlciIpeyU+DQogICAgICAgICAgICAgICAgLy8gb25seSBkbyB0aGlzIGlmIHRoZSBtb2R1bGUgaXMgbm90IGxvYWRlZCBmcm9tIA0KICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogew0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgQ29tcGFueTogew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb2RlOiB0aGlzLl9fY29uZmlnKCdjb21wYW55JywgJzwlPXNjb3BlJT4nKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICB9KSkuZm9yRWFjaChlYSA9PiAvKiB0cnllIF9lYVR5cGVzICovPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goc2VhID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoc2VhLklkIT09ZWEuSWQgJiYgc2VhLk5hbWU9PWVhLk5hbWUgJiYgKHNlYS5FbnRpdHlDbGFzcy5JZD09ZWEuRW50aXR5Q2xhc3MuSWQgfHwgc2VhLkVudGl0eUNsYXNzLk5hbWU9PWVhLkVudGl0eUNsYXNzLk5hbWUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5JZCA9PSBlYS5JZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlYS5FbnRpdHlDbGFzcy5JZCA9IGVhLkVudGl0eUNsYXNzLklkOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWU9PXNlYS5FbnRpdHlDbGFzcy5OYW1lKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoc2NlYSA9PiBzY2VhLk5hbWU9PWVhLk5hbWUpLklkID0gZWEuSWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KSk7DQogICAgPCUgfWVsc2UgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wuZGIpIGF3YWl0IHRoaXMuVG9vbC5kYi5jcmVhdGVDb2xsZWN0aW9uKDwlPV9uQ29kZSgpJT4sIHt2YWxpZGF0b3I6IHskanNvblNjaGVtYTogdGhpcy5fdG9KU09OU2NoZW1hKCl9fSk7DQogICAgPCUgfWVsc2UgaWYodD09IlJ4REIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgYXdhaXQgdGhpcy5Ub29sLmRiLmFkZENvbGxlY3Rpb25zKHtbPCU9X25Db2RlKCklPl06IHtzY2hlbWE6IHRoaXMuX3RvSlNPTlNjaGVtYSgpfX0pOw0KICAgIDwlIH0lPg0KICAgICAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbG9nJyU+KG9iaj10aGlzKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvYmopOw0KPCUgfWVsc2V7JT4NCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gb2JqLm1hcChvID0+IHRoaXMuX2xvZyhvKSk7DQogICAgICAgICAgICBpZihvYmouRW50aXR5Q2xhc3MpIG9iaiA9IG9iai5fdG9KU09OKHtiTWFwOiB0cnVlfSk7DQogICAgICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQo8JSB9JT4NCiAgICB9DQoNCiAgICBhc3luYyA8JT1tTmFtZT0nRFNDb25uZWN0JyU+KHRvb2w9dGhpcy5Ub29sKXsNCjwlIGlmKG1haW5DbGFzcygpIT1jKXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKG1haW5DbGFzcygpLCB0cnVlKSU+KCkuPCU9bU5hbWUlPih0b29sKTsNCjwlIH1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCF0b29sKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbCBpcyBudWxsIiwgdGhpcy5Ub29scy5sZW5ndGgsIDwlPXNjb3BlJT4uVG9vbHMubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9ZWxzZSBpZighdG9vbC50eXBlKXsNCiAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4iVG9vbC50eXBlIGlzIG51bGwiLCB0b29sLCB0aGlzLlRvb2xzLmxlbmd0aCwgPCU9c2NvcGUlPi5Ub29scy5sZW5ndGgpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH1lbHNlIGlmKHR5cGVvZih0b29sLmRiKSE9PSJ1bmRlZmluZWQiKXsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlRvb2wgYWxyZWFkeSBjb25uZWN0ZWQhIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfWVsc2UgaWYoPCU9bnNjb3BlJT4uX25vZGUgJiYgLyo8JT1uc2NvcGUlPi5fbm9kZS5fcGFyZW50X3NldCAmJiAqLzwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpLl9zYW1lRW50aXR5KDwlPW5zY29wZSU+Ll9ub2RlLnBhcmVudCgpKSl7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPiJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICB0b29sLl9fZG1sU3RhdGVtZW50cyA9IHRvb2wuX19kbWxTdGF0ZW1lbnRzIHx8IFtdOw0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJbPCU9dCU+XTogQ29ubmVjdGluZy4uLiIpOw0KDQogICAgICAgICAgICBpZih0b29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJFTVMiKXslPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNb25nb0RCIil7JT4NCiAgICAgICAgICAgICAgICAvLzwlPWxvZygpJT50aGlzLl9fY29uZmlnKCd1cmknLCBudWxsLCB7dG9vbDogdG9vbH0pLCB0aGlzLl9fY29uZmlnKCdjb25maWcnLCBudWxsLCB7dG9vbDogdG9vbH0pKTsNCiAgICAgICAgICAgICAgICBpZih0eXBlb2YobW9uZ29kYikhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSAoYXdhaXQgbmV3IG1vbmdvZGIuTW9uZ29DbGllbnQodGhpcy5fX2NvbmZpZygndXJpJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwgdGhpcy5fX2NvbmZpZygnY29uZmlnJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkuY29ubmVjdCgpKS5kYih0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH1lbHNlIGlmKHQ9PSdSeERCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gYXdhaXQgUnhEQi5jcmVhdGVSeERhdGFiYXNlKHtuYW1lOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsICI8JT1zY29wZSU+Iiwge3Rvb2w6IHRvb2x9KSwgc3RvcmFnZTogbnVsbH0pOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSdaYW5nb0RCJyl7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IHphbmdvLkRiKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgIjwlPXNjb3BlJT4iLCB7dG9vbDogdG9vbH0pLCB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICA8JT1uTmFtZShlYyklPjogWyI8JT1lYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gbk5hbWUoZWEpKS5qb2luKCdcIiwgXCInKSU+Il0sDQogICAgICAgIDwlIH0pICU+DQogICAgICAgICAgICAgICAgfSk7DQogICAgPCUgfWVsc2UgaWYodD09J0thZmthJyl7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2Yoa2Fma2FqcykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2wuZGIgPSBuZXcga2Fma2Fqcy5LYWZrYSh7DQogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRJZDogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYnJva2VyczogW3RoaXMuX19jb25maWcoJ2Jyb2tlcnMnLCBudWxsLCB7dG9vbDogdG9vbH0pXSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNzbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNhc2w6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy5fX2NvbmZpZygnY2xpZW50SWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdzYXNsX3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWNoYW5pc206IHRoaXMuX19jb25maWcoJ3Nhc2xfbWVjaGFuaXNtcycsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblRpbWVvdXQ6IDMwMDAsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB0b29sLnByb2R1Y2VyID0gdG9vbC5kYi5wcm9kdWNlcigpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0b29sLnByb2R1Y2VyLmNvbm5lY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIHRvb2wuY29uc3VtZXIgPSB0b29sLmRiLmNvbnN1bWVyKHtncm91cElkOiB0aGlzLl9fY29uZmlnKCdjbGllbnRJZCcsIG51bGwsIHt0b29sOiB0b29sfSl9KTsNCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5jb25zdW1lci5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRvb2wuY29uc3VtZXIuc3Vic2NyaWJlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICAgICAgICAgIGZyb21CZWdpbm5pbmc6IGZhbHNlLA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgPCUgaWYoX2NOYW1lKCdFdmVudCcpKXslPg0KICAgICAgICAgICAgICAgICAgICB0b29sLmNvbnN1bWVyLnJ1bih7ZWFjaE1lc3NhZ2U6IGFzeW5jICh7IHRvcGljLCBwYXJ0aXRpb24sIG1lc3NhZ2UgfSkgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKCdFdmVudCcsIHRydWUpJT4oKS5fZnJvbURvY3VtZW50KG1lc3NhZ2UudmFsdWUudG9TdHJpbmcoKSkucHJvY2VzcygpfSk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSdNZW1vcnknKXslPg0KICAgICAgICAgICAgICAgIHRvb2wuZGIgPSB7DQogICAgICAgIDwlIGFyQ2xhc3Nlcy5mb3JFYWNoKGVjID0+IHslPg0KICAgICAgICAgICAgICAgICAgICAnPCU9bk5hbWUoZWMpJT4nOiBbXSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgICAgICAgICAgfTsNCiAgICA8JX1lbHNlIGlmKHQ9PSJFeGNlbCIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0ndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSA8JT1zY29wZSU+Lnhsc3hEYXRhP1hMU1gucmVhZCg8JT1zY29wZSU+Lnhsc3hEYXRhKTpYTFNYLnV0aWxzLmJvb2tfbmV3KCk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uZGIgPSBYTFNYLnJlYWQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnZmlsZW5hbWUnLCBudWxsLCB7dG9vbDogdG9vbH0pKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlfWVsc2UgaWYodD09IlNub3dGbGFrZSIpeyU+DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKGdsb2JhbCkhPT0ndW5kZWZpbmVkJyAmJiBnbG9iYWwuc25vd2ZsYWtlKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbC5zbm93Zmxha2UuY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OiB0aGlzLl9fY29uZmlnKCJhY2NvdW50IiwgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLl9fY29uZmlnKCJ1c2VybmFtZSIsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogdGhpcy5fX2NvbmZpZygicGFzc3dvcmQiLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb246IHRoaXMuX19jb25maWcoInNjb3BlIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiPCU9c2NvcGUlPiIsDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdCgoZXJyLCBjb25uKT0+ew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT4nVW5hYmxlIHRvIGNvbm5lY3Q6ICcgKyBlcnIubWVzc2FnZSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlaihlcnIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2wuZGIuY29ubmVjdGlvbl9JRCA9IGNvbm4uZ2V0SWQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJOZW80aiIpeyU+DQogICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5lbzRqLmRyaXZlcigNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fX2NvbmZpZygndXJsJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgbmVvNGouYXV0aC5iYXNpYyh0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksIHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSkNCiAgICAgICAgICAgICAgICApOw0KICAgIDwlfWVsc2UgaWYodD09IkFpclRhYmxlIil7JT4NCiAgICAgICAgICAgICAgICB0b29sLmRiID0gew0KICAgICAgICAgICAgICAgICAgICBiYXNlSWQ6ICcnLA0KICAgICAgICAgICAgICAgICAgICB3b3Jrc3BhY2VJZDogdGhpcy5fX2NvbmZpZygnd29ya3NwYWNlSWQnLCBudWxsLCB7dG9vbDogdG9vbH0pLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJywNCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnLA0KICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS93aG9hbWknKSkuaWQsDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIGxldCBiYXNlcyA9IChhd2FpdCB0aGlzLl9haXJ0YWJsZSgnbWV0YS9iYXNlcycpKS5iYXNlczsNCiAgICAgICAgICAgICAgICBpZihiYXNlcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiLmJhc2VJZCA9IGJhc2VzLmZpbHRlcihiID0+IGIubmFtZT09JzwlPXNjb3BlJT4nKS5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoIXRoaXMuVG9vbC5kYi5iYXNlSWQpIHRvb2wuZGIuYmFzZUlkID0gJ2FwcCcgKyB0aGlzLl91dWlkKCkuc3BsaXQoJy0nKS5zbGljZSgtMSlbMF07DQogICAgPCV9ZWxzZSBpZih0PT0iU3FsREIiKXslPg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihnbG9iYWwpIT09J3VuZGVmaW5lZCcgJiYgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pXSl7DQogICAgICAgICAgICAgICAgICAgIGlmKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uRGF0YWJhc2Upew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IG5ldyBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHRvb2wpXS5EYXRhYmFzZSh0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgIi4vPCU9c2NvcGUlPi5kYiIpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLmNyZWF0ZUNvbm5lY3Rpb24pew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9vbC5kYiA9IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uY3JlYXRlQ29ubmVjdGlvbih7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdDogdGhpcy5fX2NvbmZpZygnc2VydmVyJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiB0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHt0b29sOiB0b29sfSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwge3Rvb2w6IHRvb2x9KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhYmFzZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICI8JT1zY29wZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHt0b29sOiB0b29sfSldLkNsaWVudCl7DQogICAgICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwge3Rvb2w6IHRvb2x9KV0uQ2xpZW50KHtjb25uZWN0aW9uU3RyaW5nOiB0aGlzLl9fY29uZmlnKCdjb25uc3RyJywgbnVsbCwge3Rvb2w6IHRvb2x9KX0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdG9vbC5kYi5jb25uZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YoZ2xvYmFsKT09PSd1bmRlZmluZWQnICYmIHRoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7dG9vbDogdG9vbH0pPT09J3NxbGl0ZScpew0KICAgICAgICAgICAgICAgICAgICAvLyBzcWxpdGUgaW4gYnJvd3Nlcg0KICAgICAgICAgICAgICAgICAgICB0b29sLmRiID0gbmV3IFNRTC5EYXRhYmFzZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICA8JX1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7JT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodG9vbC5zeXNfc2NvcGUpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyB0b29sLnN5c19zY29wZSA9IChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfYXBwIiwge3N5c19zY29wZTogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICJnbG9iYWwifSkpWzBdLnN5c19pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYodHlwZW9mKHRvb2wuc3lzX3Byb3BlcnRpZXMpPT09InVuZGVmaW5lZCIpew0KICAgICAgICAgICAgICAgICAgICAvLyBsb2FkaW5nIHNvbWUgcGxhdGZvcm0gc3R1ZmYNCiAgICAgICAgICAgICAgICAgICAgdG9vbC5zeXNfcHJvcGVydGllcyA9IHt9Ow0KICAgICAgICAgICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gT2JqZWN0LmtleXModG9vbC5zeXNfcHJvcGVydGllcykuZmlsdGVyKGsgPT4gIXRvb2wuc3lzX3Byb3BlcnRpZXNba10pLmpvaW4oJywnKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoY29uZGl0aW9uKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfcHJvcGVydGllcyIsIHtuYW1lOiAiSU4iK2NvbmRpdGlvbn0pKS5mb3JFYWNoKHIgPT4gdG9vbC5zeXNfcHJvcGVydGllc1tyLm5hbWVdID0gci52YWx1ZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgPCV9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCjwlIH0lPg0KICAgIH0NCiAgICAvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovDQogICAgDQogICAgPCU9bU5hbWU9J19tYXRjaGVzJyU+KHF1ZXJ5LCBvcHRpb25zKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIGlmKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSE9IjwlPW5OYW1lKGMpJT4iKSByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHR5cGVvZihtaWNyb2RpZmYpIT09J3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIGxldCB0SGFzaCA9IHRoaXMuX3RvSGFzaChudWxsLCB7bm9Db2RlOiB0cnVlLCBvbmx5VW5pcXVlOiBvcHRpb25zLm9ubHlVbmlxdWV9LCAnPCU9bU5hbWUlPicpLl90aGlzOw0KICAgICAgICAgICAgICAgIGxldCBxSGFzaCA9IHF1ZXJ5Ll90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogb3B0aW9ucy5vbmx5VW5pcXVlfSwgJzwlPW1OYW1lJT4nKS5fdGhpczsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZXQgZGlmZiA9IG1pY3JvZGlmZihxSGFzaCwgdEhhc2gpLmZpbHRlcihkID0+IGQudHlwZSE9J0NSRUFURScgJiYgWydPUEVSQVRPUlMnLCAnSWQnXS5pbmRleE9mKGQucGF0aFswXSk8MCk7DQogICAgICAgICAgICAgICAgLy88JT1sb2coKSU+J1t0L3FdJywgdEhhc2gsIHFIYXNoLCBkaWZmKTsNCiAgICAgICAgICAgICAgICBsZXQgcmV0ID0gZGlmZi5maWx0ZXIoZCA9PiBkLnR5cGU9PSdDSEFOR0UnKS5yZWR1Y2UoKHYsIGQpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgbGV0IGNvb3AgPSBxdWVyeVsnXycgKyBkLnBhdGhbMF0gKyAnX2Nvb3AnXSB8fCAodHlwZW9mKGQudmFsdWUpPT09J3N0cmluZyc/J0xJS0UnOic9Jyk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBsZXQgb2xkVmFsdWUgPSB0eXBlb2YoZC5vbGRWYWx1ZSk9PT0nc3RyaW5nJz9kLm9sZFZhbHVlLnNwbGl0KCcvJykuc2xpY2UoLTEpWzBdOmQub2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICA8JT1sb2coKSU+ZC5wYXRoWzBdLCBkLm9sZFZhbHVlLCBkLnZhbHVlLCBjb29wLCBvbGRWYWx1ZSwgZCk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBzd2l0Y2goY29vcCl7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdMSUtFJzogcmV0dXJuIHYgJiYgKG9sZFZhbHVlPT09bnVsbCB8fCBkLnZhbHVlLmluZGV4T2Yob2xkVmFsdWUpPj0wKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz0nOiByZXR1cm4gdiAmJiAob2xkVmFsdWU9PT1udWxsIHx8ICFkLnZhbHVlIHx8IGQudmFsdWU9PW9sZFZhbHVlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyE9JzogcmV0dXJuIHYgJiYgZC52YWx1ZSE9b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc+PSc6IHJldHVybiB2ICYmIGQudmFsdWU+PW9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPD0nOiByZXR1cm4gdiAmJiBkLnZhbHVlPD1vbGRWYWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJz4nOiByZXR1cm4gdiAmJiBkLnZhbHVlPm9sZFZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnPCc6IHJldHVybiB2ICYmIGQudmFsdWU8b2xkVmFsdWU7DQogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LCB0cnVlKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+J1t0L3FdJywgcmV0LCBkaWZmKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICAgICAgICAgIC8vRnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICAvL051bGw6IHRydWUsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQ9PXF1ZXJ5LklkLA0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj92LjwlPW1OYW1lJT4ocXVlcnk/cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTpudWxsKTp0cnVlOw0KICAgICAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPW5OYW1lKGVhKSU+ID0gdj09cXVlcnkuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLl88JT1uTmFtZShlYSklPl9zZXQgJiYgIXF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZQ0KICAgICAgICAgICAgICAgICAgICApIG9iai48JT1uTmFtZShlYSklPiA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZigNCiAgICAgICAgICAgICAgICAgICAgICAgICghdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIHF1ZXJ5Ll88JT1uTmFtZShlYSklPl9zZXQpIHx8DQogICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLjwlPW1OYW1lJT4ocXVlcnkuPCU9bk5hbWUoZWEpJT4oKSkpIHx8DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlDQogICAgICAgICAgICAgICAgICAgICkgb2JqLjwlPW5OYW1lKGVhKSU+ID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgb2JqLjwlPXRhTmFtZSU+ID0gdi5tYXAoX3YgPT4gcXVlcnkuPCU9dGFOYW1lJT4oKS5hbnkocSA9PiBfdi48JT1tTmFtZSU+KHEpKSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPm9NYXRjaCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfbWF0Y2hpbmcnJT4ocXVlcnkpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQgcmV0ID0gW107DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iRm9yIDwlPW5OYW1lKGVhKSU+Iik7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHY/W3YuPCU9bU5hbWUlPihxdWVyeSk/djpudWxsXS5jb25jYXQodi48JT1tTmFtZSU+KHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSk6W107DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT10YU5hbWUlPiA9IHYubWFwKF92ID0+IF92LjwlPW1OYW1lJT4ocXVlcnkpKS5mbGF0KCk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgPCU9bG9nKCklPiJtYXRjaGVzIiwgbWF0Y2hlcyk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0hPXF1ZXJ5KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgPCU9bG9nKCklPiJyZXQiLCByZXQpOw0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX2RlUmVmZXJlbmNlJyU+KHJvb3Qpew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBpZighcm9vdCkgcm9vdD10aGlzOw0KDQogICAgICAgICAgICBpZihyb290IT10aGlzICYmIHRoaXMuU2V0X09uKSB7DQogICAgICAgICAgICAgICAgbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOw0KICAgICAgICAgICAgICAgIGlmKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICA8JT1sb2coKSU+IlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbXlNYXRjaGVzWzBdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgdGhpcy5fX2V4cG9ydCh7fSwgew0KICAgICAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHYpew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHYuPCU9bU5hbWUlPihyb290KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJldCE9dikgdGhpcy48JT1uTmFtZShlYSklPihyZXQpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgPCUgfSk7ICU+DQogICAgICAgIA0KICAgICAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IHRhLjwlPW1OYW1lJT4ocm9vdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihyZXQhPXRhKSB0aGlzLjwlPXRhTmFtZSU+KClbaV0gPSByZXQ7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgIDwlIH0pJT4NCiAgICAgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfZnJvbURvY3VtZW50JyU+KG9iaiwgYlRvb2wpew0KICAgICAgICBpZighb2JqKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYob2JqLjwlPW1OYW1lJT4pIHJldHVybiBvYmo7DQogICAgICAgIA0KICAgICAgICBpZih0eXBlb2Yob2JqKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgIGlmKDwlPV9iNjR0ZXN0KCdvYmonKSU+KSBvYmogPSB0aGlzLl9hdG9iKG9iaik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICBpZihvYmoubGVuZ3RoPDMzICYmICFvYmoubWF0Y2goL1xzL2cpKXsNCiAgICAgICAgICAgICAgICAgICAgb2JqID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnLCB7dG9vbDogb2JqLl9fdG9vbH0pXTogb2JqDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIG9iaiA9IEpTT04ucGFyc2Uob2JqKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+IkludmFsaWQgSlNPTiBvciBVVUlEIiwgb2JqKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoQXJyYXkuaXNBcnJheShvYmopKXsNCiAgICAgICAgICAgIHJldHVybiBvYmoubWFwKG8gPT4gdGhpcy48JT1tTmFtZSU+KG8sIGJUb29sKSk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmKG9iai5fX3Rvb2wpIHRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7DQogICAgICAgIA0KICAgICAgICBpZighT2JqZWN0LmtleXMob2JqKS5maWx0ZXIoayA9PiB0eXBlb2Yob2JqW2tdKSE9PSd1bmRlZmluZWQnICYmIG9ialtrXSE9PW51bGwpLmxlbmd0aCl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkVtcHR5IG9iamVjdCBvciBvYmplY3Qgb2YgbnVsbHMiLCBvYmopOw0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCg0KICAgICAgICA8JT1sb2coKSU+b2JqKTsNCiAgICAgICAgcmV0dXJuIHRoaXMuX19pbXBvcnQob2JqLCB7DQogICAgICAgICAgICBfbWFwOiBiVG9vbCwNCiAgICAgICAgICAgIGltcG9ydGVyOiB2ID0+IHYub2JqID0gKHYub2JqJiZ2Lm9iai5TZXRfQ291bnQ8dGhpcy5TZXRfQ291bnQpP3RoaXM6di5vYmosDQogICAgICAgICAgICBfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUz9vYmouT1BFUkFUT1JTLlRISVM6dW5kZWZpbmVkKSwNCiAgICAgICAgICAgIElkOiAob2JqLCBpZENvZGUpID0+IHsNCiAgICAgICAgICAgICAgICBpZihpZENvZGU9PSdJZCcpIGlkQ29kZSA9IHRoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnSWQnKTsNCiAgICAgICAgICAgICAgICBpZihvYmpbaWRDb2RlXSkgdGhpcy5JZCA9IG9ialtpZENvZGVdOw0KICAgICAgICAgICAgfSwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46IChvYmosIGVhQ29kZSkgPT4gew0KICAgICAgICAgICAgICAgIGlmKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fPCU9bk5hbWUoZWEpJT5fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHJlZiA9IG9ialtlYUNvZGVdOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZihyZWYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIDwlIGlmKCFlYS5Jc0FycmF5KXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iUmVzdERCSU8iKSByZWYgPSByZWZbMF07DQogICAgICAgICAgICAgICAgaWYoIXJlZikgcmV0dXJuOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4oKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KHJlZiwgYlRvb2wpKTsNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7ICU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IlNxbERCIil7DQogICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZihtb21lbnQpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICAgICAgICAgICAgICByZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gbmV3IERhdGUocmVmKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YocmVmKT09PSdzdHJpbmcnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlZi5pbmRleE9mKCdUJyk+MCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJlZiA9IG5ldyBEYXRlKHJlZik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICB0aGlzLjwlPW5OYW1lKGVhKSU+KCg8JT1fYjY0dGVzdCgncmVmJyklPik/dGhpcy5fYXRvYihyZWYpOihyZWYgfHwgJycpKTsNCiAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIHRoaXMuPCU9bk5hbWUoZWEpJT4ocmVmKTsNCiAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlKSA9PiBvYmpbZWFDb2RlXT90aGlzLjwlPXRhTmFtZSU+KG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLjwlPW1OYW1lJT4oX3YsIGJUb29sKSksIG9iai5PUEVSQVRPUlM/b2JqLk9QRVJBVE9SU1tlYUNvZGVdOnVuZGVmaW5lZCwgdHJ1ZSk6dW5kZWZpbmVkLA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCiAgICB9DQogICAgDQo8JSBpZihfY05hbWUoJ0V2ZW50JykpeyU+DQogICAgPCU9bU5hbWU9J190b1Byb3RvJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe0lkOiA8JT1fbkNvZGUoKSU+LCBwcm90bzogYFxuXG5tZXNzYWdlICR7PCU9X25Db2RlKCklPn0ge2AsIGluZGV4OiAxfSwgew0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuYk1hcCwNCiAgICAgICAgICAgICAgICBGdWxsOiB0cnVlLA0KICAgICAgICAgICAgICAgIE51bGw6IHRydWUsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gdi5vYmo9KHYucmV1c2VkPjEpP3twcm90bzogYFxuXG4vLyByZXVzZWRbJHt2LnJldXNlZH1dOiAkezwlPV9uQ29kZSgpJT59XG5cbmB9OnYub2JqLA0KICAgICAgICAgICAgICAgIF9USElTOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdHJlcGVhdGVkICR7PCU9X25Db2RlKCklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICAgICAgICAgICAgICBJZDogKG9iaiwgaWRDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtpZENvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9IGBcblx0YCArIG5ldyA8JT1zY29wZSU+LjwlPV9jTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihvcHRpb25zLCBgJHtzUGF0aH0uJHtlYUNvZGV9YCk7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYFxuXHRgOw0KICAgICAgICA8JSBpZihlYS5SZXF1aXJlZCl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KSBvYmoucHJvdG8gKz0gJ3JlcXVpcmVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc0FycmF5KXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gJ3JlcGVhdGVkICc7DQogICAgICAgIDwlIH0lPg0KICAgICAgICA8JSBpZihlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpeyU+DQogICAgICAgICAgICAgICAgICAgIG9iai5wcm90byArPSAic3RyaW5nIjsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImJvb2wiOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0ludCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQzMiI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzTG9uZyl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJpbnQ2NCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRmxvdCl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJmbG9hdCI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gImRvdWJsZSI7DQogICAgICAgIDwlIH1lbHNlIGlmKGVhLklzRGF0ZSl7JT4NCiAgICAgICAgICAgICAgICAgICAgb2JqLnByb3RvICs9ICJzdHJpbmciOw0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5FbnRpdHlUeXBlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gPCU9X25Db2RlKGVhLkVudGl0eVR5cGUpJT47DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgICAgICBvYmoucHJvdG8gKz0gYCAke2VhQ29kZX0gPSAke29iai5pbmRleCsrfTtgOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5wcm90byArPSBgXG5cdGAgKyBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bXWApICsgYFxuXHRyZXBlYXRlZCAkezwlPV9uQ29kZSh0YS5FbnRpdHlDbGFzcyklPn0gJHtlYUNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgPCUgYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiB7JT4NCiAgICAgICAgICAgICAgICBlZl88JT1uTmFtZShlZiklPjogKG9iaiwgZWZDb2RlLCB2KSA9PiBvYmoucHJvdG8gKz0gYFxuXHRzdHJpbmcgJHtlZkNvZGV9ID0gJHtvYmouaW5kZXgrK307YCwNCiAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgX19jbG9zZTogb2JqID0+IG9iai5wcm90byArPSAnXG59XG5cbicsDQogICAgICAgICAgICB9LCAiPCU9bU5hbWUlPiIsIG9wdGlvbnMsIHNQYXRoKS5wcm90bzsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYocmV0ICYmICFzUGF0aCl7DQogICAgICAgICAgICAgICAgcmV0ID0gYHBhY2thZ2UgPCU9c2NvcGUlPjtcblxuc3ludGF4ID0gInByb3RvMyI7XG5cbmAgKyByZXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KPCV9JT4NCg0KICAgIDwlPW1OYW1lPSdfdG9KU09OJyU+KG9wdGlvbnM9e30sIHNQYXRoKXsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgc1BhdGggPSBzUGF0aCB8fCAiIjsNCiAgICAgICAgICAgIGxldCByZXQgPSB7fTsNCiAgICAgICAgICAgIHJldC5fX2tleXMgPSBbXTsgLy8hIQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighb3B0aW9ucy5iTWFwKXsNCiAgICAgICAgICAgICAgICByZXQuX19nZW5lcmF0ZWQgPSAnIicgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyAnIic7DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLm5hbWUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX190b29sID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fY2xhc3MgPSAnIjwlPW5OYW1lKGMpJT4iJzsNCiAgICAgICAgICAgICAgICAgICAgcmV0Ll9fdHlwZSA9ICciJys8JT1fbkNvZGUoKSU+KyciJzsNCiAgICAgICAgICAgICAgICAgICAgLy9yZXQuX19wYXRoID0gJyInK3NQYXRoKyciJzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoPCU9bnNjb3BlJT4uX25vZGUpew0KICAgICAgICAgICAgICAgICAgICByZXQuX19ub2RlID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogPCU9bnNjb3BlJT4uX25vZGUuY29kZSgpDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbGV0IHRyTWFwID0gKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgPT4gKHYgJiYgdHlwZW9mKHYpPT09J3N0cmluZycgJiYgdi5yZXBsYWNlKT92LnJlcGxhY2UoLzAxOTViNjUzMmUzMDc0NWI4ZWEzOTM5YjYxMmJkNGIyXSs+Pi9nbSwgbSA9PiB7DQogICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3RyTWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwIHx8IFtdOw0KDQogICAgICAgICAgICAgICAgbGV0IHRyaWQgPSB0aGlzLl91dWlkKCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHBQYXRoID0gJy4nKyhzUGF0aC5zcGxpdCgnLicpLnNsaWNlKDEsIC0xKS5qb2luKCcuJykpOw0KICAgICAgICAgICAgICAgIGlmKHBQYXRoPT0iLiIpIHBQYXRoID0gIiI7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHRyID0gbS5yZXBsYWNlKCcwMTk1YjY1MzJlMzA3NDViOGVhMzk4YTZmYmI1ZjFhNScsICcnKS5yZXBsYWNlKC97e25yfX0vZ20sICckbm90KCRleGlzdHMoX19yZXVzZWQpKScpLnJlcGxhY2UoL3t7dmZ9fS9nLCBvYmpbZWFDb2RlXSk7DQogICAgICAgICAgICAgICAgaWYodHIuc3RhcnRzV2l0aCgncygnKSAmJiB0ci5lbmRzV2l0aCgnKScpKXsNCiAgICAgICAgICAgICAgICAgICAgdHIgPSB0ci5yZXBsYWNlKC97e19ffX0vZ20sICdvSlNPTicrc1BhdGgpLnJlcGxhY2UoL3t7cHBhdGh9fS9nbSwgJ29KU09OJytwUGF0aCk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIHRyID0gdHIucmVwbGFjZSgve3tfX319L2dtLCBgKipbSWQ9JHtvYmouSWR9XVswXWApOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIDwlPXdhcm4oKSU+ZWFDb2RlLCB0cmlkLCB0cik7DQoNCiAgICAgICAgICAgICAgICB0ciA9IHRoaXMuX2J0b2EodHIpOw0KICAgICAgICAgICAgICAgIGxldCBtYXAgPSA8JT1zY29wZSU+Ll9fdHJNYXAuZmluZChvID0+IG8udHJhbnNmb3JtPT10cik7DQogICAgICAgICAgICAgICAgcmV0dXJuIChtYXA/bWFwLmlkOjwlPXNjb3BlJT4uX190ck1hcFs8JT1zY29wZSU+Ll9fdHJNYXAucHVzaCh7aWQ6IHRyaWQsIHRyYW5zZm9ybTogdHJ9KS0xXS5pZCk7DQogICAgICAgICAgICB9KTp2Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgICAgIF9tYXA6IG9wdGlvbnMuYk1hcCwNCiAgICAgICAgICAgICAgICBGdWxsOiBvcHRpb25zLmJGdWxsLA0KICAgICAgICAgICAgICAgIE51bGw6IG9wdGlvbnMuYk51bGwsDQogICAgICAgICAgICAgICAgZXhwb3J0ZXI6IHYgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy5yZXVzZWQpPT09J3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZXVzZWQ+PXYucmV1c2VkKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBpZih2ICYmIHYub2JqICYmIHR5cGVvZih2Lm9iai5fcmV0dXJuKT09PSdzdHJpbmcnICYmIHYub2JqLl9yZXR1cm4uaW5kZXhPZignX19yZXVzZWQ6IDEnKT4wKSByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBsZXQgb0hhc2ggPSBvcHRpb25zLmJIYXNoP1t0aGlzLl90b0hhc2gobnVsbCwge25vQ29kZTogdHJ1ZSwgb25seVVuaXF1ZTogdHJ1ZSwgbm9BcmdzOiB0cnVlLCBfbWFwOiBvcHRpb25zLmJNYXAsIG5vVHlwZXM6IGZhbHNlfSwgIjwlPW1OYW1lJT4iKV06T2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrPT0nSWQnIHx8IGsuaW5kZXhPZignX18nKT09MCkubWFwKGsgPT4ge3RyeXtyZXR1cm4geyBba106IEpTT04ucGFyc2UocmV0W2tdKSB9OyB9Y2F0Y2goZXgpe3JldHVybiB7W2tdOiByZXRba119OyB9IH0pOw0KICAgICAgICAgICAgICAgICAgICBsZXQgZVJldCA9IE9iamVjdC5hc3NpZ24oLi4ub0hhc2gsIHtfX3JldXNlZDogdi5yZXVzZWR9ICk7DQogICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkoZVJldC5fX2tleXMpKSBlUmV0Ll9fa2V5cy5mb3JFYWNoKGVrID0+IHt0cnl7IGVSZXRbZWtdID0gSlNPTi5wYXJzZShyZXRbZWtdKTt9Y2F0Y2goZXgpe2VSZXRbZWtdID0gcmV0W2VrXTsgfSB9KTsNCg0KICAgICAgICAgICAgICAgICAgICB2Lm9iaiA9IHtfcmV0dXJuOiBKU09OLnN0cmluZ2lmeShlUmV0KX07DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfVEhJUzogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuYk1hcCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICBvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1gKSk7DQogICAgICAgICAgICAgICAgICAgIG9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9Ow0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSBgIiR7dn0iYCwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IHsNCiAgICAgICAgPCUgaWYoZWEuSXNVbmlxdWUpeyU+DQogICAgICAgICAgICAgICAgICAgIGlmKG9iai5fX2tleXMpIG9iai5fX2tleXMucHVzaChlYUNvZGUpOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLklzVGV4dCl7JT4NCiAgICAgICAgICAgICAgICAgICAgaWYoITwlPV9iNjR0ZXN0KCd2JyklPil7IC8vIGlzIG5vdCBiYXNlNjQ/DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdGhpcy5fYnRvYSh2KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgIHYgPSB2JiZ2LnRvSVNPU3RyaW5nP3YudG9JU09TdHJpbmcoKTp2Ow0KICAgICAgICA8JSB9JT4NCiAgICAgICAgDQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIG9ialtlYUNvZGVdID0gdj92LjwlPW1OYW1lJT4ob3B0aW9ucywgYCR7c1BhdGh9LiR7ZWFDb2RlfWApOidudWxsJzsNCiAgICAgICAgPCUgfWVsc2UgaWYoZWEuSXNCb29sIHx8IGVhLklzSW50IHx8IGVhLklzTG9uZyB8fCBlYS5Jc0Zsb2F0IHx8IGVhLklzRG91YmxlKXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9IHRyTWFwKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgfHwgJ251bGwnOw0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXSA9ICciJyArIHRyTWFwKG9iaiwgZWFDb2RlLCB2LCBzUGF0aCkgKyAnIic7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZpbHRlcih0YSA9PiAhdGEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKHRhID0+IHtsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9ialtlYUNvZGVdID0gJ1snICsgKHYgfHwgW10pLm1hcCgoX3YsIF9pKSA9PiBfdi48JT1tTmFtZSU+KG9wdGlvbnMsIGAke3NQYXRofS4ke2VhQ29kZX1bJHtfaX1dYCkpLmZpbHRlcihfdiA9PiBfdikuam9pbigpICsgJ10nLA0KICAgIDwlIH0pJT4NCiAgICA8JSBjLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IHslPg0KICAgICAgICAgICAgICAgIGVmXzwlPW5OYW1lKGVmKSU+OiAob2JqLCBlZkNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheSh2KSl7DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9IEpTT04uc3RyaW5naWZ5KHYpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0ck1hcChvYmosIGVmQ29kZSwgdiwgc1BhdGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mKHYpPT09J3VuZGVmaW5lZCcpIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgICAgICA8JSBpZihlZil7JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCE8JT1fYjY0dGVzdCgndicpJT4peyAvLyBpcyBub3QgYmFzZTY0Pw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0aGlzLl9idG9hKHYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZSBpZihlZi5Jc0RhdGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICB2ID0gdiYmdi50b0lTT1N0cmluZz92LnRvSVNPU3RyaW5nKCk6djsNCiAgICAgICAgPCUgfSU+DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtlZkNvZGVdID0gdjsNCiAgICAgICAgPCUgaWYoIWVmLklzQm9vbCAmJiAhZWYuSXNJbnQgJiYgIWVmLklzTG9uZyAmJiAhZWYuSXNGbG9hdCAmJiAhZWYuSXNEb3VibGUpeyU+DQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbZWZDb2RlXSA9ICciJyArIG9ialtlZkNvZGVdICsgJyInOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KDQogICAgICAgICAgICAgICAgX190ck1hcDogb2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIXNQYXRoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5fX3RyTWFwID0gPCU9c2NvcGUlPi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIDwlPXNjb3BlJT4uX190ck1hcDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICAgICBfcmV0dXJuOiBvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZihvYmopIG9iai5fcmV0dXJuID0gKE9iamVjdC5rZXlzKG9ianx8e30pLmxlbmd0aCk/KCd7JyArIE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSk9PT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtvYmpba119YCkuY29uY2F0KE9iamVjdC5rZXlzKG9iaikuZmlsdGVyKGsgPT4gdHlwZW9mKG9ialtrXSkhPT0ic3RyaW5nIikubWFwKGsgPT4gYCIke2t9IjogJHtKU09OLnN0cmluZ2lmeShvYmpba10pfWApKS5qb2luKCkgKyAnfScpOidudWxsJzsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iLCBvcHRpb25zLCBzUGF0aCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldCA9IHJldD9yZXQuX3JldHVybjpyZXQ7DQogICAgICAgICAgICByZXQgPSB0eXBlb2YocmV0KT09PSd1bmRlZmluZWQnP251bGw6cmV0Ow0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZighc1BhdGggJiYgcmV0KXsNCiAgICAgICAgICAgICAgICByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsICdqYXZhc2NyaXB0Jyk7DQogICAgICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5wYXJzZSkgcmV0dXJuIEpTT04ucGFyc2UocmV0KTsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmd6aXApIHJldHVybiB0aGlzLlV0ZjhBcnJheVRvU3RyKHRoaXMuX2NvbXByZXNzKHJldCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J190b0RvY3VtZW50JyU+KG9wdGlvbnM9e30pew0KICAgICAgICB0cnl7DQogICAgICAgICAgICBsZXQganNvbiA9IHRoaXMuX3RvSlNPTihvcHRpb25zKTsNCiAgICAgICAgICAgIGxldCBvSlNPTiA9IEpTT04ucGFyc2UoanNvbik7DQogICAgICAgICAgICBsZXQgdHJNYXAgPSBvSlNPTi5fX3RyTWFwIHx8IFtdOw0KICAgICAgICAgICAgZGVsZXRlIG9KU09OLl9fdHJNYXA7DQogICAgICAgICAgICBqc29uID0gSlNPTi5zdHJpbmdpZnkob0pTT04pOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgbG9nID0gKC4uLnMpID0+IDwlPWxvZygpJT4uLi5zKTsNCiAgICAgICAgICAgIGxldCB3YXJuID0gKC4uLnMpID0+IDwlPXdhcm4oKSU+Li4ucyk7DQogICAgICAgICAgICBsZXQgZXJyb3IgPSAoLi4ucykgPT4gPCU9ZXJyb3IoKSU+Li4ucyk7DQoNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgdCBvZiB0ck1hcCl7DQogICAgICAgICAgICAgICAgaWYoIW5ldyBSZWdFeHAodC5pZCkudGVzdChqc29uKSkgY29udGludWU7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGV0IHRybiA9IHRoaXMuX2F0b2IodC50cmFuc2Zvcm0pOw0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgb0pTT04gPSBKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICAgICAgICAgICAgICBsZXQgcmVzID0gdW5kZWZpbmVkOw0KICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgaWYodHJuLnN0YXJ0c1dpdGgoInMoIikgJiYgdHJuLmVuZHNXaXRoKCIpIikpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdGhpcy5ydW5TY3JpcHQoYChvSlNPTiwgb1Njb3BlLCBsb2csIHdhcm4sIGVycm9yKSA9PiAke3Rybi5zdWJzdHJpbmcoMiwgdHJuLmxlbmd0aC0xKX1gKShvSlNPTiwgPCU9c2NvcGUlPiwgbG9nLCB3YXJuLCBlcnJvcik7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXMgPSBhd2FpdCBqc29uYXRhKHRybikuZXZhbHVhdGUob0pTT04pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICAvLzwlPXdhcm4oKSU+dC5pZCwgcmVzLCB0cm4pOw0KICAgICAgICAgICAgICAgICAgICBqc29uID0ganNvbi5yZXBsYWNlKG5ldyBSZWdFeHAodC5pZCwgImciKSwgKCFBcnJheS5pc0FycmF5KHJlcykgJiYgdHlwZW9mKHJlcykhPT0nb2JqZWN0Jyk/cmVzOnRoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkocmVzKSkpOw0KICAgICAgICAgICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+dC5pZCwgdHJuLCBleCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBqc29uID0ganNvbi5yZXBsYWNlKC8iX190ck1hcCI6XHNcW1x7W14+Pl0rXH1cXS9nbSwgJyJfX3RyTWFwIjogIiInKTsNCg0KICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYkpTT04/dGhpcy5fYmVhdXRpZnkoanNvbiwgJ2phdmFzY3JpcHQnKTpKU09OLnBhcnNlKGpzb24pOw0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQo8JQ0KX2Nsb25lRnVuY3Rpb24gPSAobywgZiwgc2NvcGUsIGMpID0+IHsNCg0KICAgIGxldCBvYmogPSBudWxsOw0KICAgIGlmKG89PSdzcicgJiYgdHlwZW9mKHNyKSE9PSd1bmRlZmluZWQnKSBvYmogPSBzcjsNCiAgICBpZihvPT0nX0ZyRU1EJyAmJiB0eXBlb2YoX0ZyRU1EKSE9PSd1bmRlZmluZWQnKSBvYmogPSBfRnJFTUQ7DQogICAgDQogICAgbGV0IGNvZGUgPSBvYmpbZl0gPyBvYmpbZl0udG9TdHJpbmcoKSA6IGAgICAke2Z9KCl7DQogICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiBfY2xvbmVGdW5jdGlvbigke299LCAke2Z9KTogSW52YWxpZCBGdW5jdGlvbiBOYW1lJyk7DQogICAgfWA7DQogICAgbGV0IHMgPSBjb2RlLnJlcGxhY2UoJyknLCAnKSA9PiAnKTsNCiAgICBpZiAocy5pbmRleE9mKCdmdW5jdGlvbicpID09IDAgfHwgcy5pbmRleE9mKCdhc3luYyBmdW5jdGlvbicpID09IDApIHsNCiAgICAJcyA9IHMucmVwbGFjZSgnZnVuY3Rpb24nLCAnICcpOw0KICAgIH0gZWxzZSB7DQogICAgCXMgPSBzLnJlcGxhY2UoZiwgJycpOw0KICAgIH0NCg0KICAgIGlmIChjLklzTWFpbiAmJiAhb2JqW2ZdKSB7DQogICAgCWNvbnNvbGUubG9nKCdFcnJvciBpbiBfY2xvbmVGdW5jdGlvbigpOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUgJyArIGYpOw0KICAgIH0NCg0KICAgIHJldHVybiBgDQogICAgJHtmfSguLi5wYXJhbXMpew0KICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuJHtvfSkhPT0idW5kZWZpbmVkIil7DQogICAgICAgICAgICByZXR1cm4gd2luZG93LiR7b30uJHtmfSguLi5wYXJhbXMpOw0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGAgKyAoYy5Jc01haW4gPyBgcmV0dXJuICgke3N9KSguLi5wYXJhbXMpO2AgOiBgcmV0dXJuIG5ldyAke3Njb3BlfS4ke25OYW1lKG1haW5DbGFzcygpKX0oKS4ke2Z9KC4uLnBhcmFtcyk7YCkgKyBgDQogICAgICAgIH0NCgl9DQogICAgYDsNCn07DQoNCg0KW3sNCiAgICB3T2JqOiAnc3InLA0KICAgIGZ1bmN0aW9uczogWydoYXNoQ29kZScsICdFcXVhbHMnLCAnc2VydmVyRGF0ZScsICdfX3Njb3BlJywgJ2FkZE1TZWNvbmRzJywgJ2lwQWRkcmVzcyddLmNvbmNhdChtYWluQ2xhc3MoWydCSVNlcnZlciddKT9bJ18nLCAnYnVpbGRVUkwnLCAnJF9SRVFVRVNUJywgJ3BhcmFtJywgJ190b1hNTCcsICdjb29wJywgJ09SJywgJ215UmVwbGFjZScsICdzZW5kWE1MJywgJ3Byb2Nlc3NSZXNwb25zZScsICdwcm9jZXNzUmVzdWx0JywgJ3J1blNSU2NyaXB0JywgJ2dyb3VwQnknLCAnU2hvd0RlYnVnJywgJ2NhY2hlUmVzdWx0JywgJ3RvSGV4JywgJ1Nob3dFcnJvciddOltdKSwNCn0sIHsNCiAgICB3T2JqOiAnX0ZyRU1EJywNCiAgICBmdW5jdGlvbnM6IFsnX2F0dHInLCAncnVuU2NyaXB0JywgJ191bmlxdWUnLCAnc3InLCAnX2F0b2InLCAnX2dldFN0b3JlZFNjcmlwdCcsICdfYnRvYScsICdfX3RpbWUnLCAnX3dhaXQnLCAnX3NxbFR5cGUnLCAnX3V1aWQnLCAncmVxdWlyZScsICdfaW5jbHVkZScsICdfYmVhdXRpZnknLCAnX2luamVjdCcsICdfY29tcHJlc3MnLCAnX2RlY29tcHJlc3MnLCAnVXRmOEFycmF5VG9TdHInLCAncmFuZFVSTCddLA0KfV0uZm9yRWFjaChjYyA9PiB7ICU+DQovKiBTVEFSVDogPCU9Y2Mud09iaiU+IGZ1bmN0aW9uIGNvcGllcyAqLw0KPCUgY2MuZnVuY3Rpb25zLmZvckVhY2goZiA9PiB7JT4NCg0KLyogQ0xPTkU6OlNUQVJUOiA8JT1jYy53T2JqJT4uPCU9ZiU+KCkgKi88JT1fY2xvbmVGdW5jdGlvbihjYy53T2JqLCBmLCBzY29wZSwgYykgJT4vKiBDTE9ORTo6RU5EICA6IDwlPWNjLndPYmolPi48JT1mJT4oKSAqLw0KPCUgfSklPg0KLyogRU5EOiA8JT1jYy53T2JqJT4gZnVuY3Rpb24gY29waWVzICovDQo8JSB9KTsgJT4NCiAgICANCiAgICA8JT1tTmFtZT0naTE4biclPihldiwgdil7DQogICAgICAgIGlmKHR5cGVvZih3aW5kb3cpPT09InVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKT09PSJ1bmRlZmluZWQiKSByZXR1cm4gdjsNCiAgICAgICAgDQogICAgICAgIGlmKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpew0KICAgICAgICAgICAgcmV0dXJuIHY7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsNCiAgICAgICAgfQ0KICAgIH0NCg0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUpLmZvckVhY2goZWEgPT4geyU+DQogICAgPCU9bU5hbWU9J2J5JyArIG5OYW1lKGVhLkVudGl0eVR5cGUpJT4oYXIpIHsNCiAgICAgICAgdmFyIHJldCA9IFtdOw0KICAgICAgICBhci5mb3JFYWNoKGEgPT4gew0KICAgICAgICAgICAgcmV0LmZvckVhY2gociA9PiB7DQogICAgICAgICAgICAgICAgaWYgKGFbIl88JT1uTmFtZShlYSklPiJdICYmIChhWyJfPCU9bk5hbWUoZWEpJT4iXS5FcXVhbHM/YVsiXzwlPW5OYW1lKGVhKSU+Il0uRXF1YWxzKHIpOnNyLkVxdWFscyhhWyJfPCU9bk5hbWUoZWEpJT4iXSwgcikpKSB7DQogICAgICAgICAgICAgICAgICAgIHIuXzwlPW5OYW1lKGVhKSU+XzwlPWMuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKSU+LnB1c2goYSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0pJT4NCg0KICAgIDwlPW1OYW1lPSdnZXQgX1RvU3RyaW5nJyU+KCkgew0KICAgICAgICByZXR1cm4gdGhpcy50b1N0cmluZygpOw0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0ndG9TdHJpbmcnJT4oKSB7DQogICAgICAgIGxldCByZXQgPSBbXTsNCjwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5Jc1VuaXF1ZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0ICYmIDwldmFsdWVPZihlYS5Jc1VuaXF1ZSklPikgcmV0LnB1c2godGhpcy48JT1uTmFtZShlYSklPigpPCVpZihlYS5FbnRpdHlUeXBlKXslPi48JT1tTmFtZSU+KCk8JX0lPik7DQo8JSB9KSU+DQogICAgICAgIHJldHVybiByZXQuam9pbignLScpOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdFbnRpdHlWYWx1ZSclPihhTmFtZSkgew0KICAgICAgICBsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsNCiAgICAgICAgDQogICAgICAgIGlmKCFyZXQpew0KICAgICAgICAgICAgLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUNCiAgICAgICAgICAgIHJldCA9IHtBY3RpdmU6IHRydWUsIE9QRVJBVE9SUzoge30sIEVudGl0eUF0dHJpYnV0ZToge05hbWU6IGFOYW1lLCBBY3RpdmU6IHRydWUsIEVudGl0eUNsYXNzOiB7SWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWR9fX07DQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXQ7DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J2ZpbmQnJT4oZGVwdGggPSAxLCBvYmpzLCBmaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgsIG9ianMsIG51bGwsIG51bGwsIGZpZWxkcykpWzBdOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfX2Fzc2VydFZhbGlkJyU+KGJTeW5jKXsNCjwlIGlmKCFjLlRvb2xzLmxlbmd0aCl7JT4NCiAgICAgICAgcmV0dXJuIHRydWU7DQo8JSB9ZWxzZXslPg0KICAgICAgICBsZXQgZXJyb3IgPSB7fTsNCg0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5SZXF1aXJlZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLlJlcXVpcmVkKSU+KXsNCiAgICAgICAgICAgIGVycm9yLjwlPW5OYW1lKGVhKSU+ID0ge307DQogICAgICAgICAgICBpZighdGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KSBlcnJvci48JT1uTmFtZShlYSklPlsiMDEiXSA9ICJOb3QgU2V0IjsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKCF0aGlzLjwlPW5OYW1lKGVhKSU+KCkpIGVycm9yLjwlPW5OYW1lKGVhKSU+WyIwMiJdID0gIkVtcHR5IFZhbHVlIjsNCiAgICAgICAgICAgIGlmKHRoaXMuPCU9bk5hbWUoZWEpJT4oKSAmJiBiU3luYyAmJiAhdGhpcy48JT1uTmFtZShlYSklPigpLl9fc3luY19vbigpKSBlcnJvci48JT1uTmFtZShlYSklPlsiMDMiXSA9ICJOb3QgaW4gU3luYyI7DQogICAgICAgIDwlIH0lPg0KICAgICAgICAgICAgaWYoIU9iamVjdC5rZXlzKGVycm9yLjwlPW5OYW1lKGVhKSU+KS5sZW5ndGgpIGRlbGV0ZSBlcnJvci48JT1uTmFtZShlYSklPjsNCiAgICAgICAgfQ0KICAgIDwlIH0pJT4NCg0KICAgICAgICBpZihPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKXsNCiAgICAgICAgICAgIHRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOw0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+SlNPTi5zdHJpbmdpZnkoZXJyb3IsbnVsbCw0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfcmFuayclPihfPCU9bU5hbWUlPj0wKXsNCgkJdHJ5IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9fZXhwb3J0KHtfPCU9bU5hbWUlPjogXzwlPW1OYW1lJT59LCB7DQogICAgICAgICAgICAgICAgTnVsbDogdHJ1ZSwNCiAgICAgICAgICAgICAgICBleHBvcnRlcjogdiA9PiB2LnJldXNlZD92Lm9iai5fX3JldXNlZCA9IHYucmV1c2VkOjAsDQogICAgICAgICAgICAgICAgSWQ6IChvYmosIGlkQ29kZSwgdikgPT4gb2JqW2lkQ29kZV0gPSAiPCU9X2NOYW1lKGMsIHRydWUpJT4iLA0KCTwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCAmJiBlYS5FbnRpdHlUeXBlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgICAgIDwlPW5OYW1lKGVhKSU+OiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5fPCU9bU5hbWUlPiArPSAob2JqW2VhQ29kZV0gPSAodiB8fCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoZWEuRW50aXR5VHlwZSwgdHJ1ZSklPigpKS48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKS5fPCU9bU5hbWUlPiwNCgk8JSB9KSU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZmlsdGVyKHRhID0+ICF0YS5FbnRpdHlNZXRob2QpLmZvckVhY2godGEgPT4ge2xldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIHRhQ29kZSwgdikgPT4gKG9ialt0YUNvZGVdID0gW25ldyA8JT1zY29wZSU+LjwlPV9jTmFtZSh0YS5FbnRpdHlUeXBlLCB0cnVlKSU+KCldLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KF88JT1tTmFtZSU+KzEpKSkuZm9yRWFjaCh2ID0+IHYuXzwlPW1OYW1lJT4pLA0KICAgIDwlIH0pJT4NCgkgICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoJCX0gY2F0Y2ggKGV4KSB7DQoJCQk8JT1lcnJvcigpJT5leCk7DQoJCX0NCgl9DQoNCiAgICA8JT1tTmFtZT0nX2lzUXVlcnknJT4oKXsNCiAgICAgICAgbGV0IHJldCA9IHRoaXMuX19leHBvcnQoLypfX3R5cGUqL3tJZDogIjwlPW5OYW1lKGMpJT4iLCA8JT1tTmFtZSU+Q291bnQ6IDB9LCB7DQogICAgICAgICAgICBOdWxsOiB0cnVlLA0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICA8JT1uTmFtZShlYSklPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgb2JqW2VhQ29kZV0gPSB7X2Nvb3A6IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3AgfHwgdW5kZWZpbmVkfTsNCiAgICAgICAgICAgICAgICBvYmouPCU9bU5hbWUlPkNvdW50ICs9IHR5cGVvZihvYmpbZWFDb2RlXS5fY29vcCk9PT0idW5kZWZpbmVkIj8wOjE7DQogICAgICAgICAgICAgICAgaWYodiAmJiB2LjwlPW1OYW1lJT4pew0KICAgICAgICAgICAgICAgICAgICBvYmpbZWFDb2RlXS5fb2JqZWN0ID0gdi48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIG9iai48JT1tTmFtZSU+Q291bnQgKz0gb2JqW2VhQ29kZV0uX29iamVjdC48JT1tTmFtZSU+Q291bnQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KTsgJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7bGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAob2JqLCB0YUNvZGUsIHYpID0+IHsNCiAgICAgICAgICAgICAgICBvYmpbdGFDb2RlXSA9IHtfY29vcDogdGhpcy5fPCU9dGFOYW1lJT5fY29vcCB8fCB1bmRlZmluZWQsIF9vYmplY3RzOiAodnx8W10pLm1hcChfdiA9PiBfdi48JT1tTmFtZSU+KCkpfTsNCiAgICAgICAgICAgICAgICBpZihvYmpbdGFDb2RlXS5fb2JqZWN0cy5sZW5ndGgpIG9ialt0YUNvZGVdLjwlPW1OYW1lJT5Db3VudCArPSBvYmpbdGFDb2RlXS5fb2JqZWN0cy5yZWR1Y2UoKHYsIG8pID0+IHYgKz0gby48JT1tTmFtZSU+Q291bnQpOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX25ldyclPihjbE5hbWUsIHRvb2wpew0KPCUgaWYobWFpbkNsYXNzKCkhPWMpeyU+DQogICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUobWFpbkNsYXNzKCksIHRydWUpJT4oKS48JT1tTmFtZSU+KGNsTmFtZSwgdG9vbCk7DQo8JSB9ZWxzZXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBzd2l0Y2goY2xOYW1lKXsNCiAgICA8JSBhckNsYXNzZXMuZm9yRWFjaChfYyA9PiB7JT4NCiAgICAgICAgICAgICAgICBjYXNlICI8JT1uTmFtZShfYyklPiI6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUoX2MsIHRydWUpJT4odW5kZWZpbmVkLCB0b29sKTsNCiAgICA8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCjwlIH0lPg0KICAgIH0NCiAgICANCiAgICBhc3luYyA8JT1tTmFtZT0nc3RvcmUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAvKioqIFNUQVJUIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgICAgICANCiAgICAgICAgbGV0IGJVcGRhdGUgPSBmYWxzZTsNCiAgICAgICAgbGV0IGJJbnNlcnQgPSBmYWxzZTsNCg0KICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKXsNCiAgICAgICAgICAgIDwlPXdhcm4oKSU+InN0b3JpbmcgZGlzYWJsZWQiKTsNCiAgICAgICAgfWVsc2UgaWYodGhpcy5faXNRdWVyeSgpLl9pc1F1ZXJ5Q291bnQpew0KICAgICAgICAgICAgPCU9d2FybigpJT4iQ2Fubm90IHN0b3JlIGEgcXVlcnkhIik7DQogICAgICAgIH1lbHNlIGlmKCF0aGlzLl9fc3luY19vbigpIHx8IDwlPV9GckVNRC5fdG9KUyhfZmlsZVRvb2xzKSU+LmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSk+PTApew0KICAgICAgICAgICAgbGV0IF90aGlzID0gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgYkZpbmQgPSBmYWxzZTsNCiAgICAgICAgICAgIGlmKHRoaXMuSWQ9PXRoaXMuSWQpew0KICAgICAgICAgICAgICAgIGJGaW5kID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBfdGhpcy5JZCA9IHRoaXMuSWQ7DQogICAgICAgICAgICB9DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzVW5pcXVlKS5mb3JFYWNoKGVhID0+IHslPg0KICAgICAgICAgICAgaWYoPCV2YWx1ZU9mKGVhLklzVW5pcXVlKSU+KXsNCiAgICAgICAgICAgICAgICBiRmluZCA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuPCU9bk5hbWUoZWEpJT4odGhpcy48JT1uTmFtZShlYSklPigpLCAnPScpOw0KICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQoNCiAgICAgICAgICAgIGlmKGJGaW5kKXsNCiAgICAgICAgICAgICAgICBfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsNCiAgICAgICAgICAgIH1lbHNlIF90aGlzID0gbnVsbDsNCiAgICAgICAgICAgIGlmKF90aGlzKXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gX3RoaXMuSWQ7DQogICAgICAgICAgICAgICAgdGhpcy5fX3N5bmNfb24oX3RoaXMuX19zeW5jX29uKCkpOw0KICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7DQogICAgICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUNCiAgICAgICAgICAgICAgICBiSW5zZXJ0ID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfWVsc2UgaWYoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSl7DQogICAgICAgICAgICA8JT1sb2coKSU+IkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsiPCIrdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgYlVwZGF0ZSA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICBpZighYlVwZGF0ZSAmJiAhYkluc2VydCl7DQogICAgICAgICAgICA8JT1sb2coKSU+Ik5vIGRhdGEgY2hhbmdlcyIpOw0KICAgICAgICB9ZWxzZXsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICA8JSBpZih0PT0iU3FsREIiKXsgJT4NCiAgICAgICAgICAgICAgICBpZih0eXBlb2YoPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uKT09PSJ1bmRlZmluZWQiIHx8IDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQpew0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7DQogICAgICAgICAgICAgICAgICAgIDwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbiA9IHtPd25lcjogdGhpcywgc3FsczogW10sIHN0YXJ0OiBuZXcgRGF0ZSgpLCBlbmQ6IG51bGx9Ow0KICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICAgICAgdGhpcy5fZGVmYXVsdHMoKTsNCg0KICAgICAgICAgICAgaWYodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSl7DQo8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLjwlPW5OYW1lKGVhKSU+KCkgJiYgIShhd2FpdCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuPCU9bU5hbWUlPigpKSkgdGhpcy5jbGVhcl88JT1uTmFtZShlYSklPigpOw0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgICAgICA8JT1sb2coKSU+YD09PT4gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsNCiAgICAgICAgICAgIGlmKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7DQogICAgICAgICAgICBpZihiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmA8PT09IEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSl7DQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICAgICAgICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuPCU9dGFOYW1lJT4oKSl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iU3luY2luZy4uLjwlPXRhTmFtZSU+IiwgdGEpOw0KICAgICAgICAgICAgICAgICAgICBhd2FpdCB0YS48JT1tTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgfQ0KPCUgfSk7ICU+DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGJVcGRhdGUgfHwgYkluc2VydCl7DQo8JSBjbHNUb29scyhjKS5mb3JFYWNoKHQgPT4geyU+DQogICAgICAgICAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KICAgIDwlIGlmKHQ9PSJTcWxEQiIpeyAlPg0KICAgICAgICAgICAgICAgICAgICBpZig8JT1zY29wZSU+Ll9fc3FsVHJhbnNhY3Rpb24gJiYgITwlPXNjb3BlJT4uX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLk93bmVyPT10aGlzKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOw0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9c2NvcGUlPi5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfSwge19fYmVmb3JlUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkJlZm9yZSkubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dLCBfX2FmdGVyUnVsZXM6IFs8JShjLkVudGl0eVJ1bGVzIHx8IFtdKS5maWx0ZXIociA9PiByW21OYW1lXSAmJiByLkFmdGVyKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl19KTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHtyZXQ6IG51bGx9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCg0KICAgIGFzeW5jIDwlPW1OYW1lPSdpbnNlcnQnJT4oKXsNCiAgICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKG51bGwsIDwlPWFsaWFzKCklPiwgIjwlPW1OYW1lJT4iLCA8JW1Sb3V0aW5nKGMpJT4sIGFzeW5jICgpID0+IHsNCiAgICAgICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiIHx8IHQ9PSJaYW5nb0RCIil7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLlRvb2wuZGIuZ2V0Q29sbGVjdGlvbig8JT1fbkNvZGUoYyklPikuaW5zZXJ0T25lKHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KSk7DQogICAgICAgICAgICB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goYGRiLmdldENvbGxlY3Rpb24oJyR7PCU9X25Db2RlKCklPn0nKS5pbnNlcnRPbmUoJHt0aGlzLl90b0pTT04oe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlJ4REIiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuVG9vbC5kYls8JT1fbkNvZGUoYyklPl0uPCU9bU5hbWUlPih0aGlzLl90b0RvY3VtZW50KHtiTWFwOiB0cnVlfSkpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJLYWZrYSIpIHslPg0KICAgICAgICAgICAgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJyk7DQogICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLnByb2R1Y2VyLnNlbmQoew0KICAgICAgICAgICAgICAgIHRvcGljOiAnPCU9c2NvcGUlPi5jYWxsJywNCiAgICAgICAgICAgICAgICBtZXNzYWdlczogW3sNCiAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLklkLA0KICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZX0pDQogICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPidjYWxsOiAnICsgdGhpcy5fX3RpbWUoJzwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPi48JT1tTmFtZSU+LmthZmthJykpOw0KICAgICAgICAgICAgPCU9bG9nKCklPidyZXNwb25zZTogJywgcmV0KTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5wdXNoKHRoaXMpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJOZW80aiIpIHslPg0KICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX25lbzRqKHRoaXMuX3RvQ3lNZXJnZSgpKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiU2FsZXNGb3JjZSIpIHslPg0KICAgICAgICAgICAgbGV0IG9iaiA9IHt9Ow0KICAgICAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+LklkOw0KICAgICAgICAgICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgIG9iai48JT1uTmFtZShlYSklPiA9IHRoaXMuPCU9bk5hbWUoZWEpJT4oKTsNCiAgICAgICAgICAgICAgICA8JSB9ICU+DQogICAgICAgICAgICB9DQogICAgICAgICAgICA8JSB9KTsgJT4NCiAgICANCiAgICAgICAgICAgIGxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7DQogICAgDQogICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIjwlPW5OYW1lKGMpJT4iKS5jcmVhdGUob2JqKTsNCiAgICAgICAgICAgIHRoaXMuSWQgPSByZXMuaWQ7DQogICAgPCUgfSBlbHNlIGlmKF9zcWxUb29scy5pbmRleE9mKHQpPj0wKSB7JT4NCiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7DQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIlNlcnZpY2VOb3ciKSB7JT4NCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIGF3YWl0IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWUsIHJldXNlZDogMX0pKSk7DQogICAgPCUgfSBlbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIHRoaXMuSWQgPSAoYXdhaXQgdGhpcy5fdG9FTVNPYmplY3QoKS5zdG9yZSgpKS5JZDsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUmVzdERCSU8iKSB7JT4NCiAgICAgICAgICAgIGxldCBvYmogPSB7fTsNCiAgICAgICAgICAgIDwlICQuZWFjaChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLCAoXywgZWEpID0+IHslPg0KICAgICAgICAgICAgaWYodGhpcy5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICA8JSBpZihlYS5FbnRpdHlUeXBlKXsgJT4NCiAgICAgICAgICAgICAgICBvYmouPCU9bkNvZGUoZWEpJT4gPSB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQvKl9pZCgpKi87DQogICAgICAgICAgICAgICAgPCUgfWVsc2V7ICU+DQogICAgICAgICAgICAgICAgb2JqLjwlPW5Db2RlKGVhKSU+ID0gdGhpcy48JT1uTmFtZShlYSklPigpOw0KICAgICAgICAgICAgICAgIDwlIH0gJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH0pOyAlPg0KICAgIA0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgbG9nKCI8JT10JT4gVVJMIiwgdXJsKTsNCiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgIA0KICAgICAgICAgICAgbG9nKCJyZXN1bHQiLCByZXMuZGF0YSk7DQogICAgICAgICAgICB0aGlzLl9mcm9tRG9jdW1lbnQocmVzLmRhdGEpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJCSVNlcnZlciIpIHslPg0KICAgICAgICAgICAgLy8gd2UgbmVlZCBkZXB0aCAyIHRvIGdldCB0aGUgRW50aXR5VmFsdWVzIGJvdW5kIHRvIHRoZSBvbmVzIHdlIHNlbnQNCiAgICAgICAgICAgIGxldCBpbnNPYmogPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5T2JqZWN0SW5zZXJ0IiwgbnVsbCwgdGhpcy50b0VudGl0eU9iamVjdCgpLCBudWxsLCAyKTsNCiAgICAgICAgICAgIGlmKCFpbnNPYmopIHJldHVybiBudWxsOw0KICAgICAgICAgICAgdGhpcy5JZCA9IGluc09iai5JZDsNCiAgICAgICAgICAgIHRoaXMuRW50aXR5VmFsdWVzID0gaW5zT2JqLkVudGl0eVZhbHVlczsNCiAgICAgICAgICAgIHRoaXMuX3JldmVydCgpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgPCUgfSAlPg0KICAgICAgICB9DQo8JSB9KSAlPg0KDQogICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSd1cGRhdGUnJT4oKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgIC8qKiogU1RBUlQgTE9DQUwgPCU9bU5hbWUlPigpICoqKi8NCg0KICAgICAgICBsZXQgcmV0ID0gbnVsbDsNCjwlIGNsc1Rvb2xzKGMpLmZvckVhY2godCA9PiB7JT4NCiAgICAgICAgaWYodGhpcy5Ub29sLnR5cGUubmFtZT09IjwlPXQlPiIpew0KDQogICAgPCUgaWYodCA9PSAiTW9uZ29EQiIpIHslPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLnVwZGF0ZU9uZSh7X2lkOiB0aGlzLklkfSwgeyRzZXQ6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pOw0KICAgICAgICAgICAgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKGBkYi5nZXRDb2xsZWN0aW9uKCckezwlPV9uQ29kZSgpJT59JykudXBkYXRlT25lKHtfaWQ6ICcke3JldC5faWR9J30sIHskc2V0OiAke3RoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KX0pYCk7DQogICAgPCUgfWVsc2UgaWYodCA9PSAiTWVtb3J5IikgeyU+DQogICAgICAgICAgICB0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPlt0aGlzLlRvb2wuZGIuPCU9bk5hbWUoYyklPi5maW5kSW5kZXgobyA9PiBvLklkPT10aGlzLklkKV0gPSB0aGlzOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkthZmthIikgeyU+DQogICAgICAgICAgICB0aGlzLl9fdGltZSgnPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+LjwlPW1OYW1lJT4ua2Fma2EnKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuVG9vbC5wcm9kdWNlci5zZW5kKHsNCiAgICAgICAgICAgICAgICB0b3BpYzogJzwlPXNjb3BlJT4uY2FsbCcsDQogICAgICAgICAgICAgICAgbWVzc2FnZXM6IFt7DQogICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy5JZCwNCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KQ0KICAgICAgICAgICAgICAgIH1dDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4nY2FsbDogJyArIHRoaXMuX190aW1lKCc8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4uPCU9bU5hbWUlPi5rYWZrYScpKTsNCiAgICAgICAgICAgIDwlPWxvZygpJT4ncmVzcG9uc2U6ICcsIHJldCk7DQogICAgPCUgfSBlbHNlIGlmKHQgPT0gIk5lbzRqIikgeyU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5TWVyZ2UoKSk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOw0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOw0KICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07DQogICAgPCUgfWVsc2UgaWYodCA9PSAiU2VydmljZU5vdyIpIHslPg0KICAgICAgICAgICAgcmV0ID0gKGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgYXdhaXQgdGhpcy5fdG9Eb2N1bWVudCh7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksICdwdXQnKSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPih0aGlzLl90b0ZpbGVOYW1lKCksIHRoaXMuX3RvSlNPTih7Yk1hcDogdHJ1ZSwgcmV1c2VkOiAxfSksIHRoaXMuSWQpOw0KICAgIDwlIH0gZWxzZSBpZih0ID09ICJFTVMiKSB7JT4NCiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RvRU1TT2JqZWN0KCkuc3RvcmUoKTsNCiAgICA8JSB9ZWxzZSBpZih0ID09ICJSZXN0REJJTyIpIHslPg0KICAgICAgICAgICAgPCU9bG9nKCklPiJTZW5kaW5nIHVwZGF0ZSB0byBSRVNUREJJTyB0byBzYXZlIik7DQoNCiAgICAgICAgICAgIGxldCB1cmwgPSAiaHR0cHM6Ly8iICsgdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnKSArICIucmVzdGRiLmlvL3Jlc3QvIiArIDwlPV9uQ29kZSgpJT4udG9Mb3dlckNhc2UoKSArICIvIiArIHRoaXMuSWQ7DQogICAgICAgICAgICAvLyA8JT1sb2coKSU+IlVwZGF0ZSB0byBSRVNUREJJTyIsIHVybCk7DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgYXhpb3MucHV0KHVybCwgb2JqLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgICAgICAiY29udGVudC10eXBlIjogImFwcGxpY2F0aW9uL2pzb24iLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQgPT0gIkJJU2VydmVyIikgeyU+DQogICAgICAgICAgICAvLyB3ZSBuZWVkIGRlcHRoIDIgdG8gZ2V0IHRoZSBFbnRpdHlWYWx1ZXMgYm91bmQgdG8gdGhlIG9uZXMgd2Ugc2VudA0KICAgICAgICAgICAgbGV0IHVwZE9iaiA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlPYmplY3RVcGRhdGUiLCBudWxsLCB0aGlzLnRvRW50aXR5T2JqZWN0KCksIDIpOw0KICAgICAgICAgICAgaWYoIXVwZE9iaikgcmV0dXJuIG51bGw7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb3B5RnJvbSh1cGRPYmopOw0KICAgIDwlIH0gJT4NCiAgICAgICAgfQ0KPCUgfSklPg0KDQogICAgICAgICAgICA8JT1sb2coKSU+InJlc3VsdCIsIHJldCk7DQogICAgICAgICAgICB0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsNCiAgICAgICAgICAgIHRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOw0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KDQogICAgICAgICAgICAvKioqIEVORCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICB9LCB7X19iZWZvcmVSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQmVmb3JlKS5tYXAociA9PiB7JT48JT1fRnJFTUQuX3RvSlMociklPjwlIH0pLmpvaW4oJywgJyklPl0sIF9fYWZ0ZXJSdWxlczogWzwlKGMuRW50aXR5UnVsZXMgfHwgW10pLmZpbHRlcihyID0+IHJbbU5hbWVdICYmIHIuQWZ0ZXIpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XX0pOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogbnVsbH0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5DQogICAgfQ0KICAgIA0KICAgIGFzeW5jIDwlPW1OYW1lPSdmaW5kQWxsJyU+KGRlcHRoID0gMSwgb2Jqcz1bXSwgc3RhcnQsIGVuZCwgZmllbGRzKSB7DQogICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShudWxsLCA8JT1hbGlhcygpJT4sICI8JT1tTmFtZSU+IiwgPCVtUm91dGluZyhjKSU+LCBhc3luYyAoKSA9PiB7DQogICAgICAgICAgICAgICAgLyoqKiBTVEFSVCBMT0NBTCA8JT1tTmFtZSU+KCkgKioqLw0KICAgICAgICANCiAgICAgICAgbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkNCg0KPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICBpZih0aGlzLlRvb2wudHlwZS5uYW1lPT0iPCU9dCU+Iil7DQogICAgPCUgaWYodD09Ik1vbmdvREIiKXsgJT4NCiAgICAgICAgICAgIGlmKHRoaXMuVG9vbC5kYikgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmRiLmNvbGxlY3Rpb24oPCU9X25Db2RlKGMpJT4pLmZpbmQodGhpcy5fdG9TZWxlY3RNb25nb0RCKGZpZWxkcywgb2JqcykpLnRvQXJyYXkoKTsNCiAgICA8JSB9IGVsc2UgaWYodCA9PSAiUnhEQiIpIHslPg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5Ub29sLmRiWzwlPV9uQ29kZShjKSU+XS5maW5kKHRoaXMuX3RvU2VsZWN0UnhEQihmaWVsZHMsIG9ianMpKS5leGVjKCk7DQogICAgPCUgfWVsc2UgaWYoX3NxbFRvb2xzLmluZGV4T2YodCk+PTApeyAlPg0KICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJFTVMiKXsgJT4NCiAgICAgICAgICAgIGxldCBvID0gdGhpcy5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSBvID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5T2JqZWN0KCkuVEhJUyhbb10uY29uY2F0KG9ianMubWFwKF9vID0+IF9vLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKSkpKTsNCiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5T2JqZWN0KG8pLjwlPW1OYW1lJT4oKSk7DQogICAgICAgICAgICBpZih0aGlzLl9fY29uZmlnKCdlbXMuZGVlcC5xdWVyeScpKSByZXR1cm4gcmV0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJNZW1vcnkiKXsgJT4NCiAgICAgICAgICAgIHJldHVybiB0aGlzLlRvb2wuZGJbPCU9X25Db2RlKCklPl0uZmlsdGVyKG8gPT4gbyAmJiB0aGlzLl9zYW1lRW50aXR5KG8pKTsNCiAgICA8JSB9ZWxzZSBpZih0PT0iSHViU3BvdCIpeyAlPg0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTZXJ2aWNlTm93Iil7ICU+DQogICAgICAgICAgICByZXQgPSAoYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7c3lzcGFybV9xdWVyeTogdGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSl9KSkucmVzdWx0Ow0KICAgIDwlIH1lbHNlIGlmKHQ9PSJTYWxlc0ZvcmNlIil7ICU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7dXJsOiAncmVzdC51cmwuZ3FsJ30pOw0KICAgIDwlIH1lbHNlIGlmKF9maWxlVG9vbHMuaW5kZXhPZih0KT4tMSl7ICU+DQogICAgICAgICAgICBsZXQgZE5hbWUgPSB0aGlzLl90b0ZpbGVOYW1lKCkuc3BsaXQoJy8nKS5zbGljZSgwLCAtMSkuam9pbignLycpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBsZXQgZExpc3QgPSBhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPihkTmFtZSk7DQoNCiAgICAgICAgICAgIDwlPWxvZygpJT4iZE5hbWUiLCBkTmFtZSwgdGhpcy5fdG9GaWxlTmFtZSgpLCAiZExpc3QiLCBkTGlzdCk7DQogICAgICAgICAgICBsZXQgaWR4TGlzdCA9IChkTGlzdCB8fCBbXSkuZmlsdGVyKHIgPT4gdHlwZW9mKHIubmFtZSkhPT0ndW5kZWZpbmVkJykubWFwKHIgPT4gbmV3IDwlPXNjb3BlJT4uPCU9X2NOYW1lKGMsIHRydWUpJT4oKS5fZnJvbUZpbGVOYW1lKHIubmFtZSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPiJpZHhMaXN0IiwgaWR4TGlzdCwgaWR4TGlzdC5tYXAociA9PiByLl90b0ZpbGVOYW1lKCkpKTsNCiAgICAgICAgICAgIGlkeExpc3QgPSBpZHhMaXN0LmZpbHRlcihyID0+IHIuX21hdGNoZXModGhpcywge29ubHlVbmlxdWU6IHRydWV9KSk7DQogICAgICAgICAgICA8JT1sb2coKSU+ImlkeExpc3QgZmlsdGVyZWQiLCBpZHhMaXN0KTsgDQoNCiAgICAgICAgICAgIGlmKGlkeExpc3QubGVuZ3RoPT0xKXsNCiAgICAgICAgICAgICAgICByZXQucHVzaChhd2FpdCB0aGlzLl88JT10LnRvTG93ZXJDYXNlKCklPihkTmFtZSArICcvJyArIGlkeExpc3RbMF0uX3RvRmlsZU5hbWUoKS5zcGxpdCgnLycpLnNsaWNlKC0xKS5qb2luKCcvJykpKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldCA9IGlkeExpc3Q7DQogICAgICAgICAgICB9DQogICAgPCUgfWVsc2UgaWYodD09Ik5lbzRqIil7ICU+DQogICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLl9uZW80aih0aGlzLl90b0N5UXVlcnkoZmllbGRzLCBvYmpzKSk7DQogICAgPCUgfWVsc2UgaWYodD09IlJlc3REQklPIil7ICU+DQogICAgICAgICAgICBsZXQgdGhpc0RvYyA9IHRoaXMuX3RvRG9jdW1lbnQoe2JNYXA6IHRydWV9KTsNCiAgICAgICAgICAgIGxldCBlYUNvZGUgPSAiIjsNCiAgICAgICAgPCUgJC5lYWNoKGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCksIChfLCBlYSkgPT4geyU+DQogICAgICAgICAgICBlYUNvZGUgPSA8JT1fbkNvZGUoZWEpJT47DQogICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9zZXQpew0KICAgICAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7ICU+DQogICAgICAgICAgICA8JSB9ZWxzZSBpZihlYS5Jc0FycmF5KXsgJT4NCiAgICAgICAgICAgICAgICBpZih0aGlzLl88JT1uTmFtZShlYSklPl9jb29wPT0iIT0iKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkbmluIjogdGhpc0RvY1tlYUNvZGVdfTsNCiAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkaW4iOiB0aGlzRG9jW2VhQ29kZV19Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDwlIH1lbHNlIGlmKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCl7ICU+DQogICAgICAgICAgICAgICAgaWYoW251bGwsICclJywgJ0xJS0UnXS5pbmRleE9mKHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApPi0xKXsNCiAgICAgICAgICAgICAgICAgICAgdGhpc0RvY1tlYUNvZGVdID0geyIkcmVnZXgiOiB0aGlzRG9jW2VhQ29kZV0gfHwgIi4qIn07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgPCUgfSAlPg0KICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9KTsgJT4NCg0KICAgICAgICAgICAgbGV0IHVybCA9ICJodHRwczovLyIgKyB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScpICsgIi5yZXN0ZGIuaW8vcmVzdC8iICsgPCU9X25Db2RlKCklPi50b0xvd2VyQ2FzZSgpICsgIj9xPSIgKyBKU09OLnN0cmluZ2lmeShjb25kaXRpb25zKTsNCiAgICAgICAgICAgIHJldCA9IChhd2FpdCBheGlvcy5nZXQodXJsLCB7DQogICAgICAgICAgICAgICAgaGVhZGVyczogew0KICAgICAgICAgICAgICAgICAgICAiY2FjaGUtY29udHJvbCI6ICJuby1jYWNoZSIsDQogICAgICAgICAgICAgICAgICAgICJ4LWFwaWtleSI6IHRoaXMuX19jb25maWcoJ2FwaWtleScpLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pKS5kYXRhOw0KICAgIDwlIH1lbHNlIGlmKHQ9PSJCSVNlcnZlciIpeyAlPg0KICAgICAgICAgICAgbGV0IHEgPSB7DQogICAgICAgICAgICAgICAgVEhJUzogdGhpcy5fYnVpbGRUaGlzKGRlcHRoKS5jb25jYXQoKG9ianMgfHwgW10pLm1hcChvYmogPT4gb2JqLnRvRW50aXR5T2JqZWN0P3sNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSwNCiAgICAgICAgICAgICAgICB9Om9iaikpLA0KICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHsgLy8gYWJzb2x1dGVseSByZXF1aXJlZCBmb3IgaW5kZXhpbmcNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQogICAgICAgICAgICA8JT1sb2coKSU+cSk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXNPYmplY3RzKChhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kYWxsIiwgbnVsbCwgcSkpKTsNCiAgICA8JSB9ICU+DQogICAgICAgIH0NCjwlIH0pJT4NCg0KICAgICAgICA8JT1sb2coKSU+IkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCBkZXB0aCwgcmV0KTsNCiAgICAgICAgDQogICAgICAgIGlmKCFBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IFtyZXRdOw0KICAgICAgICByZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUoYywgdHJ1ZSklPigpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSkpLmZpbHRlcihyID0+IHIpLm1hcChyID0+IHIuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsNCg0KICAgICAgICBpZihkZXB0aD4xKXsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgciBvZiByZXQpew0KPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyU+DQogICAgICAgICAgICAgICAgaWYoci5fPCU9bk5hbWUoZWEpJT5fc2V0KXsNCiAgICAgICAgICAgICAgICAgICAgLy8gPCU9bG9nKCklPiI8JT1uTmFtZShlYSklPiIsIHIuPCU9bk5hbWUoZWEpJT4oKS5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICAgICAgci48JT1uTmFtZShlYSklPihhd2FpdCByLl88JT1uTmFtZShlYSklPi5maW5kKGRlcHRoLTEpKTsNCiAgICAgICAgICAgICAgICB9DQo8JSB9KSU+DQogICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7ICU+DQogICAgPCUgY2xzVG9vbHMoYykuZm9yRWFjaCh0ID0+IHslPg0KICAgICAgICAgICAgICAgIGlmKHRoaXMuVG9vbC50eXBlLm5hbWU9PSI8JT10JT4iKXsNCiAgICAgICAgPCUgaWYoX2ZpbGVUb29scy5pbmRleE9mKHQpPj0wKXsgJT4NCiAgICAgICAgICAgICAgICAgICAgbGV0IHJfPCU9dGFOYW1lJT4gPSBbXTsNCiAgICAgICAgICAgICAgICAgICAgZm9yIGF3YWl0IChjb25zdCBfdGEgb2Ygci48JT10YU5hbWUlPigpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4iPCU9dGFOYW1lJT4iLCBfdGEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcl88JT10YU5hbWUlPi5wdXNoKGF3YWl0IF90YS5maW5kKGRlcHRoLTEpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByLmNsZWFyXzwlPXRhTmFtZSU+KCk7DQogICAgICAgICAgICAgICAgICAgIHIuPCU9dGFOYW1lJT4ocl88JT10YU5hbWUlPik7DQogICAgICAgIDwlIH1lbHNleyAlPg0KICAgICAgICAgICAgICAgICAgICAvLyA8JT1sb2coKSU+IjwlPXRhTmFtZSU+Iiwgci48JT10YU5hbWUlPigpKTsNCiAgICAgICAgICAgICAgICAgICAgci48JT10YU5hbWUlPihhd2FpdCBuZXcgPCU9c2NvcGUlPi48JT1fY05hbWUodGEuRW50aXR5Q2xhc3MsIHRydWUpJT4oKS48JT1uTmFtZSh0YSklPihyKQ0KICAgICAgICAgICAgPCUgaWYoZmFsc2UgJiYgWydTcWxEQiddLmluZGV4T2YodCk+PTApeyAvLyBzcWwgc3RhdGVtZW50cyBkbyBub3QgaW5jbHVkZSBsZWZ0IGpvaW5zIHdpdGhvdXQgZXhwbGljaXQgcmVmZXJlbmNlcyAlPg0KICAgICAgICAgICAgICAgICAgICAgICAgPCV0YS5FbnRpdHlDbGFzcy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kICYmIGVhLkVudGl0eVR5cGUgJiYgZWEhPXRhKS5mb3JFYWNoKGVhID0+IHslPi48JT1uTmFtZShlYSklPihuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkpPCV9KSU+DQogICAgICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICAgICAgICAgIC48JT1tTmFtZSU+KGRlcHRoLTEpKTsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgfQ0KICAgIDwlIH0pJT4NCjwlIH0pJT4NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGxldCByZWZzID0gcmV0LmZpbHRlcihyID0+IHIuRW50aXR5Q2xhc3MpOw0KICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IG8gb2YgKG9ianMgfHwgW10pLmZpbHRlcihfbyA9PiAhX28uX19zeW5jX29uKCkpKXsNCiAgICAgICAgICAgIGlmKG8uX3RvRU1TT2JqZWN0KXsNCiAgICAgICAgICAgICAgICByZWZzLnB1c2goLi4uKGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkuPCU9bU5hbWUlPihkZXB0aCkpKSk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICByZWZzLnB1c2goLi4uKGF3YWl0IG8uPCU9bU5hbWUlPihkZXB0aCkpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZWZzID0gcmVmcy5maWx0ZXIociA9PiByKTsNCiAgICAgICAgDQogICAgICAgIHJlZnMuZm9yRWFjaChyID0+IHIuX3Jlc29sdmUocmVmcykpOw0KDQogICAgICAgIDwlPWxvZygpJT4iT3V0cHV0IiwgcmV0KTsNCg0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgICAgIC8qKiogRU5EIExPQ0FMIDwlPW1OYW1lJT4oKSAqKiovDQogICAgICAgIH0sIHtkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzLCBfX2JlZm9yZVJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5CZWZvcmUpLm1hcChyID0+IHslPjwlPV9GckVNRC5fdG9KUyhyKSU+PCUgfSkuam9pbignLCAnKSU+XSwgX19hZnRlclJ1bGVzOiBbPCUoYy5FbnRpdHlSdWxlcyB8fCBbXSkuZmlsdGVyKHIgPT4gclttTmFtZV0gJiYgci5BZnRlcikubWFwKHIgPT4geyU+PCU9X0ZyRU1ELl90b0pTKHIpJT48JSB9KS5qb2luKCcsICcpJT5dfSk7DQoNCiAgICAgICAgcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwge3JldDogW119KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQ0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3Jlc29sdmUnJT4ocmVmcyl7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKCFyZWZzLmxlbmd0aCkgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuX19pbXBvcnQoe30sIHsNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QgJiYgZWEuRW50aXR5VHlwZSkuZm9yRWFjaChlYSA9PiB7ICU+DQogICAgICAgICAgICAgICAgPCU9bk5hbWUoZWEpJT46ICgpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy48JT1uTmFtZShlYSklPigpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDwlPWxvZygpJT4iPCU9bk5hbWUoZWEpJT4iLCB0aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQsIHJlZnMubWFwKHIgPT4gKHtpZDogci5JZCwgY29kZTogci5jb2RlKCl9KSkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy48JT1uTmFtZShlYSklPihyZWZzLmZpbmQobyA9PiBvLklkPT10aGlzLjwlPW5OYW1lKGVhKSU+KCkuSWQpIHx8IHRoaXMuPCU9bk5hbWUoZWEpJT4oKS48JT1tTmFtZSU+KHJlZnMpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgICAgIDwlPXRhTmFtZSU+OiAoKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuPCU9dGFOYW1lJT4oKS5sZW5ndGgpIHRoaXMuPCU9dGFOYW1lJT4odGhpcy48JT10YU5hbWUlPigpLm1hcCh0YSA9PiByZWZzLmZpbmQobyA9PiBvLklkPT10YS5JZCkgfHwgdGEuPCU9bU5hbWUlPihyZWZzKSksIG51bGwsIHRydWUpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICB9DQogICAgDQo8JSBpZihtYWluQ2xhc3MoWydFTVMnXSkpeyU+DQogICAgYXN5bmMgPCU9bU5hbWU9J19mcm9tRU1TVmFsdWVzJyU+KGV2cyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnRU1TJ10pPT1jKXslPg0KICAgICAgICB0cnl7DQogICAgICAgICAgICBhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhldnMsIFsuLi5uZXcgU2V0KGV2cy5tYXAodiA9PiB2LmVudGl0eUF0dHJpYnV0ZSgpLklkKS5mbGF0KCkpXS5tYXAoaWQgPT4gbmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKGlkKSkpOw0KICAgICAgICAgICAgPCU9bG9nKCklPmV2cyk7DQogICAgICAgIA0KICAgICAgICAgICAgbGV0IG9ianMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeShldnMsICJfZW50aXR5T2JqZWN0IikuZm9yRWFjaChldmcgPT4gew0KICAgICAgICAgICAgICAgIGV2Zy5rZXkuZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcyhldmcudmFsdWVzKTsNCiAgICAgICAgICAgICAgICBvYmpzLnB1c2goZXZnLmtleSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgb2Jqcy5mb3JFYWNoKHIgPT4gci5lbnRpdHlDbGFzcyhyLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoKVswXS5lbnRpdHlBdHRyaWJ1dGUoKS5lbnRpdHlDbGFzcygpKSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgICAgIGZvciBhd2FpdCAoY29uc3QgciBvZiBvYmpzKXsNCiAgICAgICAgICAgICAgICByZXQucHVzaChhd2FpdCBuZXcgPCU9c2NvcGUlPltyLmVudGl0eUNsYXNzKCkubmFtZSgpXSgpLl9mcm9tRU1TT2JqZWN0KHIpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgPCV9ZWxzZXslPg0KICAgICAgICByZXR1cm4gYXdhaXQgbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnRU1TJ10sYykpJT4oKS48JT1tTmFtZSU+KGV2cyk7DQogICAgPCV9JT4NCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J190b0VNU0NsYXNzJyU+KGRlcHRoKXsNCiAgICAgICAgLy8gd2h5IG5vdCBfX2V4cG9ydCA/DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGxldCByZXQgPSBuZXcgPCU9c2NvcGUlPi5FbnRpdHlDbGFzcygnPCU9Yy5JZCU+JykubmFtZSgiPCU9Yy5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShjKSU+IikuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZGF0ZShuZXcgRGF0ZSgpKS5jb21wYW55KG5ldyA8JT1zY29wZSU+LkNvbXBhbnkoKS5uYW1lKCI8JT1zY29wZSU+IikuY29kZSgiPCU9c2NvcGUlPiIpKS5lbnRpdHlNb2R1bGUobmV3IDwlPXNjb3BlJT4uRW50aXR5TW9kdWxlKCkuY29kZSgiPCU9c2NvcGUlPiIpLm5hbWUoIjwlPXNjb3BlJT4iKSk7DQogICAgICAgICAgICBpZighZGVwdGgpIHJldHVybiByZXQ7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHJldC5lbnRpdHlDbGFzc19FbnRpdHlNZXRob2RzKFsNCiAgICA8JSBjLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHslPg0KICAgICAgICAgICAgICAgIG5ldyA8JT1zY29wZSU+LkVudGl0eU1ldGhvZCgnPCU9bS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiPCU9bS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShtKSU+IikuZW50aXR5TWV0aG9kX0VudGl0eUF0dHJpYnV0ZXMoWw0KICAgICAgICA8JSBtLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHslPg0KICAgICAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPXAuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPXAuTmFtZSU+IikuY29kZSgiPCU9bk5hbWUocCklPiIpLmlzQXJyYXkoPCU9cC5Jc0FycmF5Pyd0cnVlJzonZmFsc2UnJT4pLnJlbWFyaygiPCU9Yy5OYW1lJT4uPCU9bS5OYW1lJT4oKSIpLmVudGl0eUNsYXNzKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGMsIHRydWUpJT4oKS48JT1tTmFtZSU+KCkpDQogICAgICAgICAgICA8JSBpZihwLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgICAgIC5lbnRpdHlUeXBlKG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHAuRW50aXR5VHlwZSklPigpLjwlPW1OYW1lJT4oZGVwdGgtMSkpDQogICAgICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIocCklPih0cnVlKQ0KICAgICAgICAgICAgPCUgfSU+LA0KICAgICAgICA8JSB9KSU+DQogICAgICAgICAgICAgICAgXSkucmVzcG9uc2VBdHRyaWJ1dGUobmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT1tLlJlc3BvbnNlQXR0cmlidXRlLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1tLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKG0uUmVzcG9uc2VBdHRyaWJ1dGUpJT4iKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShjLCB0cnVlKSU+KCkuPCU9bU5hbWUlPigpKQ0KICAgICAgICA8JSBpZihtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgLmVudGl0eVR5cGUobmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSU+KCkuPCU9bU5hbWUlPihkZXB0aC0xKSkNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIobS5SZXNwb25zZUF0dHJpYnV0ZSklPih0cnVlKQ0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICApLA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pLmVudGl0eUNsYXNzX0VudGl0eUF0dHJpYnV0ZXMoWw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgICAgICBuZXcgPCU9c2NvcGUlPi5FbnRpdHlBdHRyaWJ1dGUoJzwlPWVhLklkJT4nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKCI8JT1lYS5OYW1lJT4iKS5jb2RlKCI8JT1uTmFtZShlYSklPiIpLnJlbWFyaygnPCU9Yy5OYW1lJT4uPCU9ZWEuTmFtZSU+JykNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICAuZW50aXR5VHlwZShuZXcgPCU9c2NvcGUlPi48JT1uTmFtZShlYS5FbnRpdHlUeXBlLCB0cnVlKSU+KCkuPCU9bU5hbWUlPihkZXB0aC0xKSkNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICAuaXM8JT1fRnJFTUQuX2F0dHIoZWEpJT4odHJ1ZSkNCiAgICAgICAgPCUgfSU+LA0KICAgIDwlIH0pJT4NCiAgICAgICAgICAgIF0pOw0KICAgICAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgPCU9ZXJyb3IoKSU+ZXgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXN5bmMgPCU9bU5hbWU9J19mcm9tRU1TT2JqZWN0JyU+KG9iail7DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIHRoaXMuSWQgPSBvYmouSWQ7DQogICAgICAgICAgICBsZXQgZXYgPSBudWxsOw0KICAgIDwlIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZm9yRWFjaChlYSA9PiB7JT4NCiAgICAgICAgICAgIGV2ID0gb2JqLmVudGl0eU9iamVjdF9FbnRpdHlWYWx1ZXMoKS5maW5kKGV2ID0+IGV2LmVudGl0eUF0dHJpYnV0ZSgpLmNvZGUoKT09PCU9X25Db2RlKGVhKSU+KTsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgIGlmKGV2KSB0aGlzLjwlPW5OYW1lKGVhKSU+KGF3YWl0IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKGVhLkVudGl0eVR5cGUsIHRydWUpJT4oKS48JT1tTmFtZSU+KGV2Lm9iamVjdFZhbHVlKCkpKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgIGlmKGV2KSB0aGlzLjwlPW5OYW1lKGVhKSU+KGV2LjwlPV9GckVNRC5fYXR0cihlYSkudG9Mb3dlckNhc2UoKSU+VmFsdWUoKSk7DQogICAgICAgIDwlIH0lPg0KICAgIDwlIH0pJT4NCiAgICA8JSBjLlR5cGVkQXR0cmlidXRlcy5mb3JFYWNoKHRhID0+IHsgbGV0IHRhTmFtZSA9IG5OYW1lKHRhKSArICdfJyArIHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7JT4NCiAgICA8JSB9KSU+DQogICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfWNhdGNoKGV4KXsNCiAgICAgICAgICAgIDwlPWVycm9yKCklPmV4KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfdG9FTVNPYmplY3QnJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKXsNCiAgICAgICAgbGV0IHJldCA9IG5ldyA8JT1zY29wZSU+LkVudGl0eU9iamVjdCgpLmFjdGl2ZSh0cnVlKS5lbnRpdHlDbGFzcyh0aGlzLl90b0VNU0NsYXNzKCkpOw0KDQogICAgICAgIHJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7DQogICAgICAgICAgICBGdWxsOiAhYlF1ZXJ5LA0KICAgICAgICAgICAgLy9OdWxsOiAhYlF1ZXJ5LA0KICAgICAgICAgICAgSWQ6IChvYmosIGVhQ29kZSwgdikgPT4gb2JqLklkID0gdiwNCiAgICA8JSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4geyAlPg0KICAgICAgICAgICAgIjwlPW5OYW1lKGVhKSU+IjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGV2ID0gbmV3IDwlPXNjb3BlJT4uRW50aXR5VmFsdWUoKS5hY3RpdmUodHJ1ZSkuZW50aXR5QXR0cmlidXRlKG5ldyA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZSgnPCU9ZWEuSWQlPicpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIjwlPWVhLk5hbWUlPiIpLmNvZGUoIjwlPW5OYW1lKGVhKSU+IikuZW50aXR5Q2xhc3ModGhpcy5fdG9FTVNDbGFzcygpKSk7DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgZXYub2JqZWN0VmFsdWUodj92LjwlPW1OYW1lJT4oYlF1ZXJ5LCBiVHlwZWRBdHRyaWJ1dGVzKTpudWxsLCB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wKTsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICBldi48JT1fRnJFTUQuX2F0dHIoZWEpLnRvTG93ZXJDYXNlKCklPlZhbHVlKHYsIHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3ApOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICBvYmouZW50aXR5T2JqZWN0X0VudGl0eVZhbHVlcyhldiwgJz09Jyk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pOyAlPg0KICAgIDwlIGMuVHlwZWRBdHRyaWJ1dGVzLmZvckVhY2godGEgPT4geyBsZXQgdGFOYW1lID0gbk5hbWUodGEpICsgJ18nICsgdGEuRW50aXR5Q2xhc3MuUGx1cmFsLnJlcGxhY2UoLyAvZywgJ18nKTslPg0KICAgICAgICAgICAgPCU9dGFOYW1lJT46IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGlmKHYgJiYgYlR5cGVkQXR0cmlidXRlcykgb2JqLm9iamVjdFZhbHVlX0VudGl0eVZhbHVlcyh2Lm1hcChfdiA9PiBuZXcgPCU9c2NvcGUlPi5FbnRpdHlWYWx1ZSgpLmFjdGl2ZSh0cnVlKS5lbnRpdHlBdHRyaWJ1dGUobmV3IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlKCc8JT10YS5JZCU+JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSgiPCU9bk5hbWUodGEpJT4iKS5uYW1lKCI8JT10YS5OYW1lJT4iKS5lbnRpdHlDbGFzcyhuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl90b0VNU0NsYXNzKCkpKS5vYmplY3RWYWx1ZShfdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcykpKSwgJz09Jyk7DQogICAgICAgICAgICB9LA0KICAgIDwlIH0pJT4NCiAgICAgICAgfSwgIjwlPW1OYW1lJT4iKTsNCg0KICAgICAgICA8JT1sb2coKSU+cmV0KTsNCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQo8JSB9ICU+DQoNCjwlIGlmKG1haW5DbGFzcyhbJ0JJU2VydmVyJ10pKXslPg0KICAgIDwlPW1OYW1lPSdfYXNPYmplY3RzJyU+KGV2cyl7DQogICAgPCUgaWYobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSkhPWMpeyU+DQogICAgICAgICAgICByZXR1cm4gbmV3IDwlPXNjb3BlJT4uPCU9bk5hbWUobWFpbkNsYXNzKFsnQklTZXJ2ZXInXSxjKSklPigpLjwlPW1OYW1lJT4oZXZzKTsNCiAgICA8JX1lbHNleyU+DQogICAgICAgIHRyeXsNCiAgICAgICAgICAgIGlmKHR5cGVvZihldnMpPT09InVuZGVmaW5lZCIgfHwgIWV2cyB8fCAhQXJyYXkuaXNBcnJheShldnMpIHx8ICFldnMubGVuZ3RoKSByZXR1cm4gW107DQoNCiAgICAgICAgICAgIGV2cy5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICBldi5FbnRpdHlBdHRyaWJ1dGUgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5JZD09ZXYuRW50aXR5QXR0cmlidXRlaWQpOw0KICAgICAgICAgICAgICAgIGV2LkVudGl0eU9iamVjdC5FbnRpdHlDbGFzcyA9IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlDbGFzczsNCiAgICAgICAgICAgICAgICBpZihldi5PYmplY3RWYWx1ZSl7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlLkVudGl0eUNsYXNzID0gPCU9c2NvcGUlPi5FbnRpdHlDbGFzc2VzLmZpbmQoZWMgPT4gZWMuSWQ9PWV2Lk9iamVjdFZhbHVlLkVudGl0eUNsYXNzLklkKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIGxldCBvYmogPSBbXTsNCiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeShldnMsICJFbnRpdHlPYmplY3QiKS5mb3JFYWNoKGV2ZyA9PiB7DQogICAgICAgICAgICAgICAgbGV0IGMgPSBuZXcgPCU9c2NvcGUlPltldmcua2V5LkVudGl0eUNsYXNzLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpOw0KICAgICAgICAgICAgICAgIGMuRW50aXR5VmFsdWVzID0gZXZnLnZhbHVlczsNCiAgICAgICAgICAgICAgICBjLlZhbHVlRW50aXRpZXMgPSBbXTsNCiAgICAgICAgICAgICAgICAvLyBjLkVudGl0eUNsYXNzID0gZXZnLmtleS5FbnRpdHlDbGFzczsNCiAgICAgICAgICAgICAgICBjLklkID0gZXZnLmtleS5JZDsNCiAgICAgICAgICAgICAgICBldmcudmFsdWVzLmZvckVhY2godiA9PiB2LkVudGl0eU9iamVjdCA9IGMpOw0KICAgICAgICAgICAgICAgIG9iai5wdXNoKGMpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIGV2cy5maWx0ZXIoZXYgPT4gZXYuT2JqZWN0VmFsdWUpLmZvckVhY2goZXYgPT4gew0KICAgICAgICAgICAgICAgIHZhciBfZiA9IG9iai5maW5kKG8gPT4gby5JZCA9PSBldi5PYmplY3RWYWx1ZS5JZCk7DQogICAgICAgICAgICAgICAgaWYoX2YpIF9mLlZhbHVlRW50aXRpZXMucHVzaChldik7DQogICAgICAgICAgICAgICAgZXYuT2JqZWN0VmFsdWUgPSBfZjsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICANCiAgICAgICAgICAgIGxldCByZXQgPSBbXTsNCiAgICAgICAgICAgIG9iai5mb3JFYWNoKG8gPT4gew0KICAgICAgICAgICAgICAgIGlmKG8uRW50aXR5Q2xhc3MgJiYgby5FbnRpdHlDbGFzcy5JZCE9dGhpcy5FbnRpdHlDbGFzcy5JZCkgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgcmV0LnB1c2gobyk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIHJldC5tYXAobyA9PiBvLl9yZXZlcnQoKSk7DQogICAgICAgIH1jYXRjaChleCl7DQogICAgICAgICAgICA8JT1lcnJvcigpJT5leCk7DQogICAgICAgIH0NCiAgICA8JX0lPg0KICAgIH0NCiAgICANCiAgICA8JT1tTmFtZT0nX3JldmVydCclPihlbykgew0KICAgICAgICBpZiAoZW8pIHsNCiAgICAgICAgICAgIC8vIHJldmVydCBmcm9tIHNvdXJjZSBkYXRhDQogICAgICAgICAgICBpZihlby5FbnRpdHlDbGFzcyAmJiAoKHRoaXMuRW50aXR5Q2xhc3MuSWQgJiYgZW8uRW50aXR5Q2xhc3MuSWQhPXRoaXMuRW50aXR5Q2xhc3MuSWQpIHx8ICh0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgZW8uRW50aXR5Q2xhc3MuTmFtZSE9dGhpcy5FbnRpdHlDbGFzcy5OYW1lKSkpew0KICAgICAgICAgICAgICAgIDwlPWVycm9yKCklPiJDYW5ub3QgcmV2ZXJ0ICIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLkVudGl0eUNsYXNzKSArICIgZnJvbSAiICsgZW8uRW50aXR5Q2xhc3MuTmFtZSwgZW8pOw0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5JZCA9IGVvLklkOw0KICAgICAgICAgICAgdGhpcy5FbnRpdHlWYWx1ZXMgPSBlby5FbnRpdHlWYWx1ZXMgfHwgW107DQogICAgICAgICAgICB0aGlzLlZhbHVlRW50aXRpZXMgPSBlby5WYWx1ZUVudGl0aWVzIHx8IFtdOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuPCU9bU5hbWUlPigpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaWYodGhpcy5fX3N5bmNfb24oKSAmJiBNYXRoLmFicygobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IDUpew0KICAgICAgICAgICAgICAgIDwlPXdhcm4oKSU+Ik9iamVjdCBhbHJlYWR5IHJldmVydGVkIiwgdGhpcy5fdG9Eb2N1bWVudCgpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOw0KICAgICAgICANCiAgICAgICAgICAgIC8vIHVzZSBFbnRpdHlWYWx1ZXMgYW5kIFZhbHVlRW50aXRpZXMgdG8gcmV2ZXJ0IHRoZSBhdHRyaWJ1dGUgdmFsdWVzDQogICAgICAgICAgICB0aGlzLkVudGl0eVZhbHVlcy5mb3JFYWNoKGV2ID0+IHsNCiAgICAgICAgICAgICAgICBsZXQgZWEgPSBudWxsOw0KICAgICAgICAgICAgICAgIHRyeXsNCiAgICAgICAgICAgICAgICAgICAgZWEgPSA8JT1zY29wZSU+LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKF9lYSA9PiBfZWEuRW50aXR5Q2xhc3MuTmFtZT09JzwlPWMuTmFtZSU+JykuZmluZChfZWEgPT4gew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlaWQ9PV9lYS5JZCkgcmV0dXJuIF9lYTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGV2LkVudGl0eUF0dHJpYnV0ZSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlLklkPT1fZWEuSWQpIHJldHVybiBfZWE7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXYuRW50aXR5QXR0cmlidXRlLk5hbWU9PV9lYS5OYW1lKSByZXR1cm4gX2VhOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIGlmKCFlYSl7DQogICAgICAgICAgICAgICAgICAgICAgICA8JT13YXJuKCklPiJ1bmFibGUgdG8gZGV0ZWN0IGF0dHJpYnV0ZSBmcm9tIHZhbHVlIiwgZXYpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpew0KICAgICAgICAgICAgICAgICAgICA8JT1lcnJvcigpJT5ldiwgZXgpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgbGV0IHYgPSBldlsodGhpc1siX2F0dHIiXT90aGlzOl9GckVNRCkuX2F0dHIoZWEpICsgIlZhbHVlIl07DQogICAgICAgICAgICAgICAgbGV0IHAgPSBlYS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBpZih0eXBlb2YodGhpc1twXSkhPT0nZnVuY3Rpb24nKXsNCiAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iaW52YWxpZCB0eXBlIiwgZWEsIHAsIHYpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKHYgJiYgZWEuRW50aXR5VHlwZSAmJiB0eXBlb2Yodik9PT0nb2JqZWN0Jyl7DQogICAgICAgICAgICAgICAgICAgIDwlPWxvZygpJT4icmV2ZXJ0aW5nICIgKyBlYS5OYW1lLCB2LCBuZXcgPCU9c2NvcGUlPltlYS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odikpOw0KICAgICAgICAgICAgICAgICAgICBpZighdi5FbnRpdHlWYWx1ZXMpew0KICAgICAgICAgICAgICAgICAgICAgICAgPCU9d2FybigpJT4iZW1wdHkgdmFsdWVzIGZvciAiICsgZWEuTmFtZSwgdik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdiA9IHYuPCU9bU5hbWUlPj92LjwlPW1OYW1lJT4oKTpuZXcgPCU9c2NvcGUlPltlYS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXNbcF0odik7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgdGhpcy5WYWx1ZUVudGl0aWVzLmZpbHRlcih2ZSA9PiB2ZS5FbnRpdHlBdHRyaWJ1dGUpLmZvckVhY2godmUgPT4gew0KICAgICAgICAgICAgICAgIHZhciB0YSA9IDwlPXNjb3BlJT4uRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklkPT12ZS5FbnRpdHlBdHRyaWJ1dGUuSWQpOw0KICAgICAgICAgICAgICAgIGlmKCF0YSkgcmV0dXJuIG51bGw7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgdmFyIHRhTmFtZSA9IHRhLkVudGl0eUNsYXNzLlBsdXJhbC5yZXBsYWNlKC8gL2csICdfJyk7DQoNCiAgICAgICAgICAgICAgICBsZXQgdiA9IHZlLkVudGl0eU9iamVjdDsNCiAgICAgICAgICAgICAgICBpZih2KXsNCiAgICAgICAgICAgICAgICAgICAgdiA9IHYuPCU9bU5hbWUlPj92LjwlPW1OYW1lJT4oKTpuZXcgPCU9c2NvcGUlPlt0YS5FbnRpdHlUeXBlLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXSgpLjwlPW1OYW1lJT4odik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHRoaXNbdGEuTmFtZS5yZXBsYWNlKC8gL2csICJfIikgKyAiXyIgKyB0YU5hbWVdKHYpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KICAgIDwlPW1OYW1lPSdfdmFsdWVDbGFzcyclPigpew0KICAgICAgICBsZXQgX2NsYXNzID0ge0FjdGl2ZTogdHJ1ZX07DQogICAgICAgIGlmKHRoaXMuRW50aXR5Q2xhc3MuRW50aXR5TW9kdWxlKXsNCiAgICAgICAgICAgIF9jbGFzcy5FbnRpdHlNb2R1bGUgPSB0aGlzLkVudGl0eUNsYXNzLkVudGl0eU1vZHVsZTsNCiAgICAgICAgfWVsc2V7DQogICAgICAgICAgICBfY2xhc3MgPSB7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIENvbXBhbnk6IHtBY3RpdmU6IHRydWUsIEVuYWJsZWQ6IHRydWUsIEVudGl0eUNsYXNzZXM6IFt0aGlzLkVudGl0eUNsYXNzXX0NCiAgICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF9jbGFzczsNCiAgICB9DQoNCiAgICA8JT1tTmFtZT0nX3RvWE1MJyU+KCl7DQogICAgICAgIC8vIGFuIG92ZXJsb2FkIG9mIHRoZSBzci5fdG9YTUwNCiAgICAgICAgbGV0IHJldCA9IHt4bWw6IGBgfTsNCiAgICAgICAgcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IHJldC54bWwgKz0gYDwke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J0lkJ30+JHt2fTwvJHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdJZCd9PmAsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIHJldC54bWwgKz0gYDwke2VhQ29kZX0+YDsNCiAgICAgICAgPCUgaWYoZWEuRW50aXR5VHlwZSl7JT4NCiAgICAgICAgICAgICAgICByZXQueG1sICs9IHY/di48JT1tTmFtZSU+KCk6bnVsbDsNCiAgICAgICAgPCUgfWVsc2V7JT4NCiAgICAgICAgICAgICAgICByZXQueG1sICs9IGA8IVtDREFUQVske3Z9XV0+YDsNCiAgICAgICAgPCUgfSU+DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPC8ke2VhQ29kZX0+YDsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgcmV0LnhtbCArPSBgPCR7ZWFDb2RlfT5gICsgdi5tYXAoX3YgPT4gJzxPYmplY3Q+JyArIF92LjwlPW1OYW1lJT4oKSArICI8L09iamVjdD4iKS5qb2luKCcnKSArIGA8LyR7ZWFDb2RlfT5gOw0KICAgICAgICAgICAgfSwNCiAgICA8JSB9KSU+DQogICAgICAgIH0sICI8JT1tTmFtZSU+Iik7DQoNCiAgICAgICAgPCU9bG9nKCklPnJldCk7DQogICAgICAgIHJldHVybiByZXQueG1sOw0KICAgIH0NCg0KICAgIDwlPW1OYW1lPSdfYnVpbGRUaGlzJyU+KGRlcHRoPTEpew0KICAgICAgICAvLyBjYW5kaWRhdGUgZm9yIF9fZXhwb3J0DQogICAgICAgIHZhciByZXQgPSBbew0KICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgRW50aXR5QXR0cmlidXRlOiB7QWN0aXZlOiB0cnVlLCBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpfSwNCiAgICAgICAgICAgIEVudGl0eU9iamVjdDogdGhpcy50b0VudGl0eU9iamVjdCh0cnVlKSwNCiAgICAgICAgfV07DQogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IGRlcHRoOyBpKyspIHsNCiAgICAgICAgICAgIHJldC5wdXNoKHsNCiAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB7DQogICAgICAgICAgICAgICAgICAgIEFjdGl2ZTogdHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgVmFsdWVFbnRpdGllczogW3JldFtpIC0gMV1dDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgDQo8JSBjLlR5cGVkQXR0cmlidXRlcy5maWx0ZXIodGEgPT4gIXRhLkVudGl0eU1ldGhvZCkuZm9yRWFjaCh0YSA9PiB7JT4NCiAgICAgICAgaWYoZGVwdGg+MSl7DQogICAgICAgICAgICBsZXQgdiA9IG5ldyA8JT1zY29wZSU+LjwlPW5OYW1lKHRhLkVudGl0eUNsYXNzLCB0cnVlKSU+KCkuPCU9bk5hbWUodGEpJT4odGhpcyk7DQogICAgICAgICAgICByZXQucHVzaCh7DQogICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgIEVudGl0eU9iamVjdDogdj92LnRvRW50aXR5T2JqZWN0KHRydWUpOm51bGwsDQogICAgICAgICAgICB9KTsNCiAgICANCiAgICAgICAgICAgIHJldC5wdXNoKHsNCiAgICAgICAgICAgICAgICBFbnRpdHlPYmplY3Q6IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBWYWx1ZUVudGl0aWVzOiBbew0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgRW50aXR5T2JqZWN0OiB2P3YudG9FbnRpdHlPYmplY3QodHJ1ZSk6bnVsbCwNCiAgICAgICAgICAgICAgICAgICAgfV0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KPCUgfSklPg0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQogICAgDQogICAgPCU9bU5hbWU9J3RvRW50aXR5T2JqZWN0JyU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcykgew0KICAgICAgICBsZXQgcmV0ID0ge0FjdGl2ZTogdHJ1ZSwgRW50aXR5Q2xhc3M6IHRoaXMuX3ZhbHVlQ2xhc3MoKSwgRW50aXR5VmFsdWVzOiBbXSwgVmFsdWVFbnRpdGllczogW119Ow0KICAgICAgICBpZighYlF1ZXJ5KSByZXQuRGF0ZSA9IHRoaXMuc2VydmVyRGF0ZSgpOyANCg0KICAgICAgICByZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgew0KICAgICAgICAgICAgRnVsbDogIWJRdWVyeSwNCiAgICAgICAgICAgIElkOiAob2JqLCBlYUNvZGUsIHYpID0+IG9iai5JZCA9IHYsDQogICAgPCUgYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IHsgJT4NCiAgICAgICAgICAgICI8JT1uTmFtZShlYSklPiI6IChvYmosIGVhQ29kZSwgdikgPT4gew0KICAgICAgICAgICAgICAgIGxldCBldiA9IHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIElkOiA8JT1zY29wZSU+LkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPSB0aGlzLkVudGl0eUNsYXNzLklkKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZT09JzwlPWVhLk5hbWUlPicpLklkLA0KICAgICAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgTmFtZTogIjwlPWVhLk5hbWUlPiIsDQogICAgICAgICAgICAgICAgICAgICAgICBFbnRpdHlDbGFzczogdGhpcy5fdmFsdWVDbGFzcygpLA0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBPUEVSQVRPUlM6IHt9LA0KICAgICAgICAgICAgICAgIH07DQogICAgICAgIDwlIGlmKGVhLkVudGl0eVR5cGUpeyU+DQogICAgICAgICAgICAgICAgaWYodil7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9iamVjdFZhbHVlID0gdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyk7DQogICAgICAgICAgICAgICAgICAgIGV2Lk9QRVJBVE9SUy5PYmplY3RWYWx1ZSA9IHRoaXMuXzwlPW5OYW1lKGVhKSU+X2Nvb3A7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICA8JSB9ZWxzZXslPg0KICAgICAgICAgICAgICAgIGV2LjwlPV9GckVNRC5fYXR0cihlYSklPlZhbHVlID0gdjsNCiAgICAgICAgICAgICAgICBldi5PUEVSQVRPUlMuPCU9X0ZyRU1ELl9hdHRyKGVhKSU+VmFsdWUgPSB0aGlzLl88JT1uTmFtZShlYSklPl9jb29wOw0KICAgICAgICA8JSB9JT4NCiAgICAgICAgICAgICAgICBvYmouVmFsdWVFbnRpdGllcy5wdXNoKGV2KTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSk7ICU+DQogICAgPCUgYy5UeXBlZEF0dHJpYnV0ZXMuZm9yRWFjaCh0YSA9PiB7IGxldCB0YU5hbWUgPSBuTmFtZSh0YSkgKyAnXycgKyB0YS5FbnRpdHlDbGFzcy5QbHVyYWwucmVwbGFjZSgvIC9nLCAnXycpOyU+DQogICAgICAgICAgICA8JT10YU5hbWUlPjogKG9iaiwgZWFDb2RlLCB2KSA9PiB7DQogICAgICAgICAgICAgICAgaWYodiAmJiBiVHlwZWRBdHRyaWJ1dGVzKSBvYmouRW50aXR5VmFsdWVzLnB1c2godi5tYXAoX3YgPT4gKHsNCiAgICAgICAgICAgICAgICAgICAgQWN0aXZlOiB0cnVlLA0KICAgICAgICAgICAgICAgICAgICBFbnRpdHlBdHRyaWJ1dGU6IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIElkOiAnPCU9dGEuSWQlPicsDQogICAgICAgICAgICAgICAgICAgICAgICBBY3RpdmU6IHRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICBOYW1lOiAiPCU9dGEuTmFtZSU+IiwNCiAgICAgICAgICAgICAgICAgICAgICAgIEVudGl0eUNsYXNzOiBuZXcgPCU9c2NvcGUlPi48JT1uTmFtZSh0YS5FbnRpdHlDbGFzcywgdHJ1ZSklPigpLl92YWx1ZUNsYXNzKCksDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIE9iamVjdFZhbHVlOiBfdi48JT1tTmFtZSU+KGJRdWVyeSwgYlR5cGVkQXR0cmlidXRlcyksDQogICAgICAgICAgICAgICAgfSkpKTsNCiAgICAgICAgICAgIH0sDQogICAgPCUgfSklPg0KICAgICAgICB9LCAiPCU9bU5hbWUlPiIpOw0KDQogICAgICAgIDwlPWxvZygpJT5yZXQpOw0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCjwlIH0gJT4NCn0NCg==",
	"_ToString": "RW50aXR5Q2xhc3M=",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195b6532e2f766f9b89a2341abb4655",
		"transform": "KiojJGZbaW50ZXJuYWxfbmFtZT1cXCciK2MuTmFtZSsiX2xvb2t1cFxcJyBhbmQgJG5vdCgkZXhpc3RzKGZsb3dfRmxvd19TbmFwc2hvdHMpKV0uc25hcHNob3RfRmxvd19Mb2dpY3MuKioucGFyZW50X0Zsb3dfSW5zdGFuY2VzIyRmaVskbnVtYmVyKG9yZGVyKTw9IitiT3JkZXIrIiBhbmQgc3ViZmxvdy5pbnRlcm5hbF9uYW1lPVxcJyIrZWEuRW50aXR5VHlwZS5OYW1lKyJfbG9va3VwXFwnXS51aV9pZA=="
	}, {
		"id": "0195b6532e30745b8ea38d7f5b8fc8ce",
		"transform": "JC5zeXNfc2NvcGUuc2NvcGU="
	}, {
		"id": "0195b6532e30745b8ea3939b612bd4b2",
		"transform": "W14="
	}, {
		"id": "0195b6532e30745b8ea398a6fbb5f1a5",
		"transform": "JywgJycpLnJlcGxhY2UoJw=="
	}]
}
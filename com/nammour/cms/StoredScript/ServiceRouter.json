{
	"Id": "5e97e9b40bab08e7d6847547175d384015cce063",
	"name": "ServiceRouter",
	"script": "d2luZG93LlNlcnZpY2VSb3V0ZXIgPSBjbGFzcyB7CglfX3Njb3BlKHNjb3BlKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXQgPSB3aW5kb3c7CgkJfSBlbHNlIGlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXQgPSBzZWxmOwoJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCXJldCA9IGdsb2JhbDsKCQl9CgoJCWlmIChzY29wZSkgcmV0ID0gcmV0W3Njb3BlXTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ1aWxkVVJMKHNyVVJMKSB7CgkJaWYgKCFzclVSTCkgewoJCQl0aGlzLnNyVVJMID0gdGhpcy4kX1JFUVVFU1QoJ3NyJyk7CgkJCWlmICghdGhpcy5zclVSTCkgewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCWxldCBpcCA9IHRoaXMuaXBBZGRyZXNzKCk7CgkJCQkJaWYgKGlwICYmIChpcC5zdGFydHNXaXRoKCIxODIuMTY4LiIpIHx8IGlwID09ICIxOTIuMTY4LjEuMjUzIiB8fCBpcCA9PSAnMTk1LjExMi4yMTUuMjE4JykpIHsKCQkJCQkJdGhpcy5zclVSTCA9ICJodHRwOi8vMTgyLjE2OC43MC44MCI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5zclVSTCA9ICJodHRwOi8vYXJ6Lm5hbW1vdXIuY29tOjcwODAiOwoJCQkJCX0KCQkJCX0KCQkJCXRoaXMuc3JVUkwgKz0gJy9tZXRob2QvU2VydmljZVJvdXRlci5hc2h4JzsKCQkJfQoJCX0gZWxzZSB7CgkJCXRoaXMuc3JVUkwgPSBzclVSTDsKCQl9CgkJdGhpcy5zclVSTCArPSAnP3NydmVyc2lvbj0xJzsKCQlpZiAodGhpcy4kX1JFUVVFU1QoJ2d6aXAnKSkgewoJCQl0aGlzLnNyVVJMICs9ICcmZ3ppcD0nICsgdGhpcy4kX1JFUVVFU1QoJ2d6aXAnKTsKCQl9IGVsc2UgewoJCQl0aGlzLnNyVVJMICs9ICcmZ3ppcD10cnVlJzsKCQl9CgkJaWYgKHRoaXMuYkNhY2hlKSB7CgkJCXRoaXMuc3JVUkwgKz0gJyZjYWNoZT0nICsgdGhpcy5iQ2FjaGU7CgkJfQoJCWlmICghdGhpcy4kX1JFUVVFU1QoJ3JhbmQnLCB0aGlzLnNyVVJMKSkgewoJCQl0aGlzLnNyVVJMICs9ICcmcmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQl9CgoJCWlmICh0aGlzLmJEZWJ1ZykgewoJCQl0aGlzLnNyVVJMICs9ICcmREVCVUc9dHJ1ZSc7CgkJfQoKCQlpZiAoCgkJCXRoaXMuYkFzeW5jICYmCgkJCXRoaXMuYkxvY2FsICYmCgkJCSF0aGlzLiRfUkVRVUVTVCgnYXN5bmMnLCB0aGlzLnNyVVJMKQoJCSkgewoJCQl0aGlzLnNyVVJMICs9ICcmYXN5bmM9dHJ1ZSc7CgkJCWlmICh0aGlzLnJ1bkFmdGVyKSB7CgkJCQl0aGlzLnNyVVJMICs9ICcmcnVuYWZ0ZXI9JyArIHRoaXMucnVuQWZ0ZXI7CgkJCX0KCQkJdGhpcy5iQXN5bmMgPSBmYWxzZTsKCQl9CgoJCS8vdGhpcy5TaG93RGVidWcoJ3RoaXMuc3JVUkw9JyArIHRoaXMuc3JVUkwpOwoKCQlyZXR1cm4gdGhpcy5zclVSTDsKCX0KCglpbml0KAoJCXNyVVJMLAoJCXN5c3RlbU5hbWUsCgkJYlBvc3QsCgkJYkRlYnVnLAoJCWJTaG93RXJyb3JzLAoJCXByZVByb2Nlc3NIVE1MCgkpIHsKCQkvKmlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICd1bmRlZmluZWQnKSB7CgkJCWRvY3VtZW50ID0ge307CgkJCXdpbmRvdyA9IHt9OwoJCX0qLwoJCWlmICghYkRlYnVnICYmIGRvY3VtZW50LlVSTCAmJiBkb2N1bWVudC5VUkwuaW5kZXhPZignZGVidWc9dHJ1ZScpID4gMCkgYkRlYnVnID0gdHJ1ZTsKCgkJdGhpcy5iTG9jYWwgPSAhdGhpcy5TdG9yZSAmJiBkb2N1bWVudC5VUkwgJiYgZG9jdW1lbnQuVVJMLmluZGV4T2YoJ2xvY2FsPWZhbHNlJykgPCAwICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAoIWRvY3VtZW50LlVSTCkgdGhpcy5iTG9jYWwgPSB0cnVlOwoKCQl0aGlzLmJDYWNoZSA9IHRoaXMuJF9SRVFVRVNUKCdjYWNoZScpOwoJCXRoaXMuYkNhY2hlUmVzdWx0ID0gdGhpcy4kX1JFUVVFU1QoJ2NhY2hlUmVzdWx0Jyk7CgoJCXRoaXMuc3JVUkwgPSB0aGlzLmJ1aWxkVVJMKHNyVVJMKTsKCgkJdGhpcy5DUk5MID0gJ1xuJzsKCQl0aGlzLm5NYXhVUkxMZW5ndGggPSAxMDA7CgoJCXRoaXMuc3lzdGVtTmFtZSA9IHN5c3RlbU5hbWU7CgoJCXRoaXMuYlBvc3QgPSBiUG9zdDsKCQl0aGlzLmJEZWJ1ZyA9IGJEZWJ1ZzsKCQl0aGlzLmJTaG93RXJyb3JzID0gYlNob3dFcnJvcnM7CgoJCXRoaXMuc19FcnJvck1lc3NhZ2VzID0gJyc7CgoJCXJldHVybiB0aGlzOwoJfQoKCXByZVByb2Nlc3NIVE1MKGh0bWwpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQl2YXIgcmV0ID0gJyc7CgkJCXZhciBwYXJ0cyA9IGh0bWwuc3BsaXQoJyQkJyk7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKCQkJCWlmIChpICUgMiA9PSAwKSB7CgkJCQkJcmV0ICs9IHBhcnRzW2ldOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJdHJ5IHsKCQkJCQl2YXIgb1ZhbHVlID0gdGhpcy5ydW5TY3JpcHQocGFydHNbaV0pOwoJCQkJCWlmIChvVmFsdWUpIHsKCQkJCQkJcmV0ICs9IG9WYWx1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXQgKz0gJyc7CgkJCQkJfQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXJldCArPSAnJzsKCQkJCX0KCQkJfQoKCQkJaWYgKHByZVByb2Nlc3NIVE1MICE9IG51bGwpIHJldCA9IHByZVByb2Nlc3NIVE1MKHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZSkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCSRfUkVRVUVTVChrZXksIHVybCkgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoKCQlsZXQgcmV0ID0gdW5kZWZpbmVkOwoJCWlmICh1cmwpIHsKCQkJdHJ5IHsKCQkJCXJldCA9IG5ldyBVUkwodXJsKS5zZWFyY2hQYXJhbXMuZ2V0KGtleSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdbXFw/fCZdJyArIGtleSArICc9KFteJiNdKiknKTsKCQkJCXZhciByZXN1bHRzID0gcmVnZXguZXhlYygnPycgKyB1cmwuc3BsaXQoJz8nKVsxXSk7CgkJCQlyZXQgPSAocmVzdWx0cyA9PT0gbnVsbCkgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICcgJykpOwoJCQl9CgkJfSBlbHNlIHsKCQkJcmV0ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoa2V5KTsKCQl9CgoJCXJldHVybiByZXQgPT09IG51bGwgPyAnJyA6IHJldDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWNvbXBpbGUoYXJNb2R1bGVzKSB7CgkJdmFyIGNhbGxzID0gW107CgkJJC5lYWNoKGFyTW9kdWxlcywgKGksIG0pID0+CgkJCWNhbGxzLnB1c2goCgkJCQl0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZGFsbCcsIG51bGwsIHsKCQkJCQlQYWdlOiBtLAoJCQkJfSkKCQkJKQoJCSk7CgkJcmV0dXJuICQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJSZXQpID0+IHsKCQkJdmFyIF9yZXQgPSBbXTsKCQkJJC5tYXAoYXJSZXQsIChwKSA9PiB7CgkJCQlyZXQucHVzaChfLnRlbXBsYXRlKHAuSFRNTCkoc3IucnVuU2NyaXB0KHBbMF0uU2NyaXB0KSkpOwoJCQl9KTsKCQkJcmV0dXJuIF9yZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgaW1wb3J0KGFyTW9kdWxlcykgewoJCXZhciByZXQgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTW9kdWxlcy5sZW5ndGg7IGkrKykgewoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuXygnQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kJywgbnVsbCwgewoJCQkJUGFnZTogYXJNb2R1bGVzW2ldLAoJCQl9KTsKCQkJcmV0LnB1c2gocCk7CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHAuU2NyaXB0KTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglnZXRPYmplY3QocykgewoJCXZhciBjb2RlID0gcyArICc7JzsKCQljb2RlID0gJyh0eXBlb2YgJyArIHMgKyAiID09PSAndW5kZWZpbmVkJyk/c3IubmV3T2JqZWN0KCk6IiArIHM7CgkJLy9yZXR1cm4gdGhpcy5ydW5TY3JpcHQocysiOyIpOwoJCXJldHVybiB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCX0KCglydW5TY3JpcHQocykgewoJCWlmICghcykgcmV0dXJuIG51bGw7CgoJCWxldCBjTGluZXMgPSBzLnNwbGl0KCdcbicpOwoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZXNwcmltYSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQllc3ByaW1hLnBhcnNlKHMsIHsKCQkJCQllczY6IHRydWUKCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJaWYgKGNMaW5lc1tleC5saW5lTnVtYmVyIC0gMV0uaW5kZXhPZignZm9yIGF3YWl0JykgPCAwKSB7CgkJCQljb25zb2xlLmxvZygicnVuU2NyaXB0KCk6OmVzcHJpbWEgZXhjZXB0aW9uOiAiICsgZXguZGVzY3JpcHRpb24sIGV4LmxpbmVOdW1iZXIsIGNMaW5lc1tleC5saW5lTnVtYmVyIC0gMV0pOwoJCQkJLy9yZXR1cm47CgkJCX0KCQl9CgoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJdHJ5IHsKCQkJCWlmICh3aW5kb3cuX2NvbnRlbnQgJiYgd2luZG93Ll9jb250ZW50LmV2YWwpIHsKCQkJCQl2YXIgb3V0cHV0ID0gd2luZG93Ll9jb250ZW50LmV2YWwocyk7CgkJCQkJcmV0dXJuIG91dHB1dDsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJdGhpcy5TaG93RXJyb3IoJ0ZGIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQl9CgkJCXRyeSB7CgkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCS8vIGEgbXVsdGktbGluZSBzdGF0ZW1lbnQKCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCXJldHVybiBudWxsOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQl2YXIgbmV3UyA9ICduZXdWID0gJyArIHM7CgkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KG5ld1MpOwoJCQkJCQlyZXR1cm4gbmV3VjsKCQkJCQl9CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCXRoaXMuU2hvd0Vycm9yKCdJRTYgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCX0KCgkJCXRyeSB7CgkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCS8vIGEgbXVsdGktbGluZSBzdGF0ZW1lbnQKCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCXJldHVybiBudWxsOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQl2YXIgbmV3UyA9ICduZXdWID0gJyArIHM7CgkJCQkJCWV2YWwobmV3Uyk7CgkJCQkJCXJldHVybiBuZXdWOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJdGhpcy5TaG93RXJyb3IoJ0lFNyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJfQoKCQkJdHJ5IHsKCQkJCXZhciBmbiA9IGZ1bmN0aW9uKCkgewoJCQkJCXZhciByZXQgPSB3aW5kb3cuZXZhbC5jYWxsKHdpbmRvdywgcyk7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX07CgoJCQkJcmV0dXJuIGZuKCk7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCXRoaXMuU2hvd0Vycm9yKCdUQUcgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCX0KCQl9CgoJCXRyeSB7CgkJCXMgPSBzLnJlcGxhY2UoL25ldyBEYXRlXCgwMDAxL2csICduZXcgRGF0ZSgxJyk7CgkJCXJldHVybiBldmFsKHMpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJdGhpcy5TaG93RXJyb3IoJ0VWQUwgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJfQoJfQoKCVNob3dPYmplY3QobywgYklnbm9yZURlYnVnKSB7CgkJdmFyIHJldCA9ICdPYmplY3QgU3RydWN0dXJlOlxuJzsKCQlmb3IgKHMgaW4gbykgewoJCQl0cnkgewoJCQkJcmV0ICs9IHMgKyAnOiAnICsgb1tzXSArICdcbic7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCXJldCArPSBzICsgJzogRXhjZXB0aW9uIHdpdGggdmFsdWUgPSAnICsgZS5tZXNzYWdlICsgJ1xuJzsKCQkJfQoJCX0KCgkJdGhpcy5TaG93RGVidWcocmV0LCBiSWdub3JlRGVidWcpOwoJfQoKCVNob3dFcnJvcihzKSB7CgkJY29uc29sZS5sb2cocyk7CgkJaWYgKHRoaXMuYlNob3dFcnJvcnMpIHRoaXMuU2hvd01lc3NhZ2Uocyk7Cgl9CgoJY2NvcHkocykgewoJCWlmICh3aW5kb3cuY2xpcGJvYXJkRGF0YSkgY2xpcGJvYXJkRGF0YS5zZXREYXRhKCdUZXh0Jywgcyk7Cgl9CgoJU2hvd01lc3NhZ2UocykgewoJCWlmICh0eXBlb2Ygbm90eSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBzLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogMjAwMCwKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJdHJ5IHsKCQkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgcyArICc8L3A+PC9kaXY+JykuZGlhbG9nKCk7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWNvbnNvbGUubG9nKHMpOwoJCQl9CgkJfQoJfQoKCVNob3dEZWJ1ZyhzLCBiSWdub3JlRGVidWcpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCWNvbnNvbGUubG9nKCJTaG93RGVidWc6ICIgKyBzKTsKCQl9CgkJaWYgKHRoaXMuYkRlYnVnIHx8IGJJZ25vcmVEZWJ1ZykgdGhpcy5TaG93TWVzc2FnZShzKTsKCX0KCglwYXJhbShhcmdzKSB7CgkJdGhpcy5DUk5MID0gdGhpcy5DUk5MIHx8ICJcbiI7CgkJdmFyIHJldCA9CgkJCScvKicgKwoJCQl0aGlzLkNSTkwgKwoJCQknPCFbQ0RBVEFbJyArCgkJCXRoaXMuQ1JOTCArCgkJCSdQQVJBTUVURVJTJyArCgkJCXRoaXMuQ1JOTCArCgkJCSddXT4nICsKCQkJdGhpcy5DUk5MICsKCQkJJyovJyArCgkJCXRoaXMuQ1JOTCArCgkJCXRoaXMuQ1JOTCArCgkJCSc8cD4nICsKCQkJdGhpcy5DUk5MOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewoJCQl2YXIgeG1sID0gdGhpcy5fdG9YTUwoYXJnc1tpXSk7CgkJCWlmIChmYWxzZSkgewoJCQkJLy8geG1sIGNvbnRhaW5zIGNoYXJhY3RlcnMgdGhhdCB3b3VsZCBub3QgYXJyaXZlIHByb3Blcmx5IGFuZCBzaG91bGQgYmUgY29udmVydGVkIHRvIGJhc2U2NAoJCQkJeG1sID0gYnRvYSh4bWwpOwoJCQl9CgkJCXJldCArPSAnPHAnICsgaSArICc+JyArIHRoaXMuQ1JOTCArIHhtbCArICcnICsgdGhpcy5DUk5MOwoJCQlyZXQgKz0gJzwvcCcgKyBpICsgJz4nICsgdGhpcy5DUk5MOwoJCX0KCQlyZXQgKz0gJzwvcD4nICsgdGhpcy5DUk5MOwoJCXJldHVybiByZXQ7Cgl9CgoJcmVzZXRDdXJzb3IoKSB7CgkJaWYgKCFkb2N1bWVudC5ib2R5KSByZXR1cm47CgkJZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnYXJyb3cnOwoJCWRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJyc7Cgl9CgoJc2VydmVyRGF0ZShkKSB7CgkJbGV0IHRkID0gMDsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSB7CgkJCXRkID0gd2luZG93LnRpbWVEaWZmZXJlbmNlOwoJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCXRkID0gZ2xvYmFsLnRpbWVEaWZmZXJlbmNlOwoJCX0gZWxzZSBpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGQgPSBzZWxmLnRpbWVEaWZmZXJlbmNlOwoJCX0KCQlyZXR1cm4gdGhpcy5hZGRNU2Vjb25kcyhkIHx8IG5ldyBEYXRlKCksIC10ZCk7Cgl9CgoJcnVuU1JTY3JpcHQocykgewoJCXJldHVybiB0aGlzLnJ1blNjcmlwdCgKCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJcyArCgkJCScgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIil7d2luZG93Lm1ldGhvZF9uYW1lID0gbWV0aG9kX25hbWU7IHdpbmRvdy5zZXJ2ZXJfdGltZSA9IHNlcnZlcl90aW1lOyB3aW5kb3cuX2V4Y2VwdGlvbiA9IHR5cGVvZihfZXhjZXB0aW9uKT09PSJ1bmRlZmluZWQiP251bGw6X2V4Y2VwdGlvbjsgd2luZG93LmV4ZWN1dGlvbl90aW1lID0gZXhlY3V0aW9uX3RpbWU7fSByZXR1cm4ge19leGNlcHRpb246IHR5cGVvZihfZXhjZXB0aW9uKT09PSJ1bmRlZmluZWQiP251bGw6X2V4Y2VwdGlvbiwgbWV0aG9kX25hbWU6IG1ldGhvZF9uYW1lLCBzZXJ2ZXJfdGltZTogc2VydmVyX3RpbWUsIGV4ZWN1dGlvbl90aW1lOiBleGVjdXRpb25fdGltZSwgcmV0OiByZXR9O30pKCk7JwoJCSk7Cgl9CgoJYXN5bmMgcHJvY2Vzc1Jlc3VsdChyZXMpIHsKCQlpZiAoIXJlcyB8fCAhcmVzLkNvZGUgfHwgIXJlcy5TdG9yZWRNZXRob2QpIHsKCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJcmV0dXJuIHJlczsKCQl9CgoJCS8vIGZvciBzdXJlIGEgbWV0aG9kIHJlc3VsdCBmcm9tIGFuIGFzeW5jIGNhbGwKCQlpZiAocmVzLlJlc3VsdCkgewoJCQkvLyB3ZSBnb3QgYSByZXN1bHQKCQkJdmFyIF9fcmV0ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCV9fcmV0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgbnVsbCwgcmVzLlJlc3VsdCwgbnVsbCk7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCV9fcmV0ID0gcmVzLlJlc3VsdDsKCQkJfQoJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQlyZXR1cm4gX19yZXQ7CgkJfQoKCQl2YXIgdGltZW91dCA9IHJlcy5SdW5BZnRlciAtIHJlcy5EYXRlOwoJCWlmICh0aW1lb3V0IDw9IDApIHsKCQkJLy8gbmVnYXRpdmUgdGltZW91dCBtZWFucyB0aGF0IGl0IHdhcyBzdXBwb3NlZCB0byBiZSBydW4gYnV0IGRpZCBub3QgZm9yIHNvbWUgcmVhc29uIChkZWxheSwgZmFpbHVyZSwgZXRjLi4uKQoJCQkvLyBzYW1lIGRhdGUgYXMgcnVuYWZ0ZXIgbWVhbnMgdGhhdCB3ZSBhcmUgdXNpbmcgdGhlIGltbWVkaWF0ZSBhc3luYyBleGVjdXRpb24uIGkuZS4gdGhlcmUgaXMgbm8gbmVlZCBmb3IgdGhlIHJ1bm5lciB0aHJlYWQgdGFzawoJCQl0aW1lb3V0ID0gMzAwMDA7CgkJfSBlbHNlIGlmICh0aW1lb3V0ID4gNSAqIDYwICogMTAwMCkgewoJCQkvLyBtb3JlIHRoYW4gd2UgY2FuIHdhaXQsIHdlIHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgcmVzdWx0CgkJCWNvbnNvbGUubG9nKAoJCQkJJ1dlIGNhbm5vdCB3YWl0ICcgKwoJCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQkJJyBzZWNvbmRzLiBSZXR1cm5pbmcgcmVzdWx0LicKCQkJKTsKCQkJcmV0dXJuIHJlczsKCQl9CgkJY29uc29sZS5sb2coCgkJCSdNYWtpbmcgdGhlIG5leHQgY2FsbCBpbiAnICsKCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQknIHNlY29uZHMuJwoJCSk7CgoJCWF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpKTsKCQlpZiAoIXRoaXMuQWN0aXZlUmVxdWVzdCkgewoJCQljb25zb2xlLmxvZygnTm8gQWN0aXZlUmVxdWVzdCwgZXhpdGluZy4uLicpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6ICcvbWV0aG9kL2EuYXNoeD9uYW1lPUNvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQmcDA9e0NvZGV9JyArCgkJCQkJcmVzLkNvZGUgKwoJCQkJCSd7L0NvZGV9e0lkfScgKwoJCQkJCXJlcy5JZCArCgkJCQkJJ3svSWR9JnJhbmQ9JyArCgkJCQkJTWF0aC5yYW5kb20oKSwKCQkJfSk7CgkJCXJldCA9IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKDQsIG51bGwsIHJldCwgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCk7CgkJCXJldCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdChyZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCdwcm9jZXNzUmVzdWx0JywgZXgpOwoJCQlyZXR1cm4gYXdhaXQgdGhpcy5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kJywgbnVsbCwgewoJCQkJQ29kZTogcmVzLkNvZGUsCgkJCQlJZDogcmVzLklkLAoJCQl9KTsKCQl9Cgl9CgoJcHJvY2Vzc1Jlc3BvbnNlKHJlYWR5U3RhdGUsIGNhbGxCYWNrLCByZXNwb25zZVRleHQsIHVybCkgewoJCWlmIChbNCwgNDRdLmluZGV4T2YocmVhZHlTdGF0ZSkgPT0gLTEpIHJldHVybjsKCgkJdmFyIHNNZXRob2ROYW1lID0gdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCB1cmwpOwoKCQl0cnkgewoJCQlpZiAocmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQlsZXQgcmVzID0gKGFzeW5jICgpID0+IHsKCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdChudWxsLCByZXNwb25zZVRleHQpOwoJCQkJfSkoKTsKCQkJfQoKCQkJLy9yZXQgPSBudWxsOwoJCQkvL3NlcnZlcl90aW1lID0gbnVsbDsKCQkJLy9fZXhjZXB0aW9uID0gbnVsbDsKCQkJdmFyIGJTY3JpcHRFcnJvciA9IGZhbHNlOwoJCQl2YXIgX3JldCA9IG51bGw7CgkJCXRyeSB7CgkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBlOwoJCQkJYlNjcmlwdEVycm9yID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKF9yZXQgJiYgX3JldC5zZXJ2ZXJfdGltZSkgewoJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCgkJCQl0cnkgewoJCQkJCXdpbmRvdy50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQlnbG9iYWwudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCX0KCQkJfQoKCQkJaWYgKF9yZXQgJiYgX3JldC5fZXhjZXB0aW9uKSB7CgkJCQl0aGlzLlNob3dEZWJ1ZyhfZXhjZXB0aW9uLk1lc3NhZ2UpOwoJCQl9CgoJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJdmFyIGNhbGxSZXQgPSBudWxsOwoJCQkJdHJ5IHsKCQkJCQljYWxsUmV0ID0gY2FsbEJhY2soX3JldC5yZXQsIF9yZXQuX2V4Y2VwdGlvbik7CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCSdFcnJvciBpbiBDYWxsYmFjazpcblxuJyArIGNhbGxCYWNrICsgJ1xuXG4nICsgZS5tZXNzYWdlCgkJCQkJKTsKCQkJCX0KCQkJCWlmICgKCQkJCQl0eXBlb2YgX3JldC5tZXRob2RfbmFtZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCQl0eXBlb2Ygc01ldGhvZE5hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJc01ldGhvZE5hbWUgIT0gX3JldC5tZXRob2RfbmFtZQoJCQkJKSB7CgkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCSdNaXNtYXRjaCBpbiBNZXRob2QgYmV0d2VlbiBzZXJ2ZXIgYW5kIGNsaWVudDpcblNlcnZlciBNZXRob2QgTmFtZTogJyArCgkJCQkJCV9yZXQubWV0aG9kX25hbWUgKwoJCQkJCQknXG5DbGllbnQgTWV0aG9kIE5hbWU6ICcgKwoJCQkJCQlzTWV0aG9kTmFtZQoJCQkJCSk7CgkJCQl9CgkJCQkoCgkJCQkJdGhpcy5mTG9hZGluZ0VuZCB8fAoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQl3aW5kb3cuc3IucmVzZXRDdXJzb3IoKTsKCQkJCQl9CgkJCQkpKCk7CgoJCQkJcmV0dXJuICgKCQkJCQljYWxsUmV0IHx8IF9yZXQucmV0IHx8IChiU2NyaXB0RXJyb3IgPyByZXNwb25zZVRleHQgOiBudWxsKQoJCQkJKTsKCQkJfSBlbHNlIHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIpIHRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCXJldHVybiAoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQl0aHJvdyBlOwoJCQl9CgkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJdGhpcy5TaG93RXJyb3IoJ0Vycm9yIGluIGNvZGU6ICcgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcmVzcG9uc2VUZXh0KTsKCQl9CgoJCXJldHVybiBudWxsOwoJfQoKCWlzT2JqZWN0KG8pIHsKCQlyZXR1cm4gKAoJCQlvICE9IG51bGwgJiYKCQkJdHlwZW9mIG8gPT0gJ29iamVjdCcgJiYKCQkJIShvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSkgJiYKCQkJIShvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEpCgkJKTsKCX0KCglfdG9KUyhvKSB7CgkJaWYgKG8gPT0gbnVsbCkgcmV0dXJuICdudWxsJzsKCgkJdmFyIHMgPSAnJzsKCQlzd2l0Y2ggKHR5cGVvZiBvKSB7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlzICs9CgkJCQkJJyInICsKCQkJCQl0aGlzLm15UmVwbGFjZSgKCQkJCQkJdGhpcy5lc2NhcGVTdHJpbmcobyksCgkJCQkJCVsnIjogLCddLAoJCQkJCQlbJyI6IG51bGwsJ10KCQkJCQkpICsKCQkJCQknIic7CgkJCQlicmVhazsKCQkJY2FzZSAnbnVtYmVyJzoKCQkJCXMgKz0gbzsKCQkJCWJyZWFrOwoJCQljYXNlICdib29sZWFuJzoKCQkJCXMgKz0gbyA/ICd0cnVlJyA6ICdmYWxzZSc7CgkJCQlicmVhazsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCS8vIERhdGUKCQkJCWlmIChvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSkgewoJCQkJCXZhciB5ZWFyID0gby5nZXRGdWxsWWVhcigpLnRvU3RyaW5nKCk7CgkJCQkJLy92YXIgbW9udGggPSAoby5nZXRNb250aCgpICsgMSkudG9TdHJpbmcoKTsgbW9udGggPSAobW9udGgubGVuZ3RoID09IDEpID8gIjAiICsgbW9udGggOiBtb250aDsKCQkJCQl2YXIgbW9udGggPSBvLmdldE1vbnRoKCkudG9TdHJpbmcoKTsKCQkJCQltb250aCA9IG1vbnRoLmxlbmd0aCA9PSAxID8gJzAnICsgbW9udGggOiBtb250aDsKCQkJCQl2YXIgZGF0ZSA9IG8uZ2V0RGF0ZSgpLnRvU3RyaW5nKCk7CgkJCQkJZGF0ZSA9IGRhdGUubGVuZ3RoID09IDEgPyAnMCcgKyBkYXRlIDogZGF0ZTsKCQkJCQl2YXIgaG91cnMgPSBvLmdldEhvdXJzKCkudG9TdHJpbmcoKTsKCQkJCQlob3VycyA9IGhvdXJzLmxlbmd0aCA9PSAxID8gJzAnICsgaG91cnMgOiBob3VyczsKCQkJCQl2YXIgbWludXRlcyA9IG8uZ2V0TWludXRlcygpLnRvU3RyaW5nKCk7CgkJCQkJbWludXRlcyA9IG1pbnV0ZXMubGVuZ3RoID09IDEgPyAnMCcgKyBtaW51dGVzIDogbWludXRlczsKCQkJCQl2YXIgc2Vjb25kcyA9IG8uZ2V0U2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJc2Vjb25kcyA9IHNlY29uZHMubGVuZ3RoID09IDEgPyAnMCcgKyBzZWNvbmRzIDogc2Vjb25kczsKCQkJCQl2YXIgbWlsbGlzZWNvbmRzID0gby5nZXRNaWxsaXNlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCXZhciB0em1pbnV0ZXMgPSBNYXRoLmFicyhvLmdldFRpbWV6b25lT2Zmc2V0KCkpOwoJCQkJCXZhciB0emhvdXJzID0gMDsKCQkJCQl3aGlsZSAodHptaW51dGVzID49IDYwKSB7CgkJCQkJCXR6aG91cnMrKzsKCQkJCQkJdHptaW51dGVzIC09IDYwOwoJCQkJCX0KCQkJCQl0em1pbnV0ZXMgPQoJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCScwJyArIHR6bWludXRlcy50b1N0cmluZygpIDoKCQkJCQkJdHptaW51dGVzLnRvU3RyaW5nKCk7CgkJCQkJdHpob3VycyA9CgkJCQkJCXR6aG91cnMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCScwJyArIHR6aG91cnMudG9TdHJpbmcoKSA6CgkJCQkJCXR6aG91cnMudG9TdHJpbmcoKTsKCQkJCQl2YXIgdGltZXpvbmUgPQoJCQkJCQkoby5nZXRUaW1lem9uZU9mZnNldCgpIDwgMCA/ICcrJyA6ICctJykgKwoJCQkJCQl0emhvdXJzICsKCQkJCQkJJzonICsKCQkJCQkJdHptaW51dGVzOwoJCQkJCXMgKz0KCQkJCQkJJ25ldyBEYXRlKCcgKwoJCQkJCQl5ZWFyICsKCQkJCQkJJywnICsKCQkJCQkJbW9udGggKwoJCQkJCQknLCcgKwoJCQkJCQlkYXRlICsKCQkJCQkJJywnICsKCQkJCQkJaG91cnMgKwoJCQkJCQknLCcgKwoJCQkJCQltaW51dGVzICsKCQkJCQkJJywnICsKCQkJCQkJc2Vjb25kcyArCgkJCQkJCScsJyArCgkJCQkJCW1pbGxpc2Vjb25kcyArCgkJCQkJCScpJzsKCQkJCX0KCQkJCS8vIEFycmF5CgkJCQllbHNlIGlmIChvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEpIHsKCQkJCQlzICs9ICdbJzsKCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJcyArPSAnJzsKCQkJCQkJaWYgKCFpc05hTihwKSkgewoJCQkJCQkJLy8gbGluZWFyIGFycmF5CgkJCQkJCQlzICs9IHRoaXMuX3RvSlMob1twXSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBhc3NvY2lhdGl2ZSBhcnJheQoJCQkJCQkJcyArPSAneyInICsgcCArICciOiAnICsgdGhpcy5fdG9KUyhvW3BdKSArICd9JzsKCQkJCQkJfQoJCQkJCQlzICs9ICcsICc7CgkJCQkJfQoJCQkJCXMgKz0gJ10nOwoJCQkJfQoJCQkJLy8gT2JqZWN0IG9yIGN1c3RvbSBmdW5jdGlvbgoJCQkJZWxzZSB7CgkJCQkJcyArPSAneyc7CgkJCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQkJCXMgKz0gJyInICsgcCArICciOiAnICsgdGhpcy5fdG9KUyhvW3BdKSArICcsICc7CgkJCQkJfQoJCQkJCWlmIChzLmxhc3RJbmRleE9mKCcsICcpID09IHMubGVuZ3RoIC0gMikKCQkJCQkJcyA9IHMuc3Vic3RyaW5nKDAsIHMubGVuZ3RoIC0gMik7CgkJCQkJcyArPSAnfSc7CgkJCQl9CgkJCQlicmVhazsKCQkJY2FzZSAnZnVuY3Rpb24nOgoJCQkJLy8gZnVuY3Rpb25zIGFyZSBub3Qgd29ya2luZywgSUxMRUdBTCBUT0tFTi4uLi4KCQkJCS8vcyArPSAiXCIiK3RoaXMuZXNjYXBlU3RyaW5nKG8udG9TdHJpbmcoKSkrIlwiIjsKCQkJCXMgKz0gJ251bGwnOwoJCQkJYnJlYWs7CgkJCWRlZmF1bHQ6CgkJCQlzICs9ICdudWxsJzsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJZXNjYXBlU3RyaW5nKHRleHQpIHsKCQlpZiAoIWFyZ3VtZW50cy5jYWxsZWUuc1JFKSB7CgkJCXZhciBzcGVjaWFscyA9IFsKCQkJCSdccicsCgkJCQknXG4nLAoJCQkJJ1xmJywKCQkJCSdcYicsCgkJCQknXHQnLAoJCQkJIiciLAoJCQkJJyYnLAoJCQkJJy8nLAoJCQkJJy4nLAoJCQkJJyonLAoJCQkJJysnLAoJCQkJJz8nLAoJCQkJJ3wnLAoJCQkJJygnLAoJCQkJJyknLAoJCQkJJ1snLAoJCQkJJ10nLAoJCQkJJ3snLAoJCQkJJ30nLAoJCQkJJ1xcJywKCQkJCSciJywKCQkJXTsKCQkJYXJndW1lbnRzLmNhbGxlZS5zUkUgPSBuZXcgUmVnRXhwKAoJCQkJJyhcXCcgKyBzcGVjaWFscy5qb2luKCd8XFwnKSArICcpJywKCQkJCSdnJwoJCQkpOwoJCX0KCQl2YXIgcmV0ID0gdGV4dC5yZXBsYWNlKGFyZ3VtZW50cy5jYWxsZWUuc1JFLCAnXFwkMScpOwoKCQlyZXQgPSB0aGlzLm15UmVwbGFjZShyZXQsIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pOwoJCXJldCA9IHRoaXMubXlSZXBsYWNlKAoJCQlyZXQsCgkJCVsnXHInLCAnXG4nLCAnXHQnXSwKCQkJWydcXCcgKyAncicsICdcXCcgKyAnbicsICdcXCcgKyAndCddCgkJKTsKCgkJcmV0dXJuIHJldDsKCX0KCglpcEFkZHJlc3MoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIG51bGw7CgkJCWlmICh0eXBlb2YoZ2xvYmFsKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGdsb2JhbC5vcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiaXBBZGRyZXNzKCk6IEludmFsaWQgZ2xvYmFsIG9yIGdsb2JhbC5vcyBub3QgZGVmaW5lZCIpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIFtdLmNvbmNhdCguLi5PYmplY3QudmFsdWVzKGdsb2JhbC5vcy5uZXR3b3JrSW50ZXJmYWNlcygpKSkuZmluZCgoZGV0YWlscykgPT4gZGV0YWlscy5mYW1pbHkgPT09ICdJUHY0JyAmJiAhZGV0YWlscy5pbnRlcm5hbCkuYWRkcmVzczsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiaXBBZGRyZXNzKCk6ICIgKyBleCk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdG9YTUwobywgbGV2ZWwpIHsKCQlpZiAoIWxldmVsKSBsZXZlbCA9IDA7CgkJdmFyIHMgPSAnJzsKCQlpZiAobyA9PSBudWxsKSByZXR1cm4gczsKCQlzd2l0Y2ggKHR5cGVvZiBvKSB7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlzICs9ICc8IVtDREFUQVsnICsgbyArICddXT4nOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ251bWJlcic6CgkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQkJcyArPSBvLnRvU3RyaW5nKCk7CgkJCQlicmVhazsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCS8vIERhdGUKCQkJCWlmICgKCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ2Z1bmN0aW9uIERhdGUoKScpID4gLTEgJiYKCQkJCQlvLmNvbnN0cnVjdG9yLm5hbWUgPT0gIkRhdGUiCgkJCQkpIHsKCQkJCQl2YXIgeWVhciA9IG8uZ2V0VVRDRnVsbFllYXIoKS50b1N0cmluZygpOwoJCQkJCXZhciBtb250aCA9IChvLmdldFVUQ01vbnRoKCkgKyAxKS50b1N0cmluZygpOwoJCQkJCW1vbnRoID0gbW9udGgubGVuZ3RoID09IDEgPyAnMCcgKyBtb250aCA6IG1vbnRoOwoJCQkJCXZhciBkYXRlID0gby5nZXRVVENEYXRlKCkudG9TdHJpbmcoKTsKCQkJCQlkYXRlID0gZGF0ZS5sZW5ndGggPT0gMSA/ICcwJyArIGRhdGUgOiBkYXRlOwoJCQkJCXZhciBob3VycyA9IG8uZ2V0VVRDSG91cnMoKS50b1N0cmluZygpOwoJCQkJCWhvdXJzID0gaG91cnMubGVuZ3RoID09IDEgPyAnMCcgKyBob3VycyA6IGhvdXJzOwoJCQkJCXZhciBtaW51dGVzID0gby5nZXRVVENNaW51dGVzKCkudG9TdHJpbmcoKTsKCQkJCQltaW51dGVzID0gbWludXRlcy5sZW5ndGggPT0gMSA/ICcwJyArIG1pbnV0ZXMgOiBtaW51dGVzOwoJCQkJCXZhciBzZWNvbmRzID0gby5nZXRVVENTZWNvbmRzKCkudG9TdHJpbmcoKTsKCQkJCQlzZWNvbmRzID0gc2Vjb25kcy5sZW5ndGggPT0gMSA/ICcwJyArIHNlY29uZHMgOiBzZWNvbmRzOwoJCQkJCXZhciBtaWxsaXNlY29uZHMgPSBvLmdldFVUQ01pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJdmFyIHR6bWludXRlcyA9IE1hdGguYWJzKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSk7CgkJCQkJdmFyIHR6aG91cnMgPSAwOwoJCQkJCXdoaWxlICh0em1pbnV0ZXMgPj0gNjApIHsKCQkJCQkJdHpob3VycysrOwoJCQkJCQl0em1pbnV0ZXMgLT0gNjA7CgkJCQkJfQoJCQkJCXR6bWludXRlcyA9CgkJCQkJCXR6bWludXRlcy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJJzAnICsgdHptaW51dGVzLnRvU3RyaW5nKCkgOgoJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKTsKCQkJCQl0emhvdXJzID0KCQkJCQkJdHpob3Vycy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJJzAnICsgdHpob3Vycy50b1N0cmluZygpIDoKCQkJCQkJdHpob3Vycy50b1N0cmluZygpOwoJCQkJCXZhciB0aW1lem9uZSA9CgkJCQkJCShvLmdldFRpbWV6b25lT2Zmc2V0KCkgPCAwID8gJysnIDogJy0nKSArCgkJCQkJCXR6aG91cnMgKwoJCQkJCQknOicgKwoJCQkJCQl0em1pbnV0ZXM7CgkJCQkJLy9zICs9IHllYXIgKyAiLSIgKyBtb250aCArICItIiArIGRhdGUgKyAiVCIgKyBob3VycyArICI6IiArIG1pbnV0ZXMgKyAiOiIgKyBzZWNvbmRzICsgIi4iICsgbWlsbGlzZWNvbmRzICsgdGltZXpvbmU7CgkJCQkJcyArPQoJCQkJCQltb250aCArCgkJCQkJCScvJyArCgkJCQkJCWRhdGUgKwoJCQkJCQknLycgKwoJCQkJCQl5ZWFyICsKCQkJCQkJJyAnICsKCQkJCQkJaG91cnMgKwoJCQkJCQknOicgKwoJCQkJCQltaW51dGVzICsKCQkJCQkJJzonICsKCQkJCQkJc2Vjb25kczsKCQkJCX0KCQkJCS8vIEFycmF5CgkJCQllbHNlIGlmICgKCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ0FycmF5KCknKSA+IC0xCgkJCQkpIHsKCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJaWYgKHAgPT0gJ09QRVJBVE9SUycgfHwgcCA9PSAnT1JTJykgY29udGludWU7CgkJCQkJCXMgKz0gJzxPYmplY3Q+JzsKCQkJCQkJaWYgKCFpc05hTihwKSkgewoJCQkJCQkJLy8gbGluZWFyIGFycmF5CgkJCQkJCQlpZiAob1twXSA9PSBudWxsKSB7CgkJCQkJCQkJLy8gbnVsbCBlbnRyeSBpbiB0aGUgYXJyYXkKCQkJCQkJCQlzICs9ICc8SWQ+MDwvSWQ+JzsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJL2Z1bmN0aW9uXHMrKFx3KilccypcKC9naS5leGVjKAoJCQkJCQkJCQlvW3BdLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkKCQkJCQkJCQkpOwoJCQkJCQkJCXZhciB0eXBlID0gUmVnRXhwLiQxOwoJCQkJCQkJCXN3aXRjaCAodHlwZSkgewoJCQkJCQkJCQljYXNlICcnOgoJCQkJCQkJCQkJdHlwZSA9IHR5cGVvZiBvW3BdOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQkJCQkJCQl0eXBlID0gJ3N0cmluZyc7CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJY2FzZSAnTnVtYmVyJzoKCQkJCQkJCQkJCXR5cGUgPSAnaW50JzsKCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQljYXNlICdCb29sZWFuJzoKCQkJCQkJCQkJCXR5cGUgPSAnYm9vbCc7CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJY2FzZSAnRGF0ZSc6CgkJCQkJCQkJCQl0eXBlID0gJ0RhdGVUaW1lJzsKCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCX0KCQkJCQkJCQlzICs9IHRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gYXNzb2NpYXRpdmUgYXJyYXkKCQkJCQkJCXMgKz0KCQkJCQkJCQknPCcgKwoJCQkJCQkJCXAgKwoJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJJz4nICsKCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJJzwvJyArCgkJCQkJCQkJcCArCgkJCQkJCQkJJz4nOwoJCQkJCQl9CgkJCQkJCXMgKz0gJzwvT2JqZWN0PicgKyB0aGlzLkNSTkw7CgkJCQkJfQoJCQkJfQoJCQkJLy8gT2JqZWN0IG9yIGN1c3RvbSBmdW5jdGlvbgoJCQkJZWxzZSB7CgkJCQkJaWYgKG8gPT0gbnVsbCB8fCBvLklkID09IDApIHt9IGVsc2UgaWYgKGZhbHNlICYmIG8uSWQpIHsKCQkJCQkJLy8gdGhpcyBpcyBjcmVhdGluZyBhIHByb2JsZW0sIGJldHRlciBzZW5kIGFsbCB0aGUgb2JqZWN0CgkJCQkJCS8vIGRvIG5vdCBzZW5kIG90aGVyIGRhdGEgaWYgd2UgaGF2ZSBhIHZhbHVlIGZvciB0aGUgSWQKCQkJCQkJcyArPSAnPElkPicgKyB0aGlzLl90b1hNTChvLklkLCBsZXZlbCsrKSArICc8L0lkPic7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJCXMgKz0KCQkJCQkJCQknPCcgKwoJCQkJCQkJCXAgKwoJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJdGhpcy5PUihvLCBwKSArCgkJCQkJCQkJJz4nICsKCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJJzwvJyArCgkJCQkJCQkJcCArCgkJCQkJCQkJJz4nOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiBzOwoJfQoKCU9SKG8sIHApIHsKCQlyZXR1cm4gby5PUlMgJiYgby5PUlNbcF0gPwoJCQkiIE9SPSciICsKCQkJdGhpcy5teVJlcGxhY2Uoby5PUlNbcF0sIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pICsKCQkJIiciIDoKCQkJJyc7Cgl9CgoJY29vcChvLCBwKSB7CgkJaWYgKCFvLk9QRVJBVE9SUyB8fCAhby5PUEVSQVRPUlNbcF0pIHsKCQkJcmV0dXJuICcnOwoJCX0KCQlyZXR1cm4gKAoJCQkiIGNvb3A9JyIgKwoJCQl0aGlzLm15UmVwbGFjZShvLk9QRVJBVE9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkiJyIKCQkpOwoJfQoKCWdldFhtbEhUVFAoKSB7CgkJdmFyIHggPSBudWxsOwoJCXZhciBhY3RpdmV4bW9kZXMgPSBbJ01zeG1sMi5YTUxIVFRQJywgJ01pY3Jvc29mdC5YTUxIVFRQJ107IC8vYWN0aXZlWCB2ZXJzaW9ucyB0byBjaGVjayBmb3IgaW4gSUUKCQlpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKCQkJLy9UZXN0IGZvciBzdXBwb3J0IGZvciBBY3RpdmVYT2JqZWN0IGluIElFIGZpcnN0IChhcyBYTUxIdHRwUmVxdWVzdCBpbiBJRTcgaXMgYnJva2VuKQoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFjdGl2ZXhtb2Rlcy5sZW5ndGg7IGkrKykgewoJCQkJdHJ5IHsKCQkJCQl4ID0gbmV3IEFjdGl2ZVhPYmplY3QoYWN0aXZleG1vZGVzW2ldKTsKCQkJCQlicmVhazsKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkvL3N1cHByZXNzIGVycm9yCgkJCQl9CgkJCX0KCQl9IGVsc2UgaWYgKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgewoJCQkvLyBpZiBNb3ppbGxhLCBTYWZhcmkgZXRjCgkJCXggPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCQl9IGVsc2UgewoJCQl4ID0gbnVsbDsKCQl9CgoJCXJldHVybiAod2luZG93LnhtbEhUVFAgPSB4KTsKCX0KCglhc3luYyBjYWNoZVJlc3VsdChyZXF1ZXN0LCB0ZXh0cmVzcG9uc2UpIHsKCQlpZiAoIXRoaXMuYkNhY2hlUmVzdWx0KSByZXR1cm47CgkJcmVxdWVzdCA9IHJlcXVlc3QgfHwgdGhpcy5BY3RpdmVSZXF1ZXN0OwoKCQlpZiAoIXJlcXVlc3QpIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKAoJCQl0ZXh0cmVzcG9uc2UgJiYKCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5Db2RlID0gJykgPiAtMSAmJgoJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LlJ1bkFmdGVyID0gJykgPiAtMSAmJgoJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LlJlc3VsdCA9ICIiJykgPiAtMQoJCSkgewoJCQljb25zb2xlLmxvZygndGV4dHJlc3BvbnNlIGNvbnRpYW5zIGluY29tcGxldGUgbWV0aG9kIHJlc3VsdCcpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXZhciBzTWV0aG9kID0gdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCByZXF1ZXN0LlVSTCk7CgkJc01ldGhvZCA9IHNNZXRob2Quc3Vic3RyaW5nKHNNZXRob2QubGFzdEluZGV4T2YoJy4nKSArIDEpOwoJCXRyeSB7CgkJCXZhciBfdXNhYmxlID0gKHIpID0+IHsKCQkJCXZhciBpdGVtID0KCQkJCQkociAmJgoJCQkJCQlyLmhhc2ggPT0gcmVxdWVzdC5oYXNoICYmCgkJCQkJCShyLlVSTCA9PSByZXF1ZXN0LlVSTCB8fCB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHIuVVJMKSA9PSBzTWV0aG9kKSAmJgoJCQkJCQlyLlRleHRSZXNwb25zZSAmJgoJCQkJCQkodHlwZW9mIHIuRXhwaXJlcyA9PT0gJ3VuZGVmaW5lZCcgfHwKCQkJCQkJCW5ldyBEYXRlKHIuRXhwaXJlcykgPiBuZXcgRGF0ZSgpKSkgPwoJCQkJCXIgOgoJCQkJCW51bGw7CgkJCQlpZiAodGV4dHJlc3BvbnNlKSB7CgkJCQkJaXRlbSA9IGl0ZW0gfHwgcmVxdWVzdDsKCQkJCQlpdGVtLlRleHRSZXNwb25zZSA9IHRleHRyZXNwb25zZTsKCQkJCQlpdGVtLkV4cGlyZXMgPSBuZXcgRGF0ZSgKCQkJCQkJbmV3IERhdGUoKS5nZXRUaW1lKCkgKwoJCQkJCQlwYXJzZUZsb2F0KAoJCQkJCQkJdGhpcy5uQ2FjaGVFeHBpcmVIb3VycyB8fCB0aGlzLiRfUkVRVUVTVCgnbkNhY2hlRXhwaXJlSG91cnMnKSB8fCAxCgkJCQkJCSkgKgoJCQkJCQk2MCAqCgkJCQkJCTYwICoKCQkJCQkJMTAwMAoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIGl0ZW07CgkJCX07CgoJCQlpZiAoCgkJCQl0aGlzLmJDYWNoZVJlc3VsdCA9PSAna3ZzdG9yZScgJiYKCQkJCXR5cGVvZiB3aW5kb3cuY29tcGFueS5yZXN0aW9kYlNldHRpbmdzICE9PSAndW5kZWZpbmVkJwoJCQkpIHsKCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJdmFyIHJldCA9IGNvbXBhbnkucmVzdGlvZGJTZXR0aW5ncygpOwoJCQkJCXJldC51cmwgKz0gJ2t2c3RvcmUnOwoJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCS8vIHVwZGF0ZSByZWNvcmQKCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQlyZXQubWV0aG9kID0gJ1BVVCc7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQlyZXQubWV0aG9kID0gJ1BPU1QnOwoJCQkJCQl9CgkJCQkJCXJldC5kYXRhID0gSlNPTi5zdHJpbmdpZnkoewoJCQkJCQkJa2V5OiBrZXksCgkJCQkJCQl2YWx1ZTogSlNPTi5zdHJpbmdpZnkodmFsdWUsIG51bGwsIDQpLAoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQlyZXQubWV0aG9kID0gJ0RFTEVURSc7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXQubWV0aG9kID0gJ0dFVCc7CgkJCQkJCQlyZXQudXJsICs9ICc/cT17ImtleSI6JyArIGtleSArICd9JzsKCQkJCQkJfQoJCQkJCX0KCQkJCQkvL2NvbnNvbGUubG9nKCdtZXRob2QnLCByZXQubWV0aG9kKTsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfTsKCgkJCQlsZXQgcmVjb3JkID0gYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoKSk7CgkJCQlsZXQgciA9CgkJCQkJcmVjb3JkICYmIHJlY29yZC5sZW5ndGggPwoJCQkJCUpTT04ucGFyc2UocmVjb3JkWzBdLnZhbHVlKSA6CgkJCQkJbnVsbDsKCQkJCWxldCBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQlpZiAoIWl0ZW0pIHsKCQkJCQlpZiAocikgewoJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZFswXS5faWQpKTsKCQkJCQl9CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJYWpheChpdGVtLmhhc2gsIGl0ZW0sIHIgPyByZWNvcmRbMF0uX2lkIDogbnVsbCkKCQkJCQkpOwoJCQkJCXJldHVybiBpdGVtOwoJCQkJfQoKCQkJCXJldHVybiBpdGVtOwoJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdzcicpIHsKCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJdmFyIG1ldGhvZCA9ICdGaW5kJzsKCQkJCQl2YXIgcmV0ID0gewoJCQkJCQl1cmw6ICcvbWV0aG9kL2EuYXNoeD9uYW1lPUNvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdCcsCgkJCQkJCXByb2Nlc3NEYXRhOiBmYWxzZSwKCQkJCQkJdHlwZTogJ1BPU1QnLAoJCQkJCX07CgkJCQkJaWYgKHZhbHVlKSB7CgkJCQkJCWlmIChpZCkgewoJCQkJCQkJLy8gdXBkYXRlIHJlY29yZAoJCQkJCQkJbWV0aG9kID0gJ1VwZGF0ZSc7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQltZXRob2QgPSAnSW5zZXJ0JzsKCQkJCQkJfQoJCQkJCQlyZXQuYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCQlyZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoCgkJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkJKTsKCQkJCQkJfTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXQudHlwZSA9ICdHRVQnOwoJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCW1ldGhvZCA9ICdEZWxldGUnOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gZ2V0IHJlY29yZAoJCQkJCQkJbWV0aG9kID0gJ0ZpbmQnOwoJCQkJCQl9CgkJCQkJCW1ldGhvZCArPQoJCQkJCQkJJyZwMD17Q29kZX0nICsKCQkJCQkJCShjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsKCQkJCQkJCWtleSArCgkJCQkJCQkney9Db2RlfSc7CgkJCQkJfQoJCQkJCXJldC51cmwgKz0gbWV0aG9kOwoJCQkJCWlmIChyZXQudHlwZSAhPSAnR0VUJykgewoJCQkJCQlkZWxldGUgaXRlbS5Qb3N0RGF0YTsgLy8gYmVjYXVzZSB3ZSBoYXZlIHRoZSBjYWNoZSBrZXkKCQkJCQkJdmFyIHAwID0gewoJCQkJCQkJQ29kZTogKGNvbXBhbnkgPyBjb21wYW55LkNvZGUgKyAnLScgOiAnJykgKyBrZXksCgkJCQkJCQlDb21wbGV0ZWQ6IG5ldyBEYXRlKCksCgkJCQkJCQlEYXRlOiB0aGlzLkFjdGl2ZVJlcXVlc3QgPwoJCQkJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdC5EYXRlIDogbmV3IERhdGUoKSwKCQkJCQkJCVJlc3VsdDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkoaXRlbSkpKSksIC8vaXRlbS5UZXh0UmVzcG9uc2UsCgkJCQkJCQlTdG9yZWRNZXRob2Q6IHsKCQkJCQkJCQlOYW1lOiBzTWV0aG9kLAoJCQkJCQkJfSwKCQkJCQkJfTsKCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQlwMC5JZCA9IGlkOwoJCQkJCQl9CgkJCQkJCXJldC5kYXRhID0KCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCXRoaXMucGFyYW0oW3AwXSk7CgkJCQkJfQoJCQkJCXJldHVybiByZXQ7CgkJCQl9OwoKCQkJCWxldCByZWNvcmQgPSB0aGlzLnJ1blNjcmlwdCAvKnJ1blNSU2NyaXB0Ki8oCgkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQkoYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoKSkpICsKCQkJCQkncmV0dXJuIHJldDt9KSgpOycKCQkJCSk7CgkJCQlsZXQgciA9IHJlY29yZCA/IEpTT04ucGFyc2UocmVjb3JkLlJlc3VsdCkgOiBudWxsOwoJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCWlmICghaXRlbSkgewoJCQkJCWlmIChyKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZC5JZCkpOwoJCQkJCQl9IGNhdGNoIChleCkge30KCQkJCQl9CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJYWpheChpdGVtLmhhc2gsIGl0ZW0sIHIgJiYgcmVjb3JkID8gcmVjb3JkLklkIDogbnVsbCkKCQkJCQkpOwoJCQkJCXJldHVybiBpdGVtOwoJCQkJfQoKCQkJCXJldHVybiBpdGVtOwoJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdnaXRodWInKSB7CgkJCQlpZiAocmVxdWVzdC5VUkwuaW5kZXhPZignY21zTWV0aG9kUmVzdWx0JykgPj0gMCkgcmV0dXJuIG51bGw7CgkJCQlsZXQgcmVzID0gbnVsbDsKCQkJCXRyeSB7CgkJCQkJcmVzID0gYXdhaXQgJC5hamF4KHsKCQkJCQkJdXJsOiAnaHR0cHM6Ly9hcnpob3NwaXRhbC5naXRodWIuaW8vJyArCgkJCQkJCQljb21wYW55LlN0b3JlICsKCQkJCQkJCScvJyArCgkJCQkJCQlyZXF1ZXN0Lmhhc2ggKwoJCQkJCQkJJy5qcycsCgkJCQkJCWRhdGFUeXBlOiAnanNvbnAnLAoJCQkJCQlwcm9jZXNzUmVzdWx0OiBmYWxzZSwKCQkJCQl9KTsKCQkJCQlyZXR1cm4gewoJCQkJCQlUZXh0UmVzcG9uc2U6IHJlcywKCQkJCQl9OwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygnRVJST1JTOicsIGV4KTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJfSBlbHNlIGlmICh0aGlzLmJDYWNoZVJlc3VsdCA9PSAnbG9jYWwnKSB7CgkJCQl2YXIgc3JDYWNoZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzckNhY2hlJyk7CgkJCQlpZiAoc3JDYWNoZSA9PSBudWxsKSB7CgkJCQkJc3JDYWNoZSA9IHsKCQkJCQkJUmVxdWVzdHM6IHt9LAoJCQkJCX07CgkJCQl9IGVsc2UgewoJCQkJCXNyQ2FjaGUgPSBKU09OLnBhcnNlKHNyQ2FjaGUpOwoJCQkJfQoKCQkJCXZhciByID0gc3JDYWNoZS5SZXF1ZXN0c1tyZXF1ZXN0Lmhhc2hdOwoJCQkJdmFyIGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCWlmICghaXRlbSkgewoJCQkJCWRlbGV0ZSBzckNhY2hlLlJlcXVlc3RzW3JlcXVlc3QuaGFzaF07CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCXNyQ2FjaGUuUmVxdWVzdHNbaXRlbS5oYXNoXSA9IGl0ZW07CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJcmV0dXJuIGl0ZW07CgkJCQl9CgoJCQkJcmV0dXJuIGl0ZW07CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJCXRocm93IGV4OwoJCX0KCX0KCglhc3luYyBfKGZ1biwgY2FsbEJhY2spIHsKCQlpZiAodGhpcy5zX0Vycm9yTWVzc2FnZXMgJiYgdGhpcy5zX0Vycm9yTWVzc2FnZXMubGVuZ3RoID4gMCkgewoJCQlhbGVydCgKCQkJCSdUaGUgZm9sbG93aW5nIGVycm9ycyB3ZXJlIGZvdW5kIGluIHlvdXIgZGF0YTpcbicgKwoJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMKCQkJKTsKCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgPSAnJzsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQl0aGlzLmJ1aWxkVVJMKCk7CgoJCWlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAidW5kZWZpbmVkIikoCgkJCXRoaXMuZkxvYWRpbmdTdGFydCB8fAoJCQlmdW5jdGlvbigpIHsKCQkJCWlmIChkb2N1bWVudC5ib2R5KSBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICd3YWl0JzsKCQkJfQoJCSkoKTsKCgkJdmFyIGFyZ3MgPSBBcnJheSgpOwoJCWZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCWFyZ3NbaSAtIDJdID0gYXJndW1lbnRzW2ldOwoJCX0KCgkJaWYgKHR5cGVvZihfRnJFTUQpICE9PSAndW5kZWZpbmVkJyAmJiBfRnJFTUQuYXBpU2VydmVyKSB7CgkJCWxldCBmUGFydHMgPSBmdW4uc3BsaXQoJy4nKTsKCQkJbGV0IGxpYiA9IGZQYXJ0cy5sZW5ndGggPiAxID8gZlBhcnRzWzBdIDogJ0NvbnRlbnRNYW5hZ2VyJzsKCQkJbGV0IGYgPSBmUGFydHMubGVuZ3RoID4gMSA/IGZQYXJ0c1sxXSA6IGZ1bjsKCgkJCWZQYXJ0cyA9IGYucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxLiQyJykuc3BsaXQoJy4nKTsKCgkJCWxldCBlYyA9IGZQYXJ0cy5zbGljZSgxLCAtMSkuam9pbignJyk7CgkJCWxldCBmbmFtZSA9IGZQYXJ0cy5zbGljZSgtMSlbMF07CgkJCWxldCBzY29wZSA9IGxpYi50b0xvd2VyQ2FzZSgpOwoKCQkJY29uc29sZS5sb2coImNhbGxpbmcuLi4gX0ZyRU1ELmFwaVNlcnZlci5fbmV3KCIgKyBlYyArICIpLiIgKyBmbmFtZSArICIoKS4uLiAiIC8qICsgSlNPTi5zdHJpbmdpZnkoYXJncywgbnVsbCwgNCkqLyApOwoKCQkJcmV0dXJuIGF3YWl0IF9GckVNRC5hcGlTZXJ2ZXIuX25ldyhlYykoKVtmbmFtZV0oYXJncyk7CgkJfQoKCQl2YXIgcG9zdERhdGEgPSB0aGlzLnBhcmFtKGFyZ3MpOwoJCWlmIChmdW4uaW5kZXhPZignLicpIDwgMCkgewoJCQlmdW4gPSB0aGlzLnN5c3RlbU5hbWUgKyAnLicgKyBmdW47CgkJfSBlbHNlIGlmIChmdW4uaW5kZXhPZignLicpID09IDApIHsKCQkJLy8gYSBub24tbGF5ZXIgbWV0aG9kCgkJCWZ1biA9IGZ1bi5zdWJzdHJpbmcoMSk7CgkJfQoKCQlpZiAoY2FsbEJhY2sgJiYgdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCS8vcmV0dXJuIGZhbHNlOwoJCX0KCgkJdmFyIGhDb2RlID0gdGhpcy5oYXNoQ29kZSgKCQkJZnVuLnN1YnN0cmluZyhmdW4uaW5kZXhPZignLicpICsgMSkgKyBwb3N0RGF0YQoJCSk7CgoJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCXBvc3REYXRhICs9CgkJCXRoaXMuQ1JOTCArCgkJCXRoaXMuQ1JOTCArCgkJCSc8IS0tPHBpZD4nICsKCQkJaENvZGUgKwoJCQknPC9waWQ+LS0+JyArCgkJCXRoaXMuQ1JOTDsKCgkJaWYgKGZ1bi5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHRGaW5kJykgPCAwKSB7CgkJCS8vIGF2b2lkIG92ZXJ3cml0ZSBvZiBhc3luYyBjYWxscwoJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSB7CgkJCQlVUkw6IHRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCVBvc3REYXRhOiBwb3N0RGF0YSwKCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQlDYWxsQmFjazogY2FsbEJhY2ssCgkJCQlDb21wYW55OiB0eXBlb2YgY29tcGFueSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueSA/IHsKCQkJCQlDb2RlOiBjb21wYW55LkNvZGUsCgkJCQl9IDogbnVsbCwKCQkJCVRleHRSZXNwb25zZTogbnVsbCwKCQkJCWhhc2g6IGhDb2RlLAoJCQl9OwoJCX0KCgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhdGhpcy5iTG9jYWwpIHsKCQkJLy8gbGl2ZQoJCQl0cnkgewoJCQkJdmFyIF90aGVVcmwgPQoJCQkJCSh0aGlzLlN0b3JlIHx8CgkJCQkJCScvc3RvcmUvJyArCgkJCQkJCSh3aW5kb3cuY29tcGFueSAmJiB3aW5kb3cuY29tcGFueS5Db2RlID8KCQkJCQkJCXdpbmRvdy5jb21wYW55LkNvZGUgKyAnLycgOgoJCQkJCQkJJy8nKSkgKwoJCQkJCWhDb2RlICsKCQkJCQknLmpzP3JhbmQ9JyArCgkJCQkJTWF0aC5yYW5kb20oKTsKCQkJCWxldCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdCgpOwoJCQkJdmFyIHJlc3BvbnNlVGV4dCA9IG51bGw7CgkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQl0cnkgewoJCQkJCQlyZXNwb25zZVRleHQgPSBhd2FpdCAkLmdldChfdGhlVXJsKTsKCQkJCQl9IGNhdGNoIChleCkge30KCQkJCX0gZWxzZSB7CgkJCQkJcmVzcG9uc2VUZXh0ID0gcmVxdWVzdC5UZXh0UmVzcG9uc2U7CgkJCQl9CgkJCQlpZiAoIXJlc3BvbnNlVGV4dCkgewoJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQknTGl2ZSBNb2RlLCBubyByZXNwb25zZSB0ZXh0IGZvciAnICsKCQkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0Lmhhc2ggKwoJCQkJCQknIC0gJyArCgkJCQkJCXRoaXMuJF9SRVFVRVNUKCduYW1lJywgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCkKCQkJCQkpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoKCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCXZhciBfZXhjZXB0aW9uID0gbnVsbDsKCQkJCXRyeSB7CgkJCQkJX3JldCA9IHRoaXMucnVuU1JTY3JpcHQocmVzcG9uc2VUZXh0KTsKCQkJCQlfZXhjZXB0aW9uID0gX3JldC5fZXhjZXB0aW9uOwoJCQkJCWlmIChfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCWxldCB0ZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gX3JldC5zZXJ2ZXJfdGltZS5nZXRUaW1lKCk7CgkJCQkJCXRyeSB7CgkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCV9leGNlcHRpb24gPSBlOwoJCQkJfQoKCQkJCWlmICghX3JldCAmJiAhX2V4Y2VwdGlvbikgewoJCQkJCXJldHVybiBhd2FpdCBudWxsOyAvL3RoaXMuZG9IZWFkbGVzc0NhbGwoY2FsbEJhY2spOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3RoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCWNhbGxCYWNrKAoJCQkJCQkJCV9yZXQucmV0IHx8IChfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCksCgkJCQkJCQkJX2V4Y2VwdGlvbgoJCQkJCQkJKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsKCQkJCQkJCQljYWxsQmFjayArCgkJCQkJCQkJJ1xuXG4nICsKCQkJCQkJCQllLm1lc3NhZ2UKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJKAoJCQkJCQl3aW5kb3cuc3IuZkxvYWRpbmdFbmQgfHwKCQkJCQkJKCgpID0+IHsKCQkJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJfSkKCQkJCQkpKCk7CgkJCQkJcmV0dXJuICgKCQkJCQkJKF9yZXQgPyBfcmV0LnJldCA6IG51bGwpIHx8CgkJCQkJCShfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkpOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZyhlKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKCkgPT4gewoJCQkJcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFhNTCgKCQkJCQl0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJcG9zdERhdGEsCgkJCQkJY2FsbEJhY2sKCQkJCSk7CgkJCX0pKCk7CgkJfQoJfQoKCXByb21pc2UoZGF0YSwgY2FsbEJhY2spIHsKCQlpZiAoIWNhbGxCYWNrIHx8IHt9LnRvU3RyaW5nLmNhbGwoY2FsbEJhY2spICE9PSAnW29iamVjdCBGdW5jdGlvbl0nKSB7CgkJCXJldHVybiBkYXRhOwoJCX0KCgkJdmFyIHAgPSAkLkRlZmVycmVkKCk7CgoJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQl0cnkgewoJCQkJbGV0IGQgPSBhd2FpdCBjYWxsQmFjayhkYXRhKTsKCQkJCXAucmVzb2x2ZShkKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRyeSB7CgkJCQkJcC5yZXNvbHZlKGNhbGxCYWNrKGRhdGEpKTsKCQkJCX0gY2F0Y2ggKF9leCkgewoJCQkJCWNvbnNvbGUubG9nKCdwcm9taXNlIGV4Y2VwdGlvbicsIF9leCk7CgkJCQl9CgkJCX0KCQl9LCA1MDApOwoKCQlyZXR1cm4gcCA/IHAucHJvbWlzZSgpIDogZGF0YTsKCX0KCglhc3luYyBzZW5kWE1MKHVybCwgcG9zdERhdGEsIGNhbGxCYWNrKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhd2luZG93LlNSKSB3aW5kb3cuU1IgPSB0aGlzOwoKCQlpZiAoKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cualF1ZXJ5KSB8fCAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSkgewoJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgbnVsbCwgY2FsbEJhY2spOwoJCQlpZiAocmVxdWVzdCkgewoJCQkJbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCTQ0LAoJCQkJCWNhbGxCYWNrLAoJCQkJCXJlcXVlc3QuVGV4dFJlc3BvbnNlLAoJCQkJCXVybAoJCQkJKTsKCQkJCXJldHVybiBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJfSBlbHNlIHsKCQkJCS8vIGpxdWVyeSBjYWxsCgkJCQl2YXIgYWpheCA9IHt9OwoJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gKHRoaXMubk1heFVSTExlbmd0aCB8fCAxMDApKSB7CgkJCQkJYWpheC51cmwgPSB1cmw7CgkJCQkJYWpheC50eXBlID0gJ1BPU1QnOwoJCQkJCWFqYXguYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCXJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCSdDb250ZW50LVR5cGUnLAoJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkpOwoJCQkJCX07CgkJCQkJYWpheC5kYXRhID0KCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQlwb3N0RGF0YTsKCQkJCX0gZWxzZSB7CgkJCQkJYWpheC51cmwgPSB1cmwgKyAnJlBPU1RDT0RFPScgKyB0aGlzLnRvSGV4KHBvc3REYXRhKTsKCQkJCQlhamF4LnR5cGUgPSAnR0VUJzsKCQkJCX0KCgkJCQlsZXQgcmV0ID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoalF1ZXJ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQlyZXQgPSBhd2FpdCAkLmFqYXgoYWpheCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcmV0ID0gYXdhaXQgYXhpb3MoYWpheCk7CgkJCQkJcmV0ID0gcmV0LmRhdGE7CgkJCQl9CgkJCQlyZXQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgY2FsbEJhY2ssIHJldCwgdXJsKQoJCQkJKTsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9IGVsc2UgewoJCQl2YXIgeG1sSFRUUCA9IHRoaXMuZ2V0WG1sSFRUUCgpOwoJCQlpZiAoIXhtbEhUVFApIHJldHVybiBmYWxzZTsKCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCXdpbmRvdy54bWxIVFRQLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICh3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJaWYgKCQud2hlbikgewoJCQkJCQkJJC53aGVuKAoJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCXVybAoJCQkJCQkJCSkKCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdChyZXN1bHQpKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCXVybAoJCQkJCQkJCSkKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlpZiAodGhpcy5iUG9zdCB8fCBwb3N0RGF0YS5sZW5ndGggPiB0aGlzLm5NYXhVUkxMZW5ndGgpIHsKCQkJCXdpbmRvdy54bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIGNhbGxCYWNrICE9IG51bGwpOwoJCQkJd2luZG93LnhtbEhUVFAuc2V0UmVxdWVzdEhlYWRlcigKCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkpOyAvLyBmb29sIGNyb3NzLWRvbWFpbiBjaGVja2luZyBpbiBjaHJvbWUKCQkJCXdpbmRvdy54bWxIVFRQLnNlbmQoCgkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCXBvc3REYXRhCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJeG1sSFRUUC5vcGVuKAoJCQkJCSdHRVQnLAoJCQkJCXVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpLAoJCQkJCWNhbGxCYWNrICE9IG51bGwKCQkJCSk7CgkJCQl4bWxIVFRQLnNlbmQobnVsbCk7CgkJCX0KCgkJCWlmIChjYWxsQmFjayA9PSBudWxsICYmIHhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQl2YXIgX3VybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJaWYgKCQud2hlbikgewoJCQkJCXJldHVybiAkLndoZW4oCgkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJeG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCV91cmwKCQkJCQkJKQoJCQkJCSkudGhlbigocmVzdWx0KSA9PiB7CgkJCQkJCXJldHVybiB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQl0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJeG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQlfdXJsCgkJCQkJCSkKCQkJCQkpOwoJCQkJfQoJCQl9CgkJfQoJfQoKCV91cmwoZnVuLCBmaWxlbmFtZSkgewoJCXZhciBhcmdzID0gQXJyYXkoKTsKCQlmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQlhcmdzW2kgLSAyXSA9IGFyZ3VtZW50c1tpXTsKCQl9CgkJdmFyIHBvc3REYXRhID0gdGhpcy5wYXJhbShhcmdzKTsKCgkJdmFyIF9hcmdzID0gJyc7CgkJZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJX2FyZ3MgKz0gJyZwJyArIChpIC0gMikgKyAnPScgKyBhcmd1bWVudHNbaV07CgkJfQoKCQlpZiAoZnVuLmluZGV4T2YoJy4nKSA8IDApIHsKCQkJZnVuID0gdGhpcy5zeXN0ZW1OYW1lICsgJy4nICsgZnVuOwoJCX0KCgkJcmV0dXJuICgKCQkJdGhpcy5zclVSTCArCgkJCScmbmFtZT0nICsKCQkJZnVuICsKCQkJJyZyYW5kPScgKwoJCQlNYXRoLnJhbmRvbSgpICsKCQkJLy8rIF9hcmdzCgkJCScmUE9TVENPREU9JyArCgkJCXRoaXMudG9IZXgocG9zdERhdGEpICsKCQkJKGZpbGVuYW1lID8gJyZmaWxlbmFtZT0nICsgZmlsZW5hbWUgOiAnJykKCQkpOwoJfQoKCV9qc29uKGZ1bikgewoJCXZhciBhcmdzID0gQXJyYXkoKTsKCQlmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQlhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKCQl9CgkJaWYgKGZ1bi5pbmRleE9mKCcuJykgPCAwKSB7CgkJCWZ1biA9IHRoaXMuc3lzdGVtTmFtZSArICcuJyArIGZ1bjsKCQl9CgkJcmV0dXJuICgKCQkJdGhpcy5zclVSTCArCgkJCScmbmFtZT0nICsKCQkJZnVuICsKCQkJJyZyYW5kPScgKwoJCQlNYXRoLnJhbmRvbSgpICsKCQkJJyZqc29uPWNsZWFuJlBPU1RDT0RFPScgKwoJCQl0aGlzLnRvSGV4KHRoaXMucGFyYW0oYXJncykpCgkJKTsKCX0KCglteVJlcGxhY2UocywgZmMsIHJjKSB7CgkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCXZhciByZXQgPSAnJzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIHJzID0gcy5jaGFyQXQoaSk7CgkJCWZvciAodmFyIGogPSAwOyBqIDwgZmMubGVuZ3RoOyBqKyspIHsKCQkJCWlmIChzLmNoYXJBdChpKSA9PSBmY1tqXSkgewoJCQkJCXJzID0gcy5jaGFyQXQoaSkucmVwbGFjZShmY1tqXSwgcmNbal0pOwoJCQkJfQoJCQl9CgkJCXJldCArPSByczsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglydW5Db2RlKGNzQ29kZSwganNDb2RlLCBwWE1MLCBjYWxsQmFjaykgewoJCS8vIGF2b2lkIHVzaW5nIHRoaXMgcGxlYXNlCgkJdmFyIHBvc3REYXRhID0gJ1N0b3JlZE1ldGhvZCBtID0gbmV3IFN0b3JlZE1ldGhvZCgpOycgKyB0aGlzLkNSTkw7CgkJcG9zdERhdGEgKz0KCQkJJ20uQm9keUNvZGUgPSAiJyArCgkJCXRoaXMubXlSZXBsYWNlKGNzQ29kZSwgWyciJywgJ1xyJywgJ1xuJ10sIFsnXFwiJywgJ1xccicsICdcXG4nXSkgKwoJCQknIjsnICsKCQkJdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9CgkJCSdtLlJldHVybkNvZGUgPSAiJyArCgkJCXRoaXMubXlSZXBsYWNlKGpzQ29kZSwgWyciJywgJ1xyJywgJ1xuJ10sIFsnXFwiJywgJ1xccicsICdcXG4nXSkgKwoJCQknIjsnICsKCQkJdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9ICdtLkFjdGl2ZSA9IHRydWU7JyArIHRoaXMuQ1JOTDsKCQlwb3N0RGF0YSArPSAnbS5PYmplY3RSZXR1cm4gPSBmYWxzZTsnICsgdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9ICdtLlNpZ25hdHVyZSA9ICJzdHJpbmcgbmFtZSI7JyArIHRoaXMuQ1JOTDsKCQlwb3N0RGF0YSArPSAncmV0dXJuIG5ldyBvYmplY3RbXXttLCBAIicgKyBwWE1MICsgJyJ9OycgKyB0aGlzLkNSTkw7CgoJCXRoaXMuc2VuZFhNTCh0aGlzLnNyVVJMICsgJyZjb2RlPXRydWUnLCBwb3N0RGF0YSwgY2FsbEJhY2spOwoJfQoKCUdldCh1cmwsIGNhbGxCYWNrKSB7CgkJaWYgKCFjYWxsQmFjaykgewoJCQkvLyBzeW5jaHJvbm91cyBtb2RlCgkJCWlmICghd2luZG93LmpRdWVyeSkgewoJCQkJLy8gbm8ganF1ZXJ5CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5wcm9taXNlKAoJCQkJCW51bGwsCgkJCQkJJC5hamF4KHsKCQkJCQkJdHlwZTogJ0dFVCcsCgkJCQkJCXVybDogdXJsLAoJCQkJCQlhc3luYzogZmFsc2UsCgkJCQkJCXByb2Nlc3NEYXRhOiBmYWxzZSwKCQkJCQl9KQoJCQkJKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIHN5bmNocm9ub3VzIG1vZGUKCQkJaWYgKCF3aW5kb3cualF1ZXJ5KSB7CgkJCQkvLyBubyBqcXVlcnkKCQkJfSBlbHNlIHsKCQkJCSQuYWpheCh7CgkJCQkJdHlwZTogJ0dFVCcsCgkJCQkJdXJsOiB1cmwsCgkJCQkJcHJvY2Vzc0RhdGE6IGZhbHNlLAoJCQkJCXN1Y2Nlc3M6IChkYXRhKSA9PiBjYWxsQmFjayhkYXRhKSwKCQkJCQllcnJvcjogKGVycikgPT4gY2FsbEJhY2sobnVsbCksCgkJCQl9KTsKCQkJfQoJCX0KCX0KCglQb3N0KAoJCXVybCwKCQljYWxsQmFjaywKCQlwb3N0RGF0YSwKCQloZWFkZXJzLAoJCXVzZXJuYW1lLAoJCXBhc3N3b3JkLAoJCWNvbnRlbnRUeXBlCgkpIHsKCQl2YXIgeG1sSFRUUCA9IHRoaXMuZ2V0WG1sSFRUUCgpOwoKCQlpZiAoeG1sSFRUUCkgewoJCQl4bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpOwoJCQl4bWxIVFRQLndpdGhDcmVkZW50aWFscyA9ICd0cnVlJzsKCQkJaWYgKGNyb3NzRG9tYWluKQoJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCSdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLAoJCQkJCWxvY2F0aW9uLm9yaWdpbgoJCQkJKTsKCQkJaWYgKGNvbnRlbnRUeXBlKQoJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBjb250ZW50VHlwZSk7CgkJCWlmICh1c2VybmFtZSkKCQkJCXhtbEhUVFAuc2V0UmVxdWVzdEhlYWRlcigKCQkJCQknQXV0aG9yaXphdGlvbicsCgkJCQkJJ0Jhc2ljICcgKyBidG9hKCd1c2VybmFtZTpwYXNzd29yZCcpCgkJCQkpOwoKCQkJaWYgKGhlYWRlcnMpCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlcnMubGVuZ3RoOyBpKyspCgkJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlcnNbaV0ua2V5LCBoZWFkZXJzW2ldLnZhbHVlKTsKCgkJCXhtbEhUVFAub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAod2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0ICYmIGNhbGxCYWNrKSB7CgkJCQkJY2FsbEJhY2sod2luZG93LnhtbEhUVFAucmVzcG9uc2VUZXh0KTsKCQkJCX0KCQkJfTsKCQkJeG1sSFRUUC5zZW5kKHBvc3REYXRhKTsKCQl9Cgl9CgoJaGFzaENvZGUocykgewoJCXZhciBoYXNoID0gMCwKCQkJaSwKCQkJY2hyLAoJCQlsZW47CgkJaWYgKHMubGVuZ3RoID09IDApIHJldHVybiBoYXNoOwoJCWZvciAoaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJY2hyID0gcy5jaGFyQ29kZUF0KGkpOwoJCQloYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hyOwoJCQloYXNoIHw9IDA7IC8vIENvbnZlcnQgdG8gMzJiaXQgaW50ZWdlcgoJCX0KCQlyZXR1cm4gaGFzaDsKCX0KCgl0b0hleChzKSB7CgkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCXJldHVybiBzLnNwbGl0KCIiKS5tYXAoeCA9PiAoMjU2ICsgeC5jaGFyQ29kZUF0KCkpLnRvU3RyaW5nKDE2KS5zdWJzdHIoLTIpKS5qb2luKCIiKTsKCX0KCglhc2NpaV92YWx1ZShjKSB7CgkJLy8gcmVzdHJpY3QgaW5wdXQgdG8gYSBzaW5nbGUgY2hhcmFjdGVyCgkJYyA9IGMuY2hhckF0KDApOwoKCQkvLyBsb29wIHRocm91Z2ggYWxsIHBvc3NpYmxlIEFTQ0lJIHZhbHVlcwoJCXZhciBpOwoJCWZvciAoaSA9IDA7IGkgPCAyNTY7ICsraSkgewoJCQkvLyBjb252ZXJ0IGkgaW50byBhIDItZGlnaXQgaGV4IHN0cmluZwoJCQl2YXIgaCA9IGkudG9TdHJpbmcoMTYpOwoJCQlpZiAoaC5sZW5ndGggPT0gMSkgaCA9ICcwJyArIGg7CgoJCQkvLyBpbnNlcnQgYSAlIGNoYXJhY3RlciBpbnRvIHRoZSBzdHJpbmcKCQkJaCA9ICclJyArIGg7CgoJCQkvLyBkZXRlcm1pbmUgdGhlIGNoYXJhY3RlciByZXByZXNlbnRlZCBieSB0aGUgZXNjYXBlIGNvZGUKCQkJaCA9IHVuZXNjYXBlKGgpOwoKCQkJLy8gaWYgdGhlIGNoYXJhY3RlcnMgbWF0Y2gsIHdlJ3ZlIGZvdW5kIHRoZSBBU0NJSSB2YWx1ZQoJCQlpZiAoaCA9PSBjKSBicmVhazsKCQl9CgkJcmV0dXJuIGk7Cgl9CgoJLyoqCgkgKiBEYXRlIEZ1bmN0aW9ucwoJICovCglkYXlzRGlmZihkMiwgZDEpIHsKCQlyZXR1cm4gTWF0aC5jZWlsKChkMi5nZXRUaW1lKCkgLSBkMS5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKTsKCX0KCglhZGRNU2Vjb25kcyhvLCBtcykgewoJCXJldHVybiBuZXcgRGF0ZShvLmdldFRpbWUoKSArIG1zKTsKCX0KCglhZGRTZWNvbmRzKG8sIHMpIHsKCQlyZXR1cm4gdGhpcy5hZGRNU2Vjb25kcyhvLCBzICogMTAwMCk7Cgl9CgoJYWRkTWludXRlcyhvLCBtKSB7CgkJcmV0dXJuIHRoaXMuYWRkU2Vjb25kcyhvLCBtICogNjApOwoJfQoKCWFkZEhvdXJzKG8sIGgpIHsKCQlyZXR1cm4gdGhpcy5hZGRNaW51dGVzKG8sIGggKiA2MCk7Cgl9CgoJYWRkRGF5cyhvLCBkKSB7CgkJcmV0dXJuIHRoaXMuYWRkSG91cnMobywgZCAqIDI0KTsKCX0KCglhZGRZZWFycyhvLCB5KSB7CgkJcmV0dXJuIHRoaXMuYWRkTW9udGhzKG8sIHkgKiAxMik7Cgl9CgoJYWRkTW9udGhzKG8sIG0pIHsKCQlyZXR1cm4gbmV3IERhdGUoCgkJCW8uZ2V0RnVsbFllYXIoKSwKCQkJby5nZXRNb250aCgpICsgbSwKCQkJby5nZXREYXRlKCksCgkJCW8uZ2V0SG91cnMoKSwKCQkJby5nZXRNaW51dGVzKCksCgkJCW8uZ2V0U2Vjb25kcygpCgkJKTsKCX0KCglpc0RhdGUobykgewoJCXJldHVybiAoCgkJCW8gIT0gbnVsbCAmJgoJCQlvLmNvbnN0cnVjdG9yICE9IG51bGwgJiYKCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ2Z1bmN0aW9uIERhdGUoJykgPiAtMQoJCSk7Cgl9CgoJdG9TaG9ydERhdGUobykgewoJCWlmICghdGhpcy5pc0RhdGUobykpIHJldHVybiAnJzsgLy8gYXZvaWQgbnVsbHMKCQlyZXR1cm4gby5nZXRNb250aCgpICsgMSArICcvJyArIG8uZ2V0RGF0ZSgpICsgJy8nICsgby5nZXRGdWxsWWVhcigpOwoJfQoKCXRvU2hvcnRUaW1lKG8pIHsKCQlpZiAoIXRoaXMuaXNEYXRlKG8pKSByZXR1cm4gJyc7IC8vIGF2b2lkIG51bGxzCgkJdmFyIGhvdXJzID0gJycgKyBvLmdldEhvdXJzKCk7IC8vby5nZXRIb3VycygpJTEyOwoJCXZhciBtaW51dGVzID0gJycgKyBvLmdldE1pbnV0ZXMoKTsKCQl2YXIgc2Vjb25kcyA9ICcnICsgby5nZXRTZWNvbmRzKCk7CgkJaWYgKGhvdXJzLmxlbmd0aCA8IDIpIGhvdXJzID0gJzAnICsgaG91cnM7CgkJaWYgKG1pbnV0ZXMubGVuZ3RoIDwgMikgbWludXRlcyA9ICcwJyArIG1pbnV0ZXM7CgkJaWYgKHNlY29uZHMubGVuZ3RoIDwgMikgc2Vjb25kcyA9ICcwJyArIHNlY29uZHM7CgkJcmV0dXJuIGhvdXJzICsgJzonICsgbWludXRlcyArICc6JyArIHNlY29uZHM7IC8vICsgIiAiICsgKG8uZ2V0SG91cnMoKT49MTI/IlBNIjoiQU0iKTsKCX0KCgl0b0RhdGVUaW1lKG8pIHsKCQlpZiAoIXRoaXMuaXNEYXRlKG8pKSByZXR1cm4gJyc7IC8vIGF2b2lkIG51bGxzCgkJcmV0dXJuIHRoaXMudG9TaG9ydERhdGUobykgKyAnICcgKyB0aGlzLnRvU2hvcnRUaW1lKG8pOwoJfQoJLyoqCgkgKiBFTkQ6IERhdGUgRnVuY3Rpb25zCgkgKi8KCglzZXRQcm9wZXJ0eShjaWQsIHMsIHByb3AsIGRlZikgewoJCWlmICghY2lkKSByZXR1cm47CgkJdmFyIG8gPSAkKGNpZCk7CgkJaWYgKCFvKSByZXR1cm47CgoJCWlmICghcHJvcCkgewoJCQlpZiAoby50YWdOYW1lID09ICdJTlBVVCcpIHsKCQkJCXByb3AgPSAndmFsdWUnOwoJCQkJaWYgKG8udHlwZSA9PSAndGV4dCcpIHByb3AgPSAndmFsdWUnOwoJCQkJaWYgKG8udHlwZSA9PSAnY2hlY2tib3gnKSBwcm9wID0gJ2NoZWNrZWQnOwoJCQl9IGVsc2UgewoJCQkJcHJvcCA9ICdpbm5lckhUTUwnOwoJCQl9CgkJfQoJCWlmICghZGVmKSBkZWYgPSAnJzsKCQlpZiAodGhpcy5wcmVQcm9jZXNzSFRNTCkgZGVmID0gdGhpcy5wcmVQcm9jZXNzSFRNTChkZWYpOwoKCQlpZiAodGhpcy5pc0RhdGUocykpIHsKCQkJLy8gYSBkYXRlIGZpZWxkCgkJCXMgPSB0aGlzLnRvU2hvcnREYXRlKHMpOwoJCX0gZWxzZSB7CgkJCWlmICh0aGlzLnByZVByb2Nlc3NIVE1MKSBzID0gdGhpcy5wcmVQcm9jZXNzSFRNTChzKTsKCQl9CgoJCXdpbmRvdy5wcm9wZXJ0eVZhbHVlID0gczsKCQl0cnkgewoJCQl0aGlzLnJ1blNjcmlwdCgKCQkJCSIkKCciICsgby5pZCArICInKS4iICsgcHJvcCArICcgPSB3aW5kb3cucHJvcGVydHlWYWx1ZTsnCgkJCSk7CgkJfSBjYXRjaCAoZSkgewoJCQl0aGlzLlNob3dFcnJvcihlLm1lc3NhZ2UpOwoJCQl0aGlzLnJ1blNjcmlwdCgiJCgnIiArIG8uaWQgKyAiJykuIiArIHByb3AgKyAnID0gIicgKyBkZWYgKyAnIjsnKTsKCQl9CgkJd2luZG93LnByb3BlcnR5VmFsdWUgPSBudWxsOwoJfQoKCS8qKgoJICogVmFsaWRhdGlvbgoJICovCgl2YWxpZE5vdE51bGwocykgewoJCWlmICh0eXBlb2YgcyA9PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gcyAmJiBzLmxlbmd0aCA+IDA7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHMgIT0gbnVsbDsKCQl9Cgl9CgoJdmFsaWRPYmplY3QobykgewoJCXJldHVybiBvICE9IG51bGw7Cgl9CgoJdmFsaWRFbWFpbChzdHIpIHsKCQl2YXIgYXQgPSAnQCc7CgkJdmFyIGRvdCA9ICcuJzsKCQl2YXIgbGF0ID0gc3RyLmluZGV4T2YoYXQpOwoJCXZhciBsc3RyID0gc3RyLmxlbmd0aDsKCQl2YXIgbGRvdCA9IHN0ci5pbmRleE9mKGRvdCk7CgkJaWYgKAoJCQlzdHIuaW5kZXhPZihhdCkgPT0gLTEgfHwKCQkJc3RyLmluZGV4T2YoYXQpID09IC0xIHx8CgkJCXN0ci5pbmRleE9mKGF0KSA9PSAwIHx8CgkJCXN0ci5pbmRleE9mKGF0KSA9PSBsc3RyIHx8CgkJCXN0ci5pbmRleE9mKGRvdCkgPT0gLTEgfHwKCQkJc3RyLmluZGV4T2YoZG90KSA9PSAwIHx8CgkJCXN0ci5pbmRleE9mKGRvdCkgPT0gbHN0ciB8fAoJCQlzdHIuaW5kZXhPZihhdCwgbGF0ICsgMSkgIT0gLTEgfHwKCQkJc3RyLnN1YnN0cmluZyhsYXQgLSAxLCBsYXQpID09IGRvdCB8fAoJCQlzdHIuc3Vic3RyaW5nKGxhdCArIDEsIGxhdCArIDIpID09IGRvdCB8fAoJCQlzdHIuaW5kZXhPZihkb3QsIGxhdCArIDIpID09IC0xIHx8CgkJCXN0ci5pbmRleE9mKCcgJykgIT0gLTEKCQkpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCgl2YWxpZGF0ZShvLCB0eXBlLCBjb25maWcpIHsKCQlpZiAodHlwZW9mIG8gPT0gJ3N0cmluZycpIG8gPSAkKG8pOwoJCXZhciBiQWxlcnQgPSB0cnVlOwoJCWlmICghbykgcmV0dXJuOwoKCQlpZiAoIWNvbmZpZykgY29uZmlnID0ge307CgkJdmFyIG9FcnIgPSAkKG8uaWQgKyAnX0Vycm9yJyk7CgkJaWYgKCFvRXJyICYmIGRvY3VtZW50Lmluc2VydEFkamFjZW50RWxlbWVudCkgewoJCQliQWxlcnQgPSBmYWxzZTsKCQkJb0VyciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ1NQQU4nKTsKCQkJb0Vyci5pZCA9IG8uaWQgKyAnX0Vycm9yJzsKCQkJb0Vyci5jbGFzc05hbWUgPSAnZXJyb3InOwoJCQlvLmluc2VydEFkamFjZW50RWxlbWVudCgnYWZ0ZXJFbmQnLCBvRXJyKTsKCQl9CgoJCWlmICghY29uZmlnWydmaWVsZCddKSB7CgkJCXZhciB0YWcgPSBvLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCQkJaWYgKAoJCQkJKHRhZyA9PSAnc3BhbicgfHwgdGFnID09ICdhJykgJiYKCQkJCShvLmdldEF0dHJpYnV0ZSgnZnJvbScpIHx8IG8uZ2V0QXR0cmlidXRlKCdsb29rdXAnKSkKCQkJKSB7CgkJCQljb25maWdbJ2ZpZWxkJ10gPSAnU2VsZWN0ZWRJdGVtJzsKCQkJCXR5cGUgPSAnT2JqZWN0JzsKCQkJfSBlbHNlIHsKCQkJCWNvbmZpZ1snZmllbGQnXSA9ICd2YWx1ZSc7CgkJCX0KCQl9CgkJaWYgKCF0eXBlKSB0eXBlID0gJ05vdE51bGwnOwoKCQlpZiAoIWNvbmZpZ1snbGFiZWwnXSkgewoJCQl2YXIgdGl0bGUgPSBvLmdldEF0dHJpYnV0ZSgndGl0bGUnKTsKCQkJaWYgKCF0aXRsZSkgewoJCQkJdGl0bGUgPSBvLmlkLnNwbGl0KCdfJyk7CgkJCQl0aXRsZSA9IHRpdGxlWzFdOwoJCQkJdGl0bGUgPSB0aXRsZS5zdWJzdHIoMyk7CgkJCQl0aXRsZSA9IHRoaXMuRW5nbGlzaE5hbWUodGl0bGUpOwoJCQl9CgkJCWNvbmZpZ1snbGFiZWwnXSA9IHRpdGxlOwoJCX0KCQlpZiAoIWNvbmZpZ1snbWVzc2FnZSddKSBjb25maWdbJ21lc3NhZ2UnXSA9ICdJbnZhbGlkIFZhbHVlJzsKCgkJdmFyIGJWYWxpZCA9IHRydWU7CgkJd2luZG93LnZhbGlkYXRpb25WYWx1ZSA9IHdpbmRvdy5jbXMudihvKTsgLy9bY29uZmlnWyJmaWVsZCJdXTsvL3ZhbHVlCgkJYlZhbGlkID0KCQkJYlZhbGlkICYmCgkJCXRoaXMucnVuU2NyaXB0KAoJCQkJJ3dpbmRvdy5jbXMuc3IudmFsaWQnICsgdHlwZSArICcod2luZG93LnZhbGlkYXRpb25WYWx1ZSknCgkJCSk7CgkJd2luZG93LnZhbGlkYXRpb25WYWx1ZSA9IG51bGw7CgoJCWlmICghYlZhbGlkKSB7CgkJCS8vby52YWx1ZSA9ICIiOwoJCQkvL28uZm9jdXMoKTsKCQkJc01lc3NhZ2UgPSBjb25maWdbJ21lc3NhZ2UnXTsKCQl9IGVsc2UgewoJCQlzTWVzc2FnZSA9ICcnOwoJCX0KCgkJaWYgKCFiVmFsaWQpIHsKCQkJaWYgKGJBbGVydCkgewoJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgKz0KCQkJCQknXG4nICsgY29uZmlnWydsYWJlbCddICsgJzogJyArIHNNZXNzYWdlOwoJCQl9IGVsc2UgewoJCQkJb0Vyci5pbm5lckhUTUwgPSBzTWVzc2FnZTsKCQkJfQoJCX0KCX0KCS8qKgoJICogRU5EOiBWYWxpZGF0aW9uCgkgKi8KCglFbmdsaXNoTmFtZShzKSB7CgkJcmV0dXJuIHMucmVwbGFjZSgvXlthLXpdfFtBLVpdL2csICh2LCBpKSA9PiBpID09PSAwID8gdi50b1VwcGVyQ2FzZSgpIDogIiAiICsgdi50b0xvd2VyQ2FzZSgpKTsKCgkJdmFyIHJldCA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoc1tpXSA+PSAnQScgJiYgc1tpXSA8PSAnWicpIHsKCQkJCXJldCArPSAocmV0Lmxlbmd0aCA9PSAwID8gJycgOiAnICcpICsgc1tpXTsKCQkJfSBlbHNlIGlmIChyZXQubGVuZ3RoID09IDApIHsKCQkJCXJldCArPSAoc1tpXSArICcnKS50b1VwcGVyQ2FzZSgpOwoJCQl9IGVsc2UgewoJCQkJcmV0ICs9IHNbaV07CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJLyoqIE9iamVjdCBDb21wYXJpc29uICoqLwoJbmV3T2JqZWN0KCkgewoJCXZhciByZXQgPSBuZXcgT2JqZWN0KCk7CgkJcmV0Ll9fT0JKRUNUSUQgPSBNYXRoLnJhbmRvbSgpOwoJCXJldHVybiByZXQ7Cgl9CgoJRXF1YWxzKG8xLCBvMikgewoJCWlmIChvMSA9PSBvMikgcmV0dXJuIHRydWU7CgoJCWlmICgKCQkJbzEgJiYKCQkJbzEuX19PQkpFQ1RJRCAmJgoJCQlvMiAmJgoJCQlvMi5fX09CSkVDVElEICYmCgkJCW8xLl9fT0JKRUNUSUQgPT0gbzIuX19PQkpFQ1RJRAoJCSkKCQkJcmV0dXJuIHRydWU7CgkJaWYgKG8xICYmIG8xLl9fUk9XSUQgJiYgbzIgJiYgbzIuX19ST1dJRCAmJiBvMS5fX1JPV0lEID09IG8yLl9fUk9XSUQpCgkJCXJldHVybiB0cnVlOwoJCWlmIChvMSAmJiBvMS5JZCAmJiBvMiAmJiBvMi5JZCAmJiBvMS5JZCA9PSBvMi5JZCkgcmV0dXJuIHRydWU7CgoJCXJldHVybiBmYWxzZTsKCX0KCS8qKiBPYmplY3QgQ29tcGFyaXNvbiAqKi8KCglzZXJpYWxpemUoX29iaikgewoJCXRyeSB7CgkJCS8vIExldCBHZWNrbyBicm93c2VycyBkbyB0aGlzIHRoZSBlYXN5IHdheQoJCQlpZiAoCgkJCQl0eXBlb2YgX29iai50b1NvdXJjZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCXR5cGVvZiBfb2JqLmNhbGxlZSA9PT0gJ3VuZGVmaW5lZCcKCQkJKSB7CgkJCQlyZXR1cm4gX29iai50b1NvdXJjZSgpOwoJCQl9CgkJCS8vIE90aGVyIGJyb3dzZXJzIG11c3QgZG8gaXQgdGhlIGhhcmQgd2F5CgkJCXN3aXRjaCAodHlwZW9mIF9vYmopIHsKCQkJCS8vIG51bWJlcnMsIGJvb2xlYW5zLCBhbmQgZnVuY3Rpb25zIGFyZSB0cml2aWFsOgoJCQkJLy8ganVzdCByZXR1cm4gdGhlIG9iamVjdCBpdHNlbGYgc2luY2UgaXRzIGRlZmF1bHQgLnRvU3RyaW5nKCkKCQkJCS8vIGdpdmVzIHVzIGV4YWN0bHkgd2hhdCB3ZSB3YW50CgkJCQljYXNlICdudW1iZXInOgoJCQkJY2FzZSAnYm9vbGVhbic6CgkJCQljYXNlICdmdW5jdGlvbic6CgkJCQkJcmV0dXJuIF9vYmo7CgkJCQkJLy8gZm9yIEpTT04gZm9ybWF0LCBzdHJpbmdzIG5lZWQgdG8gYmUgd3JhcHBlZCBpbiBxdW90ZXMKCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJcmV0dXJuICInIiArIF9vYmogKyAiJyI7CgkJCQljYXNlICdvYmplY3QnOgoJCQkJCXZhciBzdHI7CgkJCQkJaWYgKAoJCQkJCQlfb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSB8fAoJCQkJCQl0eXBlb2YgX29iai5jYWxsZWUgIT09ICd1bmRlZmluZWQnCgkJCQkJKSB7CgkJCQkJCXN0ciA9ICdbJzsKCQkJCQkJdmFyIGksCgkJCQkJCQlsZW4gPSBfb2JqLmxlbmd0aDsKCQkJCQkJZm9yIChpID0gMDsgaSA8IGxlbiAtIDE7IGkrKykgewoJCQkJCQkJc3RyICs9IHRoaXMuc2VyaWFsaXplKF9vYmpbaV0pICsgJywnOwoJCQkJCQl9CgkJCQkJCXN0ciArPSB0aGlzLnNlcmlhbGl6ZShfb2JqW2ldKSArICddJzsKCQkJCQl9IGVsc2UgewoJCQkJCQlzdHIgPSAneyc7CgkJCQkJCXZhciBrZXk7CgkJCQkJCWZvciAoa2V5IGluIF9vYmopIHsKCQkJCQkJCXN0ciArPSBrZXkgKyAnOicgKyB0aGlzLnNlcmlhbGl6ZShfb2JqW2tleV0pICsgJywnOwoJCQkJCQl9CgkJCQkJCXN0ciA9IHN0ci5yZXBsYWNlKC9cLCQvLCAnJykgKyAnfSc7CgkJCQkJfQoJCQkJCXJldHVybiBzdHI7CgkJCQlkZWZhdWx0OgoJCQkJCXJldHVybiAnVU5LTk9XTic7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCXRoaXMuU2hvd0RlYnVnKGUubWVzc2FnZSk7CgkJfQoJfQp9",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
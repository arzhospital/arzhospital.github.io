{
	"Id": "1ffd794ebad7fe34e89aae6c8fb83c031a565459",
	"name": "ServiceRouter",
	"script": "Y2xhc3MgU2VydmljZVJvdXRlciB7CgkvKgoJdmFyIHNyVVJMOwoKCXZhciBTdG9yZTsKCgl2YXIgQ1JOTDsKCXZhciBiUG9zdDsKCXZhciBiRGVidWc7Cgl2YXIgYkNhY2hlOwoJdmFyIGJMb2NhbDsKCXZhciBiQXN5bmM7Cgl2YXIgYkNhY2hlUmVzdWx0OwoJdmFyIGJTaG93RXJyb3JzOwoJdmFyIG5NYXhVUkxMZW5ndGg7Cgl2YXIgcHJlUHJvY2Vzc0hUTUw7Cgl2YXIgc3lzdGVtTmFtZTsKCXZhciBmTG9hZGluZ1N0YXJ0OwoJdmFyIGZMb2FkaW5nRW5kOwoKCXZhciB0aW1lRGlmZmVyZW5jZSA9IDA7IC8vIHRoaXMgaXMgdGhlIHRpbWUgZGlmZmVyZW5jZSBiZXR3ZWVuIGNsaWVudCBhbmQgc2VydmVyLCB1cGRhdGVkIHdpdGggZXZlcnkgY2FsbCAoaW4gdGlja3MpCgoJdmFyIHNfRXJyb3JNZXNzYWdlczsKCSovCgoJX19zY29wZShzY29wZSkgewoJCWxldCByZXQgPSBudWxsOwoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0ID0gd2luZG93OwoJCX0gZWxzZSBpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0ID0gc2VsZjsKCQl9IGVsc2UgaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXQgPSBnbG9iYWw7CgkJfQoKCQlpZiAoc2NvcGUpIHJldCA9IHJldFtzY29wZV07CgkJcmV0dXJuIHJldDsKCX0KCglidWlsZFVSTChzclVSTCkgewoJCWlmICghc3JVUkwpIHsKCQkJdGhpcy5zclVSTCA9IHRoaXMuJF9SRVFVRVNUKCdzcicpOwoJCQlpZiAoIXRoaXMuc3JVUkwpIHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlsZXQgaXAgPSB0aGlzLmlwQWRkcmVzcygpOwoJCQkJCWlmIChpcCAmJiAoaXAuc3RhcnRzV2l0aCgiMTgyLjE2OC4iKSB8fCBpcCA9PSAiMTkyLjE2OC4xLjI1MyIgfHwgaXAgPT0gJzE5NS4xMTIuMjE1LjIxOCcpKSB7CgkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovLzE4Mi4xNjguNzAuODAiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovL2Fyei5uYW1tb3VyLmNvbTo3MDgwIjsKCQkJCQl9CgkJCQl9CgkJCQl0aGlzLnNyVVJMICs9ICcvbWV0aG9kL1NlcnZpY2VSb3V0ZXIuYXNoeCc7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLnNyVVJMID0gc3JVUkw7CgkJfQoJCXRoaXMuc3JVUkwgKz0gJz9zcnZlcnNpb249MSc7CgkJaWYgKHRoaXMuJF9SRVFVRVNUKCdnemlwJykpIHsKCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9JyArIHRoaXMuJF9SRVFVRVNUKCdnemlwJyk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9dHJ1ZSc7CgkJfQoJCWlmICh0aGlzLmJDYWNoZSkgewoJCQl0aGlzLnNyVVJMICs9ICcmY2FjaGU9JyArIHRoaXMuYkNhY2hlOwoJCX0KCQlpZiAoIXRoaXMuJF9SRVFVRVNUKCdyYW5kJywgdGhpcy5zclVSTCkpIHsKCQkJdGhpcy5zclVSTCArPSAnJnJhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJfQoKCQlpZiAodGhpcy5iRGVidWcpIHsKCQkJdGhpcy5zclVSTCArPSAnJkRFQlVHPXRydWUnOwoJCX0KCgkJaWYgKAoJCQl0aGlzLmJBc3luYyAmJgoJCQl0aGlzLmJMb2NhbCAmJgoJCQkhdGhpcy4kX1JFUVVFU1QoJ2FzeW5jJywgdGhpcy5zclVSTCkKCQkpIHsKCQkJdGhpcy5zclVSTCArPSAnJmFzeW5jPXRydWUnOwoJCQlpZiAodGhpcy5ydW5BZnRlcikgewoJCQkJdGhpcy5zclVSTCArPSAnJnJ1bmFmdGVyPScgKyB0aGlzLnJ1bkFmdGVyOwoJCQl9CgkJCXRoaXMuYkFzeW5jID0gZmFsc2U7CgkJfQoKCQkvL3RoaXMuU2hvd0RlYnVnKCd0aGlzLnNyVVJMPScgKyB0aGlzLnNyVVJMKTsKCgkJcmV0dXJuIHRoaXMuc3JVUkw7Cgl9CgoJaW5pdCgKCQlzclVSTCwKCQlzeXN0ZW1OYW1lLAoJCWJQb3N0LAoJCWJEZWJ1ZywKCQliU2hvd0Vycm9ycywKCQlwcmVQcm9jZXNzSFRNTAoJKSB7CgkJaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJZG9jdW1lbnQgPSB7fTsKCQkJd2luZG93ID0ge307CgkJfQoJCWlmICghYkRlYnVnICYmIGRvY3VtZW50LlVSTCAmJiBkb2N1bWVudC5VUkwuaW5kZXhPZignZGVidWc9dHJ1ZScpID4gMCkKCQkJYkRlYnVnID0gdHJ1ZTsKCgkJdGhpcy5iTG9jYWwgPSAhdGhpcy5TdG9yZSAmJgoJCQlkb2N1bWVudC5VUkwgJiYKCQkJIShkb2N1bWVudC5VUkwuaW5kZXhPZignbG9jYWw9ZmFsc2UnKSA+PSAwKTsKCQlpZiAoIWRvY3VtZW50LlVSTCkgdGhpcy5iTG9jYWwgPSB0cnVlOwoKCQl0aGlzLmJDYWNoZSA9IHRoaXMuJF9SRVFVRVNUKCdjYWNoZScpOwoJCXRoaXMuYkNhY2hlUmVzdWx0ID0gdGhpcy4kX1JFUVVFU1QoJ2NhY2hlUmVzdWx0Jyk7CgoJCXRoaXMuc3JVUkwgPSB0aGlzLmJ1aWxkVVJMKHNyVVJMKTsKCgkJdGhpcy5DUk5MID0gJ1xuJzsKCQl0aGlzLm5NYXhVUkxMZW5ndGggPSAxMDA7CgoJCXRoaXMuc3lzdGVtTmFtZSA9IHN5c3RlbU5hbWU7CgoJCXRoaXMuYlBvc3QgPSBiUG9zdDsKCQl0aGlzLmJEZWJ1ZyA9IGJEZWJ1ZzsKCQl0aGlzLmJTaG93RXJyb3JzID0gYlNob3dFcnJvcnM7CgoJCXRoaXMuc19FcnJvck1lc3NhZ2VzID0gJyc7CgoJCXJldHVybiB0aGlzOwoJfQoKCXByZVByb2Nlc3NIVE1MKGh0bWwpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQl2YXIgcmV0ID0gJyc7CgkJCXZhciBwYXJ0cyA9IGh0bWwuc3BsaXQoJyQkJyk7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKCQkJCWlmIChpICUgMiA9PSAwKSB7CgkJCQkJcmV0ICs9IHBhcnRzW2ldOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJdHJ5IHsKCQkJCQl2YXIgb1ZhbHVlID0gdGhpcy5ydW5TY3JpcHQocGFydHNbaV0pOwoJCQkJCWlmIChvVmFsdWUpIHsKCQkJCQkJcmV0ICs9IG9WYWx1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXQgKz0gJyc7CgkJCQkJfQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXJldCArPSAnJzsKCQkJCX0KCQkJfQoKCQkJaWYgKHByZVByb2Nlc3NIVE1MICE9IG51bGwpIHJldCA9IHByZVByb2Nlc3NIVE1MKHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZSkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCSRfUkVRVUVTVChrZXksIHVybCkgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoKCQlsZXQgcmV0ID0gdW5kZWZpbmVkOwoJCWlmICh1cmwpIHsKCQkJdHJ5IHsKCQkJCXJldCA9IG5ldyBVUkwodXJsKS5zZWFyY2hQYXJhbXMuZ2V0KGtleSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdbXFw/fCZdJyArIGtleSArICc9KFteJiNdKiknKTsKCQkJCXZhciByZXN1bHRzID0gcmVnZXguZXhlYygnPycgKyB1cmwuc3BsaXQoJz8nKVsxXSk7CgkJCQlyZXQgPSAocmVzdWx0cyA9PT0gbnVsbCkgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICcgJykpOwoJCQl9CgkJfSBlbHNlIHsKCQkJcmV0ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoa2V5KTsKCQl9CgoJCXJldHVybiByZXQgPT09IG51bGwgPyAnJyA6IHJldDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWNvbXBpbGUoYXJNb2R1bGVzKSB7CgkJdmFyIGNhbGxzID0gW107CgkJJC5lYWNoKGFyTW9kdWxlcywgKGksIG0pID0+CgkJCWNhbGxzLnB1c2goCgkJCQl0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZGFsbCcsIG51bGwsIHsKCQkJCQlQYWdlOiBtLAoJCQkJfSkKCQkJKQoJCSk7CgkJcmV0dXJuICQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJSZXQpID0+IHsKCQkJdmFyIF9yZXQgPSBbXTsKCQkJJC5tYXAoYXJSZXQsIChwKSA9PiB7CgkJCQlyZXQucHVzaChfLnRlbXBsYXRlKHAuSFRNTCkoc3IucnVuU2NyaXB0KHBbMF0uU2NyaXB0KSkpOwoJCQl9KTsKCQkJcmV0dXJuIF9yZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgaW1wb3J0KGFyTW9kdWxlcykgewoJCXZhciByZXQgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTW9kdWxlcy5sZW5ndGg7IGkrKykgewoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuXygnQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kJywgbnVsbCwgewoJCQkJUGFnZTogYXJNb2R1bGVzW2ldLAoJCQl9KTsKCQkJcmV0LnB1c2gocCk7CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHAuU2NyaXB0KTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglnZXRPYmplY3QocykgewoJCXZhciBjb2RlID0gcyArICc7JzsKCQljb2RlID0gJyh0eXBlb2YgJyArIHMgKyAiID09PSAndW5kZWZpbmVkJyk/c3IubmV3T2JqZWN0KCk6IiArIHM7CgkJLy9yZXR1cm4gdGhpcy5ydW5TY3JpcHQocysiOyIpOwoJCXJldHVybiB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCX0KCglydW5TY3JpcHQocykgewoJCWlmICghcykgcmV0dXJuIG51bGw7CgoJCWxldCBjTGluZXMgPSBzLnNwbGl0KCdcbicpOwoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZXNwcmltYSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQllc3ByaW1hLnBhcnNlKHMsIHsKCQkJCQllczY6IHRydWUKCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJaWYgKGNMaW5lc1tleC5saW5lTnVtYmVyIC0gMV0uaW5kZXhPZignZm9yIGF3YWl0JykgPCAwKSB7CgkJCQljb25zb2xlLmxvZygicnVuU2NyaXB0KCkgIiArIGV4LmRlc2NyaXB0aW9uLCBleC5saW5lTnVtYmVyLCBjTGluZXNbZXgubGluZU51bWJlciAtIDFdKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIikgewoJCQl0cnkgewoJCQkJaWYgKHdpbmRvdy5fY29udGVudCAmJiB3aW5kb3cuX2NvbnRlbnQuZXZhbCkgewoJCQkJCXZhciBvdXRwdXQgPSB3aW5kb3cuX2NvbnRlbnQuZXZhbChzKTsKCQkJCQlyZXR1cm4gb3V0cHV0OwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQl0aGlzLlNob3dFcnJvcignRkYgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCX0KCQkJdHJ5IHsKCQkJCWlmICh3aW5kb3cuZXhlY1NjcmlwdCkgewoJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQl3aW5kb3cuZXhlY1NjcmlwdChzKTsKCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gYSBzaW5nbGUtbGluZSBzdGF0ZW1lbnQKCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQobmV3Uyk7CgkJCQkJCXJldHVybiBuZXdWOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJdGhpcy5TaG93RXJyb3IoJ0lFNiBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmICh3aW5kb3cuZXhlY1NjcmlwdCkgewoJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQl3aW5kb3cuZXhlY1NjcmlwdChzKTsKCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gYSBzaW5nbGUtbGluZSBzdGF0ZW1lbnQKCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJZXZhbChuZXdTKTsKCQkJCQkJcmV0dXJuIG5ld1Y7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQl0aGlzLlNob3dFcnJvcignSUU3IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQl9CgoJCQl0cnkgewoJCQkJdmFyIGZuID0gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHJldCA9IHdpbmRvdy5ldmFsLmNhbGwod2luZG93LCBzKTsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfTsKCgkJCQlyZXR1cm4gZm4oKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJdGhpcy5TaG93RXJyb3IoJ1RBRyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJfQoJCX0KCgkJdHJ5IHsKCQkJcyA9IHMucmVwbGFjZSgvbmV3IERhdGVcKDAwMDEvZywgJ25ldyBEYXRlKDEnKTsKCQkJcmV0dXJuIGV2YWwocyk7CgkJfSBjYXRjaCAoZSkgewoJCQl0aGlzLlNob3dFcnJvcignRVZBTCBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQl9Cgl9CgoJU2hvd09iamVjdChvLCBiSWdub3JlRGVidWcpIHsKCQl2YXIgcmV0ID0gJ09iamVjdCBTdHJ1Y3R1cmU6XG4nOwoJCWZvciAocyBpbiBvKSB7CgkJCXRyeSB7CgkJCQlyZXQgKz0gcyArICc6ICcgKyBvW3NdICsgJ1xuJzsKCQkJfSBjYXRjaCAoZSkgewoJCQkJcmV0ICs9IHMgKyAnOiBFeGNlcHRpb24gd2l0aCB2YWx1ZSA9ICcgKyBlLm1lc3NhZ2UgKyAnXG4nOwoJCQl9CgkJfQoKCQl0aGlzLlNob3dEZWJ1ZyhyZXQsIGJJZ25vcmVEZWJ1Zyk7Cgl9CgoJU2hvd0Vycm9yKHMpIHsKCQljb25zb2xlLmxvZyhzKTsKCQlpZiAodGhpcy5iU2hvd0Vycm9ycykgdGhpcy5TaG93TWVzc2FnZShzKTsKCX0KCgljY29weShzKSB7CgkJaWYgKHdpbmRvdy5jbGlwYm9hcmREYXRhKSBjbGlwYm9hcmREYXRhLnNldERhdGEoJ1RleHQnLCBzKTsKCX0KCglTaG93TWVzc2FnZShzKSB7CgkJaWYgKHR5cGVvZiBub3R5ICE9PSAndW5kZWZpbmVkJykgewoJCQlub3R5KHsKCQkJCXRleHQ6IHMsCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiAyMDAwLAoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQl0cnkgewoJCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBzICsgJzwvcD48L2Rpdj4nKS5kaWFsb2coKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2cocyk7CgkJCX0KCQl9Cgl9CgoJU2hvd0RlYnVnKHMsIGJJZ25vcmVEZWJ1ZykgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJY29uc29sZS5sb2coIlNob3dEZWJ1ZzogIiArIHMpOwoJCX0KCQlpZiAodGhpcy5iRGVidWcgfHwgYklnbm9yZURlYnVnKSB0aGlzLlNob3dNZXNzYWdlKHMpOwoJfQoKCXBhcmFtKGFyZ3MpIHsKCQl0aGlzLkNSTkwgPSB0aGlzLkNSTkwgfHwgIlxuIjsKCQl2YXIgcmV0ID0KCQkJJy8qJyArCgkJCXRoaXMuQ1JOTCArCgkJCSc8IVtDREFUQVsnICsKCQkJdGhpcy5DUk5MICsKCQkJJ1BBUkFNRVRFUlMnICsKCQkJdGhpcy5DUk5MICsKCQkJJ11dPicgKwoJCQl0aGlzLkNSTkwgKwoJCQknKi8nICsKCQkJdGhpcy5DUk5MICsKCQkJdGhpcy5DUk5MICsKCQkJJzxwPicgKwoJCQl0aGlzLkNSTkw7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciB4bWwgPSB0aGlzLl90b1hNTChhcmdzW2ldKTsKCQkJaWYgKGZhbHNlKSB7CgkJCQkvLyB4bWwgY29udGFpbnMgY2hhcmFjdGVycyB0aGF0IHdvdWxkIG5vdCBhcnJpdmUgcHJvcGVybHkgYW5kIHNob3VsZCBiZSBjb252ZXJ0ZWQgdG8gYmFzZTY0CgkJCQl4bWwgPSBidG9hKHhtbCk7CgkJCX0KCQkJcmV0ICs9ICc8cCcgKyBpICsgJz4nICsgdGhpcy5DUk5MICsgeG1sICsgJycgKyB0aGlzLkNSTkw7CgkJCXJldCArPSAnPC9wJyArIGkgKyAnPicgKyB0aGlzLkNSTkw7CgkJfQoJCXJldCArPSAnPC9wPicgKyB0aGlzLkNSTkw7CgkJcmV0dXJuIHJldDsKCX0KCglyZXNldEN1cnNvcigpIHsKCQlpZiAoIWRvY3VtZW50LmJvZHkpIHJldHVybjsKCQlkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdhcnJvdyc7CgkJZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnJzsKCX0KCglzZXJ2ZXJEYXRlKGQpIHsKCQlsZXQgdGQgPSAwOwoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGQgPSB3aW5kb3cudGltZURpZmZlcmVuY2U7CgkJfSBlbHNlIGlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGQgPSBnbG9iYWwudGltZURpZmZlcmVuY2U7CgkJfSBlbHNlIGlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQl0ZCA9IHNlbGYudGltZURpZmZlcmVuY2U7CgkJfQoJCXJldHVybiB0aGlzLmFkZE1TZWNvbmRzKGQgfHwgbmV3IERhdGUoKSwgLXRkKTsKCX0KCglydW5TUlNjcmlwdChzKSB7CgkJcmV0dXJuIHRoaXMucnVuU2NyaXB0KAoJCQknKCgpID0+IHsgdmFyIHJldCA9IG51bGw7ICcgKwoJCQlzICsKCQkJJyBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiKXt3aW5kb3cubWV0aG9kX25hbWUgPSBtZXRob2RfbmFtZTsgd2luZG93LnNlcnZlcl90aW1lID0gc2VydmVyX3RpbWU7IHdpbmRvdy5fZXhjZXB0aW9uID0gdHlwZW9mKF9leGNlcHRpb24pPT09InVuZGVmaW5lZCI/bnVsbDpfZXhjZXB0aW9uOyB3aW5kb3cuZXhlY3V0aW9uX3RpbWUgPSBleGVjdXRpb25fdGltZTt9IHJldHVybiB7X2V4Y2VwdGlvbjogdHlwZW9mKF9leGNlcHRpb24pPT09InVuZGVmaW5lZCI/bnVsbDpfZXhjZXB0aW9uLCBtZXRob2RfbmFtZTogbWV0aG9kX25hbWUsIHNlcnZlcl90aW1lOiBzZXJ2ZXJfdGltZSwgZXhlY3V0aW9uX3RpbWU6IGV4ZWN1dGlvbl90aW1lLCByZXQ6IHJldH07fSkoKTsnCgkJKTsKCX0KCglhc3luYyBwcm9jZXNzUmVzdWx0KHJlcykgewoJCWlmICghcmVzIHx8ICFyZXMuQ29kZSB8fCAhcmVzLlN0b3JlZE1ldGhvZCkgewoJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQlyZXR1cm4gcmVzOwoJCX0KCgkJLy8gZm9yIHN1cmUgYSBtZXRob2QgcmVzdWx0IGZyb20gYW4gYXN5bmMgY2FsbAoJCWlmIChyZXMuUmVzdWx0KSB7CgkJCS8vIHdlIGdvdCBhIHJlc3VsdAoJCQl2YXIgX19yZXQgPSBudWxsOwoJCQl0cnkgewoJCQkJX19yZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXMuUmVzdWx0LCBudWxsKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJX19yZXQgPSByZXMuUmVzdWx0OwoJCQl9CgkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCXJldHVybiBfX3JldDsKCQl9CgoJCXZhciB0aW1lb3V0ID0gcmVzLlJ1bkFmdGVyIC0gcmVzLkRhdGU7CgkJaWYgKHRpbWVvdXQgPD0gMCkgewoJCQkvLyBuZWdhdGl2ZSB0aW1lb3V0IG1lYW5zIHRoYXQgaXQgd2FzIHN1cHBvc2VkIHRvIGJlIHJ1biBidXQgZGlkIG5vdCBmb3Igc29tZSByZWFzb24gKGRlbGF5LCBmYWlsdXJlLCBldGMuLi4pCgkJCS8vIHNhbWUgZGF0ZSBhcyBydW5hZnRlciBtZWFucyB0aGF0IHdlIGFyZSB1c2luZyB0aGUgaW1tZWRpYXRlIGFzeW5jIGV4ZWN1dGlvbi4gaS5lLiB0aGVyZSBpcyBubyBuZWVkIGZvciB0aGUgcnVubmVyIHRocmVhZCB0YXNrCgkJCXRpbWVvdXQgPSAzMDAwMDsKCQl9IGVsc2UgaWYgKHRpbWVvdXQgPiA1ICogNjAgKiAxMDAwKSB7CgkJCS8vIG1vcmUgdGhhbiB3ZSBjYW4gd2FpdCwgd2UgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSByZXN1bHQKCQkJY29uc29sZS5sb2coCgkJCQknV2UgY2Fubm90IHdhaXQgJyArCgkJCQlNYXRoLmZsb29yKHRpbWVvdXQgLyAxMDAwKSArCgkJCQknIHNlY29uZHMuIFJldHVybmluZyByZXN1bHQuJwoJCQkpOwoJCQlyZXR1cm4gcmVzOwoJCX0KCQljb25zb2xlLmxvZygKCQkJJ01ha2luZyB0aGUgbmV4dCBjYWxsIGluICcgKwoJCQlNYXRoLmZsb29yKHRpbWVvdXQgLyAxMDAwKSArCgkJCScgc2Vjb25kcy4nCgkJKTsKCgkJYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dCkpOwoJCWlmICghdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCWNvbnNvbGUubG9nKCdObyBBY3RpdmVSZXF1ZXN0LCBleGl0aW5nLi4uJyk7CgkJCXJldHVybiBudWxsOwoJCX0KCQl0cnkgewoJCQlsZXQgcmV0ID0gYXdhaXQgJC5hamF4KHsKCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZCZwMD17Q29kZX0nICsKCQkJCQlyZXMuQ29kZSArCgkJCQkJJ3svQ29kZX17SWR9JyArCgkJCQkJcmVzLklkICsKCQkJCQkney9JZH0mcmFuZD0nICsKCQkJCQlNYXRoLnJhbmRvbSgpLAoJCQl9KTsKCQkJcmV0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgbnVsbCwgcmV0LCB0aGlzLkFjdGl2ZVJlcXVlc3QuVVJMKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coJ3Byb2Nlc3NSZXN1bHQnLCBleCk7CgkJCXJldHVybiBhd2FpdCB0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQnLCBudWxsLCB7CgkJCQlDb2RlOiByZXMuQ29kZSwKCQkJCUlkOiByZXMuSWQsCgkJCX0pOwoJCX0KCX0KCglwcm9jZXNzUmVzcG9uc2UocmVhZHlTdGF0ZSwgY2FsbEJhY2ssIHJlc3BvbnNlVGV4dCwgdXJsKSB7CgkJaWYgKFs0LCA0NF0uaW5kZXhPZihyZWFkeVN0YXRlKSA9PSAtMSkgcmV0dXJuOwoKCQl2YXIgc01ldGhvZE5hbWUgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHVybCk7CgoJCXRyeSB7CgkJCWlmIChyZWFkeVN0YXRlID09IDQpIHsKCQkJCWxldCByZXMgPSAoYXN5bmMgKCkgPT4gewoJCQkJCXJldHVybiBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KG51bGwsIHJlc3BvbnNlVGV4dCk7CgkJCQl9KSgpOwoJCQl9CgoJCQkvL3JldCA9IG51bGw7CgkJCS8vc2VydmVyX3RpbWUgPSBudWxsOwoJCQkvL19leGNlcHRpb24gPSBudWxsOwoJCQl2YXIgYlNjcmlwdEVycm9yID0gZmFsc2U7CgkJCXZhciBfcmV0ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCV9yZXQgPSB0aGlzLnJ1blNSU2NyaXB0KHJlc3BvbnNlVGV4dCk7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHRocm93IGU7CgkJCQliU2NyaXB0RXJyb3IgPSB0cnVlOwoJCQl9CgoJCQlpZiAoX3JldCAmJiBfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQlsZXQgdGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIF9yZXQuc2VydmVyX3RpbWUuZ2V0VGltZSgpOwoKCQkJCXRyeSB7CgkJCQkJd2luZG93LnRpbWVEaWZmZXJlbmNlID0gdGQ7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJfQoJCQl9CgoJCQlpZiAoX3JldCAmJiBfcmV0Ll9leGNlcHRpb24pIHsKCQkJCXRoaXMuU2hvd0RlYnVnKF9leGNlcHRpb24uTWVzc2FnZSk7CgkJCX0KCgkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQl2YXIgY2FsbFJldCA9IG51bGw7CgkJCQl0cnkgewoJCQkJCWNhbGxSZXQgPSBjYWxsQmFjayhfcmV0LnJldCwgX3JldC5fZXhjZXB0aW9uKTsKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsgY2FsbEJhY2sgKyAnXG5cbicgKyBlLm1lc3NhZ2UKCQkJCQkpOwoJCQkJfQoJCQkJaWYgKAoJCQkJCXR5cGVvZiBfcmV0Lm1ldGhvZF9uYW1lICE9PSAndW5kZWZpbmVkJyAmJgoJCQkJCXR5cGVvZiBzTWV0aG9kTmFtZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCQlzTWV0aG9kTmFtZSAhPSBfcmV0Lm1ldGhvZF9uYW1lCgkJCQkpIHsKCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJJ01pc21hdGNoIGluIE1ldGhvZCBiZXR3ZWVuIHNlcnZlciBhbmQgY2xpZW50OlxuU2VydmVyIE1ldGhvZCBOYW1lOiAnICsKCQkJCQkJX3JldC5tZXRob2RfbmFtZSArCgkJCQkJCSdcbkNsaWVudCBNZXRob2QgTmFtZTogJyArCgkJCQkJCXNNZXRob2ROYW1lCgkJCQkJKTsKCQkJCX0KCQkJCSgKCQkJCQl0aGlzLmZMb2FkaW5nRW5kIHx8CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXdpbmRvdy5zci5yZXNldEN1cnNvcigpOwoJCQkJCX0KCQkJCSkoKTsKCgkJCQlyZXR1cm4gKAoJCQkJCWNhbGxSZXQgfHwgX3JldC5yZXQgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIikgdGhpcy5yZXNldEN1cnNvcigpOwoJCQkJcmV0dXJuIChfcmV0ID8gX3JldC5yZXQgOiBudWxsKSB8fCAoYlNjcmlwdEVycm9yID8gcmVzcG9uc2VUZXh0IDogbnVsbCk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXRocm93IGU7CgkJCX0KCQkJdGhpcy5yZXNldEN1cnNvcigpOwoJCQl0aGlzLlNob3dFcnJvcignRXJyb3IgaW4gY29kZTogJyArIGUubWVzc2FnZSArICdcbicgKyByZXNwb25zZVRleHQpOwoJCX0KCgkJcmV0dXJuIG51bGw7Cgl9CgoJaXNPYmplY3QobykgewoJCXJldHVybiAoCgkJCW8gIT0gbnVsbCAmJgoJCQl0eXBlb2YgbyA9PSAnb2JqZWN0JyAmJgoJCQkhKG8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdmdW5jdGlvbiBEYXRlKCknKSA+IC0xKSAmJgoJCQkhKG8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdBcnJheSgpJykgPiAtMSkKCQkpOwoJfQoKCV90b0pTKG8pIHsKCQlpZiAobyA9PSBudWxsKSByZXR1cm4gJ251bGwnOwoKCQl2YXIgcyA9ICcnOwoJCXN3aXRjaCAodHlwZW9mIG8pIHsKCQkJY2FzZSAnc3RyaW5nJzoKCQkJCXMgKz0KCQkJCQknIicgKwoJCQkJCXRoaXMubXlSZXBsYWNlKAoJCQkJCQl0aGlzLmVzY2FwZVN0cmluZyhvKSwKCQkJCQkJWyciOiAsJ10sCgkJCQkJCVsnIjogbnVsbCwnXQoJCQkJCSkgKwoJCQkJCSciJzsKCQkJCWJyZWFrOwoJCQljYXNlICdudW1iZXInOgoJCQkJcyArPSBvOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQkJcyArPSBvID8gJ3RydWUnIDogJ2ZhbHNlJzsKCQkJCWJyZWFrOwoJCQljYXNlICdvYmplY3QnOgoJCQkJLy8gRGF0ZQoJCQkJaWYgKG8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdmdW5jdGlvbiBEYXRlKCknKSA+IC0xKSB7CgkJCQkJdmFyIHllYXIgPSBvLmdldEZ1bGxZZWFyKCkudG9TdHJpbmcoKTsKCQkJCQkvL3ZhciBtb250aCA9IChvLmdldE1vbnRoKCkgKyAxKS50b1N0cmluZygpOyBtb250aCA9IChtb250aC5sZW5ndGggPT0gMSkgPyAiMCIgKyBtb250aCA6IG1vbnRoOwoJCQkJCXZhciBtb250aCA9IG8uZ2V0TW9udGgoKS50b1N0cmluZygpOwoJCQkJCW1vbnRoID0gbW9udGgubGVuZ3RoID09IDEgPyAnMCcgKyBtb250aCA6IG1vbnRoOwoJCQkJCXZhciBkYXRlID0gby5nZXREYXRlKCkudG9TdHJpbmcoKTsKCQkJCQlkYXRlID0gZGF0ZS5sZW5ndGggPT0gMSA/ICcwJyArIGRhdGUgOiBkYXRlOwoJCQkJCXZhciBob3VycyA9IG8uZ2V0SG91cnMoKS50b1N0cmluZygpOwoJCQkJCWhvdXJzID0gaG91cnMubGVuZ3RoID09IDEgPyAnMCcgKyBob3VycyA6IGhvdXJzOwoJCQkJCXZhciBtaW51dGVzID0gby5nZXRNaW51dGVzKCkudG9TdHJpbmcoKTsKCQkJCQltaW51dGVzID0gbWludXRlcy5sZW5ndGggPT0gMSA/ICcwJyArIG1pbnV0ZXMgOiBtaW51dGVzOwoJCQkJCXZhciBzZWNvbmRzID0gby5nZXRTZWNvbmRzKCkudG9TdHJpbmcoKTsKCQkJCQlzZWNvbmRzID0gc2Vjb25kcy5sZW5ndGggPT0gMSA/ICcwJyArIHNlY29uZHMgOiBzZWNvbmRzOwoJCQkJCXZhciBtaWxsaXNlY29uZHMgPSBvLmdldE1pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJdmFyIHR6bWludXRlcyA9IE1hdGguYWJzKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSk7CgkJCQkJdmFyIHR6aG91cnMgPSAwOwoJCQkJCXdoaWxlICh0em1pbnV0ZXMgPj0gNjApIHsKCQkJCQkJdHpob3VycysrOwoJCQkJCQl0em1pbnV0ZXMgLT0gNjA7CgkJCQkJfQoJCQkJCXR6bWludXRlcyA9CgkJCQkJCXR6bWludXRlcy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJJzAnICsgdHptaW51dGVzLnRvU3RyaW5nKCkgOgoJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKTsKCQkJCQl0emhvdXJzID0KCQkJCQkJdHpob3Vycy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJJzAnICsgdHpob3Vycy50b1N0cmluZygpIDoKCQkJCQkJdHpob3Vycy50b1N0cmluZygpOwoJCQkJCXZhciB0aW1lem9uZSA9CgkJCQkJCShvLmdldFRpbWV6b25lT2Zmc2V0KCkgPCAwID8gJysnIDogJy0nKSArCgkJCQkJCXR6aG91cnMgKwoJCQkJCQknOicgKwoJCQkJCQl0em1pbnV0ZXM7CgkJCQkJcyArPQoJCQkJCQknbmV3IERhdGUoJyArCgkJCQkJCXllYXIgKwoJCQkJCQknLCcgKwoJCQkJCQltb250aCArCgkJCQkJCScsJyArCgkJCQkJCWRhdGUgKwoJCQkJCQknLCcgKwoJCQkJCQlob3VycyArCgkJCQkJCScsJyArCgkJCQkJCW1pbnV0ZXMgKwoJCQkJCQknLCcgKwoJCQkJCQlzZWNvbmRzICsKCQkJCQkJJywnICsKCQkJCQkJbWlsbGlzZWNvbmRzICsKCQkJCQkJJyknOwoJCQkJfQoJCQkJLy8gQXJyYXkKCQkJCWVsc2UgaWYgKG8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdBcnJheSgpJykgPiAtMSkgewoJCQkJCXMgKz0gJ1snOwoJCQkJCWZvciAodmFyIHAgaW4gbykgewoJCQkJCQlzICs9ICcnOwoJCQkJCQlpZiAoIWlzTmFOKHApKSB7CgkJCQkJCQkvLyBsaW5lYXIgYXJyYXkKCQkJCQkJCXMgKz0gdGhpcy5fdG9KUyhvW3BdKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIGFzc29jaWF0aXZlIGFycmF5CgkJCQkJCQlzICs9ICd7IicgKyBwICsgJyI6ICcgKyB0aGlzLl90b0pTKG9bcF0pICsgJ30nOwoJCQkJCQl9CgkJCQkJCXMgKz0gJywgJzsKCQkJCQl9CgkJCQkJcyArPSAnXSc7CgkJCQl9CgkJCQkvLyBPYmplY3Qgb3IgY3VzdG9tIGZ1bmN0aW9uCgkJCQllbHNlIHsKCQkJCQlzICs9ICd7JzsKCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJcyArPSAnIicgKyBwICsgJyI6ICcgKyB0aGlzLl90b0pTKG9bcF0pICsgJywgJzsKCQkJCQl9CgkJCQkJaWYgKHMubGFzdEluZGV4T2YoJywgJykgPT0gcy5sZW5ndGggLSAyKQoJCQkJCQlzID0gcy5zdWJzdHJpbmcoMCwgcy5sZW5ndGggLSAyKTsKCQkJCQlzICs9ICd9JzsKCQkJCX0KCQkJCWJyZWFrOwoJCQljYXNlICdmdW5jdGlvbic6CgkJCQkvLyBmdW5jdGlvbnMgYXJlIG5vdCB3b3JraW5nLCBJTExFR0FMIFRPS0VOLi4uLgoJCQkJLy9zICs9ICJcIiIrdGhpcy5lc2NhcGVTdHJpbmcoby50b1N0cmluZygpKSsiXCIiOwoJCQkJcyArPSAnbnVsbCc7CgkJCQlicmVhazsKCQkJZGVmYXVsdDoKCQkJCXMgKz0gJ251bGwnOwoJCX0KCQlyZXR1cm4gczsKCX0KCgllc2NhcGVTdHJpbmcodGV4dCkgewoJCWlmICghYXJndW1lbnRzLmNhbGxlZS5zUkUpIHsKCQkJdmFyIHNwZWNpYWxzID0gWwoJCQkJJ1xyJywKCQkJCSdcbicsCgkJCQknXGYnLAoJCQkJJ1xiJywKCQkJCSdcdCcsCgkJCQkiJyIsCgkJCQknJicsCgkJCQknLycsCgkJCQknLicsCgkJCQknKicsCgkJCQknKycsCgkJCQknPycsCgkJCQknfCcsCgkJCQknKCcsCgkJCQknKScsCgkJCQknWycsCgkJCQknXScsCgkJCQkneycsCgkJCQknfScsCgkJCQknXFwnLAoJCQkJJyInLAoJCQldOwoJCQlhcmd1bWVudHMuY2FsbGVlLnNSRSA9IG5ldyBSZWdFeHAoCgkJCQknKFxcJyArIHNwZWNpYWxzLmpvaW4oJ3xcXCcpICsgJyknLAoJCQkJJ2cnCgkJCSk7CgkJfQoJCXZhciByZXQgPSB0ZXh0LnJlcGxhY2UoYXJndW1lbnRzLmNhbGxlZS5zUkUsICdcXCQxJyk7CgoJCXJldCA9IHRoaXMubXlSZXBsYWNlKHJldCwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSk7CgkJcmV0ID0gdGhpcy5teVJlcGxhY2UoCgkJCXJldCwKCQkJWydccicsICdcbicsICdcdCddLAoJCQlbJ1xcJyArICdyJywgJ1xcJyArICduJywgJ1xcJyArICd0J10KCQkpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWlwQWRkcmVzcygpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gbnVsbDsKCQkJaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoZ2xvYmFsLm9zKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogSW52YWxpZCBnbG9iYWwgb3IgZ2xvYmFsLm9zIG5vdCBkZWZpbmVkIik7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gW10uY29uY2F0KC4uLk9iamVjdC52YWx1ZXMoZ2xvYmFsLm9zLm5ldHdvcmtJbnRlcmZhY2VzKCkpKS5maW5kKChkZXRhaWxzKSA9PiBkZXRhaWxzLmZhbWlseSA9PT0gJ0lQdjQnICYmICFkZXRhaWxzLmludGVybmFsKS5hZGRyZXNzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogIiArIGV4KTsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV90b1hNTChvLCBsZXZlbCkgewoJCWlmICghbGV2ZWwpIGxldmVsID0gMDsKCQl2YXIgcyA9ICcnOwoJCWlmIChvID09IG51bGwpIHJldHVybiBzOwoJCXN3aXRjaCAodHlwZW9mIG8pIHsKCQkJY2FzZSAnc3RyaW5nJzoKCQkJCXMgKz0gJzwhW0NEQVRBWycgKyBvICsgJ11dPic7CgkJCQlicmVhazsKCQkJY2FzZSAnbnVtYmVyJzoKCQkJY2FzZSAnYm9vbGVhbic6CgkJCQlzICs9IG8udG9TdHJpbmcoKTsKCQkJCWJyZWFrOwoJCQljYXNlICdvYmplY3QnOgoJCQkJLy8gRGF0ZQoJCQkJaWYgKAoJCQkJCW8uY29uc3RydWN0b3IgJiYKCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSAmJgoJCQkJCW8uY29uc3RydWN0b3IubmFtZSA9PSAiRGF0ZSIKCQkJCSkgewoJCQkJCXZhciB5ZWFyID0gby5nZXRVVENGdWxsWWVhcigpLnRvU3RyaW5nKCk7CgkJCQkJdmFyIG1vbnRoID0gKG8uZ2V0VVRDTW9udGgoKSArIDEpLnRvU3RyaW5nKCk7CgkJCQkJbW9udGggPSBtb250aC5sZW5ndGggPT0gMSA/ICcwJyArIG1vbnRoIDogbW9udGg7CgkJCQkJdmFyIGRhdGUgPSBvLmdldFVUQ0RhdGUoKS50b1N0cmluZygpOwoJCQkJCWRhdGUgPSBkYXRlLmxlbmd0aCA9PSAxID8gJzAnICsgZGF0ZSA6IGRhdGU7CgkJCQkJdmFyIGhvdXJzID0gby5nZXRVVENIb3VycygpLnRvU3RyaW5nKCk7CgkJCQkJaG91cnMgPSBob3Vycy5sZW5ndGggPT0gMSA/ICcwJyArIGhvdXJzIDogaG91cnM7CgkJCQkJdmFyIG1pbnV0ZXMgPSBvLmdldFVUQ01pbnV0ZXMoKS50b1N0cmluZygpOwoJCQkJCW1pbnV0ZXMgPSBtaW51dGVzLmxlbmd0aCA9PSAxID8gJzAnICsgbWludXRlcyA6IG1pbnV0ZXM7CgkJCQkJdmFyIHNlY29uZHMgPSBvLmdldFVUQ1NlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCXNlY29uZHMgPSBzZWNvbmRzLmxlbmd0aCA9PSAxID8gJzAnICsgc2Vjb25kcyA6IHNlY29uZHM7CgkJCQkJdmFyIG1pbGxpc2Vjb25kcyA9IG8uZ2V0VVRDTWlsbGlzZWNvbmRzKCkudG9TdHJpbmcoKTsKCQkJCQl2YXIgdHptaW51dGVzID0gTWF0aC5hYnMoby5nZXRUaW1lem9uZU9mZnNldCgpKTsKCQkJCQl2YXIgdHpob3VycyA9IDA7CgkJCQkJd2hpbGUgKHR6bWludXRlcyA+PSA2MCkgewoJCQkJCQl0emhvdXJzKys7CgkJCQkJCXR6bWludXRlcyAtPSA2MDsKCQkJCQl9CgkJCQkJdHptaW51dGVzID0KCQkJCQkJdHptaW51dGVzLnRvU3RyaW5nKCkubGVuZ3RoID09IDEgPwoJCQkJCQknMCcgKyB0em1pbnV0ZXMudG9TdHJpbmcoKSA6CgkJCQkJCXR6bWludXRlcy50b1N0cmluZygpOwoJCQkJCXR6aG91cnMgPQoJCQkJCQl0emhvdXJzLnRvU3RyaW5nKCkubGVuZ3RoID09IDEgPwoJCQkJCQknMCcgKyB0emhvdXJzLnRvU3RyaW5nKCkgOgoJCQkJCQl0emhvdXJzLnRvU3RyaW5nKCk7CgkJCQkJdmFyIHRpbWV6b25lID0KCQkJCQkJKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSA8IDAgPyAnKycgOiAnLScpICsKCQkJCQkJdHpob3VycyArCgkJCQkJCSc6JyArCgkJCQkJCXR6bWludXRlczsKCQkJCQkvL3MgKz0geWVhciArICItIiArIG1vbnRoICsgIi0iICsgZGF0ZSArICJUIiArIGhvdXJzICsgIjoiICsgbWludXRlcyArICI6IiArIHNlY29uZHMgKyAiLiIgKyBtaWxsaXNlY29uZHMgKyB0aW1lem9uZTsKCQkJCQlzICs9CgkJCQkJCW1vbnRoICsKCQkJCQkJJy8nICsKCQkJCQkJZGF0ZSArCgkJCQkJCScvJyArCgkJCQkJCXllYXIgKwoJCQkJCQknICcgKwoJCQkJCQlob3VycyArCgkJCQkJCSc6JyArCgkJCQkJCW1pbnV0ZXMgKwoJCQkJCQknOicgKwoJCQkJCQlzZWNvbmRzOwoJCQkJfQoJCQkJLy8gQXJyYXkKCQkJCWVsc2UgaWYgKAoJCQkJCW8uY29uc3RydWN0b3IgJiYKCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEKCQkJCSkgewoJCQkJCWZvciAodmFyIHAgaW4gbykgewoJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJcyArPSAnPE9iamVjdD4nOwoJCQkJCQlpZiAoIWlzTmFOKHApKSB7CgkJCQkJCQkvLyBsaW5lYXIgYXJyYXkKCQkJCQkJCWlmIChvW3BdID09IG51bGwpIHsKCQkJCQkJCQkvLyBudWxsIGVudHJ5IGluIHRoZSBhcnJheQoJCQkJCQkJCXMgKz0gJzxJZD4wPC9JZD4nOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkvZnVuY3Rpb25ccysoXHcqKVxzKlwoL2dpLmV4ZWMoCgkJCQkJCQkJCW9bcF0uY29uc3RydWN0b3IudG9TdHJpbmcoKQoJCQkJCQkJCSk7CgkJCQkJCQkJdmFyIHR5cGUgPSBSZWdFeHAuJDE7CgkJCQkJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJCQkJCWNhc2UgJyc6CgkJCQkJCQkJCQl0eXBlID0gdHlwZW9mIG9bcF07CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJY2FzZSAnU3RyaW5nJzoKCQkJCQkJCQkJCXR5cGUgPSAnc3RyaW5nJzsKCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQljYXNlICdOdW1iZXInOgoJCQkJCQkJCQkJdHlwZSA9ICdpbnQnOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgJ0Jvb2xlYW4nOgoJCQkJCQkJCQkJdHlwZSA9ICdib29sJzsKCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQljYXNlICdEYXRlJzoKCQkJCQkJCQkJCXR5cGUgPSAnRGF0ZVRpbWUnOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoJCQkJCQkJCXMgKz0gdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKyk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBhc3NvY2lhdGl2ZSBhcnJheQoJCQkJCQkJcyArPQoJCQkJCQkJCSc8JyArCgkJCQkJCQkJcCArCgkJCQkJCQkJdGhpcy5jb29wKG8sIHApICsKCQkJCQkJCQknPicgKwoJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQknPC8nICsKCQkJCQkJCQlwICsKCQkJCQkJCQknPic7CgkJCQkJCX0KCQkJCQkJcyArPSAnPC9PYmplY3Q+JyArIHRoaXMuQ1JOTDsKCQkJCQl9CgkJCQl9CgkJCQkvLyBPYmplY3Qgb3IgY3VzdG9tIGZ1bmN0aW9uCgkJCQllbHNlIHsKCQkJCQlpZiAobyA9PSBudWxsIHx8IG8uSWQgPT0gMCkge30gZWxzZSBpZiAoZmFsc2UgJiYgby5JZCkgewoJCQkJCQkvLyB0aGlzIGlzIGNyZWF0aW5nIGEgcHJvYmxlbSwgYmV0dGVyIHNlbmQgYWxsIHRoZSBvYmplY3QKCQkJCQkJLy8gZG8gbm90IHNlbmQgb3RoZXIgZGF0YSBpZiB3ZSBoYXZlIGEgdmFsdWUgZm9yIHRoZSBJZAoJCQkJCQlzICs9ICc8SWQ+JyArIHRoaXMuX3RvWE1MKG8uSWQsIGxldmVsKyspICsgJzwvSWQ+JzsKCQkJCQl9IGVsc2UgewoJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCWlmIChwID09ICdPUEVSQVRPUlMnIHx8IHAgPT0gJ09SUycpIGNvbnRpbnVlOwoJCQkJCQkJcyArPQoJCQkJCQkJCSc8JyArCgkJCQkJCQkJcCArCgkJCQkJCQkJdGhpcy5jb29wKG8sIHApICsKCQkJCQkJCQl0aGlzLk9SKG8sIHApICsKCQkJCQkJCQknPicgKwoJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQknPC8nICsKCQkJCQkJCQlwICsKCQkJCQkJCQknPic7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJT1IobywgcCkgewoJCXJldHVybiBvLk9SUyAmJiBvLk9SU1twXSA/CgkJCSIgT1I9JyIgKwoJCQl0aGlzLm15UmVwbGFjZShvLk9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkiJyIgOgoJCQknJzsKCX0KCgljb29wKG8sIHApIHsKCQlpZiAoIW8uT1BFUkFUT1JTIHx8ICFvLk9QRVJBVE9SU1twXSkgewoJCQlyZXR1cm4gJyc7CgkJfQoJCXJldHVybiAoCgkJCSIgY29vcD0nIiArCgkJCXRoaXMubXlSZXBsYWNlKG8uT1BFUkFUT1JTW3BdLCBbJzwnLCAnPiddLCBbJyZsdDsnLCAnJmd0OyddKSArCgkJCSInIgoJCSk7Cgl9CgoJZ2V0WG1sSFRUUCgpIHsKCQl2YXIgeCA9IG51bGw7CgkJdmFyIGFjdGl2ZXhtb2RlcyA9IFsnTXN4bWwyLlhNTEhUVFAnLCAnTWljcm9zb2Z0LlhNTEhUVFAnXTsgLy9hY3RpdmVYIHZlcnNpb25zIHRvIGNoZWNrIGZvciBpbiBJRQoJCWlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewoJCQkvL1Rlc3QgZm9yIHN1cHBvcnQgZm9yIEFjdGl2ZVhPYmplY3QgaW4gSUUgZmlyc3QgKGFzIFhNTEh0dHBSZXF1ZXN0IGluIElFNyBpcyBicm9rZW4pCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYWN0aXZleG1vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCQl0cnkgewoJCQkJCXggPSBuZXcgQWN0aXZlWE9iamVjdChhY3RpdmV4bW9kZXNbaV0pOwoJCQkJCWJyZWFrOwoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCS8vc3VwcHJlc3MgZXJyb3IKCQkJCX0KCQkJfQoJCX0gZWxzZSBpZiAod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7CgkJCS8vIGlmIE1vemlsbGEsIFNhZmFyaSBldGMKCQkJeCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJCX0gZWxzZSB7CgkJCXggPSBudWxsOwoJCX0KCgkJcmV0dXJuICh3aW5kb3cueG1sSFRUUCA9IHgpOwoJfQoKCWFzeW5jIGNhY2hlUmVzdWx0KHJlcXVlc3QsIHRleHRyZXNwb25zZSkgewoJCWlmICghdGhpcy5iQ2FjaGVSZXN1bHQpIHJldHVybjsKCQlyZXF1ZXN0ID0gcmVxdWVzdCB8fCB0aGlzLkFjdGl2ZVJlcXVlc3Q7CgoJCWlmICghcmVxdWVzdCkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoCgkJCXRleHRyZXNwb25zZSAmJgoJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LkNvZGUgPSAnKSA+IC0xICYmCgkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUnVuQWZ0ZXIgPSAnKSA+IC0xICYmCgkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUmVzdWx0ID0gIiInKSA+IC0xCgkJKSB7CgkJCWNvbnNvbGUubG9nKCd0ZXh0cmVzcG9uc2UgY29udGlhbnMgaW5jb21wbGV0ZSBtZXRob2QgcmVzdWx0Jyk7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJdmFyIHNNZXRob2QgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHJlcXVlc3QuVVJMKTsKCQlzTWV0aG9kID0gc01ldGhvZC5zdWJzdHJpbmcoc01ldGhvZC5sYXN0SW5kZXhPZignLicpICsgMSk7CgkJdHJ5IHsKCQkJdmFyIF91c2FibGUgPSAocikgPT4gewoJCQkJdmFyIGl0ZW0gPQoJCQkJCShyICYmCgkJCQkJCXIuaGFzaCA9PSByZXF1ZXN0Lmhhc2ggJiYKCQkJCQkJKHIuVVJMID09IHJlcXVlc3QuVVJMIHx8IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgci5VUkwpID09IHNNZXRob2QpICYmCgkJCQkJCXIuVGV4dFJlc3BvbnNlICYmCgkJCQkJCSh0eXBlb2Ygci5FeHBpcmVzID09PSAndW5kZWZpbmVkJyB8fAoJCQkJCQkJbmV3IERhdGUoci5FeHBpcmVzKSA+IG5ldyBEYXRlKCkpKSA/CgkJCQkJciA6CgkJCQkJbnVsbDsKCQkJCWlmICh0ZXh0cmVzcG9uc2UpIHsKCQkJCQlpdGVtID0gaXRlbSB8fCByZXF1ZXN0OwoJCQkJCWl0ZW0uVGV4dFJlc3BvbnNlID0gdGV4dHJlc3BvbnNlOwoJCQkJCWl0ZW0uRXhwaXJlcyA9IG5ldyBEYXRlKAoJCQkJCQluZXcgRGF0ZSgpLmdldFRpbWUoKSArCgkJCQkJCXBhcnNlRmxvYXQoCgkJCQkJCQl0aGlzLm5DYWNoZUV4cGlyZUhvdXJzIHx8IHRoaXMuJF9SRVFVRVNUKCduQ2FjaGVFeHBpcmVIb3VycycpIHx8IDEKCQkJCQkJKSAqCgkJCQkJCTYwICoKCQkJCQkJNjAgKgoJCQkJCQkxMDAwCgkJCQkJKTsKCQkJCX0KCgkJCQlyZXR1cm4gaXRlbTsKCQkJfTsKCgkJCWlmICgKCQkJCXRoaXMuYkNhY2hlUmVzdWx0ID09ICdrdnN0b3JlJyAmJgoJCQkJdHlwZW9mIHdpbmRvdy5jb21wYW55LnJlc3Rpb2RiU2V0dGluZ3MgIT09ICd1bmRlZmluZWQnCgkJCSkgewoJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQl2YXIgcmV0ID0gY29tcGFueS5yZXN0aW9kYlNldHRpbmdzKCk7CgkJCQkJcmV0LnVybCArPSAna3ZzdG9yZSc7CgkJCQkJaWYgKHZhbHVlKSB7CgkJCQkJCWlmIChpZCkgewoJCQkJCQkJLy8gdXBkYXRlIHJlY29yZAoJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCXJldC5tZXRob2QgPSAnUFVUJzsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCXJldC5tZXRob2QgPSAnUE9TVCc7CgkJCQkJCX0KCQkJCQkJcmV0LmRhdGEgPSBKU09OLnN0cmluZ2lmeSh7CgkJCQkJCQlrZXk6IGtleSwKCQkJCQkJCXZhbHVlOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgNCksCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChpZCkgewoJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCXJldC5tZXRob2QgPSAnREVMRVRFJzsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldC5tZXRob2QgPSAnR0VUJzsKCQkJCQkJCXJldC51cmwgKz0gJz9xPXsia2V5IjonICsga2V5ICsgJ30nOwoJCQkJCQl9CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coJ21ldGhvZCcsIHJldC5tZXRob2QpOwoJCQkJCXJldHVybiByZXQ7CgkJCQl9OwoKCQkJCWxldCByZWNvcmQgPSBhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKTsKCQkJCWxldCByID0KCQkJCQlyZWNvcmQgJiYgcmVjb3JkLmxlbmd0aCA/CgkJCQkJSlNPTi5wYXJzZShyZWNvcmRbMF0udmFsdWUpIDoKCQkJCQludWxsOwoJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCWlmICghaXRlbSkgewoJCQkJCWlmIChyKSB7CgkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkWzBdLl9pZCkpOwoJCQkJCX0KCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJYXdhaXQgJC5hamF4KAoJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciA/IHJlY29yZFswXS5faWQgOiBudWxsKQoJCQkJCSk7CgkJCQkJcmV0dXJuIGl0ZW07CgkJCQl9CgoJCQkJcmV0dXJuIGl0ZW07CgkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ3NyJykgewoJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQl2YXIgbWV0aG9kID0gJ0ZpbmQnOwoJCQkJCXZhciByZXQgPSB7CgkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0JywKCQkJCQkJcHJvY2Vzc0RhdGE6IGZhbHNlLAoJCQkJCQl0eXBlOiAnUE9TVCcsCgkJCQkJfTsKCQkJCQlpZiAodmFsdWUpIHsKCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQltZXRob2QgPSAnVXBkYXRlJzsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCW1ldGhvZCA9ICdJbnNlcnQnOwoJCQkJCQl9CgkJCQkJCXJldC5iZWZvcmVTZW5kID0gKHJlcXVlc3QpID0+IHsKCQkJCQkJCXJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCQkpOwoJCQkJCQl9OwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldC50eXBlID0gJ0dFVCc7CgkJCQkJCWlmIChpZCkgewoJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJbWV0aG9kID0gJ0RlbGV0ZSc7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBnZXQgcmVjb3JkCgkJCQkJCQltZXRob2QgPSAnRmluZCc7CgkJCQkJCX0KCQkJCQkJbWV0aG9kICs9CgkJCQkJCQknJnAwPXtDb2RlfScgKwoJCQkJCQkJKGNvbXBhbnkgPyBjb21wYW55LkNvZGUgKyAnLScgOiAnJykgKwoJCQkJCQkJa2V5ICsKCQkJCQkJCSd7L0NvZGV9JzsKCQkJCQl9CgkJCQkJcmV0LnVybCArPSBtZXRob2Q7CgkJCQkJaWYgKHJldC50eXBlICE9ICdHRVQnKSB7CgkJCQkJCWRlbGV0ZSBpdGVtLlBvc3REYXRhOyAvLyBiZWNhdXNlIHdlIGhhdmUgdGhlIGNhY2hlIGtleQoJCQkJCQl2YXIgcDAgPSB7CgkJCQkJCQlDb2RlOiAoY29tcGFueSA/IGNvbXBhbnkuQ29kZSArICctJyA6ICcnKSArIGtleSwKCQkJCQkJCUNvbXBsZXRlZDogbmV3IERhdGUoKSwKCQkJCQkJCURhdGU6IHRoaXMuQWN0aXZlUmVxdWVzdCA/CgkJCQkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0LkRhdGUgOiBuZXcgRGF0ZSgpLAoJCQkJCQkJUmVzdWx0OiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeShpdGVtKSkpKSwgLy9pdGVtLlRleHRSZXNwb25zZSwKCQkJCQkJCVN0b3JlZE1ldGhvZDogewoJCQkJCQkJCU5hbWU6IHNNZXRob2QsCgkJCQkJCQl9LAoJCQkJCQl9OwoJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCXAwLklkID0gaWQ7CgkJCQkJCX0KCQkJCQkJcmV0LmRhdGEgPQoJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJdGhpcy5wYXJhbShbcDBdKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJldDsKCQkJCX07CgoJCQkJbGV0IHJlY29yZCA9IHRoaXMucnVuU2NyaXB0IC8qcnVuU1JTY3JpcHQqLygKCQkJCQknKCgpID0+IHsgdmFyIHJldCA9IG51bGw7ICcgKwoJCQkJCShhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKSkgKwoJCQkJCSdyZXR1cm4gcmV0O30pKCk7JwoJCQkJKTsKCQkJCWxldCByID0gcmVjb3JkID8gSlNPTi5wYXJzZShyZWNvcmQuUmVzdWx0KSA6IG51bGw7CgkJCQlsZXQgaXRlbSA9IF91c2FibGUocik7CgoJCQkJaWYgKCFpdGVtKSB7CgkJCQkJaWYgKHIpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkLklkKSk7CgkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJCX0KCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJYXdhaXQgJC5hamF4KAoJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciAmJiByZWNvcmQgPyByZWNvcmQuSWQgOiBudWxsKQoJCQkJCSk7CgkJCQkJcmV0dXJuIGl0ZW07CgkJCQl9CgoJCQkJcmV0dXJuIGl0ZW07CgkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2dpdGh1YicpIHsKCQkJCWlmIChyZXF1ZXN0LlVSTC5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHQnKSA+PSAwKSByZXR1cm4gbnVsbDsKCQkJCWxldCByZXMgPSBudWxsOwoJCQkJdHJ5IHsKCQkJCQlyZXMgPSBhd2FpdCAkLmFqYXgoewoJCQkJCQl1cmw6ICdodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby8nICsKCQkJCQkJCWNvbXBhbnkuU3RvcmUgKwoJCQkJCQkJJy8nICsKCQkJCQkJCXJlcXVlc3QuaGFzaCArCgkJCQkJCQknLmpzJywKCQkJCQkJZGF0YVR5cGU6ICdqc29ucCcsCgkJCQkJCXByb2Nlc3NSZXN1bHQ6IGZhbHNlLAoJCQkJCX0pOwoJCQkJCXJldHVybiB7CgkJCQkJCVRleHRSZXNwb25zZTogcmVzLAoJCQkJCX07CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCdFUlJPUlM6JywgZXgpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdsb2NhbCcpIHsKCQkJCXZhciBzckNhY2hlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3NyQ2FjaGUnKTsKCQkJCWlmIChzckNhY2hlID09IG51bGwpIHsKCQkJCQlzckNhY2hlID0gewoJCQkJCQlSZXF1ZXN0czoge30sCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJc3JDYWNoZSA9IEpTT04ucGFyc2Uoc3JDYWNoZSk7CgkJCQl9CgoJCQkJdmFyIHIgPSBzckNhY2hlLlJlcXVlc3RzW3JlcXVlc3QuaGFzaF07CgkJCQl2YXIgaXRlbSA9IF91c2FibGUocik7CgoJCQkJaWYgKCFpdGVtKSB7CgkJCQkJZGVsZXRlIHNyQ2FjaGUuUmVxdWVzdHNbcmVxdWVzdC5oYXNoXTsKCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc3JDYWNoZScsIEpTT04uc3RyaW5naWZ5KHNyQ2FjaGUpKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJc3JDYWNoZS5SZXF1ZXN0c1tpdGVtLmhhc2hdID0gaXRlbTsKCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc3JDYWNoZScsIEpTT04uc3RyaW5naWZ5KHNyQ2FjaGUpKTsKCQkJCQlyZXR1cm4gaXRlbTsKCQkJCX0KCgkJCQlyZXR1cm4gaXRlbTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQkJdGhyb3cgZXg7CgkJfQoJfQoKCWFzeW5jIF8oZnVuLCBjYWxsQmFjaykgewoJCWlmICh0aGlzLnNfRXJyb3JNZXNzYWdlcyAmJiB0aGlzLnNfRXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKSB7CgkJCWFsZXJ0KAoJCQkJJ1RoZSBmb2xsb3dpbmcgZXJyb3JzIHdlcmUgZm91bmQgaW4geW91ciBkYXRhOlxuJyArCgkJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcwoJCQkpOwoJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcyA9ICcnOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXRoaXMuYnVpbGRVUkwoKTsKCgkJaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICJ1bmRlZmluZWQiKSgKCQkJdGhpcy5mTG9hZGluZ1N0YXJ0IHx8CgkJCWZ1bmN0aW9uKCkgewoJCQkJaWYgKGRvY3VtZW50LmJvZHkpIGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3dhaXQnOwoJCQl9CgkJKSgpOwoKCQl2YXIgYXJncyA9IEFycmF5KCk7CgkJZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJYXJnc1tpIC0gMl0gPSBhcmd1bWVudHNbaV07CgkJfQoKCQlpZiAodGhpcy4kX1JFUVVFU1QoJ25vU1InKSkgewoJCQlsZXQgZlBhcnRzID0gZnVuLnNwbGl0KCcuJyk7CgkJCWxldCBsaWIgPSBmUGFydHMubGVuZ3RoID4gMSA/IGZQYXJ0c1swXSA6ICdDb250ZW50TWFuYWdlcic7CgkJCWxldCBmID0gZlBhcnRzLmxlbmd0aCA+IDEgPyBmUGFydHNbMV0gOiBmdW47CgoJCQlmUGFydHMgPSBmLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMS4kMicpLnNwbGl0KCcuJyk7CgoJCQlsZXQgZWMgPSBmUGFydHMuc2xpY2UoMSwgLTEpLmpvaW4oJycpOwoJCQlsZXQgZm5hbWUgPSBmUGFydHMuc2xpY2UoLTEpWzBdOwoJCQlsZXQgc2NvcGUgPSBsaWIudG9Mb3dlckNhc2UoKTsKCgkJCWNvbnNvbGUubG9nKCJjYWxsaW5nLi4uIG5ldyBbIiArIGxpYiArICddICcgKyBmUGFydHNbMF0gKyAnLicgKyBlYyArICIoKS4iICsgZm5hbWUgKyAiKCkuLi4gIiAvKiArIEpTT04uc3RyaW5naWZ5KGFyZ3MsIG51bGwsIDQpKi8gKTsKCgkJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoJCQlpZiAoIW9TY29wZSB8fCAhb1Njb3BlW2VjXSkgewoJCQkJaWYgKGZuYW1lID09ICdGaW5kJykgewoJCQkJCWxldCBvd25lciA9IHRoaXMuJF9SRVFVRVNUKCdvd25lcicpIHx8ICdhcnpob3NwaXRhbCc7CgkJCQkJbGV0IHVybCA9IGBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vJHtvd25lcn0vJHtvd25lcn0uZ2l0aHViLmlvL21hc3Rlci9jb20vbmFtbW91ci8ke2ZQYXJ0c1swXX0vJHtlY30vJHthcmdzWzBdW09iamVjdC5rZXlzKGFyZ3NbMF0pWzBdXX0uanNvbmA7CgkJCQkJY29uc29sZS5sb2coIl8oKTogZmV0Y2hpbmcgIiArIHVybCk7CgkJCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCk7CgkJCQkJaWYgKCFyZXQub2spIHJldHVybiBudWxsOwoJCQkJCWxldCBfb2JqID0gSlNPTi5wYXJzZShhd2FpdCByZXQudGV4dCgpKTsKCQkJCQlyZXR1cm4gX29iai5yZW1hcmsgPyBhdG9iKF9vYmoucmVtYXJrKSA6IF9vYmo7CgkJCQl9CgkJCQlyZXR1cm4gZm5hbWUuZW5kc1dpdGgoJ2FsbCcpID8gW10gOiBudWxsOwoJCQl9CgkJCWNvbnNvbGUubG9nKHNjb3BlICsgIi4uLiBjYWxsaW5nLi4uIiwgb1Njb3BlKTsKCgkJCXJldHVybiBhd2FpdCBuZXcob1Njb3BlW2VjXSkoKVtmbmFtZV0oYXJncyk7CgkJfQoKCQl2YXIgcG9zdERhdGEgPSB0aGlzLnBhcmFtKGFyZ3MpOwoJCWlmIChmdW4uaW5kZXhPZignLicpIDwgMCkgewoJCQlmdW4gPSB0aGlzLnN5c3RlbU5hbWUgKyAnLicgKyBmdW47CgkJfSBlbHNlIGlmIChmdW4uaW5kZXhPZignLicpID09IDApIHsKCQkJLy8gYSBub24tbGF5ZXIgbWV0aG9kCgkJCWZ1biA9IGZ1bi5zdWJzdHJpbmcoMSk7CgkJfQoKCQlpZiAoY2FsbEJhY2sgJiYgdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCS8vcmV0dXJuIGZhbHNlOwoJCX0KCgkJdmFyIGhDb2RlID0gdGhpcy5oYXNoQ29kZSgKCQkJZnVuLnN1YnN0cmluZyhmdW4uaW5kZXhPZignLicpICsgMSkgKyBwb3N0RGF0YQoJCSk7CgoJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCXBvc3REYXRhICs9CgkJCXRoaXMuQ1JOTCArCgkJCXRoaXMuQ1JOTCArCgkJCSc8IS0tPHBpZD4nICsKCQkJaENvZGUgKwoJCQknPC9waWQ+LS0+JyArCgkJCXRoaXMuQ1JOTDsKCgkJaWYgKGZ1bi5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHRGaW5kJykgPCAwKSB7CgkJCS8vIGF2b2lkIG92ZXJ3cml0ZSBvZiBhc3luYyBjYWxscwoJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSB7CgkJCQlVUkw6IHRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCVBvc3REYXRhOiBwb3N0RGF0YSwKCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQlDYWxsQmFjazogY2FsbEJhY2ssCgkJCQlDb21wYW55OiB0eXBlb2YgY29tcGFueSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueSA/IHsKCQkJCQlDb2RlOiBjb21wYW55LkNvZGUsCgkJCQl9IDogbnVsbCwKCQkJCVRleHRSZXNwb25zZTogbnVsbCwKCQkJCWhhc2g6IGhDb2RlLAoJCQl9OwoJCX0KCgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhdGhpcy5iTG9jYWwpIHsKCQkJLy8gbGl2ZQoJCQl0cnkgewoJCQkJdmFyIF90aGVVcmwgPQoJCQkJCSh0aGlzLlN0b3JlIHx8CgkJCQkJCScvc3RvcmUvJyArCgkJCQkJCSh3aW5kb3cuY29tcGFueSAmJiB3aW5kb3cuY29tcGFueS5Db2RlID8KCQkJCQkJCXdpbmRvdy5jb21wYW55LkNvZGUgKyAnLycgOgoJCQkJCQkJJy8nKSkgKwoJCQkJCWhDb2RlICsKCQkJCQknLmpzP3JhbmQ9JyArCgkJCQkJTWF0aC5yYW5kb20oKTsKCQkJCWxldCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdCgpOwoJCQkJdmFyIHJlc3BvbnNlVGV4dCA9IG51bGw7CgkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQl0cnkgewoJCQkJCQlyZXNwb25zZVRleHQgPSBhd2FpdCAkLmdldChfdGhlVXJsKTsKCQkJCQl9IGNhdGNoIChleCkge30KCQkJCX0gZWxzZSB7CgkJCQkJcmVzcG9uc2VUZXh0ID0gcmVxdWVzdC5UZXh0UmVzcG9uc2U7CgkJCQl9CgkJCQlpZiAoIXJlc3BvbnNlVGV4dCkgewoJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQknTGl2ZSBNb2RlLCBubyByZXNwb25zZSB0ZXh0IGZvciAnICsKCQkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0Lmhhc2ggKwoJCQkJCQknIC0gJyArCgkJCQkJCXRoaXMuJF9SRVFVRVNUKCduYW1lJywgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCkKCQkJCQkpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoKCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCXZhciBfZXhjZXB0aW9uID0gbnVsbDsKCQkJCXRyeSB7CgkJCQkJX3JldCA9IHRoaXMucnVuU1JTY3JpcHQocmVzcG9uc2VUZXh0KTsKCQkJCQlfZXhjZXB0aW9uID0gX3JldC5fZXhjZXB0aW9uOwoJCQkJCWlmIChfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCWxldCB0ZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gX3JldC5zZXJ2ZXJfdGltZS5nZXRUaW1lKCk7CgkJCQkJCXRyeSB7CgkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCV9leGNlcHRpb24gPSBlOwoJCQkJfQoKCQkJCWlmICghX3JldCAmJiAhX2V4Y2VwdGlvbikgewoJCQkJCXJldHVybiBhd2FpdCBudWxsOyAvL3RoaXMuZG9IZWFkbGVzc0NhbGwoY2FsbEJhY2spOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3RoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCWNhbGxCYWNrKAoJCQkJCQkJCV9yZXQucmV0IHx8IChfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCksCgkJCQkJCQkJX2V4Y2VwdGlvbgoJCQkJCQkJKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsKCQkJCQkJCQljYWxsQmFjayArCgkJCQkJCQkJJ1xuXG4nICsKCQkJCQkJCQllLm1lc3NhZ2UKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJKAoJCQkJCQl3aW5kb3cuc3IuZkxvYWRpbmdFbmQgfHwKCQkJCQkJKCgpID0+IHsKCQkJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJfSkKCQkJCQkpKCk7CgkJCQkJcmV0dXJuICgKCQkJCQkJKF9yZXQgPyBfcmV0LnJldCA6IG51bGwpIHx8CgkJCQkJCShfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkpOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZyhlKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKCkgPT4gewoJCQkJcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFhNTCgKCQkJCQl0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJcG9zdERhdGEsCgkJCQkJY2FsbEJhY2sKCQkJCSk7CgkJCX0pKCk7CgkJfQoJfQoKCXByb21pc2UoZGF0YSwgY2FsbEJhY2spIHsKCQlpZiAoIWNhbGxCYWNrIHx8IHt9LnRvU3RyaW5nLmNhbGwoY2FsbEJhY2spICE9PSAnW29iamVjdCBGdW5jdGlvbl0nKSB7CgkJCXJldHVybiBkYXRhOwoJCX0KCgkJdmFyIHAgPSAkLkRlZmVycmVkKCk7CgoJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQl0cnkgewoJCQkJbGV0IGQgPSBhd2FpdCBjYWxsQmFjayhkYXRhKTsKCQkJCXAucmVzb2x2ZShkKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRyeSB7CgkJCQkJcC5yZXNvbHZlKGNhbGxCYWNrKGRhdGEpKTsKCQkJCX0gY2F0Y2ggKF9leCkgewoJCQkJCWNvbnNvbGUubG9nKCdwcm9taXNlIGV4Y2VwdGlvbicsIF9leCk7CgkJCQl9CgkJCX0KCQl9LCA1MDApOwoKCQlyZXR1cm4gcCA/IHAucHJvbWlzZSgpIDogZGF0YTsKCX0KCglhc3luYyBzZW5kWE1MKHVybCwgcG9zdERhdGEsIGNhbGxCYWNrKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhd2luZG93LlNSKSB3aW5kb3cuU1IgPSB0aGlzOwoKCQlpZiAoKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cualF1ZXJ5KSB8fCAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSkgewoJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgbnVsbCwgY2FsbEJhY2spOwoJCQlpZiAocmVxdWVzdCkgewoJCQkJbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCTQ0LAoJCQkJCWNhbGxCYWNrLAoJCQkJCXJlcXVlc3QuVGV4dFJlc3BvbnNlLAoJCQkJCXVybAoJCQkJKTsKCQkJCXJldHVybiBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJfSBlbHNlIHsKCQkJCS8vIGpxdWVyeSBjYWxsCgkJCQl2YXIgYWpheCA9IHt9OwoJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gKHRoaXMubk1heFVSTExlbmd0aCB8fCAxMDApKSB7CgkJCQkJYWpheC51cmwgPSB1cmw7CgkJCQkJYWpheC50eXBlID0gJ1BPU1QnOwoJCQkJCWFqYXguYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCXJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCSdDb250ZW50LVR5cGUnLAoJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkpOwoJCQkJCX07CgkJCQkJYWpheC5kYXRhID0KCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQlwb3N0RGF0YTsKCQkJCX0gZWxzZSB7CgkJCQkJYWpheC51cmwgPSB1cmwgKyAnJlBPU1RDT0RFPScgKyB0aGlzLnRvSGV4KHBvc3REYXRhKTsKCQkJCQlhamF4LnR5cGUgPSAnR0VUJzsKCQkJCX0KCgkJCQlsZXQgcmV0ID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoalF1ZXJ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQlyZXQgPSBhd2FpdCAkLmFqYXgoYWpheCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcmV0ID0gYXdhaXQgYXhpb3MoYWpheCk7CgkJCQkJcmV0ID0gcmV0LmRhdGE7CgkJCQl9CgkJCQlyZXQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgY2FsbEJhY2ssIHJldCwgdXJsKQoJCQkJKTsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9IGVsc2UgewoJCQl2YXIgeG1sSFRUUCA9IHRoaXMuZ2V0WG1sSFRUUCgpOwoJCQlpZiAoIXhtbEhUVFApIHJldHVybiBmYWxzZTsKCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCXdpbmRvdy54bWxIVFRQLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICh3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJaWYgKCQud2hlbikgewoJCQkJCQkJJC53aGVuKAoJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCXVybAoJCQkJCQkJCSkKCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdChyZXN1bHQpKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCXVybAoJCQkJCQkJCSkKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlpZiAodGhpcy5iUG9zdCB8fCBwb3N0RGF0YS5sZW5ndGggPiB0aGlzLm5NYXhVUkxMZW5ndGgpIHsKCQkJCXdpbmRvdy54bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIGNhbGxCYWNrICE9IG51bGwpOwoJCQkJd2luZG93LnhtbEhUVFAuc2V0UmVxdWVzdEhlYWRlcigKCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkpOyAvLyBmb29sIGNyb3NzLWRvbWFpbiBjaGVja2luZyBpbiBjaHJvbWUKCQkJCXdpbmRvdy54bWxIVFRQLnNlbmQoCgkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCXBvc3REYXRhCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJeG1sSFRUUC5vcGVuKAoJCQkJCSdHRVQnLAoJCQkJCXVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpLAoJCQkJCWNhbGxCYWNrICE9IG51bGwKCQkJCSk7CgkJCQl4bWxIVFRQLnNlbmQobnVsbCk7CgkJCX0KCgkJCWlmIChjYWxsQmFjayA9PSBudWxsICYmIHhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQl2YXIgX3VybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJaWYgKCQud2hlbikgewoJCQkJCXJldHVybiAkLndoZW4oCgkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJeG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCV91cmwKCQkJCQkJKQoJCQkJCSkudGhlbigocmVzdWx0KSA9PiB7CgkJCQkJCXJldHVybiB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQl0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJeG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQlfdXJsCgkJCQkJCSkKCQkJCQkpOwoJCQkJfQoJCQl9CgkJfQoJfQoKCV91cmwoZnVuLCBmaWxlbmFtZSkgewoJCXZhciBhcmdzID0gQXJyYXkoKTsKCQlmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQlhcmdzW2kgLSAyXSA9IGFyZ3VtZW50c1tpXTsKCQl9CgkJdmFyIHBvc3REYXRhID0gdGhpcy5wYXJhbShhcmdzKTsKCgkJdmFyIF9hcmdzID0gJyc7CgkJZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJX2FyZ3MgKz0gJyZwJyArIChpIC0gMikgKyAnPScgKyBhcmd1bWVudHNbaV07CgkJfQoKCQlpZiAoZnVuLmluZGV4T2YoJy4nKSA8IDApIHsKCQkJZnVuID0gdGhpcy5zeXN0ZW1OYW1lICsgJy4nICsgZnVuOwoJCX0KCgkJcmV0dXJuICgKCQkJdGhpcy5zclVSTCArCgkJCScmbmFtZT0nICsKCQkJZnVuICsKCQkJJyZyYW5kPScgKwoJCQlNYXRoLnJhbmRvbSgpICsKCQkJLy8rIF9hcmdzCgkJCScmUE9TVENPREU9JyArCgkJCXRoaXMudG9IZXgocG9zdERhdGEpICsKCQkJKGZpbGVuYW1lID8gJyZmaWxlbmFtZT0nICsgZmlsZW5hbWUgOiAnJykKCQkpOwoJfQoKCV9qc29uKGZ1bikgewoJCXZhciBhcmdzID0gQXJyYXkoKTsKCQlmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQlhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKCQl9CgkJaWYgKGZ1bi5pbmRleE9mKCcuJykgPCAwKSB7CgkJCWZ1biA9IHRoaXMuc3lzdGVtTmFtZSArICcuJyArIGZ1bjsKCQl9CgkJcmV0dXJuICgKCQkJdGhpcy5zclVSTCArCgkJCScmbmFtZT0nICsKCQkJZnVuICsKCQkJJyZyYW5kPScgKwoJCQlNYXRoLnJhbmRvbSgpICsKCQkJJyZqc29uPWNsZWFuJlBPU1RDT0RFPScgKwoJCQl0aGlzLnRvSGV4KHRoaXMucGFyYW0oYXJncykpCgkJKTsKCX0KCglteVJlcGxhY2UocywgZmMsIHJjKSB7CgkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCXZhciByZXQgPSAnJzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIHJzID0gcy5jaGFyQXQoaSk7CgkJCWZvciAodmFyIGogPSAwOyBqIDwgZmMubGVuZ3RoOyBqKyspIHsKCQkJCWlmIChzLmNoYXJBdChpKSA9PSBmY1tqXSkgewoJCQkJCXJzID0gcy5jaGFyQXQoaSkucmVwbGFjZShmY1tqXSwgcmNbal0pOwoJCQkJfQoJCQl9CgkJCXJldCArPSByczsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglydW5Db2RlKGNzQ29kZSwganNDb2RlLCBwWE1MLCBjYWxsQmFjaykgewoJCS8vIGF2b2lkIHVzaW5nIHRoaXMgcGxlYXNlCgkJdmFyIHBvc3REYXRhID0gJ1N0b3JlZE1ldGhvZCBtID0gbmV3IFN0b3JlZE1ldGhvZCgpOycgKyB0aGlzLkNSTkw7CgkJcG9zdERhdGEgKz0KCQkJJ20uQm9keUNvZGUgPSAiJyArCgkJCXRoaXMubXlSZXBsYWNlKGNzQ29kZSwgWyciJywgJ1xyJywgJ1xuJ10sIFsnXFwiJywgJ1xccicsICdcXG4nXSkgKwoJCQknIjsnICsKCQkJdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9CgkJCSdtLlJldHVybkNvZGUgPSAiJyArCgkJCXRoaXMubXlSZXBsYWNlKGpzQ29kZSwgWyciJywgJ1xyJywgJ1xuJ10sIFsnXFwiJywgJ1xccicsICdcXG4nXSkgKwoJCQknIjsnICsKCQkJdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9ICdtLkFjdGl2ZSA9IHRydWU7JyArIHRoaXMuQ1JOTDsKCQlwb3N0RGF0YSArPSAnbS5PYmplY3RSZXR1cm4gPSBmYWxzZTsnICsgdGhpcy5DUk5MOwoJCXBvc3REYXRhICs9ICdtLlNpZ25hdHVyZSA9ICJzdHJpbmcgbmFtZSI7JyArIHRoaXMuQ1JOTDsKCQlwb3N0RGF0YSArPSAncmV0dXJuIG5ldyBvYmplY3RbXXttLCBAIicgKyBwWE1MICsgJyJ9OycgKyB0aGlzLkNSTkw7CgoJCXRoaXMuc2VuZFhNTCh0aGlzLnNyVVJMICsgJyZjb2RlPXRydWUnLCBwb3N0RGF0YSwgY2FsbEJhY2spOwoJfQoKCUdldCh1cmwsIGNhbGxCYWNrKSB7CgkJaWYgKCFjYWxsQmFjaykgewoJCQkvLyBzeW5jaHJvbm91cyBtb2RlCgkJCWlmICghd2luZG93LmpRdWVyeSkgewoJCQkJLy8gbm8ganF1ZXJ5CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5wcm9taXNlKAoJCQkJCW51bGwsCgkJCQkJJC5hamF4KHsKCQkJCQkJdHlwZTogJ0dFVCcsCgkJCQkJCXVybDogdXJsLAoJCQkJCQlhc3luYzogZmFsc2UsCgkJCQkJCXByb2Nlc3NEYXRhOiBmYWxzZSwKCQkJCQl9KQoJCQkJKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIHN5bmNocm9ub3VzIG1vZGUKCQkJaWYgKCF3aW5kb3cualF1ZXJ5KSB7CgkJCQkvLyBubyBqcXVlcnkKCQkJfSBlbHNlIHsKCQkJCSQuYWpheCh7CgkJCQkJdHlwZTogJ0dFVCcsCgkJCQkJdXJsOiB1cmwsCgkJCQkJcHJvY2Vzc0RhdGE6IGZhbHNlLAoJCQkJCXN1Y2Nlc3M6IChkYXRhKSA9PiBjYWxsQmFjayhkYXRhKSwKCQkJCQllcnJvcjogKGVycikgPT4gY2FsbEJhY2sobnVsbCksCgkJCQl9KTsKCQkJfQoJCX0KCX0KCglQb3N0KAoJCXVybCwKCQljYWxsQmFjaywKCQlwb3N0RGF0YSwKCQloZWFkZXJzLAoJCXVzZXJuYW1lLAoJCXBhc3N3b3JkLAoJCWNvbnRlbnRUeXBlCgkpIHsKCQl2YXIgeG1sSFRUUCA9IHRoaXMuZ2V0WG1sSFRUUCgpOwoKCQlpZiAoeG1sSFRUUCkgewoJCQl4bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpOwoJCQl4bWxIVFRQLndpdGhDcmVkZW50aWFscyA9ICd0cnVlJzsKCQkJaWYgKGNyb3NzRG9tYWluKQoJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCSdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLAoJCQkJCWxvY2F0aW9uLm9yaWdpbgoJCQkJKTsKCQkJaWYgKGNvbnRlbnRUeXBlKQoJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCBjb250ZW50VHlwZSk7CgkJCWlmICh1c2VybmFtZSkKCQkJCXhtbEhUVFAuc2V0UmVxdWVzdEhlYWRlcigKCQkJCQknQXV0aG9yaXphdGlvbicsCgkJCQkJJ0Jhc2ljICcgKyBidG9hKCd1c2VybmFtZTpwYXNzd29yZCcpCgkJCQkpOwoKCQkJaWYgKGhlYWRlcnMpCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlcnMubGVuZ3RoOyBpKyspCgkJCQkJeG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlcnNbaV0ua2V5LCBoZWFkZXJzW2ldLnZhbHVlKTsKCgkJCXhtbEhUVFAub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAod2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0ICYmIGNhbGxCYWNrKSB7CgkJCQkJY2FsbEJhY2sod2luZG93LnhtbEhUVFAucmVzcG9uc2VUZXh0KTsKCQkJCX0KCQkJfTsKCQkJeG1sSFRUUC5zZW5kKHBvc3REYXRhKTsKCQl9Cgl9CgoJaGFzaENvZGUocykgewoJCXZhciBoYXNoID0gMCwKCQkJaSwKCQkJY2hyLAoJCQlsZW47CgkJaWYgKHMubGVuZ3RoID09IDApIHJldHVybiBoYXNoOwoJCWZvciAoaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJY2hyID0gcy5jaGFyQ29kZUF0KGkpOwoJCQloYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hyOwoJCQloYXNoIHw9IDA7IC8vIENvbnZlcnQgdG8gMzJiaXQgaW50ZWdlcgoJCX0KCQlyZXR1cm4gaGFzaDsKCX0KCgl0b0hleChzKSB7CgkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCXJldHVybiBzLnNwbGl0KCIiKS5tYXAoeCA9PiAoMjU2ICsgeC5jaGFyQ29kZUF0KCkpLnRvU3RyaW5nKDE2KS5zdWJzdHIoLTIpKS5qb2luKCIiKTsKCX0KCglhc2NpaV92YWx1ZShjKSB7CgkJLy8gcmVzdHJpY3QgaW5wdXQgdG8gYSBzaW5nbGUgY2hhcmFjdGVyCgkJYyA9IGMuY2hhckF0KDApOwoKCQkvLyBsb29wIHRocm91Z2ggYWxsIHBvc3NpYmxlIEFTQ0lJIHZhbHVlcwoJCXZhciBpOwoJCWZvciAoaSA9IDA7IGkgPCAyNTY7ICsraSkgewoJCQkvLyBjb252ZXJ0IGkgaW50byBhIDItZGlnaXQgaGV4IHN0cmluZwoJCQl2YXIgaCA9IGkudG9TdHJpbmcoMTYpOwoJCQlpZiAoaC5sZW5ndGggPT0gMSkgaCA9ICcwJyArIGg7CgoJCQkvLyBpbnNlcnQgYSAlIGNoYXJhY3RlciBpbnRvIHRoZSBzdHJpbmcKCQkJaCA9ICclJyArIGg7CgoJCQkvLyBkZXRlcm1pbmUgdGhlIGNoYXJhY3RlciByZXByZXNlbnRlZCBieSB0aGUgZXNjYXBlIGNvZGUKCQkJaCA9IHVuZXNjYXBlKGgpOwoKCQkJLy8gaWYgdGhlIGNoYXJhY3RlcnMgbWF0Y2gsIHdlJ3ZlIGZvdW5kIHRoZSBBU0NJSSB2YWx1ZQoJCQlpZiAoaCA9PSBjKSBicmVhazsKCQl9CgkJcmV0dXJuIGk7Cgl9CgoJLyoqCgkgKiBEYXRlIEZ1bmN0aW9ucwoJICovCglkYXlzRGlmZihkMiwgZDEpIHsKCQlyZXR1cm4gTWF0aC5jZWlsKChkMi5nZXRUaW1lKCkgLSBkMS5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKTsKCX0KCglhZGRNU2Vjb25kcyhvLCBtcykgewoJCXJldHVybiBuZXcgRGF0ZShvLmdldFRpbWUoKSArIG1zKTsKCX0KCglhZGRTZWNvbmRzKG8sIHMpIHsKCQlyZXR1cm4gdGhpcy5hZGRNU2Vjb25kcyhvLCBzICogMTAwMCk7Cgl9CgoJYWRkTWludXRlcyhvLCBtKSB7CgkJcmV0dXJuIHRoaXMuYWRkU2Vjb25kcyhvLCBtICogNjApOwoJfQoKCWFkZEhvdXJzKG8sIGgpIHsKCQlyZXR1cm4gdGhpcy5hZGRNaW51dGVzKG8sIGggKiA2MCk7Cgl9CgoJYWRkRGF5cyhvLCBkKSB7CgkJcmV0dXJuIHRoaXMuYWRkSG91cnMobywgZCAqIDI0KTsKCX0KCglhZGRZZWFycyhvLCB5KSB7CgkJcmV0dXJuIHRoaXMuYWRkTW9udGhzKG8sIHkgKiAxMik7Cgl9CgoJYWRkTW9udGhzKG8sIG0pIHsKCQlyZXR1cm4gbmV3IERhdGUoCgkJCW8uZ2V0RnVsbFllYXIoKSwKCQkJby5nZXRNb250aCgpICsgbSwKCQkJby5nZXREYXRlKCksCgkJCW8uZ2V0SG91cnMoKSwKCQkJby5nZXRNaW51dGVzKCksCgkJCW8uZ2V0U2Vjb25kcygpCgkJKTsKCX0KCglpc0RhdGUobykgewoJCXJldHVybiAoCgkJCW8gIT0gbnVsbCAmJgoJCQlvLmNvbnN0cnVjdG9yICE9IG51bGwgJiYKCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ2Z1bmN0aW9uIERhdGUoJykgPiAtMQoJCSk7Cgl9CgoJdG9TaG9ydERhdGUobykgewoJCWlmICghdGhpcy5pc0RhdGUobykpIHJldHVybiAnJzsgLy8gYXZvaWQgbnVsbHMKCQlyZXR1cm4gby5nZXRNb250aCgpICsgMSArICcvJyArIG8uZ2V0RGF0ZSgpICsgJy8nICsgby5nZXRGdWxsWWVhcigpOwoJfQoKCXRvU2hvcnRUaW1lKG8pIHsKCQlpZiAoIXRoaXMuaXNEYXRlKG8pKSByZXR1cm4gJyc7IC8vIGF2b2lkIG51bGxzCgkJdmFyIGhvdXJzID0gJycgKyBvLmdldEhvdXJzKCk7IC8vby5nZXRIb3VycygpJTEyOwoJCXZhciBtaW51dGVzID0gJycgKyBvLmdldE1pbnV0ZXMoKTsKCQl2YXIgc2Vjb25kcyA9ICcnICsgby5nZXRTZWNvbmRzKCk7CgkJaWYgKGhvdXJzLmxlbmd0aCA8IDIpIGhvdXJzID0gJzAnICsgaG91cnM7CgkJaWYgKG1pbnV0ZXMubGVuZ3RoIDwgMikgbWludXRlcyA9ICcwJyArIG1pbnV0ZXM7CgkJaWYgKHNlY29uZHMubGVuZ3RoIDwgMikgc2Vjb25kcyA9ICcwJyArIHNlY29uZHM7CgkJcmV0dXJuIGhvdXJzICsgJzonICsgbWludXRlcyArICc6JyArIHNlY29uZHM7IC8vICsgIiAiICsgKG8uZ2V0SG91cnMoKT49MTI/IlBNIjoiQU0iKTsKCX0KCgl0b0RhdGVUaW1lKG8pIHsKCQlpZiAoIXRoaXMuaXNEYXRlKG8pKSByZXR1cm4gJyc7IC8vIGF2b2lkIG51bGxzCgkJcmV0dXJuIHRoaXMudG9TaG9ydERhdGUobykgKyAnICcgKyB0aGlzLnRvU2hvcnRUaW1lKG8pOwoJfQoJLyoqCgkgKiBFTkQ6IERhdGUgRnVuY3Rpb25zCgkgKi8KCglzZXRQcm9wZXJ0eShjaWQsIHMsIHByb3AsIGRlZikgewoJCWlmICghY2lkKSByZXR1cm47CgkJdmFyIG8gPSAkKGNpZCk7CgkJaWYgKCFvKSByZXR1cm47CgoJCWlmICghcHJvcCkgewoJCQlpZiAoby50YWdOYW1lID09ICdJTlBVVCcpIHsKCQkJCXByb3AgPSAndmFsdWUnOwoJCQkJaWYgKG8udHlwZSA9PSAndGV4dCcpIHByb3AgPSAndmFsdWUnOwoJCQkJaWYgKG8udHlwZSA9PSAnY2hlY2tib3gnKSBwcm9wID0gJ2NoZWNrZWQnOwoJCQl9IGVsc2UgewoJCQkJcHJvcCA9ICdpbm5lckhUTUwnOwoJCQl9CgkJfQoJCWlmICghZGVmKSBkZWYgPSAnJzsKCQlpZiAodGhpcy5wcmVQcm9jZXNzSFRNTCkgZGVmID0gdGhpcy5wcmVQcm9jZXNzSFRNTChkZWYpOwoKCQlpZiAodGhpcy5pc0RhdGUocykpIHsKCQkJLy8gYSBkYXRlIGZpZWxkCgkJCXMgPSB0aGlzLnRvU2hvcnREYXRlKHMpOwoJCX0gZWxzZSB7CgkJCWlmICh0aGlzLnByZVByb2Nlc3NIVE1MKSBzID0gdGhpcy5wcmVQcm9jZXNzSFRNTChzKTsKCQl9CgoJCXdpbmRvdy5wcm9wZXJ0eVZhbHVlID0gczsKCQl0cnkgewoJCQl0aGlzLnJ1blNjcmlwdCgKCQkJCSIkKCciICsgby5pZCArICInKS4iICsgcHJvcCArICcgPSB3aW5kb3cucHJvcGVydHlWYWx1ZTsnCgkJCSk7CgkJfSBjYXRjaCAoZSkgewoJCQl0aGlzLlNob3dFcnJvcihlLm1lc3NhZ2UpOwoJCQl0aGlzLnJ1blNjcmlwdCgiJCgnIiArIG8uaWQgKyAiJykuIiArIHByb3AgKyAnID0gIicgKyBkZWYgKyAnIjsnKTsKCQl9CgkJd2luZG93LnByb3BlcnR5VmFsdWUgPSBudWxsOwoJfQoKCS8qKgoJICogVmFsaWRhdGlvbgoJICovCgl2YWxpZE5vdE51bGwocykgewoJCWlmICh0eXBlb2YgcyA9PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gcyAmJiBzLmxlbmd0aCA+IDA7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHMgIT0gbnVsbDsKCQl9Cgl9CgoJdmFsaWRPYmplY3QobykgewoJCXJldHVybiBvICE9IG51bGw7Cgl9CgoJdmFsaWRFbWFpbChzdHIpIHsKCQl2YXIgYXQgPSAnQCc7CgkJdmFyIGRvdCA9ICcuJzsKCQl2YXIgbGF0ID0gc3RyLmluZGV4T2YoYXQpOwoJCXZhciBsc3RyID0gc3RyLmxlbmd0aDsKCQl2YXIgbGRvdCA9IHN0ci5pbmRleE9mKGRvdCk7CgkJaWYgKAoJCQlzdHIuaW5kZXhPZihhdCkgPT0gLTEgfHwKCQkJc3RyLmluZGV4T2YoYXQpID09IC0xIHx8CgkJCXN0ci5pbmRleE9mKGF0KSA9PSAwIHx8CgkJCXN0ci5pbmRleE9mKGF0KSA9PSBsc3RyIHx8CgkJCXN0ci5pbmRleE9mKGRvdCkgPT0gLTEgfHwKCQkJc3RyLmluZGV4T2YoZG90KSA9PSAwIHx8CgkJCXN0ci5pbmRleE9mKGRvdCkgPT0gbHN0ciB8fAoJCQlzdHIuaW5kZXhPZihhdCwgbGF0ICsgMSkgIT0gLTEgfHwKCQkJc3RyLnN1YnN0cmluZyhsYXQgLSAxLCBsYXQpID09IGRvdCB8fAoJCQlzdHIuc3Vic3RyaW5nKGxhdCArIDEsIGxhdCArIDIpID09IGRvdCB8fAoJCQlzdHIuaW5kZXhPZihkb3QsIGxhdCArIDIpID09IC0xIHx8CgkJCXN0ci5pbmRleE9mKCcgJykgIT0gLTEKCQkpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCgl2YWxpZGF0ZShvLCB0eXBlLCBjb25maWcpIHsKCQlpZiAodHlwZW9mIG8gPT0gJ3N0cmluZycpIG8gPSAkKG8pOwoJCXZhciBiQWxlcnQgPSB0cnVlOwoJCWlmICghbykgcmV0dXJuOwoKCQlpZiAoIWNvbmZpZykgY29uZmlnID0ge307CgkJdmFyIG9FcnIgPSAkKG8uaWQgKyAnX0Vycm9yJyk7CgkJaWYgKCFvRXJyICYmIGRvY3VtZW50Lmluc2VydEFkamFjZW50RWxlbWVudCkgewoJCQliQWxlcnQgPSBmYWxzZTsKCQkJb0VyciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ1NQQU4nKTsKCQkJb0Vyci5pZCA9IG8uaWQgKyAnX0Vycm9yJzsKCQkJb0Vyci5jbGFzc05hbWUgPSAnZXJyb3InOwoJCQlvLmluc2VydEFkamFjZW50RWxlbWVudCgnYWZ0ZXJFbmQnLCBvRXJyKTsKCQl9CgoJCWlmICghY29uZmlnWydmaWVsZCddKSB7CgkJCXZhciB0YWcgPSBvLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCQkJaWYgKAoJCQkJKHRhZyA9PSAnc3BhbicgfHwgdGFnID09ICdhJykgJiYKCQkJCShvLmdldEF0dHJpYnV0ZSgnZnJvbScpIHx8IG8uZ2V0QXR0cmlidXRlKCdsb29rdXAnKSkKCQkJKSB7CgkJCQljb25maWdbJ2ZpZWxkJ10gPSAnU2VsZWN0ZWRJdGVtJzsKCQkJCXR5cGUgPSAnT2JqZWN0JzsKCQkJfSBlbHNlIHsKCQkJCWNvbmZpZ1snZmllbGQnXSA9ICd2YWx1ZSc7CgkJCX0KCQl9CgkJaWYgKCF0eXBlKSB0eXBlID0gJ05vdE51bGwnOwoKCQlpZiAoIWNvbmZpZ1snbGFiZWwnXSkgewoJCQl2YXIgdGl0bGUgPSBvLmdldEF0dHJpYnV0ZSgndGl0bGUnKTsKCQkJaWYgKCF0aXRsZSkgewoJCQkJdGl0bGUgPSBvLmlkLnNwbGl0KCdfJyk7CgkJCQl0aXRsZSA9IHRpdGxlWzFdOwoJCQkJdGl0bGUgPSB0aXRsZS5zdWJzdHIoMyk7CgkJCQl0aXRsZSA9IHRoaXMuRW5nbGlzaE5hbWUodGl0bGUpOwoJCQl9CgkJCWNvbmZpZ1snbGFiZWwnXSA9IHRpdGxlOwoJCX0KCQlpZiAoIWNvbmZpZ1snbWVzc2FnZSddKSBjb25maWdbJ21lc3NhZ2UnXSA9ICdJbnZhbGlkIFZhbHVlJzsKCgkJdmFyIGJWYWxpZCA9IHRydWU7CgkJd2luZG93LnZhbGlkYXRpb25WYWx1ZSA9IHdpbmRvdy5jbXMudihvKTsgLy9bY29uZmlnWyJmaWVsZCJdXTsvL3ZhbHVlCgkJYlZhbGlkID0KCQkJYlZhbGlkICYmCgkJCXRoaXMucnVuU2NyaXB0KAoJCQkJJ3dpbmRvdy5jbXMuc3IudmFsaWQnICsgdHlwZSArICcod2luZG93LnZhbGlkYXRpb25WYWx1ZSknCgkJCSk7CgkJd2luZG93LnZhbGlkYXRpb25WYWx1ZSA9IG51bGw7CgoJCWlmICghYlZhbGlkKSB7CgkJCS8vby52YWx1ZSA9ICIiOwoJCQkvL28uZm9jdXMoKTsKCQkJc01lc3NhZ2UgPSBjb25maWdbJ21lc3NhZ2UnXTsKCQl9IGVsc2UgewoJCQlzTWVzc2FnZSA9ICcnOwoJCX0KCgkJaWYgKCFiVmFsaWQpIHsKCQkJaWYgKGJBbGVydCkgewoJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgKz0KCQkJCQknXG4nICsgY29uZmlnWydsYWJlbCddICsgJzogJyArIHNNZXNzYWdlOwoJCQl9IGVsc2UgewoJCQkJb0Vyci5pbm5lckhUTUwgPSBzTWVzc2FnZTsKCQkJfQoJCX0KCX0KCS8qKgoJICogRU5EOiBWYWxpZGF0aW9uCgkgKi8KCglFbmdsaXNoTmFtZShzKSB7CgkJcmV0dXJuIHMucmVwbGFjZSgvXlthLXpdfFtBLVpdL2csICh2LCBpKSA9PiBpID09PSAwID8gdi50b1VwcGVyQ2FzZSgpIDogIiAiICsgdi50b0xvd2VyQ2FzZSgpKTsKCgkJdmFyIHJldCA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoc1tpXSA+PSAnQScgJiYgc1tpXSA8PSAnWicpIHsKCQkJCXJldCArPSAocmV0Lmxlbmd0aCA9PSAwID8gJycgOiAnICcpICsgc1tpXTsKCQkJfSBlbHNlIGlmIChyZXQubGVuZ3RoID09IDApIHsKCQkJCXJldCArPSAoc1tpXSArICcnKS50b1VwcGVyQ2FzZSgpOwoJCQl9IGVsc2UgewoJCQkJcmV0ICs9IHNbaV07CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJLyoqIE9iamVjdCBDb21wYXJpc29uICoqLwoJbmV3T2JqZWN0KCkgewoJCXZhciByZXQgPSBuZXcgT2JqZWN0KCk7CgkJcmV0Ll9fT0JKRUNUSUQgPSBNYXRoLnJhbmRvbSgpOwoJCXJldHVybiByZXQ7Cgl9CgoJRXF1YWxzKG8xLCBvMikgewoJCWlmIChvMSA9PSBvMikgcmV0dXJuIHRydWU7CgoJCWlmICgKCQkJbzEgJiYKCQkJbzEuX19PQkpFQ1RJRCAmJgoJCQlvMiAmJgoJCQlvMi5fX09CSkVDVElEICYmCgkJCW8xLl9fT0JKRUNUSUQgPT0gbzIuX19PQkpFQ1RJRAoJCSkKCQkJcmV0dXJuIHRydWU7CgkJaWYgKG8xICYmIG8xLl9fUk9XSUQgJiYgbzIgJiYgbzIuX19ST1dJRCAmJiBvMS5fX1JPV0lEID09IG8yLl9fUk9XSUQpCgkJCXJldHVybiB0cnVlOwoJCWlmIChvMSAmJiBvMS5JZCAmJiBvMiAmJiBvMi5JZCAmJiBvMS5JZCA9PSBvMi5JZCkgcmV0dXJuIHRydWU7CgoJCXJldHVybiBmYWxzZTsKCX0KCS8qKiBPYmplY3QgQ29tcGFyaXNvbiAqKi8KCglzZXJpYWxpemUoX29iaikgewoJCXRyeSB7CgkJCS8vIExldCBHZWNrbyBicm93c2VycyBkbyB0aGlzIHRoZSBlYXN5IHdheQoJCQlpZiAoCgkJCQl0eXBlb2YgX29iai50b1NvdXJjZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCXR5cGVvZiBfb2JqLmNhbGxlZSA9PT0gJ3VuZGVmaW5lZCcKCQkJKSB7CgkJCQlyZXR1cm4gX29iai50b1NvdXJjZSgpOwoJCQl9CgkJCS8vIE90aGVyIGJyb3dzZXJzIG11c3QgZG8gaXQgdGhlIGhhcmQgd2F5CgkJCXN3aXRjaCAodHlwZW9mIF9vYmopIHsKCQkJCS8vIG51bWJlcnMsIGJvb2xlYW5zLCBhbmQgZnVuY3Rpb25zIGFyZSB0cml2aWFsOgoJCQkJLy8ganVzdCByZXR1cm4gdGhlIG9iamVjdCBpdHNlbGYgc2luY2UgaXRzIGRlZmF1bHQgLnRvU3RyaW5nKCkKCQkJCS8vIGdpdmVzIHVzIGV4YWN0bHkgd2hhdCB3ZSB3YW50CgkJCQljYXNlICdudW1iZXInOgoJCQkJY2FzZSAnYm9vbGVhbic6CgkJCQljYXNlICdmdW5jdGlvbic6CgkJCQkJcmV0dXJuIF9vYmo7CgkJCQkJLy8gZm9yIEpTT04gZm9ybWF0LCBzdHJpbmdzIG5lZWQgdG8gYmUgd3JhcHBlZCBpbiBxdW90ZXMKCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJcmV0dXJuICInIiArIF9vYmogKyAiJyI7CgkJCQljYXNlICdvYmplY3QnOgoJCQkJCXZhciBzdHI7CgkJCQkJaWYgKAoJCQkJCQlfb2JqLmNvbnN0cnVjdG9yID09PSBBcnJheSB8fAoJCQkJCQl0eXBlb2YgX29iai5jYWxsZWUgIT09ICd1bmRlZmluZWQnCgkJCQkJKSB7CgkJCQkJCXN0ciA9ICdbJzsKCQkJCQkJdmFyIGksCgkJCQkJCQlsZW4gPSBfb2JqLmxlbmd0aDsKCQkJCQkJZm9yIChpID0gMDsgaSA8IGxlbiAtIDE7IGkrKykgewoJCQkJCQkJc3RyICs9IHRoaXMuc2VyaWFsaXplKF9vYmpbaV0pICsgJywnOwoJCQkJCQl9CgkJCQkJCXN0ciArPSB0aGlzLnNlcmlhbGl6ZShfb2JqW2ldKSArICddJzsKCQkJCQl9IGVsc2UgewoJCQkJCQlzdHIgPSAneyc7CgkJCQkJCXZhciBrZXk7CgkJCQkJCWZvciAoa2V5IGluIF9vYmopIHsKCQkJCQkJCXN0ciArPSBrZXkgKyAnOicgKyB0aGlzLnNlcmlhbGl6ZShfb2JqW2tleV0pICsgJywnOwoJCQkJCQl9CgkJCQkJCXN0ciA9IHN0ci5yZXBsYWNlKC9cLCQvLCAnJykgKyAnfSc7CgkJCQkJfQoJCQkJCXJldHVybiBzdHI7CgkJCQlkZWZhdWx0OgoJCQkJCXJldHVybiAnVU5LTk9XTic7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCXRoaXMuU2hvd0RlYnVnKGUubWVzc2FnZSk7CgkJfQoJfQp9",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
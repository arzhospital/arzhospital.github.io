{
	"Id": "ddfbae46c0973fd6eb86ff01813f11db83f92c14",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "DynaForm",
	"order": null,
	"script": "d2luZG93LkR5bmFGb3JtID0gY2xhc3MgewoJY29uc3RydWN0b3IoKSB7CgkJdGhpcy50aXRsZSA9ICJGb3JtIFRpdGxlIjsKCQl0aGlzLm5hbWUgPSAiZnJtRm9ybSI7CgkJdGhpcy5lbGVtZW50cyA9IFtdOwoJCXRoaXMuc2VsZWN0cyA9IFtdOwoJCXRoaXMuZ3JpZHMgPSBbXTsKCQl0aGlzLmJ1dHRvbnMgPSBbXTsKCQl0aGlzLnpvbmVzID0gWydub3J0aCcsICdzb3V0aCcsICdlYXN0JywgJ3dlc3QnLCAnY2VudGVyJ107CgkJdGhpcy5zVGFibGUgPSBudWxsOwoJCXRoaXMuYkRlYnVnID0gZmFsc2U7CgkJdGhpcy51aVR5cGVzID0gewoJCQlpbnQ6ICJudW1iZXJzcGlubmVyIiwKCQkJbWVudTogInNwbGl0YnV0dG9uIiwKCQkJZGF0ZXRpbWU6ICJkYXRldGltZWJveCIsCgkJCWJvb2w6ICJzd2l0Y2hidXR0b24iLAoJCQlmaWxlOiAiZmlsZWJveCIsCgkJCXRleHQ6ICJ0ZXh0Ym94IiwKCQkJbGFiZWw6ICJodG1sIiwKCQkJcGFzc3dvcmQ6ICJwYXNzd29yZGJveCIsCgkJCXN0cmluZzogInRleHRib3giLAoJCQlpbWFnZTogImRpYWxvZyIsCgkJCXByb2dyZXNzOiAicHJvZ3Jlc3NiYXIiLAoJCQlsaW5rOiAibGlua2J1dHRvbiIsCgkJCXRyZWU6ICJjb21ib3RyZWUiLAoJCQluYXZpZ2F0aW9uOiAidHJlZSIsCgkJCXNlYXJjaDogJ3NlYXJjaGJveCcsCgkJfTsKCQl0aGlzLmV2ZW50cyA9IFt7CgkJCW5hbWU6ICdvbkNsaWNrJywKCQkJaGFuZGxlcjogJ29uVG9nZ2xlJywKCQkJcGFyYW1zOiAnbj1ldmVudCcsCgkJCXR5cGU6ICd0b2dnbGUnLAoJCX0sIHsKCQkJbmFtZTogJ29uQ2xvc2UnLAoJCQloYW5kbGVyOiAnUGFuT25DbG9zZScsCgkJCXBhcmFtczogJ249ZXZlbnQnLAoJCQl0eXBlOiAnd2luZG93JywKCQl9LCB7CgkJCW5hbWU6ICdvblNlbGVjdCcsCgkJCWhhbmRsZXI6ICdTZWxlY3RDaGFuZ2UnLAoJCQlwYXJhbXM6ICduJywKCQkJdHlwZTogJ3RhYnMnLAoJCX0sIHsKCQkJbmFtZTogJ3NlYXJjaGVyJywKCQkJaGFuZGxlcjogJ0ZpZWxkQ2hhbmdlJywKCQkJcGFyYW1zOiAnbiwgbycsCgkJCXR5cGU6ICdzZWFyY2hib3gnLAoJCX0sIHsKCQkJbmFtZTogJ29uQmVmb3JlRXhwYW5kJywKCQkJaGFuZGxlcjogJ0V4cGFuZCcsCgkJCXBhcmFtczogJ24nLAoJCQl0eXBlOiAndHJlZScsCgkJfSwgewoJCQluYW1lOiAnb25DaGFuZ2UnLAoJCQloYW5kbGVyOiAnRmllbGRDaGFuZ2UnLAoJCQlwYXJhbXM6ICduLCBvJywKCQl9LCB7CgkJCW5hbWU6ICdvbkJlZm9yZU9wZW4nLAoJCQloYW5kbGVyOiAnUGFuZWxPcGVuJywKCQkJcGFyYW1zOiAnJywKCQkJdHlwZTogJ3dpbmRvdycsCgkJfSwgewoJCQluYW1lOiAnb25PcGVuJywKCQkJaGFuZGxlcjogJ1BlbmRBZnRlck9wZW4nLAoJCQlwYXJhbXM6ICcnLAoJCQl0eXBlOiAnd2luZG93JywKCQl9LCB7CgkJCW5hbWU6ICdvbkNsaWNrJywKCQkJaGFuZGxlcjogJ2RvTGluaycsCgkJCXBhcmFtczogJ249ZXZlbnQsIG8nLAoJCQl0eXBlOiAnbGluaycsCgkJfSwgewoJCQluYW1lOiAnb25DbGlja1JvdycsCgkJCWhhbmRsZXI6ICdGaWVsZENoYW5nZScsCgkJCXBhcmFtczogJ24sIG8nLAoJCQl0eXBlOiAnZ3JpZCcsCgkJfV07CgoJCWlmICh0eXBlb2YoJCkgIT09ICd1bmRlZmluZWQnKSAkKHdpbmRvdykucmVzaXplKHRoaXMud2luZG93UmVzaXplZCk7CgkJdGhpcy53aW5kb3dSZXNpemVkKCk7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuIHR5cGVvZihfRnJFTUQpICE9PSAndW5kZWZpbmVkJyA/IF9GckVNRC5zcigpIDogd2luZG93LnNyOwoJfQoKCXBhcnNlKCkgewoJCSQucGFyc2VyLnBhcnNlKCk7Cgl9CgoJd2luZG93UmVzaXplZCgpIHsKCQl0aGlzLndpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CgkJdGhpcy5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgKiAwLjg7Cgl9CgoJaW5pdCgpIHsKCQl2YXIgc2VsZWN0ID0gewoJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCXZhciBvcCA9IG51bGw7CgkJCQl2YXIgZm9wID0gbnVsbDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5ncmlkcy5sZW5ndGg7IGkrKykKCQkJCQlpZiAodHJ1ZSB8fCB0aGlzLmdyaWRzW2ldLmlkID09IG9wdGlvbnMuc291cmNlKSBvcCA9IHRoaXMuZ3JpZHNbaV0ub3B0aW9uczsKCQkJCWZvciAoaSA9IDA7IGkgPCBvcC5jb2x1bW5zLmxlbmd0aDsgaSsrKQoJCQkJCWlmIChvcC5jb2x1bW5zW2ldLm5hbWUgPT0gb3B0aW9ucy5maWVsZCkgZm9wID0gb3AuY29sdW1uc1tpXTsKCQkJCWZvcC53aWR0aCA9ICh0aGlzLndpZHRoIC8gMyk7CgkJCQl2YXIgZSA9ICQodGhpcy5zZWxlY3QoZm9wKSk7CgkJCQl2YXIgaW5wdXQgPSBlLmFwcGVuZFRvKGNvbnRhaW5lcik7CgkJCQlpbnB1dC5jb21ib2dyaWQoKTsKCQkJCXRoaXMuYmluZChpbnB1dCk7CgkJCQlyZXR1cm4gaW5wdXQ7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKHRhcmdldCkgewoJCQkJJCh0YXJnZXQpLnJlbW92ZSgpOwoJCQl9LAoJCQlnZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQlyZXR1cm4gJCh0YXJnZXQpLnZhbCgpOwoJCQl9LAoJCQlzZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0LCB2YWx1ZSkgewoJCQkJJCh0YXJnZXQpLnZhbCh2YWx1ZSk7CgkJCX0sCgkJCXJlc2l6ZTogZnVuY3Rpb24odGFyZ2V0LCB3aWR0aCkgewoJCQkJJCh0YXJnZXQpLl9vdXRlcldpZHRoKHdpZHRoKTsKCQkJfQoJCX07CgkJJC5leHRlbmQoJC5mbi5kYXRhZ3JpZC5kZWZhdWx0cy5lZGl0b3JzLCB7CgkJCWRhdGV0aW1lOiB7CgkJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCQlvcHRpb25zLndpZHRoID0gdGhpcy5jV2lkdGgob3B0aW9ucyk7CgkJCQkJdmFyIGlucHV0ID0gJCh0aGlzLmRhdGV0aW1lKG9wdGlvbnMpKS5hcHBlbmRUbyhjb250YWluZXIpOwoJCQkJCWlucHV0LmRhdGV0aW1lYm94KCk7CgkJCQkJcmV0dXJuIGlucHV0OwoJCQkJfSwKCQkJCWRlc3Ryb3k6IGZ1bmN0aW9uKHRhcmdldCkgewoJCQkJCSQodGFyZ2V0KS5yZW1vdmUoKTsKCQkJCX0sCgkJCQlnZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQkJcmV0dXJuICQodGFyZ2V0KS52YWwoKTsKCQkJCX0sCgkJCQlzZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0LCB2YWx1ZSkgewoJCQkJCSQodGFyZ2V0KS52YWwodmFsdWUpOwoJCQkJfSwKCQkJCXJlc2l6ZTogZnVuY3Rpb24odGFyZ2V0LCB3aWR0aCkgewoJCQkJCSQodGFyZ2V0KS5fb3V0ZXJXaWR0aCh3aWR0aCk7CgkJCQl9CgkJCX0sCgkJCWNoZWNrYm94OiB7CgkJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCQl2YXIgaW5wdXQgPSAkKHRoaXMuYm9vbChvcHRpb25zKSkuYXBwZW5kVG8oY29udGFpbmVyKTsKCQkJCQlpbnB1dC5zd2l0Y2hidXR0b24oKTsKCQkJCQlyZXR1cm4gaW5wdXQ7CgkJCQl9LAoJCQkJZGVzdHJveTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQkJJCh0YXJnZXQpLnJlbW92ZSgpOwoJCQkJfSwKCQkJCWdldFZhbHVlOiBmdW5jdGlvbih0YXJnZXQpIHsKCQkJCQlyZXR1cm4gJCh0YXJnZXQpLnZhbCgpOwoJCQkJfSwKCQkJCXNldFZhbHVlOiBmdW5jdGlvbih0YXJnZXQsIHZhbHVlKSB7CgkJCQkJJCh0YXJnZXQpLnZhbCh2YWx1ZSk7CgkJCQl9LAoJCQkJcmVzaXplOiBmdW5jdGlvbih0YXJnZXQsIHdpZHRoKSB7CgkJCQkJJCh0YXJnZXQpLl9vdXRlcldpZHRoKHdpZHRoKTsKCQkJCX0KCQkJfSwKCQkJY29tYm90cmVlZ3JpZDogc2VsZWN0LAoJCQlzZWxlY3Q6IHNlbGVjdCwKCQl9KTsKCX0KCglhc2socXVlc3Rpb24sIGZBbnN3ZXIgPSB2ID0+IHYsIG9wdGlvbnMpIHsKCQkkLm1lc3NhZ2VyLmNvbmZpcm0odGhpcy50aXRsZSwgcXVlc3Rpb24sIGZ1bmN0aW9uKHIpIHsKCQkJaWYgKG9wdGlvbnMpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChvcHRpb25zW2ldLmFuc3dlciA9PSByKSB7CgkJCQkJCXJldHVybiBmQW5zd2VyKG9wdGlvbnNbaV0udmFsdWUpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXJldHVybiBmQW5zd2VyKHIpOwoJCQl9CgkJfSk7Cgl9CgoJdG9wRGF0YShhciwgZ0ZpZWxkLCB2RmllbGQsIHRvcCkgewoJCWlmICghdG9wKSB7CgkJCXJldHVybiBhcjsKCQl9CgkJcmV0ID0gW107CgkJJC5lYWNoKHRoaXMuc3IoKS5ncm91cEJ5KGFyLCBnRmllbGQpLCBmdW5jdGlvbihrZXksIHZhbHVlcykgewoJCQl2YWx1ZXMudmFsdWVzLnNvcnQoKGEsIGIpID0+IHsKCQkJCWlmIChwYXJzZUZsb2F0KGFbdkZpZWxkXSkgPCBwYXJzZUZsb2F0KGJbdkZpZWxkXSkpIHsKCQkJCQlyZXR1cm4gMTsKCQkJCX0gZWxzZSBpZiAocGFyc2VGbG9hdChhW3ZGaWVsZF0pID4gcGFyc2VGbG9hdChiW3ZGaWVsZF0pKSB7CgkJCQkJcmV0dXJuIC0xOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gMDsKCQkJCX0KCQkJfSk7CgkJCSQuZWFjaCh2YWx1ZXMudmFsdWVzLCBmdW5jdGlvbihpLCB2KSB7CgkJCQlpZiAoaSA8IHRvcCkgewoJCQkJCXJldC5wdXNoKHYpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGRvQ2xpY2soYnV0dG9uKSB7CgkJbGV0IF90aGlzID0gdHlwZW9mKHRoaXMuZG9DbGljaykgPT09ICdmdW5jdGlvbicgPyB0aGlzIDogd2luZG93LkRGb3JtOwoJCWJ1dHRvbiA9IF90aGlzLmJ1dHRvbnMuZmluZChiID0+IGIubmFtZSA9PSBidXR0b24ubmFtZSAmJiBiLmdyb3VwID09IGJ1dHRvbi5ncm91cCk7CgkJX3RoaXMuYnVzeSh0cnVlKTsKCQlfdGhpcy5zZXQoewoJCQlXb3JrUHJvZ3Jlc3NWYWx1ZTogMjAKCQl9KQoKCQl2YXIgbyA9IF90aGlzLmdldCgpOwoJCXZhciBzTWlzc2luZyA9IF90aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+IChidXR0b24ud2luZG93ID8gYnV0dG9uLmdyb3VwID09IGUuZ3JvdXAgOiB0cnVlKSkuZmlsdGVyKGUgPT4gZS5yZXF1aXJlZCAmJiAhb1tlLm5hbWVdKS5tYXAoZSA9PiAiPGxpPiIgKyAoZS5sYWJlbCB8fCBlLm5hbWUpICsgIjwvbGk+Iikuam9pbigiIik7CgkJaWYgKHNNaXNzaW5nKSB7CgkJCXdpbmRvdy5fRnJFTUQuX2Vycm9yKCJNaXNzaW5nIG1hbmRhdG9yeSBmaWVsZHM6PGJyLz48dWw+IiArIHNNaXNzaW5nICsgIjwvdWw+IiwgNTAwMCk7CgkJCV90aGlzLmJ1c3koZmFsc2UpOwoJCQlyZXR1cm47CgkJfQoJCWlmIChidXR0b24ub25jbGljaykgYXdhaXQgYnV0dG9uLm9uY2xpY2sobyk7CgkJaWYgKGJ1dHRvbi5vbkNsaWNrKSBhd2FpdCBidXR0b24ub25DbGljayhvKTsKCQlfdGhpcy5idXN5KGZhbHNlKTsKCX0KCglidXN5KGJCdXN5KSB7CgkJaWYgKCFiQnVzeSkgewoJCQl2YXIgdG90YWwgPSAwOwoJCQlpZiAodHlwZW9mIG1vbWVudCAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRvdGFsID0gbW9tZW50KCkuZGlmZihtb21lbnQodGhpcy5idXN5U3RhbXApLCAnc2Vjb25kcycpOwoJCQl9IGVsc2UgewoJCQkJLy8gbm8gbW9tZW50LCB1c2Ugc3RhbmRhcmQgRGF0ZQoJCQkJdG90YWwgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLmJ1c3lTdGFtcCA/IHRoaXMuYnVzeVN0YW1wLmdldFRpbWUoKSA6IDApIC8gMTAwMCAvIDM2MDA7CgkJCX0KCQkJaWYgKHRoaXMuYkRlYnVnKSB7CgkJCQl3aW5kb3cuX0ZyRU1ELl9hbGVydCgiRXhlY3V0aW9uIFRpbWU6ICIgKyB0b3RhbCArICIgc2Vjb25kcy4iKTsKCQkJfQoJCQlkZWxldGUgdGhpcy5idXN5U3RhbXA7CgoJCQlzZXRJbnRlcnZhbCgxLCAoKSA9PiB0aGlzLlNldCh7CgkJCQlMb2FkaW5nOiAxMAoJCQl9KSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5idXN5U3RhbXAgPSBuZXcgRGF0ZSgpOwoJCX0KCgkJJC5lYWNoKCQubWVyZ2UoJC5tYXAodGhpcy5idXR0b25zLCBiID0+IGIubmFtZSksICQubWFwKHRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gZS50eXBlID09ICdsaW5rJyksIGUgPT4gZS5uYW1lKSksIChfLCBlKSA9PiAkKCcjJyArIGUpLmxpbmtidXR0b24oYkJ1c3kgPyAnZGlzYWJsZScgOiAnZW5hYmxlJykpOwoJfQoKCXByZWZpeChlKSB7CgkJc3dpdGNoIChlLnR5cGUpIHsKCQkJY2FzZSAnbGFiZWwnOgoJCQkJcmV0dXJuICdsYmwnOwoJCQljYXNlICd0ZXh0JzoKCQkJY2FzZSAnc3RyaW5nJzoKCQkJY2FzZSAnc2VhcmNoJzoKCQkJY2FzZSAncGFzc3dvcmQnOgoJCQkJcmV0dXJuICd0eHQnOwoJCQljYXNlICJEYXRlVGltZSI6CgkJCWNhc2UgImRhdGV0aW1lIjoKCQkJCXJldHVybiAnZHRwJzsKCQkJY2FzZSAiaW50IjoKCQkJY2FzZSAiaW50ZWdlciI6CgkJCWNhc2UgIm51bWJlciI6CgkJCWNhc2UgImxvbmciOgoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAnbnVkJzsKCQkJY2FzZSAnZmlsZSc6CgkJCQlyZXR1cm4gJ2ZpbCc7CgkJCWNhc2UgJ2ltYWdlJzoKCQkJCXJldHVybiAnaW1nJzsKCQkJY2FzZSAiYm9vbCI6CgkJCQlyZXR1cm4gJ2Noayc7CgkJCWNhc2UgIndpbmRvdyI6CgkJCQlyZXR1cm4gJ3BubCc7CgkJCWNhc2UgInByb2dyZXNzIjoKCQkJCXJldHVybiAncHJnJzsKCQkJY2FzZSAiZ3JpZCI6CgkJCWNhc2UgInRyZWUiOgoJCQljYXNlICJzZWxlY3QiOgoJCQkJcmV0dXJuICdjbWInOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuICcnOwoJCX0KCX0KCgljbGVhcihncm91cCkgewoJCXZhciBvID0ge307CgkJJC5lYWNoKHRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gZ3JvdXAgPyBlLmdyb3VwID09IGdyb3VwIDogdHJ1ZSksIChfLCBlKSA9PiB7CgkJCXZhciBuYW1lID0gKGUuZW1zU291cmNlID8gIl8iIDogIiIpICsgZS5uYW1lOwoJCQlzd2l0Y2ggKGUudHlwZSkgewoJCQkJY2FzZSAndGV4dCc6CgkJCQljYXNlICdzdHJpbmcnOgoJCQkJY2FzZSAnc2VhcmNoJzoKCQkJCWNhc2UgJ3Bhc3N3b3JkJzoKCQkJCWNhc2UgIkRhdGVUaW1lIjoKCQkJCWNhc2UgImRhdGV0aW1lIjoKCQkJCQlvW25hbWVdID0gIiI7CgkJCQkJYnJlYWs7CgkJCQljYXNlICJpbnQiOgoJCQkJY2FzZSAibnVtYmVyIjoKCQkJCWNhc2UgImludGVnZXIiOgoJCQkJY2FzZSAibG9uZyI6CgkJCQljYXNlICJMb25nIjoKCQkJCWNhc2UgInByb2dyZXNzIjoKCQkJCQlvW25hbWVdID0gMDsKCQkJCQlicmVhazsKCQkJCWNhc2UgInRyZWUiOgoJCQkJY2FzZSAic2VsZWN0IjoKCQkJCQlvW25hbWVdID0gbnVsbDsKCQkJCQlicmVhazsKCQkJCWNhc2UgImdyaWQiOgoJCQkJCW9bbmFtZV0gPyBvW25hbWVdLmRhdGEgPSBbXSA6IG51bGw7CgkJCQkJYnJlYWs7CgkJCQljYXNlICJib29sIjoKCQkJCQlvW25hbWVdID0gZmFsc2U7CgkJCQkJYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfSk7CgkJLy9jb25zb2xlLmxvZygiY2xlYXIiLCBvKTsKCQl0aGlzLnNldChvKTsKCQl0aGlzLmJ1c3koZmFsc2UpOwoJfQoKCXNldChvLCBlTmFtZSkgewoJCWlmIChlTmFtZSkgewoJCQl2YXIgb0VsZW1lbnQgPSB0aGlzLmJ5TmFtZShlTmFtZSk7CgkJCWlmICghb0VsZW1lbnQpIHJldHVybjsKCQkJdmFyIGF0dCA9IG51bGw7CgkJCWlmIChvICYmIG8uSWQgJiYgby5FbnRpdHlBdHRyaWJ1dGUpIHsKCQkJCS8vIGFuIEVudGl0eVZhbHVlCgkJCQlmb3IgKHZhciBwIGluIG8pCgkJCQkJaWYgKHAuZW5kc1dpdGgoIlZhbHVlIikpIGF0dCA9IHA7CgkJCQlvRWxlbWVudC5lbXNTb3VyY2UgPSBvOwoJCQl9CgkJCXRyeSB7CgkJCQlsZXQgZU5hbWUgPSAiIyIgKyB0aGlzLnByZWZpeChvRWxlbWVudCkgKyBvRWxlbWVudC5uYW1lOwoJCQkJbGV0IGVUeXBlID0gdGhpcy51aVR5cGVzW29FbGVtZW50LnR5cGVdOwoJCQkJLy8gY29uc29sZS5sb2coIkR5bmFGb3JtOjpzZXQoIiArIG9FbGVtZW50Lm5hbWUgKyAiKTogIiwgZU5hbWUsIGVUeXBlLCBvKTsKCQkJCXN3aXRjaCAob0VsZW1lbnQudHlwZSkgewoJCQkJCWNhc2UgJ2xhYmVsJzoKCQkJCQkJaWYgKGF0dCkgewoJCQkJCQkJJChlTmFtZSkuaHRtbChvW2F0dF0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJChlTmFtZSkuaHRtbCgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3RleHQnOgoJCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJY2FzZSAncGFzc3dvcmQnOgoJCQkJCWNhc2UgImludCI6CgkJCQkJY2FzZSAic2VhcmNoIjoKCQkJCQljYXNlICJpbnRlZ2VyIjoKCQkJCQljYXNlICJudW1iZXIiOgoJCQkJCWNhc2UgImxvbmciOgoJCQkJCWNhc2UgIkxvbmciOgoJCQkJCQlpZiAoYXR0KSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oInNldFZhbHVlIiwgb1thdHRdKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgic2V0VmFsdWUiLCAobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkRhdGVUaW1lIjoKCQkJCQljYXNlICJkYXRldGltZSI6CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCAob1thdHRdID8gdGhpcy5zcigpLnRvRGF0ZVRpbWUob1thdHRdKSA6ICIiKSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oJ3NldFZhbHVlJywgKG8gJiYgby5FbnRpdHlBdHRyaWJ1dGUpID8gIiIgOiAobyA/IHRoaXMuc3IoKS50b0RhdGVUaW1lKG8pIDogIiIpKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICJib29sIjoKCQkJCQkJaWYgKGF0dCkgewoJCQkJCQkJJChlTmFtZSlbZVR5cGVdKChvW2F0dF0gPyAnJyA6ICd1bicpICsgJ2NoZWNrJyk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oKCgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pID8gJycgOiAndW4nKSArICdjaGVjaycpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIndpbmRvdyI6CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCW9FbGVtZW50LnZhbHVlID0gb1thdHRdOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJb0VsZW1lbnQudmFsdWUgPSAobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG87CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAicHJvZ3Jlc3MiOgoJCQkJCQl2YXIgdiA9IDA7CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCXYgPSBvW2F0dF07CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl2ID0gKG8gJiYgby5FbnRpdHlBdHRyaWJ1dGUpID8gIiIgOiBvOwoJCQkJCQl9CgkJCQkJCS8vY29uc29sZS5sb2coIiMiICsgdGhpcy5wcmVmaXgob0VsZW1lbnQpICsgb0VsZW1lbnQubmFtZSwgdGhpcy51aVR5cGVzW29FbGVtZW50LnR5cGVdLCBNYXRoLnJvdW5kKHYgKiAxMCkgLyAxMCk7CgkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCBNYXRoLnJvdW5kKHYgKiAxMCkgLyAxMCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgImdyaWQiOgoJCQkJCQlsZXQgY29scyA9IEpTT04ucGFyc2UoInsiICsgdGhpcy5tYXBDb2x1bW5zKG9FbGVtZW50LCB0cnVlKSArICJ9Iik7CgkJCQkJCSQuZWFjaChjb2xzLmNvbHVtbnNbMF0sIChfLCBjKSA9PiBjLmZvcm1hdHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQodGhpcy5mb3JtYXR0ZXIob0VsZW1lbnQubmFtZSwgYykpKTsKCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoY29scyk7CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCSQoZU5hbWUpLmRhdGFncmlkKHsKCQkJCQkJCQlkYXRhOiBvW2F0dF0KCQkJCQkJCX0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoewoJCQkJCQkJCWRhdGE6IChvICYmIG8uRW50aXR5QXR0cmlidXRlKSA/ICIiIDogbwoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoInVuc2VsZWN0QWxsIik7CgkJCQkJCSQoZU5hbWUpLmRhdGFncmlkKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgInRyZWUiOgoJCQkJCQl2YXIgdiA9IGF0dCA/IG9bYXR0XSA6ICgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQlpZiAoQXJyYXkuaXNBcnJheSh2KSkgewoJCQkJCQkJJChlTmFtZSlbZVR5cGVdKCJ0cmVlIikudHJlZSgibG9hZERhdGEiLCB2KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCB2KTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICJzZWxlY3QiOgoJCQkJCQlpZiAoYXR0KSB7CgkJCQkJCQlpZiAob0VsZW1lbnQub3B0aW9ucykgewoJCQkJCQkJCSQoZU5hbWUpLmNvbWJvKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIChvW2F0dF0gPyBvW2F0dF0gOiAiIikpOwoJCQkJCQkJCSQoZU5hbWUpLmNvbWJvKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIChvW2F0dF0gPyBvW2F0dF0gOiAiIikpOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkkKGVOYW1lKS5jb21ib2dyaWQoJ3NldFZhbHVlJyArIChvRWxlbWVudC5tdWx0aXBsZSA/ICdzJyA6ICcnKSwgKG9bYXR0XSA/IG9bYXR0XSA6ICIiKSk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl2ID0gbnVsbDsKCQkJCQkJCWlmIChvID09PSBudWxsKSB7CgoJCQkJCQkJfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewoKCQkJCQkJCX0gZWxzZSBpZiAoIW8uRW50aXR5QXR0cmlidXRlKSB7CgkJCQkJCQkJdiA9IG8gfHwgewoJCQkJCQkJCQlJZDogby5JZCwKCQkJCQkJCQkJX1RvU3RyaW5nOiBvLl9Ub1N0cmluZywKCQkJCQkJCQkJdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQkJcmV0dXJuIHRoaXMuX1RvU3RyaW5nOwoJCQkJCQkJCQl9CgkJCQkJCQkJfTsKCQkJCQkJCX0KCQkJCQkJCWlmIChvRWxlbWVudC5vcHRpb25zKSB7CgkJCQkJCQkJJChlTmFtZSkuY29tYm8oJ3NldFZhbHVlJyArIChvRWxlbWVudC5tdWx0aXBsZSA/ICdzJyA6ICcnKSwgdik7CgkJCQkJCQkJJChlTmFtZSkuY29tYm8oJ3NldFRleHQnICsgKG9FbGVtZW50Lm11bHRpcGxlID8gJ3MnIDogJycpLCB2KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJJChlTmFtZSkuY29tYm9ncmlkKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIHYpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfSBlbHNlIHsKCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQlpZiAocC5pbmRleE9mKCdfJykgPT09IDApIHAgPSBwLnN1YnN0cmluZygxKTsKCQkJCXZhciBlID0gdGhpcy5ieU5hbWUocCk7CgkJCQlpZiAoIWUgfHwgIWUubmFtZSkgY29udGludWU7CgkJCQl2YXIgdmFsdWUgPSBvW3BdOwoJCQkJaWYgKGUubmFtZSA9PSB0aGlzLnNUYWJsZSkgewoJCQkJCXZhbHVlID0gbzsKCQkJCQl2YWx1ZS5EYXRlID0gbmV3IERhdGUoKTsKCQkJCX0KCQkJCWlmIChwID09ICJFbnRpdHlWYWx1ZXMiKSB7CgkJCQkJLy8gYW4gZW1zRm9ybVZhbHVlcyBzb3VyY2UKCQkJCQkvLyBmaW5kIHRoZSBFbnRpdHlWYWx1ZSBmb3IgdGhpcyBlbGVtZW50IGFuZCBzZXQgaXQKCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IG8uRW50aXR5VmFsdWVzLmxlbmd0aDsgaisrKSB7CgkJCQkJCWlmIChvLkVudGl0eVZhbHVlc1tqXS5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBlLm5hbWUpIHsKCQkJCQkJCS8vIGZvdW5kIHRoZSBFbnRpdHlWYWx1ZSBmb3IgdGhpcyBlbGVtZW50CgkJCQkJCQlfdiA9IG8uRW50aXR5VmFsdWVzW2pdOwoJCQkJCQkJZm9yICh2YXIgcSBpbiBfdikgewoJCQkJCQkJCWlmIChxLmVuZHNXaXRoKCJWYWx1ZSIpKSB7CgkJCQkJCQkJCV92W3FdID0gdmFsdWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQl0aGlzLnNldCh2YWx1ZSwgZS5uYW1lKTsKCQkJfQoJCX0KCX0KCglnZXQoKSB7CgkJdmFyIG8gPSB7fTsKCQlpZiAodGhpcy5zVGFibGUgJiYgd2luZG93W3RoaXMuc1RhYmxlXSkgbyA9IG5ldyB3aW5kb3dbdGhpcy5zVGFibGVdKCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBjbiA9IG51bGw7CgkJCXZhciB2ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWxldCBlTmFtZSA9ICIjIiArIHRoaXMucHJlZml4KHRoaXMuZWxlbWVudHNbaV0pICsgdGhpcy5lbGVtZW50c1tpXS5uYW1lOwoJCQkJc3dpdGNoICh0aGlzLmVsZW1lbnRzW2ldLnR5cGUpIHsKCQkJCQljYXNlICdsYWJlbCc6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi5odG1sKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3RleHQnOgoJCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJY2FzZSAnc2VhcmNoJzoKCQkJCQljYXNlICdwYXNzd29yZCc6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi52YWwoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiZmlsZSI6CgkJCQkJY2FzZSAiaW1hZ2UiOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gdGhpcy5lbGVtZW50c1tpXS5kYXRhOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJEYXRlVGltZSI6CgkJCQkJY2FzZSAiZGF0ZXRpbWUiOgoJCQkJCQl2ID0gbmV3IERhdGUoJChlTmFtZSkuZGF0ZXRpbWVib3goJ2dldFZhbHVlJykpOwoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJwcm9ncmVzcyI6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi5wcm9ncmVzc2JhcignZ2V0VmFsdWUnKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiaW50IjoKCQkJCQljYXNlICJpbnRlZ2VyIjoKCQkJCQljYXNlICJudW1iZXIiOgoJCQkJCWNhc2UgImxvbmciOgoJCQkJCWNhc2UgIkxvbmciOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gcGFyc2VGbG9hdChjbi52YWwoKSk7CgkJCQkJCWlmIChpc05hTih2KSkgdiA9IDA7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgImdyaWQiOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gY24uZGF0YWdyaWQoJ2dldERhdGEnKTsKCQkJCQkJdi5zZWxlY3RlZCA9IGNuLmRhdGFncmlkKCJnZXRTZWxlY3RlZCIpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJ0cmVlIjoKCQkJCQkJY24gPSAkKGVOYW1lKTsKCQkJCQkJdiA9IGNuLmNvbWJvdHJlZSgidHJlZSIpLnRyZWUoImdldFNlbGVjdGVkIik7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIndpbmRvdyI6CgkJCQkJCXYgPSB0aGlzLmVsZW1lbnRzW2ldLnZhbHVlOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJzZWxlY3QiOgoJCQkJCQlpZiAodGhpcy5lbGVtZW50c1tpXS5vcHRpb25zKSB7CgkJCQkJCQl2ID0gJChlTmFtZSkuY29tYm9ncmlkKCdnZXRWYWx1ZScgKyAodGhpcy5lbGVtZW50c1tpXS5tdWx0aXBsZSA/ICdzJyA6ICcnKSk7CgkJCQkJCQl2ID0gdGhpcy5zcigpLnJ1blNjcmlwdCh2KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXYgPSAkKGVOYW1lKS5jb21ib2dyaWQoJ2dyaWQnKS5kYXRhZ3JpZCgnZ2V0U2VsZWN0aW9ucycpOwoJCQkJCQkJaWYgKCF2IHx8ICF2Lmxlbmd0aCkgewoJCQkJCQkJCXYgPSAkKGVOYW1lKS5jb21ib2dyaWQoJ2dldFZhbHVlJyArICh0aGlzLmVsZW1lbnRzW2ldLm11bHRpcGxlID8gJ3MnIDogJycpKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCF0aGlzLmVsZW1lbnRzW2ldLm11bHRpcGxlKSB2ID0gdlswXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJib29sIjoKCQkJCQkJY24gPSAkKGVOYW1lKTsKCQkJCQkJdiA9IGNuLnN3aXRjaGJ1dHRvbignb3B0aW9ucycpLmNoZWNrZWQ7CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQkJb1t0aGlzLmVsZW1lbnRzW2ldLm5hbWVdKHYpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKHRoaXMuZWxlbWVudHNbaV0ubmFtZSwgZSk7CgkJCQlvW3RoaXMuZWxlbWVudHNbaV0ubmFtZV0gPSB2OwoJCQl9CgkJCWlmIChjbikgewoJCQkJaWYgKG8uRW50aXR5VmFsdWVzKSB7CgkJCQkJZm9yICh2YXIgaiA9IDA7IGogPCBvLkVudGl0eVZhbHVlcy5sZW5ndGg7IGorKykgewoJCQkJCQlpZiAodGhpcy5lbGVtZW50c1tpXS5uYW1lID09IHRoaXMuc1RhYmxlICYmIHRoaXMuZWxlbWVudHNbaV0uZW1zU291cmNlKSBvLklkID0gdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UuSWQ7CgkJCQkJCWlmIChvLkVudGl0eVZhbHVlc1tqXS5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSB0aGlzLmVsZW1lbnRzW2ldLm5hbWUgJiYgdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UpIHsKCQkJCQkJCW8uRW50aXR5VmFsdWVzW2pdLklkID0gdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UuSWQ7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIG87Cgl9CgoJY0hlaWdodChvcHRpb25zKSB7CgkJaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lZGl0b3IpIHJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQ7CgkJaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5oZWlnaHQgJiYgdHlwZW9mKG9wdGlvbnMuaGVpZ2h0KSA9PT0gJ3N0cmluZycpIHJldHVybiB0aGlzLmhlaWdodDsKCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT0gJ3dpbmRvdycgJiYgIW9wdGlvbnMuaGVpZ2h0KSByZXR1cm4gdGhpcy5oZWlnaHQgKiAwLjk7CgkJcmV0dXJuIE1hdGguZmxvb3IoKChvcHRpb25zID8gb3B0aW9ucy5oZWlnaHQgOiBudWxsKSB8fCAodGhpcy5oZWlnaHQgLyAzKSkpOwoJfQoKCXNlYXJjaChvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuc3RyaW5nKG9wdGlvbnMpOwoJfQoKCXN0cmluZyhvcHRpb25zKSB7CgkJb3B0aW9ucy5oZWlnaHQgPSAyMDsKCQlvcHRpb25zLnNpbXBsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXMudGV4dChvcHRpb25zKTsKCX0KCglkYXRldGltZShvcHRpb25zKSB7CgkJcmV0dXJuIGA8aW5wdXQgaWQ9ImR0cCR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiPmA7Cgl9CgoJcXVlcnkob3B0aW9ucykgewoJCXJldHVybiAiPGRpdiBpZD0ndnMiICsgb3B0aW9ucy5uYW1lICsgIic+PC9kaXY+IjsKCX0KCglEYXRlVGltZShvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuZGF0ZXRpbWUob3B0aW9ucyk7Cgl9CgoJbG9uZyhvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuaW50KG9wdGlvbnMpOwoJfQoKCUxvbmcob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmxvbmcob3B0aW9ucyk7Cgl9CgoJdmFsdWUob3B0aW9ucykgewoJCWlmICh0eXBlb2Ygb3B0aW9ucy52YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl0cnkgewoJCQkJcmV0dXJuIG9wdGlvbnMudmFsdWUodGhpcy5nZXQoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhgREZvcm0udmFsdWUoJHtvcHRpb25zLm5hbWV9KTogJHtleH1gKTsKCQkJCXJldHVybiAnJzsKCQkJfQoJCX0gZWxzZSB7CgkJCXN3aXRjaCAob3B0aW9ucy50eXBlKSB7CgkJCQljYXNlICdpbnQnOgoJCQkJY2FzZSAncHJvZ3Jlc3MnOgoJCQkJCXJldHVybiBvcHRpb25zLnZhbHVlIHx8IG9wdGlvbnMubWluIHx8IDA7CgkJCQljYXNlICdzdHJpbmcnOgoJCQkJY2FzZSAndGV4dCc6CgkJCQljYXNlICdkYXRldGltZSc6CgkJCQljYXNlICdsYWJlbCc6CgkJCQkJcmV0dXJuIG9wdGlvbnMudmFsdWUgfHwgIiI7CgkJCQlkZWZhdWx0OgoJCQkJCXJldHVybiBvcHRpb25zLnZhbHVlOwoJCQl9CgkJfQoJfQoKCWludChvcHRpb25zKSB7CgkJbGV0IHJldCA9IGA8aW5wdXQgaWQ9Im51ZCR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgZGF0YS1vcHRpb25zPSJtaW46JHtvcHRpb25zLm1pbiB8fCAwfSxtYXg6JHtvcHRpb25zLm1heCB8fCAxMDB9LGluY3JlbWVudDoke29wdGlvbnMuaW5jcmVtZW50IHx8IDF9IiBzdHlsZT0id2lkdGg6JHt0aGlzLmNXaWR0aChvcHRpb25zKX1weDsiPjwvaW5wdXQ+YDsKCQkvL2NvbnNvbGUubG9nKHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCgltZW51KG9wdGlvbnMpIHsKCQlvcHRpb25zLnR5cGUgPSBvcHRpb25zLnR5cGUgfHwgJ21lbnUnOwoKCQlvcHRpb25zLm1lbnUgPSAob3B0aW9ucy5tZW51IHx8IFtdKS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7CgoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjptZW51KCk6IG9wdGlvbnMiLCBvcHRpb25zKTsKCgkJbGV0IHJldCA9ICIiOwoJCXJldCArPSAnPGRpdiBjbGFzcz0iZWFzeXVpLXBhbmVsIiBpZD0ibW51JyArIG9wdGlvbnMubmFtZSArICciIHN0eWxlPSJwYWRkaW5nOjVweDsiPlxuJzsKCgkJcmV0ICs9IG9wdGlvbnMubWVudS5tYXAobSA9PiBgPGEgaHJlZj0iIyIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJtZW51OicjbW0ke20ubGFiZWwucmVwbGFjZSgvIC9nLCAnJyl9JyxpY29uQ2xzOidpY29uLSR7bS5pY29uIHx8ICdub25lJ30nIj4ke20ubGFiZWx9PC9hPmApLmpvaW4oJ1xuJyk7CgoJCS8qJC5lYWNoKG9wdGlvbnMubWVudSwgKF8sIG0pID0+IHJldCArPSBgPGEgaHJlZj0iIyIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJtZW51OicjbW0ke20ubGFiZWwucmVwbGFjZSgvIC9nLCAnJyl9JyxpY29uQ2xzOidpY29uLSR7bS5pY29uIHx8ICdub25lJ30nIj4ke20ubGFiZWx9PC9hPlxuYCk7Ki8KCQlyZXQgKz0gIjwvZGl2PlxuIjsKCgkJbGV0IGR2ID0gbSA9PiB7CgkJCWxldCByZXQgPSAnPGRpdicgKyAobS5zdWJNZW51cyA/ICcnIDogYCBkYXRhLW9wdGlvbnM9Imljb25DbHM6J2ljb24tJHttLmljb24gfHwgJ25vbmUnfSciYCkgKyAnPlxuJzsKCQkJcmV0ICs9IG0uc3ViTWVudXMgPyAnPHNwYW4+JyArIChtLmxhYmVsIHx8IHRoaXMuZW5nbGlzaChtLmNvZGUpKSArICc8L3NwYW4+XG48ZGl2PicgOiAoYDxzcGFuIHdpZHRoPScxMDAlJyBvbmNsaWNrPScoYXN5bmMgKCkgPT4ge2xldCBtID0gJHtfRnJFTUQuX3RvSlMobSl9OyBpZihtLmFjdGlvbil7cmV0dXJuIGF3YWl0IG0uYWN0aW9uKERGb3JtLmdldCgpLCBtKTt9IGlmIChtLnN1Yk1lbnVzKSByZXR1cm47IGF3YWl0IF9GckVNRC5SZW5kZXJQYWdlKHtfY29kZTogbS5jb2RlIHx8IG0ubGFiZWwucmVwbGFjZSgvIC9nLCAiIikudG9Mb3dlckNhc2UoKX0sIG0uZGF0YSk7fSkoKSc+JHttLmxhYmVsIHx8IHRoaXMuZW5nbGlzaChtLmNvZGUpfTwvc3Bhbj5gKTsKCQkJJC5lYWNoKG0uc3ViTWVudXMsIChfLCBzKSA9PiByZXQgKz0gZHYocykpOwoJCQlyZXQgKz0gKG0uc3ViTWVudXMgPyAiPC9kaXY+XG4iIDogIiIpICsgYDwvZGl2PlxuYDsKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQlyZXQgKz0gb3B0aW9ucy5tZW51Lm1hcChtID0+IGA8ZGl2IGlkPSJtbSR7bS5sYWJlbC5yZXBsYWNlKC8gL2csICcnKX0iIHN0eWxlPSJ3aWR0aDoxNTBweDsiPiR7bS5zdWJNZW51cy5tYXAoc20gPT4gZHYoc20pKS5qb2luKCcnKX08L2Rpdj5gKS5qb2luKCdcbicpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWludGVnZXIob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmludChvcHRpb25zKTsKCX0KCgludW1iZXIob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmludChvcHRpb25zKTsKCX0KCglJbnRlZ2VyKG9wdGlvbnMpIHsKCQlyZXR1cm4gdGhpcy5pbnQob3B0aW9ucyk7Cgl9CgoJYm9vbChvcHRpb25zKSB7CgkJcmV0dXJuIGA8aW5wdXQgaWQ9IiR7dGhpcy5wcmVmaXgob3B0aW9ucyl9JHtvcHRpb25zLm5hbWV9IiBkYXRhLWRmb3JtPSJlbGVtZW50OiR7b3B0aW9ucy5uYW1lfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZD8ndHJ1ZSc6J2ZhbHNlJ30iIGRhdGEtb3B0aW9ucz0nZGlzYWJsZWQ6JHtvcHRpb25zLmRpc2FibGVkPyd0cnVlJzonZmFsc2UnfSwke3RoaXMuZXZlbnRIYW5kbGVycyhvcHRpb25zKX0nIGNsYXNzPSJlYXN5dWktJHt0aGlzLnVpVHlwZXNbb3B0aW9ucy50eXBlXX0iICR7b3B0aW9ucy5jaGVja2VkPydjaGVja2VkJzonJ30gLz5gOwoJfQoKCWxhYmVsKG9wdGlvbnMpIHsKCQlyZXR1cm4gYDxzcGFuIGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiIGRhdGEtb3B0aW9ucz0iZGlzYWJsZWQ6JHtvcHRpb25zLmRpc2FibGVkPyd0cnVlJzonZmFsc2UnfSI+JHt0aGlzLnZhbHVlKG9wdGlvbnMpfTwvc3Bhbj5gOwoJfQoKCXVybChvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuc3RyaW5nKG9wdGlvbnMpLnJlcGxhY2UoIkZpZWxkQ2hhbmdlIiwgIlVSTENoYW5nZSIpOwoJfQoKCXRleHQob3B0aW9ucykgewoJCXJldHVybiBgPGlucHV0IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke29wdGlvbnMuZWRpdG9yIHx8IHRoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSdkaXNhYmxlZDoke29wdGlvbnMuZGlzYWJsZWQ/J3RydWUnOidmYWxzZSd9LCR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfScgbXVsdGlsaW5lPSIke29wdGlvbnMuc2ltcGxlID8gJ2ZhbHNlJyA6ICd0cnVlJ30iIHN0eWxlPSJ3aGl0ZS1zcGFjZTpwcmUtd3JhcDt3aWR0aDoke3RoaXMuY1dpZHRoKG9wdGlvbnMpfXB4O2hlaWdodDoke3RoaXMuY0hlaWdodChvcHRpb25zKX1weCIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgLz5gOwoJfQoKCXBhc3N3b3JkKG9wdGlvbnMpIHsKCQl2YXIgcmV0ID0gdGhpcy5zdHJpbmcob3B0aW9ucyk7CgkJcmV0ID0gcmV0LnJlcGxhY2UoJzxpbnB1dCAnLCAnPGlucHV0IHR5cGU9InBhc3N3b3JkIiAnKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWZpbGUob3B0aW9ucykgewoJCXJldHVybiBgPGlucHV0IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJvbkNoYW5nZTpmdW5jdGlvbihuLG8pe3ZhciBzID0gJCgnIycgKyB0aGlzLmlkKS5maWxlYm94KCdvcHRpb25zJyk7IERGb3JtLlVwbG9hZEZpbGUocywgREZvcm0uYnlOYW1lKCcke29wdGlvbnMubmFtZX0nKSk7fSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiPmA7Cgl9CgoJaW1hZ2Uob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmZpbGUob3B0aW9ucykgKyBgPGRpdiBpZD0iZGxnJHtvcHRpb25zLm5hbWV9IiBjbGFzcz0iZWFzeXVpLSR7dGhpcy51aVR5cGVzW29wdGlvbnMudHlwZV19IiB0aXRsZT0iSW1hZ2UgUHJldmlldyIgZGF0YS1vcHRpb25zPSJjbG9zZWQ6dHJ1ZSxpY29uQ2xzOidpY29uLXNhdmUnLHJlc2l6YWJsZTpmYWxzZSxtb2RhbDp0cnVlIiBzdHlsZT0id2lkdGg6NDAwcHg7aGVpZ2h0OjIwMHB4O3BhZGRpbmc6MTBweCI+PGltZyBpZD0iJHt0aGlzLnByZWZpeChvcHRpb25zKX0ke29wdGlvbnMubmFtZX0iIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiLz48L2Rpdj5gOwoJfQoKCXByb2dyZXNzKG9wdGlvbnMpIHsKCQlpZiAoIW9wdGlvbnMuaGVpZ2h0KSBvcHRpb25zLmhlaWdodCA9IDIwOyAvLyBmaXggYmlnIHByb2dyZXNzCgkJcmV0dXJuIGA8ZGl2IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJ2YWx1ZToke3RoaXMudmFsdWUob3B0aW9ucyl9IiBzdHlsZT0id2lkdGg6JHt0aGlzLmNXaWR0aChvcHRpb25zKX1weDtoZWlnaHQ6JHt0aGlzLmNIZWlnaHQob3B0aW9ucyl9cHgiPjwvZGl2PmA7Cgl9CgoJZmxvd2NoYXJ0KG9wdGlvbnMpIHsKCQlyZXR1cm4gYDxkaXYgaWQ9ImZsdyR7b3B0aW9ucy5uYW1lfSIgd2lkdGg9IiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9IiBoZWlnaHQ9IiR7dGhpcy5jSGVpZ2h0KG9wdGlvbnMpfSI+PC9kaXY+YDsKCX0KCgljaGFydChvcHRpb25zKSB7CgkJcmV0dXJuIGA8ZGl2IGlkPSJjaHQke29wdGlvbnMubmFtZX0iIHdpZHRoPSIke3RoaXMuY1dpZHRoKG9wdGlvbnMpfSIgaGVpZ2h0PSIke3RoaXMuY0hlaWdodChvcHRpb25zKX0iPjwvZGl2PmA7Cgl9CgoJZm9ybWF0dGVyKG5hbWUsIGMsIGpzb24pIHsKCQlqc29uID0ganNvbiA/ICciJyA6ICcnOwoJCXJldHVybiBgJHtqc29ufSh2YWx1ZSwgcm93LCBpbmRleCkgPT4ge3RyeXt2YXIgYyA9IChERm9ybS5ieU5hbWUoXGAke25hbWV9XGApLmNvbHVtbnMgfHwgW10pLmZpbmQoYyA9PiBjLmZpZWxkPT1cYCR7Yy5maWVsZH1cYCk7IHJldHVybiBjJiZjLmZvcm1hdD9jLmZvcm1hdCh2YWx1ZSxyb3csaW5kZXgpOnZhbHVlO31jYXRjaChleCl7cmV0dXJuIHZhbHVlO30gfSR7anNvbn1gOwoJfQoKCW1hcENvbHVtbnMob3B0aW9ucywganNvbikgewoJCWxldCBjVGl0bGUgPSBjID0+IGMudGl0bGUgfHwgdGhpcy5lbmdsaXNoKGMuZmllbGQpOwoKCQl2YXIgY29scyA9ICQuZ3JlcChvcHRpb25zLmNvbHVtbnMgfHwgW10sIGMgPT4gIWMuaWdub3JlKTsKCQlsZXQgcmV0ID0gIiI7CgkJaWYgKG9wdGlvbnMubXVsdGlwbGUpIHJldCArPSBgeyJmaWVsZCI6J2NrJywiY2hlY2tib3giOnRydWV9LGA7CgkJcmV0ID0gYCJmcm96ZW5Db2x1bW5zIjogW1tgOwoJCWlmICghb3B0aW9ucy5mcm96ZW4pIHsKCQkJcmV0ICs9IGB7ImZpZWxkIjoiJHtvcHRpb25zLmlkRmllbGQuZmllbGR9IiwidGl0bGUiOiAiJHtvcHRpb25zLmlkRmllbGQudGl0bGV9Iiwic29ydGFibGUiOiAidHJ1ZSIsICJmb3JtYXR0ZXIiOiAke3RoaXMuZm9ybWF0dGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucy5pZEZpZWxkLCBqc29uKX19LGA7CgkJCWlmIChvcHRpb25zLnRleHRGaWVsZC5maWVsZCAhPSBvcHRpb25zLmlkRmllbGQuZmllbGQpIHJldCArPSBgeyJmaWVsZCI6IiR7b3B0aW9ucy50ZXh0RmllbGQuZmllbGQgfHwgb3B0aW9ucy50ZXh0RmllbGQudGl0bGV9IiwidGl0bGUiOiIke29wdGlvbnMudGV4dEZpZWxkLnRpdGxlIHx8IG9wdGlvbnMudGV4dEZpZWxkLmZpZWxkfSIsIndpZHRoIjoiJHtvcHRpb25zLnRleHRGaWVsZC53aWR0aHx8MTIwfSIsICJzb3J0YWJsZSI6ICJ0cnVlIiwgImZvcm1hdHRlciI6ICR7dGhpcy5mb3JtYXR0ZXIob3B0aW9ucy5uYW1lLCBvcHRpb25zLnRleHRGaWVsZCwganNvbil9fWA7CgkJfSBlbHNlIHsKCQkJJC5tYXAoJC5ncmVwKGNvbHMsIGMgPT4gYy5mcm96ZW4pLCBjID0+IGB7ImZpZWxkIjoiJHtjLmZpZWxkIHx8IGNUaXRsZShjKX0iLCJ0aXRsZSI6IiR7Y1RpdGxlKGMpIHx8IGMuZmllbGR9Iiwid2lkdGgiOiIke2Mud2lkdGh8fDEyMH0iLCJhbGlnbiI6J2xlZnQnLCJzb3J0YWJsZSI6InRydWUiLCAiZm9ybWF0dGVyIjogJHt0aGlzLmZvcm1hdHRlcihvcHRpb25zLm5hbWUsIGMsIGpzb24pfX1gKS5qb2luKCIsIik7CgkJfQoJCXJldCArPSBgXV0sICJjb2x1bW5zIjogW1tgOwoJCXJldCArPSAkLm1hcCgkLmdyZXAoY29scywgYyA9PiAhYy5mcm96ZW4pLCBjID0+IGB7ImZpZWxkIjoiJHtjLmZpZWxkIHx8IGNUaXRsZShjKX0iLCJ0aXRsZSI6IiR7Y1RpdGxlKGMpIHx8IGMuZmllbGR9IiwiYWxpZ24iOiJsZWZ0Iiwic29ydGFibGUiOiJ0cnVlIiwgImZvcm1hdHRlciI6ICR7dGhpcy5mb3JtYXR0ZXIob3B0aW9ucy5uYW1lLCBjLCBqc29uKX19YCkuam9pbigiLCIpOwoJCXJldCArPSAnXV0nOwoKCQkvL2NvbnNvbGUubG9nKCJEeW5hRm9ybTo6bWFwQ29sdW1ucygiICsgb3B0aW9ucy5uYW1lICsgIik6ICIsIHJldCwganNvbik7CgkJcmV0dXJuIHJldDsKCX0KCglzZWxlY3Qob3B0aW9ucywgdGFnID0gb3B0aW9ucy50YWcsIHR5cGUpIHsKCQlyZXR1cm4gdGhpcy5jb21ibyhvcHRpb25zLCB0YWcsIHR5cGUpOwoJfQoKCXRyZWUob3B0aW9ucykgewoJCXJldHVybiB0aGlzLnNlbGVjdChvcHRpb25zLCAic2VsZWN0Iik7Cgl9CgoJbmF2aWdhdGlvbihvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuY29tYm8ob3B0aW9ucywgJ3VsJywgJ3RyZWUnKTsKCX0KCgljb21ibyhvcHRpb25zLCB0YWcsIHR5cGUpIHsKCQl2YXIgY29scyA9ICQuZ3JlcChvcHRpb25zLmNvbHVtbnMgfHwgW10sIGMgPT4gIWMuaWdub3JlKTsKCQl0YWcgPSB0YWcgfHwgInNlbGVjdCI7CgoJCW9wdGlvbnMuaWRGaWVsZCA9ICQudW5pcXVlU29ydChbewoJCQlmaWVsZDogb3B0aW9ucy5pZEZpZWxkLAoJCQl0aXRsZTogb3B0aW9ucy5pZEZpZWxkCgkJfV0uY29uY2F0KCQuZ3JlcChjb2xzLCBjID0+IGMucHJpbWFyeSksIFt7CgkJCWZpZWxkOiAnSWQnLAoJCQl0aXRsZTogJ0lEJwoJCX1dKSkuZmluZCh4ID0+IHR5cGVvZih4LmZpZWxkKSAhPT0gInVuZGVmaW5lZCIpOwoKCQlvcHRpb25zLnRleHRGaWVsZCA9ICQudW5pcXVlU29ydChbewoJCQlmaWVsZDogb3B0aW9ucy50ZXh0RmllbGQsCgkJCXRpdGxlOiBvcHRpb25zLnRleHRGaWVsZAoJCX1dLmNvbmNhdCgkLmdyZXAoY29scywgYyA9PiBjLmRpc3BsYXkpLCBbewoJCQlmaWVsZDogJ19Ub1N0cmluZycsCgkJCXRpdGxlOiBvcHRpb25zLm5hbWUsCgkJfV0pKS5maW5kKHggPT4gdHlwZW9mKHguZmllbGQpICE9PSAidW5kZWZpbmVkIik7CgoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpjb21ibygpOiBvcHRpb25zIiwgb3B0aW9ucyk7CgoJCXZhciBmdW4gPSB0eXBlIHx8IHRoaXMuZUZ1bihvcHRpb25zKTsKCgkJdmFyIGRyb3Bkb3duID0gWydjb21ib3RyZWVncmlkJywgJ2NvbWJvdHJlZScsICdjb21ib2dyaWQnLCAnc2VsZWN0J10uaW5kZXhPZihmdW4pID4gLTE7CgkJaWYgKGRyb3Bkb3duKSB0aGlzLnNlbGVjdHMucHVzaCh7CgkJCWlkOiAiY21iIiArIG9wdGlvbnMubmFtZSwKCQkJb3B0aW9uczogdGhpcy5ieU5hbWUob3B0aW9ucy5uYW1lKQoJCX0pOwoJCXRoaXMuc2VsZWN0cyA9ICQudW5pcXVlU29ydCh0aGlzLnNlbGVjdHMpOwoJCXZhciByZXQgPSBgPCR7dGFnfSBpZD0iY21iJHtvcHRpb25zLm5hbWV9IiBjbGFzcz0iZWFzeXVpLSR7ZnVufSIgc3R5bGU9Im1heC13aWR0aDoke2Ryb3Bkb3duPyc0MDBweCc6dGhpcy5jV2lkdGgob3B0aW9ucyl9OyB3aWR0aDoke3RoaXMuY1dpZHRoKG9wdGlvbnMpfXB4IiByZXF1aXJlZD0iJHsob3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZScpfSIgZGF0YS1vcHRpb25zPSdkaXNhYmxlZDoke29wdGlvbnMuZGlzYWJsZWQ/J3RydWUnOidmYWxzZSd9LCR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfSwgdmFsdWU6IiR7dGhpcy52YWx1ZShvcHRpb25zKX0iLCByb3dudW1iZXJzOiR7dHlwZW9mKG9wdGlvbnMucm93TnVtYmVycykhPT0ndW5kZWZpbmVkJz9vcHRpb25zLnJvd051bWJlcnM6KGZ1bi5pbmRleE9mKCd0cmVlJyk8LTE/J2ZhbHNlJzondHJ1ZScpfSwgcGFnaW5hdGlvbjoke3R5cGVvZihvcHRpb25zLnBhZ2luYXRpb24pIT09J3VuZGVmaW5lZCc/b3B0aW9ucy5wYWdpbmF0aW9uOihmdW4uaW5kZXhPZigndHJlZScpPC0xPydmYWxzZSc6J3RydWUnKX0sIHBhbmVsV2lkdGg6JHsyKnRoaXMuY1dpZHRoKG9wdGlvbnMpfSwgZml0Q29sdW1uczogdHJ1ZSwgc2luZ2xlU2VsZWN0OiB0cnVlLCBtdWx0aXBsZTokeyhvcHRpb25zLm11bHRpcGxlIHx8ICdmYWxzZScpfSwgaWRGaWVsZDogIiR7b3B0aW9ucy5pZEZpZWxkLmZpZWxkfSIsIGVuYWJsZUZpbHRlcjogJHtvcHRpb25zLmZpbHRlcj8ndHJ1ZSc6J2ZhbHNlJ30sIG5vd3JhcDogZmFsc2UsIHRleHRGaWVsZDogIiR7b3B0aW9ucy50ZXh0RmllbGQuZmllbGR9IiwgdHJlZUZpZWxkOiAiJHtvcHRpb25zLnRleHRGaWVsZC5maWVsZH0iLGA7CgkJaWYgKGZ1bi5pbmRleE9mKCd0cmVlJykgPT0gLTEpIHsKCQkJcmV0ICs9ICdmaXRDb2x1bW5zOiBmYWxzZSwnICsgdGhpcy5tYXBDb2x1bW5zKG9wdGlvbnMpOwoJCX0KCQlpZiAob3B0aW9ucy5kYXRhKSB7CgkJCXJldCArPSBgLGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucy5kYXRhKX1gOwoJCX0KCQlyZXQgKz0gYCc+YDsKCQlpZiAob3B0aW9ucy5vcHRpb25zKSB7CgkJCXJldCArPSAkLm1hcChvcHRpb25zLm9wdGlvbnMsIG8gPT4gYDxvcHRpb24gdmFsdWU9JyR7X0ZyRU1ELl90b0pTKG8pfSc+JHtvLm5hbWUgfHwgb308L29wdGlvbj5gKS5qb2luKCdcbicpOwoJCX0KCQlyZXQgKz0gYDwvJHt0YWd9PmA7CgkJLy8gY29uc29sZS5sb2cocmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWdyaWQob3B0aW9ucywgdGFnLCB0eXBlKSB7CgkJcmV0dXJuIHRoaXMuY29tYm8ob3B0aW9ucywgInRhYmxlIiwgImRhdGFncmlkIik7Cgl9CgoJdHJlZWdyaWQob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmNvbWJvKG9wdGlvbnMsICd0YWJsZScsICd0cmVlJyk7Cgl9CgoJYXN5bmMgZG9MaW5rKGUsIGV2ZW50KSB7CgkJdGhpcy5idXN5KHRydWUpOwoJCXRyeSB7CgkJCWF3YWl0IGUubGlua3MuZmluZChsID0+IGwubGFiZWwgPT0gZXZlbnQudGFyZ2V0LmlubmVyVGV4dCkub25DbGljayh0aGlzLmdldCgpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRHluYUZvcm06OmRvTGluaygpOiBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJRWRpdGVkVmFsdWUoZSkgewoJCXJldHVybiAodHlwZW9mKGFjZSkgIT09ICJ1bmRlZmluZWQiKSA/IGFjZS5lZGl0KCdwbmwnICsgZS5uYW1lKS5zZXNzaW9uLmdldFZhbHVlKCkgOiAnJzsKCX0KCglhc3luYyBQYW5PbkNsb3NlKGUpIHsKCQlpZiAoZS5lZGl0b3IpIHsKCQkJZS52YWx1ZSA9IHRoaXMuRWRpdGVkVmFsdWUoZSk7CgkJfQoJCWlmIChlLmNsb3NlKSB7CgkJCWF3YWl0IGUuY2xvc2UodGhpcy5nZXQoKSk7CgkJfQoJfQoKCWFzeW5jIFBlbmRBZnRlck9wZW4oZSkgewoJCWlmIChlLmVkaXRvciAmJiB0eXBlb2YoYWNlKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJYXdhaXQgX0ZyRU1ELk9wZW5FZGl0b3IoJ3BubCcgKyBlLm5hbWUgLyorICctY2VudGVyJyovICwgZS5sYW5ndWFnZSwgZS5sb2FkZXIgfHwgKG8gPT4gZS52YWx1ZSksIGUuc2F2ZXIsIHRoaXMuZ2V0KCksIGUpOwoJCX0KCQlpZiAoZS5vcGVuKSB7CgkJCWF3YWl0IGUub3Blbih0aGlzLmdldCgpKTsKCQl9Cgl9CgoJbGluayhvcHRpb25zKSB7CgkJcmV0dXJuIChvcHRpb25zLmxpbmtzIHx8IFtdKS5maWx0ZXIobCA9PiAhbC5pZ25vcmUpLm1hcChsID0+IGA8YSBocmVmPSIjIiBjbGFzcz0iZWFzeXVpLSR7dGhpcy51aVR5cGVzW29wdGlvbnMudHlwZV19IiBkYXRhLW9wdGlvbnM9JyR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfSwgaWNvbkNsczoiaWNvbi0ke2wuaWNvbiB8fCAnb2snfSInPiR7bC5sYWJlbH08L2E+YCkuam9pbignXG4nKTsKCX0KCglhc3luYyBTZXRUcmVlRGF0YShlLCBuLCBkYXRhKSB7CgkJJC5lYWNoKCQoIiNjbWIiICsgZS5uYW1lKVt0aGlzLmVGdW4oZSldKCd0cmVlJykudHJlZSgiZ2V0Q2hpbGRyZW4iLCBuLnRhcmdldCksIChfLCBjKSA9PiAkKCIjY21iIiArIGUubmFtZSlbdGhpcy5lRnVuKGUpXSgndHJlZScpLnRyZWUoInJlbW92ZSIsIGMudGFyZ2V0KSk7CgkJJCgiI2NtYiIgKyBlLm5hbWUpW3RoaXMuZUZ1bihlKV0oJ3RyZWUnKS50cmVlKCJhcHBlbmQiLCB7CgkJCXBhcmVudDogbi50YXJnZXQsCgkJCWRhdGE6IGRhdGEKCQl9KTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglhc3luYyBFeHBhbmQoZSwgbikgewoJCXRoaXMuU2V0VHJlZURhdGEoZSwgbiwgW3sKCQkJaWQ6IG51bGwsCgkJCXRleHQ6ICJsb2FkaW5nLi4uIgoJCX1dKTsKCQl2YXIgb2JqID0ge307CgkJdmFyIHBGaWVsZCA9IGUucGFyZW50RmllbGQgfHwgJC5tYXAoJC5ncmVwKGUuY29sdW1ucyB8fCBbXSwgYyA9PiBjLnBhcmVudCksIGMgPT4gYy5maWVsZCkuY29uY2F0KFtudWxsXSlbMF07CgkJdmFyIGlkRmllbGQgPSAkLmdyZXAoZS5jb2x1bW5zIHx8IFtdLCBjID0+IGMucHJpbWFyeSkuY29uY2F0KGUuaWRGaWVsZClbMF0uZmllbGQ7CgkJaWYgKHBGaWVsZCkgewoJCQlvYmpbcEZpZWxkXSA9IHsKCQkJCV9zb3VyY2U6IG4uX3NvdXJjZQoJCQl9OwoJCQlpZiAoaWRGaWVsZCkgewoJCQkJb2JqW3BGaWVsZF1baWRGaWVsZF0gPSBuLmlkOwoJCQl9IGVsc2UgewoJCQkJb2JqW3BGaWVsZF0gPSBuLmlkOwoJCQl9CgkJfQoJCWxldCBkYXRhID0gYXdhaXQgdGhpcy5fbG9hZERhdGEoewoJCQlpZDogImNtYiIgKyBlLm5hbWUsCgkJCW9wdGlvbnM6IGUKCQl9LCBvYmopOwoJCXRoaXMuU2V0VHJlZURhdGEoZSwgbiwgZGF0YSk7Cgl9CgoJYXN5bmMgX2xvYWREYXRhKHMsIG8sIHN0YXJ0LCBlbmQpIHsKCQl2YXIgbmFtZSA9IChzICYmIHMub3B0aW9ucyA/IChzLm9wdGlvbnMuQ2xhc3MgPyBzLm9wdGlvbnMuQ2xhc3MuTmFtZS5yZXBsYWNlKCcgJywgJ18nKSA6IChzLm9wdGlvbnMudGFibGUgfHwgcy5vcHRpb25zLm5hbWUpKSA6IHMubmFtZSk7CgkJbmFtZSA9IG5hbWUudHJpbSgpOyAvLy5zcGxpdCgnLicpLnNsaWNlKC0xKVswXTsKCgkJbGV0IG9TY29wZSA9ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuU2NvcGUpID8gd2luZG93W2NvbXBhbnkuU2NvcGVdIDogd2luZG93OwoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpfbG9hZERhdGEoKTogb1Njb3BlIiwgb1Njb3BlKTsKCgkJbyA9IG8gfHwgKChvU2NvcGUgJiYgb1Njb3BlW25hbWVdKSA/IG5ldyBvU2NvcGVbbmFtZV0oKSA6IHsKCQkJQWN0aXZlOiB0cnVlLAoJCX0pOwoKCQlvID0gKHR5cGVvZiBmaWx0ZXJzICE9PSAidW5kZWZpbmVkIiAmJiBmaWx0ZXJzICYmIGZpbHRlcnNbbmFtZV0pID8gZmlsdGVyc1tuYW1lXShvKSA6IG87CgkJdmFyIGZ1biA9IHRoaXMuZUZ1bihzLm9wdGlvbnMpOwoJCWxldCBzVGV4dCA9ICQoIiMiICsgcy5pZClbZnVuXSgnZ2V0VGV4dCcpOwoKCQlvID0gKHMgJiYgcy5vcHRpb25zICYmIHMub3B0aW9ucy5zb3VyY2UpID8gcy5vcHRpb25zLnNvdXJjZShvLCB0aGlzLmdldCgpLCBzVGV4dCkgOiBvOwoJCWxldCBuYW1lcyA9ICQudW5pcXVlU29ydChbcy5vcHRpb25zLnNlYXJjaEZpZWxkXS5jb25jYXQoJC5tYXAoJC5ncmVwKHMub3B0aW9ucy5jb2x1bW5zIHx8IFtdLCBjID0+IGMuc2VhcmNoKSwgYyA9PiBjLmZpZWxkKSwgWyJOYW1lIl0pKS5maWx0ZXIodiA9PiB2KTsKCQlpZiAoIW9bbmFtZXNbMF1dKSBvW25hbWVzWzBdXSA9IHNUZXh0OwoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpfbG9hZERhdGEoKTogbyIsIG8pOwoJCXZhciBkYXRhID0gbnVsbDsKCgkJbGV0IGxpYiA9ICcnOwoJCWlmIChuYW1lLmluZGV4T2YoJy4nKSA+IDApIHsKCQkJbGliID0gbmFtZS5zcGxpdCgnLicpWzBdICsgJy4nOwoJCQluYW1lID0gbmFtZS5zcGxpdCgnLicpWzFdOwoJCX0KCgkJaWYgKHMub3B0aW9ucy5sb2FkZXIpIHsKCQkJZGF0YSA9IGF3YWl0IHMub3B0aW9ucy5sb2FkZXIodGhpcy5nZXQoKSwgcy5vcHRpb25zLCBvLCBzVGV4dCk7CgkJfSBlbHNlIGlmIChvICYmIHR5cGVvZihvLmZpbmRBbGwpID09PSAnZnVuY3Rpb24nKSB7CgkJCWRhdGEgPSBhd2FpdCBvLmZpbmRBbGwoKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5saWJyYXJ5ICYmIGNvbXBhbnkuQ29kZSAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCS8vY29uc29sZS5sb2coIkRGb3JtOjpfbG9hZERhdGEoKTogc3IoKS5fKCIgKyBsaWIgKyBjb21wYW55LkNvZGUudG9Mb3dlckNhc2UoKSArIG5hbWUgKyAiRmluZGFsbCIgKyAiKSIsIG8pOwoJCQlkYXRhID0gYXdhaXQgdGhpcy5zcigpLl8obGliICsgY29tcGFueS5Db2RlLnRvTG93ZXJDYXNlKCkgKyBuYW1lICsgIkZpbmRhbGwiLCBudWxsLCBvLCBudWxsLCBzdGFydCwgZW5kKTsKCQl9IGVsc2UgaWYgKF9GckVNRC5hcGlTZXJ2ZXIpIHsKCQkJbyA9IE9iamVjdC5hc3NpZ24oLi4uT2JqZWN0LmtleXMobykubWFwKGsgPT4gKHsKCQkJCVtTdHJpbmcoaykuY2hhckF0KDApLnRvTG93ZXJDYXNlKCkgKyBTdHJpbmcoaykuc2xpY2UoMSldOiBvW2tdCgkJCX0pKSk7CgkJCS8vY29uc29sZS5sb2coIkRGb3JtOjpfbG9hZERhdGEoKTogdXNpbmcgX0ZyRU1ELmFwaVNlcnZlcjogbyIsIG8pOwoJCQlkYXRhID0gYXdhaXQgX0ZyRU1ELmFwaVNlcnZlci5fbmV3KG5hbWUpLl9mcm9tRG9jdW1lbnQobykuZmluZEFsbCgpOwoJCQkvL2RhdGEuZmlsdGVyKGQgPT4gZC5JZCAhPSBkLklkKS5mb3JFYWNoKGQgPT4gZC5JZCA9IGQuX3V1aWQobnVsbCwgbnVsbCwgdHJ1ZSkpOwoJCX0KCgkJaWYgKHMub3B0aW9ucy5wb3N0bG9hZCkgewoJCQlhd2FpdCBzLm9wdGlvbnMucG9zdGxvYWQoZGF0YSk7CgkJfQoJCSQuZWFjaChkYXRhLCAoaSwgZCkgPT4gewoJCQlkLl9fT1dORVIgPSBzOwoJCQkkLmVhY2gocy5vcHRpb25zLmNvbHVtbnMsIChfLCBjKSA9PiB7CgkJCQlpZiAoYy52YWx1ZSkgewoJCQkJCWRbYy5maWVsZF0gPSBjLnZhbHVlKGQsIGRhdGEsIGkpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlpZiAoIXMub3B0aW9ucy5jb2x1bW5zICYmIGZ1bi5pbmRleE9mKCd0cmVlJykgPiAtMSkgewoJCQlkYXRhID0gJC5tYXAoZGF0YSwgZCA9PiB7CgkJCQlsZXQgcmV0ID0gewoJCQkJCWlkOiBkW3Mub3B0aW9ucy5pZEZpZWxkLmZpZWxkXSwKCQkJCQl0ZXh0OiBkW3Mub3B0aW9ucy50ZXh0RmllbGQuZmllbGRdLAoJCQkJCXN0YXRlOiBkLnN0YXRlIHx8IChzLm9wdGlvbnMubG9hZGVyID8gImZpbGUiIDogImNsb3NlZCIpLAoJCQkJCV9zb3VyY2U6IGQsCgkJCQl9OwoJCQkJcmV0LmNoaWxkcmVuID0gKHJldC5zdGF0ZSA9PSAiY2xvc2VkIikgPyBbewoJCQkJCXRleHQ6ICdsb2FkaW5nLi4uJwoJCQkJfV0gOiBudWxsOwoJCQkJcmV0dXJuIHJldDsKCQkJfSk7CgkJfQoJCXJldHVybiBkYXRhIHx8IFtdOwoJfQoKCWFzeW5jIGZpbGxEYXRhKGcsIG8sIHN0YXJ0LCBlbmQpIHsKCQl2YXIgcyA9IG51bGw7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMuc2VsZWN0c1tpXS5pZCA9PSBnWzBdLmlkKSBzID0gdGhpcy5zZWxlY3RzW2ldOwoJCX0KCQlpZiAoIXMpIHJldHVybjsKCQl0aGlzLmJ1c3kodHJ1ZSk7CgkJdHJ5IHsKCQkJdmFyIGZ1biA9IGdbMF0uY2xhc3NMaXN0WyIwIl0ucmVwbGFjZSgnZWFzeXVpLScsICcnKTsKCQkJdHJ5IHsKCQkJCSQoIiMiICsgcy5pZClbZnVuXSgnZ3JpZCcpLmRhdGFncmlkKCdnZXRQYWdlcicpLnBhZ2luYXRpb24oJ2xvYWRpbmcnKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChzLm9wdGlvbnMubm9sb2FkKSB7CgkJCQlsZXQgX2RhdGEgPSBudWxsOwoJCQkJdHJ5IHsKCQkJCQlfZGF0YSA9ICQoIiMiICsgcy5pZClbZnVuXSgnZ3JpZCcpLmRhdGFncmlkKCJnZXREYXRhIik7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCV9kYXRhID0gJCgiIyIgKyBzLmlkKVtmdW5dKCd0cmVlJykudHJlZSgnZ2V0Um9vdCcpOwoJCQkJfQoJCQkJaWYgKF9kYXRhKSB7CgkJCQkJcmV0dXJuIHRoaXMuYnVzeShmYWxzZSk7CgkJCQl9CgkJCX0KCQkJdmFyIGRhdGEgPSBhd2FpdCB0aGlzLl9sb2FkRGF0YShzLCBvLCBzdGFydCwgZW5kKTsKCQkJdHJ5IHsKCQkJCWlmICgkKCIjIiArIHMuaWQpW2Z1bl0oJ2dyaWQnKSkgJCgiIyIgKyBzLmlkKVtmdW5dKCdncmlkJykuZGF0YWdyaWQoJ2dldFBhZ2VyJykucGFnaW5hdGlvbignbG9hZGVkJyk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl0cnkgewoJCQkJJCgiIyIgKyBzLmlkKVtmdW5dKCdncmlkJykuZGF0YWdyaWQoJ2xvYWREYXRhJywgewoJCQkJCXRvdGFsOiBkYXRhLkNvdW50IHx8IGRhdGEubGVuZ3RoLAoJCQkJCXJvd3M6IGRhdGEsCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCSQoIiMiICsgcy5pZClbZnVuXSgndHJlZScpLnRyZWUoJ2xvYWREYXRhJywgZGF0YSk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJZXZlbnRIYW5kbGVycyhvcHRpb25zKSB7CgkJLy9jb25zb2xlLmxvZygiRHluYUZvcm06OmV2ZW50SGFuZGxlcnMoKTogb3B0aW9ucyIsIG9wdGlvbnMpOwoJCWlmICghdGhpcy5ieU5hbWUob3B0aW9ucy5uYW1lKSkgcmV0dXJuOyAvLyBpZiBub3QgYW4gZWxlbWVudCwgZG8gbm90IHJ1biB0aGUgaGFuZGxlcnMKCgkJcmV0dXJuIHRoaXMuZXZlbnRzLmZpbHRlcihlID0+IGUudHlwZSA9PSBvcHRpb25zLnR5cGUgfHwgdHlwZW9mKGUudHlwZSkgPT09ICd1bmRlZmluZWQnKS5tYXAoZSA9PiBgJHtlLm5hbWV9OiAoJHtlLnBhcmFtcyB8fCAnJ30pID0+IHt0cnl7REZvcm0uJHtlLmhhbmRsZXJ9KERGb3JtLmJ5TmFtZSgiJHtvcHRpb25zLm5hbWV9IikgfHwgJHtfRnJFTUQuX3RvSlMob3B0aW9ucyl9IHx8IHtuYW1lOiAiJHtvcHRpb25zLm5hbWV9Iix0eXBlOiAiJHtvcHRpb25zLnR5cGV9In0sICR7ZS5wYXJhbXN9KX1jYXRjaChleCl7Y29uc29sZS5sb2coIkV2ZW50IEVycm9yOiAke29wdGlvbnMubmFtZX0vJHtvcHRpb25zLnR5cGV9LyR7ZS5uYW1lfSIsIGV4KTt9fWApLmpvaW4oJywnKTsKCX0KCglhc3luYyBQYW5lbE9wZW4oZSkgewoJCWlmIChlLmVkaXRvcikgcmV0dXJuIHRydWU7CgkJbGV0IGNvbnRlbnQgPSBlLnZhbHVlOwoJCWlmIChlLmxvYWRlcikgewoJCQljb250ZW50ID0gYXdhaXQgZS5sb2FkZXIodGhpcy5nZXQoKSk7CgkJfQoJCWlmIChjb250ZW50KSB7CgkJCXRyeSB7CgkJCQkkKCIjcG5sIiArIGUubmFtZSkucGFuZWwoJ2JvZHknKS5odG1sKGNvbnRlbnQpOwoJCQkJY29uc29sZS5sb2coInBubCIgKyBlLm5hbWUgKyAiOiBDb250ZW50IFZhbGlkIik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkvL2NvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gY29udGVudDsKCX0KCglhc3luYyBTZWxlY3RDaGFuZ2Uob3B0aW9ucywgdGFiKSB7CgkJdGhpcy5idXN5KHRydWUpOwoJCSQuZ3JlcCh0aGlzLmVsZW1lbnRzLCBlID0+IGUudHlwZSA9PSAiZ3JpZCIgJiYgZS5ncm91cCA9PSB0YWIpLmZvckVhY2goZSA9PiAkKCIjY21iIiArIGUubmFtZSkuZGF0YWdyaWQoKSk7CgkJdGhpcy5idXN5KGZhbHNlKTsKCX0KCglhc3luYyBGaWVsZENoYW5nZShvcHRpb25zLCB2YWx1ZSkgewoJCXRoaXMuYnVzeSh0cnVlKTsKCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNoYW5nZSkgewoJCQlhd2FpdCBvcHRpb25zLmNoYW5nZSh0aGlzLmdldCgpLCB2YWx1ZSk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJYXN5bmMgVVJMQ2hhbmdlKHMsIG9wdGlvbnMpIHsKCQlvcHRpb25zLmRhdGEgPSBhd2FpdCAkLmdldChzLnZhbHVlKTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5GaWVsZENoYW5nZShzLCBvcHRpb25zKTsKCX0KCglhc3luYyBVcGxvYWRGaWxlKGYsIG9wdGlvbnMpIHsKCQl0aGlzLmJ1c3kodHJ1ZSk7CgkJdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7CgkJdmFyIGZpbGVpZCA9IE1hdGgucmFuZG9tKCk7CgkJdmFyIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kIHx8ICJDb250ZW50TWFuYWdlci5jbXNVcGxvYWRGaWxlIjsKCQlmb3JtRGF0YS5hcHBlbmQoJ2ZpbGVpZCcsIGZpbGVpZCk7CgkJdmFyIGZpbGUgPSAkKCIjIiArIGYuZmlsZWJveElkKVswXS5maWxlc1swXTsKCQlmb3JtRGF0YS5hcHBlbmQoJ19fVUZJTEUnLCBmaWxlKTsKCQlpZiAob3B0aW9ucy5sb2NhbCkgewoJCQkvLyBoYW5kbGluZyB0aGUgZmlsZSBsb2NhbGx5CgkJCXZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwoJCQlyZWFkZXIub25sb2FkID0gYXN5bmMgKGUpID0+IHsKCQkJCXZhciBkYXRhID0gZS50YXJnZXQucmVzdWx0OwoJCQkJREZvcm0uYnlOYW1lKG9wdGlvbnMubmFtZSkuZGF0YSA9IGRhdGE7CgkJCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwbG9hZCkgYXdhaXQgb3B0aW9ucy51cGxvYWQodGhpcy5nZXQoKSwgZGF0YSk7CgoJCQkJaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy54bWwgJiYgdHlwZW9mKGZhc3RYTUwpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCWF3YWl0IG9wdGlvbnMueG1sKHRoaXMuZ2V0KCksIG5ldyBmYXN0WE1MLlhNTFBhcnNlcih7CgkJCQkJCWlnbm9yZUF0dHJpYnV0ZXM6IGZhbHNlCgkJCQkJfSkucGFyc2UoZGF0YSkpOwoJCQkJfSBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXhjZWwgJiYgdHlwZW9mKEV4Y2VsSlMpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCS8vIGRhdGEgaXMgYW4gZXhjZWwgYmluYXJ5IGZpbGUKCQkJCQljb25zdCB3YiA9IG5ldyBFeGNlbEpTLldvcmtib29rKCk7CgkJCQkJbGV0IHdvcmtib29rID0gYXdhaXQgd2IueGxzeC5sb2FkKGRhdGEpOwoJCQkJCWxldCBhckRhdGEgPSB7fTsKCQkJCQl3b3JrYm9vay5lYWNoU2hlZXQoKHNoZWV0LCBpZCkgPT4gewoJCQkJCQlsZXQgY29sdW1ucyA9IFtdOwoJCQkJCQlmb3IgKHZhciBpID0gMDsgc2hlZXQuZ2V0Q2VsbChTdHJpbmcuZnJvbUNoYXJDb2RlKCdBJy5jaGFyQ29kZUF0KDApICsgaSkgKyAnMScpLnZhbHVlOyBpKyspIGNvbHVtbnMucHVzaChzaGVldC5nZXRDZWxsKFN0cmluZy5mcm9tQ2hhckNvZGUoJ0EnLmNoYXJDb2RlQXQoMCkgKyBpKSArICcxJykudmFsdWUpOwoKCQkJCQkJbGV0IHJEYXRhID0gW107CgkJCQkJCWZvciAodmFyIGogPSAyOyBzaGVldC5nZXRDZWxsKCJBIiArIGopLnZhbHVlOyBqKyspIHsKCQkJCQkJCXJEYXRhLnB1c2goT2JqZWN0LmFzc2lnbiguLi5jb2x1bW5zLm1hcCgoYywgaSkgPT4gKHsKCQkJCQkJCQlbY106IHNoZWV0LmdldENlbGwoU3RyaW5nLmZyb21DaGFyQ29kZSgnQScuY2hhckNvZGVBdCgwKSArIGkpICsgaikudmFsdWUKCQkJCQkJCX0pKSkpOwoJCQkJCQl9CgoJCQkJCQlhckRhdGFbc2hlZXQubmFtZV0gPSByRGF0YTsKCQkJCQl9KTsKCQkJCQlhd2FpdCBvcHRpb25zLmV4Y2VsKHRoaXMuZ2V0KCksIGFyRGF0YSk7CgkJCQl9CgoJCQkJdGhpcy5idXN5KGZhbHNlKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuYmluYXJ5KSB7CgkJCQlyZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpOwoJCQl9IGVsc2UgaWYgKG9wdGlvbnMuZGF0YXVybCkgewoJCQkJcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7CgkJCX0gZWxzZSB7CgkJCQlyZWFkZXIucmVhZEFzVGV4dChmaWxlKTsKCQkJfQoJCX0gZWxzZSBpZiAobWV0aG9kKSB7CgkJCSQuYWpheCh7CgkJCQl1cmw6IHRoaXMuc3IoKS5zclVSTCArICImbWV0aG9kPSIgKyBtZXRob2QgKyAiJnNJbnB1dD0iICsgZmlsZWlkICsgIiZwcmVUYWc9JnBvc3RUYWc9IiwKCQkJCWRhdGE6IGZvcm1EYXRhLAoJCQkJLy8gVEhJUyBNVVNUIEJFIERPTkUgRk9SIEZJTEUgVVBMT0FESU5HCgkJCQljYWNoZTogZmFsc2UsCgkJCQljb250ZW50VHlwZTogZmFsc2UsCgkJCQl0eXBlOiAnUE9TVCcsCgkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQlzdWNjZXNzOiBkYXRhID0+IHsKCQkJCQl0aGlzLnNyKCkucnVuU2NyaXB0KGRhdGEpOwoJCQkJCXRoaXMuYnlOYW1lKG9wdGlvbnMubmFtZSkuZGF0YSA9IHJldDsKCQkJCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwbG9hZCkgb3B0aW9ucy51cGxvYWQodGhpcy5nZXQoKSwgcmV0KTsKCQkJCQl0aGlzLmJ1c3koZmFsc2UpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9CgoJZUZ1bihlKSB7CgkJdHJ5IHsKCQkJaWYgKGUudHlwZSA9PSAidHJlZSIpIHsKCQkJCWlmIChlLmNvbHVtbnMpIHsKCQkJCQlyZXR1cm4gImNvbWJvdHJlZWdyaWQiOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZS5jb21ibykgIT09ICd1bmRlZmluZWQnICYmICFlLmNvbWJvKSB7CgkJCQkJcmV0dXJuICd0cmVlJzsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuICJjb21ib3RyZWUiOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGUudHlwZSA9PSAnbmF2aWdhdGlvbicpIHsKCQkJCXJldHVybiAndHJlZSc7CgkJCX0gZWxzZSBpZiAoZS50eXBlID09ICJjb21ib3RyZWUiKSB7CgkJCQlyZXR1cm4gImNvbWJvdHJlZWdyaWQiOwoJCQl9IGVsc2UgaWYgKGUudHlwZSA9PSAic2VsZWN0IiAmJiBlLm9wdGlvbnMpIHsKCQkJCXJldHVybiAiY29tYm9ib3giOwoJCQl9CgkJCXJldHVybiAiY29tYm9ncmlkIjsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gImNvbWJvZ3JpZCI7CgkJfQoJfQoKCV9maWxsV2luZG93KHdpbk5hbWUsIHYsIG1hcCkgewoJCXYgPSB2IHx8IHt9OwoJCW1hcCA9IG1hcCB8fCB7fTsKCQlpZiAoQXJyYXkuaXNBcnJheShtYXApKSB7CgkJCW1hcCA9IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKG1hcCkpOwoJCX0KCgkJbWFwID0gJC5leHRlbmQoe30sIG1hcCwgT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5rZXlzKHYpLm1hcChrID0+IFt3aW5OYW1lICsgaywga10pKSk7CgoJCWxldCBzID0ge307CgkJZm9yICh2YXIgbSBpbiBtYXApIHsKCQkJaWYgKHR5cGVvZih2W21hcFttXV0pID09PSAidW5kZWZpbmVkIikgewoJCQkJLy9jb25zb2xlLmxvZygnaXNfdW5kZWZpbmVkJywgbSwgbWFwW21dLCB2W21hcFttXV0pOwoJCQkJc1ttXSA9IG1hcFttXTsKCQkJfSBlbHNlIHsKCQkJCS8vY29uc29sZS5sb2coJ2lzX25vdF91bmRlZmluZWQnLCBtLCBtYXBbbV0sIHZbbWFwW21dXSk7CgkJCQlzW21dID0gdlttYXBbbV1dOwoJCQl9CgkJfQoJCXRoaXMuY2xlYXIod2luTmFtZSk7CgkJLy9jb25zb2xlLmxvZygicyIsIHMpOwoJCXRoaXMuc2V0KHMpOwoJCSQoIiNwbmxfIiArIHdpbk5hbWUpLndpbmRvdygib3BlbiIpOwoJfQoKCXdpbmRvd1RvRW50aXR5KG8sIGJFbXB0eSwgZ3JpZCwgcHJlZml4LCBmaWx0ZXIpIHsKCQlvID0gbyB8fCB0aGlzLmdldCgpOwoJCWZpbHRlciA9IGZpbHRlciB8fCAodiA9PiB2KTsKCQlsZXQgcmV0ID0gZ3JpZCA/IChncmlkLnNlbGVjdGVkIHx8IGdyaWQpIDogbnVsbDsKCQlpZiAoYkVtcHR5KSB7CgkJCXJldCA9IHt9OwoJCQlvID0ge307CgkJfSBlbHNlIHsKCQkJcmV0ID0gKHJldCAmJiByZXQuSWQpID8gewoJCQkJSWQ6IHJldC5JZAoJCQl9IDoge307CgkJfQoKCQl0aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+IChwcmVmaXggPyBlLmdyb3VwID09IHByZWZpeCA6IHRydWUpICYmIGUudHlwZSAhPSAnbGluaycgJiYgWydfJ10uaW5kZXhPZihlLm5hbWUucmVwbGFjZShwcmVmaXgsICIiKSkgPCAwKS5mb3JFYWNoKGUgPT4gewoJCQlyZXRbZS5uYW1lLnJlcGxhY2UocHJlZml4LCAiIildID0gb1tlLm5hbWVdOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsKCgkJZmlsdGVyKHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYmluZChvYmopIHsKCQl2YXIgb2JqQmluZCA9IChvLCBlKSA9PiB7CgkJCW9bdGhpcy5lRnVuKGUpXSh7CgkJCQlvblNob3dQYW5lbDogKCkgPT4gewoJCQkJCXRoaXMuZmlsbERhdGEoJCgiIyIgKyBlLmlkKSwgbnVsbCwgMCwgMTApOwoJCQkJfSwKCQkJCW9uQ2xpY2tSb3c6IChpbmRleCwgcm93KSA9PiB7CgkJCQkJdmFyIHMgPSByb3cgPyByb3cuX19PV05FUiA6IG51bGw7CgkJCQkJLy8gY29uc29sZS5sb2coIm9uQ2xpY2tSb3coKTogIiwgaW5kZXgsIHJvdywgcyk7CgkJCQkJaWYgKHMgJiYgcy5vcHRpb25zLnNlbGVjdCkgewoJCQkJCQlzLm9wdGlvbnMuc2VsZWN0KHJvdywgdGhpcy5nZXQoKSk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdHJ5IHsKCQkJCXZhciBkZyA9IG9bdGhpcy5lRnVuKGUpXSgnZ3JpZCcpOwoJCQkJLy8gZGcuZGF0YWdyaWQoJ2VuYWJsZUZpbHRlcicpCgkJCQl2YXIgc3RhdGUgPSBkZy5kYXRhKCdkYXRhZ3JpZCcpOwoJCQkJdmFyIG9wdHMgPSBzdGF0ZS5vcHRpb25zOwoJCQkJdmFyIG9uQmVmb3JlTG9hZCA9IG9wdHMub25CZWZvcmVMb2FkOwoJCQkJb3B0cy5vbkJlZm9yZUxvYWQgPSAocGFyYW0pID0+IHsKCQkJCQlzdGF0ZS5hbGxSb3dzID0gbnVsbDsKCQkJCQlyZXR1cm4gb25CZWZvcmVMb2FkLmNhbGwodGhpcywgcGFyYW0pOwoJCQkJfTsKCQkJCXZhciBwYWdlciA9IGRnLmRhdGFncmlkKCdnZXRQYWdlcicpOwoJCQkJZGcuZGF0YWdyaWQoJ2dldFBhbmVsJykucGFuZWwoewoJCQkJCUlEOiBpCgkJCQl9KTsKCQkJCXBhZ2VyLnBhZ2luYXRpb24oewoJCQkJCW9uU2VsZWN0UGFnZTogZnVuY3Rpb24ocGFnZU51bSwgcGFnZVNpemUpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCURGb3JtLmZpbGxEYXRhKCQoIiMiICsgREZvcm0uc2VsZWN0c1skKHRoaXMucGFyZW50Tm9kZSkucGFuZWwoJ29wdGlvbnMnKS5JRF0uaWQpLCBudWxsLCBwYWdlU2l6ZSAqIChwYWdlTnVtIC0gMSksIHBhZ2VTaXplICogcGFnZU51bSk7CgkJCQkJCX0gY2F0Y2ggKF9leCkgewoJCQkJCQkJY29uc29sZS5sb2coIkR5bmFGb3JtOjpvblNlbGVjdFBhZ2UoKSAiLCBfZXgpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJCQlkZy5kYXRhZ3JpZCgnbG9hZERhdGEnLCBzdGF0ZS5kYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfTsKCQlpZiAob2JqKSB7CgkJCW9iakJpbmQob2JqKTsKCQl9IGVsc2UgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuc2VsZWN0cy5sZW5ndGg7IGkrKykgewoJCQkJaWYgKHRoaXMuc2VsZWN0c1tpXS5vcHRpb25zLm9wdGlvbnMpIHsKCQkJCQkvLyQoIiMiICsgdGhpcy5zZWxlY3RzW2ldLmlkKS5jb21ibygpOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpCaW5kKCQoIiMiICsgdGhpcy5zZWxlY3RzW2ldLmlkKSwgdGhpcy5zZWxlY3RzW2ldKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5lbGVtZW50cy5maWx0ZXIoZSA9PiBlLndpbmRvdyAmJiBlLmdyb3VwKS5mb3JFYWNoKGUgPT4gewoJCQkJbGV0IHQgPSAkKCIjdGJjV2luZG93IikudGFicygiZ2V0VGFiIiwgZS5ncm91cCk7CgkJCQlpZiAodCkgewoJCQkJCXQucGFuZWwoJ29wdGlvbnMnKS50YWIuaGlkZSgpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9CgoJZW5nbGlzaChzKSB7CgkJaWYgKCFzKSByZXR1cm4gIiI7CgkJdmFyIHJlc3VsdCA9IHMucmVwbGFjZSgvKFtBLVpdKS9nLCAiICQxIik7CgkJcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoL18vZywgJycpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJb25Ub2dnbGUoZSwgYlZhbHVlKSB7CgkJbGV0IHNUYWcgPSBgI2ZFbGVtZW50XyR7ZS5mb3IubmFtZX0gPiAuZWFzeXVpLSR7dGhpcy51aVR5cGVzW2UuZm9yLnR5cGVdfWA7CgkJbGV0IG9UYWcgPSAkKHNUYWcpOwoJCWUuZm9yLmVuYWJsZWQgPSB0eXBlb2YoYlZhbHVlKSA9PT0gInVuZGVmaW5lZCIgPyAhZS5mb3IuZW5hYmxlZCA6IGJWYWx1ZTsKCgkJb1RhZy5wcm9wKCJkaXNhYmxlZCIsICFlLmZvci5lbmFibGVkKTsKCQkvL29UYWdbdGhpcy51aVR5cGVzW2UuZm9yLnR5cGVdXShlLmZvci5lbmFibGVkID8gImVuYWJsZSIgOiAiZGlzYWJsZSIpOwoJCWNvbnNvbGUubG9nKHNUYWcsIG9UYWcsIHRoaXMudWlUeXBlc1tlLmZvci50eXBlXSwgZS5mb3IuZW5hYmxlZCk7Cgl9CgoJcmVuZGVyKG5hbWUsIHRpdGxlLCBlbGVtZW50cywgYnV0dG9ucywgYkZpeGVkKSB7CgkJdGhpcy5lbGVtZW50cyA9IChlbGVtZW50cyB8fCBbXSkuZmlsdGVyKGUgPT4gIWUuaWdub3JlKTsKCgkJdGhpcy5idXR0b25zID0gYnV0dG9ucyB8fCBbXTsKCQl0aGlzLnNlbGVjdHMgPSBbXTsKCQl0aGlzLmdyaWRzID0gW107CgoJCXRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gZS50eXBlID09ICJ3aW5kb3ciKS5mb3JFYWNoKHcgPT4gdGhpcy5lbGVtZW50cy5zcGxpY2UodGhpcy5lbGVtZW50cy5maW5kSW5kZXgoZSA9PiBlLm5hbWUgPT0gdy5uYW1lKSwgMCwgewoJCQluYW1lOiAiXyIgKyB3Lm5hbWUsCgkJCXR5cGU6ICJsaW5rIiwKCQkJdGl0bGU6IHcudGl0bGUgfHwgdGhpcy5lbmdsaXNoKHcubmFtZSksCgkJCWdyb3VwOiB3Lmdyb3VwLAoJCQl3aW5kb3c6IHcud2luZG93LAoJCQlzZWN0aW9uOiB3LnNlY3Rpb24sCgkJCWxpbmtzOiBbewoJCQkJbGFiZWw6ICdPcGVuJywKCQkJCWljb246ICdlZGl0JywKCQkJCW9uQ2xpY2s6IG8gPT4gJCgiI3BubCIgKyB3Lm5hbWUpLndpbmRvdygnb3BlbicpCgkJCX1dLAoJCX0pKTsKCgkJdGhpcy5zcigpLmdyb3VwQnkodGhpcy5lbGVtZW50cy5maWx0ZXIoZSA9PiBlLndpbmRvdyksICJncm91cCIpLmZvckVhY2goa3YgPT4gewoJCQlpZiAoIWt2LmtleSkgcmV0dXJuOwoKCQkJbGV0IGUgPSB7CgkJCQluYW1lOiAiXyIgKyBrdi5rZXksCgkJCQl0aXRsZToga3Yua2V5LAoJCQkJdHlwZTogIndpbmRvdyIsCgkJCQlncm91cDoga3Yua2V5LAoJCQkJd2lkdGg6IHRoaXMud2lkdGggKiAwLjksCgkJCQloZWlnaHQ6IHRoaXMuaGVpZ2h0ICogMC45LAoJCQkJbG9hZGVyOiBvID0+IHsKCQkJCQlrdi52YWx1ZXMuZmlsdGVyKHYgPT4gdi50eXBlICE9PSAnbGluaycgfHwgKHYudHlwZSA9PSAnbGluaycgJiYgdi5uYW1lLnN0YXJ0c1dpdGgoJ18nKSkpLmZvckVhY2godiA9PiAkKCIjcG5sXyIgKyB2Lmdyb3VwICsgJy1jZW50ZXInKS5hcHBlbmQoJCgiI2ZFbGVtZW50XyIgKyB2Lm5hbWUpKSk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9LAoJCQkJYnV0dG9uczogW10uY29uY2F0LmFwcGx5KFtdLCBrdi52YWx1ZXMuZmlsdGVyKHYgPT4gdi50eXBlID09ICdsaW5rJyAmJiAhdi5uYW1lLnN0YXJ0c1dpdGgoJ18nKSkubWFwKHYgPT4gWy4uLnYubGlua3MubWFwKGwgPT4gKHsKCQkJCQluYW1lOiBsLm5hbWUgfHwgbC5sYWJlbCwKCQkJCQl0aXRsZTogbC50aXRsZSB8fCBsLmxhYmVsLAoJCQkJCW9uQ2xpY2s6IGwub25DbGljaywKCQkJCQlpY29uOiBsLmljb24sCgkJCQkJd2luZG93OiB0cnVlLAoJCQkJCWdyb3VwOiBrdi5rZXksCgkJCQl9KSldKSksCgkJCX07CgkJCXRoaXMuYnV0dG9ucy5wdXNoKC4uLmUuYnV0dG9ucyk7CgoJCQl0aGlzLmVsZW1lbnRzLnB1c2goZSk7CgkJfSk7CgoJCXZhciByZXQgPSAiIjsKCQkvLyBjaGVjayB0aGUgb3B0aW9uIG9mIHVzaW5nIHdpbmRvdygpIGFzIGEgcmVuZGVyZXIgb2YgdGhlIG1haW4gd2luZG93Li4uCgkJaWYgKHRydWUpIHsKCQkJdGhpcy5lbGVtZW50cy5maWx0ZXIoZSA9PiAhZS56b25lKS5mb3JFYWNoKGUgPT4gZS56b25lID0gJ2NlbnRlcicpOwoJCQlsZXQgd09wdGlvbnMgPSB7CgkJCQluYW1lOiBuYW1lIHx8IHRoaXMubmFtZSwKCQkJCXRpdGxlOiB0aXRsZSB8fCB0aGlzLnRpdGxlLAoJCQkJdHlwZTogJ3dpbmRvdycsCgkJCQl2aXNpYmxlOiB0cnVlLAoJCQkJd2lkdGg6IHRoaXMud2lkdGgsCgkJCQloZWlnaHQ6IHRoaXMuaGVpZ2h0LAoJCQkJZml4ZWQ6IGJGaXhlZCwKCQkJCWxpbmtzOiBbewoJCQkJCWljb246ICJoZWxwIiwKCQkJCQlhY3Rpb246IG8gPT4gJCgiI3BubF9fQ29uc29sZSIpLndpbmRvdygnb3BlbicpCgkJCQl9XSwKCQkJCWJ1dHRvbnM6IHRoaXMuYnV0dG9ucy5maWx0ZXIoYiA9PiAhYi53aW5kb3cpLAoJCQl9OwoJCQl0aGlzLnNyKCkuZ3JvdXBCeSh0aGlzLmVsZW1lbnRzLCAnem9uZScpLmZpbHRlcih6ZyA9PiB6Zy5rZXkpLmZvckVhY2goemcgPT4gewoJCQkJd09wdGlvbnNbemcua2V5XSA9IHRoaXMucmVuZGVyRWxlbWVudHMoemcudmFsdWVzKTsKCQkJfSk7CgoJCQlyZXQgPSB0aGlzLndpbmRvdyh3T3B0aW9ucyk7CgkJfSBlbHNlIHsKCQkJcmV0ID0gdGhpcy5oZWFkZXIobmFtZSwgdGl0bGUsIGJGaXhlZCwgW3sKCQkJCWljb246ICJoZWxwIiwKCQkJCWFjdGlvbjogbyA9PiAkKCIjcG5sX19Db25zb2xlIikud2luZG93KCdvcGVuJykKCQkJfV0pOwoKCQkJcmV0ICs9IHRoaXMucmVuZGVyRWxlbWVudHMoKTsKCgkJCXJldCArPSB0aGlzLmZvb3RlcihiRml4ZWQpOwoKCQl9CgkJLy8gY29uc29sZS5sb2cocmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCgljV2lkdGgob3B0aW9ucykgewoJCWxldCByZXQgPSBNYXRoLmZsb29yKCgob3B0aW9ucyA/IG9wdGlvbnMud2lkdGggOiBudWxsKSB8fCAodGhpcy53aWR0aCAvIDMpKSk7CgkJaWYgKG9wdGlvbnMuem9uZSA9PSAnZWFzdCcgfHwgb3B0aW9ucy56b25lID09ICd3ZXN0JykgewoJCQlyZXQgPSAwLjI1ICogcmV0OyAvLyA5MCUgb2YgMy8xMCwgdGhlIHdpZHRoIG9mIHRoZSBub3JtYWwgZWxlbWVudAoJCX0gZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVkaXRvcikgewoJCQlyZXQgPSB3aW5kb3cuaW5uZXJXaWR0aDsKCQl9IGVsc2UgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy53aWR0aCAmJiB0eXBlb2Yob3B0aW9ucy53aWR0aCkgPT09ICdzdHJpbmcnKSB7CgkJCXJldCA9IHRoaXMud2lkdGg7CgkJfSBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMudHlwZSA9PSAnd2luZG93JyAmJiAhb3B0aW9ucy53aWR0aCkgewoJCQlyZXQgPSB0aGlzLndpZHRoICogMC45OwoJCX0KCgkJLy8gY29uc29sZS5sb2cob3B0aW9ucy5uYW1lICsgIjogY1dpZHRoID0gIiArIHJldCwgb3B0aW9ucy56b25lKTsKCQlyZXR1cm4gcmV0OwoJfQoKCXdpbmRvdyhvcHRpb25zKSB7CgkJb3B0aW9ucy50aXRsZSA9IG9wdGlvbnMudGl0bGUgfHwgb3B0aW9ucy5uYW1lOwoJCXZhciByZXQgPSBgCgkJPGRpdiBpZCA9ICJwbmwke29wdGlvbnMubmFtZX0iIGNsYXNzPSJlYXN5dWktd2luZG93IiB0aXRsZT0iJHtvcHRpb25zLnRpdGxlIHx8IHRoaXMuZW5nbGlzaChvcHRpb25zLm5hbWUpfSIgZGF0YS1vcHRpb25zPScke3RoaXMuZXZlbnRIYW5kbGVycyhvcHRpb25zKX0sIGNsb3NlZDokeyFvcHRpb25zLnZpc2libGV9LG1pbmltaXphYmxlOiR7IW9wdGlvbnMuZml4ZWR9LG1heGltaXphYmxlOiR7IW9wdGlvbnMuZml4ZWR9LGNsb3NhYmxlOiR7IW9wdGlvbnMuZml4ZWR9LGNvbGxhcHNpYmxlOiR7IW9wdGlvbnMuZml4ZWR9LGRyYWdnYWJsZTokeyFvcHRpb25zLmZpeGVkfSxyZXNpemFibGU6JHshb3B0aW9ucy5maXhlZH0saWNvbkNsczoiaWNvbi0ke29wdGlvbnMuaWNvbn0iLCB0b29sczoiIyR7b3B0aW9ucy5uYW1lfV90b29scyInIHN0eWxlPSJ3aWR0aDoke3RoaXMuY1dpZHRoKG9wdGlvbnMpfXB4O2hlaWdodDoke3RoaXMuY0hlaWdodChvcHRpb25zKX1weDtwYWRkaW5nOjEwcHg7Ij4KCQkgICAgPGRpdiBjbGFzcz0iZWFzeXVpLWxheW91dCIgZGF0YS1vcHRpb25zPSJmaXQ6dHJ1ZSI+CgkJYDsKCgkJbGV0IGJab25lID0gb3B0aW9ucy5zb3V0aCA/ICdzb3V0aCcgOiAodGhpcy56b25lcy5maW5kKHogPT4geiA9PSAnc291dGgnKSB8fCB0aGlzLnpvbmVzWzBdKTsKCQlvcHRpb25zW2Jab25lXSA9IG9wdGlvbnNbYlpvbmVdIHx8IFtdOwoJCWxldCB6V2lkdGggPSBNYXRoLm1pbigxMjAsIHRoaXMud2lkdGggKiAwLjk1IC8gKG9wdGlvbnMuYnV0dG9ucyA/IG9wdGlvbnMuYnV0dG9ucy5sZW5ndGggOiAxKSwgdGhpcy5jV2lkdGgob3B0aW9ucykpOwoJCW9wdGlvbnNbYlpvbmVdLnB1c2goYDxkaXYgaWQ9InBubCR7b3B0aW9ucy5uYW1lfS1idXR0b25zIiBkYXRhLW9wdGlvbnM9InJlZ2lvbjonJHtiWm9uZX0nLGJvcmRlcjpmYWxzZSIgc3R5bGU9InRleHQtYWxpZ246cmlnaHQ7cGFkZGluZzo1cHggMCAwOyI+YCArICQubWFwKCQuZ3JlcChvcHRpb25zLmJ1dHRvbnMgfHwgW10sIGIgPT4gIWIuaWdub3JlKSwgYiA9PiBgPGEgaWQ9JyR7Yi5uYW1lfScgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iZWFzeXVpLWxpbmtidXR0b24gYzYiIGljb25DbHM9Imljb24tJHtiLmljb24gfHwgJ3NhdmUnfSIgc3R5bGU9IndpZHRoOiR7eldpZHRofXB4IiBvbmNsaWNrPSdERm9ybS5kb0NsaWNrKCR7X0ZyRU1ELl90b0pTKGIpfSknPiR7Yi50aXRsZSB8fCBiLm5hbWV9PC9hPiZuYnNwOyZuYnNwO2ApLmpvaW4oJycpICsgYDwvZGl2PmApOwoKCQl0aGlzLnpvbmVzLmZpbHRlcih6ID0+IG9wdGlvbnNbel0pLmZvckVhY2goeiA9PiB7CgkJCXJldCArPSBgCgkJICAgICAgICA8ZGl2IGRhdGEtb3B0aW9ucz0icmVnaW9uOicke3p9JyIgdGl0bGU9IiR7KHo9PSd3ZXN0JyB8fCB6PT0nZWFzdCcpPycmbmJzcDsnOicnfSIgc3R5bGU9J2hlaWdodDokeyh6PT0nbm9ydGgnfHx6PT0nc291dGgnKT8xMDoxMDB9JTt3aWR0aDokeygoej09J2Vhc3QnfHx6PT0nd2VzdCcpPzAuMToxKSp0aGlzLmNXaWR0aChvcHRpb25zKX1weCc+CiAgICAgICAgCQkgICAgJHsoQXJyYXkuaXNBcnJheShvcHRpb25zW3pdKT9vcHRpb25zW3pdOltvcHRpb25zW3pdXSkuam9pbignJyl9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgYDsKCQl9KTsKCgkJcmV0ICs9IGA8L2Rpdj48L2Rpdj5gOwoKCQkvLyBsaW5rcyAodG9vbHMpCgkJbGV0IGxpbmtzID0gJC5ncmVwKFtdLmNvbmNhdChvcHRpb25zLmxpbmtzIHx8IFtdKSwgbCA9PiAhbC5pZ25vcmUpOwoJCXJldCArPSBgPGRpdiBpZD0iJHtvcHRpb25zLm5hbWV9X3Rvb2xzIj5gICsgJC5tYXAobGlua3MucmV2ZXJzZSgpLCBsID0+IGA8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHN0eWxlPSJjb2xvcjpibGFjayIgY2xhc3M9ImZhcyBmYS0ke2wuaWNvbiB8fCAnYWRkJ30iIG9uY2xpY2s9Jyhhc3luYyAoKSA9PiB7dmFyIGEgPSAke19GckVNRC5fdG9KUyhsKX07ICQoIiNwbmwke29wdGlvbnMubmFtZX0iKS53aW5kb3coInNldFRpdGxlIiwgIiR7b3B0aW9ucy50aXRsZX06ICIgKyBhLm5hbWUpOyBhd2FpdCBhLmFjdGlvbihERm9ybS5nZXQoKSwgYSwgJHtfRnJFTUQuX3RvSlMob3B0aW9ucyl9KTsgJCgiI3BubCR7b3B0aW9ucy5uYW1lfSIpLndpbmRvdygic2V0VGl0bGUiLCAiJHtvcHRpb25zLnRpdGxlfSIpO30pKCknPjwvYT5gKS5qb2luKCdcbicpICsgYDwvZGl2PmA7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2VuZCgpIHsKCQlsZXQgbyA9IHRoaXMuZ2V0KCk7CgoJCS8vIGRvIG5vdCB1c2UgdGhlIGZpcnN0IGJ1dHRvbiwgYmVjYXVzZSBtYW55IGZvcm1zIGhhdmUgYSBDYW5jZWwgYnV0dG9uIG9ubHkKCQlsZXQgYnV0dG9uID0gdGhpcy5idXR0b25zLmZpbmQoYiA9PiBiLmF1dG9TdWJtaXQpIC8qIHx8IHRoaXMuYnV0dG9uc1swXSovIDsKCQlpZiAoYnV0dG9uICYmIG8gJiYgT2JqZWN0LnZhbHVlcyhvKS5sZW5ndGggJiYgKHR5cGVvZihidXR0b24uYXV0b1N1Ym1pdCkgPT09ICJ1bmRlZmluZWQiIHx8IGJ1dHRvbi5hdXRvU3VibWl0KSkgewoJCQlsZXQgdiA9IE9iamVjdC52YWx1ZXMobykucmVkdWNlKCh0LCB2KSA9PiB7CgkJCQlyZXR1cm4gKCh0eXBlb2YodikgIT09ICJvYmplY3QiKSA/IDEgOiAwKSAqICh2ID8gMSA6IDApOwoJCQl9KTsKCQkJLy9jb25zb2xlLmxvZyhvLCBPYmplY3QudmFsdWVzKG8pLCB2KTsKCQkJaWYgKHYpIHsKCQkJCS8vIGFsbCBmaWVsZHMgaGF2ZSB2YWx1ZXMKCQkJCWF3YWl0IHRoaXMuZG9DbGljayhidXR0b24pOwoKCQkJfQoJCX0KCX0KCglmb290ZXIoYkZpeGVkKSB7CgkJcmV0dXJuIGA8L2Zvcm0+YCArIGA8ZGl2IGlkPSJkbGctYnV0dG9ucyI+YCArIHRoaXMuYnV0dG9ucy5maWx0ZXIoYiA9PiAhYi53aW5kb3cpLm1hcChiID0+IGA8YSBpZD0nJHtiLm5hbWV9JyBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJlYXN5dWktbGlua2J1dHRvbiBjNiIgaWNvbkNscz0iaWNvbi0ke2IuaWNvbiB8fCAnc2F2ZSd9IiBzdHlsZT0id2lkdGg6JHtNYXRoLm1pbigxMjAsIHRoaXMud2lkdGggKiAwLjk1IC8gdGhpcy5idXR0b25zLmxlbmd0aCwgdGhpcy5jV2lkdGgoKSl9cHgiIG9uY2xpY2s9J0RGb3JtLmRvQ2xpY2soJHtfRnJFTUQuX3RvSlMoYil9KSc+JHtiLnRpdGxlIHx8IHRoaXMuZW5nbGlzaChiLm5hbWUpfTwvYT4mbmJzcDsmbmJzcDtgKS5qb2luKCcnKSArICI8L2Rpdj4iICsgKGJGaXhlZCA/ICIiIDogJzwvZGl2PicpOwoJfQoKCWhlYWRlcihuYW1lLCB0aXRsZSwgYkZpeGVkLCBsaW5rcykgewoJCXRoaXMudGl0bGUgPSB0aXRsZSB8fCB0aGlzLnRpdGxlOwoJCW5hbWUgPSBuYW1lIHx8IHRoaXMubmFtZTsKCQl2YXIgcmV0ID0gJyc7CgoJCXJldCArPSB0aGlzLndpbmRvdyh7CgkJCW5hbWU6ICJfX0NvbnNvbGUiLAoJCQl0eXBlOiAid2luZG93IiwKCQkJZWRpdG9yOiB0cnVlLAoJCQlsb2FkZXI6IG8gPT4gd2luZG93LmxvZ3Muc2xpY2UoKS5yZXZlcnNlKCkubWFwKGwgPT4gbC5kYXRlLnRvSVNPU3RyaW5nKCkgKyAiOiAiICsgbC5hcmdzLm1hcChzID0+IHR5cGVvZihzKSA9PT0gJ29iamVjdCcgPyAoKG9iaiwgaW5kZW50ID0gMikgPT4gewoJCQkJbGV0IGNhY2hlID0gW107CgkJCQljb25zdCByZXRWYWwgPSBKU09OLnN0cmluZ2lmeSgKCQkJCQlvYmosCgkJCQkJKGtleSwgdmFsdWUpID0+CgkJCQkJdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCA/CgkJCQkJY2FjaGUuaW5jbHVkZXModmFsdWUpID8KCQkJCQl1bmRlZmluZWQgLy8gRHVwbGljYXRlIHJlZmVyZW5jZSBmb3VuZCwgZGlzY2FyZCBrZXkKCQkJCQk6CgkJCQkJY2FjaGUucHVzaCh2YWx1ZSkgJiYgdmFsdWUgLy8gU3RvcmUgdmFsdWUgaW4gb3VyIGNvbGxlY3Rpb24KCQkJCQk6CgkJCQkJdmFsdWUsCgkJCQkJaW5kZW50CgkJCQkpOwoJCQkJY2FjaGUgPSBudWxsOwoJCQkJcmV0dXJuIHJldFZhbDsKCQkJfSkocykgOiBzKS5qb2luKCcsICcpKS5qb2luKCdcbicpLAoJCX0pOwoKCQlpZiAoIWJGaXhlZCkgewoJCQlsaW5rcyA9IChsaW5rcyB8fCBbXSkuZmlsdGVyKGwgPT4gIWwuaWdub3JlKTsKCQkJbGV0IHREYXRhID0gIiI7CgkJCWlmIChsaW5rcy5sZW5ndGgpIHsKCQkJCXJldCArPSBgPGRpdiBpZD0iJHt0aGlzLm5hbWV9X3Rvb2xzIj5gICsgbGlua3MubWFwKGwgPT4gYDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9Imljb24tJHtsLmljb259IiBvbmNsaWNrPScoYXN5bmMgKCkgPT4ge3ZhciBhID0gJHtfRnJFTUQuX3RvSlMobCl9OyAkKCIjd2luJHt0aGlzLm5hbWV9Iikud2luZG93KCJzZXRUaXRsZSIsICIke3RoaXMudGl0bGV9OiAiICsgYS5uYW1lKTsgYXdhaXQgYS5hY3Rpb24oREZvcm0uZ2V0KCkpOyAkKCIjd2luJHt0aGlzLm5hbWV9Iikud2luZG93KCJzZXRUaXRsZSIsICIke3RoaXMudGl0bGV9Iik7fSkoKSc+PC9hPmApLmpvaW4oJ1xuJykgKyAiPC9kaXY+IjsKCQkJCXREYXRhID0gYCx0b29sczoiIyR7dGhpcy5uYW1lfV90b29scyJgOwoJCQl9CgkJCXJldCArPSBgPGRpdiBpZD0nd2luJHt0aGlzLm5hbWV9JyBjbGFzcz0nZWFzeXVpLXdpbmRvdycgdGl0bGU9JyR7dGhpcy50aXRsZSB8fCB0aGlzLmVuZ2xpc2godGhpcy5uYW1lKX0nIGRhdGEtb3B0aW9ucz0naWNvbkNsczoiaWNvbi1zYXZlIiAke3REYXRhfScgc3R5bGU9J3dpZHRoOiR7dGhpcy53aWR0aH1weDtoZWlnaHQ6JHt0aGlzLmhlaWdodH1weDtwYWRkaW5nOjEwcHg7Jz5gOwoJCX0KCQlyZXR1cm4gcmV0ICsgYDxmb3JtIGlkPSJmcm0ke3RoaXMubmFtZX0iIG1ldGhvZD0icG9zdCIgbm92YWxpZGF0ZT5gOwoJfQoKCXJlbmRlckVsZW1lbnRzKGVsZW1lbnRzKSB7CgkJZWxlbWVudHMgPSBlbGVtZW50cyB8fCB0aGlzLmVsZW1lbnRzOwoKCQl2YXIgdFdpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoICogMC45NSk7CgkJdmFyIHRIZWlnaHQgPSBNYXRoLmZsb29yKHRoaXMuaGVpZ2h0ICogMC44NSk7CgoJCWxldCByZXQgPSAnJzsKCQl2YXIgZ0VsZW1lbnRzID0gdGhpcy5zcigpLmdyb3VwQnkoZWxlbWVudHMsICJncm91cCIpOwoJCWlmIChnRWxlbWVudHMubGVuZ3RoID4gMSkgcmV0ICs9IGA8ZGl2IGlkPSJ0YmNXaW5kb3ciIGNsYXNzPSJlYXN5dWktdGFicyIgZGF0YS1vcHRpb25zPScke3RoaXMuZXZlbnRIYW5kbGVycyh7dHlwZTogJ3RhYnMnfSl9JyBzdHlsZT0id2lkdGg6JHt0V2lkdGh9cHg7aGVpZ2h0OiR7dEhlaWdodH1weDsiPmA7CgkJZm9yICh2YXIgZyA9IDA7IGcgPCBnRWxlbWVudHMubGVuZ3RoOyBnKyspIHsKCQkJaWYgKGdFbGVtZW50cy5sZW5ndGggPiAxKSByZXQgKz0gJzxkaXYgdGl0bGU9IicgKyAoZ0VsZW1lbnRzW2ddLmtleSB8fCAiTWFpbiIpICsgJyIgc3R5bGU9InBhZGRpbmc6MjBweDtkaXNwbGF5Om5vbmU7Ij4nOwoJCQl2YXIgc0VsZW1lbnRzID0gdGhpcy5zcigpLmdyb3VwQnkoZ0VsZW1lbnRzW2ddLnZhbHVlcywgInNlY3Rpb24iKTsKCQkJaWYgKHNFbGVtZW50cy5sZW5ndGggPiAxKSByZXQgKz0gJzxkaXYgY2xhc3M9ImVhc3l1aS1hY2NvcmRpb24iIHN0eWxlPSJ3aWR0aDonICsgdFdpZHRoICsgJ3B4O2hlaWdodDonICsgLyp0SGVpZ2h0Ki8gIjEwMCUiICsgJ3B4OyI+JzsKCQkJZm9yICh2YXIgcyA9IDA7IHMgPCBzRWxlbWVudHMubGVuZ3RoOyBzKyspIHsKCQkJCXJldCArPSBgPGRpdiB0aXRsZT0iJHtzRWxlbWVudHNbc10ua2V5IHx8ICIifSIgZGF0YS1vcHRpb25zPSJpY29uQ2xzOidpY29uLW1vcmUnIiBzdHlsZT0icGFkZGluZzoxMHB4OyI+YDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgc0VsZW1lbnRzW3NdLnZhbHVlcy5sZW5ndGg7IGkrKykgewoJCQkJCXZhciBlID0gc0VsZW1lbnRzW3NdLnZhbHVlc1tpXTsKCQkJCQlpZiAoZS5pZ25vcmUpIGNvbnRpbnVlOwoJCQkJCWUudmFsdWUgPSBlLnZhbHVlIHx8IF9GckVNRC5oYXNoW2UubmFtZV0gfHwgKF9GckVNRC5hcGlTZXJ2ZXIgPyBfRnJFTUQuYXBpU2VydmVyLl9fY29uZmlnKCd0ZXN0XycgKyBlLm5hbWUsICcnKSA6ICcnKTsKCQkJCQlyZXQgKz0gYDxkaXYgaWQ9ImZFbGVtZW50XyR7ZS5uYW1lfSIgY2xhc3M9ImZpdGVtIiBzdHlsZT0iZGlzcGxheTogJHsoZS50eXBlPT0nd2luZG93JyB8fCBlLmhpZGRlbik/J25vbmUnOicnfSI+YDsKCQkJCQlpZiAoZS50b2dnbGUpIHsKCQkJCQkJcmV0ICs9IGA8YSBocmVmPSIjIiBjbGFzcz0iZWFzeXVpLWxpbmtidXR0b24iIGRhdGEtb3B0aW9ucz0nJHt0aGlzLmV2ZW50SGFuZGxlcnMoe3R5cGU6ICd0b2dnbGUnLCBmb3I6IGV9KX0scGxhaW46dHJ1ZSxpY29uQ2xzOiJpY29uLSR7ZS5pY29uIHx8ICdzZWFyY2gnfSInIHN0eWxlPSJ3aWR0aDoxMDBweDtoZWlnaHQ6MzBweCI+JHtlLnRpdGxlIHx8IHRoaXMuZW5nbGlzaChlLm5hbWUpfTwvYT5gOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldCArPSBgPGxhYmVsPiR7ZS50aXRsZSB8fCB0aGlzLmVuZ2xpc2goZS5uYW1lKX06PC9sYWJlbD5gOwoJCQkJCX0KCQkJCQlpZiAoZS50eXBlICYmIHRoaXNbZS50eXBlXSkgewoJCQkJCQlyZXQgKz0gdGhpc1tlLnR5cGVdKGUpOwoJCQkJCX0gZWxzZSBpZiAoZS5yZW5kZXIpIHsKCQkJCQkJcmV0ICs9IGUucmVuZGVyKCk7CgkJCQkJfQoJCQkJCXJldCArPSAnPC9kaXY+JzsKCQkJCX0KCQkJCXJldCArPSAnPC9kaXY+JzsKCQkJfQoJCQlpZiAoc0VsZW1lbnRzLmxlbmd0aCA+IDEpIHJldCArPSAnPC9kaXY+JzsKCQkJaWYgKGdFbGVtZW50cy5sZW5ndGggPiAxKSByZXQgKz0gIjwvZGl2PiI7CgkJfQoJCWlmIChnRWxlbWVudHMubGVuZ3RoID4gMSkgcmV0ICs9ICI8L2Rpdj4iOwoJCXJldHVybiByZXQ7Cgl9CgoJaW5mbyhtc2cpIHsKCQlpZiAoJC5tZXNzYWdlcikgewoJCQkkLm1lc3NhZ2VyLmFsZXJ0KHRoaXMudGl0bGUsIG1zZywgJ2luZm8nKTsKCQl9IGVsc2UgewoJCQl0aGlzLnNyKCkuU2hvd01lc3NhZ2UobXNnLCB0aGlzLnRpdGxlKTsKCQl9Cgl9CgoJZXJyb3IobXNnKSB7CgkJaWYgKCQubWVzc2FnZXIpIHsKCQkJJC5tZXNzYWdlci5hbGVydCh0aGlzLnRpdGxlLCBtc2csICdlcnJvcicpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc3IoKS5TaG93TWVzc2FnZShtc2csIHRoaXMudGl0bGUpOwoJCX0KCX0KCglieU5hbWUobmFtZSkgewoJCXJldHVybiB0aGlzLmVsZW1lbnRzLmZpbmQoZSA9PiBlLm5hbWUgPT09IG5hbWUpOwoJfQoKCS8qKiBDb21wb25lbnRzOjpTdGFydCAqKi8KCUNvcmVDb21wb25lbnQgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IocGFnZSwgZEZvcm0sIG9TY29wZSkgewoJCQl0aGlzLnBhZ2UgPSBwYWdlOwoJCQl0aGlzLmRGb3JtID0gZEZvcm0gfHwgREZvcm07CgkJCXRoaXMub1Njb3BlID0gb1Njb3BlOwoJCX0KCgkJX3NlcnZlcigpIHsKCQkJbGV0IHNjb3BlID0gd2luZG93LmJMb2NhbCA/ICJwbGF0Zm9ybW1hbmFnZXIiIDogX0ZyRU1ELmFwaVNlcnZlci5TY29wZTsKCQkJcmV0dXJuIG5ldyhfRnJFTUQuX19zY29wZShzY29wZSlbX0ZyRU1ELl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKS5OYW1lXSkoKTsKCQl9CgoJCV9lbnRpdHlGaWVsZChlYykgewoJCQlyZXR1cm4gewoJCQkJbmFtZTogZWMuTmFtZS5yZXBsYWNlKC9cIC9nLCAnXycpLAoJCQkJdGl0bGU6IF9GckVNRC5fdGl0bGVDYXNlKGVjLk5hbWUpLAoJCQkJQ2xhc3M6IHsKCQkJCQlOYW1lOiBlYy5OYW1lLAoJCQkJCUlkOiBlYy5JZAoJCQkJfSwKCQkJCXpvbmU6ICdub3J0aCcsCgkJCQl0eXBlOiBlYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQocGVhID0+ICFwZWEuRW50aXR5TWV0aG9kICYmIHBlYS5FbnRpdHlUeXBlID09IGVjKSA/ICd0cmVlJyA6ICdzZWxlY3QnLAoJCQkJcGFyZW50RmllbGQ6IGVjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChwZWEgPT4gIXBlYS5FbnRpdHlNZXRob2QgJiYgcGVhLkVudGl0eVR5cGUgPT0gZWMpPy5OYW1lLAoJCQkJLy9zZWFyY2hGaWVsZDogZWMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklzU3RyaW5nKS5OYW1lLAoJCQkJLy9pZEZpZWxkOiAnX1RvU3RyaW5nJywKCQkJCXNvdXJjZTogKG8sIGZEYXRhLCBzVGV4dCkgPT4gKHsKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJW2VjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5Jc1N0cmluZykuTmFtZV06ICdsaWtlJwoJCQkJCX0sCgkJCQkJW2VjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5Jc1N0cmluZykuTmFtZV06IHNUZXh0CgoJCQkJfSksCgkJCX07CgkJfQoKCQlfZWFUb0ZpZWxkKGVhKSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gewoJCQkJZ3JvdXA6IGVhLkdyb3VwLk5hbWUsCgkJCQluYW1lOiBlYS5OYW1lLAoJCQkJX3R5cGU6IGVhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKHBlYSA9PiAhcGVhLkVudGl0eU1ldGhvZCAmJiBwZWEuRW50aXR5VHlwZSA9PSBlYS5FbnRpdHlUeXBlKSA/ICd0cmVlJyA6ICdzZWxlY3QnLAoJCQkJdHlwZTogJ3NlbGVjdCcsCgkJCQlwYXJlbnRGaWVsZDogZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQocGVhID0+ICFwZWEuRW50aXR5TWV0aG9kICYmIHBlYS5FbnRpdHlUeXBlID09IGVhLkVudGl0eVR5cGUpPy5OYW1lLAoJCQkJLy9pZEZpZWxkOiAnX1RvU3RyaW5nJywKCQkJCXpvbmU6ICdjZW50ZXInLAoJCQkJQ2xhc3M6IHsKCQkJCQlOYW1lOiBlYS5FbnRpdHlUeXBlLk5hbWUsCgkJCQkJSWQ6IGVhLkVudGl0eVR5cGUuSWQKCQkJCX0sCgkJCQlzb3VyY2U6IChvLCBmRGF0YSwgc1RleHQpID0+ICh7CgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCVtlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5Jc1N0cmluZykuTmFtZV06ICdsaWtlJwoJCQkJCX0sCgkJCQkJW2VhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklzU3RyaW5nKS5OYW1lXTogc1RleHQKCgkJCQl9KSwKCQkJfTsKCQkJaWYgKGVhLklzVGV4dCkgcmV0dXJuIHsKCQkJCWdyb3VwOiBlYS5Hcm91cC5OYW1lLAoJCQkJbmFtZTogZWEuTmFtZSwKCQkJCXR5cGU6ICd3aW5kb3cnLAoJCQkJem9uZTogJ2NlbnRlcicsCgkJCQllZGl0b3I6IHRydWUsCgkJCQlsYW5ndWFnZTogbyA9PiBlYS5OYW1lID09ICdzY3JpcHQnID8gJ2phdmFzY3JpcHQnIDogInRleHQiLAoJCQl9OwoKCQkJcmV0dXJuIHsKCQkJCWdyb3VwOiBlYS5Hcm91cC5OYW1lLAoJCQkJbmFtZTogZWEuTmFtZSwKCQkJCXpvbmU6ICdjZW50ZXInLAoJCQkJdHlwZTogT2JqZWN0LmVudHJpZXMoewoJCQkJCUJvb2w6ICdib29sJywKCQkJCQlEYXRlOiAnZGF0ZXRpbWUnLAoJCQkJCUludDogJ2ludCcsCgkJCQkJTG9uZzogJ2xvbmcnLAoJCQkJCUltYWdlOiAnaW1hZ2UnLAoJCQkJCVN0cmluZzogJ3N0cmluZycKCQkJCX0pLmZpbmQoZSA9PiBlYVsnSXMnICsgZVswXV0pWzFdLAoJCQl9OwoJCX0KCgkJYnVzeShiQnVzeSkgewoJCQlyZXR1cm4gdGhpcy5kRm9ybS5idXN5KGJCdXN5KTsKCQl9CgoJCV9tZSh2KSB7CgkJCWxldCBtZU5hbWUgPSAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgPyAoY29tcGFueS5sb2dnZWRJbklkZW50aXR5IHx8ICJtZSIpIDogIm1lIjsKCQkJaWYgKHYpIHsKCQkJCXdpbmRvd1ttZU5hbWVdID0gdjsKCQkJfQoKCQkJcmV0dXJuIHdpbmRvd1ttZU5hbWVdOwoJCX0KCgkJX2NhblZpZXcoKSB7CgkJCWlmICghdGhpcy5fbWUoKSkgewoJCQkJd2luZG93Ll9GckVNRC5zZXRVUkwoewoJCQkJCXBhZ2U6ICdsb2dpbicsCgkJCQkJX3JlZGlyZWN0OiB0aGlzLnBhZ2UuX2NvZGUsCgkJCQl9KTsKCQkJCXRocm93IGBfY2FuVmlldzogJHt0aGlzLnBhZ2UuX2NvZGV9IG5vdCBhbGxvd2VkIHdpdGhvdXQgbG9naW4hYDsKCQkJfQoJCX0KCgkJX25hbWUoKSB7CgkJCWlmICghdGhpcy5fbWUoKSkgcmV0dXJuICIiOwoJCQlyZXR1cm4gdGhpcy5fbWUoKS5uYW1lID8gdGhpcy5fbWUoKS5uYW1lKCkgOiB0aGlzLl9tZSgpLlRvU3RyaW5nOwoJCX0KCX0KCglNYWluQ29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCV9tZW51Q2xhc3NlcyhzY29wZSkgewoJCQlsZXQgb1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoJCQkvL2NvbnNvbGUubG9nKCJNYWluQ29tcG9uZW50OjpfbWVudUNsYXNzZXMoIiArIHNjb3BlICsgIik6IG9TY29wZSIsIHNjb3BlLCBvU2NvcGUsIF9GckVNRC5hcGlTZXJ2ZXIpOwoJCQlpZiAoIW9TY29wZSkgcmV0dXJuIFtdOwoKCQkJcmV0dXJuIF9GckVNRC5zcigpLmdyb3VwQnkob1Njb3BlLkVudGl0eUNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5tYXAoZyA9PiAoewoJCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuZEZvcm0uZW5nbGlzaChnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBfRnJFTUQuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCQlsYWJlbDogKGd2LmtleSA/IHRoaXMuZEZvcm0uZW5nbGlzaChndi5rZXkuTmFtZSkgOiBudWxsKSB8fCAnTWFpbicsCgkJCQkJc3ViTWVudXM6IGd2LnZhbHVlcy5tYXAoZ3Z2ID0+ICh7CgkJCQkJCWxhYmVsOiB0aGlzLmRGb3JtLmVuZ2xpc2goZ3Z2Lk5hbWUpLAoJCQkJCQljb2RlOiAnc3RvcmUnLAoJCQkJCQlkYXRhOiBndnYuTmFtZQoJCQkJCX0pKQoJCQkJfSkpCgkJCX0pKTsKCQl9CgoJCV9tZW51TWV0aG9kcyhzY29wZSkgewoJCQlsZXQgb1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoJCQkvL2NvbnNvbGUubG9nKCJNYWluQ29tcG9uZW50OjpfbWVudU1ldGhvZHMoIiArIHNjb3BlICsgIik6IG9TY29wZSIsIHNjb3BlLCBvU2NvcGUsIF9GckVNRC5hcGlTZXJ2ZXIpOwoJCQlpZiAoIW9TY29wZSkgcmV0dXJuIFtdOwoKCQkJcmV0dXJuIF9GckVNRC5zcigpLmdyb3VwQnkob1Njb3BlLkVudGl0eUNsYXNzZXMuZmlsdGVyKGVjID0+IGVjLkVudGl0eU1ldGhvZHMubGVuZ3RoKSwgJ0VudGl0eU1vZHVsZScpLm1hcChnID0+ICh7CgkJCQlsYWJlbDogKGcua2V5ID8gdGhpcy5kRm9ybS5lbmdsaXNoKGcua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQkJc3ViTWVudXM6IF9GckVNRC5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5kRm9ybS5lbmdsaXNoKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCQlzdWJNZW51czogZ3YudmFsdWVzLm1hcChtYyA9PiAoewoJCQkJCQlsYWJlbDogdGhpcy5kRm9ybS5lbmdsaXNoKG1jLk5hbWUpLAoJCQkJCQlzdWJNZW51czogbWMuRW50aXR5TWV0aG9kcy5tYXAoZW0gPT4gKHsKCQkJCQkJCWxhYmVsOiB0aGlzLmRGb3JtLmVuZ2xpc2goZW0uTmFtZSksCgkJCQkJCQljb2RlOiAnbWV0aG9kJywKCQkJCQkJCWRhdGE6IG1jLk5hbWUgKyAiLiIgKyBlbS5OYW1lCgkJCQkJCX0pKQoJCQkJCX0pKQoJCQkJfSkpCgkJCX0pKTsKCQl9CgoJCV9idWlsZE1lbnUoc2NvcGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlsYWJlbDogIk1haW4iLAoJCQkJb3JkZXI6IC0xLAoJCQkJc3ViTWVudXM6IFt7CgkJCQkJbGFiZWw6ICdJbmRleCcsCgkJCQl9LCB7CgkJCQkJbGFiZWw6ICJMb2dpbiIsCgkJCQl9LCB7CgkJCQkJbGFiZWw6ICJMb2FkIiwKCQkJCX0sIHsKCQkJCQlsYWJlbDogIlNhdmUiLAoJCQkJfSwgewoJCQkJCWxhYmVsOiAiTG9nb3V0IgoJCQkJfV0KCQkJfSwgewoJCQkJbGFiZWw6ICJQcm9jZXNzIiwKCQkJCW9yZGVyOiA5OTk5OCwKCQkJCXN1Yk1lbnVzOiB0aGlzLl9tZW51TWV0aG9kcyhzY29wZSkKCQkJfSwgewoJCQkJbGFiZWw6ICJTZXR1cCIsCgkJCQlvcmRlcjogOTk5OTksCgkJCQlzdWJNZW51czogdGhpcy5fbWVudUNsYXNzZXMoc2NvcGUpCgkJCX1dOwoJCX0KCX0KCglMb2FkQ29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCWFzeW5jIG1haW4oKSB7CgkJCXRoaXMucGFnZS5kYXRhID0gewoJCQkJZm9ybTogdGhpcy5kRm9ybS5yZW5kZXIoJ2ZybUxvYWQnLCAiTG9hZCBTZXR1cCBEYXRhIiwgW3sKCQkJCQluYW1lOiAnRXhjZWwnLAoJCQkJCXR5cGU6ICJmaWxlIiwKCQkJCQliaW5hcnk6IHRydWUsCgkJCQkJbG9jYWw6IHRydWUsCgkJCQkJdXBsb2FkOiBhc3luYyAoZkRhdGEsIGRhdGEpID0+IHsKCQkJCQkJdGhpcy5kRm9ybS5zZXQoewoJCQkJCQkJUHJvZ3Jlc3M6IDAKCQkJCQkJfSk7CgoJCQkJCQlsZXQgdGFibGVzID0gW107CgkJCQkJCWxldCBvYmogPSBbXTsKCgkJCQkJCWxldCBzZXJ2ZXIgPSB0aGlzLl9zZXJ2ZXIoKTsKCgkJCQkJCWNvbnN0IHdiID0gbmV3IEV4Y2VsSlMuV29ya2Jvb2soKTsKCQkJCQkJY29uc29sZS5jbGVhcigpOwoJCQkJCQlsZXQgd29ya2Jvb2sgPSBhd2FpdCB3Yi54bHN4LmxvYWQoZGF0YSk7CgkJCQkJCXdvcmtib29rLmVhY2hTaGVldCgoc2hlZXQsIGlkKSA9PiB7CgkJCQkJCQlsZXQgc1RhYmxlcyA9IHNoZWV0LmdldFRhYmxlcygpOwoJCQkJCQkJc1RhYmxlcy5mb3JFYWNoKHQgPT4gdC50YWJsZS5zaGVldCA9IHNoZWV0KTsKCQkJCQkJCXRhYmxlcy5wdXNoKC4uLnNUYWJsZXMpOwoJCQkJCQl9KTsKCQkJCQkJdGFibGVzID0gdGFibGVzLmZsYXQoKS5tYXAodCA9PiB0LnRhYmxlKTsKCgkJCQkJCS8vY29uc29sZS5jbGVhcigpOwoJCQkJCQl0YWJsZXMuZm9yRWFjaCh0ID0+IHsKCQkJCQkJCS8vY29uc29sZS5sb2codC5uYW1lLCB0LmNvbHVtbnMsIHQuc2hlZXQuZ2V0Q2VsbCgnQTInKS52YWx1ZSk7CgkJCQkJCQlmb3IgKHZhciBpID0gMjsgdC5zaGVldC5nZXRDZWxsKCdBJyArIGkpLnZhbHVlICE9PSBudWxsOyBpKyspIHsKCQkJCQkJCQlvYmoucHVzaChzZXJ2ZXIuX25ldyh0Lm5hbWUpLl9mcm9tRG9jdW1lbnQoT2JqZWN0LmFzc2lnbiguLi50LmNvbHVtbnMubWFwKChjLCBjaSkgPT4gKHsKCQkJCQkJCQkJW2MubmFtZV06IHQuc2hlZXQuZ2V0Q2VsbChTdHJpbmcuZnJvbUNoYXJDb2RlKCdBJy5jaGFyQ29kZUF0KDApICsgY2kpICsgaSkudmFsdWUKCQkJCQkJCQl9KSkpKSk7CgkJCQkJCQl9CgkJCQkJCX0pOwoKCQkJCQkJZm9yIGF3YWl0IChjb25zdCBvIG9mIG9iaikgewoJCQkJCQkJLy9hd2FpdCBfRnJFTUQuX3dhaXQoMTAwMCkKCQkJCQkJCWF3YWl0IG8uc3RvcmUoKTsKCQkJCQkJCXRoaXMuZEZvcm0uc2V0KHsKCQkJCQkJCQlQcm9ncmVzczogdGhpcy5kRm9ybS5nZXQoKS5Qcm9ncmVzcyArIDEwMC4wIC8gb2JqLmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0KCgkJCQkJCV9GckVNRC5SZW5kZXJQYWdlKHsKCQkJCQkJCV9jb2RlOiAnbG9naW4nCgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sIHsKCQkJCQluYW1lOiAiUHJvZ3Jlc3MiLAoJCQkJCXR5cGU6ICJwcm9ncmVzcyIsCgkJCQl9XSwgW3sKCQkJCQluYW1lOiAnTG9hZCcsCgkJCQkJb25jbGljazogYXN5bmMgbyA9PiB7fQoJCQkJfV0pCgkJCX07CgkJfQoJfQoKCVNhdmVDb21wb25lbnQgPSBjbGFzcyBleHRlbmRzIHRoaXMuQ29yZUNvbXBvbmVudCB7CgkJYXN5bmMgbWFpbigpIHsKCQkJLy90aGlzLl9jYW5WaWV3KCk7CgoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKCdmcm1TYXZlJywgIlNhdmUgU2V0dXAgRGF0YSIsIFt7CgkJCQkJbmFtZTogJ1NhdmUnLAoJCQkJCXR5cGU6ICJsYWJlbCIsCgkJCQkJdmFsdWU6ICJFeHBvcnQgdG8gRXhjZWwiLAoJCQkJfSwgewoJCQkJCW5hbWU6ICdUaXRsZScsCgkJCQkJdHlwZTogJ3N0cmluZycsCgkJCQkJdmFsdWU6ICcnLAoJCQkJfSwgewoJCQkJCW5hbWU6ICJQcm9ncmVzcyIsCgkJCQkJdHlwZTogInByb2dyZXNzIiwKCQkJCX1dLCBbewoJCQkJCW5hbWU6ICdTYXZlJywKCQkJCQlvbmNsaWNrOiBhc3luYyBvID0+IHsKCQkJCQkJY29uc29sZS5jbGVhcigpOwoKCQkJCQkJdGhpcy5kRm9ybS5zZXQoewoJCQkJCQkJUHJvZ3Jlc3M6IDAKCQkJCQkJfSk7CgoJCQkJCQlsZXQgc2VydmVyID0gdGhpcy5fc2VydmVyKCk7CgoJCQkJCQlsZXQgdFRlbXBsYXRlID0gewoJCQkJCQkJaGVhZGVyUm93OiB0cnVlLAoJCQkJCQkJc3R5bGU6IHsKCQkJCQkJCQl0aGVtZTogJ1RhYmxlU3R5bGVEYXJrMycsCgkJCQkJCQkJc2hvd1Jvd1N0cmlwZXM6IHRydWUsCgkJCQkJCQl9LAoJCQkJCQl9OwoJCQkJCQlsZXQgdGFibGVzID0gW107CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgYyBvZiBfRnJFTUQuX19zY29wZShzZXJ2ZXIuU2NvcGUpLkVudGl0eUNsYXNzZXMuc29ydCgoYSwgYikgPT4gYS5SYW5rIC0gYi5SYW5rKSkgewoJCQkJCQkJLy9jb25zb2xlLmxvZygiRHluYUZvcm06OlNhdmVDb21wb25lbnQoKTogIiArIGMuTmFtZSArICIsIFJhbms9IiArIGMuUmFuayk7CgkJCQkJCQl0YWJsZXMucHVzaChPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodFRlbXBsYXRlKSksIGF3YWl0IHNlcnZlci5fbmV3KGMuTmFtZSkuX3RvVGFidWxhcigpKSk7CgkJCQkJCQl0aGlzLmRGb3JtLnNldCh7CgkJCQkJCQkJUHJvZ3Jlc3M6IHRoaXMuZEZvcm0uZ2V0KCkuUHJvZ3Jlc3MgKyAxMDAuMCAvIF9GckVNRC5fX3Njb3BlKHNlcnZlci5TY29wZSkuRW50aXR5Q2xhc3Nlcy5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9CgkJCQkJCXRhYmxlcy5mb3JFYWNoKHQgPT4gdC5yZWYgPSAnQTE6JyArIFN0cmluZy5mcm9tQ2hhckNvZGUoJ0EnLmNoYXJDb2RlQXQoMCkgKyB0LmNvbHVtbnMubGVuZ3RoIC0gMSkgKyAodC5yb3dzLmxlbmd0aCArIDEpKTsKCgkJCQkJCWxldCByZ2IgPSAobGV0dGVycyA9ICcwMTIzNDU2Nzg5QUJDREVGJykgPT4gQXJyYXkoNikubWFwKGkgPT4gbGV0dGVyc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxNildKS5qb2luKCcnKTsKCgkJCQkJCWNvbnN0IHdvcmtib29rID0gbmV3IEV4Y2VsSlMuV29ya2Jvb2soKTsKCQkJCQkJdGFibGVzLmZvckVhY2godCA9PiB3b3JrYm9vay5hZGRXb3Jrc2hlZXQodC5uYW1lLCB7CgkJCQkJCQlwcm9wZXJ0aWVzOiB7CgkJCQkJCQkJdGFiQ29sb3I6IHsKCQkJCQkJCQkJYXJnYjogJ0YnICsgcmdiKCkKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0pLmFkZFRhYmxlKHQpKTsKCgkJCQkJCWxldCBidWZmZXIgPSBhd2FpdCB3b3JrYm9vay54bHN4LndyaXRlQnVmZmVyKHsKCQkJCQkJCWRhdGVGb3JtYXQ6ICdZWVlZLU1NLUREIEhIOm1tOnNzJwoJCQkJCQl9KTsKCgkJCQkJCWNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CgkJCQkJCWxpbmsuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCQkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rKTsKCQkJCQkJbGluay5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbYnVmZmVyXSwgewoJCQkJCQkJdHlwZTogJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0O2NoYXJzZXQ9VVRGLTgnCgkJCQkJCX0pKTsKCQkJCQkJbGluay5kb3dubG9hZCA9IChvLlRpdGxlIHx8IHNlcnZlci5TY29wZSB8fCAiZGF0YSIpICsgIi54bHN4IjsKCQkJCQkJbGluay5jbGljaygpOwoJCQkJCX0KCQkJCX1dKQoJCQl9OwoJCX0KCX0KCglJbmRleENvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQlhc3luYyBtYWluKCkgewoJCQl0aGlzLl9jYW5WaWV3KCk7CgoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKCdmcm1JbmRleCcsICJNYWluIFBhZ2UiLCBbewoJCQkJCW5hbWU6ICdXZWxjb21lJywKCQkJCQlyZXF1aXJlZDogdHJ1ZSwKCQkJCQl0eXBlOiAibGFiZWwiLAoJCQkJCXZhbHVlOiB0aGlzLl9uYW1lKCksCgkJCQl9XSwgW10pCgkJCX07CgkJfQoJfQoKCUxvZ291dENvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQltYWluKCkgewoJCQl0aGlzLl9jYW5WaWV3KCk7CgoJCQlkZWxldGUgd2luZG93Lm1lOwoKCQkJdGhpcy5wYWdlLmRhdGEgPSB7CgkJCQlmb3JtOiB0aGlzLmRGb3JtLnJlbmRlcignZnJtTG9nb3V0JywgIkxvZ291dCIsIFt7CgkJCQkJCW5hbWU6ICJMb2dvdXQiLAoJCQkJCQl0eXBlOiAibGFiZWwiLAoJCQkJCQl2YWx1ZTogImxvZ291dCBpbiBwcm9ncmVzcy4uLiIKCQkJCQl9XSwKCQkJCQlbXSkKCQkJfTsKCgkJCV9GckVNRC5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiAibG9naW4iCgkJCX0pOwoJCX0KCX0KCglMb2dpbkNvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQlhc3luYyBfYXV0aGVudGljYXRlKG8pIHsKCQkJLy9pZiAoIXdpbmRvdy5iTG9jYWwgJiYgKCFfRnJFTUQuX19zY29wZSgpIHx8ICFfRnJFTUQuX19zY29wZSgpLkVudGl0eUNsYXNzZXMpKSByZXR1cm47CgoJCQlsZXQgYXV0aENsYXNzTmFtZSA9IF9GckVNRC5fX3Njb3BlKCk/LkVudGl0eUNsYXNzZXM/LmZpbmQoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICd1c2VybmFtZScpKT8uTmFtZTsKCQkJaWYgKF9GckVNRC5hcGlTZXJ2ZXIgJiYgYXV0aENsYXNzTmFtZSkgcmV0dXJuIGF3YWl0IF9GckVNRC5hcGlTZXJ2ZXIuX25ldyhhdXRoQ2xhc3NOYW1lKS51c2VybmFtZShvLlVzZXJuYW1lLCAnPScpLnBhc3N3b3JkKG8uUGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOwoKCQkJYXV0aENsYXNzTmFtZSA9IGF1dGhDbGFzc05hbWUgfHwgKHdpbmRvdy5iTG9jYWwgPyAoewoJCQkJY21zOiAiQXV0aG9yIiwKCQkJCWVtczogIkVtcGxveWVlIgoJCQl9KVtjb21wYW55LkNvZGVdIDogbnVsbCk7CgoJCQlvLk9QRVJBVE9SUyA9IHsKCQkJCVVzZXJuYW1lOiAiPSIsCgkJCQlQYXNzd29yZDogIj0iCgkJCX07CgoJCQlpZiAoYXV0aENsYXNzTmFtZSkgcmV0dXJuIChhd2FpdCBzci5fKCJlbXMiICsgYXV0aENsYXNzTmFtZSArICJGaW5kIiwgbnVsbCwgbykpOwoJCX0KCgkJYXN5bmMgX2xvZ2dlZEluKCkge30KCgkJYXN5bmMgX25vdExvZ2dlZEluKCkge30KCgkJYXN5bmMgbWFpbigpIHsKCQkJdGhpcy5wYWdlLmRhdGEgPSB7CgkJCQlmb3JtOiB0aGlzLmRGb3JtLnJlbmRlcignZnJtTG9naW4nLCAiVXNlciBBdXRoZW50aWNhdGlvbiIsIFt7CgkJCQkJCW5hbWU6ICdVc2VybmFtZScsCgkJCQkJCXJlcXVpcmVkOiB0cnVlLAoJCQkJCQl0eXBlOiAic3RyaW5nIgoJCQkJCX0sCgkJCQkJewoJCQkJCQluYW1lOiAnUGFzc3dvcmQnLAoJCQkJCQlyZXF1aXJlZDogdHJ1ZSwKCQkJCQkJdHlwZTogInBhc3N3b3JkIgoJCQkJCX0KCQkJCV0sIFt7CgkJCQkJbmFtZTogJ0xvZ2luJywKCQkJCQlhdXRvU3VibWl0OiB0cnVlLAoJCQkJCW9uY2xpY2s6IGFzeW5jIG8gPT4gewoJCQkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fYXV0aGVudGljYXRlKG8pOwoKCQkJCQkJaWYgKHJldCkgewoJCQkJCQkJdGhpcy5fbWUocmV0KTsKCgkJCQkJCQl0cnkgewoJCQkJCQkJCWF3YWl0IHRoaXMuX2xvZ2dlZEluKCk7CgkJCQkJCQl9IGNhdGNoIChleCkge30KCgkJCQkJCQlfRnJFTUQuc2V0VVJMKHsKCQkJCQkJCQlwYWdlOiBfRnJFTUQuaGFzaC5fcmVkaXJlY3QgfHwgImluZGV4IgoJCQkJCQkJfSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0cnkgewoJCQkJCQkJCWF3YWl0IHRoaXMuX25vdExvZ2dlZEluKCk7CgkJCQkJCQl9IGNhdGNoIChleCkge30KCgkJCQkJCQl0aGlzLmRGb3JtLmVycm9yKCJJbnZhbGlkIHVzZXJuYW1lIG9yIHBhc3N3b3JkIik7CgkJCQkJCX0KCgkJCQkJCXRoaXMuZEZvcm0uYnVzeShmYWxzZSk7CgkJCQkJfQoJCQkJfV0pCgkJCX07CgkJfQoJfQoKCU1ldGhvZENvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQlhc3luYyBtYWluKCkgewoJCQl0aGlzLl9jYW5WaWV3KCk7CgoJCQl0aGlzLnNNZXRob2QgPSB0aGlzLnBhZ2UuZGF0YTsKCQkJY29uc29sZS5jbGVhcigpOwoKCQkJbGV0IGVjID0gKF9GckVNRC5fX3Njb3BlKCkgfHwgdGhpcy5vU2NvcGUpLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSB0aGlzLnNNZXRob2Quc3BsaXQoJy4nKVswXSk7CgkJCWxldCBlbSA9IGVjLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSB0aGlzLnNNZXRob2Quc3BsaXQoJy4nKVsxXSk7CgoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKHRoaXMuc01ldGhvZCwgX0ZyRU1ELl90aXRsZUNhc2UoZWMuTmFtZSkgKyAnIDo6ICcgKyBfRnJFTUQuX3RpdGxlQ2FzZShlbS5OYW1lKSwgW3RoaXMuX2VudGl0eUZpZWxkKGVjKV0uY29uY2F0KC4uLmVtLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gdGhpcy5fZWFUb0ZpZWxkKHApKSksIFt7CgkJCQkJbmFtZTogJ1Jlc2V0JywKCQkJCQlvbmNsaWNrOiBvID0+IHsKCQkJCQkJdGhpcy5kRm9ybS5jbGVhcigpOwoJCQkJCX0sCgkJCQkJaWNvbjogImNhbmNlbCIKCQkJCX0sIHsKCQkJCQluYW1lOiAnUmVsb2FkJywKCQkJCQlvbmNsaWNrOiBvID0+IF9GckVNRC5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6ICdtZXRob2QnCgkJCQkJfSwgdGhpcy5wYWdlLmRhdGEpLAoJCQkJCWljb246ICJyZWxvYWQiCgkJCQl9LCB7CgkJCQkJbmFtZTogZW0uTmFtZSwKCQkJCQl0aXRsZTogX0ZyRU1ELl90aXRsZUNhc2UoZW0uTmFtZSksCgkJCQkJb25jbGljazogYXN5bmMgbyA9PiB7CgkJCQkJCWxldCBvYmogPSBvW2VjLk5hbWVdIHx8IF9GckVNRC5hcGlTZXJ2ZXIuX25ldyhlYy5OYW1lKTsKCQkJCQkJY29uc29sZS5sb2coIm9uY2xpY2soKSIsIGVjLk5hbWUsIG9iaiwgbywgb1tlYy5OYW1lXSk7CgkJCQkJCS8vaWYgKG9bdGhpcy5zVGFibGVdICYmIHR5cGVvZihvW3RoaXMuc1RhYmxlXS5fX3N5bmNfb24pID09PSAnZnVuY3Rpb24nICYmIG9bdGhpcy5zVGFibGVdLl9fc3luY19vbigpKSBvYmouSWQgPSBvW3RoaXMuc1RhYmxlXS5JZDsKCgkJCQkJCWF3YWl0IG9ialtlbS5OYW1lXSguLi5lbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IG9bcC5OYW1lXSkpOwoJCQkJCX0KCQkJCX1dKQoJCQl9OwoJCX0KCX0KCglTdG9yZUNvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQlhc3luYyBtYWluKCkgewoJCQl0aGlzLl9jYW5WaWV3KCk7CgoJCQl0aGlzLnNUYWJsZSA9IHRoaXMucGFnZS5kYXRhOwoJCQljb25zb2xlLmNsZWFyKCk7CgoJCQkvL2NvbnNvbGUubG9nKCJEeW5hRm9ybTo6U3RvcmVDb21wb25lbnQoKTogc1RhYmxlIiwgdGhpcy5zVGFibGUpOwoKCQkJbGV0IGVjID0gX0ZyRU1ELl9fc2NvcGUoKS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gdGhpcy5zVGFibGUpOwoKCQkJdGhpcy5wYWdlLmRhdGEgPSB7CgkJCQlmb3JtOiB0aGlzLmRGb3JtLnJlbmRlcihlYy5OYW1lLnJlcGxhY2UoL1wgL2csICdfJyksIF9GckVNRC5fdGl0bGVDYXNlKGVjLk5hbWUpLCBbT2JqZWN0LmFzc2lnbih0aGlzLl9lbnRpdHlGaWVsZChlYyksIHsKCQkJCQlzZWxlY3Q6IGFzeW5jIG8gPT4gewoJCQkJCQl0aGlzLmRGb3JtLmNsZWFyKCk7CgkJCQkJCXRoaXMuZEZvcm0uYnVzeSh0cnVlKTsKCgkJCQkJCWxldCByID0gYXdhaXQgby5maW5kKCk7CgkJCQkJCXRoaXMuZEZvcm0uc2V0KE9iamVjdC5hc3NpZ24oewoJCQkJCQkJW2VjLk5hbWUucmVwbGFjZSgvXCAvZywgJ18nKV06IHIKCQkJCQkJfSwgLi4uZWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkuZmlsdGVyKGVhID0+IHR5cGVvZihyW2VhLk5hbWVdKCkpICE9PSAndW5kZWZpbmVkJykubWFwKGVhID0+ICh7CgkJCQkJCQlbZWEuTmFtZV06IHJbZWEuTmFtZV0oKQoJCQkJCQl9KSkpKTsKCQkJCQkJdGhpcy5kRm9ybS5idXN5KGZhbHNlKTsKCQkJCQl9CgkJCQl9KV0uY29uY2F0KC4uLmVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiB0aGlzLl9lYVRvRmllbGQoZWEpKSksIFt7CgkJCQkJbmFtZTogJ1Jlc2V0JywKCQkJCQlvbmNsaWNrOiBvID0+IHsKCQkJCQkJdGhpcy5kRm9ybS5jbGVhcigpOwoJCQkJCX0sCgkJCQkJaWNvbjogImNhbmNlbCIKCQkJCX0sIHsKCQkJCQluYW1lOiAnUmVsb2FkJywKCQkJCQlvbmNsaWNrOiBvID0+IF9GckVNRC5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6ICdzdG9yZScKCQkJCQl9LCB0aGlzLnBhZ2UuZGF0YSksCgkJCQkJaWNvbjogInJlbG9hZCIKCQkJCX0sIHsKCQkJCQluYW1lOiAnU2F2ZScsCgkJCQkJb25jbGljazogYXN5bmMgbyA9PiB7CgkJCQkJCWxldCBvYmogPSBfRnJFTUQuYXBpU2VydmVyLl9uZXcodGhpcy5zVGFibGUpOwoJCQkJCQkvL2NvbnNvbGUubG9nKCJvbmNsaWNrKCkiLCB0aGlzLnNUYWJsZSwgb2JqLCBvLCBvW3RoaXMuc1RhYmxlXSk7CgkJCQkJCWlmIChvW3RoaXMuc1RhYmxlXSAmJiB0eXBlb2Yob1t0aGlzLnNUYWJsZV0uX19zeW5jX29uKSA9PT0gJ2Z1bmN0aW9uJyAmJiBvW3RoaXMuc1RhYmxlXS5fX3N5bmNfb24oKSkgb2JqLklkID0gb1t0aGlzLnNUYWJsZV0uSWQ7CgoJCQkJCQllYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5mb3JFYWNoKGVhID0+IG9ialtlYS5OYW1lXShvW2VhLk5hbWVdKSk7CgkJCQkJCS8vcmV0dXJuIGNvbnNvbGUubG9nKG9iai5fdG9GaWxlTmFtZSgpLCBvYmopOwoJCQkJCQlhd2FpdCBvYmouc3RvcmUoKTsKCQkJCQl9CgkJCQl9XSkKCQkJfTsKCQl9Cgl9CgkvKiogQ29tcG9uZW50czo6RW5kICoqLwp9Ow==",
	"Name": "DynaForm",
	"Script": "window.DynaForm = class {
	constructor() {
		this.title = "Form Title";
		this.name = "frmForm";
		this.elements = [];
		this.selects = [];
		this.grids = [];
		this.buttons = [];
		this.zones = ['north', 'south', 'east', 'west', 'center'];
		this.sTable = null;
		this.bDebug = false;
		this.uiTypes = {
			int: "numberspinner",
			menu: "splitbutton",
			datetime: "datetimebox",
			bool: "switchbutton",
			file: "filebox",
			text: "textbox",
			label: "html",
			password: "passwordbox",
			string: "textbox",
			image: "dialog",
			progress: "progressbar",
			link: "linkbutton",
			tree: "combotree",
			navigation: "tree",
			search: 'searchbox',
		};
		this.events = [{
			name: 'onClick',
			handler: 'onToggle',
			params: 'n=event',
			type: 'toggle',
		}, {
			name: 'onClose',
			handler: 'PanOnClose',
			params: 'n=event',
			type: 'window',
		}, {
			name: 'onSelect',
			handler: 'SelectChange',
			params: 'n',
			type: 'tabs',
		}, {
			name: 'searcher',
			handler: 'FieldChange',
			params: 'n, o',
			type: 'searchbox',
		}, {
			name: 'onBeforeExpand',
			handler: 'Expand',
			params: 'n',
			type: 'tree',
		}, {
			name: 'onChange',
			handler: 'FieldChange',
			params: 'n, o',
		}, {
			name: 'onBeforeOpen',
			handler: 'PanelOpen',
			params: '',
			type: 'window',
		}, {
			name: 'onOpen',
			handler: 'PendAfterOpen',
			params: '',
			type: 'window',
		}, {
			name: 'onClick',
			handler: 'doLink',
			params: 'n=event, o',
			type: 'link',
		}, {
			name: 'onClickRow',
			handler: 'FieldChange',
			params: 'n, o',
			type: 'grid',
		}];

		if (typeof($) !== 'undefined') $(window).resize(this.windowResized);
		this.windowResized();
	}

	sr() {
		return typeof(_FrEMD) !== 'undefined' ? _FrEMD.sr() : window.sr;
	}

	parse() {
		$.parser.parse();
	}

	windowResized() {
		this.width = window.innerWidth;
		this.height = window.innerHeight * 0.8;
	}

	init() {
		var select = {
			init: function(container, options) {
				var op = null;
				var fop = null;
				for (var i = 0; i < this.grids.length; i++)
					if (true || this.grids[i].id == options.source) op = this.grids[i].options;
				for (i = 0; i < op.columns.length; i++)
					if (op.columns[i].name == options.field) fop = op.columns[i];
				fop.width = (this.width / 3);
				var e = $(this.select(fop));
				var input = e.appendTo(container);
				input.combogrid();
				this.bind(input);
				return input;
			},
			destroy: function(target) {
				$(target).remove();
			},
			getValue: function(target) {
				return $(target).val();
			},
			setValue: function(target, value) {
				$(target).val(value);
			},
			resize: function(target, width) {
				$(target)._outerWidth(width);
			}
		};
		$.extend($.fn.datagrid.defaults.editors, {
			datetime: {
				init: function(container, options) {
					options.width = this.cWidth(options);
					var input = $(this.datetime(options)).appendTo(container);
					input.datetimebox();
					return input;
				},
				destroy: function(target) {
					$(target).remove();
				},
				getValue: function(target) {
					return $(target).val();
				},
				setValue: function(target, value) {
					$(target).val(value);
				},
				resize: function(target, width) {
					$(target)._outerWidth(width);
				}
			},
			checkbox: {
				init: function(container, options) {
					var input = $(this.bool(options)).appendTo(container);
					input.switchbutton();
					return input;
				},
				destroy: function(target) {
					$(target).remove();
				},
				getValue: function(target) {
					return $(target).val();
				},
				setValue: function(target, value) {
					$(target).val(value);
				},
				resize: function(target, width) {
					$(target)._outerWidth(width);
				}
			},
			combotreegrid: select,
			select: select,
		});
	}

	ask(question, fAnswer = v => v, options) {
		$.messager.confirm(this.title, question, function(r) {
			if (options) {
				for (var i = 0; i < options.length; i++) {
					if (options[i].answer == r) {
						return fAnswer(options[i].value);
					}
				}
			} else {
				return fAnswer(r);
			}
		});
	}

	topData(ar, gField, vField, top) {
		if (!top) {
			return ar;
		}
		ret = [];
		$.each(this.sr().groupBy(ar, gField), function(key, values) {
			values.values.sort((a, b) => {
				if (parseFloat(a[vField]) < parseFloat(b[vField])) {
					return 1;
				} else if (parseFloat(a[vField]) > parseFloat(b[vField])) {
					return -1;
				} else {
					return 0;
				}
			});
			$.each(values.values, function(i, v) {
				if (i < top) {
					ret.push(v);
				}
			});
		});
		return ret;
	}

	async doClick(button) {
		let _this = typeof(this.doClick) === 'function' ? this : window.DForm;
		button = _this.buttons.find(b => b.name == button.name && b.group == button.group);
		_this.busy(true);
		_this.set({
			WorkProgressValue: 20
		})

		var o = _this.get();
		var sMissing = _this.elements.filter(e => (button.window ? button.group == e.group : true)).filter(e => e.required && !o[e.name]).map(e => "<li>" + (e.label || e.name) + "</li>").join("");
		if (sMissing) {
			window._FrEMD._error("Missing mandatory fields:<br/><ul>" + sMissing + "</ul>", 5000);
			_this.busy(false);
			return;
		}
		if (button.onclick) await button.onclick(o);
		if (button.onClick) await button.onClick(o);
		_this.busy(false);
	}

	busy(bBusy) {
		if (!bBusy) {
			var total = 0;
			if (typeof moment !== 'undefined') {
				total = moment().diff(moment(this.busyStamp), 'seconds');
			} else {
				// no moment, use standard Date
				total = (new Date().getTime() - this.busyStamp ? this.busyStamp.getTime() : 0) / 1000 / 3600;
			}
			if (this.bDebug) {
				window._FrEMD._alert("Execution Time: " + total + " seconds.");
			}
			delete this.busyStamp;

			setInterval(1, () => this.Set({
				Loading: 10
			}));
		} else {
			this.busyStamp = new Date();
		}

		$.each($.merge($.map(this.buttons, b => b.name), $.map(this.elements.filter(e => e.type == 'link'), e => e.name)), (_, e) => $('#' + e).linkbutton(bBusy ? 'disable' : 'enable'));
	}

	prefix(e) {
		switch (e.type) {
			case 'label':
				return 'lbl';
			case 'text':
			case 'string':
			case 'search':
			case 'password':
				return 'txt';
			case "DateTime":
			case "datetime":
				return 'dtp';
			case "int":
			case "integer":
			case "number":
			case "long":
			case "Long":
				return 'nud';
			case 'file':
				return 'fil';
			case 'image':
				return 'img';
			case "bool":
				return 'chk';
			case "window":
				return 'pnl';
			case "progress":
				return 'prg';
			case "grid":
			case "tree":
			case "select":
				return 'cmb';
			default:
				return '';
		}
	}

	clear(group) {
		var o = {};
		$.each(this.elements.filter(e => group ? e.group == group : true), (_, e) => {
			var name = (e.emsSource ? "_" : "") + e.name;
			switch (e.type) {
				case 'text':
				case 'string':
				case 'search':
				case 'password':
				case "DateTime":
				case "datetime":
					o[name] = "";
					break;
				case "int":
				case "number":
				case "integer":
				case "long":
				case "Long":
				case "progress":
					o[name] = 0;
					break;
				case "tree":
				case "select":
					o[name] = null;
					break;
				case "grid":
					o[name] ? o[name].data = [] : null;
					break;
				case "bool":
					o[name] = false;
					break;
				default:
					break;
			}
		});
		//console.log("clear", o);
		this.set(o);
		this.busy(false);
	}

	set(o, eName) {
		if (eName) {
			var oElement = this.byName(eName);
			if (!oElement) return;
			var att = null;
			if (o && o.Id && o.EntityAttribute) {
				// an EntityValue
				for (var p in o)
					if (p.endsWith("Value")) att = p;
				oElement.emsSource = o;
			}
			try {
				let eName = "#" + this.prefix(oElement) + oElement.name;
				let eType = this.uiTypes[oElement.type];
				// console.log("DynaForm::set(" + oElement.name + "): ", eName, eType, o);
				switch (oElement.type) {
					case 'label':
						if (att) {
							$(eName).html(o[att]);
						} else {
							$(eName).html((o && o.EntityAttribute) ? "" : o);
						}
						break;
					case 'text':
					case 'string':
					case 'password':
					case "int":
					case "search":
					case "integer":
					case "number":
					case "long":
					case "Long":
						if (att) {
							$(eName)[eType]("setValue", o[att]);
						} else {
							$(eName)[eType]("setValue", (o && o.EntityAttribute) ? "" : o);
						}
						break;
					case "DateTime":
					case "datetime":
						if (att) {
							$(eName)[eType]('setValue', (o[att] ? this.sr().toDateTime(o[att]) : ""));
						} else {
							$(eName)[eType]('setValue', (o && o.EntityAttribute) ? "" : (o ? this.sr().toDateTime(o) : ""));
						}
						break;
					case "bool":
						if (att) {
							$(eName)[eType]((o[att] ? '' : 'un') + 'check');
						} else {
							$(eName)[eType]((((o && o.EntityAttribute) ? "" : o) ? '' : 'un') + 'check');
						}
						break;
					case "window":
						if (att) {
							oElement.value = o[att];
						} else {
							oElement.value = (o && o.EntityAttribute) ? "" : o;
						}
						break;
					case "progress":
						var v = 0;
						if (att) {
							v = o[att];
						} else {
							v = (o && o.EntityAttribute) ? "" : o;
						}
						//console.log("#" + this.prefix(oElement) + oElement.name, this.uiTypes[oElement.type], Math.round(v * 10) / 10);
						$(eName)[eType]('setValue', Math.round(v * 10) / 10);
						break;
					case "grid":
						let cols = JSON.parse("{" + this.mapColumns(oElement, true) + "}");
						$.each(cols.columns[0], (_, c) => c.formatter = this.sr().runScript(this.formatter(oElement.name, c)));
						$(eName).datagrid(cols);
						if (att) {
							$(eName).datagrid({
								data: o[att]
							});
						} else {
							$(eName).datagrid({
								data: (o && o.EntityAttribute) ? "" : o
							});
						}
						$(eName).datagrid("unselectAll");
						$(eName).datagrid();
						break;
					case "tree":
						var v = att ? o[att] : ((o && o.EntityAttribute) ? "" : o);
						if (Array.isArray(v)) {
							$(eName)[eType]("tree").tree("loadData", v);
						} else {
							$(eName)[eType]('setValue', v);
						}
						break;
					case "select":
						if (att) {
							if (oElement.options) {
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
							} else {
								$(eName).combogrid('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
							}
						} else {
							v = null;
							if (o === null) {

							} else if (o.constructor === Array) {

							} else if (!o.EntityAttribute) {
								v = o || {
									Id: o.Id,
									_ToString: o._ToString,
									toString: function() {
										return this._ToString;
									}
								};
							}
							if (oElement.options) {
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), v);
								$(eName).combo('setText' + (oElement.multiple ? 's' : ''), v);
							} else {
								$(eName).combogrid('setValue' + (oElement.multiple ? 's' : ''), v);
							}
						}
						break;
					default:
						break;
				}
			} catch (ex) {
				console.log(ex);
			}
		} else {
			for (var p in o) {
				if (p.indexOf('_') === 0) p = p.substring(1);
				var e = this.byName(p);
				if (!e || !e.name) continue;
				var value = o[p];
				if (e.name == this.sTable) {
					value = o;
					value.Date = new Date();
				}
				if (p == "EntityValues") {
					// an emsFormValues source
					// find the EntityValue for this element and set it
					for (var j = 0; j < o.EntityValues.length; j++) {
						if (o.EntityValues[j].EntityAttribute.Name == e.name) {
							// found the EntityValue for this element
							_v = o.EntityValues[j];
							for (var q in _v) {
								if (q.endsWith("Value")) {
									_v[q] = value;
								}
							}
							break;
						}
					}
				}
				this.set(value, e.name);
			}
		}
	}

	get() {
		var o = {};
		if (this.sTable && window[this.sTable]) o = new window[this.sTable]();
		for (var i = 0; i < this.elements.length; i++) {
			var cn = null;
			var v = null;
			try {
				let eName = "#" + this.prefix(this.elements[i]) + this.elements[i].name;
				switch (this.elements[i].type) {
					case 'label':
						cn = $(eName);
						v = cn.html();
						break;
					case 'text':
					case 'string':
					case 'search':
					case 'password':
						cn = $(eName);
						v = cn.val();
						break;
					case "file":
					case "image":
						cn = $(eName);
						v = this.elements[i].data;
						break;
					case "DateTime":
					case "datetime":
						v = new Date($(eName).datetimebox('getValue'));
						cn = $(eName);
						break;
					case "progress":
						cn = $(eName);
						v = cn.progressbar('getValue');
						break;
					case "int":
					case "integer":
					case "number":
					case "long":
					case "Long":
						cn = $(eName);
						v = parseFloat(cn.val());
						if (isNaN(v)) v = 0;
						break;
					case "grid":
						cn = $(eName);
						v = cn.datagrid('getData');
						v.selected = cn.datagrid("getSelected");
						break;
					case "tree":
						cn = $(eName);
						v = cn.combotree("tree").tree("getSelected");
						break;
					case "window":
						v = this.elements[i].value;
						break;
					case "select":
						if (this.elements[i].options) {
							v = $(eName).combogrid('getValue' + (this.elements[i].multiple ? 's' : ''));
							v = this.sr().runScript(v);
						} else {
							v = $(eName).combogrid('grid').datagrid('getSelections');
							if (!v || !v.length) {
								v = $(eName).combogrid('getValue' + (this.elements[i].multiple ? 's' : ''));
							} else {
								if (!this.elements[i].multiple) v = v[0];
							}
						}
						cn = $(eName);
						break;
					case "bool":
						cn = $(eName);
						v = cn.switchbutton('options').checked;
						break;
					default:
						break;
				}
				o[this.elements[i].name](v);
			} catch (e) {
				//console.log(this.elements[i].name, e);
				o[this.elements[i].name] = v;
			}
			if (cn) {
				if (o.EntityValues) {
					for (var j = 0; j < o.EntityValues.length; j++) {
						if (this.elements[i].name == this.sTable && this.elements[i].emsSource) o.Id = this.elements[i].emsSource.Id;
						if (o.EntityValues[j].EntityAttribute.Name == this.elements[i].name && this.elements[i].emsSource) {
							o.EntityValues[j].Id = this.elements[i].emsSource.Id;
						}
					}
				}
			}
		}
		return o;
	}

	cHeight(options) {
		if (options && options.editor) return window.innerHeight;
		if (options && options.height && typeof(options.height) === 'string') return this.height;
		if (options && options.type == 'window' && !options.height) return this.height * 0.9;
		return Math.floor(((options ? options.height : null) || (this.height / 3)));
	}

	search(options) {
		return this.string(options);
	}

	string(options) {
		options.height = 20;
		options.simple = true;
		return this.text(options);
	}

	datetime(options) {
		return `<input id="dtp${options.name}" class="easyui-${this.uiTypes[options.type]}" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" style="width:${this.cWidth(options)}px">`;
	}

	query(options) {
		return "<div id='vs" + options.name + "'></div>";
	}

	DateTime(options) {
		return this.datetime(options);
	}

	long(options) {
		return this.int(options);
	}

	Long(options) {
		return this.long(options);
	}

	value(options) {
		if (typeof options.value === 'function') {
			try {
				return options.value(this.get());
			} catch (ex) {
				console.log(`DForm.value(${options.name}): ${ex}`);
				return '';
			}
		} else {
			switch (options.type) {
				case 'int':
				case 'progress':
					return options.value || options.min || 0;
				case 'string':
				case 'text':
				case 'datetime':
				case 'label':
					return options.value || "";
				default:
					return options.value;
			}
		}
	}

	int(options) {
		let ret = `<input id="nud${options.name}" class="easyui-${this.uiTypes[options.type]}" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" data-options="min:${options.min || 0},max:${options.max || 100},increment:${options.increment || 1}" style="width:${this.cWidth(options)}px;"></input>`;
		//console.log(ret);
		return ret;
	}

	menu(options) {
		options.type = options.type || 'menu';

		options.menu = (options.menu || []).sort((a, b) => a.order - b.order);

		//console.log("DynaForm::menu(): options", options);

		let ret = "";
		ret += '<div class="easyui-panel" id="mnu' + options.name + '" style="padding:5px;">\n';

		ret += options.menu.map(m => `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options="menu:'#mm${m.label.replace(/ /g, '')}',iconCls:'icon-${m.icon || 'none'}'">${m.label}</a>`).join('\n');

		/*$.each(options.menu, (_, m) => ret += `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options="menu:'#mm${m.label.replace(/ /g, '')}',iconCls:'icon-${m.icon || 'none'}'">${m.label}</a>\n`);*/
		ret += "</div>\n";

		let dv = m => {
			let ret = '<div' + (m.subMenus ? '' : ` data-options="iconCls:'icon-${m.icon || 'none'}'"`) + '>\n';
			ret += m.subMenus ? '<span>' + (m.label || this.english(m.code)) + '</span>\n<div>' : (`<span width='100%' onclick='(async () => {let m = ${_FrEMD._toJS(m)}; if(m.action){return await m.action(DForm.get(), m);} if (m.subMenus) return; await _FrEMD.RenderPage({_code: m.code || m.label.replace(/ /g, "").toLowerCase()}, m.data);})()'>${m.label || this.english(m.code)}</span>`);
			$.each(m.subMenus, (_, s) => ret += dv(s));
			ret += (m.subMenus ? "</div>\n" : "") + `</div>\n`;
			return ret;
		};

		ret += options.menu.map(m => `<div id="mm${m.label.replace(/ /g, '')}" style="width:150px;">${m.subMenus.map(sm => dv(sm)).join('')}</div>`).join('\n');

		return ret;
	}

	integer(options) {
		return this.int(options);
	}

	number(options) {
		return this.int(options);
	}

	Integer(options) {
		return this.int(options);
	}

	bool(options) {
		return `<input id="${this.prefix(options)}${options.name}" data-dform="element:${options.name}" required="${options.required?'true':'false'}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}' class="easyui-${this.uiTypes[options.type]}" ${options.checked?'checked':''} />`;
	}

	label(options) {
		return `<span id="${this.prefix(options)}${options.name}" style="width:${this.cWidth(options)}px" data-options="disabled:${options.disabled?'true':'false'}">${this.value(options)}</span>`;
	}

	url(options) {
		return this.string(options).replace("FieldChange", "URLChange");
	}

	text(options) {
		return `<input id="${this.prefix(options)}${options.name}" class="easyui-${options.editor || this.uiTypes[options.type]}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}' multiline="${options.simple ? 'false' : 'true'}" style="white-space:pre-wrap;width:${this.cWidth(options)}px;height:${this.cHeight(options)}px" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" />`;
	}

	password(options) {
		var ret = this.string(options);
		ret = ret.replace('<input ', '<input type="password" ');
		return ret;
	}

	file(options) {
		return `<input id="${this.prefix(options)}${options.name}" class="easyui-${this.uiTypes[options.type]}" data-options="onChange:function(n,o){var s = $('#' + this.id).filebox('options'); DForm.UploadFile(s, DForm.byName('${options.name}'));}" style="width:${this.cWidth(options)}px">`;
	}

	image(options) {
		return this.file(options) + `<div id="dlg${options.name}" class="easyui-${this.uiTypes[options.type]}" title="Image Preview" data-options="closed:true,iconCls:'icon-save',resizable:false,modal:true" style="width:400px;height:200px;padding:10px"><img id="${this.prefix(options)}${options.name}" width="100%" height="100%"/></div>`;
	}

	progress(options) {
		if (!options.height) options.height = 20; // fix big progress
		return `<div id="${this.prefix(options)}${options.name}" class="easyui-${this.uiTypes[options.type]}" data-options="value:${this.value(options)}" style="width:${this.cWidth(options)}px;height:${this.cHeight(options)}px"></div>`;
	}

	flowchart(options) {
		return `<div id="flw${options.name}" width="${this.cWidth(options)}" height="${this.cHeight(options)}"></div>`;
	}

	chart(options) {
		return `<div id="cht${options.name}" width="${this.cWidth(options)}" height="${this.cHeight(options)}"></div>`;
	}

	formatter(name, c, json) {
		json = json ? '"' : '';
		return `${json}(value, row, index) => {try{var c = (DForm.byName(\`${name}\`).columns || []).find(c => c.field==\`${c.field}\`); return c&&c.format?c.format(value,row,index):value;}catch(ex){return value;} }${json}`;
	}

	mapColumns(options, json) {
		let cTitle = c => c.title || this.english(c.field);

		var cols = $.grep(options.columns || [], c => !c.ignore);
		let ret = "";
		if (options.multiple) ret += `{"field":'ck',"checkbox":true},`;
		ret = `"frozenColumns": [[`;
		if (!options.frozen) {
			ret += `{"field":"${options.idField.field}","title": "${options.idField.title}","sortable": "true", "formatter": ${this.formatter(options.name, options.idField, json)}},`;
			if (options.textField.field != options.idField.field) ret += `{"field":"${options.textField.field || options.textField.title}","title":"${options.textField.title || options.textField.field}","width":"${options.textField.width||120}", "sortable": "true", "formatter": ${this.formatter(options.name, options.textField, json)}}`;
		} else {
			$.map($.grep(cols, c => c.frozen), c => `{"field":"${c.field || cTitle(c)}","title":"${cTitle(c) || c.field}","width":"${c.width||120}","align":'left',"sortable":"true", "formatter": ${this.formatter(options.name, c, json)}}`).join(",");
		}
		ret += `]], "columns": [[`;
		ret += $.map($.grep(cols, c => !c.frozen), c => `{"field":"${c.field || cTitle(c)}","title":"${cTitle(c) || c.field}","align":"left","sortable":"true", "formatter": ${this.formatter(options.name, c, json)}}`).join(",");
		ret += ']]';

		//console.log("DynaForm::mapColumns(" + options.name + "): ", ret, json);
		return ret;
	}

	select(options, tag = options.tag, type) {
		return this.combo(options, tag, type);
	}

	tree(options) {
		return this.select(options, "select");
	}

	navigation(options) {
		return this.combo(options, 'ul', 'tree');
	}

	combo(options, tag, type) {
		var cols = $.grep(options.columns || [], c => !c.ignore);
		tag = tag || "select";

		options.idField = $.uniqueSort([{
			field: options.idField,
			title: options.idField
		}].concat($.grep(cols, c => c.primary), [{
			field: 'Id',
			title: 'ID'
		}])).find(x => typeof(x.field) !== "undefined");

		options.textField = $.uniqueSort([{
			field: options.textField,
			title: options.textField
		}].concat($.grep(cols, c => c.display), [{
			field: '_ToString',
			title: options.name,
		}])).find(x => typeof(x.field) !== "undefined");

		//console.log("DynaForm::combo(): options", options);

		var fun = type || this.eFun(options);

		var dropdown = ['combotreegrid', 'combotree', 'combogrid', 'select'].indexOf(fun) > -1;
		if (dropdown) this.selects.push({
			id: "cmb" + options.name,
			options: this.byName(options.name)
		});
		this.selects = $.uniqueSort(this.selects);
		var ret = `<${tag} id="cmb${options.name}" class="easyui-${fun}" style="max-width:${dropdown?'400px':this.cWidth(options)}; width:${this.cWidth(options)}px" required="${(options.required ? 'true' : 'false')}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}, value:"${this.value(options)}", rownumbers:${typeof(options.rowNumbers)!=='undefined'?options.rowNumbers:(fun.indexOf('tree')<-1?'false':'true')}, pagination:${typeof(options.pagination)!=='undefined'?options.pagination:(fun.indexOf('tree')<-1?'false':'true')}, panelWidth:${2*this.cWidth(options)}, fitColumns: true, singleSelect: true, multiple:${(options.multiple || 'false')}, idField: "${options.idField.field}", enableFilter: ${options.filter?'true':'false'}, nowrap: false, textField: "${options.textField.field}", treeField: "${options.textField.field}",`;
		if (fun.indexOf('tree') == -1) {
			ret += 'fitColumns: false,' + this.mapColumns(options);
		}
		if (options.data) {
			ret += `,data: ${JSON.stringify(options.data)}`;
		}
		ret += `'>`;
		if (options.options) {
			ret += $.map(options.options, o => `<option value='${_FrEMD._toJS(o)}'>${o.name || o}</option>`).join('\n');
		}
		ret += `</${tag}>`;
		// console.log(ret);
		return ret;
	}

	grid(options, tag, type) {
		return this.combo(options, "table", "datagrid");
	}

	treegrid(options) {
		return this.combo(options, 'table', 'tree');
	}

	async doLink(e, event) {
		this.busy(true);
		try {
			await e.links.find(l => l.label == event.target.innerText).onClick(this.get());
		} catch (ex) {
			console.log("DynaForm::doLink(): Exception: " + ex);
		}
		this.busy(false);
	}

	EditedValue(e) {
		return (typeof(ace) !== "undefined") ? ace.edit('pnl' + e.name).session.getValue() : '';
	}

	async PanOnClose(e) {
		if (e.editor) {
			e.value = this.EditedValue(e);
		}
		if (e.close) {
			await e.close(this.get());
		}
	}

	async PendAfterOpen(e) {
		if (e.editor && typeof(ace) !== "undefined") {
			await _FrEMD.OpenEditor('pnl' + e.name /*+ '-center'*/ , e.language, e.loader || (o => e.value), e.saver, this.get(), e);
		}
		if (e.open) {
			await e.open(this.get());
		}
	}

	link(options) {
		return (options.links || []).filter(l => !l.ignore).map(l => `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options='${this.eventHandlers(options)}, iconCls:"icon-${l.icon || 'ok'}"'>${l.label}</a>`).join('\n');
	}

	async SetTreeData(e, n, data) {
		$.each($("#cmb" + e.name)[this.eFun(e)]('tree').tree("getChildren", n.target), (_, c) => $("#cmb" + e.name)[this.eFun(e)]('tree').tree("remove", c.target));
		$("#cmb" + e.name)[this.eFun(e)]('tree').tree("append", {
			parent: n.target,
			data: data
		});
		return true;
	}

	async Expand(e, n) {
		this.SetTreeData(e, n, [{
			id: null,
			text: "loading..."
		}]);
		var obj = {};
		var pField = e.parentField || $.map($.grep(e.columns || [], c => c.parent), c => c.field).concat([null])[0];
		var idField = $.grep(e.columns || [], c => c.primary).concat(e.idField)[0].field;
		if (pField) {
			obj[pField] = {
				_source: n._source
			};
			if (idField) {
				obj[pField][idField] = n.id;
			} else {
				obj[pField] = n.id;
			}
		}
		let data = await this._loadData({
			id: "cmb" + e.name,
			options: e
		}, obj);
		this.SetTreeData(e, n, data);
	}

	async _loadData(s, o, start, end) {
		var name = (s && s.options ? (s.options.Class ? s.options.Class.Name.replace(' ', '_') : (s.options.table || s.options.name)) : s.name);
		name = name.trim(); //.split('.').slice(-1)[0];

		let oScope = (typeof(company) !== 'undefined' && company.Scope) ? window[company.Scope] : window;
		//console.log("DynaForm::_loadData(): oScope", oScope);

		o = o || ((oScope && oScope[name]) ? new oScope[name]() : {
			Active: true,
		});

		o = (typeof filters !== "undefined" && filters && filters[name]) ? filters[name](o) : o;
		var fun = this.eFun(s.options);
		let sText = $("#" + s.id)[fun]('getText');

		o = (s && s.options && s.options.source) ? s.options.source(o, this.get(), sText) : o;
		let names = $.uniqueSort([s.options.searchField].concat($.map($.grep(s.options.columns || [], c => c.search), c => c.field), ["Name"])).filter(v => v);
		if (!o[names[0]]) o[names[0]] = sText;
		//console.log("DynaForm::_loadData(): o", o);
		var data = null;

		let lib = '';
		if (name.indexOf('.') > 0) {
			lib = name.split('.')[0] + '.';
			name = name.split('.')[1];
		}

		if (s.options.loader) {
			data = await s.options.loader(this.get(), s.options, o, sText);
		} else if (o && typeof(o.findAll) === 'function') {
			data = await o.findAll();
		} else if (typeof(company) !== 'undefined' && company.library && company.Code && window.bLocal) {
			//console.log("DForm::_loadData(): sr()._(" + lib + company.Code.toLowerCase() + name + "Findall" + ")", o);
			data = await this.sr()._(lib + company.Code.toLowerCase() + name + "Findall", null, o, null, start, end);
		} else if (_FrEMD.apiServer) {
			o = Object.assign(...Object.keys(o).map(k => ({
				[String(k).charAt(0).toLowerCase() + String(k).slice(1)]: o[k]
			})));
			//console.log("DForm::_loadData(): using _FrEMD.apiServer: o", o);
			data = await _FrEMD.apiServer._new(name)._fromDocument(o).findAll();
			//data.filter(d => d.Id != d.Id).forEach(d => d.Id = d._uuid(null, null, true));
		}

		if (s.options.postload) {
			await s.options.postload(data);
		}
		$.each(data, (i, d) => {
			d.__OWNER = s;
			$.each(s.options.columns, (_, c) => {
				if (c.value) {
					d[c.field] = c.value(d, data, i);
				}
			});
		});
		if (!s.options.columns && fun.indexOf('tree') > -1) {
			data = $.map(data, d => {
				let ret = {
					id: d[s.options.idField.field],
					text: d[s.options.textField.field],
					state: d.state || (s.options.loader ? "file" : "closed"),
					_source: d,
				};
				ret.children = (ret.state == "closed") ? [{
					text: 'loading...'
				}] : null;
				return ret;
			});
		}
		return data || [];
	}

	async fillData(g, o, start, end) {
		var s = null;
		for (var i = 0; i < this.selects.length; i++) {
			if (this.selects[i].id == g[0].id) s = this.selects[i];
		}
		if (!s) return;
		this.busy(true);
		try {
			var fun = g[0].classList["0"].replace('easyui-', '');
			try {
				$("#" + s.id)[fun]('grid').datagrid('getPager').pagination('loading');
			} catch (ex) {}
			if (s.options.noload) {
				let _data = null;
				try {
					_data = $("#" + s.id)[fun]('grid').datagrid("getData");
				} catch (ex) {
					_data = $("#" + s.id)[fun]('tree').tree('getRoot');
				}
				if (_data) {
					return this.busy(false);
				}
			}
			var data = await this._loadData(s, o, start, end);
			try {
				if ($("#" + s.id)[fun]('grid')) $("#" + s.id)[fun]('grid').datagrid('getPager').pagination('loaded');
			} catch (ex) {}
			try {
				$("#" + s.id)[fun]('grid').datagrid('loadData', {
					total: data.Count || data.length,
					rows: data,
				});
			} catch (ex) {
				$("#" + s.id)[fun]('tree').tree('loadData', data);
			}
		} catch (ex) {
			console.log(ex);
		}
		this.busy(false);
	}

	eventHandlers(options) {
		//console.log("DynaForm::eventHandlers(): options", options);
		if (!this.byName(options.name)) return; // if not an element, do not run the handlers

		return this.events.filter(e => e.type == options.type || typeof(e.type) === 'undefined').map(e => `${e.name}: (${e.params || ''}) => {try{DForm.${e.handler}(DForm.byName("${options.name}") || ${_FrEMD._toJS(options)} || {name: "${options.name}",type: "${options.type}"}, ${e.params})}catch(ex){console.log("Event Error: ${options.name}/${options.type}/${e.name}", ex);}}`).join(',');
	}

	async PanelOpen(e) {
		if (e.editor) return true;
		let content = e.value;
		if (e.loader) {
			content = await e.loader(this.get());
		}
		if (content) {
			try {
				$("#pnl" + e.name).panel('body').html(content);
				console.log("pnl" + e.name + ": Content Valid");
			} catch (ex) {
				//console.log(ex);
			}
		}
		return content;
	}

	async SelectChange(options, tab) {
		this.busy(true);
		$.grep(this.elements, e => e.type == "grid" && e.group == tab).forEach(e => $("#cmb" + e.name).datagrid());
		this.busy(false);
	}

	async FieldChange(options, value) {
		this.busy(true);
		if (options && options.change) {
			await options.change(this.get(), value);
		}
		this.busy(false);
	}

	async URLChange(s, options) {
		options.data = await $.get(s.value);
		return await this.FieldChange(s, options);
	}

	async UploadFile(f, options) {
		this.busy(true);
		var formData = new FormData();
		var fileid = Math.random();
		var method = options.method || "ContentManager.cmsUploadFile";
		formData.append('fileid', fileid);
		var file = $("#" + f.fileboxId)[0].files[0];
		formData.append('__UFILE', file);
		if (options.local) {
			// handling the file locally
			var reader = new FileReader();
			reader.onload = async (e) => {
				var data = e.target.result;
				DForm.byName(options.name).data = data;
				if (options && options.upload) await options.upload(this.get(), data);

				if (options && options.xml && typeof(fastXML) !== 'undefined') {
					await options.xml(this.get(), new fastXML.XMLParser({
						ignoreAttributes: false
					}).parse(data));
				} else if (options && options.excel && typeof(ExcelJS) !== 'undefined') {
					// data is an excel binary file
					const wb = new ExcelJS.Workbook();
					let workbook = await wb.xlsx.load(data);
					let arData = {};
					workbook.eachSheet((sheet, id) => {
						let columns = [];
						for (var i = 0; sheet.getCell(String.fromCharCode('A'.charCodeAt(0) + i) + '1').value; i++) columns.push(sheet.getCell(String.fromCharCode('A'.charCodeAt(0) + i) + '1').value);

						let rData = [];
						for (var j = 2; sheet.getCell("A" + j).value; j++) {
							rData.push(Object.assign(...columns.map((c, i) => ({
								[c]: sheet.getCell(String.fromCharCode('A'.charCodeAt(0) + i) + j).value
							}))));
						}

						arData[sheet.name] = rData;
					});
					await options.excel(this.get(), arData);
				}

				this.busy(false);
			};
			if (options.binary) {
				reader.readAsBinaryString(file);
			} else if (options.dataurl) {
				reader.readAsDataURL(file);
			} else {
				reader.readAsText(file);
			}
		} else if (method) {
			$.ajax({
				url: this.sr().srURL + "&method=" + method + "&sInput=" + fileid + "&preTag=&postTag=",
				data: formData,
				// THIS MUST BE DONE FOR FILE UPLOADING
				cache: false,
				contentType: false,
				type: 'POST',
				processData: false,
				success: data => {
					this.sr().runScript(data);
					this.byName(options.name).data = ret;
					if (options && options.upload) options.upload(this.get(), ret);
					this.busy(false);
				}
			});
		}
	}

	eFun(e) {
		try {
			if (e.type == "tree") {
				if (e.columns) {
					return "combotreegrid";
				} else if (typeof(e.combo) !== 'undefined' && !e.combo) {
					return 'tree';
				} else {
					return "combotree";
				}
			} else if (e.type == 'navigation') {
				return 'tree';
			} else if (e.type == "combotree") {
				return "combotreegrid";
			} else if (e.type == "select" && e.options) {
				return "combobox";
			}
			return "combogrid";
		} catch (ex) {
			return "combogrid";
		}
	}

	_fillWindow(winName, v, map) {
		v = v || {};
		map = map || {};
		if (Array.isArray(map)) {
			map = Object.fromEntries(new Map(map));
		}

		map = $.extend({}, map, Object.fromEntries(Object.keys(v).map(k => [winName + k, k])));

		let s = {};
		for (var m in map) {
			if (typeof(v[map[m]]) === "undefined") {
				//console.log('is_undefined', m, map[m], v[map[m]]);
				s[m] = map[m];
			} else {
				//console.log('is_not_undefined', m, map[m], v[map[m]]);
				s[m] = v[map[m]];
			}
		}
		this.clear(winName);
		//console.log("s", s);
		this.set(s);
		$("#pnl_" + winName).window("open");
	}

	windowToEntity(o, bEmpty, grid, prefix, filter) {
		o = o || this.get();
		filter = filter || (v => v);
		let ret = grid ? (grid.selected || grid) : null;
		if (bEmpty) {
			ret = {};
			o = {};
		} else {
			ret = (ret && ret.Id) ? {
				Id: ret.Id
			} : {};
		}

		this.elements.filter(e => (prefix ? e.group == prefix : true) && e.type != 'link' && ['_'].indexOf(e.name.replace(prefix, "")) < 0).forEach(e => {
			ret[e.name.replace(prefix, "")] = o[e.name];
			return true;
		});

		filter(ret);

		return ret;
	}

	bind(obj) {
		var objBind = (o, e) => {
			o[this.eFun(e)]({
				onShowPanel: () => {
					this.fillData($("#" + e.id), null, 0, 10);
				},
				onClickRow: (index, row) => {
					var s = row ? row.__OWNER : null;
					// console.log("onClickRow(): ", index, row, s);
					if (s && s.options.select) {
						s.options.select(row, this.get());
					}
				}
			});
			try {
				var dg = o[this.eFun(e)]('grid');
				// dg.datagrid('enableFilter')
				var state = dg.data('datagrid');
				var opts = state.options;
				var onBeforeLoad = opts.onBeforeLoad;
				opts.onBeforeLoad = (param) => {
					state.allRows = null;
					return onBeforeLoad.call(this, param);
				};
				var pager = dg.datagrid('getPager');
				dg.datagrid('getPanel').panel({
					ID: i
				});
				pager.pagination({
					onSelectPage: function(pageNum, pageSize) {
						try {
							DForm.fillData($("#" + DForm.selects[$(this.parentNode).panel('options').ID].id), null, pageSize * (pageNum - 1), pageSize * pageNum);
						} catch (_ex) {
							console.log("DynaForm::onSelectPage() ", _ex);
						}
					}
				});
				dg.datagrid('loadData', state.data);
			} catch (ex) {}
		};
		if (obj) {
			objBind(obj);
		} else {
			for (var i = 0; i < this.selects.length; i++) {
				if (this.selects[i].options.options) {
					//$("#" + this.selects[i].id).combo();
				} else {
					objBind($("#" + this.selects[i].id), this.selects[i]);
				}
			}

			this.elements.filter(e => e.window && e.group).forEach(e => {
				let t = $("#tbcWindow").tabs("getTab", e.group);
				if (t) {
					t.panel('options').tab.hide();
				}
			});
		}
	}

	english(s) {
		if (!s) return "";
		var result = s.replace(/([A-Z])/g, " $1");
		result = result.replace(/_/g, '');
		return result.charAt(0).toUpperCase() + result.slice(1);
	}

	onToggle(e, bValue) {
		let sTag = `#fElement_${e.for.name} > .easyui-${this.uiTypes[e.for.type]}`;
		let oTag = $(sTag);
		e.for.enabled = typeof(bValue) === "undefined" ? !e.for.enabled : bValue;

		oTag.prop("disabled", !e.for.enabled);
		//oTag[this.uiTypes[e.for.type]](e.for.enabled ? "enable" : "disable");
		console.log(sTag, oTag, this.uiTypes[e.for.type], e.for.enabled);
	}

	render(name, title, elements, buttons, bFixed) {
		this.elements = (elements || []).filter(e => !e.ignore);

		this.buttons = buttons || [];
		this.selects = [];
		this.grids = [];

		this.elements.filter(e => e.type == "window").forEach(w => this.elements.splice(this.elements.findIndex(e => e.name == w.name), 0, {
			name: "_" + w.name,
			type: "link",
			title: w.title || this.english(w.name),
			group: w.group,
			window: w.window,
			section: w.section,
			links: [{
				label: 'Open',
				icon: 'edit',
				onClick: o => $("#pnl" + w.name).window('open')
			}],
		}));

		this.sr().groupBy(this.elements.filter(e => e.window), "group").forEach(kv => {
			if (!kv.key) return;

			let e = {
				name: "_" + kv.key,
				title: kv.key,
				type: "window",
				group: kv.key,
				width: this.width * 0.9,
				height: this.height * 0.9,
				loader: o => {
					kv.values.filter(v => v.type !== 'link' || (v.type == 'link' && v.name.startsWith('_'))).forEach(v => $("#pnl_" + v.group + '-center').append($("#fElement_" + v.name)));
					return null;
				},
				buttons: [].concat.apply([], kv.values.filter(v => v.type == 'link' && !v.name.startsWith('_')).map(v => [...v.links.map(l => ({
					name: l.name || l.label,
					title: l.title || l.label,
					onClick: l.onClick,
					icon: l.icon,
					window: true,
					group: kv.key,
				}))])),
			};
			this.buttons.push(...e.buttons);

			this.elements.push(e);
		});

		var ret = "";
		// check the option of using window() as a renderer of the main window...
		if (true) {
			this.elements.filter(e => !e.zone).forEach(e => e.zone = 'center');
			let wOptions = {
				name: name || this.name,
				title: title || this.title,
				type: 'window',
				visible: true,
				width: this.width,
				height: this.height,
				fixed: bFixed,
				links: [{
					icon: "help",
					action: o => $("#pnl__Console").window('open')
				}],
				buttons: this.buttons.filter(b => !b.window),
			};
			this.sr().groupBy(this.elements, 'zone').filter(zg => zg.key).forEach(zg => {
				wOptions[zg.key] = this.renderElements(zg.values);
			});

			ret = this.window(wOptions);
		} else {
			ret = this.header(name, title, bFixed, [{
				icon: "help",
				action: o => $("#pnl__Console").window('open')
			}]);

			ret += this.renderElements();

			ret += this.footer(bFixed);

		}
		// console.log(ret);

		return ret;
	}

	cWidth(options) {
		let ret = Math.floor(((options ? options.width : null) || (this.width / 3)));
		if (options.zone == 'east' || options.zone == 'west') {
			ret = 0.25 * ret; // 90% of 3/10, the width of the normal element
		} else if (options && options.editor) {
			ret = window.innerWidth;
		} else if (options && options.width && typeof(options.width) === 'string') {
			ret = this.width;
		} else if (options && options.type == 'window' && !options.width) {
			ret = this.width * 0.9;
		}

		// console.log(options.name + ": cWidth = " + ret, options.zone);
		return ret;
	}

	window(options) {
		options.title = options.title || options.name;
		var ret = `
		<div id = "pnl${options.name}" class="easyui-window" title="${options.title || this.english(options.name)}" data-options='${this.eventHandlers(options)}, closed:${!options.visible},minimizable:${!options.fixed},maximizable:${!options.fixed},closable:${!options.fixed},collapsible:${!options.fixed},draggable:${!options.fixed},resizable:${!options.fixed},iconCls:"icon-${options.icon}", tools:"#${options.name}_tools"' style="width:${this.cWidth(options)}px;height:${this.cHeight(options)}px;padding:10px;">
		    <div class="easyui-layout" data-options="fit:true">
		`;

		let bZone = options.south ? 'south' : (this.zones.find(z => z == 'south') || this.zones[0]);
		options[bZone] = options[bZone] || [];
		let zWidth = Math.min(120, this.width * 0.95 / (options.buttons ? options.buttons.length : 1), this.cWidth(options));
		options[bZone].push(`<div id="pnl${options.name}-buttons" data-options="region:'${bZone}',border:false" style="text-align:right;padding:5px 0 0;">` + $.map($.grep(options.buttons || [], b => !b.ignore), b => `<a id='${b.name}' href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-${b.icon || 'save'}" style="width:${zWidth}px" onclick='DForm.doClick(${_FrEMD._toJS(b)})'>${b.title || b.name}</a>&nbsp;&nbsp;`).join('') + `</div>`);

		this.zones.filter(z => options[z]).forEach(z => {
			ret += `
		        <div data-options="region:'${z}'" title="${(z=='west' || z=='east')?'&nbsp;':''}" style='height:${(z=='north'||z=='south')?10:100}%;width:${((z=='east'||z=='west')?0.1:1)*this.cWidth(options)}px'>
        		    ${(Array.isArray(options[z])?options[z]:[options[z]]).join('')}
                </div>
            `;
		});

		ret += `</div></div>`;

		// links (tools)
		let links = $.grep([].concat(options.links || []), l => !l.ignore);
		ret += `<div id="${options.name}_tools">` + $.map(links.reverse(), l => `<a href="javascript:void(0)" style="color:black" class="fas fa-${l.icon || 'add'}" onclick='(async () => {var a = ${_FrEMD._toJS(l)}; $("#pnl${options.name}").window("setTitle", "${options.title}: " + a.name); await a.action(DForm.get(), a, ${_FrEMD._toJS(options)}); $("#pnl${options.name}").window("setTitle", "${options.title}");})()'></a>`).join('\n') + `</div>`;

		return ret;
	}

	async _end() {
		let o = this.get();

		// do not use the first button, because many forms have a Cancel button only
		let button = this.buttons.find(b => b.autoSubmit) /* || this.buttons[0]*/ ;
		if (button && o && Object.values(o).length && (typeof(button.autoSubmit) === "undefined" || button.autoSubmit)) {
			let v = Object.values(o).reduce((t, v) => {
				return ((typeof(v) !== "object") ? 1 : 0) * (v ? 1 : 0);
			});
			//console.log(o, Object.values(o), v);
			if (v) {
				// all fields have values
				await this.doClick(button);

			}
		}
	}

	footer(bFixed) {
		return `</form>` + `<div id="dlg-buttons">` + this.buttons.filter(b => !b.window).map(b => `<a id='${b.name}' href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-${b.icon || 'save'}" style="width:${Math.min(120, this.width * 0.95 / this.buttons.length, this.cWidth())}px" onclick='DForm.doClick(${_FrEMD._toJS(b)})'>${b.title || this.english(b.name)}</a>&nbsp;&nbsp;`).join('') + "</div>" + (bFixed ? "" : '</div>');
	}

	header(name, title, bFixed, links) {
		this.title = title || this.title;
		name = name || this.name;
		var ret = '';

		ret += this.window({
			name: "__Console",
			type: "window",
			editor: true,
			loader: o => window.logs.slice().reverse().map(l => l.date.toISOString() + ": " + l.args.map(s => typeof(s) === 'object' ? ((obj, indent = 2) => {
				let cache = [];
				const retVal = JSON.stringify(
					obj,
					(key, value) =>
					typeof value === "object" && value !== null ?
					cache.includes(value) ?
					undefined // Duplicate reference found, discard key
					:
					cache.push(value) && value // Store value in our collection
					:
					value,
					indent
				);
				cache = null;
				return retVal;
			})(s) : s).join(', ')).join('\n'),
		});

		if (!bFixed) {
			links = (links || []).filter(l => !l.ignore);
			let tData = "";
			if (links.length) {
				ret += `<div id="${this.name}_tools">` + links.map(l => `<a href="javascript:void(0)" class="icon-${l.icon}" onclick='(async () => {var a = ${_FrEMD._toJS(l)}; $("#win${this.name}").window("setTitle", "${this.title}: " + a.name); await a.action(DForm.get()); $("#win${this.name}").window("setTitle", "${this.title}");})()'></a>`).join('\n') + "</div>";
				tData = `,tools:"#${this.name}_tools"`;
			}
			ret += `<div id='win${this.name}' class='easyui-window' title='${this.title || this.english(this.name)}' data-options='iconCls:"icon-save" ${tData}' style='width:${this.width}px;height:${this.height}px;padding:10px;'>`;
		}
		return ret + `<form id="frm${this.name}" method="post" novalidate>`;
	}

	renderElements(elements) {
		elements = elements || this.elements;

		var tWidth = Math.floor(this.width * 0.95);
		var tHeight = Math.floor(this.height * 0.85);

		let ret = '';
		var gElements = this.sr().groupBy(elements, "group");
		if (gElements.length > 1) ret += `<div id="tbcWindow" class="easyui-tabs" data-options='${this.eventHandlers({type: 'tabs'})}' style="width:${tWidth}px;height:${tHeight}px;">`;
		for (var g = 0; g < gElements.length; g++) {
			if (gElements.length > 1) ret += '<div title="' + (gElements[g].key || "Main") + '" style="padding:20px;display:none;">';
			var sElements = this.sr().groupBy(gElements[g].values, "section");
			if (sElements.length > 1) ret += '<div class="easyui-accordion" style="width:' + tWidth + 'px;height:' + /*tHeight*/ "100%" + 'px;">';
			for (var s = 0; s < sElements.length; s++) {
				ret += `<div title="${sElements[s].key || ""}" data-options="iconCls:'icon-more'" style="padding:10px;">`;
				for (var i = 0; i < sElements[s].values.length; i++) {
					var e = sElements[s].values[i];
					if (e.ignore) continue;
					e.value = e.value || _FrEMD.hash[e.name] || (_FrEMD.apiServer ? _FrEMD.apiServer.__config('test_' + e.name, '') : '');
					ret += `<div id="fElement_${e.name}" class="fitem" style="display: ${(e.type=='window' || e.hidden)?'none':''}">`;
					if (e.toggle) {
						ret += `<a href="#" class="easyui-linkbutton" data-options='${this.eventHandlers({type: 'toggle', for: e})},plain:true,iconCls:"icon-${e.icon || 'search'}"' style="width:100px;height:30px">${e.title || this.english(e.name)}</a>`;
					} else {
						ret += `<label>${e.title || this.english(e.name)}:</label>`;
					}
					if (e.type && this[e.type]) {
						ret += this[e.type](e);
					} else if (e.render) {
						ret += e.render();
					}
					ret += '</div>';
				}
				ret += '</div>';
			}
			if (sElements.length > 1) ret += '</div>';
			if (gElements.length > 1) ret += "</div>";
		}
		if (gElements.length > 1) ret += "</div>";
		return ret;
	}

	info(msg) {
		if ($.messager) {
			$.messager.alert(this.title, msg, 'info');
		} else {
			this.sr().ShowMessage(msg, this.title);
		}
	}

	error(msg) {
		if ($.messager) {
			$.messager.alert(this.title, msg, 'error');
		} else {
			this.sr().ShowMessage(msg, this.title);
		}
	}

	byName(name) {
		return this.elements.find(e => e.name === name);
	}

	/** Components::Start **/
	CoreComponent = class {
		constructor(page, dForm, oScope) {
			this.page = page;
			this.dForm = dForm || DForm;
			this.oScope = oScope;
		}

		_server() {
			let scope = window.bLocal ? "platformmanager" : _FrEMD.apiServer.Scope;
			return new(_FrEMD.__scope(scope)[_FrEMD.__scope(scope).EntityClasses.find(c => c.IsMain).Name])();
		}

		_entityField(ec) {
			return {
				name: ec.Name.replace(/\ /g, '_'),
				title: _FrEMD._titleCase(ec.Name),
				Class: {
					Name: ec.Name,
					Id: ec.Id
				},
				zone: 'north',
				type: ec.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ec) ? 'tree' : 'select',
				parentField: ec.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ec)?.Name,
				//searchField: ec.EntityAttributes.find(ea => ea.IsString).Name,
				//idField: '_ToString',
				source: (o, fData, sText) => ({
					OPERATORS: {
						[ec.EntityAttributes.find(ea => ea.IsString).Name]: 'like'
					},
					[ec.EntityAttributes.find(ea => ea.IsString).Name]: sText

				}),
			};
		}

		_eaToField(ea) {
			if (ea.EntityType) return {
				group: ea.Group.Name,
				name: ea.Name,
				_type: ea.EntityType.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ea.EntityType) ? 'tree' : 'select',
				type: 'select',
				parentField: ea.EntityType.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ea.EntityType)?.Name,
				//idField: '_ToString',
				zone: 'center',
				Class: {
					Name: ea.EntityType.Name,
					Id: ea.EntityType.Id
				},
				source: (o, fData, sText) => ({
					OPERATORS: {
						[ea.EntityType.EntityAttributes.find(ea => ea.IsString).Name]: 'like'
					},
					[ea.EntityType.EntityAttributes.find(ea => ea.IsString).Name]: sText

				}),
			};
			if (ea.IsText) return {
				group: ea.Group.Name,
				name: ea.Name,
				type: 'window',
				zone: 'center',
				editor: true,
				language: o => ea.Name == 'script' ? 'javascript' : "text",
			};

			return {
				group: ea.Group.Name,
				name: ea.Name,
				zone: 'center',
				type: Object.entries({
					Bool: 'bool',
					Date: 'datetime',
					Int: 'int',
					Long: 'long',
					Image: 'image',
					String: 'string'
				}).find(e => ea['Is' + e[0]])[1],
			};
		}

		busy(bBusy) {
			return this.dForm.busy(bBusy);
		}

		_me(v) {
			let meName = (typeof(company) !== 'undefined') ? (company.loggedInIdentity || "me") : "me";
			if (v) {
				window[meName] = v;
			}

			return window[meName];
		}

		_canView() {
			if (!this._me()) {
				window._FrEMD.setURL({
					page: 'login',
					_redirect: this.page._code,
				});
				throw `_canView: ${this.page._code} not allowed without login!`;
			}
		}

		_name() {
			if (!this._me()) return "";
			return this._me().name ? this._me().name() : this._me().ToString;
		}
	}

	MainComponent = class extends this.CoreComponent {
		_menuClasses(scope) {
			let oScope = _FrEMD.__scope(scope);
			//console.log("MainComponent::_menuClasses(" + scope + "): oScope", scope, oScope, _FrEMD.apiServer);
			if (!oScope) return [];

			return _FrEMD.sr().groupBy(oScope.EntityClasses, 'EntityModule').map(g => ({
				label: (g.key ? this.dForm.english(g.key.Name) : null) || 'Main',
				subMenus: _FrEMD.sr().groupBy(g.values, 'Group').map(gv => ({
					label: (gv.key ? this.dForm.english(gv.key.Name) : null) || 'Main',
					subMenus: gv.values.map(gvv => ({
						label: this.dForm.english(gvv.Name),
						code: 'store',
						data: gvv.Name
					}))
				}))
			}));
		}

		_menuMethods(scope) {
			let oScope = _FrEMD.__scope(scope);
			//console.log("MainComponent::_menuMethods(" + scope + "): oScope", scope, oScope, _FrEMD.apiServer);
			if (!oScope) return [];

			return _FrEMD.sr().groupBy(oScope.EntityClasses.filter(ec => ec.EntityMethods.length), 'EntityModule').map(g => ({
				label: (g.key ? this.dForm.english(g.key.Name) : null) || 'Main',
				subMenus: _FrEMD.sr().groupBy(g.values, 'Group').map(gv => ({
					label: (gv.key ? this.dForm.english(gv.key.Name) : null) || 'Main',
					subMenus: gv.values.map(mc => ({
						label: this.dForm.english(mc.Name),
						subMenus: mc.EntityMethods.map(em => ({
							label: this.dForm.english(em.Name),
							code: 'method',
							data: mc.Name + "." + em.Name
						}))
					}))
				}))
			}));
		}

		_buildMenu(scope) {
			return [{
				label: "Main",
				order: -1,
				subMenus: [{
					label: 'Index',
				}, {
					label: "Login",
				}, {
					label: "Load",
				}, {
					label: "Save",
				}, {
					label: "Logout"
				}]
			}, {
				label: "Process",
				order: 99998,
				subMenus: this._menuMethods(scope)
			}, {
				label: "Setup",
				order: 99999,
				subMenus: this._menuClasses(scope)
			}];
		}
	}

	LoadComponent = class extends this.CoreComponent {
		async main() {
			this.page.data = {
				form: this.dForm.render('frmLoad', "Load Setup Data", [{
					name: 'Excel',
					type: "file",
					binary: true,
					local: true,
					upload: async (fData, data) => {
						this.dForm.set({
							Progress: 0
						});

						let tables = [];
						let obj = [];

						let server = this._server();

						const wb = new ExcelJS.Workbook();
						console.clear();
						let workbook = await wb.xlsx.load(data);
						workbook.eachSheet((sheet, id) => {
							let sTables = sheet.getTables();
							sTables.forEach(t => t.table.sheet = sheet);
							tables.push(...sTables);
						});
						tables = tables.flat().map(t => t.table);

						//console.clear();
						tables.forEach(t => {
							//console.log(t.name, t.columns, t.sheet.getCell('A2').value);
							for (var i = 2; t.sheet.getCell('A' + i).value !== null; i++) {
								obj.push(server._new(t.name)._fromDocument(Object.assign(...t.columns.map((c, ci) => ({
									[c.name]: t.sheet.getCell(String.fromCharCode('A'.charCodeAt(0) + ci) + i).value
								})))));
							}
						});

						for await (const o of obj) {
							//await _FrEMD._wait(1000)
							await o.store();
							this.dForm.set({
								Progress: this.dForm.get().Progress + 100.0 / obj.length
							});
						}

						_FrEMD.RenderPage({
							_code: 'login'
						});
					}
				}, {
					name: "Progress",
					type: "progress",
				}], [{
					name: 'Load',
					onclick: async o => {}
				}])
			};
		}
	}

	SaveComponent = class extends this.CoreComponent {
		async main() {
			//this._canView();

			this.page.data = {
				form: this.dForm.render('frmSave', "Save Setup Data", [{
					name: 'Save',
					type: "label",
					value: "Export to Excel",
				}, {
					name: 'Title',
					type: 'string',
					value: '',
				}, {
					name: "Progress",
					type: "progress",
				}], [{
					name: 'Save',
					onclick: async o => {
						console.clear();

						this.dForm.set({
							Progress: 0
						});

						let server = this._server();

						let tTemplate = {
							headerRow: true,
							style: {
								theme: 'TableStyleDark3',
								showRowStripes: true,
							},
						};
						let tables = [];
						for await (const c of _FrEMD.__scope(server.Scope).EntityClasses.sort((a, b) => a.Rank - b.Rank)) {
							//console.log("DynaForm::SaveComponent(): " + c.Name + ", Rank=" + c.Rank);
							tables.push(Object.assign(JSON.parse(JSON.stringify(tTemplate)), await server._new(c.Name)._toTabular()));
							this.dForm.set({
								Progress: this.dForm.get().Progress + 100.0 / _FrEMD.__scope(server.Scope).EntityClasses.length
							});
						}
						tables.forEach(t => t.ref = 'A1:' + String.fromCharCode('A'.charCodeAt(0) + t.columns.length - 1) + (t.rows.length + 1));

						let rgb = (letters = '0123456789ABCDEF') => Array(6).map(i => letters[Math.floor(Math.random() * 16)]).join('');

						const workbook = new ExcelJS.Workbook();
						tables.forEach(t => workbook.addWorksheet(t.name, {
							properties: {
								tabColor: {
									argb: 'F' + rgb()
								}
							}
						}).addTable(t));

						let buffer = await workbook.xlsx.writeBuffer({
							dateFormat: 'YYYY-MM-DD HH:mm:ss'
						});

						const link = document.createElement('a');
						link.style.display = 'none';
						document.body.appendChild(link);
						link.href = URL.createObjectURL(new Blob([buffer], {
							type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8'
						}));
						link.download = (o.Title || server.Scope || "data") + ".xlsx";
						link.click();
					}
				}])
			};
		}
	}

	IndexComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.page.data = {
				form: this.dForm.render('frmIndex', "Main Page", [{
					name: 'Welcome',
					required: true,
					type: "label",
					value: this._name(),
				}], [])
			};
		}
	}

	LogoutComponent = class extends this.CoreComponent {
		main() {
			this._canView();

			delete window.me;

			this.page.data = {
				form: this.dForm.render('frmLogout', "Logout", [{
						name: "Logout",
						type: "label",
						value: "logout in progress..."
					}],
					[])
			};

			_FrEMD.RenderPage({
				_code: "login"
			});
		}
	}

	LoginComponent = class extends this.CoreComponent {
		async _authenticate(o) {
			//if (!window.bLocal && (!_FrEMD.__scope() || !_FrEMD.__scope().EntityClasses)) return;

			let authClassName = _FrEMD.__scope()?.EntityClasses?.find(c => c.EntityAttributes.find(ea => ea.Name == 'username'))?.Name;
			if (_FrEMD.apiServer && authClassName) return await _FrEMD.apiServer._new(authClassName).username(o.Username, '=').password(o.Password, '=').active(true).enabled(true).find();

			authClassName = authClassName || (window.bLocal ? ({
				cms: "Author",
				ems: "Employee"
			})[company.Code] : null);

			o.OPERATORS = {
				Username: "=",
				Password: "="
			};

			if (authClassName) return (await sr._("ems" + authClassName + "Find", null, o));
		}

		async _loggedIn() {}

		async _notLoggedIn() {}

		async main() {
			this.page.data = {
				form: this.dForm.render('frmLogin', "User Authentication", [{
						name: 'Username',
						required: true,
						type: "string"
					},
					{
						name: 'Password',
						required: true,
						type: "password"
					}
				], [{
					name: 'Login',
					autoSubmit: true,
					onclick: async o => {
						let ret = await this._authenticate(o);

						if (ret) {
							this._me(ret);

							try {
								await this._loggedIn();
							} catch (ex) {}

							_FrEMD.setURL({
								page: _FrEMD.hash._redirect || "index"
							});
						} else {
							try {
								await this._notLoggedIn();
							} catch (ex) {}

							this.dForm.error("Invalid username or password");
						}

						this.dForm.busy(false);
					}
				}])
			};
		}
	}

	MethodComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.sMethod = this.page.data;
			console.clear();

			let ec = (_FrEMD.__scope() || this.oScope).EntityClasses.find(c => c.Name == this.sMethod.split('.')[0]);
			let em = ec.EntityMethods.find(m => m.Name == this.sMethod.split('.')[1]);

			this.page.data = {
				form: this.dForm.render(this.sMethod, _FrEMD._titleCase(ec.Name) + ' :: ' + _FrEMD._titleCase(em.Name), [this._entityField(ec)].concat(...em.MethodParameters.map(p => this._eaToField(p))), [{
					name: 'Reset',
					onclick: o => {
						this.dForm.clear();
					},
					icon: "cancel"
				}, {
					name: 'Reload',
					onclick: o => _FrEMD.RenderPage({
						_code: 'method'
					}, this.page.data),
					icon: "reload"
				}, {
					name: em.Name,
					title: _FrEMD._titleCase(em.Name),
					onclick: async o => {
						let obj = o[ec.Name] || _FrEMD.apiServer._new(ec.Name);
						console.log("onclick()", ec.Name, obj, o, o[ec.Name]);
						//if (o[this.sTable] && typeof(o[this.sTable].__sync_on) === 'function' && o[this.sTable].__sync_on()) obj.Id = o[this.sTable].Id;

						await obj[em.Name](...em.MethodParameters.map(p => o[p.Name]));
					}
				}])
			};
		}
	}

	StoreComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.sTable = this.page.data;
			console.clear();

			//console.log("DynaForm::StoreComponent(): sTable", this.sTable);

			let ec = _FrEMD.__scope().EntityClasses.find(c => c.Name == this.sTable);

			this.page.data = {
				form: this.dForm.render(ec.Name.replace(/\ /g, '_'), _FrEMD._titleCase(ec.Name), [Object.assign(this._entityField(ec), {
					select: async o => {
						this.dForm.clear();
						this.dForm.busy(true);

						let r = await o.find();
						this.dForm.set(Object.assign({
							[ec.Name.replace(/\ /g, '_')]: r
						}, ...ec.EntityAttributes.filter(ea => !ea.EntityMethod).filter(ea => typeof(r[ea.Name]()) !== 'undefined').map(ea => ({
							[ea.Name]: r[ea.Name]()
						}))));
						this.dForm.busy(false);
					}
				})].concat(...ec.EntityAttributes.filter(ea => !ea.EntityMethod).map(ea => this._eaToField(ea))), [{
					name: 'Reset',
					onclick: o => {
						this.dForm.clear();
					},
					icon: "cancel"
				}, {
					name: 'Reload',
					onclick: o => _FrEMD.RenderPage({
						_code: 'store'
					}, this.page.data),
					icon: "reload"
				}, {
					name: 'Save',
					onclick: async o => {
						let obj = _FrEMD.apiServer._new(this.sTable);
						//console.log("onclick()", this.sTable, obj, o, o[this.sTable]);
						if (o[this.sTable] && typeof(o[this.sTable].__sync_on) === 'function' && o[this.sTable].__sync_on()) obj.Id = o[this.sTable].Id;

						ec.EntityAttributes.filter(ea => !ea.EntityMethod).forEach(ea => obj[ea.Name](o[ea.Name]));
						//return console.log(obj._toFileName(), obj);
						await obj.store();
					}
				}])
			};
		}
	}
	/** Components::End **/
};
","
storedMethod ": null,"
__keys ": ["
name "],"
active ": true,"
enabled ": true,"
__trMap ": []}
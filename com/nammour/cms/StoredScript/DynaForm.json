{
	"Id": "58d439aff12a27a270314a7d76b8d7008a48d7cc",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "DynaForm",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkR5bmFGb3JtID0gY2xhc3MgewoJY29uc3RydWN0b3IoKSB7CgkJdGhpcy50aXRsZSA9ICJGb3JtIFRpdGxlIjsKCQl0aGlzLm5hbWUgPSAiZnJtRm9ybSI7CgkJdGhpcy5lbGVtZW50cyA9IFtdOwoJCXRoaXMuc2VsZWN0cyA9IFtdOwoJCXRoaXMuZ3JpZHMgPSBbXTsKCQl0aGlzLmJ1dHRvbnMgPSBbXTsKCQl0aGlzLnpvbmVzID0gWydub3J0aCcsICdzb3V0aCcsICdlYXN0JywgJ3dlc3QnLCAnY2VudGVyJ107CgkJdGhpcy5zVGFibGUgPSBudWxsOwoJCXRoaXMuYkRlYnVnID0gZmFsc2U7CgkJdGhpcy51aVR5cGVzID0gewoJCQlpbnQ6ICJudW1iZXJzcGlubmVyIiwKCQkJbWVudTogInNwbGl0YnV0dG9uIiwKCQkJZGF0ZXRpbWU6ICJkYXRldGltZWJveCIsCgkJCWJvb2w6ICJzd2l0Y2hidXR0b24iLAoJCQlmaWxlOiAiZmlsZWJveCIsCgkJCXRleHQ6ICJ0ZXh0Ym94IiwKCQkJbGFiZWw6ICJodG1sIiwKCQkJcGFzc3dvcmQ6ICJwYXNzd29yZGJveCIsCgkJCXN0cmluZzogInRleHRib3giLAoJCQlpbWFnZTogImRpYWxvZyIsCgkJCXByb2dyZXNzOiAicHJvZ3Jlc3NiYXIiLAoJCQlsaW5rOiAibGlua2J1dHRvbiIsCgkJCXRyZWU6ICJjb21ib3RyZWUiLAoJCQluYXZpZ2F0aW9uOiAidHJlZSIsCgkJCXNlYXJjaDogJ3NlYXJjaGJveCcsCgkJfTsKCQl0aGlzLmV2ZW50cyA9IFt7CgkJCW5hbWU6ICdvbkNsaWNrJywKCQkJaGFuZGxlcjogJ29uVG9nZ2xlJywKCQkJcGFyYW1zOiAnbj1ldmVudCcsCgkJCXR5cGU6ICd0b2dnbGUnLAoJCX0sIHsKCQkJbmFtZTogJ29uQ2xvc2UnLAoJCQloYW5kbGVyOiAnUGFuT25DbG9zZScsCgkJCXBhcmFtczogJ249ZXZlbnQnLAoJCQl0eXBlOiAnd2luZG93JywKCQl9LCB7CgkJCW5hbWU6ICdvblNlbGVjdCcsCgkJCWhhbmRsZXI6ICdTZWxlY3RDaGFuZ2UnLAoJCQlwYXJhbXM6ICduJywKCQkJdHlwZTogJ3RhYnMnLAoJCX0sIHsKCQkJbmFtZTogJ3NlYXJjaGVyJywKCQkJaGFuZGxlcjogJ0ZpZWxkQ2hhbmdlJywKCQkJcGFyYW1zOiAnbiwgbycsCgkJCXR5cGU6ICdzZWFyY2hib3gnLAoJCX0sIHsKCQkJbmFtZTogJ29uQmVmb3JlRXhwYW5kJywKCQkJaGFuZGxlcjogJ0V4cGFuZCcsCgkJCXBhcmFtczogJ24nLAoJCQl0eXBlOiAndHJlZScsCgkJfSwgewoJCQluYW1lOiAnb25DaGFuZ2UnLAoJCQloYW5kbGVyOiAnRmllbGRDaGFuZ2UnLAoJCQlwYXJhbXM6ICduLCBvJywKCQl9LCB7CgkJCW5hbWU6ICdvbkJlZm9yZU9wZW4nLAoJCQloYW5kbGVyOiAnUGFuZWxPcGVuJywKCQkJcGFyYW1zOiAnJywKCQkJdHlwZTogJ3dpbmRvdycsCgkJfSwgewoJCQluYW1lOiAnb25PcGVuJywKCQkJaGFuZGxlcjogJ1BlbmRBZnRlck9wZW4nLAoJCQlwYXJhbXM6ICcnLAoJCQl0eXBlOiAnd2luZG93JywKCQl9LCB7CgkJCW5hbWU6ICdvbkNsaWNrJywKCQkJaGFuZGxlcjogJ2RvTGluaycsCgkJCXBhcmFtczogJ249ZXZlbnQsIG8nLAoJCQl0eXBlOiAnbGluaycsCgkJfSwgewoJCQluYW1lOiAnb25DbGlja1JvdycsCgkJCWhhbmRsZXI6ICdGaWVsZENoYW5nZScsCgkJCXBhcmFtczogJ24sIG8nLAoJCQl0eXBlOiAnZ3JpZCcsCgkJfV07CgoJCWlmICh0eXBlb2YoJCkgIT09ICd1bmRlZmluZWQnKSAkKHdpbmRvdykucmVzaXplKHRoaXMud2luZG93UmVzaXplZCk7CgkJdGhpcy53aW5kb3dSZXNpemVkKCk7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuIHR5cGVvZihfRnJFTUQpICE9PSAndW5kZWZpbmVkJyA/IF9GckVNRC5zcigpIDogd2luZG93LnNyOwoJfQoKCXBhcnNlKCkgewoJCSQucGFyc2VyLnBhcnNlKCk7Cgl9CgoJd2luZG93UmVzaXplZCgpIHsKCQl0aGlzLndpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CgkJdGhpcy5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgKiAwLjg7Cgl9CgoJaW5pdCgpIHsKCQl2YXIgc2VsZWN0ID0gewoJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCXZhciBvcCA9IG51bGw7CgkJCQl2YXIgZm9wID0gbnVsbDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5ncmlkcy5sZW5ndGg7IGkrKykKCQkJCQlpZiAodHJ1ZSB8fCB0aGlzLmdyaWRzW2ldLmlkID09IG9wdGlvbnMuc291cmNlKSBvcCA9IHRoaXMuZ3JpZHNbaV0ub3B0aW9uczsKCQkJCWZvciAoaSA9IDA7IGkgPCBvcC5jb2x1bW5zLmxlbmd0aDsgaSsrKQoJCQkJCWlmIChvcC5jb2x1bW5zW2ldLm5hbWUgPT0gb3B0aW9ucy5maWVsZCkgZm9wID0gb3AuY29sdW1uc1tpXTsKCQkJCWZvcC53aWR0aCA9ICh0aGlzLndpZHRoIC8gMyk7CgkJCQl2YXIgZSA9ICQodGhpcy5zZWxlY3QoZm9wKSk7CgkJCQl2YXIgaW5wdXQgPSBlLmFwcGVuZFRvKGNvbnRhaW5lcik7CgkJCQlpbnB1dC5jb21ib2dyaWQoKTsKCQkJCXRoaXMuYmluZChpbnB1dCk7CgkJCQlyZXR1cm4gaW5wdXQ7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKHRhcmdldCkgewoJCQkJJCh0YXJnZXQpLnJlbW92ZSgpOwoJCQl9LAoJCQlnZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQlyZXR1cm4gJCh0YXJnZXQpLnZhbCgpOwoJCQl9LAoJCQlzZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0LCB2YWx1ZSkgewoJCQkJJCh0YXJnZXQpLnZhbCh2YWx1ZSk7CgkJCX0sCgkJCXJlc2l6ZTogZnVuY3Rpb24odGFyZ2V0LCB3aWR0aCkgewoJCQkJJCh0YXJnZXQpLl9vdXRlcldpZHRoKHdpZHRoKTsKCQkJfQoJCX07CgkJJC5leHRlbmQoJC5mbi5kYXRhZ3JpZC5kZWZhdWx0cy5lZGl0b3JzLCB7CgkJCWRhdGV0aW1lOiB7CgkJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCQlvcHRpb25zLndpZHRoID0gdGhpcy5jV2lkdGgob3B0aW9ucyk7CgkJCQkJdmFyIGlucHV0ID0gJCh0aGlzLmRhdGV0aW1lKG9wdGlvbnMpKS5hcHBlbmRUbyhjb250YWluZXIpOwoJCQkJCWlucHV0LmRhdGV0aW1lYm94KCk7CgkJCQkJcmV0dXJuIGlucHV0OwoJCQkJfSwKCQkJCWRlc3Ryb3k6IGZ1bmN0aW9uKHRhcmdldCkgewoJCQkJCSQodGFyZ2V0KS5yZW1vdmUoKTsKCQkJCX0sCgkJCQlnZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQkJcmV0dXJuICQodGFyZ2V0KS52YWwoKTsKCQkJCX0sCgkJCQlzZXRWYWx1ZTogZnVuY3Rpb24odGFyZ2V0LCB2YWx1ZSkgewoJCQkJCSQodGFyZ2V0KS52YWwodmFsdWUpOwoJCQkJfSwKCQkJCXJlc2l6ZTogZnVuY3Rpb24odGFyZ2V0LCB3aWR0aCkgewoJCQkJCSQodGFyZ2V0KS5fb3V0ZXJXaWR0aCh3aWR0aCk7CgkJCQl9CgkJCX0sCgkJCWNoZWNrYm94OiB7CgkJCQlpbml0OiBmdW5jdGlvbihjb250YWluZXIsIG9wdGlvbnMpIHsKCQkJCQl2YXIgaW5wdXQgPSAkKHRoaXMuYm9vbChvcHRpb25zKSkuYXBwZW5kVG8oY29udGFpbmVyKTsKCQkJCQlpbnB1dC5zd2l0Y2hidXR0b24oKTsKCQkJCQlyZXR1cm4gaW5wdXQ7CgkJCQl9LAoJCQkJZGVzdHJveTogZnVuY3Rpb24odGFyZ2V0KSB7CgkJCQkJJCh0YXJnZXQpLnJlbW92ZSgpOwoJCQkJfSwKCQkJCWdldFZhbHVlOiBmdW5jdGlvbih0YXJnZXQpIHsKCQkJCQlyZXR1cm4gJCh0YXJnZXQpLnZhbCgpOwoJCQkJfSwKCQkJCXNldFZhbHVlOiBmdW5jdGlvbih0YXJnZXQsIHZhbHVlKSB7CgkJCQkJJCh0YXJnZXQpLnZhbCh2YWx1ZSk7CgkJCQl9LAoJCQkJcmVzaXplOiBmdW5jdGlvbih0YXJnZXQsIHdpZHRoKSB7CgkJCQkJJCh0YXJnZXQpLl9vdXRlcldpZHRoKHdpZHRoKTsKCQkJCX0KCQkJfSwKCQkJY29tYm90cmVlZ3JpZDogc2VsZWN0LAoJCQlzZWxlY3Q6IHNlbGVjdCwKCQl9KTsKCX0KCglhc2socXVlc3Rpb24sIGZBbnN3ZXIgPSB2ID0+IHYsIG9wdGlvbnMpIHsKCQkkLm1lc3NhZ2VyLmNvbmZpcm0odGhpcy50aXRsZSwgcXVlc3Rpb24sIGZ1bmN0aW9uKHIpIHsKCQkJaWYgKG9wdGlvbnMpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChvcHRpb25zW2ldLmFuc3dlciA9PSByKSB7CgkJCQkJCXJldHVybiBmQW5zd2VyKG9wdGlvbnNbaV0udmFsdWUpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXJldHVybiBmQW5zd2VyKHIpOwoJCQl9CgkJfSk7Cgl9CgoJdG9wRGF0YShhciwgZ0ZpZWxkLCB2RmllbGQsIHRvcCkgewoJCWlmICghdG9wKSB7CgkJCXJldHVybiBhcjsKCQl9CgkJcmV0ID0gW107CgkJJC5lYWNoKHRoaXMuc3IoKS5ncm91cEJ5KGFyLCBnRmllbGQpLCBmdW5jdGlvbihrZXksIHZhbHVlcykgewoJCQl2YWx1ZXMudmFsdWVzLnNvcnQoKGEsIGIpID0+IHsKCQkJCWlmIChwYXJzZUZsb2F0KGFbdkZpZWxkXSkgPCBwYXJzZUZsb2F0KGJbdkZpZWxkXSkpIHsKCQkJCQlyZXR1cm4gMTsKCQkJCX0gZWxzZSBpZiAocGFyc2VGbG9hdChhW3ZGaWVsZF0pID4gcGFyc2VGbG9hdChiW3ZGaWVsZF0pKSB7CgkJCQkJcmV0dXJuIC0xOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gMDsKCQkJCX0KCQkJfSk7CgkJCSQuZWFjaCh2YWx1ZXMudmFsdWVzLCBmdW5jdGlvbihpLCB2KSB7CgkJCQlpZiAoaSA8IHRvcCkgewoJCQkJCXJldC5wdXNoKHYpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGRvQ2xpY2soYnV0dG9uKSB7CgkJbGV0IF90aGlzID0gdHlwZW9mKHRoaXMuZG9DbGljaykgPT09ICdmdW5jdGlvbicgPyB0aGlzIDogd2luZG93LkRGb3JtOwoJCWJ1dHRvbiA9IF90aGlzLmJ1dHRvbnMuZmluZChiID0+IGIubmFtZSA9PSBidXR0b24ubmFtZSAmJiBiLmdyb3VwID09IGJ1dHRvbi5ncm91cCk7CgkJX3RoaXMuYnVzeSh0cnVlKTsKCQlfdGhpcy5zZXQoewoJCQlXb3JrUHJvZ3Jlc3NWYWx1ZTogMjAKCQl9KQoKCQl2YXIgbyA9IF90aGlzLmdldCgpOwoJCXZhciBzTWlzc2luZyA9IF90aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+IChidXR0b24ud2luZG93ID8gYnV0dG9uLmdyb3VwID09IGUuZ3JvdXAgOiB0cnVlKSkuZmlsdGVyKGUgPT4gZS5yZXF1aXJlZCAmJiAhb1tlLm5hbWVdKS5tYXAoZSA9PiAiPGxpPiIgKyAoZS5sYWJlbCB8fCBlLm5hbWUpICsgIjwvbGk+Iikuam9pbigiIik7CgkJaWYgKHNNaXNzaW5nKSB7CgkJCXdpbmRvdy5fRnJFTUQuX2Vycm9yKCJNaXNzaW5nIG1hbmRhdG9yeSBmaWVsZHM6PGJyLz48dWw+IiArIHNNaXNzaW5nICsgIjwvdWw+IiwgNTAwMCk7CgkJCV90aGlzLmJ1c3koZmFsc2UpOwoJCQlyZXR1cm47CgkJfQoJCWlmIChidXR0b24ub25jbGljaykgYXdhaXQgYnV0dG9uLm9uY2xpY2sobyk7CgkJaWYgKGJ1dHRvbi5vbkNsaWNrKSBhd2FpdCBidXR0b24ub25DbGljayhvKTsKCQlfdGhpcy5idXN5KGZhbHNlKTsKCX0KCglidXN5KGJCdXN5KSB7CgkJaWYgKCFiQnVzeSkgewoJCQl2YXIgdG90YWwgPSAwOwoJCQlpZiAodHlwZW9mIG1vbWVudCAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRvdGFsID0gbW9tZW50KCkuZGlmZihtb21lbnQodGhpcy5idXN5U3RhbXApLCAnc2Vjb25kcycpOwoJCQl9IGVsc2UgewoJCQkJLy8gbm8gbW9tZW50LCB1c2Ugc3RhbmRhcmQgRGF0ZQoJCQkJdG90YWwgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLmJ1c3lTdGFtcCA/IHRoaXMuYnVzeVN0YW1wLmdldFRpbWUoKSA6IDApIC8gMTAwMCAvIDM2MDA7CgkJCX0KCQkJaWYgKHRoaXMuYkRlYnVnKSB7CgkJCQl3aW5kb3cuX0ZyRU1ELl9hbGVydCgiRXhlY3V0aW9uIFRpbWU6ICIgKyB0b3RhbCArICIgc2Vjb25kcy4iKTsKCQkJfQoJCQlkZWxldGUgdGhpcy5idXN5U3RhbXA7CgoJCQlzZXRJbnRlcnZhbCgxLCAoKSA9PiB0aGlzLlNldCh7CgkJCQlMb2FkaW5nOiAxMAoJCQl9KSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5idXN5U3RhbXAgPSBuZXcgRGF0ZSgpOwoJCX0KCgkJJC5lYWNoKCQubWVyZ2UoJC5tYXAodGhpcy5idXR0b25zLCBiID0+IGIubmFtZSksICQubWFwKHRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gZS50eXBlID09ICdsaW5rJyksIGUgPT4gZS5uYW1lKSksIChfLCBlKSA9PiAkKCcjJyArIGUpLmxpbmtidXR0b24oYkJ1c3kgPyAnZGlzYWJsZScgOiAnZW5hYmxlJykpOwoJfQoKCXByZWZpeChlKSB7CgkJc3dpdGNoIChlLnR5cGUpIHsKCQkJY2FzZSAnbGFiZWwnOgoJCQkJcmV0dXJuICdsYmwnOwoJCQljYXNlICd0ZXh0JzoKCQkJY2FzZSAnc3RyaW5nJzoKCQkJY2FzZSAnc2VhcmNoJzoKCQkJY2FzZSAncGFzc3dvcmQnOgoJCQkJcmV0dXJuICd0eHQnOwoJCQljYXNlICJEYXRlVGltZSI6CgkJCWNhc2UgImRhdGV0aW1lIjoKCQkJCXJldHVybiAnZHRwJzsKCQkJY2FzZSAiaW50IjoKCQkJY2FzZSAiaW50ZWdlciI6CgkJCWNhc2UgIm51bWJlciI6CgkJCWNhc2UgImxvbmciOgoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAnbnVkJzsKCQkJY2FzZSAnZmlsZSc6CgkJCQlyZXR1cm4gJ2ZpbCc7CgkJCWNhc2UgJ2ltYWdlJzoKCQkJCXJldHVybiAnaW1nJzsKCQkJY2FzZSAiYm9vbCI6CgkJCQlyZXR1cm4gJ2Noayc7CgkJCWNhc2UgIndpbmRvdyI6CgkJCQlyZXR1cm4gJ3BubCc7CgkJCWNhc2UgInByb2dyZXNzIjoKCQkJCXJldHVybiAncHJnJzsKCQkJY2FzZSAiZ3JpZCI6CgkJCWNhc2UgInRyZWUiOgoJCQljYXNlICJzZWxlY3QiOgoJCQkJcmV0dXJuICdjbWInOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuICcnOwoJCX0KCX0KCgljbGVhcihncm91cCkgewoJCXZhciBvID0ge307CgkJJC5lYWNoKHRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gZ3JvdXAgPyBlLmdyb3VwID09IGdyb3VwIDogdHJ1ZSksIChfLCBlKSA9PiB7CgkJCXZhciBuYW1lID0gKGUuZW1zU291cmNlID8gIl8iIDogIiIpICsgZS5uYW1lOwoJCQlzd2l0Y2ggKGUudHlwZSkgewoJCQkJY2FzZSAndGV4dCc6CgkJCQljYXNlICdzdHJpbmcnOgoJCQkJY2FzZSAnc2VhcmNoJzoKCQkJCWNhc2UgJ3Bhc3N3b3JkJzoKCQkJCWNhc2UgIkRhdGVUaW1lIjoKCQkJCWNhc2UgImRhdGV0aW1lIjoKCQkJCQlvW25hbWVdID0gIiI7CgkJCQkJYnJlYWs7CgkJCQljYXNlICJpbnQiOgoJCQkJY2FzZSAibnVtYmVyIjoKCQkJCWNhc2UgImludGVnZXIiOgoJCQkJY2FzZSAibG9uZyI6CgkJCQljYXNlICJMb25nIjoKCQkJCWNhc2UgInByb2dyZXNzIjoKCQkJCQlvW25hbWVdID0gMDsKCQkJCQlicmVhazsKCQkJCWNhc2UgInRyZWUiOgoJCQkJY2FzZSAic2VsZWN0IjoKCQkJCQlvW25hbWVdID0gbnVsbDsKCQkJCQlicmVhazsKCQkJCWNhc2UgImdyaWQiOgoJCQkJCW9bbmFtZV0gPyBvW25hbWVdLmRhdGEgPSBbXSA6IG51bGw7CgkJCQkJYnJlYWs7CgkJCQljYXNlICJib29sIjoKCQkJCQlvW25hbWVdID0gZmFsc2U7CgkJCQkJYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfSk7CgkJLy9jb25zb2xlLmxvZygiY2xlYXIiLCBvKTsKCQl0aGlzLnNldChvKTsKCQl0aGlzLmJ1c3koZmFsc2UpOwoJfQoKCXNldChvLCBlTmFtZSkgewoJCWlmIChlTmFtZSkgewoJCQl2YXIgb0VsZW1lbnQgPSB0aGlzLmJ5TmFtZShlTmFtZSk7CgkJCWlmICghb0VsZW1lbnQpIHJldHVybjsKCQkJdmFyIGF0dCA9IG51bGw7CgkJCWlmIChvICYmIG8uSWQgJiYgby5FbnRpdHlBdHRyaWJ1dGUpIHsKCQkJCS8vIGFuIEVudGl0eVZhbHVlCgkJCQlmb3IgKHZhciBwIGluIG8pCgkJCQkJaWYgKHAuZW5kc1dpdGgoIlZhbHVlIikpIGF0dCA9IHA7CgkJCQlvRWxlbWVudC5lbXNTb3VyY2UgPSBvOwoJCQl9CgkJCXRyeSB7CgkJCQlsZXQgZU5hbWUgPSAiIyIgKyB0aGlzLnByZWZpeChvRWxlbWVudCkgKyBvRWxlbWVudC5uYW1lOwoJCQkJbGV0IGVUeXBlID0gdGhpcy51aVR5cGVzW29FbGVtZW50LnR5cGVdOwoJCQkJLy8gY29uc29sZS5sb2coIkR5bmFGb3JtOjpzZXQoIiArIG9FbGVtZW50Lm5hbWUgKyAiKTogIiwgZU5hbWUsIGVUeXBlLCBvKTsKCQkJCXN3aXRjaCAob0VsZW1lbnQudHlwZSkgewoJCQkJCWNhc2UgJ2xhYmVsJzoKCQkJCQkJaWYgKGF0dCkgewoJCQkJCQkJJChlTmFtZSkuaHRtbChvW2F0dF0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJChlTmFtZSkuaHRtbCgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3RleHQnOgoJCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJY2FzZSAncGFzc3dvcmQnOgoJCQkJCWNhc2UgImludCI6CgkJCQkJY2FzZSAic2VhcmNoIjoKCQkJCQljYXNlICJpbnRlZ2VyIjoKCQkJCQljYXNlICJudW1iZXIiOgoJCQkJCWNhc2UgImxvbmciOgoJCQkJCWNhc2UgIkxvbmciOgoJCQkJCQlpZiAoYXR0KSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oInNldFZhbHVlIiwgb1thdHRdKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgic2V0VmFsdWUiLCAobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkRhdGVUaW1lIjoKCQkJCQljYXNlICJkYXRldGltZSI6CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCAob1thdHRdID8gdGhpcy5zcigpLnRvRGF0ZVRpbWUob1thdHRdKSA6ICIiKSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oJ3NldFZhbHVlJywgKG8gJiYgby5FbnRpdHlBdHRyaWJ1dGUpID8gIiIgOiAobyA/IHRoaXMuc3IoKS50b0RhdGVUaW1lKG8pIDogIiIpKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICJib29sIjoKCQkJCQkJaWYgKGF0dCkgewoJCQkJCQkJJChlTmFtZSlbZVR5cGVdKChvW2F0dF0gPyAnJyA6ICd1bicpICsgJ2NoZWNrJyk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkkKGVOYW1lKVtlVHlwZV0oKCgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pID8gJycgOiAndW4nKSArICdjaGVjaycpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIndpbmRvdyI6CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCW9FbGVtZW50LnZhbHVlID0gb1thdHRdOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJb0VsZW1lbnQudmFsdWUgPSAobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG87CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAicHJvZ3Jlc3MiOgoJCQkJCQl2YXIgdiA9IDA7CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCXYgPSBvW2F0dF07CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl2ID0gKG8gJiYgby5FbnRpdHlBdHRyaWJ1dGUpID8gIiIgOiBvOwoJCQkJCQl9CgkJCQkJCS8vY29uc29sZS5sb2coIiMiICsgdGhpcy5wcmVmaXgob0VsZW1lbnQpICsgb0VsZW1lbnQubmFtZSwgdGhpcy51aVR5cGVzW29FbGVtZW50LnR5cGVdLCBNYXRoLnJvdW5kKHYgKiAxMCkgLyAxMCk7CgkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCBNYXRoLnJvdW5kKHYgKiAxMCkgLyAxMCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgImdyaWQiOgoJCQkJCQlsZXQgY29scyA9IEpTT04ucGFyc2UoInsiICsgdGhpcy5tYXBDb2x1bW5zKG9FbGVtZW50LCB0cnVlKSArICJ9Iik7CgkJCQkJCSQuZWFjaChjb2xzLmNvbHVtbnNbMF0sIChfLCBjKSA9PiBjLmZvcm1hdHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQodGhpcy5mb3JtYXR0ZXIob0VsZW1lbnQubmFtZSwgYykpKTsKCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoY29scyk7CgkJCQkJCWlmIChhdHQpIHsKCQkJCQkJCSQoZU5hbWUpLmRhdGFncmlkKHsKCQkJCQkJCQlkYXRhOiBvW2F0dF0KCQkJCQkJCX0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoewoJCQkJCQkJCWRhdGE6IChvICYmIG8uRW50aXR5QXR0cmlidXRlKSA/ICIiIDogbwoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQkJJChlTmFtZSkuZGF0YWdyaWQoInVuc2VsZWN0QWxsIik7CgkJCQkJCSQoZU5hbWUpLmRhdGFncmlkKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgInRyZWUiOgoJCQkJCQl2YXIgdiA9IGF0dCA/IG9bYXR0XSA6ICgobyAmJiBvLkVudGl0eUF0dHJpYnV0ZSkgPyAiIiA6IG8pOwoJCQkJCQlpZiAoQXJyYXkuaXNBcnJheSh2KSkgewoJCQkJCQkJJChlTmFtZSlbZVR5cGVdKCJ0cmVlIikudHJlZSgibG9hZERhdGEiLCB2KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSQoZU5hbWUpW2VUeXBlXSgnc2V0VmFsdWUnLCB2KTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCQljYXNlICJzZWxlY3QiOgoJCQkJCQlpZiAoYXR0KSB7CgkJCQkJCQlpZiAob0VsZW1lbnQub3B0aW9ucykgewoJCQkJCQkJCSQoZU5hbWUpLmNvbWJvKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIChvW2F0dF0gPyBvW2F0dF0gOiAiIikpOwoJCQkJCQkJCSQoZU5hbWUpLmNvbWJvKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIChvW2F0dF0gPyBvW2F0dF0gOiAiIikpOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkkKGVOYW1lKS5jb21ib2dyaWQoJ3NldFZhbHVlJyArIChvRWxlbWVudC5tdWx0aXBsZSA/ICdzJyA6ICcnKSwgKG9bYXR0XSA/IG9bYXR0XSA6ICIiKSk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl2ID0gbnVsbDsKCQkJCQkJCWlmIChvID09PSBudWxsKSB7CgoJCQkJCQkJfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBBcnJheSkgewoKCQkJCQkJCX0gZWxzZSBpZiAoIW8uRW50aXR5QXR0cmlidXRlKSB7CgkJCQkJCQkJdiA9IG8gfHwgewoJCQkJCQkJCQlJZDogby5JZCwKCQkJCQkJCQkJX1RvU3RyaW5nOiBvLl9Ub1N0cmluZywKCQkJCQkJCQkJdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQkJcmV0dXJuIHRoaXMuX1RvU3RyaW5nOwoJCQkJCQkJCQl9CgkJCQkJCQkJfTsKCQkJCQkJCX0KCQkJCQkJCWlmIChvRWxlbWVudC5vcHRpb25zKSB7CgkJCQkJCQkJJChlTmFtZSkuY29tYm8oJ3NldFZhbHVlJyArIChvRWxlbWVudC5tdWx0aXBsZSA/ICdzJyA6ICcnKSwgdik7CgkJCQkJCQkJJChlTmFtZSkuY29tYm8oJ3NldFRleHQnICsgKG9FbGVtZW50Lm11bHRpcGxlID8gJ3MnIDogJycpLCB2KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJJChlTmFtZSkuY29tYm9ncmlkKCdzZXRWYWx1ZScgKyAob0VsZW1lbnQubXVsdGlwbGUgPyAncycgOiAnJyksIHYpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfSBlbHNlIHsKCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQlpZiAocC5pbmRleE9mKCdfJykgPT09IDApIHAgPSBwLnN1YnN0cmluZygxKTsKCQkJCXZhciBlID0gdGhpcy5ieU5hbWUocCk7CgkJCQlpZiAoIWUgfHwgIWUubmFtZSkgY29udGludWU7CgkJCQl2YXIgdmFsdWUgPSBvW3BdOwoJCQkJaWYgKGUubmFtZSA9PSB0aGlzLnNUYWJsZSkgewoJCQkJCXZhbHVlID0gbzsKCQkJCQl2YWx1ZS5EYXRlID0gbmV3IERhdGUoKTsKCQkJCX0KCQkJCWlmIChwID09ICJFbnRpdHlWYWx1ZXMiKSB7CgkJCQkJLy8gYW4gZW1zRm9ybVZhbHVlcyBzb3VyY2UKCQkJCQkvLyBmaW5kIHRoZSBFbnRpdHlWYWx1ZSBmb3IgdGhpcyBlbGVtZW50IGFuZCBzZXQgaXQKCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IG8uRW50aXR5VmFsdWVzLmxlbmd0aDsgaisrKSB7CgkJCQkJCWlmIChvLkVudGl0eVZhbHVlc1tqXS5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBlLm5hbWUpIHsKCQkJCQkJCS8vIGZvdW5kIHRoZSBFbnRpdHlWYWx1ZSBmb3IgdGhpcyBlbGVtZW50CgkJCQkJCQlfdiA9IG8uRW50aXR5VmFsdWVzW2pdOwoJCQkJCQkJZm9yICh2YXIgcSBpbiBfdikgewoJCQkJCQkJCWlmIChxLmVuZHNXaXRoKCJWYWx1ZSIpKSB7CgkJCQkJCQkJCV92W3FdID0gdmFsdWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQl0aGlzLnNldCh2YWx1ZSwgZS5uYW1lKTsKCQkJfQoJCX0KCX0KCglnZXQoKSB7CgkJdmFyIG8gPSB7fTsKCQlpZiAodGhpcy5zVGFibGUgJiYgd2luZG93W3RoaXMuc1RhYmxlXSkgbyA9IG5ldyB3aW5kb3dbdGhpcy5zVGFibGVdKCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBjbiA9IG51bGw7CgkJCXZhciB2ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWxldCBlTmFtZSA9ICIjIiArIHRoaXMucHJlZml4KHRoaXMuZWxlbWVudHNbaV0pICsgdGhpcy5lbGVtZW50c1tpXS5uYW1lOwoJCQkJc3dpdGNoICh0aGlzLmVsZW1lbnRzW2ldLnR5cGUpIHsKCQkJCQljYXNlICdsYWJlbCc6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi5odG1sKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ3RleHQnOgoJCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJY2FzZSAnc2VhcmNoJzoKCQkJCQljYXNlICdwYXNzd29yZCc6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi52YWwoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiZmlsZSI6CgkJCQkJY2FzZSAiaW1hZ2UiOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gdGhpcy5lbGVtZW50c1tpXS5kYXRhOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJEYXRlVGltZSI6CgkJCQkJY2FzZSAiZGF0ZXRpbWUiOgoJCQkJCQl2ID0gbmV3IERhdGUoJChlTmFtZSkuZGF0ZXRpbWVib3goJ2dldFZhbHVlJykpOwoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJwcm9ncmVzcyI6CgkJCQkJCWNuID0gJChlTmFtZSk7CgkJCQkJCXYgPSBjbi5wcm9ncmVzc2JhcignZ2V0VmFsdWUnKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiaW50IjoKCQkJCQljYXNlICJpbnRlZ2VyIjoKCQkJCQljYXNlICJudW1iZXIiOgoJCQkJCWNhc2UgImxvbmciOgoJCQkJCWNhc2UgIkxvbmciOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gcGFyc2VGbG9hdChjbi52YWwoKSk7CgkJCQkJCWlmIChpc05hTih2KSkgdiA9IDA7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgImdyaWQiOgoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQl2ID0gY24uZGF0YWdyaWQoJ2dldERhdGEnKTsKCQkJCQkJdi5zZWxlY3RlZCA9IGNuLmRhdGFncmlkKCJnZXRTZWxlY3RlZCIpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJ0cmVlIjoKCQkJCQkJY24gPSAkKGVOYW1lKTsKCQkJCQkJdiA9IGNuLmNvbWJvdHJlZSgidHJlZSIpLnRyZWUoImdldFNlbGVjdGVkIik7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIndpbmRvdyI6CgkJCQkJCXYgPSB0aGlzLmVsZW1lbnRzW2ldLnZhbHVlOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJzZWxlY3QiOgoJCQkJCQlpZiAodGhpcy5lbGVtZW50c1tpXS5vcHRpb25zKSB7CgkJCQkJCQl2ID0gJChlTmFtZSkuY29tYm9ncmlkKCdnZXRWYWx1ZScgKyAodGhpcy5lbGVtZW50c1tpXS5tdWx0aXBsZSA/ICdzJyA6ICcnKSk7CgkJCQkJCQl2ID0gdGhpcy5zcigpLnJ1blNjcmlwdCh2KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXYgPSAkKGVOYW1lKS5jb21ib2dyaWQoJ2dyaWQnKS5kYXRhZ3JpZCgnZ2V0U2VsZWN0aW9ucycpOwoJCQkJCQkJaWYgKCF2IHx8ICF2Lmxlbmd0aCkgewoJCQkJCQkJCXYgPSAkKGVOYW1lKS5jb21ib2dyaWQoJ2dldFZhbHVlJyArICh0aGlzLmVsZW1lbnRzW2ldLm11bHRpcGxlID8gJ3MnIDogJycpKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCF0aGlzLmVsZW1lbnRzW2ldLm11bHRpcGxlKSB2ID0gdlswXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQljbiA9ICQoZU5hbWUpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJib29sIjoKCQkJCQkJY24gPSAkKGVOYW1lKTsKCQkJCQkJdiA9IGNuLnN3aXRjaGJ1dHRvbignb3B0aW9ucycpLmNoZWNrZWQ7CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQkJb1t0aGlzLmVsZW1lbnRzW2ldLm5hbWVdKHYpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKHRoaXMuZWxlbWVudHNbaV0ubmFtZSwgZSk7CgkJCQlvW3RoaXMuZWxlbWVudHNbaV0ubmFtZV0gPSB2OwoJCQl9CgkJCWlmIChjbikgewoJCQkJaWYgKG8uRW50aXR5VmFsdWVzKSB7CgkJCQkJZm9yICh2YXIgaiA9IDA7IGogPCBvLkVudGl0eVZhbHVlcy5sZW5ndGg7IGorKykgewoJCQkJCQlpZiAodGhpcy5lbGVtZW50c1tpXS5uYW1lID09IHRoaXMuc1RhYmxlICYmIHRoaXMuZWxlbWVudHNbaV0uZW1zU291cmNlKSBvLklkID0gdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UuSWQ7CgkJCQkJCWlmIChvLkVudGl0eVZhbHVlc1tqXS5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSB0aGlzLmVsZW1lbnRzW2ldLm5hbWUgJiYgdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UpIHsKCQkJCQkJCW8uRW50aXR5VmFsdWVzW2pdLklkID0gdGhpcy5lbGVtZW50c1tpXS5lbXNTb3VyY2UuSWQ7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIG87Cgl9CgoJY0hlaWdodChvcHRpb25zKSB7CgkJaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lZGl0b3IpIHJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQ7CgkJaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5oZWlnaHQgJiYgdHlwZW9mKG9wdGlvbnMuaGVpZ2h0KSA9PT0gJ3N0cmluZycpIHJldHVybiB0aGlzLmhlaWdodDsKCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgPT0gJ3dpbmRvdycgJiYgIW9wdGlvbnMuaGVpZ2h0KSByZXR1cm4gdGhpcy5oZWlnaHQgKiAwLjk7CgkJcmV0dXJuIE1hdGguZmxvb3IoKChvcHRpb25zID8gb3B0aW9ucy5oZWlnaHQgOiBudWxsKSB8fCAodGhpcy5oZWlnaHQgLyAzKSkpOwoJfQoKCXNlYXJjaChvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuc3RyaW5nKG9wdGlvbnMpOwoJfQoKCXN0cmluZyhvcHRpb25zKSB7CgkJb3B0aW9ucy5oZWlnaHQgPSAyMDsKCQlvcHRpb25zLnNpbXBsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXMudGV4dChvcHRpb25zKTsKCX0KCglkYXRldGltZShvcHRpb25zKSB7CgkJcmV0dXJuIGA8aW5wdXQgaWQ9ImR0cCR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiPmA7Cgl9CgoJcXVlcnkob3B0aW9ucykgewoJCXJldHVybiAiPGRpdiBpZD0ndnMiICsgb3B0aW9ucy5uYW1lICsgIic+PC9kaXY+IjsKCX0KCglEYXRlVGltZShvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuZGF0ZXRpbWUob3B0aW9ucyk7Cgl9CgoJbG9uZyhvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuaW50KG9wdGlvbnMpOwoJfQoKCUxvbmcob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmxvbmcob3B0aW9ucyk7Cgl9CgoJdmFsdWUob3B0aW9ucykgewoJCWlmICh0eXBlb2Ygb3B0aW9ucy52YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl0cnkgewoJCQkJcmV0dXJuIG9wdGlvbnMudmFsdWUodGhpcy5nZXQoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhgREZvcm0udmFsdWUoJHtvcHRpb25zLm5hbWV9KTogJHtleH1gKTsKCQkJCXJldHVybiAnJzsKCQkJfQoJCX0gZWxzZSB7CgkJCXN3aXRjaCAob3B0aW9ucy50eXBlKSB7CgkJCQljYXNlICdpbnQnOgoJCQkJY2FzZSAncHJvZ3Jlc3MnOgoJCQkJCXJldHVybiBvcHRpb25zLnZhbHVlIHx8IG9wdGlvbnMubWluIHx8IDA7CgkJCQljYXNlICdzdHJpbmcnOgoJCQkJY2FzZSAndGV4dCc6CgkJCQljYXNlICdkYXRldGltZSc6CgkJCQljYXNlICdsYWJlbCc6CgkJCQkJcmV0dXJuIG9wdGlvbnMudmFsdWUgfHwgIiI7CgkJCQlkZWZhdWx0OgoJCQkJCXJldHVybiBvcHRpb25zLnZhbHVlOwoJCQl9CgkJfQoJfQoKCWludChvcHRpb25zKSB7CgkJbGV0IHJldCA9IGA8aW5wdXQgaWQ9Im51ZCR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgZGF0YS1vcHRpb25zPSJtaW46JHtvcHRpb25zLm1pbiB8fCAwfSxtYXg6JHtvcHRpb25zLm1heCB8fCAxMDB9LGluY3JlbWVudDoke29wdGlvbnMuaW5jcmVtZW50IHx8IDF9IiBzdHlsZT0id2lkdGg6JHt0aGlzLmNXaWR0aChvcHRpb25zKX1weDsiPjwvaW5wdXQ+YDsKCQkvL2NvbnNvbGUubG9nKHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCgltZW51KG9wdGlvbnMpIHsKCQlvcHRpb25zLnR5cGUgPSBvcHRpb25zLnR5cGUgfHwgJ21lbnUnOwoKCQlvcHRpb25zLm1lbnUgPSAob3B0aW9ucy5tZW51IHx8IFtdKS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7CgoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjptZW51KCk6IG9wdGlvbnMiLCBvcHRpb25zKTsKCgkJbGV0IHJldCA9ICIiOwoJCXJldCArPSAnPGRpdiBjbGFzcz0iZWFzeXVpLXBhbmVsIiBpZD0ibW51JyArIG9wdGlvbnMubmFtZSArICciIHN0eWxlPSJwYWRkaW5nOjVweDsiPlxuJzsKCgkJcmV0ICs9IG9wdGlvbnMubWVudS5tYXAobSA9PiBgPGEgaHJlZj0iIyIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJtZW51OicjbW0ke20ubGFiZWwucmVwbGFjZSgvIC9nLCAnJyl9JyxpY29uQ2xzOidpY29uLSR7bS5pY29uIHx8ICdub25lJ30nIj4ke20ubGFiZWx9PC9hPmApLmpvaW4oJ1xuJyk7CgoJCS8qJC5lYWNoKG9wdGlvbnMubWVudSwgKF8sIG0pID0+IHJldCArPSBgPGEgaHJlZj0iIyIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJtZW51OicjbW0ke20ubGFiZWwucmVwbGFjZSgvIC9nLCAnJyl9JyxpY29uQ2xzOidpY29uLSR7bS5pY29uIHx8ICdub25lJ30nIj4ke20ubGFiZWx9PC9hPlxuYCk7Ki8KCQlyZXQgKz0gIjwvZGl2PlxuIjsKCgkJbGV0IGR2ID0gbSA9PiB7CgkJCWxldCByZXQgPSAnPGRpdicgKyAobS5zdWJNZW51cyA/ICcnIDogYCBkYXRhLW9wdGlvbnM9Imljb25DbHM6J2ljb24tJHttLmljb24gfHwgJ25vbmUnfSciYCkgKyAnPlxuJzsKCQkJcmV0ICs9IG0uc3ViTWVudXMgPyAnPHNwYW4+JyArIChtLmxhYmVsIHx8IHRoaXMuZW5nbGlzaChtLmNvZGUpKSArICc8L3NwYW4+XG48ZGl2PicgOiAoYDxzcGFuIHdpZHRoPScxMDAlJyBvbmNsaWNrPScoYXN5bmMgKCkgPT4ge2xldCBtID0gJHtfRnJFTUQuX3RvSlMobSl9OyBpZihtLmFjdGlvbil7cmV0dXJuIGF3YWl0IG0uYWN0aW9uKERGb3JtLmdldCgpLCBtKTt9IGlmIChtLnN1Yk1lbnVzKSByZXR1cm47IGF3YWl0IF9GckVNRC5SZW5kZXJQYWdlKHtfY29kZTogbS5jb2RlIHx8IG0ubGFiZWwucmVwbGFjZSgvIC9nLCAiIikudG9Mb3dlckNhc2UoKX0sIG0uZGF0YSk7fSkoKSc+JHttLmxhYmVsIHx8IHRoaXMuZW5nbGlzaChtLmNvZGUpfTwvc3Bhbj5gKTsKCQkJJC5lYWNoKG0uc3ViTWVudXMsIChfLCBzKSA9PiByZXQgKz0gZHYocykpOwoJCQlyZXQgKz0gKG0uc3ViTWVudXMgPyAiPC9kaXY+XG4iIDogIiIpICsgYDwvZGl2PlxuYDsKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQlyZXQgKz0gb3B0aW9ucy5tZW51Lm1hcChtID0+IGA8ZGl2IGlkPSJtbSR7bS5sYWJlbC5yZXBsYWNlKC8gL2csICcnKX0iIHN0eWxlPSJ3aWR0aDoxNTBweDsiPiR7bS5zdWJNZW51cy5tYXAoc20gPT4gZHYoc20pKS5qb2luKCcnKX08L2Rpdj5gKS5qb2luKCdcbicpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWludGVnZXIob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmludChvcHRpb25zKTsKCX0KCgludW1iZXIob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmludChvcHRpb25zKTsKCX0KCglJbnRlZ2VyKG9wdGlvbnMpIHsKCQlyZXR1cm4gdGhpcy5pbnQob3B0aW9ucyk7Cgl9CgoJYm9vbChvcHRpb25zKSB7CgkJcmV0dXJuIGA8aW5wdXQgaWQ9IiR7dGhpcy5wcmVmaXgob3B0aW9ucyl9JHtvcHRpb25zLm5hbWV9IiBkYXRhLWRmb3JtPSJlbGVtZW50OiR7b3B0aW9ucy5uYW1lfSIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZD8ndHJ1ZSc6J2ZhbHNlJ30iIGRhdGEtb3B0aW9ucz0nZGlzYWJsZWQ6JHtvcHRpb25zLmRpc2FibGVkPyd0cnVlJzonZmFsc2UnfSwke3RoaXMuZXZlbnRIYW5kbGVycyhvcHRpb25zKX0nIGNsYXNzPSJlYXN5dWktJHt0aGlzLnVpVHlwZXNbb3B0aW9ucy50eXBlXX0iICR7b3B0aW9ucy5jaGVja2VkPydjaGVja2VkJzonJ30gLz5gOwoJfQoKCWxhYmVsKG9wdGlvbnMpIHsKCQlyZXR1cm4gYDxzcGFuIGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiIGRhdGEtb3B0aW9ucz0iZGlzYWJsZWQ6JHtvcHRpb25zLmRpc2FibGVkPyd0cnVlJzonZmFsc2UnfSI+JHt0aGlzLnZhbHVlKG9wdGlvbnMpfTwvc3Bhbj5gOwoJfQoKCXVybChvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuc3RyaW5nKG9wdGlvbnMpLnJlcGxhY2UoIkZpZWxkQ2hhbmdlIiwgIlVSTENoYW5nZSIpOwoJfQoKCXRleHQob3B0aW9ucykgewoJCXJldHVybiBgPGlucHV0IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke29wdGlvbnMuZWRpdG9yIHx8IHRoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSdkaXNhYmxlZDoke29wdGlvbnMuZGlzYWJsZWQ/J3RydWUnOidmYWxzZSd9LCR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfScgbXVsdGlsaW5lPSIke29wdGlvbnMuc2ltcGxlID8gJ2ZhbHNlJyA6ICd0cnVlJ30iIHN0eWxlPSJ3aGl0ZS1zcGFjZTpwcmUtd3JhcDt3aWR0aDoke3RoaXMuY1dpZHRoKG9wdGlvbnMpfXB4O2hlaWdodDoke3RoaXMuY0hlaWdodChvcHRpb25zKX1weCIgcmVxdWlyZWQ9IiR7b3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZSd9IiB2YWx1ZT0iJHt0aGlzLnZhbHVlKG9wdGlvbnMpfSIgLz5gOwoJfQoKCXBhc3N3b3JkKG9wdGlvbnMpIHsKCQl2YXIgcmV0ID0gdGhpcy5zdHJpbmcob3B0aW9ucyk7CgkJcmV0ID0gcmV0LnJlcGxhY2UoJzxpbnB1dCAnLCAnPGlucHV0IHR5cGU9InBhc3N3b3JkIiAnKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWZpbGUob3B0aW9ucykgewoJCXJldHVybiBgPGlucHV0IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJvbkNoYW5nZTpmdW5jdGlvbihuLG8pe3ZhciBzID0gJCgnIycgKyB0aGlzLmlkKS5maWxlYm94KCdvcHRpb25zJyk7IERGb3JtLlVwbG9hZEZpbGUocywgREZvcm0uYnlOYW1lKCcke29wdGlvbnMubmFtZX0nKSk7fSIgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHgiPmA7Cgl9CgoJaW1hZ2Uob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmZpbGUob3B0aW9ucykgKyBgPGRpdiBpZD0iZGxnJHtvcHRpb25zLm5hbWV9IiBjbGFzcz0iZWFzeXVpLSR7dGhpcy51aVR5cGVzW29wdGlvbnMudHlwZV19IiB0aXRsZT0iSW1hZ2UgUHJldmlldyIgZGF0YS1vcHRpb25zPSJjbG9zZWQ6dHJ1ZSxpY29uQ2xzOidpY29uLXNhdmUnLHJlc2l6YWJsZTpmYWxzZSxtb2RhbDp0cnVlIiBzdHlsZT0id2lkdGg6NDAwcHg7aGVpZ2h0OjIwMHB4O3BhZGRpbmc6MTBweCI+PGltZyBpZD0iJHt0aGlzLnByZWZpeChvcHRpb25zKX0ke29wdGlvbnMubmFtZX0iIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiLz48L2Rpdj5gOwoJfQoKCXByb2dyZXNzKG9wdGlvbnMpIHsKCQlpZiAoIW9wdGlvbnMuaGVpZ2h0KSBvcHRpb25zLmhlaWdodCA9IDIwOyAvLyBmaXggYmlnIHByb2dyZXNzCgkJcmV0dXJuIGA8ZGl2IGlkPSIke3RoaXMucHJlZml4KG9wdGlvbnMpfSR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS0ke3RoaXMudWlUeXBlc1tvcHRpb25zLnR5cGVdfSIgZGF0YS1vcHRpb25zPSJ2YWx1ZToke3RoaXMudmFsdWUob3B0aW9ucyl9IiBzdHlsZT0id2lkdGg6JHt0aGlzLmNXaWR0aChvcHRpb25zKX1weDtoZWlnaHQ6JHt0aGlzLmNIZWlnaHQob3B0aW9ucyl9cHgiPjwvZGl2PmA7Cgl9CgoJZmxvd2NoYXJ0KG9wdGlvbnMpIHsKCQlyZXR1cm4gYDxkaXYgaWQ9ImZsdyR7b3B0aW9ucy5uYW1lfSIgd2lkdGg9IiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9IiBoZWlnaHQ9IiR7dGhpcy5jSGVpZ2h0KG9wdGlvbnMpfSI+PC9kaXY+YDsKCX0KCgljaGFydChvcHRpb25zKSB7CgkJcmV0dXJuIGA8ZGl2IGlkPSJjaHQke29wdGlvbnMubmFtZX0iIHdpZHRoPSIke3RoaXMuY1dpZHRoKG9wdGlvbnMpfSIgaGVpZ2h0PSIke3RoaXMuY0hlaWdodChvcHRpb25zKX0iPjwvZGl2PmA7Cgl9CgoJZm9ybWF0dGVyKG5hbWUsIGMsIGpzb24pIHsKCQlqc29uID0ganNvbiA/ICciJyA6ICcnOwoJCXJldHVybiBgJHtqc29ufSh2YWx1ZSwgcm93LCBpbmRleCkgPT4ge3RyeXt2YXIgYyA9IChERm9ybS5ieU5hbWUoXGAke25hbWV9XGApLmNvbHVtbnMgfHwgW10pLmZpbmQoYyA9PiBjLmZpZWxkPT1cYCR7Yy5maWVsZH1cYCk7IHJldHVybiBjJiZjLmZvcm1hdD9jLmZvcm1hdCh2YWx1ZSxyb3csaW5kZXgpOnZhbHVlO31jYXRjaChleCl7cmV0dXJuIHZhbHVlO30gfSR7anNvbn1gOwoJfQoKCW1hcENvbHVtbnMob3B0aW9ucywganNvbikgewoJCWxldCBjVGl0bGUgPSBjID0+IGMudGl0bGUgfHwgdGhpcy5lbmdsaXNoKGMuZmllbGQpOwoKCQl2YXIgY29scyA9ICQuZ3JlcChvcHRpb25zLmNvbHVtbnMgfHwgW10sIGMgPT4gIWMuaWdub3JlKTsKCQlsZXQgcmV0ID0gIiI7CgkJaWYgKG9wdGlvbnMubXVsdGlwbGUpIHJldCArPSBgeyJmaWVsZCI6J2NrJywiY2hlY2tib3giOnRydWV9LGA7CgkJcmV0ID0gYCJmcm96ZW5Db2x1bW5zIjogW1tgOwoJCWlmICghb3B0aW9ucy5mcm96ZW4pIHsKCQkJcmV0ICs9IGB7ImZpZWxkIjoiJHtvcHRpb25zLmlkRmllbGQuZmllbGR9IiwidGl0bGUiOiAiJHtvcHRpb25zLmlkRmllbGQudGl0bGV9Iiwic29ydGFibGUiOiAidHJ1ZSIsICJmb3JtYXR0ZXIiOiAke3RoaXMuZm9ybWF0dGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucy5pZEZpZWxkLCBqc29uKX19LGA7CgkJCWlmIChvcHRpb25zLnRleHRGaWVsZC5maWVsZCAhPSBvcHRpb25zLmlkRmllbGQuZmllbGQpIHJldCArPSBgeyJmaWVsZCI6IiR7b3B0aW9ucy50ZXh0RmllbGQuZmllbGQgfHwgb3B0aW9ucy50ZXh0RmllbGQudGl0bGV9IiwidGl0bGUiOiIke29wdGlvbnMudGV4dEZpZWxkLnRpdGxlIHx8IG9wdGlvbnMudGV4dEZpZWxkLmZpZWxkfSIsIndpZHRoIjoiJHtvcHRpb25zLnRleHRGaWVsZC53aWR0aHx8MTIwfSIsICJzb3J0YWJsZSI6ICJ0cnVlIiwgImZvcm1hdHRlciI6ICR7dGhpcy5mb3JtYXR0ZXIob3B0aW9ucy5uYW1lLCBvcHRpb25zLnRleHRGaWVsZCwganNvbil9fWA7CgkJfSBlbHNlIHsKCQkJJC5tYXAoJC5ncmVwKGNvbHMsIGMgPT4gYy5mcm96ZW4pLCBjID0+IGB7ImZpZWxkIjoiJHtjLmZpZWxkIHx8IGNUaXRsZShjKX0iLCJ0aXRsZSI6IiR7Y1RpdGxlKGMpIHx8IGMuZmllbGR9Iiwid2lkdGgiOiIke2Mud2lkdGh8fDEyMH0iLCJhbGlnbiI6J2xlZnQnLCJzb3J0YWJsZSI6InRydWUiLCAiZm9ybWF0dGVyIjogJHt0aGlzLmZvcm1hdHRlcihvcHRpb25zLm5hbWUsIGMsIGpzb24pfX1gKS5qb2luKCIsIik7CgkJfQoJCXJldCArPSBgXV0sICJjb2x1bW5zIjogW1tgOwoJCXJldCArPSAkLm1hcCgkLmdyZXAoY29scywgYyA9PiAhYy5mcm96ZW4pLCBjID0+IGB7ImZpZWxkIjoiJHtjLmZpZWxkIHx8IGNUaXRsZShjKX0iLCJ0aXRsZSI6IiR7Y1RpdGxlKGMpIHx8IGMuZmllbGR9IiwiYWxpZ24iOiJsZWZ0Iiwic29ydGFibGUiOiJ0cnVlIiwgImZvcm1hdHRlciI6ICR7dGhpcy5mb3JtYXR0ZXIob3B0aW9ucy5uYW1lLCBjLCBqc29uKX19YCkuam9pbigiLCIpOwoJCXJldCArPSAnXV0nOwoKCQkvL2NvbnNvbGUubG9nKCJEeW5hRm9ybTo6bWFwQ29sdW1ucygiICsgb3B0aW9ucy5uYW1lICsgIik6ICIsIHJldCwganNvbik7CgkJcmV0dXJuIHJldDsKCX0KCglzZWxlY3Qob3B0aW9ucywgdGFnID0gb3B0aW9ucy50YWcsIHR5cGUpIHsKCQlyZXR1cm4gdGhpcy5jb21ibyhvcHRpb25zLCB0YWcsIHR5cGUpOwoJfQoKCXRyZWUob3B0aW9ucykgewoJCXJldHVybiB0aGlzLnNlbGVjdChvcHRpb25zLCAic2VsZWN0Iik7Cgl9CgoJbmF2aWdhdGlvbihvcHRpb25zKSB7CgkJcmV0dXJuIHRoaXMuY29tYm8ob3B0aW9ucywgJ3VsJywgJ3RyZWUnKTsKCX0KCgljb21ibyhvcHRpb25zLCB0YWcsIHR5cGUpIHsKCQl2YXIgY29scyA9ICQuZ3JlcChvcHRpb25zLmNvbHVtbnMgfHwgW10sIGMgPT4gIWMuaWdub3JlKTsKCQl0YWcgPSB0YWcgfHwgInNlbGVjdCI7CgoJCW9wdGlvbnMuaWRGaWVsZCA9ICQudW5pcXVlU29ydChbewoJCQlmaWVsZDogb3B0aW9ucy5pZEZpZWxkLAoJCQl0aXRsZTogb3B0aW9ucy5pZEZpZWxkCgkJfV0uY29uY2F0KCQuZ3JlcChjb2xzLCBjID0+IGMucHJpbWFyeSksIFt7CgkJCWZpZWxkOiAnSWQnLAoJCQl0aXRsZTogJ0lEJwoJCX1dKSkuZmluZCh4ID0+IHR5cGVvZih4LmZpZWxkKSAhPT0gInVuZGVmaW5lZCIpOwoKCQlvcHRpb25zLnRleHRGaWVsZCA9ICQudW5pcXVlU29ydChbewoJCQlmaWVsZDogb3B0aW9ucy50ZXh0RmllbGQsCgkJCXRpdGxlOiBvcHRpb25zLnRleHRGaWVsZAoJCX1dLmNvbmNhdCgkLmdyZXAoY29scywgYyA9PiBjLmRpc3BsYXkpLCBbewoJCQlmaWVsZDogJ19Ub1N0cmluZycsCgkJCXRpdGxlOiBvcHRpb25zLm5hbWUsCgkJfV0pKS5maW5kKHggPT4gdHlwZW9mKHguZmllbGQpICE9PSAidW5kZWZpbmVkIik7CgoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpjb21ibygpOiBvcHRpb25zIiwgb3B0aW9ucyk7CgoJCXZhciBmdW4gPSB0eXBlIHx8IHRoaXMuZUZ1bihvcHRpb25zKTsKCgkJdmFyIGRyb3Bkb3duID0gWydjb21ib3RyZWVncmlkJywgJ2NvbWJvdHJlZScsICdjb21ib2dyaWQnLCAnc2VsZWN0J10uaW5kZXhPZihmdW4pID4gLTE7CgkJaWYgKGRyb3Bkb3duKSB0aGlzLnNlbGVjdHMucHVzaCh7CgkJCWlkOiAiY21iIiArIG9wdGlvbnMubmFtZSwKCQkJb3B0aW9uczogdGhpcy5ieU5hbWUob3B0aW9ucy5uYW1lKQoJCX0pOwoJCXRoaXMuc2VsZWN0cyA9ICQudW5pcXVlU29ydCh0aGlzLnNlbGVjdHMpOwoJCXZhciByZXQgPSBgPCR7dGFnfSBpZD0iY21iJHtvcHRpb25zLm5hbWV9IiBjbGFzcz0iZWFzeXVpLSR7ZnVufSIgc3R5bGU9Im1heC13aWR0aDoke2Ryb3Bkb3duPyc0MDBweCc6dGhpcy5jV2lkdGgob3B0aW9ucyl9OyB3aWR0aDoke3RoaXMuY1dpZHRoKG9wdGlvbnMpfXB4IiByZXF1aXJlZD0iJHsob3B0aW9ucy5yZXF1aXJlZCA/ICd0cnVlJyA6ICdmYWxzZScpfSIgZGF0YS1vcHRpb25zPSdkaXNhYmxlZDoke29wdGlvbnMuZGlzYWJsZWQ/J3RydWUnOidmYWxzZSd9LCR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfSwgdmFsdWU6IiR7dGhpcy52YWx1ZShvcHRpb25zKX0iLCByb3dudW1iZXJzOiR7dHlwZW9mKG9wdGlvbnMucm93TnVtYmVycykhPT0ndW5kZWZpbmVkJz9vcHRpb25zLnJvd051bWJlcnM6KGZ1bi5pbmRleE9mKCd0cmVlJyk8LTE/J2ZhbHNlJzondHJ1ZScpfSwgcGFnaW5hdGlvbjoke3R5cGVvZihvcHRpb25zLnBhZ2luYXRpb24pIT09J3VuZGVmaW5lZCc/b3B0aW9ucy5wYWdpbmF0aW9uOihmdW4uaW5kZXhPZigndHJlZScpPC0xPydmYWxzZSc6J3RydWUnKX0sIHBhbmVsV2lkdGg6JHsyKnRoaXMuY1dpZHRoKG9wdGlvbnMpfSwgZml0Q29sdW1uczogdHJ1ZSwgc2luZ2xlU2VsZWN0OiB0cnVlLCBtdWx0aXBsZTokeyhvcHRpb25zLm11bHRpcGxlIHx8ICdmYWxzZScpfSwgaWRGaWVsZDogIiR7b3B0aW9ucy5pZEZpZWxkLmZpZWxkfSIsIGVuYWJsZUZpbHRlcjogJHtvcHRpb25zLmZpbHRlcj8ndHJ1ZSc6J2ZhbHNlJ30sIG5vd3JhcDogZmFsc2UsIHRleHRGaWVsZDogIiR7b3B0aW9ucy50ZXh0RmllbGQuZmllbGR9IiwgdHJlZUZpZWxkOiAiJHtvcHRpb25zLnRleHRGaWVsZC5maWVsZH0iLGA7CgkJaWYgKGZ1bi5pbmRleE9mKCd0cmVlJykgPT0gLTEpIHsKCQkJcmV0ICs9ICdmaXRDb2x1bW5zOiBmYWxzZSwnICsgdGhpcy5tYXBDb2x1bW5zKG9wdGlvbnMpOwoJCX0KCQlpZiAob3B0aW9ucy5kYXRhKSB7CgkJCXJldCArPSBgLGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucy5kYXRhKX1gOwoJCX0KCQlyZXQgKz0gYCc+YDsKCQlpZiAob3B0aW9ucy5vcHRpb25zKSB7CgkJCXJldCArPSAkLm1hcChvcHRpb25zLm9wdGlvbnMsIG8gPT4gYDxvcHRpb24gdmFsdWU9JyR7X0ZyRU1ELl90b0pTKG8pfSc+JHtvLm5hbWUgfHwgb308L29wdGlvbj5gKS5qb2luKCdcbicpOwoJCX0KCQlyZXQgKz0gYDwvJHt0YWd9PmA7CgkJLy8gY29uc29sZS5sb2cocmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWdyaWQob3B0aW9ucywgdGFnLCB0eXBlKSB7CgkJcmV0dXJuIHRoaXMuY29tYm8ob3B0aW9ucywgInRhYmxlIiwgImRhdGFncmlkIik7Cgl9CgoJdHJlZWdyaWQob3B0aW9ucykgewoJCXJldHVybiB0aGlzLmNvbWJvKG9wdGlvbnMsICd0YWJsZScsICd0cmVlJyk7Cgl9CgoJYXN5bmMgZG9MaW5rKGUsIGV2ZW50KSB7CgkJdGhpcy5idXN5KHRydWUpOwoJCXRyeSB7CgkJCWF3YWl0IGUubGlua3MuZmluZChsID0+IGwubGFiZWwgPT0gZXZlbnQudGFyZ2V0LmlubmVyVGV4dCkub25DbGljayh0aGlzLmdldCgpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRHluYUZvcm06OmRvTGluaygpOiBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJRWRpdGVkVmFsdWUoZSkgewoJCXJldHVybiAodHlwZW9mKGFjZSkgIT09ICJ1bmRlZmluZWQiKSA/IGFjZS5lZGl0KCdwbmwnICsgZS5uYW1lKS5zZXNzaW9uLmdldFZhbHVlKCkgOiAnJzsKCX0KCglhc3luYyBQYW5PbkNsb3NlKGUpIHsKCQlpZiAoZS5lZGl0b3IpIHsKCQkJZS52YWx1ZSA9IHRoaXMuRWRpdGVkVmFsdWUoZSk7CgkJfQoJCWlmIChlLmNsb3NlKSB7CgkJCWF3YWl0IGUuY2xvc2UodGhpcy5nZXQoKSk7CgkJfQoJfQoKCWFzeW5jIFBlbmRBZnRlck9wZW4oZSkgewoJCWlmIChlLmVkaXRvciAmJiB0eXBlb2YoYWNlKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJYXdhaXQgX0ZyRU1ELk9wZW5FZGl0b3IoJ3BubCcgKyBlLm5hbWUgLyorICctY2VudGVyJyovICwgZS5sYW5ndWFnZSwgZS5sb2FkZXIgfHwgKG8gPT4gZS52YWx1ZSksIGUuc2F2ZXIsIHRoaXMuZ2V0KCksIGUpOwoJCX0KCQlpZiAoZS5vcGVuKSB7CgkJCWF3YWl0IGUub3Blbih0aGlzLmdldCgpKTsKCQl9Cgl9CgoJbGluayhvcHRpb25zKSB7CgkJcmV0dXJuIChvcHRpb25zLmxpbmtzIHx8IFtdKS5maWx0ZXIobCA9PiAhbC5pZ25vcmUpLm1hcChsID0+IGA8YSBocmVmPSIjIiBjbGFzcz0iZWFzeXVpLSR7dGhpcy51aVR5cGVzW29wdGlvbnMudHlwZV19IiBkYXRhLW9wdGlvbnM9JyR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfSwgaWNvbkNsczoiaWNvbi0ke2wuaWNvbiB8fCAnb2snfSInPiR7bC5sYWJlbH08L2E+YCkuam9pbignXG4nKTsKCX0KCglhc3luYyBTZXRUcmVlRGF0YShlLCBuLCBkYXRhKSB7CgkJJC5lYWNoKCQoIiNjbWIiICsgZS5uYW1lKVt0aGlzLmVGdW4oZSldKCd0cmVlJykudHJlZSgiZ2V0Q2hpbGRyZW4iLCBuLnRhcmdldCksIChfLCBjKSA9PiAkKCIjY21iIiArIGUubmFtZSlbdGhpcy5lRnVuKGUpXSgndHJlZScpLnRyZWUoInJlbW92ZSIsIGMudGFyZ2V0KSk7CgkJJCgiI2NtYiIgKyBlLm5hbWUpW3RoaXMuZUZ1bihlKV0oJ3RyZWUnKS50cmVlKCJhcHBlbmQiLCB7CgkJCXBhcmVudDogbi50YXJnZXQsCgkJCWRhdGE6IGRhdGEKCQl9KTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglhc3luYyBFeHBhbmQoZSwgbikgewoJCXRoaXMuU2V0VHJlZURhdGEoZSwgbiwgW3sKCQkJaWQ6IG51bGwsCgkJCXRleHQ6ICJsb2FkaW5nLi4uIgoJCX1dKTsKCQl2YXIgb2JqID0ge307CgkJdmFyIHBGaWVsZCA9IGUucGFyZW50RmllbGQgfHwgJC5tYXAoJC5ncmVwKGUuY29sdW1ucyB8fCBbXSwgYyA9PiBjLnBhcmVudCksIGMgPT4gYy5maWVsZCkuY29uY2F0KFtudWxsXSlbMF07CgkJdmFyIGlkRmllbGQgPSAkLmdyZXAoZS5jb2x1bW5zIHx8IFtdLCBjID0+IGMucHJpbWFyeSkuY29uY2F0KGUuaWRGaWVsZClbMF0uZmllbGQ7CgkJaWYgKHBGaWVsZCkgewoJCQlvYmpbcEZpZWxkXSA9IHsKCQkJCV9zb3VyY2U6IG4uX3NvdXJjZQoJCQl9OwoJCQlpZiAoaWRGaWVsZCkgewoJCQkJb2JqW3BGaWVsZF1baWRGaWVsZF0gPSBuLmlkOwoJCQl9IGVsc2UgewoJCQkJb2JqW3BGaWVsZF0gPSBuLmlkOwoJCQl9CgkJfQoJCWxldCBkYXRhID0gYXdhaXQgdGhpcy5fbG9hZERhdGEoewoJCQlpZDogImNtYiIgKyBlLm5hbWUsCgkJCW9wdGlvbnM6IGUKCQl9LCBvYmopOwoJCXRoaXMuU2V0VHJlZURhdGEoZSwgbiwgZGF0YSk7Cgl9CgoJYXN5bmMgX2xvYWREYXRhKHMsIG8sIHN0YXJ0LCBlbmQpIHsKCQl2YXIgbmFtZSA9IChzICYmIHMub3B0aW9ucyA/IChzLm9wdGlvbnMuQ2xhc3MgPyBzLm9wdGlvbnMuQ2xhc3MuTmFtZS5yZXBsYWNlKCcgJywgJ18nKSA6IChzLm9wdGlvbnMudGFibGUgfHwgcy5vcHRpb25zLm5hbWUpKSA6IHMubmFtZSk7CgkJbmFtZSA9IG5hbWUudHJpbSgpOyAvLy5zcGxpdCgnLicpLnNsaWNlKC0xKVswXTsKCgkJbGV0IG9TY29wZSA9ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuU2NvcGUpID8gd2luZG93W2NvbXBhbnkuU2NvcGVdIDogd2luZG93OwoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpfbG9hZERhdGEoKTogb1Njb3BlIiwgb1Njb3BlKTsKCgkJbyA9IG8gfHwgKChvU2NvcGUgJiYgb1Njb3BlW25hbWVdKSA/IG5ldyBvU2NvcGVbbmFtZV0oKSA6IHsKCQkJQWN0aXZlOiB0cnVlLAoJCX0pOwoKCQlvID0gKHR5cGVvZiBmaWx0ZXJzICE9PSAidW5kZWZpbmVkIiAmJiBmaWx0ZXJzICYmIGZpbHRlcnNbbmFtZV0pID8gZmlsdGVyc1tuYW1lXShvKSA6IG87CgkJdmFyIGZ1biA9IHRoaXMuZUZ1bihzLm9wdGlvbnMpOwoJCWxldCBzVGV4dCA9ICQoIiMiICsgcy5pZClbZnVuXSgnZ2V0VGV4dCcpOwoKCQlvID0gKHMgJiYgcy5vcHRpb25zICYmIHMub3B0aW9ucy5zb3VyY2UpID8gcy5vcHRpb25zLnNvdXJjZShvLCB0aGlzLmdldCgpLCBzVGV4dCkgOiBvOwoJCWxldCBuYW1lcyA9ICQudW5pcXVlU29ydChbcy5vcHRpb25zLnNlYXJjaEZpZWxkXS5jb25jYXQoJC5tYXAoJC5ncmVwKHMub3B0aW9ucy5jb2x1bW5zIHx8IFtdLCBjID0+IGMuc2VhcmNoKSwgYyA9PiBjLmZpZWxkKSwgWyJOYW1lIl0pKS5maWx0ZXIodiA9PiB2KTsKCQlpZiAoIW9bbmFtZXNbMF1dKSBvW25hbWVzWzBdXSA9IHNUZXh0OwoJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpfbG9hZERhdGEoKTogbyIsIG8pOwoJCXZhciBkYXRhID0gbnVsbDsKCgkJbGV0IGxpYiA9ICcnOwoJCWlmIChuYW1lLmluZGV4T2YoJy4nKSA+IDApIHsKCQkJbGliID0gbmFtZS5zcGxpdCgnLicpWzBdICsgJy4nOwoJCQluYW1lID0gbmFtZS5zcGxpdCgnLicpWzFdOwoJCX0KCgkJaWYgKHMub3B0aW9ucy5sb2FkZXIpIHsKCQkJZGF0YSA9IGF3YWl0IHMub3B0aW9ucy5sb2FkZXIodGhpcy5nZXQoKSwgcy5vcHRpb25zLCBvLCBzVGV4dCk7CgkJfSBlbHNlIGlmIChvICYmIHR5cGVvZihvLmZpbmRBbGwpID09PSAnZnVuY3Rpb24nKSB7CgkJCWRhdGEgPSBhd2FpdCBvLmZpbmRBbGwoKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5saWJyYXJ5ICYmIGNvbXBhbnkuQ29kZSAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCS8vY29uc29sZS5sb2coIkRGb3JtOjpfbG9hZERhdGEoKTogc3IoKS5fKCIgKyBsaWIgKyBjb21wYW55LkNvZGUudG9Mb3dlckNhc2UoKSArIG5hbWUgKyAiRmluZGFsbCIgKyAiKSIsIG8pOwoJCQlkYXRhID0gYXdhaXQgdGhpcy5zcigpLl8obGliICsgY29tcGFueS5Db2RlLnRvTG93ZXJDYXNlKCkgKyBuYW1lICsgIkZpbmRhbGwiLCBudWxsLCBvLCBudWxsLCBzdGFydCwgZW5kKTsKCQl9IGVsc2UgaWYgKF9GckVNRC5hcGlTZXJ2ZXIpIHsKCQkJbyA9IE9iamVjdC5hc3NpZ24oLi4uT2JqZWN0LmtleXMobykubWFwKGsgPT4gKHsKCQkJCVtTdHJpbmcoaykuY2hhckF0KDApLnRvTG93ZXJDYXNlKCkgKyBTdHJpbmcoaykuc2xpY2UoMSldOiBvW2tdCgkJCX0pKSk7CgkJCS8vY29uc29sZS5sb2coIkRGb3JtOjpfbG9hZERhdGEoKTogdXNpbmcgX0ZyRU1ELmFwaVNlcnZlcjogbyIsIG8pOwoJCQlkYXRhID0gYXdhaXQgX0ZyRU1ELmFwaVNlcnZlci5fbmV3KG5hbWUpLl9mcm9tRG9jdW1lbnQobykuZmluZEFsbCgpOwoJCQkvL2RhdGEuZmlsdGVyKGQgPT4gZC5JZCAhPSBkLklkKS5mb3JFYWNoKGQgPT4gZC5JZCA9IGQuX3V1aWQobnVsbCwgbnVsbCwgdHJ1ZSkpOwoJCX0KCgkJaWYgKHMub3B0aW9ucy5wb3N0bG9hZCkgewoJCQlhd2FpdCBzLm9wdGlvbnMucG9zdGxvYWQoZGF0YSk7CgkJfQoJCSQuZWFjaChkYXRhLCAoaSwgZCkgPT4gewoJCQlkLl9fT1dORVIgPSBzOwoJCQkkLmVhY2gocy5vcHRpb25zLmNvbHVtbnMsIChfLCBjKSA9PiB7CgkJCQlpZiAoYy52YWx1ZSkgewoJCQkJCWRbYy5maWVsZF0gPSBjLnZhbHVlKGQsIGRhdGEsIGkpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlpZiAoIXMub3B0aW9ucy5jb2x1bW5zICYmIGZ1bi5pbmRleE9mKCd0cmVlJykgPiAtMSkgewoJCQlkYXRhID0gJC5tYXAoZGF0YSwgZCA9PiB7CgkJCQlsZXQgcmV0ID0gewoJCQkJCWlkOiBkW3Mub3B0aW9ucy5pZEZpZWxkLmZpZWxkXSwKCQkJCQl0ZXh0OiBkW3Mub3B0aW9ucy50ZXh0RmllbGQuZmllbGRdLAoJCQkJCXN0YXRlOiBkLnN0YXRlIHx8IChzLm9wdGlvbnMubG9hZGVyID8gImZpbGUiIDogImNsb3NlZCIpLAoJCQkJCV9zb3VyY2U6IGQsCgkJCQl9OwoJCQkJcmV0LmNoaWxkcmVuID0gKHJldC5zdGF0ZSA9PSAiY2xvc2VkIikgPyBbewoJCQkJCXRleHQ6ICdsb2FkaW5nLi4uJwoJCQkJfV0gOiBudWxsOwoJCQkJcmV0dXJuIHJldDsKCQkJfSk7CgkJfQoJCXJldHVybiBkYXRhIHx8IFtdOwoJfQoKCWFzeW5jIGZpbGxEYXRhKGcsIG8sIHN0YXJ0LCBlbmQpIHsKCQl2YXIgcyA9IG51bGw7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMuc2VsZWN0c1tpXS5pZCA9PSBnWzBdLmlkKSBzID0gdGhpcy5zZWxlY3RzW2ldOwoJCX0KCQlpZiAoIXMpIHJldHVybjsKCQl0aGlzLmJ1c3kodHJ1ZSk7CgkJdHJ5IHsKCQkJdmFyIGZ1biA9IGdbMF0uY2xhc3NMaXN0WyIwIl0ucmVwbGFjZSgnZWFzeXVpLScsICcnKTsKCQkJdHJ5IHsKCQkJCSQoIiMiICsgcy5pZClbZnVuXSgnZ3JpZCcpLmRhdGFncmlkKCdnZXRQYWdlcicpLnBhZ2luYXRpb24oJ2xvYWRpbmcnKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChzLm9wdGlvbnMubm9sb2FkKSB7CgkJCQlsZXQgX2RhdGEgPSBudWxsOwoJCQkJdHJ5IHsKCQkJCQlfZGF0YSA9ICQoIiMiICsgcy5pZClbZnVuXSgnZ3JpZCcpLmRhdGFncmlkKCJnZXREYXRhIik7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCV9kYXRhID0gJCgiIyIgKyBzLmlkKVtmdW5dKCd0cmVlJykudHJlZSgnZ2V0Um9vdCcpOwoJCQkJfQoJCQkJaWYgKF9kYXRhKSB7CgkJCQkJcmV0dXJuIHRoaXMuYnVzeShmYWxzZSk7CgkJCQl9CgkJCX0KCQkJdmFyIGRhdGEgPSBhd2FpdCB0aGlzLl9sb2FkRGF0YShzLCBvLCBzdGFydCwgZW5kKTsKCQkJdHJ5IHsKCQkJCWlmICgkKCIjIiArIHMuaWQpW2Z1bl0oJ2dyaWQnKSkgJCgiIyIgKyBzLmlkKVtmdW5dKCdncmlkJykuZGF0YWdyaWQoJ2dldFBhZ2VyJykucGFnaW5hdGlvbignbG9hZGVkJyk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl0cnkgewoJCQkJJCgiIyIgKyBzLmlkKVtmdW5dKCdncmlkJykuZGF0YWdyaWQoJ2xvYWREYXRhJywgewoJCQkJCXRvdGFsOiBkYXRhLkNvdW50IHx8IGRhdGEubGVuZ3RoLAoJCQkJCXJvd3M6IGRhdGEsCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCSQoIiMiICsgcy5pZClbZnVuXSgndHJlZScpLnRyZWUoJ2xvYWREYXRhJywgZGF0YSk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJZXZlbnRIYW5kbGVycyhvcHRpb25zKSB7CgkJLy9jb25zb2xlLmxvZygiRHluYUZvcm06OmV2ZW50SGFuZGxlcnMoKTogb3B0aW9ucyIsIG9wdGlvbnMpOwoJCWlmICghdGhpcy5ieU5hbWUob3B0aW9ucy5uYW1lKSkgcmV0dXJuOyAvLyBpZiBub3QgYW4gZWxlbWVudCwgZG8gbm90IHJ1biB0aGUgaGFuZGxlcnMKCgkJcmV0dXJuIHRoaXMuZXZlbnRzLmZpbHRlcihlID0+IGUudHlwZSA9PSBvcHRpb25zLnR5cGUgfHwgdHlwZW9mKGUudHlwZSkgPT09ICd1bmRlZmluZWQnKS5tYXAoZSA9PiBgJHtlLm5hbWV9OiAoJHtlLnBhcmFtcyB8fCAnJ30pID0+IHt0cnl7REZvcm0uJHtlLmhhbmRsZXJ9KERGb3JtLmJ5TmFtZSgiJHtvcHRpb25zLm5hbWV9IikgfHwgJHtfRnJFTUQuX3RvSlMob3B0aW9ucyl9IHx8IHtuYW1lOiAiJHtvcHRpb25zLm5hbWV9Iix0eXBlOiAiJHtvcHRpb25zLnR5cGV9In0sICR7ZS5wYXJhbXN9KX1jYXRjaChleCl7Y29uc29sZS5sb2coIkV2ZW50IEVycm9yOiAke29wdGlvbnMubmFtZX0vJHtvcHRpb25zLnR5cGV9LyR7ZS5uYW1lfSIsIGV4KTt9fWApLmpvaW4oJywnKTsKCX0KCglhc3luYyBQYW5lbE9wZW4oZSkgewoJCWlmIChlLmVkaXRvcikgcmV0dXJuIHRydWU7CgkJbGV0IGNvbnRlbnQgPSBlLnZhbHVlOwoJCWlmIChlLmxvYWRlcikgewoJCQljb250ZW50ID0gYXdhaXQgZS5sb2FkZXIodGhpcy5nZXQoKSk7CgkJfQoJCWlmIChjb250ZW50KSB7CgkJCXRyeSB7CgkJCQkkKCIjcG5sIiArIGUubmFtZSkucGFuZWwoJ2JvZHknKS5odG1sKGNvbnRlbnQpOwoJCQkJY29uc29sZS5sb2coInBubCIgKyBlLm5hbWUgKyAiOiBDb250ZW50IFZhbGlkIik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkvL2NvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gY29udGVudDsKCX0KCglhc3luYyBTZWxlY3RDaGFuZ2Uob3B0aW9ucywgdGFiKSB7CgkJdGhpcy5idXN5KHRydWUpOwoJCSQuZ3JlcCh0aGlzLmVsZW1lbnRzLCBlID0+IGUudHlwZSA9PSAiZ3JpZCIgJiYgZS5ncm91cCA9PSB0YWIpLmZvckVhY2goZSA9PiAkKCIjY21iIiArIGUubmFtZSkuZGF0YWdyaWQoKSk7CgkJdGhpcy5idXN5KGZhbHNlKTsKCX0KCglhc3luYyBGaWVsZENoYW5nZShvcHRpb25zLCB2YWx1ZSkgewoJCXRoaXMuYnVzeSh0cnVlKTsKCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNoYW5nZSkgewoJCQlhd2FpdCBvcHRpb25zLmNoYW5nZSh0aGlzLmdldCgpLCB2YWx1ZSk7CgkJfQoJCXRoaXMuYnVzeShmYWxzZSk7Cgl9CgoJYXN5bmMgVVJMQ2hhbmdlKHMsIG9wdGlvbnMpIHsKCQlvcHRpb25zLmRhdGEgPSBhd2FpdCAkLmdldChzLnZhbHVlKTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5GaWVsZENoYW5nZShzLCBvcHRpb25zKTsKCX0KCglhc3luYyBVcGxvYWRGaWxlKGYsIG9wdGlvbnMpIHsKCQl0aGlzLmJ1c3kodHJ1ZSk7CgkJdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7CgkJdmFyIGZpbGVpZCA9IE1hdGgucmFuZG9tKCk7CgkJdmFyIG1ldGhvZCA9IG9wdGlvbnMubWV0aG9kIHx8ICJDb250ZW50TWFuYWdlci5jbXNVcGxvYWRGaWxlIjsKCQlmb3JtRGF0YS5hcHBlbmQoJ2ZpbGVpZCcsIGZpbGVpZCk7CgkJdmFyIGZpbGUgPSAkKCIjIiArIGYuZmlsZWJveElkKVswXS5maWxlc1swXTsKCQlmb3JtRGF0YS5hcHBlbmQoJ19fVUZJTEUnLCBmaWxlKTsKCQlpZiAob3B0aW9ucy5sb2NhbCkgewoJCQkvLyBoYW5kbGluZyB0aGUgZmlsZSBsb2NhbGx5CgkJCXZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwoJCQlyZWFkZXIub25sb2FkID0gYXN5bmMgKGUpID0+IHsKCQkJCXZhciBkYXRhID0gZS50YXJnZXQucmVzdWx0OwoJCQkJREZvcm0uYnlOYW1lKG9wdGlvbnMubmFtZSkuZGF0YSA9IGRhdGE7CgkJCQlpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVwbG9hZCkgYXdhaXQgb3B0aW9ucy51cGxvYWQodGhpcy5nZXQoKSwgZGF0YSk7CgkJCQl0aGlzLmJ1c3koZmFsc2UpOwoJCQl9OwoJCQlpZiAob3B0aW9ucy5iaW5hcnkpIHsKCQkJCXJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSk7CgkJCX0gZWxzZSBpZiAob3B0aW9ucy5kYXRhdXJsKSB7CgkJCQlyZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTsKCQkJfSBlbHNlIHsKCQkJCXJlYWRlci5yZWFkQXNUZXh0KGZpbGUpOwoJCQl9CgkJfSBlbHNlIGlmIChtZXRob2QpIHsKCQkJJC5hamF4KHsKCQkJCXVybDogdGhpcy5zcigpLnNyVVJMICsgIiZtZXRob2Q9IiArIG1ldGhvZCArICImc0lucHV0PSIgKyBmaWxlaWQgKyAiJnByZVRhZz0mcG9zdFRhZz0iLAoJCQkJZGF0YTogZm9ybURhdGEsCgkJCQkvLyBUSElTIE1VU1QgQkUgRE9ORSBGT1IgRklMRSBVUExPQURJTkcKCQkJCWNhY2hlOiBmYWxzZSwKCQkJCWNvbnRlbnRUeXBlOiBmYWxzZSwKCQkJCXR5cGU6ICdQT1NUJywKCQkJCXByb2Nlc3NEYXRhOiBmYWxzZSwKCQkJCXN1Y2Nlc3M6IGRhdGEgPT4gewoJCQkJCXRoaXMuc3IoKS5ydW5TY3JpcHQoZGF0YSk7CgkJCQkJdGhpcy5ieU5hbWUob3B0aW9ucy5uYW1lKS5kYXRhID0gcmV0OwoJCQkJCWlmIChvcHRpb25zICYmIG9wdGlvbnMudXBsb2FkKSBvcHRpb25zLnVwbG9hZCh0aGlzLmdldCgpLCByZXQpOwoJCQkJCXRoaXMuYnVzeShmYWxzZSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0KCgllRnVuKGUpIHsKCQl0cnkgewoJCQlpZiAoZS50eXBlID09ICJ0cmVlIikgewoJCQkJaWYgKGUuY29sdW1ucykgewoJCQkJCXJldHVybiAiY29tYm90cmVlZ3JpZCI7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihlLmNvbWJvKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWUuY29tYm8pIHsKCQkJCQlyZXR1cm4gJ3RyZWUnOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gImNvbWJvdHJlZSI7CgkJCQl9CgkJCX0gZWxzZSBpZiAoZS50eXBlID09ICduYXZpZ2F0aW9uJykgewoJCQkJcmV0dXJuICd0cmVlJzsKCQkJfSBlbHNlIGlmIChlLnR5cGUgPT0gImNvbWJvdHJlZSIpIHsKCQkJCXJldHVybiAiY29tYm90cmVlZ3JpZCI7CgkJCX0gZWxzZSBpZiAoZS50eXBlID09ICJzZWxlY3QiICYmIGUub3B0aW9ucykgewoJCQkJcmV0dXJuICJjb21ib2JveCI7CgkJCX0KCQkJcmV0dXJuICJjb21ib2dyaWQiOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiAiY29tYm9ncmlkIjsKCQl9Cgl9CgoJX2ZpbGxXaW5kb3cod2luTmFtZSwgdiwgbWFwKSB7CgkJdiA9IHYgfHwge307CgkJbWFwID0gbWFwIHx8IHt9OwoJCWlmIChBcnJheS5pc0FycmF5KG1hcCkpIHsKCQkJbWFwID0gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAobWFwKSk7CgkJfQoKCQltYXAgPSAkLmV4dGVuZCh7fSwgbWFwLCBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmtleXModikubWFwKGsgPT4gW3dpbk5hbWUgKyBrLCBrXSkpKTsKCgkJbGV0IHMgPSB7fTsKCQlmb3IgKHZhciBtIGluIG1hcCkgewoJCQlpZiAodHlwZW9mKHZbbWFwW21dXSkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkvL2NvbnNvbGUubG9nKCdpc191bmRlZmluZWQnLCBtLCBtYXBbbV0sIHZbbWFwW21dXSk7CgkJCQlzW21dID0gbWFwW21dOwoJCQl9IGVsc2UgewoJCQkJLy9jb25zb2xlLmxvZygnaXNfbm90X3VuZGVmaW5lZCcsIG0sIG1hcFttXSwgdlttYXBbbV1dKTsKCQkJCXNbbV0gPSB2W21hcFttXV07CgkJCX0KCQl9CgkJdGhpcy5jbGVhcih3aW5OYW1lKTsKCQkvL2NvbnNvbGUubG9nKCJzIiwgcyk7CgkJdGhpcy5zZXQocyk7CgkJJCgiI3BubF8iICsgd2luTmFtZSkud2luZG93KCJvcGVuIik7Cgl9CgoJd2luZG93VG9FbnRpdHkobywgYkVtcHR5LCBncmlkLCBwcmVmaXgsIGZpbHRlcikgewoJCW8gPSBvIHx8IHRoaXMuZ2V0KCk7CgkJZmlsdGVyID0gZmlsdGVyIHx8ICh2ID0+IHYpOwoJCWxldCByZXQgPSBncmlkID8gKGdyaWQuc2VsZWN0ZWQgfHwgZ3JpZCkgOiBudWxsOwoJCWlmIChiRW1wdHkpIHsKCQkJcmV0ID0ge307CgkJCW8gPSB7fTsKCQl9IGVsc2UgewoJCQlyZXQgPSAocmV0ICYmIHJldC5JZCkgPyB7CgkJCQlJZDogcmV0LklkCgkJCX0gOiB7fTsKCQl9CgoJCXRoaXMuZWxlbWVudHMuZmlsdGVyKGUgPT4gKHByZWZpeCA/IGUuZ3JvdXAgPT0gcHJlZml4IDogdHJ1ZSkgJiYgZS50eXBlICE9ICdsaW5rJyAmJiBbJ18nXS5pbmRleE9mKGUubmFtZS5yZXBsYWNlKHByZWZpeCwgIiIpKSA8IDApLmZvckVhY2goZSA9PiB7CgkJCXJldFtlLm5hbWUucmVwbGFjZShwcmVmaXgsICIiKV0gPSBvW2UubmFtZV07CgkJCXJldHVybiB0cnVlOwoJCX0pOwoKCQlmaWx0ZXIocmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCgliaW5kKG9iaikgewoJCXZhciBvYmpCaW5kID0gKG8sIGUpID0+IHsKCQkJb1t0aGlzLmVGdW4oZSldKHsKCQkJCW9uU2hvd1BhbmVsOiAoKSA9PiB7CgkJCQkJdGhpcy5maWxsRGF0YSgkKCIjIiArIGUuaWQpLCBudWxsLCAwLCAxMCk7CgkJCQl9LAoJCQkJb25DbGlja1JvdzogKGluZGV4LCByb3cpID0+IHsKCQkJCQl2YXIgcyA9IHJvdyA/IHJvdy5fX09XTkVSIDogbnVsbDsKCQkJCQkvLyBjb25zb2xlLmxvZygib25DbGlja1JvdygpOiAiLCBpbmRleCwgcm93LCBzKTsKCQkJCQlpZiAocyAmJiBzLm9wdGlvbnMuc2VsZWN0KSB7CgkJCQkJCXMub3B0aW9ucy5zZWxlY3Qocm93LCB0aGlzLmdldCgpKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQl0cnkgewoJCQkJdmFyIGRnID0gb1t0aGlzLmVGdW4oZSldKCdncmlkJyk7CgkJCQkvLyBkZy5kYXRhZ3JpZCgnZW5hYmxlRmlsdGVyJykKCQkJCXZhciBzdGF0ZSA9IGRnLmRhdGEoJ2RhdGFncmlkJyk7CgkJCQl2YXIgb3B0cyA9IHN0YXRlLm9wdGlvbnM7CgkJCQl2YXIgb25CZWZvcmVMb2FkID0gb3B0cy5vbkJlZm9yZUxvYWQ7CgkJCQlvcHRzLm9uQmVmb3JlTG9hZCA9IChwYXJhbSkgPT4gewoJCQkJCXN0YXRlLmFsbFJvd3MgPSBudWxsOwoJCQkJCXJldHVybiBvbkJlZm9yZUxvYWQuY2FsbCh0aGlzLCBwYXJhbSk7CgkJCQl9OwoJCQkJdmFyIHBhZ2VyID0gZGcuZGF0YWdyaWQoJ2dldFBhZ2VyJyk7CgkJCQlkZy5kYXRhZ3JpZCgnZ2V0UGFuZWwnKS5wYW5lbCh7CgkJCQkJSUQ6IGkKCQkJCX0pOwoJCQkJcGFnZXIucGFnaW5hdGlvbih7CgkJCQkJb25TZWxlY3RQYWdlOiBmdW5jdGlvbihwYWdlTnVtLCBwYWdlU2l6ZSkgewoJCQkJCQl0cnkgewoJCQkJCQkJREZvcm0uZmlsbERhdGEoJCgiIyIgKyBERm9ybS5zZWxlY3RzWyQodGhpcy5wYXJlbnROb2RlKS5wYW5lbCgnb3B0aW9ucycpLklEXS5pZCksIG51bGwsIHBhZ2VTaXplICogKHBhZ2VOdW0gLSAxKSwgcGFnZVNpemUgKiBwYWdlTnVtKTsKCQkJCQkJfSBjYXRjaCAoX2V4KSB7CgkJCQkJCQljb25zb2xlLmxvZygiRHluYUZvcm06Om9uU2VsZWN0UGFnZSgpICIsIF9leCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQkJCWRnLmRhdGFncmlkKCdsb2FkRGF0YScsIHN0YXRlLmRhdGEpOwoJCQl9IGNhdGNoIChleCkge30KCQl9OwoJCWlmIChvYmopIHsKCQkJb2JqQmluZChvYmopOwoJCX0gZWxzZSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zZWxlY3RzLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAodGhpcy5zZWxlY3RzW2ldLm9wdGlvbnMub3B0aW9ucykgewoJCQkJCS8vJCgiIyIgKyB0aGlzLnNlbGVjdHNbaV0uaWQpLmNvbWJvKCk7CgkJCQl9IGVsc2UgewoJCQkJCW9iakJpbmQoJCgiIyIgKyB0aGlzLnNlbGVjdHNbaV0uaWQpLCB0aGlzLnNlbGVjdHNbaV0pOwoJCQkJfQoJCQl9CgoJCQl0aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+IGUud2luZG93ICYmIGUuZ3JvdXApLmZvckVhY2goZSA9PiB7CgkJCQlsZXQgdCA9ICQoIiN0YmNXaW5kb3ciKS50YWJzKCJnZXRUYWIiLCBlLmdyb3VwKTsKCQkJCWlmICh0KSB7CgkJCQkJdC5wYW5lbCgnb3B0aW9ucycpLnRhYi5oaWRlKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX0KCgllbmdsaXNoKHMpIHsKCQlpZiAoIXMpIHJldHVybiAiIjsKCQl2YXIgcmVzdWx0ID0gcy5yZXBsYWNlKC8oW0EtWl0pL2csICIgJDEiKTsKCQlyZXN1bHQgPSByZXN1bHQucmVwbGFjZSgvXy9nLCAnJyk7CgkJcmV0dXJuIHJlc3VsdC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHJlc3VsdC5zbGljZSgxKTsKCX0KCglvblRvZ2dsZShlLCBiVmFsdWUpIHsKCQlsZXQgc1RhZyA9IGAjZkVsZW1lbnRfJHtlLmZvci5uYW1lfSA+IC5lYXN5dWktJHt0aGlzLnVpVHlwZXNbZS5mb3IudHlwZV19YDsKCQlsZXQgb1RhZyA9ICQoc1RhZyk7CgkJZS5mb3IuZW5hYmxlZCA9IHR5cGVvZihiVmFsdWUpID09PSAidW5kZWZpbmVkIiA/ICFlLmZvci5lbmFibGVkIDogYlZhbHVlOwoKCQlvVGFnLnByb3AoImRpc2FibGVkIiwgIWUuZm9yLmVuYWJsZWQpOwoJCS8vb1RhZ1t0aGlzLnVpVHlwZXNbZS5mb3IudHlwZV1dKGUuZm9yLmVuYWJsZWQgPyAiZW5hYmxlIiA6ICJkaXNhYmxlIik7CgkJY29uc29sZS5sb2coc1RhZywgb1RhZywgdGhpcy51aVR5cGVzW2UuZm9yLnR5cGVdLCBlLmZvci5lbmFibGVkKTsKCX0KCglyZW5kZXIobmFtZSwgdGl0bGUsIGVsZW1lbnRzLCBidXR0b25zLCBiRml4ZWQpIHsKCQl0aGlzLmVsZW1lbnRzID0gKGVsZW1lbnRzIHx8IFtdKS5maWx0ZXIoZSA9PiAhZS5pZ25vcmUpOwoKCQl0aGlzLmJ1dHRvbnMgPSBidXR0b25zIHx8IFtdOwoJCXRoaXMuc2VsZWN0cyA9IFtdOwoJCXRoaXMuZ3JpZHMgPSBbXTsKCgkJdGhpcy5lbGVtZW50cy5maWx0ZXIoZSA9PiBlLnR5cGUgPT0gIndpbmRvdyIpLmZvckVhY2godyA9PiB0aGlzLmVsZW1lbnRzLnNwbGljZSh0aGlzLmVsZW1lbnRzLmZpbmRJbmRleChlID0+IGUubmFtZSA9PSB3Lm5hbWUpLCAwLCB7CgkJCW5hbWU6ICJfIiArIHcubmFtZSwKCQkJdHlwZTogImxpbmsiLAoJCQl0aXRsZTogdy50aXRsZSB8fCB0aGlzLmVuZ2xpc2gody5uYW1lKSwKCQkJZ3JvdXA6IHcuZ3JvdXAsCgkJCXdpbmRvdzogdy53aW5kb3csCgkJCXNlY3Rpb246IHcuc2VjdGlvbiwKCQkJbGlua3M6IFt7CgkJCQlsYWJlbDogJ09wZW4nLAoJCQkJaWNvbjogJ2VkaXQnLAoJCQkJb25DbGljazogbyA9PiAkKCIjcG5sIiArIHcubmFtZSkud2luZG93KCdvcGVuJykKCQkJfV0sCgkJfSkpOwoKCQl0aGlzLnNyKCkuZ3JvdXBCeSh0aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+IGUud2luZG93KSwgImdyb3VwIikuZm9yRWFjaChrdiA9PiB7CgkJCWlmICgha3Yua2V5KSByZXR1cm47CgoJCQlsZXQgZSA9IHsKCQkJCW5hbWU6ICJfIiArIGt2LmtleSwKCQkJCXRpdGxlOiBrdi5rZXksCgkJCQl0eXBlOiAid2luZG93IiwKCQkJCWdyb3VwOiBrdi5rZXksCgkJCQl3aWR0aDogdGhpcy53aWR0aCAqIDAuOSwKCQkJCWhlaWdodDogdGhpcy5oZWlnaHQgKiAwLjksCgkJCQlsb2FkZXI6IG8gPT4gewoJCQkJCWt2LnZhbHVlcy5maWx0ZXIodiA9PiB2LnR5cGUgIT09ICdsaW5rJyB8fCAodi50eXBlID09ICdsaW5rJyAmJiB2Lm5hbWUuc3RhcnRzV2l0aCgnXycpKSkuZm9yRWFjaCh2ID0+ICQoIiNwbmxfIiArIHYuZ3JvdXAgKyAnLWNlbnRlcicpLmFwcGVuZCgkKCIjZkVsZW1lbnRfIiArIHYubmFtZSkpKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0sCgkJCQlidXR0b25zOiBbXS5jb25jYXQuYXBwbHkoW10sIGt2LnZhbHVlcy5maWx0ZXIodiA9PiB2LnR5cGUgPT0gJ2xpbmsnICYmICF2Lm5hbWUuc3RhcnRzV2l0aCgnXycpKS5tYXAodiA9PiBbLi4udi5saW5rcy5tYXAobCA9PiAoewoJCQkJCW5hbWU6IGwubmFtZSB8fCBsLmxhYmVsLAoJCQkJCXRpdGxlOiBsLnRpdGxlIHx8IGwubGFiZWwsCgkJCQkJb25DbGljazogbC5vbkNsaWNrLAoJCQkJCWljb246IGwuaWNvbiwKCQkJCQl3aW5kb3c6IHRydWUsCgkJCQkJZ3JvdXA6IGt2LmtleSwKCQkJCX0pKV0pKSwKCQkJfTsKCQkJdGhpcy5idXR0b25zLnB1c2goLi4uZS5idXR0b25zKTsKCgkJCXRoaXMuZWxlbWVudHMucHVzaChlKTsKCQl9KTsKCgkJdmFyIHJldCA9ICIiOwoJCS8vIGNoZWNrIHRoZSBvcHRpb24gb2YgdXNpbmcgd2luZG93KCkgYXMgYSByZW5kZXJlciBvZiB0aGUgbWFpbiB3aW5kb3cuLi4KCQlpZiAodHJ1ZSkgewoJCQl0aGlzLmVsZW1lbnRzLmZpbHRlcihlID0+ICFlLnpvbmUpLmZvckVhY2goZSA9PiBlLnpvbmUgPSAnY2VudGVyJyk7CgkJCWxldCB3T3B0aW9ucyA9IHsKCQkJCW5hbWU6IG5hbWUgfHwgdGhpcy5uYW1lLAoJCQkJdGl0bGU6IHRpdGxlIHx8IHRoaXMudGl0bGUsCgkJCQl0eXBlOiAnd2luZG93JywKCQkJCXZpc2libGU6IHRydWUsCgkJCQl3aWR0aDogdGhpcy53aWR0aCwKCQkJCWhlaWdodDogdGhpcy5oZWlnaHQsCgkJCQlmaXhlZDogYkZpeGVkLAoJCQkJbGlua3M6IFt7CgkJCQkJaWNvbjogImhlbHAiLAoJCQkJCWFjdGlvbjogbyA9PiAkKCIjcG5sX19Db25zb2xlIikud2luZG93KCdvcGVuJykKCQkJCX1dLAoJCQkJYnV0dG9uczogdGhpcy5idXR0b25zLmZpbHRlcihiID0+ICFiLndpbmRvdyksCgkJCX07CgkJCXRoaXMuc3IoKS5ncm91cEJ5KHRoaXMuZWxlbWVudHMsICd6b25lJykuZmlsdGVyKHpnID0+IHpnLmtleSkuZm9yRWFjaCh6ZyA9PiB7CgkJCQl3T3B0aW9uc1t6Zy5rZXldID0gdGhpcy5yZW5kZXJFbGVtZW50cyh6Zy52YWx1ZXMpOwoJCQl9KTsKCgkJCXJldCA9IHRoaXMud2luZG93KHdPcHRpb25zKTsKCQl9IGVsc2UgewoJCQlyZXQgPSB0aGlzLmhlYWRlcihuYW1lLCB0aXRsZSwgYkZpeGVkLCBbewoJCQkJaWNvbjogImhlbHAiLAoJCQkJYWN0aW9uOiBvID0+ICQoIiNwbmxfX0NvbnNvbGUiKS53aW5kb3coJ29wZW4nKQoJCQl9XSk7CgoJCQlyZXQgKz0gdGhpcy5yZW5kZXJFbGVtZW50cygpOwoKCQkJcmV0ICs9IHRoaXMuZm9vdGVyKGJGaXhlZCk7CgoJCX0KCQkvLyBjb25zb2xlLmxvZyhyZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWNXaWR0aChvcHRpb25zKSB7CgkJbGV0IHJldCA9IE1hdGguZmxvb3IoKChvcHRpb25zID8gb3B0aW9ucy53aWR0aCA6IG51bGwpIHx8ICh0aGlzLndpZHRoIC8gMykpKTsKCQlpZiAob3B0aW9ucy56b25lID09ICdlYXN0JyB8fCBvcHRpb25zLnpvbmUgPT0gJ3dlc3QnKSB7CgkJCXJldCA9IDAuMjUgKiByZXQ7IC8vIDkwJSBvZiAzLzEwLCB0aGUgd2lkdGggb2YgdGhlIG5vcm1hbCBlbGVtZW50CgkJfSBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZWRpdG9yKSB7CgkJCXJldCA9IHdpbmRvdy5pbm5lcldpZHRoOwoJCX0gZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLndpZHRoICYmIHR5cGVvZihvcHRpb25zLndpZHRoKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gdGhpcy53aWR0aDsKCQl9IGVsc2UgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy50eXBlID09ICd3aW5kb3cnICYmICFvcHRpb25zLndpZHRoKSB7CgkJCXJldCA9IHRoaXMud2lkdGggKiAwLjk7CgkJfQoKCQkvLyBjb25zb2xlLmxvZyhvcHRpb25zLm5hbWUgKyAiOiBjV2lkdGggPSAiICsgcmV0LCBvcHRpb25zLnpvbmUpOwoJCXJldHVybiByZXQ7Cgl9CgoJd2luZG93KG9wdGlvbnMpIHsKCQlvcHRpb25zLnRpdGxlID0gb3B0aW9ucy50aXRsZSB8fCBvcHRpb25zLm5hbWU7CgkJdmFyIHJldCA9IGAKCQk8ZGl2IGlkID0gInBubCR7b3B0aW9ucy5uYW1lfSIgY2xhc3M9ImVhc3l1aS13aW5kb3ciIHRpdGxlPSIke29wdGlvbnMudGl0bGUgfHwgdGhpcy5lbmdsaXNoKG9wdGlvbnMubmFtZSl9IiBkYXRhLW9wdGlvbnM9JyR7dGhpcy5ldmVudEhhbmRsZXJzKG9wdGlvbnMpfSwgY2xvc2VkOiR7IW9wdGlvbnMudmlzaWJsZX0sbWluaW1pemFibGU6JHshb3B0aW9ucy5maXhlZH0sbWF4aW1pemFibGU6JHshb3B0aW9ucy5maXhlZH0sY2xvc2FibGU6JHshb3B0aW9ucy5maXhlZH0sY29sbGFwc2libGU6JHshb3B0aW9ucy5maXhlZH0sZHJhZ2dhYmxlOiR7IW9wdGlvbnMuZml4ZWR9LHJlc2l6YWJsZTokeyFvcHRpb25zLmZpeGVkfSxpY29uQ2xzOiJpY29uLSR7b3B0aW9ucy5pY29ufSIsIHRvb2xzOiIjJHtvcHRpb25zLm5hbWV9X3Rvb2xzIicgc3R5bGU9IndpZHRoOiR7dGhpcy5jV2lkdGgob3B0aW9ucyl9cHg7aGVpZ2h0OiR7dGhpcy5jSGVpZ2h0KG9wdGlvbnMpfXB4O3BhZGRpbmc6MTBweDsiPgoJCSAgICA8ZGl2IGNsYXNzPSJlYXN5dWktbGF5b3V0IiBkYXRhLW9wdGlvbnM9ImZpdDp0cnVlIj4KCQlgOwoKCQlsZXQgYlpvbmUgPSBvcHRpb25zLnNvdXRoID8gJ3NvdXRoJyA6ICh0aGlzLnpvbmVzLmZpbmQoeiA9PiB6ID09ICdzb3V0aCcpIHx8IHRoaXMuem9uZXNbMF0pOwoJCW9wdGlvbnNbYlpvbmVdID0gb3B0aW9uc1tiWm9uZV0gfHwgW107CgkJbGV0IHpXaWR0aCA9IE1hdGgubWluKDEyMCwgdGhpcy53aWR0aCAqIDAuOTUgLyAob3B0aW9ucy5idXR0b25zID8gb3B0aW9ucy5idXR0b25zLmxlbmd0aCA6IDEpLCB0aGlzLmNXaWR0aChvcHRpb25zKSk7CgkJb3B0aW9uc1tiWm9uZV0ucHVzaChgPGRpdiBpZD0icG5sJHtvcHRpb25zLm5hbWV9LWJ1dHRvbnMiIGRhdGEtb3B0aW9ucz0icmVnaW9uOicke2Jab25lfScsYm9yZGVyOmZhbHNlIiBzdHlsZT0idGV4dC1hbGlnbjpyaWdodDtwYWRkaW5nOjVweCAwIDA7Ij5gICsgJC5tYXAoJC5ncmVwKG9wdGlvbnMuYnV0dG9ucyB8fCBbXSwgYiA9PiAhYi5pZ25vcmUpLCBiID0+IGA8YSBpZD0nJHtiLm5hbWV9JyBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJlYXN5dWktbGlua2J1dHRvbiBjNiIgaWNvbkNscz0iaWNvbi0ke2IuaWNvbiB8fCAnc2F2ZSd9IiBzdHlsZT0id2lkdGg6JHt6V2lkdGh9cHgiIG9uY2xpY2s9J0RGb3JtLmRvQ2xpY2soJHtfRnJFTUQuX3RvSlMoYil9KSc+JHtiLnRpdGxlIHx8IGIubmFtZX08L2E+Jm5ic3A7Jm5ic3A7YCkuam9pbignJykgKyBgPC9kaXY+YCk7CgoJCXRoaXMuem9uZXMuZmlsdGVyKHogPT4gb3B0aW9uc1t6XSkuZm9yRWFjaCh6ID0+IHsKCQkJcmV0ICs9IGAKCQkgICAgICAgIDxkaXYgZGF0YS1vcHRpb25zPSJyZWdpb246JyR7en0nIiB0aXRsZT0iJHsoej09J3dlc3QnIHx8IHo9PSdlYXN0Jyk/JyZuYnNwOyc6Jyd9IiBzdHlsZT0naGVpZ2h0OiR7KHo9PSdub3J0aCd8fHo9PSdzb3V0aCcpPzEwOjEwMH0lO3dpZHRoOiR7KCh6PT0nZWFzdCd8fHo9PSd3ZXN0Jyk/MC4xOjEpKnRoaXMuY1dpZHRoKG9wdGlvbnMpfXB4Jz4KICAgICAgICAJCSAgICAkeyhBcnJheS5pc0FycmF5KG9wdGlvbnNbel0pP29wdGlvbnNbel06W29wdGlvbnNbel1dKS5qb2luKCcnKX0KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICBgOwoJCX0pOwoKCQlyZXQgKz0gYDwvZGl2PjwvZGl2PmA7CgoJCS8vIGxpbmtzICh0b29scykKCQlsZXQgbGlua3MgPSAkLmdyZXAoW10uY29uY2F0KG9wdGlvbnMubGlua3MgfHwgW10pLCBsID0+ICFsLmlnbm9yZSk7CgkJcmV0ICs9IGA8ZGl2IGlkPSIke29wdGlvbnMubmFtZX1fdG9vbHMiPmAgKyAkLm1hcChsaW5rcy5yZXZlcnNlKCksIGwgPT4gYDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgc3R5bGU9ImNvbG9yOmJsYWNrIiBjbGFzcz0iZmFzIGZhLSR7bC5pY29uIHx8ICdhZGQnfSIgb25jbGljaz0nKGFzeW5jICgpID0+IHt2YXIgYSA9ICR7X0ZyRU1ELl90b0pTKGwpfTsgJCgiI3BubCR7b3B0aW9ucy5uYW1lfSIpLndpbmRvdygic2V0VGl0bGUiLCAiJHtvcHRpb25zLnRpdGxlfTogIiArIGEubmFtZSk7IGF3YWl0IGEuYWN0aW9uKERGb3JtLmdldCgpLCBhLCAke19GckVNRC5fdG9KUyhvcHRpb25zKX0pOyAkKCIjcG5sJHtvcHRpb25zLm5hbWV9Iikud2luZG93KCJzZXRUaXRsZSIsICIke29wdGlvbnMudGl0bGV9Iik7fSkoKSc+PC9hPmApLmpvaW4oJ1xuJykgKyBgPC9kaXY+YDsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfZW5kKCkgewoJCWxldCBvID0gdGhpcy5nZXQoKTsKCgkJLy8gZG8gbm90IHVzZSB0aGUgZmlyc3QgYnV0dG9uLCBiZWNhdXNlIG1hbnkgZm9ybXMgaGF2ZSBhIENhbmNlbCBidXR0b24gb25seQoJCWxldCBidXR0b24gPSB0aGlzLmJ1dHRvbnMuZmluZChiID0+IGIuYXV0b1N1Ym1pdCkgLyogfHwgdGhpcy5idXR0b25zWzBdKi8gOwoJCWlmIChidXR0b24gJiYgbyAmJiBPYmplY3QudmFsdWVzKG8pLmxlbmd0aCAmJiAodHlwZW9mKGJ1dHRvbi5hdXRvU3VibWl0KSA9PT0gInVuZGVmaW5lZCIgfHwgYnV0dG9uLmF1dG9TdWJtaXQpKSB7CgkJCWxldCB2ID0gT2JqZWN0LnZhbHVlcyhvKS5yZWR1Y2UoKHQsIHYpID0+IHsKCQkJCXJldHVybiAoKHR5cGVvZih2KSAhPT0gIm9iamVjdCIpID8gMSA6IDApICogKHYgPyAxIDogMCk7CgkJCX0pOwoJCQkvL2NvbnNvbGUubG9nKG8sIE9iamVjdC52YWx1ZXMobyksIHYpOwoJCQlpZiAodikgewoJCQkJLy8gYWxsIGZpZWxkcyBoYXZlIHZhbHVlcwoJCQkJYXdhaXQgdGhpcy5kb0NsaWNrKGJ1dHRvbik7CgoJCQl9CgkJfQoJfQoKCWZvb3RlcihiRml4ZWQpIHsKCQlyZXR1cm4gYDwvZm9ybT5gICsgYDxkaXYgaWQ9ImRsZy1idXR0b25zIj5gICsgdGhpcy5idXR0b25zLmZpbHRlcihiID0+ICFiLndpbmRvdykubWFwKGIgPT4gYDxhIGlkPScke2IubmFtZX0nIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImVhc3l1aS1saW5rYnV0dG9uIGM2IiBpY29uQ2xzPSJpY29uLSR7Yi5pY29uIHx8ICdzYXZlJ30iIHN0eWxlPSJ3aWR0aDoke01hdGgubWluKDEyMCwgdGhpcy53aWR0aCAqIDAuOTUgLyB0aGlzLmJ1dHRvbnMubGVuZ3RoLCB0aGlzLmNXaWR0aCgpKX1weCIgb25jbGljaz0nREZvcm0uZG9DbGljaygke19GckVNRC5fdG9KUyhiKX0pJz4ke2IudGl0bGUgfHwgdGhpcy5lbmdsaXNoKGIubmFtZSl9PC9hPiZuYnNwOyZuYnNwO2ApLmpvaW4oJycpICsgIjwvZGl2PiIgKyAoYkZpeGVkID8gIiIgOiAnPC9kaXY+Jyk7Cgl9CgoJaGVhZGVyKG5hbWUsIHRpdGxlLCBiRml4ZWQsIGxpbmtzKSB7CgkJdGhpcy50aXRsZSA9IHRpdGxlIHx8IHRoaXMudGl0bGU7CgkJbmFtZSA9IG5hbWUgfHwgdGhpcy5uYW1lOwoJCXZhciByZXQgPSAnJzsKCgkJcmV0ICs9IHRoaXMud2luZG93KHsKCQkJbmFtZTogIl9fQ29uc29sZSIsCgkJCXR5cGU6ICJ3aW5kb3ciLAoJCQllZGl0b3I6IHRydWUsCgkJCWxvYWRlcjogbyA9PiB3aW5kb3cubG9ncy5zbGljZSgpLnJldmVyc2UoKS5tYXAobCA9PiBsLmRhdGUudG9JU09TdHJpbmcoKSArICI6ICIgKyBsLmFyZ3MubWFwKHMgPT4gdHlwZW9mKHMpID09PSAnb2JqZWN0JyA/ICgob2JqLCBpbmRlbnQgPSAyKSA9PiB7CgkJCQlsZXQgY2FjaGUgPSBbXTsKCQkJCWNvbnN0IHJldFZhbCA9IEpTT04uc3RyaW5naWZ5KAoJCQkJCW9iaiwKCQkJCQkoa2V5LCB2YWx1ZSkgPT4KCQkJCQl0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsID8KCQkJCQljYWNoZS5pbmNsdWRlcyh2YWx1ZSkgPwoJCQkJCXVuZGVmaW5lZCAvLyBEdXBsaWNhdGUgcmVmZXJlbmNlIGZvdW5kLCBkaXNjYXJkIGtleQoJCQkJCToKCQkJCQljYWNoZS5wdXNoKHZhbHVlKSAmJiB2YWx1ZSAvLyBTdG9yZSB2YWx1ZSBpbiBvdXIgY29sbGVjdGlvbgoJCQkJCToKCQkJCQl2YWx1ZSwKCQkJCQlpbmRlbnQKCQkJCSk7CgkJCQljYWNoZSA9IG51bGw7CgkJCQlyZXR1cm4gcmV0VmFsOwoJCQl9KShzKSA6IHMpLmpvaW4oJywgJykpLmpvaW4oJ1xuJyksCgkJfSk7CgoJCWlmICghYkZpeGVkKSB7CgkJCWxpbmtzID0gKGxpbmtzIHx8IFtdKS5maWx0ZXIobCA9PiAhbC5pZ25vcmUpOwoJCQlsZXQgdERhdGEgPSAiIjsKCQkJaWYgKGxpbmtzLmxlbmd0aCkgewoJCQkJcmV0ICs9IGA8ZGl2IGlkPSIke3RoaXMubmFtZX1fdG9vbHMiPmAgKyBsaW5rcy5tYXAobCA9PiBgPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iaWNvbi0ke2wuaWNvbn0iIG9uY2xpY2s9Jyhhc3luYyAoKSA9PiB7dmFyIGEgPSAke19GckVNRC5fdG9KUyhsKX07ICQoIiN3aW4ke3RoaXMubmFtZX0iKS53aW5kb3coInNldFRpdGxlIiwgIiR7dGhpcy50aXRsZX06ICIgKyBhLm5hbWUpOyBhd2FpdCBhLmFjdGlvbihERm9ybS5nZXQoKSk7ICQoIiN3aW4ke3RoaXMubmFtZX0iKS53aW5kb3coInNldFRpdGxlIiwgIiR7dGhpcy50aXRsZX0iKTt9KSgpJz48L2E+YCkuam9pbignXG4nKSArICI8L2Rpdj4iOwoJCQkJdERhdGEgPSBgLHRvb2xzOiIjJHt0aGlzLm5hbWV9X3Rvb2xzImA7CgkJCX0KCQkJcmV0ICs9IGA8ZGl2IGlkPSd3aW4ke3RoaXMubmFtZX0nIGNsYXNzPSdlYXN5dWktd2luZG93JyB0aXRsZT0nJHt0aGlzLnRpdGxlIHx8IHRoaXMuZW5nbGlzaCh0aGlzLm5hbWUpfScgZGF0YS1vcHRpb25zPSdpY29uQ2xzOiJpY29uLXNhdmUiICR7dERhdGF9JyBzdHlsZT0nd2lkdGg6JHt0aGlzLndpZHRofXB4O2hlaWdodDoke3RoaXMuaGVpZ2h0fXB4O3BhZGRpbmc6MTBweDsnPmA7CgkJfQoJCXJldHVybiByZXQgKyBgPGZvcm0gaWQ9ImZybSR7dGhpcy5uYW1lfSIgbWV0aG9kPSJwb3N0IiBub3ZhbGlkYXRlPmA7Cgl9CgoJcmVuZGVyRWxlbWVudHMoZWxlbWVudHMpIHsKCQllbGVtZW50cyA9IGVsZW1lbnRzIHx8IHRoaXMuZWxlbWVudHM7CgoJCXZhciB0V2lkdGggPSBNYXRoLmZsb29yKHRoaXMud2lkdGggKiAwLjk1KTsKCQl2YXIgdEhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5oZWlnaHQgKiAwLjg1KTsKCgkJbGV0IHJldCA9ICcnOwoJCXZhciBnRWxlbWVudHMgPSB0aGlzLnNyKCkuZ3JvdXBCeShlbGVtZW50cywgImdyb3VwIik7CgkJaWYgKGdFbGVtZW50cy5sZW5ndGggPiAxKSByZXQgKz0gYDxkaXYgaWQ9InRiY1dpbmRvdyIgY2xhc3M9ImVhc3l1aS10YWJzIiBkYXRhLW9wdGlvbnM9JyR7dGhpcy5ldmVudEhhbmRsZXJzKHt0eXBlOiAndGFicyd9KX0nIHN0eWxlPSJ3aWR0aDoke3RXaWR0aH1weDtoZWlnaHQ6JHt0SGVpZ2h0fXB4OyI+YDsKCQlmb3IgKHZhciBnID0gMDsgZyA8IGdFbGVtZW50cy5sZW5ndGg7IGcrKykgewoJCQlpZiAoZ0VsZW1lbnRzLmxlbmd0aCA+IDEpIHJldCArPSAnPGRpdiB0aXRsZT0iJyArIChnRWxlbWVudHNbZ10ua2V5IHx8ICJNYWluIikgKyAnIiBzdHlsZT0icGFkZGluZzoyMHB4O2Rpc3BsYXk6bm9uZTsiPic7CgkJCXZhciBzRWxlbWVudHMgPSB0aGlzLnNyKCkuZ3JvdXBCeShnRWxlbWVudHNbZ10udmFsdWVzLCAic2VjdGlvbiIpOwoJCQlpZiAoc0VsZW1lbnRzLmxlbmd0aCA+IDEpIHJldCArPSAnPGRpdiBjbGFzcz0iZWFzeXVpLWFjY29yZGlvbiIgc3R5bGU9IndpZHRoOicgKyB0V2lkdGggKyAncHg7aGVpZ2h0OicgKyAvKnRIZWlnaHQqLyAiMTAwJSIgKyAncHg7Ij4nOwoJCQlmb3IgKHZhciBzID0gMDsgcyA8IHNFbGVtZW50cy5sZW5ndGg7IHMrKykgewoJCQkJcmV0ICs9IGA8ZGl2IHRpdGxlPSIke3NFbGVtZW50c1tzXS5rZXkgfHwgIiJ9IiBkYXRhLW9wdGlvbnM9Imljb25DbHM6J2ljb24tbW9yZSciIHN0eWxlPSJwYWRkaW5nOjEwcHg7Ij5gOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzRWxlbWVudHNbc10udmFsdWVzLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIGUgPSBzRWxlbWVudHNbc10udmFsdWVzW2ldOwoJCQkJCWlmIChlLmlnbm9yZSkgY29udGludWU7CgkJCQkJZS52YWx1ZSA9IGUudmFsdWUgfHwgX0ZyRU1ELmhhc2hbZS5uYW1lXSB8fCAoX0ZyRU1ELmFwaVNlcnZlciA/IF9GckVNRC5hcGlTZXJ2ZXIuX19jb25maWcoJ3Rlc3RfJyArIGUubmFtZSwgJycpIDogJycpOwoJCQkJCXJldCArPSBgPGRpdiBpZD0iZkVsZW1lbnRfJHtlLm5hbWV9IiBjbGFzcz0iZml0ZW0iIHN0eWxlPSJkaXNwbGF5OiAkeyhlLnR5cGU9PSd3aW5kb3cnIHx8IGUuaGlkZGVuKT8nbm9uZSc6Jyd9Ij5gOwoJCQkJCWlmIChlLnRvZ2dsZSkgewoJCQkJCQlyZXQgKz0gYDxhIGhyZWY9IiMiIGNsYXNzPSJlYXN5dWktbGlua2J1dHRvbiIgZGF0YS1vcHRpb25zPScke3RoaXMuZXZlbnRIYW5kbGVycyh7dHlwZTogJ3RvZ2dsZScsIGZvcjogZX0pfSxwbGFpbjp0cnVlLGljb25DbHM6Imljb24tJHtlLmljb24gfHwgJ3NlYXJjaCd9Iicgc3R5bGU9IndpZHRoOjEwMHB4O2hlaWdodDozMHB4Ij4ke2UudGl0bGUgfHwgdGhpcy5lbmdsaXNoKGUubmFtZSl9PC9hPmA7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0ICs9IGA8bGFiZWw+JHtlLnRpdGxlIHx8IHRoaXMuZW5nbGlzaChlLm5hbWUpfTo8L2xhYmVsPmA7CgkJCQkJfQoJCQkJCWlmIChlLnR5cGUgJiYgdGhpc1tlLnR5cGVdKSB7CgkJCQkJCXJldCArPSB0aGlzW2UudHlwZV0oZSk7CgkJCQkJfSBlbHNlIGlmIChlLnJlbmRlcikgewoJCQkJCQlyZXQgKz0gZS5yZW5kZXIoKTsKCQkJCQl9CgkJCQkJcmV0ICs9ICc8L2Rpdj4nOwoJCQkJfQoJCQkJcmV0ICs9ICc8L2Rpdj4nOwoJCQl9CgkJCWlmIChzRWxlbWVudHMubGVuZ3RoID4gMSkgcmV0ICs9ICc8L2Rpdj4nOwoJCQlpZiAoZ0VsZW1lbnRzLmxlbmd0aCA+IDEpIHJldCArPSAiPC9kaXY+IjsKCQl9CgkJaWYgKGdFbGVtZW50cy5sZW5ndGggPiAxKSByZXQgKz0gIjwvZGl2PiI7CgkJcmV0dXJuIHJldDsKCX0KCglpbmZvKG1zZykgewoJCWlmICgkLm1lc3NhZ2VyKSB7CgkJCSQubWVzc2FnZXIuYWxlcnQodGhpcy50aXRsZSwgbXNnLCAnaW5mbycpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc3IoKS5TaG93TWVzc2FnZShtc2csIHRoaXMudGl0bGUpOwoJCX0KCX0KCgllcnJvcihtc2cpIHsKCQlpZiAoJC5tZXNzYWdlcikgewoJCQkkLm1lc3NhZ2VyLmFsZXJ0KHRoaXMudGl0bGUsIG1zZywgJ2Vycm9yJyk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zcigpLlNob3dNZXNzYWdlKG1zZywgdGhpcy50aXRsZSk7CgkJfQoJfQoKCWJ5TmFtZShuYW1lKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudHMuZmluZChlID0+IGUubmFtZSA9PT0gbmFtZSk7Cgl9CgoJLyoqIENvbXBvbmVudHM6OlN0YXJ0ICoqLwoJQ29yZUNvbXBvbmVudCA9IGNsYXNzIHsKCQljb25zdHJ1Y3RvcihwYWdlLCBkRm9ybSwgb1Njb3BlKSB7CgkJCXRoaXMucGFnZSA9IHBhZ2U7CgkJCXRoaXMuZEZvcm0gPSBkRm9ybSB8fCBERm9ybTsKCQkJdGhpcy5vU2NvcGUgPSBvU2NvcGU7CgkJfQoKCQlfc2VydmVyKCkgewoJCQlsZXQgc2NvcGUgPSB3aW5kb3cuYkxvY2FsID8gInBsYXRmb3JtbWFuYWdlciIgOiBfRnJFTUQuYXBpU2VydmVyLlNjb3BlOwoJCQlyZXR1cm4gbmV3KF9GckVNRC5fX3Njb3BlKHNjb3BlKVtfRnJFTUQuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pLk5hbWVdKSgpOwoJCX0KCgkJX2VudGl0eUZpZWxkKGVjKSB7CgkJCXJldHVybiB7CgkJCQluYW1lOiBlYy5OYW1lLnJlcGxhY2UoL1wgL2csICdfJyksCgkJCQl0aXRsZTogX0ZyRU1ELl90aXRsZUNhc2UoZWMuTmFtZSksCgkJCQlDbGFzczogewoJCQkJCU5hbWU6IGVjLk5hbWUsCgkJCQkJSWQ6IGVjLklkCgkJCQl9LAoJCQkJem9uZTogJ25vcnRoJywKCQkJCXR5cGU6IGVjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChwZWEgPT4gIXBlYS5FbnRpdHlNZXRob2QgJiYgcGVhLkVudGl0eVR5cGUgPT0gZWMpID8gJ3RyZWUnIDogJ3NlbGVjdCcsCgkJCQlwYXJlbnRGaWVsZDogZWMuRW50aXR5QXR0cmlidXRlcy5maW5kKHBlYSA9PiAhcGVhLkVudGl0eU1ldGhvZCAmJiBwZWEuRW50aXR5VHlwZSA9PSBlYyk/Lk5hbWUsCgkJCQkvL3NlYXJjaEZpZWxkOiBlYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSXNTdHJpbmcpLk5hbWUsCgkJCQkvL2lkRmllbGQ6ICdfVG9TdHJpbmcnLAoJCQkJc291cmNlOiAobywgZkRhdGEsIHNUZXh0KSA9PiAoewoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlbZWMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklzU3RyaW5nKS5OYW1lXTogJ2xpa2UnCgkJCQkJfSwKCQkJCQlbZWMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklzU3RyaW5nKS5OYW1lXTogc1RleHQKCgkJCQl9KSwKCQkJfTsKCQl9CgoJCV9lYVRvRmllbGQoZWEpIHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiB7CgkJCQlncm91cDogZWEuR3JvdXAuTmFtZSwKCQkJCW5hbWU6IGVhLk5hbWUsCgkJCQlfdHlwZTogZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQocGVhID0+ICFwZWEuRW50aXR5TWV0aG9kICYmIHBlYS5FbnRpdHlUeXBlID09IGVhLkVudGl0eVR5cGUpID8gJ3RyZWUnIDogJ3NlbGVjdCcsCgkJCQl0eXBlOiAnc2VsZWN0JywKCQkJCXBhcmVudEZpZWxkOiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChwZWEgPT4gIXBlYS5FbnRpdHlNZXRob2QgJiYgcGVhLkVudGl0eVR5cGUgPT0gZWEuRW50aXR5VHlwZSk/Lk5hbWUsCgkJCQkvL2lkRmllbGQ6ICdfVG9TdHJpbmcnLAoJCQkJem9uZTogJ2NlbnRlcicsCgkJCQlDbGFzczogewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZSwKCQkJCQlJZDogZWEuRW50aXR5VHlwZS5JZAoJCQkJfSwKCQkJCXNvdXJjZTogKG8sIGZEYXRhLCBzVGV4dCkgPT4gKHsKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJW2VhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLklzU3RyaW5nKS5OYW1lXTogJ2xpa2UnCgkJCQkJfSwKCQkJCQlbZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuSXNTdHJpbmcpLk5hbWVdOiBzVGV4dAoKCQkJCX0pLAoJCQl9OwoJCQlpZiAoZWEuSXNUZXh0KSByZXR1cm4gewoJCQkJZ3JvdXA6IGVhLkdyb3VwLk5hbWUsCgkJCQluYW1lOiBlYS5OYW1lLAoJCQkJdHlwZTogJ3dpbmRvdycsCgkJCQl6b25lOiAnY2VudGVyJywKCQkJCWVkaXRvcjogdHJ1ZSwKCQkJCWxhbmd1YWdlOiBvID0+IGVhLk5hbWUgPT0gJ3NjcmlwdCcgPyAnamF2YXNjcmlwdCcgOiAidGV4dCIsCgkJCX07CgoJCQlyZXR1cm4gewoJCQkJZ3JvdXA6IGVhLkdyb3VwLk5hbWUsCgkJCQluYW1lOiBlYS5OYW1lLAoJCQkJem9uZTogJ2NlbnRlcicsCgkJCQl0eXBlOiBPYmplY3QuZW50cmllcyh7CgkJCQkJQm9vbDogJ2Jvb2wnLAoJCQkJCURhdGU6ICdkYXRldGltZScsCgkJCQkJSW50OiAnaW50JywKCQkJCQlMb25nOiAnbG9uZycsCgkJCQkJSW1hZ2U6ICdpbWFnZScsCgkJCQkJU3RyaW5nOiAnc3RyaW5nJwoJCQkJfSkuZmluZChlID0+IGVhWydJcycgKyBlWzBdXSlbMV0sCgkJCX07CgkJfQoKCQlidXN5KGJCdXN5KSB7CgkJCXJldHVybiB0aGlzLmRGb3JtLmJ1c3koYkJ1c3kpOwoJCX0KCgkJX21lKHYpIHsKCQkJbGV0IG1lTmFtZSA9ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSA/IChjb21wYW55LmxvZ2dlZEluSWRlbnRpdHkgfHwgIm1lIikgOiAibWUiOwoJCQlpZiAodikgewoJCQkJd2luZG93W21lTmFtZV0gPSB2OwoJCQl9CgoJCQlyZXR1cm4gd2luZG93W21lTmFtZV07CgkJfQoKCQlfY2FuVmlldygpIHsKCQkJaWYgKCF0aGlzLl9tZSgpKSB7CgkJCQl3aW5kb3cuX0ZyRU1ELnNldFVSTCh7CgkJCQkJcGFnZTogJ2xvZ2luJywKCQkJCQlfcmVkaXJlY3Q6IHRoaXMucGFnZS5fY29kZSwKCQkJCX0pOwoJCQkJdGhyb3cgYF9jYW5WaWV3OiAke3RoaXMucGFnZS5fY29kZX0gbm90IGFsbG93ZWQgd2l0aG91dCBsb2dpbiFgOwoJCQl9CgkJfQoKCQlfbmFtZSgpIHsKCQkJaWYgKCF0aGlzLl9tZSgpKSByZXR1cm4gIiI7CgkJCXJldHVybiB0aGlzLl9tZSgpLm5hbWUgPyB0aGlzLl9tZSgpLm5hbWUoKSA6IHRoaXMuX21lKCkuVG9TdHJpbmc7CgkJfQoJfQoKCU1haW5Db21wb25lbnQgPSBjbGFzcyBleHRlbmRzIHRoaXMuQ29yZUNvbXBvbmVudCB7CgkJX21lbnVDbGFzc2VzKHNjb3BlKSB7CgkJCWxldCBvU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgkJCS8vY29uc29sZS5sb2coIk1haW5Db21wb25lbnQ6Ol9tZW51Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogb1Njb3BlIiwgc2NvcGUsIG9TY29wZSwgX0ZyRU1ELmFwaVNlcnZlcik7CgkJCWlmICghb1Njb3BlKSByZXR1cm4gW107CgoJCQlyZXR1cm4gX0ZyRU1ELnNyKCkuZ3JvdXBCeShvU2NvcGUuRW50aXR5Q2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLm1hcChnID0+ICh7CgkJCQlsYWJlbDogKGcua2V5ID8gdGhpcy5kRm9ybS5lbmdsaXNoKGcua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQkJc3ViTWVudXM6IF9GckVNRC5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5kRm9ybS5lbmdsaXNoKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCQlzdWJNZW51czogZ3YudmFsdWVzLm1hcChndnYgPT4gKHsKCQkJCQkJbGFiZWw6IHRoaXMuZEZvcm0uZW5nbGlzaChndnYuTmFtZSksCgkJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJCWRhdGE6IGd2di5OYW1lCgkJCQkJfSkpCgkJCQl9KSkKCQkJfSkpOwoJCX0KCgkJX21lbnVNZXRob2RzKHNjb3BlKSB7CgkJCWxldCBvU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgkJCS8vY29uc29sZS5sb2coIk1haW5Db21wb25lbnQ6Ol9tZW51TWV0aG9kcygiICsgc2NvcGUgKyAiKTogb1Njb3BlIiwgc2NvcGUsIG9TY29wZSwgX0ZyRU1ELmFwaVNlcnZlcik7CgkJCWlmICghb1Njb3BlKSByZXR1cm4gW107CgoJCQlyZXR1cm4gX0ZyRU1ELnNyKCkuZ3JvdXBCeShvU2NvcGUuRW50aXR5Q2xhc3Nlcy5maWx0ZXIoZWMgPT4gZWMuRW50aXR5TWV0aG9kcy5sZW5ndGgpLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJCWxhYmVsOiAoZy5rZXkgPyB0aGlzLmRGb3JtLmVuZ2xpc2goZy5rZXkuTmFtZSkgOiBudWxsKSB8fCAnTWFpbicsCgkJCQlzdWJNZW51czogX0ZyRU1ELnNyKCkuZ3JvdXBCeShnLnZhbHVlcywgJ0dyb3VwJykubWFwKGd2ID0+ICh7CgkJCQkJbGFiZWw6IChndi5rZXkgPyB0aGlzLmRGb3JtLmVuZ2xpc2goZ3Yua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKG1jID0+ICh7CgkJCQkJCWxhYmVsOiB0aGlzLmRGb3JtLmVuZ2xpc2gobWMuTmFtZSksCgkJCQkJCXN1Yk1lbnVzOiBtYy5FbnRpdHlNZXRob2RzLm1hcChlbSA9PiAoewoJCQkJCQkJbGFiZWw6IHRoaXMuZEZvcm0uZW5nbGlzaChlbS5OYW1lKSwKCQkJCQkJCWNvZGU6ICdtZXRob2QnLAoJCQkJCQkJZGF0YTogbWMuTmFtZSArICIuIiArIGVtLk5hbWUKCQkJCQkJfSkpCgkJCQkJfSkpCgkJCQl9KSkKCQkJfSkpOwoJCX0KCgkJX2J1aWxkTWVudShzY29wZSkgewoJCQlyZXR1cm4gW3sKCQkJCWxhYmVsOiAiTWFpbiIsCgkJCQlvcmRlcjogLTEsCgkJCQlzdWJNZW51czogW3sKCQkJCQlsYWJlbDogJ0luZGV4JywKCQkJCX0sIHsKCQkJCQlsYWJlbDogIkxvZ2luIiwKCQkJCX0sIHsKCQkJCQlsYWJlbDogIkxvYWQiLAoJCQkJfSwgewoJCQkJCWxhYmVsOiAiU2F2ZSIsCgkJCQl9LCB7CgkJCQkJbGFiZWw6ICJMb2dvdXQiCgkJCQl9XQoJCQl9LCB7CgkJCQlsYWJlbDogIlByb2Nlc3MiLAoJCQkJb3JkZXI6IDk5OTk4LAoJCQkJc3ViTWVudXM6IHRoaXMuX21lbnVNZXRob2RzKHNjb3BlKQoJCQl9LCB7CgkJCQlsYWJlbDogIlNldHVwIiwKCQkJCW9yZGVyOiA5OTk5OSwKCQkJCXN1Yk1lbnVzOiB0aGlzLl9tZW51Q2xhc3NlcyhzY29wZSkKCQkJfV07CgkJfQoJfQoKCUxvYWRDb21wb25lbnQgPSBjbGFzcyBleHRlbmRzIHRoaXMuQ29yZUNvbXBvbmVudCB7CgkJYXN5bmMgbWFpbigpIHsKCQkJdGhpcy5wYWdlLmRhdGEgPSB7CgkJCQlmb3JtOiB0aGlzLmRGb3JtLnJlbmRlcignZnJtTG9hZCcsICJMb2FkIFNldHVwIERhdGEiLCBbewoJCQkJCW5hbWU6ICdFeGNlbCcsCgkJCQkJdHlwZTogImZpbGUiLAoJCQkJCWJpbmFyeTogdHJ1ZSwKCQkJCQlsb2NhbDogdHJ1ZSwKCQkJCQl1cGxvYWQ6IGFzeW5jIChmRGF0YSwgZGF0YSkgPT4gewoJCQkJCQl0aGlzLmRGb3JtLnNldCh7CgkJCQkJCQlQcm9ncmVzczogMAoJCQkJCQl9KTsKCgkJCQkJCWxldCB0YWJsZXMgPSBbXTsKCQkJCQkJbGV0IG9iaiA9IFtdOwoKCQkJCQkJbGV0IHNlcnZlciA9IHRoaXMuX3NlcnZlcigpOwoKCQkJCQkJY29uc3Qgd2IgPSBuZXcgRXhjZWxKUy5Xb3JrYm9vaygpOwoJCQkJCQljb25zb2xlLmNsZWFyKCk7CgkJCQkJCWxldCB3b3JrYm9vayA9IGF3YWl0IHdiLnhsc3gubG9hZChkYXRhKTsKCQkJCQkJd29ya2Jvb2suZWFjaFNoZWV0KChzaGVldCwgaWQpID0+IHsKCQkJCQkJCWxldCBzVGFibGVzID0gc2hlZXQuZ2V0VGFibGVzKCk7CgkJCQkJCQlzVGFibGVzLmZvckVhY2godCA9PiB0LnRhYmxlLnNoZWV0ID0gc2hlZXQpOwoJCQkJCQkJdGFibGVzLnB1c2goLi4uc1RhYmxlcyk7CgkJCQkJCX0pOwoJCQkJCQl0YWJsZXMgPSB0YWJsZXMuZmxhdCgpLm1hcCh0ID0+IHQudGFibGUpOwoKCQkJCQkJLy9jb25zb2xlLmNsZWFyKCk7CgkJCQkJCXRhYmxlcy5mb3JFYWNoKHQgPT4gewoJCQkJCQkJLy9jb25zb2xlLmxvZyh0Lm5hbWUsIHQuY29sdW1ucywgdC5zaGVldC5nZXRDZWxsKCdBMicpLnZhbHVlKTsKCQkJCQkJCWZvciAodmFyIGkgPSAyOyB0LnNoZWV0LmdldENlbGwoJ0EnICsgaSkudmFsdWUgIT09IG51bGw7IGkrKykgewoJCQkJCQkJCW9iai5wdXNoKHNlcnZlci5fbmV3KHQubmFtZSkuX2Zyb21Eb2N1bWVudChPYmplY3QuYXNzaWduKC4uLnQuY29sdW1ucy5tYXAoKGMsIGNpKSA9PiAoewoJCQkJCQkJCQlbYy5uYW1lXTogdC5zaGVldC5nZXRDZWxsKFN0cmluZy5mcm9tQ2hhckNvZGUoJ0EnLmNoYXJDb2RlQXQoMCkgKyBjaSkgKyBpKS52YWx1ZQoJCQkJCQkJCX0pKSkpKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IG8gb2Ygb2JqKSB7CgkJCQkJCQkvL2F3YWl0IF9GckVNRC5fd2FpdCgxMDAwKQoJCQkJCQkJYXdhaXQgby5zdG9yZSgpOwoJCQkJCQkJdGhpcy5kRm9ybS5zZXQoewoJCQkJCQkJCVByb2dyZXNzOiB0aGlzLmRGb3JtLmdldCgpLlByb2dyZXNzICsgMTAwLjAgLyBvYmoubGVuZ3RoCgkJCQkJCQl9KTsKCQkJCQkJfQoKCQkJCQkJX0ZyRU1ELlJlbmRlclBhZ2UoewoJCQkJCQkJX2NvZGU6ICdsb2dpbicKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSwgewoJCQkJCW5hbWU6ICJQcm9ncmVzcyIsCgkJCQkJdHlwZTogInByb2dyZXNzIiwKCQkJCX1dLCBbewoJCQkJCW5hbWU6ICdMb2FkJywKCQkJCQlvbmNsaWNrOiBhc3luYyBvID0+IHt9CgkJCQl9XSkKCQkJfTsKCQl9Cgl9CgoJU2F2ZUNvbXBvbmVudCA9IGNsYXNzIGV4dGVuZHMgdGhpcy5Db3JlQ29tcG9uZW50IHsKCQlhc3luYyBtYWluKCkgewoJCQkvL3RoaXMuX2NhblZpZXcoKTsKCgkJCXRoaXMucGFnZS5kYXRhID0gewoJCQkJZm9ybTogdGhpcy5kRm9ybS5yZW5kZXIoJ2ZybVNhdmUnLCAiU2F2ZSBTZXR1cCBEYXRhIiwgW3sKCQkJCQluYW1lOiAnU2F2ZScsCgkJCQkJdHlwZTogImxhYmVsIiwKCQkJCQl2YWx1ZTogIkV4cG9ydCB0byBFeGNlbCIsCgkJCQl9LCB7CgkJCQkJbmFtZTogJ1RpdGxlJywKCQkJCQl0eXBlOiAnc3RyaW5nJywKCQkJCQl2YWx1ZTogJycsCgkJCQl9LCB7CgkJCQkJbmFtZTogIlByb2dyZXNzIiwKCQkJCQl0eXBlOiAicHJvZ3Jlc3MiLAoJCQkJfV0sIFt7CgkJCQkJbmFtZTogJ1NhdmUnLAoJCQkJCW9uY2xpY2s6IGFzeW5jIG8gPT4gewoJCQkJCQljb25zb2xlLmNsZWFyKCk7CgoJCQkJCQl0aGlzLmRGb3JtLnNldCh7CgkJCQkJCQlQcm9ncmVzczogMAoJCQkJCQl9KTsKCgkJCQkJCWxldCBzZXJ2ZXIgPSB0aGlzLl9zZXJ2ZXIoKTsKCgkJCQkJCWxldCB0VGVtcGxhdGUgPSB7CgkJCQkJCQloZWFkZXJSb3c6IHRydWUsCgkJCQkJCQlzdHlsZTogewoJCQkJCQkJCXRoZW1lOiAnVGFibGVTdHlsZURhcmszJywKCQkJCQkJCQlzaG93Um93U3RyaXBlczogdHJ1ZSwKCQkJCQkJCX0sCgkJCQkJCX07CgkJCQkJCWxldCB0YWJsZXMgPSBbXTsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCBjIG9mIF9GckVNRC5fX3Njb3BlKHNlcnZlci5TY29wZSkuRW50aXR5Q2xhc3Nlcy5zb3J0KChhLCBiKSA9PiBhLlJhbmsgLSBiLlJhbmspKSB7CgkJCQkJCQkvL2NvbnNvbGUubG9nKCJEeW5hRm9ybTo6U2F2ZUNvbXBvbmVudCgpOiAiICsgYy5OYW1lICsgIiwgUmFuaz0iICsgYy5SYW5rKTsKCQkJCQkJCXRhYmxlcy5wdXNoKE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0VGVtcGxhdGUpKSwgYXdhaXQgc2VydmVyLl9uZXcoYy5OYW1lKS5fdG9UYWJ1bGFyKCkpKTsKCQkJCQkJCXRoaXMuZEZvcm0uc2V0KHsKCQkJCQkJCQlQcm9ncmVzczogdGhpcy5kRm9ybS5nZXQoKS5Qcm9ncmVzcyArIDEwMC4wIC8gX0ZyRU1ELl9fc2NvcGUoc2VydmVyLlNjb3BlKS5FbnRpdHlDbGFzc2VzLmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQkJdGFibGVzLmZvckVhY2godCA9PiB0LnJlZiA9ICdBMTonICsgU3RyaW5nLmZyb21DaGFyQ29kZSgnQScuY2hhckNvZGVBdCgwKSArIHQuY29sdW1ucy5sZW5ndGggLSAxKSArICh0LnJvd3MubGVuZ3RoICsgMSkpOwoKCQkJCQkJbGV0IHJnYiA9IChsZXR0ZXJzID0gJzAxMjM0NTY3ODlBQkNERUYnKSA9PiBBcnJheSg2KS5tYXAoaSA9PiBsZXR0ZXJzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDE2KV0pLmpvaW4oJycpOwoKCQkJCQkJY29uc3Qgd29ya2Jvb2sgPSBuZXcgRXhjZWxKUy5Xb3JrYm9vaygpOwoJCQkJCQl0YWJsZXMuZm9yRWFjaCh0ID0+IHdvcmtib29rLmFkZFdvcmtzaGVldCh0Lm5hbWUsIHsKCQkJCQkJCXByb3BlcnRpZXM6IHsKCQkJCQkJCQl0YWJDb2xvcjogewoJCQkJCQkJCQlhcmdiOiAnRicgKyByZ2IoKQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfSkuYWRkVGFibGUodCkpOwoKCQkJCQkJbGV0IGJ1ZmZlciA9IGF3YWl0IHdvcmtib29rLnhsc3gud3JpdGVCdWZmZXIoewoJCQkJCQkJZGF0ZUZvcm1hdDogJ1lZWVktTU0tREQgSEg6bW06c3MnCgkJCQkJCX0pOwoKCQkJCQkJY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKCQkJCQkJbGluay5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoJCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwoJCQkJCQlsaW5rLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFtidWZmZXJdLCB7CgkJCQkJCQl0eXBlOiAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQ7Y2hhcnNldD1VVEYtOCcKCQkJCQkJfSkpOwoJCQkJCQlsaW5rLmRvd25sb2FkID0gKG8uVGl0bGUgfHwgc2VydmVyLlNjb3BlIHx8ICJkYXRhIikgKyAiLnhsc3giOwoJCQkJCQlsaW5rLmNsaWNrKCk7CgkJCQkJfQoJCQkJfV0pCgkJCX07CgkJfQoJfQoKCUluZGV4Q29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCWFzeW5jIG1haW4oKSB7CgkJCXRoaXMuX2NhblZpZXcoKTsKCgkJCXRoaXMucGFnZS5kYXRhID0gewoJCQkJZm9ybTogdGhpcy5kRm9ybS5yZW5kZXIoJ2ZybUluZGV4JywgIk1haW4gUGFnZSIsIFt7CgkJCQkJbmFtZTogJ1dlbGNvbWUnLAoJCQkJCXJlcXVpcmVkOiB0cnVlLAoJCQkJCXR5cGU6ICJsYWJlbCIsCgkJCQkJdmFsdWU6IHRoaXMuX25hbWUoKSwKCQkJCX1dLCBbXSkKCQkJfTsKCQl9Cgl9CgoJTG9nb3V0Q29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCW1haW4oKSB7CgkJCXRoaXMuX2NhblZpZXcoKTsKCgkJCWRlbGV0ZSB3aW5kb3cubWU7CgoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKCdmcm1Mb2dvdXQnLCAiTG9nb3V0IiwgW3sKCQkJCQkJbmFtZTogIkxvZ291dCIsCgkJCQkJCXR5cGU6ICJsYWJlbCIsCgkJCQkJCXZhbHVlOiAibG9nb3V0IGluIHByb2dyZXNzLi4uIgoJCQkJCX1dLAoJCQkJCVtdKQoJCQl9OwoKCQkJX0ZyRU1ELlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6ICJsb2dpbiIKCQkJfSk7CgkJfQoJfQoKCUxvZ2luQ29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCWFzeW5jIF9hdXRoZW50aWNhdGUobykgewoJCQkvL2lmICghd2luZG93LmJMb2NhbCAmJiAoIV9GckVNRC5fX3Njb3BlKCkgfHwgIV9GckVNRC5fX3Njb3BlKCkuRW50aXR5Q2xhc3NlcykpIHJldHVybjsKCgkJCWxldCBhdXRoQ2xhc3NOYW1lID0gX0ZyRU1ELl9fc2NvcGUoKT8uRW50aXR5Q2xhc3Nlcz8uZmluZChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ3VzZXJuYW1lJykpPy5OYW1lOwoJCQlpZiAoX0ZyRU1ELmFwaVNlcnZlciAmJiBhdXRoQ2xhc3NOYW1lKSByZXR1cm4gYXdhaXQgX0ZyRU1ELmFwaVNlcnZlci5fbmV3KGF1dGhDbGFzc05hbWUpLnVzZXJuYW1lKG8uVXNlcm5hbWUsICc9JykucGFzc3dvcmQoby5QYXNzd29yZCwgJz0nKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5maW5kKCk7CgoJCQlhdXRoQ2xhc3NOYW1lID0gYXV0aENsYXNzTmFtZSB8fCAod2luZG93LmJMb2NhbCA/ICh7CgkJCQljbXM6ICJBdXRob3IiLAoJCQkJZW1zOiAiRW1wbG95ZWUiCgkJCX0pW2NvbXBhbnkuQ29kZV0gOiBudWxsKTsKCgkJCW8uT1BFUkFUT1JTID0gewoJCQkJVXNlcm5hbWU6ICI9IiwKCQkJCVBhc3N3b3JkOiAiPSIKCQkJfTsKCgkJCWlmIChhdXRoQ2xhc3NOYW1lKSByZXR1cm4gKGF3YWl0IHNyLl8oImVtcyIgKyBhdXRoQ2xhc3NOYW1lICsgIkZpbmQiLCBudWxsLCBvKSk7CgkJfQoKCQlhc3luYyBfbG9nZ2VkSW4oKSB7fQoKCQlhc3luYyBfbm90TG9nZ2VkSW4oKSB7fQoKCQlhc3luYyBtYWluKCkgewoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKCdmcm1Mb2dpbicsICJVc2VyIEF1dGhlbnRpY2F0aW9uIiwgW3sKCQkJCQkJbmFtZTogJ1VzZXJuYW1lJywKCQkJCQkJcmVxdWlyZWQ6IHRydWUsCgkJCQkJCXR5cGU6ICJzdHJpbmciCgkJCQkJfSwKCQkJCQl7CgkJCQkJCW5hbWU6ICdQYXNzd29yZCcsCgkJCQkJCXJlcXVpcmVkOiB0cnVlLAoJCQkJCQl0eXBlOiAicGFzc3dvcmQiCgkJCQkJfQoJCQkJXSwgW3sKCQkJCQluYW1lOiAnTG9naW4nLAoJCQkJCWF1dG9TdWJtaXQ6IHRydWUsCgkJCQkJb25jbGljazogYXN5bmMgbyA9PiB7CgkJCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9hdXRoZW50aWNhdGUobyk7CgoJCQkJCQlpZiAocmV0KSB7CgkJCQkJCQl0aGlzLl9tZShyZXQpOwoKCQkJCQkJCXRyeSB7CgkJCQkJCQkJYXdhaXQgdGhpcy5fbG9nZ2VkSW4oKTsKCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoKCQkJCQkJCV9GckVNRC5zZXRVUkwoewoJCQkJCQkJCXBhZ2U6IF9GckVNRC5oYXNoLl9yZWRpcmVjdCB8fCAiaW5kZXgiCgkJCQkJCQl9KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXRyeSB7CgkJCQkJCQkJYXdhaXQgdGhpcy5fbm90TG9nZ2VkSW4oKTsKCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoKCQkJCQkJCXRoaXMuZEZvcm0uZXJyb3IoIkludmFsaWQgdXNlcm5hbWUgb3IgcGFzc3dvcmQiKTsKCQkJCQkJfQoKCQkJCQkJdGhpcy5kRm9ybS5idXN5KGZhbHNlKTsKCQkJCQl9CgkJCQl9XSkKCQkJfTsKCQl9Cgl9CgoJTWV0aG9kQ29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCWFzeW5jIG1haW4oKSB7CgkJCXRoaXMuX2NhblZpZXcoKTsKCgkJCXRoaXMuc01ldGhvZCA9IHRoaXMucGFnZS5kYXRhOwoJCQljb25zb2xlLmNsZWFyKCk7CgoJCQlsZXQgZWMgPSAoX0ZyRU1ELl9fc2NvcGUoKSB8fCB0aGlzLm9TY29wZSkuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IHRoaXMuc01ldGhvZC5zcGxpdCgnLicpWzBdKTsKCQkJbGV0IGVtID0gZWMuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHRoaXMuc01ldGhvZC5zcGxpdCgnLicpWzFdKTsKCgkJCXRoaXMucGFnZS5kYXRhID0gewoJCQkJZm9ybTogdGhpcy5kRm9ybS5yZW5kZXIodGhpcy5zTWV0aG9kLCBfRnJFTUQuX3RpdGxlQ2FzZShlYy5OYW1lKSArICcgOjogJyArIF9GckVNRC5fdGl0bGVDYXNlKGVtLk5hbWUpLCBbdGhpcy5fZW50aXR5RmllbGQoZWMpXS5jb25jYXQoLi4uZW0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiB0aGlzLl9lYVRvRmllbGQocCkpKSwgW3sKCQkJCQluYW1lOiAnUmVzZXQnLAoJCQkJCW9uY2xpY2s6IG8gPT4gewoJCQkJCQl0aGlzLmRGb3JtLmNsZWFyKCk7CgkJCQkJfSwKCQkJCQlpY29uOiAiY2FuY2VsIgoJCQkJfSwgewoJCQkJCW5hbWU6ICdSZWxvYWQnLAoJCQkJCW9uY2xpY2s6IG8gPT4gX0ZyRU1ELlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogJ21ldGhvZCcKCQkJCQl9LCB0aGlzLnBhZ2UuZGF0YSksCgkJCQkJaWNvbjogInJlbG9hZCIKCQkJCX0sIHsKCQkJCQluYW1lOiBlbS5OYW1lLAoJCQkJCXRpdGxlOiBfRnJFTUQuX3RpdGxlQ2FzZShlbS5OYW1lKSwKCQkJCQlvbmNsaWNrOiBhc3luYyBvID0+IHsKCQkJCQkJbGV0IG9iaiA9IG9bZWMuTmFtZV0gfHwgX0ZyRU1ELmFwaVNlcnZlci5fbmV3KGVjLk5hbWUpOwoJCQkJCQljb25zb2xlLmxvZygib25jbGljaygpIiwgZWMuTmFtZSwgb2JqLCBvLCBvW2VjLk5hbWVdKTsKCQkJCQkJLy9pZiAob1t0aGlzLnNUYWJsZV0gJiYgdHlwZW9mKG9bdGhpcy5zVGFibGVdLl9fc3luY19vbikgPT09ICdmdW5jdGlvbicgJiYgb1t0aGlzLnNUYWJsZV0uX19zeW5jX29uKCkpIG9iai5JZCA9IG9bdGhpcy5zVGFibGVdLklkOwoKCQkJCQkJYXdhaXQgb2JqW2VtLk5hbWVdKC4uLmVtLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gb1twLk5hbWVdKSk7CgkJCQkJfQoJCQkJfV0pCgkJCX07CgkJfQoJfQoKCVN0b3JlQ29tcG9uZW50ID0gY2xhc3MgZXh0ZW5kcyB0aGlzLkNvcmVDb21wb25lbnQgewoJCWFzeW5jIG1haW4oKSB7CgkJCXRoaXMuX2NhblZpZXcoKTsKCgkJCXRoaXMuc1RhYmxlID0gdGhpcy5wYWdlLmRhdGE7CgkJCWNvbnNvbGUuY2xlYXIoKTsKCgkJCS8vY29uc29sZS5sb2coIkR5bmFGb3JtOjpTdG9yZUNvbXBvbmVudCgpOiBzVGFibGUiLCB0aGlzLnNUYWJsZSk7CgoJCQlsZXQgZWMgPSBfRnJFTUQuX19zY29wZSgpLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSB0aGlzLnNUYWJsZSk7CgoJCQl0aGlzLnBhZ2UuZGF0YSA9IHsKCQkJCWZvcm06IHRoaXMuZEZvcm0ucmVuZGVyKGVjLk5hbWUucmVwbGFjZSgvXCAvZywgJ18nKSwgX0ZyRU1ELl90aXRsZUNhc2UoZWMuTmFtZSksIFtPYmplY3QuYXNzaWduKHRoaXMuX2VudGl0eUZpZWxkKGVjKSwgewoJCQkJCXNlbGVjdDogYXN5bmMgbyA9PiB7CgkJCQkJCXRoaXMuZEZvcm0uY2xlYXIoKTsKCQkJCQkJdGhpcy5kRm9ybS5idXN5KHRydWUpOwoKCQkJCQkJbGV0IHIgPSBhd2FpdCBvLmZpbmQoKTsKCQkJCQkJdGhpcy5kRm9ybS5zZXQoT2JqZWN0LmFzc2lnbih7CgkJCQkJCQlbZWMuTmFtZS5yZXBsYWNlKC9cIC9nLCAnXycpXTogcgoJCQkJCQl9LCAuLi5lYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5maWx0ZXIoZWEgPT4gdHlwZW9mKHJbZWEuTmFtZV0oKSkgIT09ICd1bmRlZmluZWQnKS5tYXAoZWEgPT4gKHsKCQkJCQkJCVtlYS5OYW1lXTogcltlYS5OYW1lXSgpCgkJCQkJCX0pKSkpOwoJCQkJCQl0aGlzLmRGb3JtLmJ1c3koZmFsc2UpOwoJCQkJCX0KCQkJCX0pXS5jb25jYXQoLi4uZWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IHRoaXMuX2VhVG9GaWVsZChlYSkpKSwgW3sKCQkJCQluYW1lOiAnUmVzZXQnLAoJCQkJCW9uY2xpY2s6IG8gPT4gewoJCQkJCQl0aGlzLmRGb3JtLmNsZWFyKCk7CgkJCQkJfSwKCQkJCQlpY29uOiAiY2FuY2VsIgoJCQkJfSwgewoJCQkJCW5hbWU6ICdSZWxvYWQnLAoJCQkJCW9uY2xpY2s6IG8gPT4gX0ZyRU1ELlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogJ3N0b3JlJwoJCQkJCX0sIHRoaXMucGFnZS5kYXRhKSwKCQkJCQlpY29uOiAicmVsb2FkIgoJCQkJfSwgewoJCQkJCW5hbWU6ICdTYXZlJywKCQkJCQlvbmNsaWNrOiBhc3luYyBvID0+IHsKCQkJCQkJbGV0IG9iaiA9IF9GckVNRC5hcGlTZXJ2ZXIuX25ldyh0aGlzLnNUYWJsZSk7CgkJCQkJCS8vY29uc29sZS5sb2coIm9uY2xpY2soKSIsIHRoaXMuc1RhYmxlLCBvYmosIG8sIG9bdGhpcy5zVGFibGVdKTsKCQkJCQkJaWYgKG9bdGhpcy5zVGFibGVdICYmIHR5cGVvZihvW3RoaXMuc1RhYmxlXS5fX3N5bmNfb24pID09PSAnZnVuY3Rpb24nICYmIG9bdGhpcy5zVGFibGVdLl9fc3luY19vbigpKSBvYmouSWQgPSBvW3RoaXMuc1RhYmxlXS5JZDsKCgkJCQkJCWVjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLmZvckVhY2goZWEgPT4gb2JqW2VhLk5hbWVdKG9bZWEuTmFtZV0pKTsKCQkJCQkJLy9yZXR1cm4gY29uc29sZS5sb2cob2JqLl90b0ZpbGVOYW1lKCksIG9iaik7CgkJCQkJCWF3YWl0IG9iai5zdG9yZSgpOwoJCQkJCX0KCQkJCX1dKQoJCQl9OwoJCX0KCX0KCS8qKiBDb21wb25lbnRzOjpFbmQgKiovCn07",
	"Name": "DynaForm",
	"Script": "window.DynaForm = class {
	constructor() {
		this.title = "Form Title";
		this.name = "frmForm";
		this.elements = [];
		this.selects = [];
		this.grids = [];
		this.buttons = [];
		this.zones = ['north', 'south', 'east', 'west', 'center'];
		this.sTable = null;
		this.bDebug = false;
		this.uiTypes = {
			int: "numberspinner",
			menu: "splitbutton",
			datetime: "datetimebox",
			bool: "switchbutton",
			file: "filebox",
			text: "textbox",
			label: "html",
			password: "passwordbox",
			string: "textbox",
			image: "dialog",
			progress: "progressbar",
			link: "linkbutton",
			tree: "combotree",
			navigation: "tree",
			search: 'searchbox',
		};
		this.events = [{
			name: 'onClick',
			handler: 'onToggle',
			params: 'n=event',
			type: 'toggle',
		}, {
			name: 'onClose',
			handler: 'PanOnClose',
			params: 'n=event',
			type: 'window',
		}, {
			name: 'onSelect',
			handler: 'SelectChange',
			params: 'n',
			type: 'tabs',
		}, {
			name: 'searcher',
			handler: 'FieldChange',
			params: 'n, o',
			type: 'searchbox',
		}, {
			name: 'onBeforeExpand',
			handler: 'Expand',
			params: 'n',
			type: 'tree',
		}, {
			name: 'onChange',
			handler: 'FieldChange',
			params: 'n, o',
		}, {
			name: 'onBeforeOpen',
			handler: 'PanelOpen',
			params: '',
			type: 'window',
		}, {
			name: 'onOpen',
			handler: 'PendAfterOpen',
			params: '',
			type: 'window',
		}, {
			name: 'onClick',
			handler: 'doLink',
			params: 'n=event, o',
			type: 'link',
		}, {
			name: 'onClickRow',
			handler: 'FieldChange',
			params: 'n, o',
			type: 'grid',
		}];

		if (typeof($) !== 'undefined') $(window).resize(this.windowResized);
		this.windowResized();
	}

	sr() {
		return typeof(_FrEMD) !== 'undefined' ? _FrEMD.sr() : window.sr;
	}

	parse() {
		$.parser.parse();
	}

	windowResized() {
		this.width = window.innerWidth;
		this.height = window.innerHeight * 0.8;
	}

	init() {
		var select = {
			init: function(container, options) {
				var op = null;
				var fop = null;
				for (var i = 0; i < this.grids.length; i++)
					if (true || this.grids[i].id == options.source) op = this.grids[i].options;
				for (i = 0; i < op.columns.length; i++)
					if (op.columns[i].name == options.field) fop = op.columns[i];
				fop.width = (this.width / 3);
				var e = $(this.select(fop));
				var input = e.appendTo(container);
				input.combogrid();
				this.bind(input);
				return input;
			},
			destroy: function(target) {
				$(target).remove();
			},
			getValue: function(target) {
				return $(target).val();
			},
			setValue: function(target, value) {
				$(target).val(value);
			},
			resize: function(target, width) {
				$(target)._outerWidth(width);
			}
		};
		$.extend($.fn.datagrid.defaults.editors, {
			datetime: {
				init: function(container, options) {
					options.width = this.cWidth(options);
					var input = $(this.datetime(options)).appendTo(container);
					input.datetimebox();
					return input;
				},
				destroy: function(target) {
					$(target).remove();
				},
				getValue: function(target) {
					return $(target).val();
				},
				setValue: function(target, value) {
					$(target).val(value);
				},
				resize: function(target, width) {
					$(target)._outerWidth(width);
				}
			},
			checkbox: {
				init: function(container, options) {
					var input = $(this.bool(options)).appendTo(container);
					input.switchbutton();
					return input;
				},
				destroy: function(target) {
					$(target).remove();
				},
				getValue: function(target) {
					return $(target).val();
				},
				setValue: function(target, value) {
					$(target).val(value);
				},
				resize: function(target, width) {
					$(target)._outerWidth(width);
				}
			},
			combotreegrid: select,
			select: select,
		});
	}

	ask(question, fAnswer = v => v, options) {
		$.messager.confirm(this.title, question, function(r) {
			if (options) {
				for (var i = 0; i < options.length; i++) {
					if (options[i].answer == r) {
						return fAnswer(options[i].value);
					}
				}
			} else {
				return fAnswer(r);
			}
		});
	}

	topData(ar, gField, vField, top) {
		if (!top) {
			return ar;
		}
		ret = [];
		$.each(this.sr().groupBy(ar, gField), function(key, values) {
			values.values.sort((a, b) => {
				if (parseFloat(a[vField]) < parseFloat(b[vField])) {
					return 1;
				} else if (parseFloat(a[vField]) > parseFloat(b[vField])) {
					return -1;
				} else {
					return 0;
				}
			});
			$.each(values.values, function(i, v) {
				if (i < top) {
					ret.push(v);
				}
			});
		});
		return ret;
	}

	async doClick(button) {
		let _this = typeof(this.doClick) === 'function' ? this : window.DForm;
		button = _this.buttons.find(b => b.name == button.name && b.group == button.group);
		_this.busy(true);
		_this.set({
			WorkProgressValue: 20
		})

		var o = _this.get();
		var sMissing = _this.elements.filter(e => (button.window ? button.group == e.group : true)).filter(e => e.required && !o[e.name]).map(e => "<li>" + (e.label || e.name) + "</li>").join("");
		if (sMissing) {
			window._FrEMD._error("Missing mandatory fields:<br/><ul>" + sMissing + "</ul>", 5000);
			_this.busy(false);
			return;
		}
		if (button.onclick) await button.onclick(o);
		if (button.onClick) await button.onClick(o);
		_this.busy(false);
	}

	busy(bBusy) {
		if (!bBusy) {
			var total = 0;
			if (typeof moment !== 'undefined') {
				total = moment().diff(moment(this.busyStamp), 'seconds');
			} else {
				// no moment, use standard Date
				total = (new Date().getTime() - this.busyStamp ? this.busyStamp.getTime() : 0) / 1000 / 3600;
			}
			if (this.bDebug) {
				window._FrEMD._alert("Execution Time: " + total + " seconds.");
			}
			delete this.busyStamp;

			setInterval(1, () => this.Set({
				Loading: 10
			}));
		} else {
			this.busyStamp = new Date();
		}

		$.each($.merge($.map(this.buttons, b => b.name), $.map(this.elements.filter(e => e.type == 'link'), e => e.name)), (_, e) => $('#' + e).linkbutton(bBusy ? 'disable' : 'enable'));
	}

	prefix(e) {
		switch (e.type) {
			case 'label':
				return 'lbl';
			case 'text':
			case 'string':
			case 'search':
			case 'password':
				return 'txt';
			case "DateTime":
			case "datetime":
				return 'dtp';
			case "int":
			case "integer":
			case "number":
			case "long":
			case "Long":
				return 'nud';
			case 'file':
				return 'fil';
			case 'image':
				return 'img';
			case "bool":
				return 'chk';
			case "window":
				return 'pnl';
			case "progress":
				return 'prg';
			case "grid":
			case "tree":
			case "select":
				return 'cmb';
			default:
				return '';
		}
	}

	clear(group) {
		var o = {};
		$.each(this.elements.filter(e => group ? e.group == group : true), (_, e) => {
			var name = (e.emsSource ? "_" : "") + e.name;
			switch (e.type) {
				case 'text':
				case 'string':
				case 'search':
				case 'password':
				case "DateTime":
				case "datetime":
					o[name] = "";
					break;
				case "int":
				case "number":
				case "integer":
				case "long":
				case "Long":
				case "progress":
					o[name] = 0;
					break;
				case "tree":
				case "select":
					o[name] = null;
					break;
				case "grid":
					o[name] ? o[name].data = [] : null;
					break;
				case "bool":
					o[name] = false;
					break;
				default:
					break;
			}
		});
		//console.log("clear", o);
		this.set(o);
		this.busy(false);
	}

	set(o, eName) {
		if (eName) {
			var oElement = this.byName(eName);
			if (!oElement) return;
			var att = null;
			if (o && o.Id && o.EntityAttribute) {
				// an EntityValue
				for (var p in o)
					if (p.endsWith("Value")) att = p;
				oElement.emsSource = o;
			}
			try {
				let eName = "#" + this.prefix(oElement) + oElement.name;
				let eType = this.uiTypes[oElement.type];
				// console.log("DynaForm::set(" + oElement.name + "): ", eName, eType, o);
				switch (oElement.type) {
					case 'label':
						if (att) {
							$(eName).html(o[att]);
						} else {
							$(eName).html((o && o.EntityAttribute) ? "" : o);
						}
						break;
					case 'text':
					case 'string':
					case 'password':
					case "int":
					case "search":
					case "integer":
					case "number":
					case "long":
					case "Long":
						if (att) {
							$(eName)[eType]("setValue", o[att]);
						} else {
							$(eName)[eType]("setValue", (o && o.EntityAttribute) ? "" : o);
						}
						break;
					case "DateTime":
					case "datetime":
						if (att) {
							$(eName)[eType]('setValue', (o[att] ? this.sr().toDateTime(o[att]) : ""));
						} else {
							$(eName)[eType]('setValue', (o && o.EntityAttribute) ? "" : (o ? this.sr().toDateTime(o) : ""));
						}
						break;
					case "bool":
						if (att) {
							$(eName)[eType]((o[att] ? '' : 'un') + 'check');
						} else {
							$(eName)[eType]((((o && o.EntityAttribute) ? "" : o) ? '' : 'un') + 'check');
						}
						break;
					case "window":
						if (att) {
							oElement.value = o[att];
						} else {
							oElement.value = (o && o.EntityAttribute) ? "" : o;
						}
						break;
					case "progress":
						var v = 0;
						if (att) {
							v = o[att];
						} else {
							v = (o && o.EntityAttribute) ? "" : o;
						}
						//console.log("#" + this.prefix(oElement) + oElement.name, this.uiTypes[oElement.type], Math.round(v * 10) / 10);
						$(eName)[eType]('setValue', Math.round(v * 10) / 10);
						break;
					case "grid":
						let cols = JSON.parse("{" + this.mapColumns(oElement, true) + "}");
						$.each(cols.columns[0], (_, c) => c.formatter = this.sr().runScript(this.formatter(oElement.name, c)));
						$(eName).datagrid(cols);
						if (att) {
							$(eName).datagrid({
								data: o[att]
							});
						} else {
							$(eName).datagrid({
								data: (o && o.EntityAttribute) ? "" : o
							});
						}
						$(eName).datagrid("unselectAll");
						$(eName).datagrid();
						break;
					case "tree":
						var v = att ? o[att] : ((o && o.EntityAttribute) ? "" : o);
						if (Array.isArray(v)) {
							$(eName)[eType]("tree").tree("loadData", v);
						} else {
							$(eName)[eType]('setValue', v);
						}
						break;
					case "select":
						if (att) {
							if (oElement.options) {
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
							} else {
								$(eName).combogrid('setValue' + (oElement.multiple ? 's' : ''), (o[att] ? o[att] : ""));
							}
						} else {
							v = null;
							if (o === null) {

							} else if (o.constructor === Array) {

							} else if (!o.EntityAttribute) {
								v = o || {
									Id: o.Id,
									_ToString: o._ToString,
									toString: function() {
										return this._ToString;
									}
								};
							}
							if (oElement.options) {
								$(eName).combo('setValue' + (oElement.multiple ? 's' : ''), v);
								$(eName).combo('setText' + (oElement.multiple ? 's' : ''), v);
							} else {
								$(eName).combogrid('setValue' + (oElement.multiple ? 's' : ''), v);
							}
						}
						break;
					default:
						break;
				}
			} catch (ex) {
				console.log(ex);
			}
		} else {
			for (var p in o) {
				if (p.indexOf('_') === 0) p = p.substring(1);
				var e = this.byName(p);
				if (!e || !e.name) continue;
				var value = o[p];
				if (e.name == this.sTable) {
					value = o;
					value.Date = new Date();
				}
				if (p == "EntityValues") {
					// an emsFormValues source
					// find the EntityValue for this element and set it
					for (var j = 0; j < o.EntityValues.length; j++) {
						if (o.EntityValues[j].EntityAttribute.Name == e.name) {
							// found the EntityValue for this element
							_v = o.EntityValues[j];
							for (var q in _v) {
								if (q.endsWith("Value")) {
									_v[q] = value;
								}
							}
							break;
						}
					}
				}
				this.set(value, e.name);
			}
		}
	}

	get() {
		var o = {};
		if (this.sTable && window[this.sTable]) o = new window[this.sTable]();
		for (var i = 0; i < this.elements.length; i++) {
			var cn = null;
			var v = null;
			try {
				let eName = "#" + this.prefix(this.elements[i]) + this.elements[i].name;
				switch (this.elements[i].type) {
					case 'label':
						cn = $(eName);
						v = cn.html();
						break;
					case 'text':
					case 'string':
					case 'search':
					case 'password':
						cn = $(eName);
						v = cn.val();
						break;
					case "file":
					case "image":
						cn = $(eName);
						v = this.elements[i].data;
						break;
					case "DateTime":
					case "datetime":
						v = new Date($(eName).datetimebox('getValue'));
						cn = $(eName);
						break;
					case "progress":
						cn = $(eName);
						v = cn.progressbar('getValue');
						break;
					case "int":
					case "integer":
					case "number":
					case "long":
					case "Long":
						cn = $(eName);
						v = parseFloat(cn.val());
						if (isNaN(v)) v = 0;
						break;
					case "grid":
						cn = $(eName);
						v = cn.datagrid('getData');
						v.selected = cn.datagrid("getSelected");
						break;
					case "tree":
						cn = $(eName);
						v = cn.combotree("tree").tree("getSelected");
						break;
					case "window":
						v = this.elements[i].value;
						break;
					case "select":
						if (this.elements[i].options) {
							v = $(eName).combogrid('getValue' + (this.elements[i].multiple ? 's' : ''));
							v = this.sr().runScript(v);
						} else {
							v = $(eName).combogrid('grid').datagrid('getSelections');
							if (!v || !v.length) {
								v = $(eName).combogrid('getValue' + (this.elements[i].multiple ? 's' : ''));
							} else {
								if (!this.elements[i].multiple) v = v[0];
							}
						}
						cn = $(eName);
						break;
					case "bool":
						cn = $(eName);
						v = cn.switchbutton('options').checked;
						break;
					default:
						break;
				}
				o[this.elements[i].name](v);
			} catch (e) {
				//console.log(this.elements[i].name, e);
				o[this.elements[i].name] = v;
			}
			if (cn) {
				if (o.EntityValues) {
					for (var j = 0; j < o.EntityValues.length; j++) {
						if (this.elements[i].name == this.sTable && this.elements[i].emsSource) o.Id = this.elements[i].emsSource.Id;
						if (o.EntityValues[j].EntityAttribute.Name == this.elements[i].name && this.elements[i].emsSource) {
							o.EntityValues[j].Id = this.elements[i].emsSource.Id;
						}
					}
				}
			}
		}
		return o;
	}

	cHeight(options) {
		if (options && options.editor) return window.innerHeight;
		if (options && options.height && typeof(options.height) === 'string') return this.height;
		if (options && options.type == 'window' && !options.height) return this.height * 0.9;
		return Math.floor(((options ? options.height : null) || (this.height / 3)));
	}

	search(options) {
		return this.string(options);
	}

	string(options) {
		options.height = 20;
		options.simple = true;
		return this.text(options);
	}

	datetime(options) {
		return `<input id="dtp${options.name}" class="easyui-${this.uiTypes[options.type]}" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" style="width:${this.cWidth(options)}px">`;
	}

	query(options) {
		return "<div id='vs" + options.name + "'></div>";
	}

	DateTime(options) {
		return this.datetime(options);
	}

	long(options) {
		return this.int(options);
	}

	Long(options) {
		return this.long(options);
	}

	value(options) {
		if (typeof options.value === 'function') {
			try {
				return options.value(this.get());
			} catch (ex) {
				console.log(`DForm.value(${options.name}): ${ex}`);
				return '';
			}
		} else {
			switch (options.type) {
				case 'int':
				case 'progress':
					return options.value || options.min || 0;
				case 'string':
				case 'text':
				case 'datetime':
				case 'label':
					return options.value || "";
				default:
					return options.value;
			}
		}
	}

	int(options) {
		let ret = `<input id="nud${options.name}" class="easyui-${this.uiTypes[options.type]}" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" data-options="min:${options.min || 0},max:${options.max || 100},increment:${options.increment || 1}" style="width:${this.cWidth(options)}px;"></input>`;
		//console.log(ret);
		return ret;
	}

	menu(options) {
		options.type = options.type || 'menu';

		options.menu = (options.menu || []).sort((a, b) => a.order - b.order);

		//console.log("DynaForm::menu(): options", options);

		let ret = "";
		ret += '<div class="easyui-panel" id="mnu' + options.name + '" style="padding:5px;">\n';

		ret += options.menu.map(m => `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options="menu:'#mm${m.label.replace(/ /g, '')}',iconCls:'icon-${m.icon || 'none'}'">${m.label}</a>`).join('\n');

		/*$.each(options.menu, (_, m) => ret += `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options="menu:'#mm${m.label.replace(/ /g, '')}',iconCls:'icon-${m.icon || 'none'}'">${m.label}</a>\n`);*/
		ret += "</div>\n";

		let dv = m => {
			let ret = '<div' + (m.subMenus ? '' : ` data-options="iconCls:'icon-${m.icon || 'none'}'"`) + '>\n';
			ret += m.subMenus ? '<span>' + (m.label || this.english(m.code)) + '</span>\n<div>' : (`<span width='100%' onclick='(async () => {let m = ${_FrEMD._toJS(m)}; if(m.action){return await m.action(DForm.get(), m);} if (m.subMenus) return; await _FrEMD.RenderPage({_code: m.code || m.label.replace(/ /g, "").toLowerCase()}, m.data);})()'>${m.label || this.english(m.code)}</span>`);
			$.each(m.subMenus, (_, s) => ret += dv(s));
			ret += (m.subMenus ? "</div>\n" : "") + `</div>\n`;
			return ret;
		};

		ret += options.menu.map(m => `<div id="mm${m.label.replace(/ /g, '')}" style="width:150px;">${m.subMenus.map(sm => dv(sm)).join('')}</div>`).join('\n');

		return ret;
	}

	integer(options) {
		return this.int(options);
	}

	number(options) {
		return this.int(options);
	}

	Integer(options) {
		return this.int(options);
	}

	bool(options) {
		return `<input id="${this.prefix(options)}${options.name}" data-dform="element:${options.name}" required="${options.required?'true':'false'}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}' class="easyui-${this.uiTypes[options.type]}" ${options.checked?'checked':''} />`;
	}

	label(options) {
		return `<span id="${this.prefix(options)}${options.name}" style="width:${this.cWidth(options)}px" data-options="disabled:${options.disabled?'true':'false'}">${this.value(options)}</span>`;
	}

	url(options) {
		return this.string(options).replace("FieldChange", "URLChange");
	}

	text(options) {
		return `<input id="${this.prefix(options)}${options.name}" class="easyui-${options.editor || this.uiTypes[options.type]}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}' multiline="${options.simple ? 'false' : 'true'}" style="white-space:pre-wrap;width:${this.cWidth(options)}px;height:${this.cHeight(options)}px" required="${options.required ? 'true' : 'false'}" value="${this.value(options)}" />`;
	}

	password(options) {
		var ret = this.string(options);
		ret = ret.replace('<input ', '<input type="password" ');
		return ret;
	}

	file(options) {
		return `<input id="${this.prefix(options)}${options.name}" class="easyui-${this.uiTypes[options.type]}" data-options="onChange:function(n,o){var s = $('#' + this.id).filebox('options'); DForm.UploadFile(s, DForm.byName('${options.name}'));}" style="width:${this.cWidth(options)}px">`;
	}

	image(options) {
		return this.file(options) + `<div id="dlg${options.name}" class="easyui-${this.uiTypes[options.type]}" title="Image Preview" data-options="closed:true,iconCls:'icon-save',resizable:false,modal:true" style="width:400px;height:200px;padding:10px"><img id="${this.prefix(options)}${options.name}" width="100%" height="100%"/></div>`;
	}

	progress(options) {
		if (!options.height) options.height = 20; // fix big progress
		return `<div id="${this.prefix(options)}${options.name}" class="easyui-${this.uiTypes[options.type]}" data-options="value:${this.value(options)}" style="width:${this.cWidth(options)}px;height:${this.cHeight(options)}px"></div>`;
	}

	flowchart(options) {
		return `<div id="flw${options.name}" width="${this.cWidth(options)}" height="${this.cHeight(options)}"></div>`;
	}

	chart(options) {
		return `<div id="cht${options.name}" width="${this.cWidth(options)}" height="${this.cHeight(options)}"></div>`;
	}

	formatter(name, c, json) {
		json = json ? '"' : '';
		return `${json}(value, row, index) => {try{var c = (DForm.byName(\`${name}\`).columns || []).find(c => c.field==\`${c.field}\`); return c&&c.format?c.format(value,row,index):value;}catch(ex){return value;} }${json}`;
	}

	mapColumns(options, json) {
		let cTitle = c => c.title || this.english(c.field);

		var cols = $.grep(options.columns || [], c => !c.ignore);
		let ret = "";
		if (options.multiple) ret += `{"field":'ck',"checkbox":true},`;
		ret = `"frozenColumns": [[`;
		if (!options.frozen) {
			ret += `{"field":"${options.idField.field}","title": "${options.idField.title}","sortable": "true", "formatter": ${this.formatter(options.name, options.idField, json)}},`;
			if (options.textField.field != options.idField.field) ret += `{"field":"${options.textField.field || options.textField.title}","title":"${options.textField.title || options.textField.field}","width":"${options.textField.width||120}", "sortable": "true", "formatter": ${this.formatter(options.name, options.textField, json)}}`;
		} else {
			$.map($.grep(cols, c => c.frozen), c => `{"field":"${c.field || cTitle(c)}","title":"${cTitle(c) || c.field}","width":"${c.width||120}","align":'left',"sortable":"true", "formatter": ${this.formatter(options.name, c, json)}}`).join(",");
		}
		ret += `]], "columns": [[`;
		ret += $.map($.grep(cols, c => !c.frozen), c => `{"field":"${c.field || cTitle(c)}","title":"${cTitle(c) || c.field}","align":"left","sortable":"true", "formatter": ${this.formatter(options.name, c, json)}}`).join(",");
		ret += ']]';

		//console.log("DynaForm::mapColumns(" + options.name + "): ", ret, json);
		return ret;
	}

	select(options, tag = options.tag, type) {
		return this.combo(options, tag, type);
	}

	tree(options) {
		return this.select(options, "select");
	}

	navigation(options) {
		return this.combo(options, 'ul', 'tree');
	}

	combo(options, tag, type) {
		var cols = $.grep(options.columns || [], c => !c.ignore);
		tag = tag || "select";

		options.idField = $.uniqueSort([{
			field: options.idField,
			title: options.idField
		}].concat($.grep(cols, c => c.primary), [{
			field: 'Id',
			title: 'ID'
		}])).find(x => typeof(x.field) !== "undefined");

		options.textField = $.uniqueSort([{
			field: options.textField,
			title: options.textField
		}].concat($.grep(cols, c => c.display), [{
			field: '_ToString',
			title: options.name,
		}])).find(x => typeof(x.field) !== "undefined");

		//console.log("DynaForm::combo(): options", options);

		var fun = type || this.eFun(options);

		var dropdown = ['combotreegrid', 'combotree', 'combogrid', 'select'].indexOf(fun) > -1;
		if (dropdown) this.selects.push({
			id: "cmb" + options.name,
			options: this.byName(options.name)
		});
		this.selects = $.uniqueSort(this.selects);
		var ret = `<${tag} id="cmb${options.name}" class="easyui-${fun}" style="max-width:${dropdown?'400px':this.cWidth(options)}; width:${this.cWidth(options)}px" required="${(options.required ? 'true' : 'false')}" data-options='disabled:${options.disabled?'true':'false'},${this.eventHandlers(options)}, value:"${this.value(options)}", rownumbers:${typeof(options.rowNumbers)!=='undefined'?options.rowNumbers:(fun.indexOf('tree')<-1?'false':'true')}, pagination:${typeof(options.pagination)!=='undefined'?options.pagination:(fun.indexOf('tree')<-1?'false':'true')}, panelWidth:${2*this.cWidth(options)}, fitColumns: true, singleSelect: true, multiple:${(options.multiple || 'false')}, idField: "${options.idField.field}", enableFilter: ${options.filter?'true':'false'}, nowrap: false, textField: "${options.textField.field}", treeField: "${options.textField.field}",`;
		if (fun.indexOf('tree') == -1) {
			ret += 'fitColumns: false,' + this.mapColumns(options);
		}
		if (options.data) {
			ret += `,data: ${JSON.stringify(options.data)}`;
		}
		ret += `'>`;
		if (options.options) {
			ret += $.map(options.options, o => `<option value='${_FrEMD._toJS(o)}'>${o.name || o}</option>`).join('\n');
		}
		ret += `</${tag}>`;
		// console.log(ret);
		return ret;
	}

	grid(options, tag, type) {
		return this.combo(options, "table", "datagrid");
	}

	treegrid(options) {
		return this.combo(options, 'table', 'tree');
	}

	async doLink(e, event) {
		this.busy(true);
		try {
			await e.links.find(l => l.label == event.target.innerText).onClick(this.get());
		} catch (ex) {
			console.log("DynaForm::doLink(): Exception: " + ex);
		}
		this.busy(false);
	}

	EditedValue(e) {
		return (typeof(ace) !== "undefined") ? ace.edit('pnl' + e.name).session.getValue() : '';
	}

	async PanOnClose(e) {
		if (e.editor) {
			e.value = this.EditedValue(e);
		}
		if (e.close) {
			await e.close(this.get());
		}
	}

	async PendAfterOpen(e) {
		if (e.editor && typeof(ace) !== "undefined") {
			await _FrEMD.OpenEditor('pnl' + e.name /*+ '-center'*/ , e.language, e.loader || (o => e.value), e.saver, this.get(), e);
		}
		if (e.open) {
			await e.open(this.get());
		}
	}

	link(options) {
		return (options.links || []).filter(l => !l.ignore).map(l => `<a href="#" class="easyui-${this.uiTypes[options.type]}" data-options='${this.eventHandlers(options)}, iconCls:"icon-${l.icon || 'ok'}"'>${l.label}</a>`).join('\n');
	}

	async SetTreeData(e, n, data) {
		$.each($("#cmb" + e.name)[this.eFun(e)]('tree').tree("getChildren", n.target), (_, c) => $("#cmb" + e.name)[this.eFun(e)]('tree').tree("remove", c.target));
		$("#cmb" + e.name)[this.eFun(e)]('tree').tree("append", {
			parent: n.target,
			data: data
		});
		return true;
	}

	async Expand(e, n) {
		this.SetTreeData(e, n, [{
			id: null,
			text: "loading..."
		}]);
		var obj = {};
		var pField = e.parentField || $.map($.grep(e.columns || [], c => c.parent), c => c.field).concat([null])[0];
		var idField = $.grep(e.columns || [], c => c.primary).concat(e.idField)[0].field;
		if (pField) {
			obj[pField] = {
				_source: n._source
			};
			if (idField) {
				obj[pField][idField] = n.id;
			} else {
				obj[pField] = n.id;
			}
		}
		let data = await this._loadData({
			id: "cmb" + e.name,
			options: e
		}, obj);
		this.SetTreeData(e, n, data);
	}

	async _loadData(s, o, start, end) {
		var name = (s && s.options ? (s.options.Class ? s.options.Class.Name.replace(' ', '_') : (s.options.table || s.options.name)) : s.name);
		name = name.trim(); //.split('.').slice(-1)[0];

		let oScope = (typeof(company) !== 'undefined' && company.Scope) ? window[company.Scope] : window;
		//console.log("DynaForm::_loadData(): oScope", oScope);

		o = o || ((oScope && oScope[name]) ? new oScope[name]() : {
			Active: true,
		});

		o = (typeof filters !== "undefined" && filters && filters[name]) ? filters[name](o) : o;
		var fun = this.eFun(s.options);
		let sText = $("#" + s.id)[fun]('getText');

		o = (s && s.options && s.options.source) ? s.options.source(o, this.get(), sText) : o;
		let names = $.uniqueSort([s.options.searchField].concat($.map($.grep(s.options.columns || [], c => c.search), c => c.field), ["Name"])).filter(v => v);
		if (!o[names[0]]) o[names[0]] = sText;
		//console.log("DynaForm::_loadData(): o", o);
		var data = null;

		let lib = '';
		if (name.indexOf('.') > 0) {
			lib = name.split('.')[0] + '.';
			name = name.split('.')[1];
		}

		if (s.options.loader) {
			data = await s.options.loader(this.get(), s.options, o, sText);
		} else if (o && typeof(o.findAll) === 'function') {
			data = await o.findAll();
		} else if (typeof(company) !== 'undefined' && company.library && company.Code && window.bLocal) {
			//console.log("DForm::_loadData(): sr()._(" + lib + company.Code.toLowerCase() + name + "Findall" + ")", o);
			data = await this.sr()._(lib + company.Code.toLowerCase() + name + "Findall", null, o, null, start, end);
		} else if (_FrEMD.apiServer) {
			o = Object.assign(...Object.keys(o).map(k => ({
				[String(k).charAt(0).toLowerCase() + String(k).slice(1)]: o[k]
			})));
			//console.log("DForm::_loadData(): using _FrEMD.apiServer: o", o);
			data = await _FrEMD.apiServer._new(name)._fromDocument(o).findAll();
			//data.filter(d => d.Id != d.Id).forEach(d => d.Id = d._uuid(null, null, true));
		}

		if (s.options.postload) {
			await s.options.postload(data);
		}
		$.each(data, (i, d) => {
			d.__OWNER = s;
			$.each(s.options.columns, (_, c) => {
				if (c.value) {
					d[c.field] = c.value(d, data, i);
				}
			});
		});
		if (!s.options.columns && fun.indexOf('tree') > -1) {
			data = $.map(data, d => {
				let ret = {
					id: d[s.options.idField.field],
					text: d[s.options.textField.field],
					state: d.state || (s.options.loader ? "file" : "closed"),
					_source: d,
				};
				ret.children = (ret.state == "closed") ? [{
					text: 'loading...'
				}] : null;
				return ret;
			});
		}
		return data || [];
	}

	async fillData(g, o, start, end) {
		var s = null;
		for (var i = 0; i < this.selects.length; i++) {
			if (this.selects[i].id == g[0].id) s = this.selects[i];
		}
		if (!s) return;
		this.busy(true);
		try {
			var fun = g[0].classList["0"].replace('easyui-', '');
			try {
				$("#" + s.id)[fun]('grid').datagrid('getPager').pagination('loading');
			} catch (ex) {}
			if (s.options.noload) {
				let _data = null;
				try {
					_data = $("#" + s.id)[fun]('grid').datagrid("getData");
				} catch (ex) {
					_data = $("#" + s.id)[fun]('tree').tree('getRoot');
				}
				if (_data) {
					return this.busy(false);
				}
			}
			var data = await this._loadData(s, o, start, end);
			try {
				if ($("#" + s.id)[fun]('grid')) $("#" + s.id)[fun]('grid').datagrid('getPager').pagination('loaded');
			} catch (ex) {}
			try {
				$("#" + s.id)[fun]('grid').datagrid('loadData', {
					total: data.Count || data.length,
					rows: data,
				});
			} catch (ex) {
				$("#" + s.id)[fun]('tree').tree('loadData', data);
			}
		} catch (ex) {
			console.log(ex);
		}
		this.busy(false);
	}

	eventHandlers(options) {
		//console.log("DynaForm::eventHandlers(): options", options);
		if (!this.byName(options.name)) return; // if not an element, do not run the handlers

		return this.events.filter(e => e.type == options.type || typeof(e.type) === 'undefined').map(e => `${e.name}: (${e.params || ''}) => {try{DForm.${e.handler}(DForm.byName("${options.name}") || ${_FrEMD._toJS(options)} || {name: "${options.name}",type: "${options.type}"}, ${e.params})}catch(ex){console.log("Event Error: ${options.name}/${options.type}/${e.name}", ex);}}`).join(',');
	}

	async PanelOpen(e) {
		if (e.editor) return true;
		let content = e.value;
		if (e.loader) {
			content = await e.loader(this.get());
		}
		if (content) {
			try {
				$("#pnl" + e.name).panel('body').html(content);
				console.log("pnl" + e.name + ": Content Valid");
			} catch (ex) {
				//console.log(ex);
			}
		}
		return content;
	}

	async SelectChange(options, tab) {
		this.busy(true);
		$.grep(this.elements, e => e.type == "grid" && e.group == tab).forEach(e => $("#cmb" + e.name).datagrid());
		this.busy(false);
	}

	async FieldChange(options, value) {
		this.busy(true);
		if (options && options.change) {
			await options.change(this.get(), value);
		}
		this.busy(false);
	}

	async URLChange(s, options) {
		options.data = await $.get(s.value);
		return await this.FieldChange(s, options);
	}

	async UploadFile(f, options) {
		this.busy(true);
		var formData = new FormData();
		var fileid = Math.random();
		var method = options.method || "ContentManager.cmsUploadFile";
		formData.append('fileid', fileid);
		var file = $("#" + f.fileboxId)[0].files[0];
		formData.append('__UFILE', file);
		if (options.local) {
			// handling the file locally
			var reader = new FileReader();
			reader.onload = async (e) => {
				var data = e.target.result;
				DForm.byName(options.name).data = data;
				if (options && options.upload) await options.upload(this.get(), data);
				this.busy(false);
			};
			if (options.binary) {
				reader.readAsBinaryString(file);
			} else if (options.dataurl) {
				reader.readAsDataURL(file);
			} else {
				reader.readAsText(file);
			}
		} else if (method) {
			$.ajax({
				url: this.sr().srURL + "&method=" + method + "&sInput=" + fileid + "&preTag=&postTag=",
				data: formData,
				// THIS MUST BE DONE FOR FILE UPLOADING
				cache: false,
				contentType: false,
				type: 'POST',
				processData: false,
				success: data => {
					this.sr().runScript(data);
					this.byName(options.name).data = ret;
					if (options && options.upload) options.upload(this.get(), ret);
					this.busy(false);
				}
			});
		}
	}

	eFun(e) {
		try {
			if (e.type == "tree") {
				if (e.columns) {
					return "combotreegrid";
				} else if (typeof(e.combo) !== 'undefined' && !e.combo) {
					return 'tree';
				} else {
					return "combotree";
				}
			} else if (e.type == 'navigation') {
				return 'tree';
			} else if (e.type == "combotree") {
				return "combotreegrid";
			} else if (e.type == "select" && e.options) {
				return "combobox";
			}
			return "combogrid";
		} catch (ex) {
			return "combogrid";
		}
	}

	_fillWindow(winName, v, map) {
		v = v || {};
		map = map || {};
		if (Array.isArray(map)) {
			map = Object.fromEntries(new Map(map));
		}

		map = $.extend({}, map, Object.fromEntries(Object.keys(v).map(k => [winName + k, k])));

		let s = {};
		for (var m in map) {
			if (typeof(v[map[m]]) === "undefined") {
				//console.log('is_undefined', m, map[m], v[map[m]]);
				s[m] = map[m];
			} else {
				//console.log('is_not_undefined', m, map[m], v[map[m]]);
				s[m] = v[map[m]];
			}
		}
		this.clear(winName);
		//console.log("s", s);
		this.set(s);
		$("#pnl_" + winName).window("open");
	}

	windowToEntity(o, bEmpty, grid, prefix, filter) {
		o = o || this.get();
		filter = filter || (v => v);
		let ret = grid ? (grid.selected || grid) : null;
		if (bEmpty) {
			ret = {};
			o = {};
		} else {
			ret = (ret && ret.Id) ? {
				Id: ret.Id
			} : {};
		}

		this.elements.filter(e => (prefix ? e.group == prefix : true) && e.type != 'link' && ['_'].indexOf(e.name.replace(prefix, "")) < 0).forEach(e => {
			ret[e.name.replace(prefix, "")] = o[e.name];
			return true;
		});

		filter(ret);

		return ret;
	}

	bind(obj) {
		var objBind = (o, e) => {
			o[this.eFun(e)]({
				onShowPanel: () => {
					this.fillData($("#" + e.id), null, 0, 10);
				},
				onClickRow: (index, row) => {
					var s = row ? row.__OWNER : null;
					// console.log("onClickRow(): ", index, row, s);
					if (s && s.options.select) {
						s.options.select(row, this.get());
					}
				}
			});
			try {
				var dg = o[this.eFun(e)]('grid');
				// dg.datagrid('enableFilter')
				var state = dg.data('datagrid');
				var opts = state.options;
				var onBeforeLoad = opts.onBeforeLoad;
				opts.onBeforeLoad = (param) => {
					state.allRows = null;
					return onBeforeLoad.call(this, param);
				};
				var pager = dg.datagrid('getPager');
				dg.datagrid('getPanel').panel({
					ID: i
				});
				pager.pagination({
					onSelectPage: function(pageNum, pageSize) {
						try {
							DForm.fillData($("#" + DForm.selects[$(this.parentNode).panel('options').ID].id), null, pageSize * (pageNum - 1), pageSize * pageNum);
						} catch (_ex) {
							console.log("DynaForm::onSelectPage() ", _ex);
						}
					}
				});
				dg.datagrid('loadData', state.data);
			} catch (ex) {}
		};
		if (obj) {
			objBind(obj);
		} else {
			for (var i = 0; i < this.selects.length; i++) {
				if (this.selects[i].options.options) {
					//$("#" + this.selects[i].id).combo();
				} else {
					objBind($("#" + this.selects[i].id), this.selects[i]);
				}
			}

			this.elements.filter(e => e.window && e.group).forEach(e => {
				let t = $("#tbcWindow").tabs("getTab", e.group);
				if (t) {
					t.panel('options').tab.hide();
				}
			});
		}
	}

	english(s) {
		if (!s) return "";
		var result = s.replace(/([A-Z])/g, " $1");
		result = result.replace(/_/g, '');
		return result.charAt(0).toUpperCase() + result.slice(1);
	}

	onToggle(e, bValue) {
		let sTag = `#fElement_${e.for.name} > .easyui-${this.uiTypes[e.for.type]}`;
		let oTag = $(sTag);
		e.for.enabled = typeof(bValue) === "undefined" ? !e.for.enabled : bValue;

		oTag.prop("disabled", !e.for.enabled);
		//oTag[this.uiTypes[e.for.type]](e.for.enabled ? "enable" : "disable");
		console.log(sTag, oTag, this.uiTypes[e.for.type], e.for.enabled);
	}

	render(name, title, elements, buttons, bFixed) {
		this.elements = (elements || []).filter(e => !e.ignore);

		this.buttons = buttons || [];
		this.selects = [];
		this.grids = [];

		this.elements.filter(e => e.type == "window").forEach(w => this.elements.splice(this.elements.findIndex(e => e.name == w.name), 0, {
			name: "_" + w.name,
			type: "link",
			title: w.title || this.english(w.name),
			group: w.group,
			window: w.window,
			section: w.section,
			links: [{
				label: 'Open',
				icon: 'edit',
				onClick: o => $("#pnl" + w.name).window('open')
			}],
		}));

		this.sr().groupBy(this.elements.filter(e => e.window), "group").forEach(kv => {
			if (!kv.key) return;

			let e = {
				name: "_" + kv.key,
				title: kv.key,
				type: "window",
				group: kv.key,
				width: this.width * 0.9,
				height: this.height * 0.9,
				loader: o => {
					kv.values.filter(v => v.type !== 'link' || (v.type == 'link' && v.name.startsWith('_'))).forEach(v => $("#pnl_" + v.group + '-center').append($("#fElement_" + v.name)));
					return null;
				},
				buttons: [].concat.apply([], kv.values.filter(v => v.type == 'link' && !v.name.startsWith('_')).map(v => [...v.links.map(l => ({
					name: l.name || l.label,
					title: l.title || l.label,
					onClick: l.onClick,
					icon: l.icon,
					window: true,
					group: kv.key,
				}))])),
			};
			this.buttons.push(...e.buttons);

			this.elements.push(e);
		});

		var ret = "";
		// check the option of using window() as a renderer of the main window...
		if (true) {
			this.elements.filter(e => !e.zone).forEach(e => e.zone = 'center');
			let wOptions = {
				name: name || this.name,
				title: title || this.title,
				type: 'window',
				visible: true,
				width: this.width,
				height: this.height,
				fixed: bFixed,
				links: [{
					icon: "help",
					action: o => $("#pnl__Console").window('open')
				}],
				buttons: this.buttons.filter(b => !b.window),
			};
			this.sr().groupBy(this.elements, 'zone').filter(zg => zg.key).forEach(zg => {
				wOptions[zg.key] = this.renderElements(zg.values);
			});

			ret = this.window(wOptions);
		} else {
			ret = this.header(name, title, bFixed, [{
				icon: "help",
				action: o => $("#pnl__Console").window('open')
			}]);

			ret += this.renderElements();

			ret += this.footer(bFixed);

		}
		// console.log(ret);

		return ret;
	}

	cWidth(options) {
		let ret = Math.floor(((options ? options.width : null) || (this.width / 3)));
		if (options.zone == 'east' || options.zone == 'west') {
			ret = 0.25 * ret; // 90% of 3/10, the width of the normal element
		} else if (options && options.editor) {
			ret = window.innerWidth;
		} else if (options && options.width && typeof(options.width) === 'string') {
			ret = this.width;
		} else if (options && options.type == 'window' && !options.width) {
			ret = this.width * 0.9;
		}

		// console.log(options.name + ": cWidth = " + ret, options.zone);
		return ret;
	}

	window(options) {
		options.title = options.title || options.name;
		var ret = `
		<div id = "pnl${options.name}" class="easyui-window" title="${options.title || this.english(options.name)}" data-options='${this.eventHandlers(options)}, closed:${!options.visible},minimizable:${!options.fixed},maximizable:${!options.fixed},closable:${!options.fixed},collapsible:${!options.fixed},draggable:${!options.fixed},resizable:${!options.fixed},iconCls:"icon-${options.icon}", tools:"#${options.name}_tools"' style="width:${this.cWidth(options)}px;height:${this.cHeight(options)}px;padding:10px;">
		    <div class="easyui-layout" data-options="fit:true">
		`;

		let bZone = options.south ? 'south' : (this.zones.find(z => z == 'south') || this.zones[0]);
		options[bZone] = options[bZone] || [];
		let zWidth = Math.min(120, this.width * 0.95 / (options.buttons ? options.buttons.length : 1), this.cWidth(options));
		options[bZone].push(`<div id="pnl${options.name}-buttons" data-options="region:'${bZone}',border:false" style="text-align:right;padding:5px 0 0;">` + $.map($.grep(options.buttons || [], b => !b.ignore), b => `<a id='${b.name}' href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-${b.icon || 'save'}" style="width:${zWidth}px" onclick='DForm.doClick(${_FrEMD._toJS(b)})'>${b.title || b.name}</a>&nbsp;&nbsp;`).join('') + `</div>`);

		this.zones.filter(z => options[z]).forEach(z => {
			ret += `
		        <div data-options="region:'${z}'" title="${(z=='west' || z=='east')?'&nbsp;':''}" style='height:${(z=='north'||z=='south')?10:100}%;width:${((z=='east'||z=='west')?0.1:1)*this.cWidth(options)}px'>
        		    ${(Array.isArray(options[z])?options[z]:[options[z]]).join('')}
                </div>
            `;
		});

		ret += `</div></div>`;

		// links (tools)
		let links = $.grep([].concat(options.links || []), l => !l.ignore);
		ret += `<div id="${options.name}_tools">` + $.map(links.reverse(), l => `<a href="javascript:void(0)" style="color:black" class="fas fa-${l.icon || 'add'}" onclick='(async () => {var a = ${_FrEMD._toJS(l)}; $("#pnl${options.name}").window("setTitle", "${options.title}: " + a.name); await a.action(DForm.get(), a, ${_FrEMD._toJS(options)}); $("#pnl${options.name}").window("setTitle", "${options.title}");})()'></a>`).join('\n') + `</div>`;

		return ret;
	}

	async _end() {
		let o = this.get();

		// do not use the first button, because many forms have a Cancel button only
		let button = this.buttons.find(b => b.autoSubmit) /* || this.buttons[0]*/ ;
		if (button && o && Object.values(o).length && (typeof(button.autoSubmit) === "undefined" || button.autoSubmit)) {
			let v = Object.values(o).reduce((t, v) => {
				return ((typeof(v) !== "object") ? 1 : 0) * (v ? 1 : 0);
			});
			//console.log(o, Object.values(o), v);
			if (v) {
				// all fields have values
				await this.doClick(button);

			}
		}
	}

	footer(bFixed) {
		return `</form>` + `<div id="dlg-buttons">` + this.buttons.filter(b => !b.window).map(b => `<a id='${b.name}' href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-${b.icon || 'save'}" style="width:${Math.min(120, this.width * 0.95 / this.buttons.length, this.cWidth())}px" onclick='DForm.doClick(${_FrEMD._toJS(b)})'>${b.title || this.english(b.name)}</a>&nbsp;&nbsp;`).join('') + "</div>" + (bFixed ? "" : '</div>');
	}

	header(name, title, bFixed, links) {
		this.title = title || this.title;
		name = name || this.name;
		var ret = '';

		ret += this.window({
			name: "__Console",
			type: "window",
			editor: true,
			loader: o => window.logs.slice().reverse().map(l => l.date.toISOString() + ": " + l.args.map(s => typeof(s) === 'object' ? ((obj, indent = 2) => {
				let cache = [];
				const retVal = JSON.stringify(
					obj,
					(key, value) =>
					typeof value === "object" && value !== null ?
					cache.includes(value) ?
					undefined // Duplicate reference found, discard key
					:
					cache.push(value) && value // Store value in our collection
					:
					value,
					indent
				);
				cache = null;
				return retVal;
			})(s) : s).join(', ')).join('\n'),
		});

		if (!bFixed) {
			links = (links || []).filter(l => !l.ignore);
			let tData = "";
			if (links.length) {
				ret += `<div id="${this.name}_tools">` + links.map(l => `<a href="javascript:void(0)" class="icon-${l.icon}" onclick='(async () => {var a = ${_FrEMD._toJS(l)}; $("#win${this.name}").window("setTitle", "${this.title}: " + a.name); await a.action(DForm.get()); $("#win${this.name}").window("setTitle", "${this.title}");})()'></a>`).join('\n') + "</div>";
				tData = `,tools:"#${this.name}_tools"`;
			}
			ret += `<div id='win${this.name}' class='easyui-window' title='${this.title || this.english(this.name)}' data-options='iconCls:"icon-save" ${tData}' style='width:${this.width}px;height:${this.height}px;padding:10px;'>`;
		}
		return ret + `<form id="frm${this.name}" method="post" novalidate>`;
	}

	renderElements(elements) {
		elements = elements || this.elements;

		var tWidth = Math.floor(this.width * 0.95);
		var tHeight = Math.floor(this.height * 0.85);

		let ret = '';
		var gElements = this.sr().groupBy(elements, "group");
		if (gElements.length > 1) ret += `<div id="tbcWindow" class="easyui-tabs" data-options='${this.eventHandlers({type: 'tabs'})}' style="width:${tWidth}px;height:${tHeight}px;">`;
		for (var g = 0; g < gElements.length; g++) {
			if (gElements.length > 1) ret += '<div title="' + (gElements[g].key || "Main") + '" style="padding:20px;display:none;">';
			var sElements = this.sr().groupBy(gElements[g].values, "section");
			if (sElements.length > 1) ret += '<div class="easyui-accordion" style="width:' + tWidth + 'px;height:' + /*tHeight*/ "100%" + 'px;">';
			for (var s = 0; s < sElements.length; s++) {
				ret += `<div title="${sElements[s].key || ""}" data-options="iconCls:'icon-more'" style="padding:10px;">`;
				for (var i = 0; i < sElements[s].values.length; i++) {
					var e = sElements[s].values[i];
					if (e.ignore) continue;
					e.value = e.value || _FrEMD.hash[e.name] || (_FrEMD.apiServer ? _FrEMD.apiServer.__config('test_' + e.name, '') : '');
					ret += `<div id="fElement_${e.name}" class="fitem" style="display: ${(e.type=='window' || e.hidden)?'none':''}">`;
					if (e.toggle) {
						ret += `<a href="#" class="easyui-linkbutton" data-options='${this.eventHandlers({type: 'toggle', for: e})},plain:true,iconCls:"icon-${e.icon || 'search'}"' style="width:100px;height:30px">${e.title || this.english(e.name)}</a>`;
					} else {
						ret += `<label>${e.title || this.english(e.name)}:</label>`;
					}
					if (e.type && this[e.type]) {
						ret += this[e.type](e);
					} else if (e.render) {
						ret += e.render();
					}
					ret += '</div>';
				}
				ret += '</div>';
			}
			if (sElements.length > 1) ret += '</div>';
			if (gElements.length > 1) ret += "</div>";
		}
		if (gElements.length > 1) ret += "</div>";
		return ret;
	}

	info(msg) {
		if ($.messager) {
			$.messager.alert(this.title, msg, 'info');
		} else {
			this.sr().ShowMessage(msg, this.title);
		}
	}

	error(msg) {
		if ($.messager) {
			$.messager.alert(this.title, msg, 'error');
		} else {
			this.sr().ShowMessage(msg, this.title);
		}
	}

	byName(name) {
		return this.elements.find(e => e.name === name);
	}

	/** Components::Start **/
	CoreComponent = class {
		constructor(page, dForm, oScope) {
			this.page = page;
			this.dForm = dForm || DForm;
			this.oScope = oScope;
		}

		_server() {
			let scope = window.bLocal ? "platformmanager" : _FrEMD.apiServer.Scope;
			return new(_FrEMD.__scope(scope)[_FrEMD.__scope(scope).EntityClasses.find(c => c.IsMain).Name])();
		}

		_entityField(ec) {
			return {
				name: ec.Name.replace(/\ /g, '_'),
				title: _FrEMD._titleCase(ec.Name),
				Class: {
					Name: ec.Name,
					Id: ec.Id
				},
				zone: 'north',
				type: ec.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ec) ? 'tree' : 'select',
				parentField: ec.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ec)?.Name,
				//searchField: ec.EntityAttributes.find(ea => ea.IsString).Name,
				//idField: '_ToString',
				source: (o, fData, sText) => ({
					OPERATORS: {
						[ec.EntityAttributes.find(ea => ea.IsString).Name]: 'like'
					},
					[ec.EntityAttributes.find(ea => ea.IsString).Name]: sText

				}),
			};
		}

		_eaToField(ea) {
			if (ea.EntityType) return {
				group: ea.Group.Name,
				name: ea.Name,
				_type: ea.EntityType.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ea.EntityType) ? 'tree' : 'select',
				type: 'select',
				parentField: ea.EntityType.EntityAttributes.find(pea => !pea.EntityMethod && pea.EntityType == ea.EntityType)?.Name,
				//idField: '_ToString',
				zone: 'center',
				Class: {
					Name: ea.EntityType.Name,
					Id: ea.EntityType.Id
				},
				source: (o, fData, sText) => ({
					OPERATORS: {
						[ea.EntityType.EntityAttributes.find(ea => ea.IsString).Name]: 'like'
					},
					[ea.EntityType.EntityAttributes.find(ea => ea.IsString).Name]: sText

				}),
			};
			if (ea.IsText) return {
				group: ea.Group.Name,
				name: ea.Name,
				type: 'window',
				zone: 'center',
				editor: true,
				language: o => ea.Name == 'script' ? 'javascript' : "text",
			};

			return {
				group: ea.Group.Name,
				name: ea.Name,
				zone: 'center',
				type: Object.entries({
					Bool: 'bool',
					Date: 'datetime',
					Int: 'int',
					Long: 'long',
					Image: 'image',
					String: 'string'
				}).find(e => ea['Is' + e[0]])[1],
			};
		}

		busy(bBusy) {
			return this.dForm.busy(bBusy);
		}

		_me(v) {
			let meName = (typeof(company) !== 'undefined') ? (company.loggedInIdentity || "me") : "me";
			if (v) {
				window[meName] = v;
			}

			return window[meName];
		}

		_canView() {
			if (!this._me()) {
				window._FrEMD.setURL({
					page: 'login',
					_redirect: this.page._code,
				});
				throw `_canView: ${this.page._code} not allowed without login!`;
			}
		}

		_name() {
			if (!this._me()) return "";
			return this._me().name ? this._me().name() : this._me().ToString;
		}
	}

	MainComponent = class extends this.CoreComponent {
		_menuClasses(scope) {
			let oScope = _FrEMD.__scope(scope);
			//console.log("MainComponent::_menuClasses(" + scope + "): oScope", scope, oScope, _FrEMD.apiServer);
			if (!oScope) return [];

			return _FrEMD.sr().groupBy(oScope.EntityClasses, 'EntityModule').map(g => ({
				label: (g.key ? this.dForm.english(g.key.Name) : null) || 'Main',
				subMenus: _FrEMD.sr().groupBy(g.values, 'Group').map(gv => ({
					label: (gv.key ? this.dForm.english(gv.key.Name) : null) || 'Main',
					subMenus: gv.values.map(gvv => ({
						label: this.dForm.english(gvv.Name),
						code: 'store',
						data: gvv.Name
					}))
				}))
			}));
		}

		_menuMethods(scope) {
			let oScope = _FrEMD.__scope(scope);
			//console.log("MainComponent::_menuMethods(" + scope + "): oScope", scope, oScope, _FrEMD.apiServer);
			if (!oScope) return [];

			return _FrEMD.sr().groupBy(oScope.EntityClasses.filter(ec => ec.EntityMethods.length), 'EntityModule').map(g => ({
				label: (g.key ? this.dForm.english(g.key.Name) : null) || 'Main',
				subMenus: _FrEMD.sr().groupBy(g.values, 'Group').map(gv => ({
					label: (gv.key ? this.dForm.english(gv.key.Name) : null) || 'Main',
					subMenus: gv.values.map(mc => ({
						label: this.dForm.english(mc.Name),
						subMenus: mc.EntityMethods.map(em => ({
							label: this.dForm.english(em.Name),
							code: 'method',
							data: mc.Name + "." + em.Name
						}))
					}))
				}))
			}));
		}

		_buildMenu(scope) {
			return [{
				label: "Main",
				order: -1,
				subMenus: [{
					label: 'Index',
				}, {
					label: "Login",
				}, {
					label: "Load",
				}, {
					label: "Save",
				}, {
					label: "Logout"
				}]
			}, {
				label: "Process",
				order: 99998,
				subMenus: this._menuMethods(scope)
			}, {
				label: "Setup",
				order: 99999,
				subMenus: this._menuClasses(scope)
			}];
		}
	}

	LoadComponent = class extends this.CoreComponent {
		async main() {
			this.page.data = {
				form: this.dForm.render('frmLoad', "Load Setup Data", [{
					name: 'Excel',
					type: "file",
					binary: true,
					local: true,
					upload: async (fData, data) => {
						this.dForm.set({
							Progress: 0
						});

						let tables = [];
						let obj = [];

						let server = this._server();

						const wb = new ExcelJS.Workbook();
						console.clear();
						let workbook = await wb.xlsx.load(data);
						workbook.eachSheet((sheet, id) => {
							let sTables = sheet.getTables();
							sTables.forEach(t => t.table.sheet = sheet);
							tables.push(...sTables);
						});
						tables = tables.flat().map(t => t.table);

						//console.clear();
						tables.forEach(t => {
							//console.log(t.name, t.columns, t.sheet.getCell('A2').value);
							for (var i = 2; t.sheet.getCell('A' + i).value !== null; i++) {
								obj.push(server._new(t.name)._fromDocument(Object.assign(...t.columns.map((c, ci) => ({
									[c.name]: t.sheet.getCell(String.fromCharCode('A'.charCodeAt(0) + ci) + i).value
								})))));
							}
						});

						for await (const o of obj) {
							//await _FrEMD._wait(1000)
							await o.store();
							this.dForm.set({
								Progress: this.dForm.get().Progress + 100.0 / obj.length
							});
						}

						_FrEMD.RenderPage({
							_code: 'login'
						});
					}
				}, {
					name: "Progress",
					type: "progress",
				}], [{
					name: 'Load',
					onclick: async o => {}
				}])
			};
		}
	}

	SaveComponent = class extends this.CoreComponent {
		async main() {
			//this._canView();

			this.page.data = {
				form: this.dForm.render('frmSave', "Save Setup Data", [{
					name: 'Save',
					type: "label",
					value: "Export to Excel",
				}, {
					name: 'Title',
					type: 'string',
					value: '',
				}, {
					name: "Progress",
					type: "progress",
				}], [{
					name: 'Save',
					onclick: async o => {
						console.clear();

						this.dForm.set({
							Progress: 0
						});

						let server = this._server();

						let tTemplate = {
							headerRow: true,
							style: {
								theme: 'TableStyleDark3',
								showRowStripes: true,
							},
						};
						let tables = [];
						for await (const c of _FrEMD.__scope(server.Scope).EntityClasses.sort((a, b) => a.Rank - b.Rank)) {
							//console.log("DynaForm::SaveComponent(): " + c.Name + ", Rank=" + c.Rank);
							tables.push(Object.assign(JSON.parse(JSON.stringify(tTemplate)), await server._new(c.Name)._toTabular()));
							this.dForm.set({
								Progress: this.dForm.get().Progress + 100.0 / _FrEMD.__scope(server.Scope).EntityClasses.length
							});
						}
						tables.forEach(t => t.ref = 'A1:' + String.fromCharCode('A'.charCodeAt(0) + t.columns.length - 1) + (t.rows.length + 1));

						let rgb = (letters = '0123456789ABCDEF') => Array(6).map(i => letters[Math.floor(Math.random() * 16)]).join('');

						const workbook = new ExcelJS.Workbook();
						tables.forEach(t => workbook.addWorksheet(t.name, {
							properties: {
								tabColor: {
									argb: 'F' + rgb()
								}
							}
						}).addTable(t));

						let buffer = await workbook.xlsx.writeBuffer({
							dateFormat: 'YYYY-MM-DD HH:mm:ss'
						});

						const link = document.createElement('a');
						link.style.display = 'none';
						document.body.appendChild(link);
						link.href = URL.createObjectURL(new Blob([buffer], {
							type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8'
						}));
						link.download = (o.Title || server.Scope || "data") + ".xlsx";
						link.click();
					}
				}])
			};
		}
	}

	IndexComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.page.data = {
				form: this.dForm.render('frmIndex', "Main Page", [{
					name: 'Welcome',
					required: true,
					type: "label",
					value: this._name(),
				}], [])
			};
		}
	}

	LogoutComponent = class extends this.CoreComponent {
		main() {
			this._canView();

			delete window.me;

			this.page.data = {
				form: this.dForm.render('frmLogout', "Logout", [{
						name: "Logout",
						type: "label",
						value: "logout in progress..."
					}],
					[])
			};

			_FrEMD.RenderPage({
				_code: "login"
			});
		}
	}

	LoginComponent = class extends this.CoreComponent {
		async _authenticate(o) {
			//if (!window.bLocal && (!_FrEMD.__scope() || !_FrEMD.__scope().EntityClasses)) return;

			let authClassName = _FrEMD.__scope()?.EntityClasses?.find(c => c.EntityAttributes.find(ea => ea.Name == 'username'))?.Name;
			if (_FrEMD.apiServer && authClassName) return await _FrEMD.apiServer._new(authClassName).username(o.Username, '=').password(o.Password, '=').active(true).enabled(true).find();

			authClassName = authClassName || (window.bLocal ? ({
				cms: "Author",
				ems: "Employee"
			})[company.Code] : null);

			o.OPERATORS = {
				Username: "=",
				Password: "="
			};

			if (authClassName) return (await sr._("ems" + authClassName + "Find", null, o));
		}

		async _loggedIn() {}

		async _notLoggedIn() {}

		async main() {
			this.page.data = {
				form: this.dForm.render('frmLogin', "User Authentication", [{
						name: 'Username',
						required: true,
						type: "string"
					},
					{
						name: 'Password',
						required: true,
						type: "password"
					}
				], [{
					name: 'Login',
					autoSubmit: true,
					onclick: async o => {
						let ret = await this._authenticate(o);

						if (ret) {
							this._me(ret);

							try {
								await this._loggedIn();
							} catch (ex) {}

							_FrEMD.setURL({
								page: _FrEMD.hash._redirect || "index"
							});
						} else {
							try {
								await this._notLoggedIn();
							} catch (ex) {}

							this.dForm.error("Invalid username or password");
						}

						this.dForm.busy(false);
					}
				}])
			};
		}
	}

	MethodComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.sMethod = this.page.data;
			console.clear();

			let ec = (_FrEMD.__scope() || this.oScope).EntityClasses.find(c => c.Name == this.sMethod.split('.')[0]);
			let em = ec.EntityMethods.find(m => m.Name == this.sMethod.split('.')[1]);

			this.page.data = {
				form: this.dForm.render(this.sMethod, _FrEMD._titleCase(ec.Name) + ' :: ' + _FrEMD._titleCase(em.Name), [this._entityField(ec)].concat(...em.MethodParameters.map(p => this._eaToField(p))), [{
					name: 'Reset',
					onclick: o => {
						this.dForm.clear();
					},
					icon: "cancel"
				}, {
					name: 'Reload',
					onclick: o => _FrEMD.RenderPage({
						_code: 'method'
					}, this.page.data),
					icon: "reload"
				}, {
					name: em.Name,
					title: _FrEMD._titleCase(em.Name),
					onclick: async o => {
						let obj = o[ec.Name] || _FrEMD.apiServer._new(ec.Name);
						console.log("onclick()", ec.Name, obj, o, o[ec.Name]);
						//if (o[this.sTable] && typeof(o[this.sTable].__sync_on) === 'function' && o[this.sTable].__sync_on()) obj.Id = o[this.sTable].Id;

						await obj[em.Name](...em.MethodParameters.map(p => o[p.Name]));
					}
				}])
			};
		}
	}

	StoreComponent = class extends this.CoreComponent {
		async main() {
			this._canView();

			this.sTable = this.page.data;
			console.clear();

			//console.log("DynaForm::StoreComponent(): sTable", this.sTable);

			let ec = _FrEMD.__scope().EntityClasses.find(c => c.Name == this.sTable);

			this.page.data = {
				form: this.dForm.render(ec.Name.replace(/\ /g, '_'), _FrEMD._titleCase(ec.Name), [Object.assign(this._entityField(ec), {
					select: async o => {
						this.dForm.clear();
						this.dForm.busy(true);

						let r = await o.find();
						this.dForm.set(Object.assign({
							[ec.Name.replace(/\ /g, '_')]: r
						}, ...ec.EntityAttributes.filter(ea => !ea.EntityMethod).filter(ea => typeof(r[ea.Name]()) !== 'undefined').map(ea => ({
							[ea.Name]: r[ea.Name]()
						}))));
						this.dForm.busy(false);
					}
				})].concat(...ec.EntityAttributes.filter(ea => !ea.EntityMethod).map(ea => this._eaToField(ea))), [{
					name: 'Reset',
					onclick: o => {
						this.dForm.clear();
					},
					icon: "cancel"
				}, {
					name: 'Reload',
					onclick: o => _FrEMD.RenderPage({
						_code: 'store'
					}, this.page.data),
					icon: "reload"
				}, {
					name: 'Save',
					onclick: async o => {
						let obj = _FrEMD.apiServer._new(this.sTable);
						//console.log("onclick()", this.sTable, obj, o, o[this.sTable]);
						if (o[this.sTable] && typeof(o[this.sTable].__sync_on) === 'function' && o[this.sTable].__sync_on()) obj.Id = o[this.sTable].Id;

						ec.EntityAttributes.filter(ea => !ea.EntityMethod).forEach(ea => obj[ea.Name](o[ea.Name]));
						//return console.log(obj._toFileName(), obj);
						await obj.store();
					}
				}])
			};
		}
	}
	/** Components::End **/
};
","
storedMethod ": null,"
__keys ": ["
name "],"
active ": true,"
enabled ": true,"
__trMap ": []}
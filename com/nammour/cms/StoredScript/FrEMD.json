{
	"Id": "ff7d18c1fb5389d62f48fc0f8306014547c615df",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpKT8uU2NyaXB0OwoJCX0gZWxzZSBpZiAoIXRoaXMuYXBpU2VydmVyKSB7CgkJCWxldCBfcyA9IGF3YWl0IGZldGNoKGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbj9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQkJaWYgKF9zLm9rKSBzY3JpcHQgPSBhdG9iKChhd2FpdCBfcy5qc29uKCkpLnNjcmlwdCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJYXN5bmMgX2luaXRDb250ZW50TWFuYWdlcigpIHsKCQlsZXQgYXJDbGFzc2VzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSk7CgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXJDbGFzc2VzLCAiY29udGVudG1hbmFnZXIiKTsKCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gc2NvcGUgfHwgY29tcGFueS5TY29wZTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuSWQgPyB0bXAgOiAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1BhZ2VUZW1wbGF0ZUZpbmQiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJVHlwZTogewoJCQkJTmFtZTogIkVudGl0eVRlbXBsYXRlIgoJCQl9LAoJCQlOYW1lOiB0bXAuTmFtZSB8fCB0bXAubmFtZSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0KTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0ZW1wbGF0ZVtmXS5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGVtcGxhdGVbZl0gPSB0ZW1wbGF0ZVtmXS5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGVtcGxhdGVbZl0sIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7IC8vd2luZG93W3Njb3BlXTsKCgkJCXRoaXMubmMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ05vZGUnKTsKCQkJdGhpcy5zYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnU3RvcmVkU2NyaXB0Jyk7CgkJCXRoaXMuZWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ0V2ZW50Jyk7CgkJCXRoaXMubWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklzTWFpbik7CgoJCQl0aGlzLmRTY29wZSA9ICh0aGlzLm5jICYmIHRoaXMubmMuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMubmMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJdGhpcy5jbVNjb3BlID0gKHRoaXMuc2MgJiYgdGhpcy5zYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5zYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJdGhpcy5kYXRhID0gZGF0YTsKCgkJCXRoaXMubk5hbWUgPSB0aGlzLm9TY29wZS5uTmFtZTsKCQkJdGhpcy5jTmFtZSA9IHRoaXMub1Njb3BlLmNOYW1lOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKCQoYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7d2lkdGg6MTAwJTsgaGVpZ2h0OiAxMDAlJyBzcmM9JyR7X0ZyRU1ELl9zdmdCYXNlNjQocmV0LkJvZHkpfScvPmApKTsKCQl9CgoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWF3YWl0IHRoaXMucHJ2RnVuYyhgPGRpdj4ke3JldC5Cb2R5fTwvZGl2PmApOwoJCX0KCgkJYXN5bmMgZGVwbG95KHJldCwgdHlwZU5hbWUsIGxhbmcpIHsKCQkJdHlwZU5hbWUgPSB0eXBlTmFtZSB8fCAiQnJvd3NlciI7CgkJCWxldCBzID0gcmV0LkJvZHk7CgkJCWlmIChsYW5nKSBfRnJFTUQuX2JlYXV0aWZ5KHJldC5Cb2R5LCBsYW5nKTsKCgkJCWlmICh0aGlzLm5jKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuZFNjb3BlLk5vZGVfVHlwZShudWxsLCAnR2l0SHViJykuY29kZSh0eXBlTmFtZS50b0xvd2VyQ2FzZSgpKS5uYW1lKHR5cGVOYW1lKS5yZW1hcmsocykuc3RvcmUoKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNjKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuY21TY29wZS5TdG9yZWRTY3JpcHQobnVsbCwgJ0dpdEh1YicpLmFjdGl2ZSh0cnVlKS5uYW1lKHR5cGVOYW1lKS5zY3JpcHQocykuc3RvcmUoKTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCdkZXBsb3koKTogTm8gZGVwbG95bWVudCBtb2R1bGUnKTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFRhYmxlKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoYAo8ZGl2IGlkID0gImR2UG9zdEluamVjdCIgc3R5bGU9J292ZXJmbG93WT1zY3JvbGwnPmAgKwoJCQkJREZvcm0ucmVuZGVyRWxlbWVudHModGhpcy5lbGVtZW50cy5tYXAoKHMsIGkpID0+ICh7CgkJCQkJbmFtZTogYFJPVyR7aX1gLAoJCQkJCXRpdGxlOiAnICcsCgkJCQkJdHlwZTogImdyaWQiLAoJCQkJCXdpZHRoOiAiMTAwJSIsCgkJCQkJcm93TnVtYmVyczogZmFsc2UsCgkJCQkJcGFnaW5hdGlvbjogZmFsc2UsCgkJCQkJZnJvemVuOiBbXSwKCQkJCQljb2x1bW5zOiBbewoJCQkJCQl0aXRsZTogIlByb3BlcnR5IiwKCQkJCQkJd2lkdGg6ICIzMCUiLAoJCQkJCX0sIHsKCQkJCQkJdGl0bGU6ICJEZXNjcmlwdGlvbiIsCgkJCQkJCXdpZHRoOiAiNzAlIiwKCQkJCQl9XSwKCQkJCQlkYXRhOiBPYmplY3QuZW50cmllcyhzKS5tYXAoZSA9PiAoewoJCQkJCQlQcm9wZXJ0eTogZVswXSwKCQkJCQkJRGVzY3JpcHRpb246IGVbMV0KCQkJCQl9KSksCgkJCQl9KSkpICsgYDwvZGl2Pgo8c2NyaXB0PgoJc2V0VGltZW91dCgoKSA9PiAkLnBhcnNlci5wYXJzZSgiI2R2UG9zdEluamVjdCIpLCAxMDApOwo8L3NjcmlwdD5gKTsKCQl9Cgl9OwoKCVByb3h5Tm9kZVRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXN1cGVyKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspOwoJCX0KCgkJYXN5bmMgcHJlSW5qZWN0KCkgewoJCQl0aGlzLnVybFJlZ2V4ID0gYCgoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KWA7CgkJfQoKCQljcnVkTWV0aG9kcyhjLCB0eXBlKSB7CgkJCXJldHVybiBbewoJCQkJTmFtZTogJ3N0b3JlJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZEFsbCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUlzQXJyYXk6IHRydWUsCgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfV0ubWFwKG0gPT4gewoJCQkJbVt0eXBlXSA9IGNbdHlwZV0gPyBjW3R5cGVdW20uTmFtZV0gOiBudWxsOwoJCQkJbS5Jc1B1YmxpYyA9IHRydWU7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBbXTsKCQkJCXJldHVybiBtOwoJCQl9KTsKCQl9Cgl9OwoKCVBsYW50VU1MVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWxldCBodG1sID0gcmV0LkJvZHkucmVwbGFjZSgvQGVuZHVtbC9nLCBgbGVmdCBmb290ZXIgJHsnXHUwMEE5J30ke25ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKX0gJHt0aGlzLmRhdGEuQ29weXJpZ2h0IHx8ICdGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9CgoJdG9CYXNlNjQodXJsLCBkYXRhLCBtaW1lID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsIGJSYXcpIHsKCQlyZXR1cm4gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3VybCA/IHRoaXMuX2luamVjdCgkLmFqYXgoewoJCQl1cmw6IHVybCArICc/JyArIE1hdGgucmFuZG9tKCksCgkJCWFzeW5jOiBmYWxzZQoJCX0pLnJlc3BvbnNlVGV4dCwgZGF0YSkgOiAoYlJhdyA/IGRhdGEgOiBKU09OLnN0cmluZ2lmeShkYXRhKSldLCB7CgkJCXR5cGU6IG1pbWUKCQl9KSk7Cgl9CgoJX3N2Z0Jhc2U2NCh0eHQpIHsKCQl0cnkgewoJCQltZXJtYWlkLm1lcm1haWRBUEkuaW5pdGlhbGl6ZSh7CgkJCQkidGhlbWUiOiAiZGVmYXVsdCIsCgkJCQkic2VjdXJpdHlMZXZlbCI6ICJsb29zZSIsCgkJCQkibWF4VGV4dFNpemUiOiA5MDAwMDAwMCwKCQkJfSk7CgoJCQlyZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsJyArIHRoaXMuX2J0b2EobmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZygkKG1lcm1haWQubWVybWFpZEFQSS5yZW5kZXIoJ2dyYXBoRGl2JywgdHh0KSlbMF0pKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gdHh0OwoJCX0KCX0KCglfcHJ1bmUob2JqKSB7CgkJaWYgKHR5cGVvZihvYmopID09PSAidW5kZWZpbmVkIiB8fCBvYmogPT09IG51bGwpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gIm9iamVjdCIpIHJldHVybiBvYmo7CgkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewoJCQlsZXQgcmV0ID0gb2JqLm1hcCh2ID0+IHRoaXMuX3BydW5lKHYpKS5maWx0ZXIodiA9PiB2KTsKCQkJcmV0dXJuIHJldC5sZW5ndGggPyByZXQgOiBudWxsOwoJCX0KCgkJbGV0IHJldCA9IE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5lbnRyaWVzKG9iaikubWFwKChba2V5LCB2YWx1ZV0pID0+IHZhbHVlID8gKHsKCQkJW2tleV06IHRoaXMuX3BydW5lKHZhbHVlKQoJCX0pIDogbnVsbCkpOwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLmxlbmd0aCA/IHJldCA6IG51bGw7Cgl9CgoJdmFsaWRVUkwoc3RyKSB7CgkJdmFyIHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeKGh0dHBzPzpcXC9cXC8pPycgKyAvLyBwcm90b2NvbAoJCQknKCgoW2EtelxcZF0oW2EtelxcZC1dKlthLXpcXGRdKSopXFwuKStbYS16XXsyLH18JyArIC8vIGRvbWFpbiBuYW1lCgkJCScoKFxcZHsxLDN9XFwuKXszfVxcZHsxLDN9KSknICsgLy8gT1IgaXAgKHY0KSBhZGRyZXNzCgkJCScoXFw6XFxkKyk/KFxcL1stYS16XFxkJV8ufitdKikqJyArIC8vIHBvcnQgYW5kIHBhdGgKCQkJJyhcXD9bOyZhLXpcXGQlXy5+Kz0tXSopPycgKyAvLyBxdWVyeSBzdHJpbmcKCQkJJyhcXCNbLWEtelxcZF9dKik/JCcsICdpJyk7IC8vIGZyYWdtZW50IGxvY2F0b3IKCQlyZXR1cm4gISFwYXR0ZXJuLnRlc3Qoc3RyKTsKCX0KCglfdG9KUyhvKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihvKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiAndW5kZWZpbmVkJzsKCgkJCXJldHVybiBgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoXGAke3RoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkobywgKHQsbik9PiJmdW5jdGlvbiI9PT10eXBlb2Ygbj9uLnRvU3RyaW5nKCk6bikpfVxgKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KWA7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl90b0pTOiAiICsgZXgudG9TdHJpbmcoKSk7CgkJfQoJfQoKCV9hdG9iKGEpIHsKCQlyZXR1cm4gdHlwZW9mKGF0b2IpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGEsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JykgOiBhdG9iKGEpOwoJfQoKCV9idG9hKGIpIHsKCQlyZXR1cm4gdHlwZW9mKGJ0b2EpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGIpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGIpKSk7Cgl9CgoJX2F0dHIoZWEpIHsKCQl0cnkgewoJCQlpZiAoZWEuRW50aXR5VHlwZSkgcmV0dXJuICJFbnRpdHkiOwoJCQlyZXR1cm4gT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+ICFrLmluZGV4T2YoIklzIikgJiYgayAhPT0gIklzVW5pcXVlIikuZmluZChrID0+IGVhW2tdKS5yZXBsYWNlKCdJcycsICcnKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3NxbFR5cGUoZWEsIGRiVHlwZSkgewoJCWxldCB0eXBlID0gdHlwZW9mKGVhKSA9PT0gInN0cmluZyIgPyBlYSA6IHRoaXMuX2F0dHIoZWEpOwoJCXN3aXRjaCAodHlwZSkgewoJCQljYXNlICJTdHJpbmciOgoJCQljYXNlICcnOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJUZXh0IjoKCQkJY2FzZSAiT2JqZWN0IjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdzcWxpdGUnPydWQVJDSEFSJzonVEVYVCd9JHtkYlR5cGU9PSdwb3N0Z3Jlcyc/Jyc6Jyg0MDAwKSd9YDsKCQkJY2FzZSAiQm9vbCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCSVQoMSknOidUSU5ZSU5UJ31gOyAvL0JJVAoJCQljYXNlICJEYXRlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J1RJTUVTVEFNUCc6J0RBVEVUSU1FJ31gOwoJCQljYXNlICJJbnQiOgoJCQkJcmV0dXJuICJJTlRFR0VSIjsKCQkJY2FzZSAiTG9uZyI6CgkJCQlyZXR1cm4gIkJJR0lOVCI7CgkJCWNhc2UgIkVudGl0eSI6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIkltYWdlIjoKCQkJY2FzZSAiRmlsZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCWVRFQSc6IkJMT0IifWA7CgkJCWRlZmF1bHQ6CgkJCQlyZXR1cm4gdHlwZSArICIoNDApIjsKCQl9Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgYkFzeW5jKSB7CgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgbW9kdWxlKSB7CgkJCQlhd2FpdCB0aGlzLmltcG9ydChtLCBiQXN5bmMpOwoJCQl9CgkJCXJldHVybjsKCQl9CgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCXZhciBqcyA9IG51bGw7CgkJdHJ5IHsKCQkJanMgPSAoYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBtb2R1bGUKCQkJfSkpIHx8IChhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiB0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIG1vZHVsZSArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pKTsKCQl9IGNhdGNoIChleCkge30KCQlpZiAoIWpzKSB7CgkJCWpzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IG1vZHVsZS5pbmRleE9mKCcvJykgPj0gMCA/IG1vZHVsZSA6IChDTVNfUk9PVCArIG1vZHVsZSkKCQkJfSk7CgkJCWlmIChqcykganMgPSBqcy5TY3JpcHQ7CgkJfQoJCWlmICghanMpIHJldHVybiBudWxsOwoJCXJldHVybiBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcywgYkFzeW5jKTsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQltb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KG4uc2NyaXB0LCBuLm5vUnVuKSk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IGF3YWl0IHJlcy50ZXh0KCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiBudWxsOwoJCQkJCWpzID0gcC5zY3JpcHQoKSA/IHAuX2F0b2IocC5zY3JpcHQoKSkgOiBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWpzKSBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogYmxvY2sKCQkJfSwgImJsb2NrcyIpIHx8IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KTsKCQkJaWYgKGpzKSB7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzKTsKCQkJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5vYmogPSBvYmo7CgkJCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCXRyeSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbCB8fCBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgkJdGhpcy5zdGVwKCk7CgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMSAmJiAhd2luZG93LmZyYW1lcy5sZW5ndGg7CgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgiTW9kdWxlcyIpOwoJCX0gZWxzZSB7CgkJCWlmICh3aW5kb3cuYkxvY2FsKSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5pbXBvcnQoIi4uLy4uLyIgKyAod2luZG93LmJMb2NhbCA/ICIuLi9lbXMvIiA6ICIiKSArICJzY3JpcHQvbW9kdWxlcyIpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogJ01vZHVsZXMnCgkJCQl9KTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoJ0pRdWVyeScpOwoJCX0KCgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCSQod2luZG93KS5vbignaGFzaGNoYW5nZScsIGFzeW5jICgpID0+IHsKCQkJdGhpcy5mcm9tSGFzaCgpOwoJCQlpZiAodGhpcy5hbGxEYXRhICYmIHRoaXMuYWxsRGF0YS5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICE9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlICYmIHRoaXMuZW5kQ2FsbGVkKSB7CgkJCQlpZiAod2luZG93LmZyYW1lcy5sZW5ndGgpIHsKCQkJCQkvLyBmcmFtZS1iYXNlZCB0ZW1wbGF0ZQoJCQkJCWF3YWl0IHRoaXMuaW5pdERPTSgpOwoJCQkJfSBlbHNlIHsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNlcnZpY2VSb3V0ZXIiKTsKCQl0aGlzLl9pbml0U2VydmljZVJvdXRlcigpOwoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKCk7CgkJYXdhaXQgdGhpcy5faW5pdENvbnRlbnRNYW5hZ2VyKCk7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKTsgLy93aW5kb3dbY29tcGFueS5TY29wZV07CgkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQoKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQlsZXQgbWMgPSAob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLmZpbmQoYyA9PiBjLklzTWFpbik7CgkJY29uc29sZS5sb2coInByZUluaXQoKTogb1Njb3BlIiwgb1Njb3BlKQoJCWlmIChtYykgewoJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCWxvYWRUb29sczogdHJ1ZSwKCQkJCWluaXRTZWxmOiB0cnVlLAoJCQkJaW5pdE5vZGU6IHRydWUKCQkJfSk7CgkJfQoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogd2luZG93W3Njb3BlXSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgJC5nZXQodXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQlzY29wZSA9IHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpIHx8ICJ3aW5kb3ciOwoJCWxldCBlYXMgPSBbXTsKCgkJaWYgKGVjICYmIGVjLmxpYnJhcnkgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCXRyeSB7CgkJCQllYyA9IGF3YWl0IHRoaXMucmVxdWlyZSgnU2NoZW1hJyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBjb21wYW55LkNvZGUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJfQoKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoc2NvcGUgIT09ICJ3aW5kb3ciKSB7CgkJCWlmICh0eXBlb2Yod2luZG93W3Njb3BlXSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkvLyBjbGVhbnVwIHRoZSBvbGQgc2NvcGUKCQkJCWRlbGV0ZSB3aW5kb3dbc2NvcGVdOwoJCQl9CgkJCXdpbmRvd1tzY29wZV0gPSB7fTsKCQl9CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuRW50aXR5Q2xhc3NlcyA9IHJldDsKCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdCA9IChzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0IHx8IHt9OwoJCWlmICh0aGlzLnNyKCkuc2VydmVyRGF0ZSkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdC5EYXRlID0gdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCgkJaWYgKCFlYXMubGVuZ3RoKSB7CgkJCS8vIGNsYXNzZXMgZnJvbSBKU09OIEFycmF5CgkJCWVhcyA9IGVhcy5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcykpOwoJCX0KCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5FbnRpdHlBdHRyaWJ1dGVzID0gZWFzOwoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gW107CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgoJCWlmIChlYXMubGVuZ3RoKSB7CgkJCSh0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpKS5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIikuZm9yRWFjaChnID0+IHsKCQkJCWcua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBnLnZhbHVlczsKCQkJCWcua2V5LkVudGl0eU1vZHVsZSA9IG07CgkJCQlnLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eUNsYXNzID0gZy5rZXkpOwoKCQkJCWlmIChlYyAmJiBBcnJheS5pc0FycmF5KGVjKSkgZWMucHVzaChnLmtleSk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIG5vdCBzdG9yZWQgaW4gRU1TLCBjaGVjayBpZiBhdmFpbGFibGUgYXMgYSBzdG9yZWQgc2NyaXB0CgkJCXRyeSB7CgkJCQlsZXQgbUVDcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogbU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJCW1FQ3MgPSBtRUNzLmZpbHRlcihjID0+IChtLkV4Y2x1ZGVzIHx8IFtdKS5pbmRleE9mKGMuTmFtZSkgPCAwKTsKCgkJCQltRUNzLmZpbHRlcihjID0+ICFjLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IHsKCQkJCQljLkVudGl0eVJ1bGVzID0gYy5FbnRpdHlSdWxlcyB8fCBbXTsKCQkJCQljLkVudGl0eVJ1bGVzLnB1c2goLi4uKCgobS5FbnRpdHlSdWxlcyB8fCB7fSlbYy5OYW1lXSkgfHwgW10pKTsKCQkJCQljLkVudGl0eU1vZHVsZSA9IG07CgkJCQl9KTsKCQkJCWRlbGV0ZSBtLkVudGl0eVJ1bGVzOwoJCQkJZWMucHVzaCguLi5tRUNzKTsKCgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDbGFzc2VzIiwgZWMubWFwKGMgPT4gYy5FbnRpdHlNb2R1bGUpKTsKCQkJCWZvciBhd2FpdCAoY29uc3QgZG0gb2YgZWMuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgIT0gbU5hbWUpKSB7CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2FuZGlkYXRlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGRtLkVudGl0eU1vZHVsZS5OYW1lKS5sZW5ndGgpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTW9kdWxlIGFscmVhZHkgbG9hZGVkISIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJCWNvbnRpbnVlOwoJCQkJCX0KCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiByZWN1cnNpdmUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZG0uRW50aXR5TW9kdWxlKSB7CgkJCQkJCShkbS5FbnRpdHlNb2R1bGUgfHwgZG0pLkltcG9ydHMrKzsKCQkJCQkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShkbS5FbnRpdHlNb2R1bGUsIGVjKTsKCQkJCQl9CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogRmFpbGVkIGxvYWRpbmcgbW9kdWxlICIgKyBtTmFtZSwgZXgpOwoJCQl9CgkJfQoJfQoKCV9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB7CgkJbGV0IG9Hcm91cGVyID0gdGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKTsKCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKEFycmF5LmlzQXJyYXkoZWMpICYmICEoZWFzIHx8IFtdKS5sZW5ndGgpIHsKCQkJZWMgPSBlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgKHR5cGVvZihjLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGMuQWN0aXZlKSk7CgoJCQllYy5mb3JFYWNoKGMgPT4gewoJCQkJYy5JZCA9IGMuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJYy5QbHVyYWwgPSBjLlBsdXJhbCB8fCAoYy5OYW1lICsgInMiKTsKCQkJCWMuX1RvU3RyaW5nID0gYy5fVG9TdHJpbmcgfHwgYy5OYW1lOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcyB8fCBbXTsKCgkJCQlsZXQgX2Jhc2VfID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZSA9PSAnX19CQVNFX18nKTsKCQkJCWlmIChfYmFzZV8pIHsKCQkJCQlsZXQgcHJvcExpc3QgPSBbJ0lzVW5pcXVlJywgJ0NvZGUnLCAnRGVmYXVsdCcsICdWYWx1ZScsICdSZXF1aXJlZCcsICdEdXBsaWNhdGUnXTsKCQkJCQlwcm9wTGlzdC5maWx0ZXIocCA9PiBBcnJheS5pc0FycmF5KF9iYXNlX1twXSkpLmZvckVhY2gocCA9PiBfYmFzZV9bcF0gPSBPYmplY3QuYXNzaWduKHt9LCAuLi5fYmFzZV9bcF0ubWFwKF9hID0+ICh7CgkJCQkJCVtfYV06IHRydWUKCQkJCQl9KSkpKTsKCgkJCQkJbGV0IGF0dExpc3QgPSBbewoJCQkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiY29kZSIsCgkJCQkJCUlzVW5pcXVlOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJvcmRlciIsCgkJCQkJCUlzSW50OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJuYW1lIiwKCQkJCQkJUmVxdWlyZWQ6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogInJlbWFyayIsCgkJCQkJCUlzVGV4dDogdHJ1ZSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJcmV0dXJuIHRoaXMuc3IoKS5fID8gdGhpcy5zcigpLl9fc2NvcGUoc2NvcGUpIDogdGhpczsKCX0KCglhc3luYyBfYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCgkJb1Njb3BlLm5OYW1lID0gb1Njb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlvU2NvcGUubkNvZGUgPSBvU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIGh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKSkpOwoKCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gIiI7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQlhckNsYXNzZXM6IHJldCwKCQkJCWM6IGMsCgkJCQlzY29wZTogc2NvcGUsCgkJCQluTmFtZTogb1Njb3BlLm5OYW1lLAoJCQkJbkNvZGU6IG9TY29wZS5uQ29kZSwKCQkJfSkgKyAnXG4nICsgb1Njb3BlLm5OYW1lKGMpOwoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSArPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtvU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7b1Njb3BlLm5OYW1lKGMpfSA9ICR7b1Njb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IG9TY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tvU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJfQoKCQlyZXR1cm4gX2NvZGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCXRoaXMuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCXRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9jbG9uZUZ1bmN0aW9uKG8sIGYsIHNjb3BlLCBjKSB7CgkJbGV0IGNvZGUgPSB3aW5kb3dbb11bZl0gPyB3aW5kb3dbb11bZl0udG9TdHJpbmcoKSA6IGAgICAke2Z9KCl7CgkJICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oJHtvfSwgJHtmfSk6IEludmFsaWQgRnVuY3Rpb24gTmFtZScpOwoJICAgIH1gOwoJCWxldCBzID0gY29kZS5yZXBsYWNlKCcpJywgJykgPT4gJyk7CgkJaWYgKHMuaW5kZXhPZignZnVuY3Rpb24nKSA9PSAwIHx8IHMuaW5kZXhPZignYXN5bmMgZnVuY3Rpb24nKSA9PSAwKSB7CgkJCXMgPSBzLnJlcGxhY2UoJ2Z1bmN0aW9uJywgJyAnKTsKCQl9IGVsc2UgewoJCQlzID0gcy5yZXBsYWNlKGYsICcnKTsKCQl9CgoJCWlmIChjLklzTWFpbiAmJiAhd2luZG93W29dW2ZdKSB7CgkJCWNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oKTogSW52YWxpZCBGdW5jdGlvbiBOYW1lICcgKyBmKTsKCQl9CgoJCXJldHVybiBgCiAgICAke2Z9KC4uLnBhcmFtcyl7CiAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LiR7b30pIT09InVuZGVmaW5lZCIpewogICAgICAgICAgICByZXR1cm4gd2luZG93LiR7b30uJHtmfSguLi5wYXJhbXMpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBgICsgKGMuSXNNYWluID8gYHJldHVybiAoJHtzfSkoLi4ucGFyYW1zKTtgIDogYHJldHVybiBuZXcgJHtzY29wZX0uJHt3aW5kb3dbc2NvcGVdLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpfSgpLiR7Zn0oLi4ucGFyYW1zKTtgKSArIGAKICAgICAgICB9Cgl9CmA7Cgl9CgoJX2luaXRTZXJ2aWNlUm91dGVyKCkgewoJCWlmICh0eXBlb2YoU2VydmljZVJvdXRlcikgPT09ICd1bmRlZmluZWQnKSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5faW5pdFNlcnZpY2VSb3V0ZXIoKTogU2VydmljZVJvdXRlciBub3QgZGVmaW5lZC4iKTsKCQkJcmV0dXJuOwoJCX0KCQl3aW5kb3cuc3IgPSB3aW5kb3cuc3IgfHwgbmV3IFNlcnZpY2VSb3V0ZXIoKTsKCgkJLy9jb25zb2xlLmxvZygiX2luaXRTZXJ2aWNlUm91dGVyKCk6IGNvbXBhbnkiLCBjb21wYW55KQoKCQl0aGlzLnNyKCkuU3RvcmUgPSB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TdG9yZSA6IHVuZGVmaW5lZDsKCQl0aGlzLnNyKCkuaW5pdChudWxsLCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkubGlicmFyeSA6IHVuZGVmaW5lZCkgfHwgIkVudGVycHJpc2VNYW5hZ2VyIiwgdHJ1ZSwgdGhpcy5iRGVidWcpOwoJCWlmICh0eXBlb2Ygc3JVUkwgIT09ICd1bmRlZmluZWQnKSB0aGlzLnNyKCkuc3JVUkwgPSBzclVSTDsKCQl0aGlzLnNyKCkuZkxvYWRpbmdTdGFydCA9ICgpID0+IHsKCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5sb2FkaW5nKCdzaG93Jyk7CgkJfTsKCQl0aGlzLnNyKCkuZkxvYWRpbmdFbmQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnaGlkZScpOwoJCX07Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiZW5kKCkgd2l0aCBkYXRhIiwgZGF0YSk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQkvL29Db250ZW50LmhpZGUoKTsKCQkJLy9vQ29udGVudC5mYWRlSW4oMTAwMCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgewoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJCUVudGl0eU9iamVjdDogKGMub2JqID8gYy5vYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQkJfSkpOwoJCQl9CgkJfSk7CgkJcmV0dXJuICQud2hlbiguLi5hckNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJJC5lYWNoKHJldCwgKGksIHIpID0+IHsKCQkJCWlmIChyICYmIHIubGVuZ3RoICYmIHJbMF0uT3JkZXIpIHsKCQkJCQlyLnNvcnQoKGEsIGIpID0+IHsKCQkJCQkJaWYgKGEuT3JkZXIgPCBiLk9yZGVyKSByZXR1cm4gLTE7CgkJCQkJCWlmIChhLk9yZGVyID4gYi5PcmRlcikgcmV0dXJuIDE7CgkJCQkJCXJldHVybiAwOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKSB0aGlzLl9jYWxsc1tpXS5DYWxsYmFjayhyKTsKCQkJfSk7CgkJfSkudGhlbigoKSA9PiB7CgkJCXRoaXMuX2NhbGxzID0gW107CgkJfSk7Cgl9CgoJX28oZkNhbGxCYWNrLCBvYmopIHsKCQl0aGlzLnN0ZXAoKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogJ0xvYWRpbmcnLAoJCQkJCW1zZzogJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJCQl0aXRsZTogJ1BsZWFzZSB3YWl0aW5nJywKCQkJCQkJCW1zZzogJ1NhdmluZyBkYXRhLi4uJywKCQkJCQkJCWludGVydmFsOiBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgc2F2ZXIodmFsdWUsIGZEYXRhKTsKCQkJCQkJZWRpdG9yLmxhc3RTYXZlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIFNhdmUgZmlsZS5cbiIgKyBleCk7CgkJCQkJfQoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF92dWVDb21wb25lbnQoY29kZSkgewoJCWlmICh0eXBlb2YgVnVlID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7Cgl9CgoJYXN5bmMgX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJY29uc29sZS5sb2coIlJlbmRlclBhZ2UiLCBwYWdlLCBkYXRhKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMucGFnZXNbaV0uX2NvZGUgPT0gcGFnZS5fY29kZSAmJiB0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSAmJiAodGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgPT0gKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpKSB7CgkJCQljb25zb2xlLmxvZygod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSk7CgkJCQlwYWdlID0gdGhpcy5wYWdlc1tpXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlmICghdGhpcy5zcigpLmJMb2NhbCAmJiAocGFnZS5Cb2R5IHx8IHBhZ2UudG9FbnRpdHlPYmplY3QpKSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBhbHJlYWR5IGxvYWRlZCwgc2VydmluZy4uLiIpOwoJCQkvLyBmb3VuZCB0aGUgcGFnZSBhbmQgaXQgaXMgYW4gb2JqZWN0CgkJCWlmICghcGFnZS5TY3JpcHQpIHsKCQkJCWxldCBlID0gYXdhaXQgdGhpcy5lbmQoKTsKCQkJCXJldHVybiBlOwoJCQl9CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQljb25zb2xlLmxvZygiX3JlbmRlcigpIHVzaW5nIGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyLlNjb3BlKTsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpLmZpbmQoKTsKCQkJaWYgKHApIHJldCA9IHsKCQkJCVNjcmlwdDogcC5zY3JpcHQoKSA/IHAuX2F0b2IocC5zY3JpcHQoKSkgOiAnJywKCQkJCUJvZHk6IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCX0KCgkJaWYgKCFyZXQpIHJldCA9IGF3YWl0IHRoaXMuX3Z1ZUNvbXBvbmVudChwYWdlLl9jb2RlKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YoQ01TX1JPT1QpID09PSAnc3RyaW5nJykgewoJCQlyZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogcGFnZS5fY29kZS5pbmRleE9mKCcvJykgPj0gMCA/IHBhZ2UuX2NvZGUgOiAoQ01TX1JPT1QgKyBwYWdlLl9jb2RlKQoJCQl9KTsKCQl9CgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBDTVMsIGxvb2tpbmcgaW4gRU1TIik7CgkJCXZhciBlb1BhZ2UgPSBudWxsOwoJCQl0cnkgewoJCQkJZW9QYWdlID0gbmV3IFBhZ2UoKS5jb2RlKHBhZ2UuX2NvZGUsICI9Iik7CgkJCQlpZiAoZW9QYWdlLmxhbmd1YWdlKSBlb1BhZ2UubGFuZ3VhZ2Uod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iLCAiPSIpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZygiRU1TIGRvZXMgbm90IGhhdmUgYSBQYWdlIGNsYXNzLCBmYWlsaW5nIG9uIHB1cnBvc2U6ICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAodGhpcy5zcigpLl8pIHJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJRW50aXR5T2JqZWN0OiAoZW9QYWdlID8gZW9QYWdlLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJfSk7CgkJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCkgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIEVNUywgdHJ5aW5nIHRlbXBsYXRlcyIpOwoJCQkJcGFnZSA9IHJldFswXTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gRU1TLCBzbyBnb2luZyBsb2NhbCIpOwoJCQl9CgoJCQlsZXQgaHRtbCA9IG51bGw7CgkJCXRyeSB7CgkJCQlodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5odG0iKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoaHRtbCAmJiAhaHRtbC5zdGF0dXMpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBodG1sIHRlbXBsYXRlIGZvdW5kIiwgaHRtbCk7CgkJCQlwYWdlLkJvZHkgPSBodG1sOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGhhcyBubyBodG1sIHRlbXBsYXRlIik7CgkJCQlpZiAoIXBhZ2UuQm9keSAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoTWFpbkNvbXBvbmVudCkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQkJfSBlbHNlIHsKCQkJCQlwYWdlLkJvZHkgPSBwYWdlLl9jb250ZW50IHx8ICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQkJfQoJCQl9CgoJCQlsZXQganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUocGFnZSk7CgkJCWlmICghanMpIHRyeSB7CgkJCQlqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuanMiKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoIWpzIHx8ICFqcy5vaykganMgPSBudWxsOwoJCQlpZiAoanMgJiYganMub2spIHBhZ2UuU2NyaXB0ID0gYXdhaXQganMudGV4dCgpOwoKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIHNjcmlwdCBpcyIgKyAoanMgPyAnJyA6ICcgbm90JykgKyAiIHJldHJpZXZlZCIpOwoJCQl0aGlzLnN0ZXAoKTsKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQkvL2NvbnNvbGUubG9nKCJwYWdlIEJvZHkiLCBwYWdlLl9ib2R5IHx8IHBhZ2UuQm9keSk7CgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9IHRoaXMuYmxvY2tzLmhlYWRlci5odG1sICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5KSArIHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoanMuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoanMpOwoJCQl9IGVsc2UgewoJCQkJbGV0IHNDb2RlID0ganM7CgkJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQkJfQoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdCgiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyIpOwoJCQl9CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKGpzKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwganMuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJdHJ5IHsKCQkJCXJldHVybiBKU09OLnBhcnNlKGpzKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXJldHVybiBldmFsKGpzKTsKCQkJfQoJCX0KCX0KfTs=",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
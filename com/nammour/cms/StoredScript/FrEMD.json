{
	"Id": "054f733df257e32e324b71daced396a1abf16402",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXykgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlcikgewoJCQlsZXQgX3MgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9hcnpob3NwaXRhbC5naXRodWIuaW8vY29tL25hbW1vdXIvY21zL1N0b3JlZFNjcmlwdC8ke3MuTmFtZSB8fCBzLm5hbWV9Lmpzb24/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJCWlmIChfcy5vaykgc2NyaXB0ID0gYXRvYigoYXdhaXQgX3MuanNvbigpKS5zY3JpcHQpOwoJCX0KCgkJaWYgKHNjcmlwdCkgewoJCQlyZXR1cm4gKGJOb1J1biA/IHNjcmlwdCA6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHNjcmlwdCkpOwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJubyBzdG9yZWQgc2NyaXB0IGxvYWRlciB0byB1c2UiLCBzKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCWFzeW5jIF9pbml0Q29udGVudE1hbmFnZXIoKSB7CgkJbGV0IGFyQ2xhc3NlcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCU5hbWU6ICJDb250ZW50IE1hbmFnZXIiLAoJCQlFbmFibGVkOiB0cnVlLAoJCX0pOwoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGFyQ2xhc3NlcywgImNvbnRlbnRtYW5hZ2VyIik7Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLnNyKCkuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gc2NvcGUgfHwgY29tcGFueS5TY29wZTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuSWQgPyB0bXAgOiAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1BhZ2VUZW1wbGF0ZUZpbmQiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJVHlwZTogewoJCQkJTmFtZTogIkVudGl0eVRlbXBsYXRlIgoJCQl9LAoJCQlOYW1lOiB0bXAuTmFtZSB8fCB0bXAubmFtZSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0KTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0ZW1wbGF0ZVtmXS5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGVtcGxhdGVbZl0gPSB0ZW1wbGF0ZVtmXS5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGVtcGxhdGVbZl0sIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSB3aW5kb3dbc2NvcGVdOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoJCQl0aGlzLnBydkZ1bmMgPSBwcnZGdW5jIHx8ICgoKSA9PiB7fSk7CgkJCXRoaXMubVJhbmsgPSAwOwoKCQkJaWYgKGJSYW5rKSB0aGlzLm1SYW5rID0gTWF0aC5tYXgoMCwgLi4udGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlJhbmspKTsgLy8gdXNlZnVsIGluIHRlbXBsYXRlcwoKCQkJdGhpcy5tYWluVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuc3BsaXQoJy0nKVswXTsKCQkJdGhpcy5zdWJUaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5pbmRleE9mKCctJykgPj0gMCA/IGRhdGEuVGl0bGUuc3BsaXQoJy0nKVsxXSA6ICIiOwoJCX0KCgkJX25ldyhjLCB0b29sLCBpZCkgewoJCQlpZiAoIWMpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKTsKCQkJaWYgKHR5cGVvZihjKSA9PT0gJ3N0cmluZycpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBjKTsKCQkJaWYgKCFjKSByZXR1cm4gbnVsbDsKCgkJCWxldCBtU2NvcGUgPSBjLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKGMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXJldHVybiBuZXcobVNjb3BlW25OYW1lKGMpXSkoaWQsIHRvb2wpOwoJCX0KCgkJY25mKF9jLCBpZCwgZGlkLCB0b29sKSB7CgkJCV9jID0gX2MgfHwgdGhpcy5tYzsKCQkJbGV0IG1TY29wZSA9IF9jLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKF9jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXJldHVybiBtU2NvcGUuX25vZGUgPyBtU2NvcGUuX25vZGUuX19jb25maWcoaWQsIGRpZCwgewoJCQkJdG9vbDogdG9vbAoJCQl9KSA6ICh0aGlzLl9uZXcoX2MsIHRvb2wpLl9fY29uZmlnKGlkLCBkaWQsIHRvb2wgPyB7CgkJCQl0b29sOiB0b29sCgkJCX0gOiB1bmRlZmluZWQpKTsKCQl9CgoJCW5UeXBlKGVhKSB7CgkJCWlmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Jvb2wpIHsKCQkJCXJldHVybiAiYm9vbGVhbiI7CgkJCX0gZWxzZSBpZiAoZWEuSXNGbG9hdCkgewoJCQkJcmV0dXJuICJmbG9hdCI7CgkJCX0gZWxzZSBpZiAoZWEuSXNJbnQgfHwgZWEuSXNMb25nKSB7CgkJCQlyZXR1cm4gIm51bWJlciI7CgkJCX0gZWxzZSBpZiAoZWEuSXNEYXRlKSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCgkJX3QocHJvcCwgb2JqLCBzZWFyY2gpIHsKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBvYmpbcHJvcF07CgoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl90IiwgZXgpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0U1ZHKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoJChgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnIHNyYz0nJHtfRnJFTUQuX3N2Z0Jhc2U2NChyZXQuQm9keSl9Jy8+YCkpOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0ZhZGkgTmFtbW91cid9LCBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5AZW5kdW1sYCkuc3BsaXQoJ0BlbmR1bWwnKS5tYXAoYiA9PiBgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazsgaGVpZ2h0OiAxMDAlJyBzcmM9J2h0dHBzOi8vd3d3LnBsYW50dW1sLmNvbS9wbGFudHVtbC9wbmcvJHt0aGlzLnpvcChiKydAZW5kdW1sJyl9Jy8+YCkuam9pbignPGJyLz4nKTsKCgkJCXRoaXMucHJ2RnVuYygkKGA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBvdmVyZmxvdy15OiBzY3JvbGw7Ij4ke2h0bWx9PC9kaXY+YCkpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJem9wKHMpIHsKCQkJcyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzKSk7CgkJCXZhciBhcnIgPSBbXTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSBhcnIucHVzaChzLmNoYXJDb2RlQXQoaSkpOwoJCQlsZXQgeiA9IG5ldyBab3BmbGkuUmF3RGVmbGF0ZShhcnIpLmNvbXByZXNzKCk7CgkJCXJldHVybiB0aGlzLmVuY29kZTY0Xyh6KTsKCQl9CgoJCWVuY29kZTY0XyhkYXRhKSB7CgkJCWxldCByID0gIiI7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMykgewoJCQkJaWYgKGkgKyAyID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgMCk7CgkJCQl9IGVsc2UgaWYgKGkgKyAxID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCAwLCAwKTsKCQkJCX0gZWxzZSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgZGF0YVtpICsgMl0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiByOwoJCX0KCgkJYXBwZW5kM2J5dGVzKGIxLCBiMiwgYjMpIHsKCQkJbGV0IGMxID0gYjEgPj4gMjsKCQkJbGV0IGMyID0gKChiMSAmIDB4MykgPDwgNCkgfCAoYjIgPj4gNCk7CgkJCWxldCBjMyA9ICgoYjIgJiAweEYpIDw8IDIpIHwgKGIzID4+IDYpOwoJCQlsZXQgYzQgPSBiMyAmIDB4M0Y7CgkJCWxldCByID0gIiI7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMxICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMyICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMzICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGM0ICYgMHgzRik7CgkJCXJldHVybiByOwoJCX0KCgkJZW5jb2RlNmJpdChiKSB7CgkJCWlmIChiIDwgMTApIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDQ4ICsgYik7CgkJCX0KCQkJYiAtPSAxMDsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiID09IDApIHsKCQkJCXJldHVybiAnLSc7CgkJCX0KCQkJaWYgKGIgPT0gMSkgewoJCQkJcmV0dXJuICdfJzsKCQkJfQoJCQlyZXR1cm4gJz8nOwoJCX0KCX0KCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQpIHsKCQkJCXJldHVybiBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQobi5zY3JpcHQsIG4ubm9SdW4pOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKGpzRXh0KSByZXR1cm4gcmV0OwoJCQkJCQkJCWlmICghbi5sb2FkKSByZXR1cm4gYXdhaXQgcmVzLnRleHQoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiBudWxsOwoJCQkJCWpzID0gcC5zY3JpcHQoKSA/IHAuX2F0b2IocC5zY3JpcHQoKSkgOiBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWpzKSBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogYmxvY2sKCQkJfSwgImJsb2NrcyIpIHx8IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KTsKCQkJaWYgKGpzKSB7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzKTsKCQkJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5vYmogPSBvYmo7CgkJCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCXRyeSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbCB8fCBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgkJdGhpcy5zdGVwKCk7CgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMTsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiQ29tcGFueSIpOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWNvbXBhbnkuU2NvcGUgPSBjb21wYW55LlNjb3BlIHx8ICJ3aW5kb3ciOwoJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWUgKyAiOiBsb2FkaW5nLi4uIjsKCQl9CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiU2VydmljZVJvdXRlciIpOwoJCXRoaXMuX2luaXRTZXJ2aWNlUm91dGVyKCk7CgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoKTsKCQlhd2FpdCB0aGlzLl9pbml0Q29udGVudE1hbmFnZXIoKTsKCgkJYXdhaXQgdGhpcy5fbWFuaWZlc3QoKTsKCgkJbGV0IG9TY29wZSA9IHRoaXMuc3IoKS5fX3Njb3BlKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCk7IC8vd2luZG93W2NvbXBhbnkuU2NvcGVdOwoJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJbGV0IG1jID0gKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5maW5kKGMgPT4gYy5Jc01haW4pOwoJCWlmIChtYykgewoJCQlhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCWluaXROb2RlOiB0cnVlCgkJCX0pOwoJCX0KCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J30/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHdpbmRvd1tzY29wZV0sCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKCF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0ICQuZ2V0KHVybCk7CgkJCWh0bWwgPSB0aGlzLl9pbmplY3QoaHRtbCwgd2luZG93LnBhcmVudCk7CgoJCQljb25zdCBkb21wID0gbmV3IERPTVBhcnNlcigpOwoJCQlsZXQgZG9jID0gZG9tcC5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQvaHRtbCIpOwoJCQlhd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKGRvYyk7CgkJCWNvbnNvbGUubG9nKCJodG1sIGJpbmRpbmcgZG9uZSEiKTsKCgkJCWh0bWwgPSBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKCQkJLy9odG1sID0gJ3Rlc3QnOwoKCQkJLy93aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uID0gdXJsOwoJCQl3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LndyaXRlKGh0bWwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fYmluZEtPKCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCWFzeW5jIF9iaW5kS08oKSB7CgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA+PSAwKSB7CgkJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQkJLy9hd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIHRydWUpOwoKCQkJCWtvLmNsZWFuTm9kZSh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJa28uYXBwbHlCaW5kaW5ncyh3aW5kb3csIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQl9LCAzMDApOwoJCX0KCX0KCglfc2V0KG9iaiwgcGF0aCwgdmFsKSB7CgkJdmFyIHN0cmluZ1RvUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCQkJLy8gSWYgdGhlIHBhdGggaXNuJ3QgYSBzdHJpbmcsIHJldHVybiBpdAoJCQlpZiAodHlwZW9mIHBhdGggIT09ICdzdHJpbmcnKSByZXR1cm4gcGF0aDsKCQkJLy8gQ3JlYXRlIG5ldyBhcnJheQoJCQl2YXIgb3V0cHV0ID0gW107CgkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggZG90IG5vdGF0aW9uCgkJCXBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CgkJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGJyYWNrZXQgbm90YXRpb24KCQkJCWl0ZW0uc3BsaXQoL1xbKFtefV0rKVxdL2cpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCQkJLy8gUHVzaCB0byB0aGUgbmV3IGFycmF5CgkJCQkJaWYgKGtleS5sZW5ndGggPiAwKSB7CgkJCQkJCW91dHB1dC5wdXNoKGtleSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0pOwoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgkJLy8gQ29udmVydCB0aGUgcGF0aCB0byBhbiBhcnJheSBpZiBub3QgYWxyZWFkeQoJCXBhdGggPSBzdHJpbmdUb1BhdGgocGF0aCk7CgkJLy8gQ2FjaGUgdGhlIHBhdGggbGVuZ3RoIGFuZCBjdXJyZW50IHNwb3QgaW4gdGhlIG9iamVjdAoJCXZhciBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCQl2YXIgY3VycmVudCA9IG9iajsKCQkvLyBMb29wIHRocm91Z2ggdGhlIHBhdGgKCQlwYXRoLmZvckVhY2goZnVuY3Rpb24oa2V5LCBpbmRleCkgewoJCQkvLyBDaGVjayBpZiB0aGUgYXNzaWduZWQga2V5IHNob3VsIGJlIGFuIGFycmF5CgkJCXZhciBpc0FycmF5ID0ga2V5LnNsaWNlKC0yKSA9PT0gJ1tdJzsKCQkJLy8gSWYgc28sIGdldCB0aGUgdHJ1ZSBrZXkgbmFtZSBieSByZW1vdmluZyB0aGUgdHJhaWxpbmcgW10KCQkJa2V5ID0gaXNBcnJheSA/IGtleS5zbGljZSgwLCAtMikgOiBrZXk7CgkJCS8vIElmIHRoZSBrZXkgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBpc24ndCwgY3JlYXRlIGFuIGFycmF5CgkJCWlmIChpc0FycmF5ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50W2tleV0pICE9PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCQljdXJyZW50W2tleV0gPSBbXTsKCQkJfQoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxvb3AsIGFzc2lnbiB0aGUgdmFsdWUKCQkJaWYgKGluZGV4ID09PSBsZW5ndGggLSAxKSB7CgkJCQkvLyBJZiBpdCdzIGFuIGFycmF5LCBwdXNoIHRoZSB2YWx1ZQoJCQkJLy8gT3RoZXJ3aXNlLCBhc3NpZ24gaXQKCQkJCWlmIChpc0FycmF5KSB7CgkJCQkJY3VycmVudFtrZXldLnB1c2godmFsKTsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFtrZXldID0gdmFsOwoJCQkJfQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJZWxzZSB7CgkJCQkvLyBJZiB0aGUga2V5IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdAoJCQkJaWYgKCFjdXJyZW50W2tleV0pIHsKCQkJCQljdXJyZW50W2tleV0gPSB7fTsKCQkJCX0KCQkJCS8vIFVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCQljdXJyZW50ID0gY3VycmVudFtrZXldOwoJCQl9CgkJfSk7Cgl9CgoJX3BhZ2VGaWx0ZXIoYikgewoJCWlmICghYi5fYWN0aXZlKSByZXR1cm4gZmFsc2U7CgkJbGV0IHBhZ2UgPSB0eXBlb2YoX0ZyRU1ELmhhc2gucGFnZSkgPT09ICd1bmRlZmluZWQnID8gJ2luZGV4JyA6IF9GckVNRC5oYXNoLnBhZ2U7CgkJaWYgKHR5cGVvZihiLl9wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGIuX3BhZ2UuX3VybCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gYi5fcGFnZS5fdXJsID09IHBhZ2U7Cgl9CgoJYXN5bmMgX2FwcGx5QmluZGluZ3MoZG9jID0gd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgYkFmdGVyID0gZmFsc2UpIHsKCQl0aGlzLmZyb21IYXNoKCk7CgkJaWYgKHRoaXMuaGFzaC5ub0JpbmRpbmcpIHJldHVybjsKCQlsZXQgYmluZGluZ3MgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkJpbmRpbmdzIik7CgkJaWYgKCFiaW5kaW5ncyAmJiBjb21wYW55LkJpbmRpbmdzKSB7CgkJCWJpbmRpbmdzID0gYXdhaXQgY29tcGFueS5CaW5kaW5ncygpOwoJCX0KCQliaW5kaW5ncyA9IGJpbmRpbmdzIHx8IFtdOwoKCQlzci5ncm91cEJ5KGJpbmRpbmdzLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5maWx0ZXIoYiA9PiBiQWZ0ZXIgPyBiLl9hZnRlciA6ICFiLl9hZnRlciksICJfcGF0aCIpLmZvckVhY2gocGIgPT4gewoJCQl0cnkgewoJCQkJbGV0IGUgPSBkb2MuZXZhbHVhdGUocGIua2V5LCBkb2MsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7CgkJCQlsZXQgZF9iaW5kID0ge307CgkJCQlwYi52YWx1ZXMuZm9yRWFjaChiID0+IHsKCQkJCQl0aGlzLl9zZXQoZF9iaW5kLCBiLl9hdHRyaWJ1dGUsIGIuX2NvZGUpOwoJCQkJfSk7CgkJCQkkKGUpLmF0dHIoImRhdGEtYmluZCIsIEpTT04uc3RyaW5naWZ5KGRfYmluZCkucmVwbGFjZSgvIi9nLCAnJykpOwoJCQkJLy9jb25zb2xlLmxvZyhwYi5rZXksIGUpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2cocGIua2V5LCBleCk7CgkJCX0KCQl9KTsKCX0KCglhc3luYyBpbml0KCkgewoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCWF3YWl0IHRoaXMuX2xvYWRDb250ZW50KCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCV91dWlkKGlkLCBsZW4pIHsKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoaWQpIHsKCQkJbGV0IGhjID0gTWF0aC5hYnMoTnVtYmVyKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnID8gc3IuaGFzaENvZGUoaWQpIDogaWQubGVuZ3RoKSk7CgkJCWxldCBocyA9IGggPT4gTnVtYmVyKFN0cmluZyhoKS5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpKTsKCQkJbGV0IHUgPSBocyhocyhoYykgKiBocyhoYykpLnRvU3RyaW5nKDE2KTsKCgkJCXJldCA9IHUgKyAnJyArIHUgKyAnJyArIHU7CgkJCWlmIChyZXQubGVuZ3RoID4gMzIpIHJldCA9IHJldC5zdWJzdHJpbmcoMCwgMzIpOwoJCX0KCgkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHYoKTsKCgkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpOwoKCQlyZXR1cm4gcmV0LnJlcGxhY2UoL1wtL2csICcnKTsKCX0KCglhc3luYyBfbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKSB7CgkJc2NvcGUgPSBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXykgewoJCQlsZXQgbGNzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0dlbmVyYXRlTGF5ZXJDbGFzcyIsIG51bGwsIGVjLmxpYnJhcnkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKGMuTGF5ZXJBdHRyaWJ1dGVzLCAoXywgbGEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogbGEuTmFtZSwKCQkJCVBsdXJhbDogbGEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IGxhLAoJCQkJSXNCb29sOiBsYS5OYXRpdmVUeXBlID09ICJib29sIiwKCQkJCUlzU3RyaW5nOiBsYS5OYXRpdmVUeXBlID09ICJzdHJpbmciLAoJCQkJSXNUZXh0OiBsYS5OYXRpdmVUeXBlID09ICJ0ZXh0IiwKCQkJCUlzTG9uZzogbGEuTmF0aXZlVHlwZSA9PSAibG9uZyIsCgkJCQlJc0Zsb2F0OiBsYS5OYXRpdmVUeXBlID09ICJmbG9hdCIsCgkJCQlJc0ludDogbGEuTmF0aXZlVHlwZSA9PSAiaW50ZWdlciIsCgkJCQlJc0RvdWJsZTogbGEuTmF0aXZlVHlwZSA9PSAiZG91YmxlIiwKCQkJCUlzRGF0ZTogbGEuTmF0aXZlVHlwZSA9PSAiZGF0ZXRpbWUiLAoJCQkJSXNGaWxlOiBsYS5OYXRpdmVUeXBlID09ICJmaWxlIiwKCQkJCUlzSW1hZ2U6IGxhLk5hdGl2ZVR5cGUgPT0gImltYWdlIiwKCQkJCUlzT2JqZWN0OiBsYS5OYXRpdmVUeXBlID09ICJvYmplY3QiLAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKCQuZ3JlcChjLlJlbGF0aW9uQXR0cmlidXRlcywgcmEgPT4gIXJhLklzQXJyYXkpLCAoXywgcmEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogcmEuTmFtZSwKCQkJCVBsdXJhbDogcmEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IHJhLAoJCQkJSXNCb29sOiBmYWxzZSwKCQkJCUlzU3RyaW5nOiBmYWxzZSwKCQkJCUlzVGV4dDogZmFsc2UsCgkJCQlJc0xvbmc6IGZhbHNlLAoJCQkJSXNGbG9hdDogZmFsc2UsCgkJCQlJc0ludDogZmFsc2UsCgkJCQlJc0RvdWJsZTogZmFsc2UsCgkJCQlJc0RhdGU6IGZhbHNlLAoJCQkJSXNGaWxlOiBmYWxzZSwKCQkJCUlzSW1hZ2U6IGZhbHNlLAoJCQkJRW50aXR5VHlwZTogewoJCQkJCUlkOiBzci5oYXNoQ29kZShyYS5SZWxhdGlvbkNsYXNzLk5hbWUpLAoJCQkJCU5hbWU6IHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSwKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJfSBlbHNlIGlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJdHJ5IHsKCQkJCWVjID0gYXdhaXQgdGhpcy5yZXF1aXJlKCdTY2hlbWEnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogY29tcGFueS5Db2RlLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCX0KCgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgewoJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCQl9CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKHNjb3BlICE9PSAid2luZG93IikgewoJCQlpZiAodHlwZW9mKHdpbmRvd1tzY29wZV0pICE9PSAidW5kZWZpbmVkIikgewoJCQkJLy8gY2xlYW51cCB0aGUgb2xkIHNjb3BlCgkJCQlkZWxldGUgd2luZG93W3Njb3BlXTsKCQkJfQoJCQl3aW5kb3dbc2NvcGVdID0ge307CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUNsYXNzZXMgPSByZXQ7CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQgPSAoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdCB8fCB7fTsKCQlpZiAodGhpcy5zcigpLnNlcnZlckRhdGUpKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQuRGF0ZSA9IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuRW50aXR5QXR0cmlidXRlcyA9IGVhczsKCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IHRoaXMuX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlDbGFzc2VzKCk6IEV4Y2VwdGlvbiIsIGV4KTsKCQkJLyphd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJTmFtZTogIkFQSVN5c3RlbSIsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQl9KTsqLwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLnNyKCkuX19zY29wZShzY29wZSk7CgoJCW9TY29wZS5uTmFtZSA9IG9TY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJb1Njb3BlLm5Db2RlID0gb1Njb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWNvbnNvbGUubG9nKCJodG1sIiwgaHRtbC5sZW5ndGgpCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIHsKCQkJbGV0IHNOYW1lID0gbVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpOwoKCQkJaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUoc05hbWUpKTsKCgkJCS8qbGV0IGNvZGUgPSBhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiAoc3IuYkxvY2FsID8gIi9uYW1tb3VyLmNvbS9lbXMvIiA6ICIiKSArICJzY3JpcHQvIiArIG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpICsgIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpLAoJCQkJZGF0YVR5cGU6ICJzY3JpcHQiLAoJCQl9KTsKCQkJaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBjb2RlKTsqLwoJCX0KCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gIiI7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQlhckNsYXNzZXM6IHJldCwKCQkJCWM6IGMsCgkJCQlzY29wZTogc2NvcGUsCgkJCQluTmFtZTogb1Njb3BlLm5OYW1lLAoJCQkJbkNvZGU6IG9TY29wZS5uQ29kZSwKCQkJfSkgKyAnXG4nICsgb1Njb3BlLm5OYW1lKGMpOwoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSArPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtvU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7b1Njb3BlLm5OYW1lKGMpfSA9ICR7b1Njb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IG9TY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tvU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJCWlmIChjLklzTWFpbikgewoJCQkJLy9hbGlhcy5HZW5lcmljU2VydmljZUFQSSA9IEdlbmVyaWNTZXJ2aWNlQVBJOwoJCQl9CgkJfQoKCQlyZXR1cm4gX2NvZGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lcyA9IHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lcyB8fCB7fTsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9jbG9uZUZ1bmN0aW9uKG8sIGYsIHNjb3BlLCBjKSB7CgkJbGV0IGNvZGUgPSB3aW5kb3dbb11bZl0gPyB3aW5kb3dbb11bZl0udG9TdHJpbmcoKSA6IGAgICAke2Z9KCl7CgkJICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oJHtvfSwgJHtmfSk6IEludmFsaWQgRnVuY3Rpb24gTmFtZScpOwoJICAgIH1gOwoJCWxldCBzID0gY29kZS5yZXBsYWNlKCcpJywgJykgPT4gJyk7CgkJaWYgKHMuaW5kZXhPZignZnVuY3Rpb24nKSA9PSAwIHx8IHMuaW5kZXhPZignYXN5bmMgZnVuY3Rpb24nKSA9PSAwKSB7CgkJCXMgPSBzLnJlcGxhY2UoJ2Z1bmN0aW9uJywgJyAnKTsKCQl9IGVsc2UgewoJCQlzID0gcy5yZXBsYWNlKGYsICcnKTsKCQl9CgoJCWlmIChjLklzTWFpbiAmJiAhd2luZG93W29dW2ZdKSB7CgkJCWNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oKTogSW52YWxpZCBGdW5jdGlvbiBOYW1lICcgKyBmKTsKCQl9CgoJCXJldHVybiBgCiAgICAke2Z9KC4uLnBhcmFtcyl7CiAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LiR7b30pIT09InVuZGVmaW5lZCIpewogICAgICAgICAgICByZXR1cm4gd2luZG93LiR7b30uJHtmfSguLi5wYXJhbXMpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBgICsgKGMuSXNNYWluID8gYHJldHVybiAoJHtzfSkoLi4ucGFyYW1zKTtgIDogYHJldHVybiBuZXcgJHtzY29wZX0uJHt3aW5kb3dbc2NvcGVdLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpfSgpLiR7Zn0oLi4ucGFyYW1zKTtgKSArIGAKICAgICAgICB9Cgl9CmA7Cgl9CgoJX2luaXRTZXJ2aWNlUm91dGVyKCkgewoJCWlmICh0eXBlb2YoU2VydmljZVJvdXRlcikgPT09ICd1bmRlZmluZWQnKSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5faW5pdFNlcnZpY2VSb3V0ZXIoKTogU2VydmljZVJvdXRlciBub3QgZGVmaW5lZC4iKTsKCQkJcmV0dXJuOwoJCX0KCQl3aW5kb3cuc3IgPSBuZXcgU2VydmljZVJvdXRlcigpOwoKCQl0aGlzLnNyKCkuU3RvcmUgPSBjb21wYW55LlN0b3JlOwoJCXRoaXMuc3IoKS5pbml0KG51bGwsIGNvbXBhbnkubGlicmFyeSB8fCAiRW50ZXJwcmlzZU1hbmFnZXIiLCB0cnVlLCB0aGlzLmJEZWJ1Zyk7CgkJaWYgKHR5cGVvZiBzclVSTCAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuc3IoKS5zclVSTCA9IHNyVVJMOwoJCXRoaXMuc3IoKS5mTG9hZGluZ1N0YXJ0ID0gKCkgPT4gewoJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmxvYWRpbmcoJ3Nob3cnKTsKCQl9OwoJCXRoaXMuc3IoKS5mTG9hZGluZ0VuZCA9ICgpID0+IHsKCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5sb2FkaW5nKCdoaWRlJyk7CgkJfTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCXJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDApIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiAnTG9hZGluZycsCgkJCQkJbXNnOiAnTG9hZGluZyBkYXRhLi4uJywKCQkJCQlpbnRlcnZhbDogaW50ZXJ2YWwsCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHJldHVybiBmYWxzZTsKCX0KCglhc3luYyByZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCkgewoJCWlmICghZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQpIHRoaXMuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyBvRWxlbWVudC5pbnRlcnZhbCA6IG51bGwpOwoJCXRyeSB7CgkJCWxldCB2ID0gYXdhaXQgbG9hZGVyKGZEYXRhLCBvRWxlbWVudCwgZWRpdG9yKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJbGV0IGRpZmYgPSAwOwoJCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgJiYgZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQuZ2V0VGltZSgpIC0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmID4gMCAmJiBkaWZmIDwgMTAwKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiTm90IGNoYW5nZWQgb24gdGhlIHNlcnZlciIpOwoJCQl9IGVsc2UgewoJCQkJLy8gY29uc29sZS5sb2coIlNlcnZlciBjaGFuZ2UsIHNldHRpbmcgdmFsdWUiLCBkaWZmKTsKCQkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkOwoJCQkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodik7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIExvYWQgZmlsZS5cbiIgKyBleCk7CgkJfQoJCXRoaXMuX2xvYWRpbmcoZmFsc2UpOwoKCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSB7CgkJCS8vYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDAuNSAqIDYwICogMTAwMCkpOwoJCQlhd2FpdCB0aGlzLl93YWl0KDAuNSAqIDYwICogMTAwMCk7CgkJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoJCX0KCX0KCglhc3luYyBPcGVuRWRpdG9yKGUsIGxhbmd1YWdlID0gbyA9PiAiaHRtbCIsIGxvYWRlciA9IG8gPT4ge30sIHNhdmVyID0gKHYsIG8pID0+IHt9LCBmRGF0YSwgb0VsZW1lbnQpIHsKCQl2YXIgZWRpdG9yID0gYWNlLmVkaXQoZSk7CgkJZGVsZXRlIGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTsKCQkvL2FjZS5jb25maWcuc2V0KCdiYXNlUGF0aCcsICcvbm9kZV9tb2R1bGVzL2FjZS1idWlsZHMvc3JjLW1pbi1ub2NvbmZsaWN0Jyk7CgkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUoJycpOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS8nICsgbGFuZ3VhZ2UoZkRhdGEpKTsKCQllZGl0b3Iub24oImNoYW5nZSIsIGUgPT4gewoJCQlsZXQgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQuZ2V0VGltZSgpIC0gc3Iuc2VydmVyRGF0ZSgpLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmIDwgMTAwICYmIGUuc3RhcnQucm93ID09IDAgJiYgZS5zdGFydC5jb2x1bW4gPT0gMCkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGNvbnNvbGUubG9nKCJDaGFuZ2VkIEV2ZW50IiwgZGlmZik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCX0pOwoJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoKCQlpZiAoc2F2ZXIpIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHsKCQkJbmFtZTogJ3NhdmUnLAoJCQliaW5kS2V5OiB7CgkJCQl3aW46ICJDdHJsLVMiLAoJCQkJbWFjOiAiQ21kLVMiCgkJCX0sCgkJCWV4ZWM6IGFzeW5jIGVkaXRvciA9PiB7CgkJCQl2YXIgdmFsdWUgPSB0aGlzLl9iZWF1dGlmeShlZGl0b3IuZ2V0VmFsdWUoKSwgbGFuZ3VhZ2UoZkRhdGEpKTsKCQkJCWlmICh2YWx1ZSAhPSBlZGl0b3Iuc2Vzc2lvbi5nZXRWYWx1ZSgpKSBlZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2YWx1ZSk7CgkJCQlpZiAoc2F2ZXIpIHsKCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQkJCXRpdGxlOiAnUGxlYXNlIHdhaXRpbmcnLAoJCQkJCQkJbXNnOiAnU2F2aW5nIGRhdGEuLi4nLAoJCQkJCQkJaW50ZXJ2YWw6IG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KTsKCX0KCglfYmVhdXRpZnkodmFsdWUsIHR5cGUpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzX2JlYXV0aWZ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBvcHRpb25zID0gewoJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJImU0eCI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoJCQkJdmFsdWUgPSB0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwoJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnLCAnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCXZhbHVlID0ganNfYmVhdXRpZnkodmFsdWUsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHt9CgkJcmV0dXJuIHZhbHVlOwoJfQoKCV9sYW5nKGNvZGUpIHsKCQl3aW5kb3cubGFuZyA9IGNvZGU7CgkJdGhpcy5zZXRVUkwoInBhZ2U9IiArICh0aGlzLmFsbERhdGEucGFnZS5fY29kZSB8fCAnaW5kZXgnKSk7Cgl9CgoJc2VsZWN0MlNSKG9TZWxlY3QpIHsKCQlsZXQgcyA9ICQob1NlbGVjdCk7CgkJbGV0IGNhbGxzID0gW107CgkJaWYgKHRoaXMuc2VsZWN0MlRlbXBsYXRlKSB7CgkJCWNhbGxzLnB1c2godGhpcy5zZWxlY3QyVGVtcGxhdGUpOwoJCX0gZWxzZSB7CgkJCWNhbGxzLnB1c2godGhpcy5zcigpLkdldCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvc2VsZWN0Mi10ZW1wbGF0ZS5odG0iKSkpOwoJCX0KCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQl0aGlzLnNlbGVjdDJUZW1wbGF0ZSA9IHJldFswXTsKCQkJcy5zZWxlY3QyKHsKCQkJCWFqYXg6IHsKCQkJCQl0cmFuc3BvcnQ6IChwYXJhbXMsIHN1Y2Nlc3MsIGZhaWx1cmUpID0+IHsKCQkJCQkJdmFyIGZGaWx0ZXIgPSB0aGlzLnNyKCkucnVuU2NyaXB0KCIobywgc3RhdGUpID0+IHsiICsgcy5kYXRhKCJzcl9maWx0ZXIiKSArICJ9Iik7CgkJCQkJCSQud2hlbih0aGlzLnNyKCkuXyhzLmRhdGEoInNyX21ldGhvZCIpLCBudWxsLCBmRmlsdGVyKHt9LCB0aGlzLnNyKCkucnVuU2NyaXB0KHMuZGF0YSgiY19zdGF0ZSIpKSkpKS50aGVuKHJldCA9PiB7CgkJCQkJCQlzdWNjZXNzKHsKCQkJCQkJCQlwYWdpbmF0aW9uOiB7CgkJCQkJCQkJCW1vcmU6IGZhbHNlCgkJCQkJCQkJfSwKCQkJCQkJCQlyZXN1bHRzOiAkLm1hcChyZXQsIHIgPT4gewoJCQkJCQkJCQlyLmlkID0gci5JZDsKCQkJCQkJCQkJci50ZXh0ID0gci5Ub1N0cmluZzsKCQkJCQkJCQkJcmV0dXJuIHI7CgkJCQkJCQkJfSksCgkJCQkJCQkJdG90YWxzOiByZXQubGVuZ3RoCgkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSwKCQkJCXRlbXBsYXRlUmVzdWx0OiAoX2UsIF9zKSA9PiB7CgkJCQkJcmV0dXJuIHRoaXMuX2luamVjdCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSwgewoJCQkJCQlkYXRhOiBfZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQkJcy5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCQljb25zb2xlLmxvZyhlLnRhcmdldCk7CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2Uuc2VsZWN0MiIsIGUgPT4gewoJCQkJLy92YXIgZGF0YSA9IGUucGFyYW1zLmRhdGE7CgkJCQl2YXIgX3MgPSAkKGUudGFyZ2V0KTsKCQkJfSk7CgkJfSk7Cgl9CgoJYXN5bmMgcHJlQ29tcGlsZShwYWdlLCBsb2NhdGlvbikgewoJCWlmICh0eXBlb2YgQmFiZWwgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mIFJlYWN0ICE9PSAidW5kZWZpbmVkIikgewoJCQlsZXQganN4ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWpzeCA9IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGpzeCA9PT0gbnVsbCB8fCBqc3ggPT09ICIiKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQl2YXIgcmVzID0gbnVsbDsKCQkJdHJ5IHsKCQkJCXJlcyA9IGF3YWl0IEJhYmVsLnRyYW5zZm9ybShqc3gsIHsKCQkJCQlwcmVzZXRzOiBbJ2xhdGVzdCcsICJyZWFjdCJdCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJCYWJlbCIsIGV4KTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXJldHVybiByZXMuY29kZTsKCQl9Cgl9CgoJYXN5bmMgX3Z1ZUNvbXBvbmVudChjb2RlKSB7CgkJaWYgKHR5cGVvZiBWdWUgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IHAuc2NyaXB0KCkgPyBwLl9hdG9iKHAuc2NyaXB0KCkpIDogJycsCgkJCQlCb2R5OiBwLmJvZHkoKSA/IHAuX2F0b2IocC5ib2R5KCkpIDogJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0KSByZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKENNU19ST09UKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKS5fKSByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBudWxsOwoJCQl0cnkgewoJCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuaHRtIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSB0cnkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKCFqcyB8fCAhanMub2spIGpzID0gbnVsbDsKCQkJaWYgKGpzICYmIGpzLm9rKSBwYWdlLlNjcmlwdCA9IGF3YWl0IGpzLnRleHQoKTsKCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBzY3JpcHQgaXMiICsgKGpzID8gJycgOiAnIG5vdCcpICsgIiByZXRyaWV2ZWQiKTsKCQkJdGhpcy5zdGVwKCk7CgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgkJcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJLy9jb25zb2xlLmxvZygicGFnZSBCb2R5IiwgcGFnZS5fYm9keSB8fCBwYWdlLkJvZHkpOwoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJdHJ5IHsKCQkJCWxldCBvYmogPSBuZXcgcGFnZS5TY3JpcHQocGFnZSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSB0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCArICh0aGlzLmJsb2Nrcy5jb250ZW50Lmh0bWwgfHwgX3BhZ2UuQm9keSB8fCBfcGFnZS5fYm9keSkgKyB0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbDsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGpzLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkJLy8gYSBjbGFzcyBkZWZpbml0aW9uLCBkbyBub3QgZW5jbG9zZSBpdCBpbiBhIGZ1bmN0aW9uCgkJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KGpzKTsKCQkJfSBlbHNlIHsKCQkJCWxldCBzQ29kZSA9IGpzOwoJCQkJaWYgKHNDb2RlLmluZGV4T2YoJ3JldHVybiAnKSAhPSAwKSB7CgkJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJCX0KCQkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoIihhc3luYyAoKSA9PiB7IiArIHNDb2RlICsgIlxufSkoKTsiKTsKCQkJfQoJCX0gZWxzZSBpZiAoZmFsc2UgJiYgdHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IHJldCA9IGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCXNjcmlwdC5hc3luYyA9IGJBc3luYzsKCQkJCXNjcmlwdC5zcmMgPSBgZGF0YTp0ZXh0L2phdmFzY3JpcHQ7YmFzZTY0LCR7dGhpcy5fYnRvYShqcyl9YDsKCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCX0pOwoJCQljb25zb2xlLmxvZyhyZXQsIGpzLnN1YnN0cmluZygwLCAyMCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXRyeSB7CgkJCQlyZXR1cm4gSlNPTi5wYXJzZShqcyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlyZXR1cm4gZXZhbChqcyk7CgkJCX0KCQl9Cgl9Cn07",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
{
	"Id": "e9fbd507a2a5b2a1dd7c4b1092c204e8cdef7115",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "FrEMD",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sOwoKCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgdGhpcy5fZ2V0KGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9YCwgdHJ1ZSk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiB0eXBlb2YocmV0LnJlcGxhY2UpID09PSAnZnVuY3Rpb24nICYmICF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMuX2dldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuLCBiSW50KSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGJJbnQpIHJldHVybiBNYXRoLmZsb29yKERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpKTsKCgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6X21lbnVDbGFzc2VzKCIgKyBzY29wZSArICIpOiBvU2NvcGUiLCBzY29wZSwgb1Njb3BlLCB0aGlzLmFwaVNlcnZlcik7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAodGhpcy5oYXNoLnNjb3BlIHx8ICcnKS5yZXBsYWNlKC9cIC9nLCAnJykudG9Mb3dlckNhc2UoKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9fc2NvcGUoKTogc2NvcGUiLCBzY29wZSk7CgoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCByU2NvcGUgPSB7CgkJCUVudGl0eUNsYXNzZXM6IHJldCwKCQkJRW50aXR5QXR0cmlidXRlczogZWFzLAoJCX07CgoJCXJTY29wZS5uTmFtZSA9IHJTY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJclNjb3BlLm5Db2RlID0gclNjb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSBodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJykpKTsKCgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICcnOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSAiIjsKCQkJdHJ5IHsKCQkJCWNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJCWM6IGMsCgkJCQkJc2NvcGU6IHNjb3BlLAoJCQkJCW5OYW1lOiByU2NvcGUubk5hbWUsCgkJCQkJbkNvZGU6IHJTY29wZS5uQ29kZSwKCQkJCX0pICsgJ1xuJyArIHJTY29wZS5uTmFtZShjKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfYnVpbGRDbGFzc2VzKCk6IF9pbmplY3QgZXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlID0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7clNjb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke3JTY29wZS5uTmFtZShjKX0gPSAke3JTY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSByU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbclNjb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCX0KCgkJcmV0dXJuIHJTY29wZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gZDsKCQlvU2NvcGUuX190aW1lcyA9IG9TY29wZS5fX3RpbWVzIHx8IHt9OwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gb1Njb3BlLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIG9TY29wZS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCU9iamVjdC5rZXlzKHRoaXMuaGFzaCkuZm9yRWFjaChoID0+IHRoaXMuaGFzaFtoXSA9IGRlY29kZVVSSSh0aGlzLmhhc2hbaF0pKTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDAsIG1zZywgdGl0bGUpIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiB0aXRsZSB8fCAnTG9hZGluZycsCgkJCQkJbXNnOiBtc2cgfHwgJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsICdTYXZpbmcgZGF0YS4uLicsICdQcm9ncmVzcycpOwoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlfRnJFTUQuX2xvYWRpbmcoZmFsc2UpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCWpzeCA9IGF3YWl0IHRoaXMuX2dldCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IiwgdHJ1ZSk7CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIgJiYgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKSkgewoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkgfHwgJycpLAoJCQkJQm9keTogcC5ib2R5KCkgfHwgJycsCgkJCQlTdHlsZTogcC5zdHlsZSgpIHx8ICcnLAoJCQkJX2NvZGU6IHBhZ2UuX2NvZGUsCgkJCX07CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCIgKyB0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIpIHVzaW5nIGFwaVNlcnZlciIsIHAsIHJldCk7CgkJfQoKCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQlwYWdlLkJvZHkgPSBhd2FpdCB0aGlzLmltcG9ydCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSwgewoJCQkJZXh0OiAnaHRtJywKCQkJCWZpZWxkOiAnYm9keScsCgkJCX0pOwoKCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih2dWUpID09PSAndW5kZWZpbmVkJykgewoJCQkJcGFnZS5Cb2R5ID0gLypwYWdlLl9jb250ZW50IHx8ICovICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQl9CgoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMuaW1wb3J0KCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlLCB7CgkJCQlleHQ6ICdqcycsCgkJCQlmaWVsZDogJ3NjcmlwdCcsCgkJCX0pOwoKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCgkJLy9pZiAocGFnZS5TY3JpcHQpIHBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCXRyeSB7CgkJCWN1c3RvbUVsZW1lbnRzLmRlZmluZShwYWdlLl9jb2RlLCBwYWdlLmNvbXBvbmVudCA9IHZ1ZS5kZWZpbmVDdXN0b21FbGVtZW50KE9iamVjdC5hc3NpZ24obmV3IHBhZ2UuU2NyaXB0KCksIHsKCQkJCXRlbXBsYXRlOiBwYWdlLkJvZHksCgkJCQlzdHlsZXM6IFtwYWdlLlN0eWxlXQoJCQl9KSkpOwoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogcGFnZSBhcyB2dWVqcyBjdXN0b20gZWxlbWVudCIsIHBhZ2UpOwoJCQlwYWdlLkJvZHkgPSBudWxsOwoJCQkvL3BhZ2UuU2NyaXB0ID0gbnVsbDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogVnVlIEV4Y2VwdGlvbjogIiArIGV4KTsKCQkJcGFnZS5jb21wb25lbnQgPSBudWxsOwoJCX0KCgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIiAmJiAhcGFnZS5jb21wb25lbnQpIHsKCQkJdHJ5IHsKCQkJCXBhZ2UuY29tcG9uZW50ID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UsIERGb3JtKTsKCQkJCWlmIChwYWdlLmNvbXBvbmVudCAmJiBwYWdlLmNvbXBvbmVudC5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IHBhZ2UuY29tcG9uZW50Lm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBuZXcgcGFnZS5TY3JpcHQoKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coIkZyRU1EOjplbmQoKTogZGF0YSIsIGRhdGEsIHRoaXMuYWxsSFRNTCk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoKCQkJaWYgKHR5cGVvZih2dWUpICE9PSAndW5kZWZpbmVkJyAmJiBwYWdlLmNvbXBvbmVudCAmJiB0eXBlb2YocGFnZS5jb21wb25lbnQuZGVmKSA9PT0gJ29iamVjdCcpIHsKCQkJCWNvbnNvbGUubG9nKCJlbmQoKTogYWRkaW5nIFZ1ZUpTIENvbXBvbmVuZXQgdG8gcGFnZSIsIHBhZ2UpOwoJCQkJb0NvbnRlbnQuYXBwZW5kKG5ldyBwYWdlLmNvbXBvbmVudCgpKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9ICh0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCB8fCAnJykgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkgfHwgJycpICsgKHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sIHx8ICcnKTsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCgkJdHJ5IHsKCQkJcmV0dXJuIEpTT04ucGFyc2Uoc0NvZGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQlsZXQgc0NvZGUgPSBqczsKCQlpZiAoc0NvZGUuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCX0gZWxzZSB7CgkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJfQoJCQlzQ29kZSA9ICIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7IjsKCQl9CgoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KHNDb2RlKTsKCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2Eoc0NvZGUpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBzQ29kZS5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChzQ29kZSk7CgkJfQoJfQp9Ow==",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDAxOTVlN2FkY2E2Nzc2NWFhMDVkYjA5M2NmMWI4YWZjIDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSAwMTk1ZTdhZGNhNjc3NjVhYTA1ZGI3OGYxMGJhMjIyOCA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sOwoKCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgdGhpcy5fZ2V0KGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9YCwgdHJ1ZSk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiB0eXBlb2YocmV0LnJlcGxhY2UpID09PSAnZnVuY3Rpb24nICYmICF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMuX2dldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuLCBiSW50KSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGJJbnQpIHJldHVybiBNYXRoLmZsb29yKERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpKTsKCgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6X21lbnVDbGFzc2VzKCIgKyBzY29wZSArICIpOiBvU2NvcGUiLCBzY29wZSwgb1Njb3BlLCB0aGlzLmFwaVNlcnZlcik7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAodGhpcy5oYXNoLnNjb3BlIHx8ICcnKS5yZXBsYWNlKC9cIC9nLCAnJykudG9Mb3dlckNhc2UoKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9fc2NvcGUoKTogc2NvcGUiLCBzY29wZSk7CgoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCByU2NvcGUgPSB7CgkJCUVudGl0eUNsYXNzZXM6IHJldCwKCQkJRW50aXR5QXR0cmlidXRlczogZWFzLAoJCX07CgoJCXJTY29wZS5uTmFtZSA9IHJTY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJclNjb3BlLm5Db2RlID0gclNjb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSBodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJykpKTsKCgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICcnOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSAiIjsKCQkJdHJ5IHsKCQkJCWNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJCWM6IGMsCgkJCQkJc2NvcGU6IHNjb3BlLAoJCQkJCW5OYW1lOiByU2NvcGUubk5hbWUsCgkJCQkJbkNvZGU6IHJTY29wZS5uQ29kZSwKCQkJCX0pICsgJ1xuJyArIHJTY29wZS5uTmFtZShjKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfYnVpbGRDbGFzc2VzKCk6IF9pbmplY3QgZXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlID0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7clNjb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke3JTY29wZS5uTmFtZShjKX0gPSAke3JTY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSByU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbclNjb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCX0KCgkJcmV0dXJuIHJTY29wZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gZDsKCQlvU2NvcGUuX190aW1lcyA9IG9TY29wZS5fX3RpbWVzIHx8IHt9OwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gb1Njb3BlLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIG9TY29wZS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCU9iamVjdC5rZXlzKHRoaXMuaGFzaCkuZm9yRWFjaChoID0+IHRoaXMuaGFzaFtoXSA9IGRlY29kZVVSSSh0aGlzLmhhc2hbaF0pKTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDAsIG1zZywgdGl0bGUpIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiB0aXRsZSB8fCAnTG9hZGluZycsCgkJCQkJbXNnOiBtc2cgfHwgJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsICdTYXZpbmcgZGF0YS4uLicsICdQcm9ncmVzcycpOwoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlfRnJFTUQuX2xvYWRpbmcoZmFsc2UpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCWpzeCA9IGF3YWl0IHRoaXMuX2dldCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IiwgdHJ1ZSk7CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIgJiYgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKSkgewoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkgfHwgJycpLAoJCQkJQm9keTogcC5ib2R5KCkgfHwgJycsCgkJCQlTdHlsZTogcC5zdHlsZSgpIHx8ICcnLAoJCQkJX2NvZGU6IHBhZ2UuX2NvZGUsCgkJCX07CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCIgKyB0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIpIHVzaW5nIGFwaVNlcnZlciIsIHAsIHJldCk7CgkJfQoKCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQlwYWdlLkJvZHkgPSBhd2FpdCB0aGlzLmltcG9ydCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSwgewoJCQkJZXh0OiAnaHRtJywKCQkJCWZpZWxkOiAnYm9keScsCgkJCX0pOwoKCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih2dWUpID09PSAndW5kZWZpbmVkJykgewoJCQkJcGFnZS5Cb2R5ID0gLypwYWdlLl9jb250ZW50IHx8ICovICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQl9CgoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMuaW1wb3J0KCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlLCB7CgkJCQlleHQ6ICdqcycsCgkJCQlmaWVsZDogJ3NjcmlwdCcsCgkJCX0pOwoKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCgkJLy9pZiAocGFnZS5TY3JpcHQpIHBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCXRyeSB7CgkJCWN1c3RvbUVsZW1lbnRzLmRlZmluZShwYWdlLl9jb2RlLCBwYWdlLmNvbXBvbmVudCA9IHZ1ZS5kZWZpbmVDdXN0b21FbGVtZW50KE9iamVjdC5hc3NpZ24obmV3IHBhZ2UuU2NyaXB0KCksIHsKCQkJCXRlbXBsYXRlOiBwYWdlLkJvZHksCgkJCQlzdHlsZXM6IFtwYWdlLlN0eWxlXQoJCQl9KSkpOwoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogcGFnZSBhcyB2dWVqcyBjdXN0b20gZWxlbWVudCIsIHBhZ2UpOwoJCQlwYWdlLkJvZHkgPSBudWxsOwoJCQkvL3BhZ2UuU2NyaXB0ID0gbnVsbDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogVnVlIEV4Y2VwdGlvbjogIiArIGV4KTsKCQkJcGFnZS5jb21wb25lbnQgPSBudWxsOwoJCX0KCgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIiAmJiAhcGFnZS5jb21wb25lbnQpIHsKCQkJdHJ5IHsKCQkJCXBhZ2UuY29tcG9uZW50ID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UsIERGb3JtKTsKCQkJCWlmIChwYWdlLmNvbXBvbmVudCAmJiBwYWdlLmNvbXBvbmVudC5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IHBhZ2UuY29tcG9uZW50Lm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBuZXcgcGFnZS5TY3JpcHQoKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coIkZyRU1EOjplbmQoKTogZGF0YSIsIGRhdGEsIHRoaXMuYWxsSFRNTCk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoKCQkJaWYgKHR5cGVvZih2dWUpICE9PSAndW5kZWZpbmVkJyAmJiBwYWdlLmNvbXBvbmVudCAmJiB0eXBlb2YocGFnZS5jb21wb25lbnQuZGVmKSA9PT0gJ29iamVjdCcpIHsKCQkJCWNvbnNvbGUubG9nKCJlbmQoKTogYWRkaW5nIFZ1ZUpTIENvbXBvbmVuZXQgdG8gcGFnZSIsIHBhZ2UpOwoJCQkJb0NvbnRlbnQuYXBwZW5kKG5ldyBwYWdlLmNvbXBvbmVudCgpKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9ICh0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCB8fCAnJykgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkgfHwgJycpICsgKHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sIHx8ICcnKTsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCgkJdHJ5IHsKCQkJcmV0dXJuIEpTT04ucGFyc2Uoc0NvZGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQlsZXQgc0NvZGUgPSBqczsKCQlpZiAoc0NvZGUuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCX0gZWxzZSB7CgkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJfQoJCQlzQ29kZSA9ICIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7IjsKCQl9CgoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KHNDb2RlKTsKCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2Eoc0NvZGUpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBzQ29kZS5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChzQ29kZSk7CgkJfQoJfQp9Ow==",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195e7adca67765aa05db093cf1b8afc",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "0195e7adca67765aa05db78f10ba2228",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
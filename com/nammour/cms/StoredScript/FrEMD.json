{
	"Id": "cef7222e3fbab2c99678518ce3216edce1c4abf3",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpKT8uU2NyaXB0OwoJCX0gZWxzZSBpZiAoIXRoaXMuYXBpU2VydmVyKSB7CgkJCWxldCBfcyA9IGF3YWl0IGZldGNoKGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbj9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQkJaWYgKF9zLm9rKSBzY3JpcHQgPSBhdG9iKChhd2FpdCBfcy5qc29uKCkpLnNjcmlwdCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJYXN5bmMgX2luaXRDb250ZW50TWFuYWdlcigpIHsKCQlsZXQgYXJDbGFzc2VzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSk7CgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXJDbGFzc2VzLCAiY29udGVudG1hbmFnZXIiKTsKCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGMuTmFtZSwKCQkJCVRvb2xzOiBjLlRvb2xzLAoJCQkJRGVidWc6IGMuRGVidWcsCgkJCQlUZXN0OiBjLlRlc3QsCgkJCQlDb25maWc6IGMuQ29uZmlnLAoJCQkJRW5hYmxlZDogYy5FbmFibGVkLAoJCQkJRW50aXR5QXR0cmlidXRlczogYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gZWFNYXAoZWEpKSwKCQkJCUVudGl0eU1ldGhvZHM6IGMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiAoewoJCQkJCU5hbWU6IG0uTmFtZSwKCQkJCQlTY3JpcHQ6IG0uU2NyaXB0LAoJCQkJCVJvdXRpbmc6IG0uUm91dGluZywKCQkJCQlNZXRob2RQYXJhbWV0ZXJzOiBtLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gZWFNYXAocCkpLAoJCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBlYU1hcChtLlJlc3BvbnNlQXR0cmlidXRlKSwKCQkJCX0pKSwKCQkJfTsKCgkJCVsiVG9vbHMiLCAiRW50aXR5TWV0aG9kcyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIXJldFthXS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlbIkRlYnVnIiwgIlRlc3QiLCAiQ29uZmlnIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghT2JqZWN0LmtleXMocmV0W2FdKS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlyZXQuRW50aXR5QXR0cmlidXRlcyA9IHJldC5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9ICJpZCIpOwoJCQlyZXR1cm4gcmV0OwoJCX0pOwoJfQoKCWFzeW5jIF9ydW5TZXF1ZW5jZXMoc2Vxcywgc2NvcGUpIHsKCQlsZXQgY2FsbFNlcXVlbmNlcyA9IFtdOwoJCWlmICghc2NvcGUpIHJldHVybiBjYWxsU2VxdWVuY2VzOwoKCQlmb3IgYXdhaXQgKGNvbnN0IHNlcSBvZiBzZXFzKSB7CgkJCWxldCBjYWxsU2VxdWVuY2UgPSB7CgkJCQlhY3RpdmU6IHRydWUsCgkJCQl0aXRsZTogc2VxLnRpdGxlLAoJCQkJY2xhc3NpZmllcjogc2VxLmNsYXNzaWZpZXIsCgkJCQllbnRpdGllczogW10sCgkJCQl0aW1lbGluZTogW10sCgkJCX07CgoJCQlsZXQgX2VudGl0aWVzID0gc2VxLmVudGl0aWVzLmZpbHRlcihlID0+IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCWUub2JqID0gbmV3IHNjb3BlW2UudHlwZV0oKS5fZnJvbURvY3VtZW50KGUuY29udGVudCk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCS8vIGZpcnN0IGxldmVsIHJlZmVyZW5jZSBjbGVhbnVwOiBtYWtlIHN1cmUgb25seSBvbmUgcmVmZXJlbmNlIG9iamVjdCBpcyB1c2VkIHdpdGggdGhlIHNhbWUgIl9uYW1lIi4gbG93ZXIgbGV2ZWxzIHNob3VsZCBiZSBkb25lIHJlY3Vyc2l2ZWx5CgkJCQlzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKF9lYSA9PiBfZWEuTmFtZSA9PSAnbmFtZScgJiYgX2VhLklzU3RyaW5nKSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKGUub2JqWydfJyArIGVhLk5hbWVdKSB7CgkJCQkJCWUub2JqWydfJyArIGVhLk5hbWVdID0gKHNlcS5lbnRpdGllcy5maW5kKF9lID0+IF9lICE9PSBlICYmIF9lLm9iaiAmJiBfZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUgPT0gZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUpIHx8IGUpLm9ialsnXycgKyBlYS5OYW1lXTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJc2VxLnN0ZXBzID0gc2VxLnN0ZXBzLm1hcChzID0+IHsKCQkJCWlmICghcy5faWYpIHJldHVybiBbc107CgkJCQlyZXR1cm4gcy5fdGhlbi5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogdHJ1ZQoJCQkJCX0KCQkJCX0pKS5jb25jYXQocy5fZWxzZS5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogZmFsc2UKCQkJCQl9CgkJCQl9KSkpOwoJCQl9KTsKCQkJc2VxLnN0ZXBzID0gW10uY29uY2F0LmFwcGx5KFtdLCBzZXEuc3RlcHMpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIHNlcS5zdGVwcykgewoJCQkJaWYgKHMuaWdub3JlKSBjb250aW51ZTsKCgkJCQlsZXQgX2Zyb20gPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IHMuZnJvbSk7CgkJCQlpZiAoIV9mcm9tKSB7CgkJCQkJY29uc29sZS5sb2coIk1pc3NpbmcgRW50aXR5IERlZmluaXRpb246ICIgKyBzLmZyb20pOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJX2Zyb20gPSBfZnJvbS5vYmo7CgoJCQkJdHJ5IHsKCQkJCQlzLnBhcmFtcyA9IE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhzLnBhcmFtcykubWFwKGV0ID0+IHsKCQkJCQkJaWYgKGV0WzFdICYmIGV0WzFdLm5hbWUpIHsKCQkJCQkJCWxldCBvYmogPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IGV0WzFdLm5hbWUpOwoJCQkJCQkJcmV0dXJuIG9iaiA/IFtldFswXSwgb2JqLm9ial0gOiBldDsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldHVybiBldDsKCQkJCQkJfQoJCQkJCX0pKTsKCgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgX2Zyb21bcy5tZXRob2RdKC4uLk9iamVjdC52YWx1ZXMocy5wYXJhbXMpKTsKCgkJCQkJCXMuX21ldGhvZCA9IHMubWV0aG9kLmluZGV4T2YoJy4nKSA+IDAgPyBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID09IF9mcm9tLkVudGl0eUNsYXNzLklkKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2QpIDogc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMF0pLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzFdKTsKCQkJCQl9IGNhdGNoIChfZXgpIHt9CgoJCQkJCS8vIG5vdCBkZWZpbmVkIHRvIHdoaWNoIGVudGl0eSB0aGlzIGlzIGdvaW5nLCBmaW5kIGZpcnN0IGVudGl0eSBpbiB0aGUgcGFyYW1ldGVycywgb3RoZXJ3aXNlIGl0IGlzIGEgbG9vcCB0byBteXNlbGYKCQkJCQlsZXQgX3RvID0gKE9iamVjdC52YWx1ZXMocy5wYXJhbXMpIHx8IFtdKS5maW5kKHAgPT4gcCAmJiBwLkVudGl0eUNsYXNzKSB8fCBfZnJvbTsKCgkJCQkJY2FsbFNlcXVlbmNlLmVudGl0aWVzID0gY2FsbFNlcXVlbmNlLmVudGl0aWVzLmNvbmNhdChbX2Zyb20sIF90b10pLmZpbHRlcihlID0+IGUpLmZpbHRlcigob2JqLCBwb3MsIGFycikgPT4gewoJCQkJCQlyZXR1cm4gYXJyLm1hcChtYXBPYmogPT4gbWFwT2JqKS5pbmRleE9mKG9iaikgPT09IHBvczsKCQkJCQl9KTsKCgkJCQkJbGV0IHNPYmogPSB7CgkJCQkJCWRhdGU6IG5ldyBEYXRlKCksCgkJCQkJCWZyb206IF9mcm9tLAoJCQkJCQl0bzogX3RvLAoJCQkJCQlhY3RpdmF0ZTogcy5hY3RpdmF0ZSwKCQkJCQkJcGFyYW1zOiBzLnBhcmFtcywKCQkJCQkJbWV0aG9kOiBzLm1ldGhvZCwKCQkJCQkJX2lmOiBzLl9pZiwKCQkJCQl9OwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5wdXNoKHNPYmopOwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5zb3J0KChhLCBiKSA9PiBhLmRhdGUgPCBiLmRhdGUpOwoKCQkJCQlpZiAoX2Zyb20gIT09IF90byAmJiAodHlwZW9mKHMuYWN0aXZhdGUpID09PSAndW5kZWZpbmVkJyB8fCBzLmFjdGl2YXRlKSkgewoJCQkJCQkvLyBpcyB0aGlzIGNhbGwgY2xvc2luZyBhbiBhY3RpdmF0aW9uPyB0aGVuIGRlZmluZSBpdCBhcyBhY3RpdmF0ZWQgaW4gdGhlIGluaXRpYWwgY2FsbAoJCQkJCQlsZXQgaW5pdCA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKHQgPT4gdC5mcm9tID09IHNPYmoudG8gJiYgdC50byA9PSBzT2JqLmZyb20gJiYgdC5kYXRlIDwgc09iai5kYXRlICYmICF0LmFjdGl2YXRpbmcpOwoJCQkJCQlpZiAoaW5pdCkgewoJCQkJCQkJaW5pdC5hY3RpdmF0aW5nID0gc09iajsKCQkJCQkJfQoJCQkJCX0KCQkJCQlhd2FpdCB0aGlzLl93YWl0KHMud2FpdCB8fCBzZXEud2FpdCk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKF9mcm9tLCBzLCBleCk7CgkJCQl9CgkJCX0KCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZvckVhY2goKHQsIGkpID0+IHsKCQkJCXQuZnJvbSA9IHQuZnJvbSB8fCAibnVsbCI7CgkJCQl0LnRvID0gdC50byB8fCAibnVsbCI7CgkJCQl0Ll9wcmV2aW91cyA9IGkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSAtIDFdIDogbnVsbDsKCQkJCXQuX25leHQgPSAoaSA8IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5sZW5ndGggLSAxKSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpICsgMV0gOiBudWxsOwoJCQkJdC5fYWN0aXZhdG9yID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQoX3QgPT4gX3QuYWN0aXZhdGluZyA9PSB0KTsKCQkJfSk7CgoJCQljYWxsU2VxdWVuY2VzLnB1c2goY2FsbFNlcXVlbmNlKTsKCQl9CgoJCXJldHVybiBjYWxsU2VxdWVuY2VzOwoJfQoKCWFzeW5jIF93YWl0KG1zKSB7CgkJYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7Cgl9CgoJX2ZpbGVUeXBlKGJhc2U2NCkgewoJCXZhciBiaW5hcnlfc3RyaW5nID0gdGhpcy5fYXRvYihiYXNlNjQpOwoJCXZhciBsZW4gPSBiaW5hcnlfc3RyaW5nLmxlbmd0aDsKCQl2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheShsZW4pOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJYnl0ZXNbaV0gPSBiaW5hcnlfc3RyaW5nLmNoYXJDb2RlQXQoaSk7CgkJfQoKCQl2YXIgYXJyID0gKG5ldyBVaW50OEFycmF5KGJ5dGVzLmJ1ZmZlcikpLnN1YmFycmF5KDAsIDQpOwoJCXZhciBoZWFkZXIgPSAnJzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewoJCQloZWFkZXIgKz0gYXJyW2ldLnRvU3RyaW5nKDE2KTsKCQl9CgoJCS8vIENoZWNrIHRoZSBmaWxlIHNpZ25hdHVyZSBhZ2FpbnN0IGtub3duIHR5cGVzCgkJdmFyIHR5cGUgPSAndW5rbm93bic7CgkJc3dpdGNoIChoZWFkZXIpIHsKCQkJY2FzZSAnODk1MDRlNDcnOgoJCQkJdHlwZSA9ICdpbWFnZS9wbmcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzQ3NDk0NjM4JzoKCQkJCXR5cGUgPSAnaW1hZ2UvZ2lmJzsKCQkJCWJyZWFrOwoJCQljYXNlICdmZmQ4ZmZlMCc6CgkJCWNhc2UgJ2ZmZDhmZmUxJzoKCQkJY2FzZSAnZmZkOGZmZTInOgoJCQkJdHlwZSA9ICdpbWFnZS9qcGVnJzsKCQkJCWJyZWFrOwoJCQljYXNlICcyNTUwNDQ0Nic6CgkJCQl0eXBlID0gJ2FwcGxpY2F0aW9uL3BkZic7CgkJCQlicmVhazsKCQkJY2FzZSAnM2M3Mzc2NjcnOgoJCQkJdHlwZSA9ICdpbWFnZS9zdmcreG1sJzsKCQkJCWJyZWFrOwoJCX0KCQlyZXR1cm4gdHlwZTsKCX0KCglpbWcoZEltZywgbWltZVR5cGUpIHsKCQlyZXR1cm4gYGRhdGE6JHttaW1lVHlwZSB8fCB0aGlzLl9maWxlVHlwZShkSW1nKX07YmFzZTY0LGAgKyBkSW1nOwoJfQoKCV9mdWxsU2NyZWVuKGVsZW0pIHsKCQl0cnkgewoJCQlpZiAoZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIFNhZmFyaSAqLwoJCQkJZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogSUUxMSAqLwoJCQkJZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJfQoKCV9jb3B5VGV4dFRvQ2xpcGJvYXJkKHRleHQpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuY29weSkgPT09ICdmdW5jdGlvbicpIHsKCQkJd2luZG93LmNvcHkodGV4dCk7CgkJfSBlbHNlIGlmICghbmF2aWdhdG9yLmNsaXBib2FyZCkgewoJCQl2YXIgdGV4dEFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZXh0YXJlYSIpOwoJCQl0ZXh0QXJlYS52YWx1ZSA9IHRleHQ7CgoJCQkvLyBBdm9pZCBzY3JvbGxpbmcgdG8gYm90dG9tCgkJCXRleHRBcmVhLnN0eWxlLnRvcCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUubGVmdCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUucG9zaXRpb24gPSAiZml4ZWQiOwoKCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0QXJlYSk7CgkJCS8vdGV4dEFyZWEuZm9jdXMoKTsKCQkJdGV4dEFyZWEuc2VsZWN0KCk7CgoJCQl0cnkgewoJCQkJdmFyIHN1Y2Nlc3NmdWwgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwoJCQkJdmFyIG1zZyA9IHN1Y2Nlc3NmdWwgPyAnc3VjY2Vzc2Z1bCcgOiAndW5zdWNjZXNzZnVsJzsKCQkJCWNvbnNvbGUubG9nKCdGYWxsYmFjazogQ29weWluZyB0ZXh0IGNvbW1hbmQgd2FzICcgKyBtc2cpOwoJCQl9IGNhdGNoIChlcnIpIHsKCQkJCWNvbnNvbGUuZXJyb3IoJ0ZhbGxiYWNrOiBPb3BzLCB1bmFibGUgdG8gY29weScsIGVycik7CgkJCX0KCgkJCWRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dEFyZWEpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQluYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KS50aGVuKGZ1bmN0aW9uKCkgewoJCQkJCWNvbnNvbGUubG9nKCdBc3luYzogQ29weWluZyB0byBjbGlwYm9hcmQgd2FzIHN1Y2Nlc3NmdWwhJyk7CgkJCQkJcmVzb2x2ZSgpOwoJCQkJfSwgZnVuY3Rpb24oZXJyKSB7CgkJCQkJY29uc29sZS5lcnJvcignQXN5bmM6IENvdWxkIG5vdCBjb3B5IHRleHQ6ICcsIGVycik7CgkJCQkJcmVqZWN0KGVycik7CgkJCQl9KTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGV4dDsKCX0KCglhc3luYyBfcmVzaXplSW1nKGltZ0Jhc2U2NCwgd2lkdGgsIGhlaWdodCwgbWltZVR5cGUsIHRvX21pbWVUeXBlKSB7CgkJaWYgKGltZ0Jhc2U2NC5zcGxpdCgnLCcpLmxlbmd0aCA+IDEpIHsKCQkJaW1nQmFzZTY0ID0gaW1nQmFzZTY0LnNwbGl0KCcsJylbMV07CgkJfQoJCXZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKCQlpbWcuc3JjID0gdGhpcy5pbWcoaW1nQmFzZTY0LCBtaW1lVHlwZSk7CgoJCS8vIGNyZWF0ZSBhbiBvZmYtc2NyZWVuIGNhbnZhcwoJCXZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKCQkJY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CgoJCS8vIHNldCBpdHMgZGltZW5zaW9uIHRvIHRhcmdldCBzaXplCgkJY2FudmFzLndpZHRoID0gd2lkdGggfHwgaW1nLndpZHRoOwoJCWNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgfHwgaW1nLmhlaWdodDsKCgkJLy8gZHJhdyBzb3VyY2UgaW1hZ2UgaW50byB0aGUgb2ZmLXNjcmVlbiBjYW52YXM6CgkJY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKCQkvLyBlbmNvZGUgaW1hZ2UgdG8gZGF0YS11cmkgd2l0aCBiYXNlNjQgdmVyc2lvbiBvZiBjb21wcmVzc2VkIGltYWdlCgkJcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwodG9fbWltZVR5cGUgfHwgbWltZVR5cGUsIDEpOwoJfQoKCWFzeW5jIF90ZW1wbGF0ZSh0bXAsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKSB7CgkJc2NvcGUgPSBzY29wZSB8fCBjb21wYW55LlNjb3BlOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lIHx8IHRtcC50ZW1wbGF0ZSB8fCB0bXAsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogJz0nCgkJCX0KCQl9KSk7CgkJaWYgKCF0ZW1wbGF0ZSkgcmV0dXJuIG51bGw7CgoJCWxldCBzY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0ZW1wbGF0ZS5TY3JpcHQpOwoJCWxldCBvYmogPSBuZXcgc2NyaXB0KHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYyk7CgoJCXRyeSB7CgkJCW9iai5tYWluICYmIGF3YWl0IG9iai5tYWluKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLm1haW4oKSIsIGV4KTsKCQl9CgoJCXRyeSB7CgkJCW9iai5wcmVJbmplY3QgJiYgYXdhaXQgb2JqLnByZUluamVjdCgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wcmVJbmplY3QoKSIsIGV4KTsKCQl9CgoJCWxldCByZXQgPSB7CgkJCVNjcmlwdDogb2JqLAoJCX07CgoJCWxldCB0Q2FjaGUgPSB7fTsKCQlmb3IgYXdhaXQgKGNvbnN0IGYgb2YgWydCb2R5JywgJ0Zvb3RlcicsICdUaXRsZSddKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKHRlbXBsYXRlW2ZdLm1hdGNoQWxsKC8oXFtcWyU9KS5bXHdcLS5dK1tcLl0odG1wKVtcOlw6XT9bXiglXF1cXSldKltcOlw6XT9bXiglXF1cXSldKiglXF1cXSkvZ20pKV0pIHsKCQkJCWxldCB0TmFtZVBhcnRzID0gbVswXS5yZXBsYWNlKCdbWyU9JywgJycpLnJlcGxhY2UoJyVdXScsICcnKS5yZXBsYWNlKCcudG1wJywgJycpLnNwbGl0KCc6OicpOwoJCQkJbGV0IHROYW1lID0gdE5hbWVQYXJ0c1swXTsKCQkJCWxldCB0RGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwge30pOwoJCQkJaWYgKHROYW1lUGFydHMubGVuZ3RoID4gMSkgewoJCQkJCXREYXRhID0gT2JqZWN0LmFzc2lnbih0RGF0YSwgYXdhaXQgdGhpcy5ydW5TY3JpcHQodE5hbWVQYXJ0c1sxXSkpOwoJCQkJfQoJCQkJbGV0IHQgPSBhd2FpdCB0aGlzLl90ZW1wbGF0ZSh0TmFtZSwgc2NvcGUsIHREYXRhLCBwcnZGdW5jKTsKCQkJCXRDYWNoZVt0TmFtZV0gPSB0Q2FjaGVbdE5hbWVdIHx8IHRbZl07CgkJCQl0ZW1wbGF0ZVtmXSA9IHRlbXBsYXRlW2ZdLnJlcGxhY2UobVswXSwgdENhY2hlW3ROYW1lXSk7CgkJCX0KCgkJCXJldFtmXSA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZVtmXSwgb2JqKTsKCQl9CgkJY29uc29sZS5sb2codENhY2hlKTsKCgkJdHJ5IHsKCQkJb2JqLnBvc3RJbmplY3QgJiYgYXdhaXQgb2JqLnBvc3RJbmplY3QocmV0KTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucG9zdEluamVjdCgpIiwgZXgpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglUZW1wbGF0ZSA9IGNsYXNzIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKCQkJdGhpcy5zY29wZSA9IHNjb3BlOwoJCQl0aGlzLm9TY29wZSA9IHdpbmRvd1tzY29wZV07CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbbk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCXRoaXMucHJ2RnVuYygkKGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJScgc3JjPScke19GckVNRC5fc3ZnQmFzZTY0KHJldC5Cb2R5KX0nLz5gKSk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSA8PCA0KSB8IChiMiA+PiA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgPDwgMikgfCAoYjMgPj4gNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfQoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIGJBc3luYykgewoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIG1vZHVsZSkgewoJCQkJYXdhaXQgdGhpcy5pbXBvcnQobSwgYkFzeW5jKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkge30KCQl2YXIganMgPSBudWxsOwoJCXRyeSB7CgkJCWpzID0gKGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogbW9kdWxlCgkJCX0pKSB8fCAoYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBtb2R1bGUgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJaWYgKCFqcykgewoJCQlqcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBtb2R1bGUuaW5kZXhPZignLycpID49IDAgPyBtb2R1bGUgOiAoQ01TX1JPT1QgKyBtb2R1bGUpCgkJCX0pOwoJCQlpZiAoanMpIGpzID0ganMuU2NyaXB0OwoJCX0KCQlpZiAoIWpzKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMsIGJBc3luYyk7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQlpZiAobG9hZGVyKSB7CgkJCQkvLyBjb25zb2xlLmxvZygibG9hZGVyKClbIiArIG4ubGliICsgIl06ICIsIHR5cGVvZihuLmxvYWQpKTsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZihuLnNyYykgPT09ICd1bmRlZmluZWQnICYmIG4uc2NyaXB0ICYmICFtb2R1bGVzLmxlbmd0aCkgewoJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgJ106JywgbikKCQkJCW1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQobi5zY3JpcHQsIG4ubm9SdW4pKTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIChBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkuZmlsdGVyKHMgPT4gcykpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChzKTsKCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCB0aGlzLmltcG9ydChzKSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YocykgPT09ICdzdHJpbmcnKSB7CgkJCQkJCWxldCBqc0V4dCA9ICEoWydqc3QnXS5zb21lKGUgPT4gcy5lbmRzV2l0aCgnLicgKyBlKSkpOwoJCQkJCQlpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCS8vIGEgd2ViLXdvcmtlcgoJCQkJCQkJaW1wb3J0U2NyaXB0cyhzKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJiBqc0V4dCkgewoJCQkJCQkJLy8gZG9jdW1lbnQgc2hvdWxkIGxvYWQgdGhlIHNjcmlwdCB3aGVuZXZlciBwb3NzaWJsZQoJCQkJCQkJLypyZXR1cm4gKi8KCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJCQkJCXNjcmlwdC5hc3luYyA9IGZhbHNlOwoJCQkJCQkJCXNjcmlwdC5zcmMgPSBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKTsKCQkJCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiAiICsgcyk7CgkJCQkJCQkJKGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuYm9keSkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJCQkJCX0pKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2hJbmplY3QpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlhd2FpdCBmZXRjaEluamVjdChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJbGV0IHJlcyA9IGF3YWl0IGZldGNoKG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJCWlmIChyZXMub2spIHsKCQkJCQkJCQlpZiAoanNFeHQgfHwgbi5sb2FkKSBtb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoYXdhaXQgcmVzLnRleHQoKSkpOwoJCQkJCQkJCWlmICghanNFeHQgJiYgIW4ubG9hZCkgcmV0ID0gYXdhaXQgcmVzLnRleHQoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXRoaXMuYmxvY2tzW2Jsb2NrXSA9IHsKCQkJaHRtbDogIiIsCgkJCW9iajogbnVsbCwKCQl9CgkJdHJ5IHsKCQkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykucGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArIGJsb2NrLmluZGV4T2YoJy8nKSA+PSAwID8gYmxvY2sgOiAodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAnL2Jsb2NrcycgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrKSkuZmluZCgpOwoJCQkJaWYgKHApIHsKCQkJCQlodG1sID0gcC5ib2R5KCkgPyBwLl9hdG9iKHAuYm9keSgpKSA6IG51bGw7CgkJCQkJanMgPSBwLnNjcmlwdCgpID8gcC5fYXRvYihwLnNjcmlwdCgpKSA6IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICghanMpIGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIikgfHwgYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pOwoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgkJdHJ5IHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sIHx8IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJDb21wYW55Iik7CgkJaWYgKGZhbHNlICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29tcGFueS5TY29wZSA9IGNvbXBhbnkuU2NvcGUgfHwgIndpbmRvdyI7CgkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZSArICI6IGxvYWRpbmcuLi4iOwoJCX0KCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTZXJ2aWNlUm91dGVyIik7CgkJdGhpcy5faW5pdFNlcnZpY2VSb3V0ZXIoKTsKCgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKSBhd2FpdCBjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCQl9CgkJfQoKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcygpOwoJCWF3YWl0IHRoaXMuX2luaXRDb250ZW50TWFuYWdlcigpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQlsZXQgb1Njb3BlID0gdGhpcy5zcigpLl9fc2NvcGUodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKTsgLy93aW5kb3dbY29tcGFueS5TY29wZV07CgkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQoKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQlsZXQgbWMgPSAob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLmZpbmQoYyA9PiBjLklzTWFpbik7CgkJaWYgKG1jKSB7CgkJCXRoaXMuYXBpU2VydmVyID0gYXdhaXQgbmV3IG9TY29wZVttYy5OYW1lXSgpLl9zZXJ2ZXIoewoJCQkJbG9hZFRvb2xzOiB0cnVlLAoJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQlpbml0Tm9kZTogdHJ1ZQoJCQl9KTsKCQl9CgkJY29uc29sZS5sb2coIkRvbmUgTG9hZGluZyIpOwoJfQoKCWFzeW5jIF9tYW5pZmVzdChzY29wZSwganNvbikgewoJCXRyeSB7CgkJCWlmICghanNvbikgewoJCQkJanNvbiA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7CgkJCQkJdGVtcGxhdGU6ICJNQU5JRkVTVCIKCQkJCX0sIHNjb3BlKTsKCQkJfQoJCQlsZXQgaHJlZiA9IHRoaXMudG9CYXNlNjQobnVsbCwganNvbiwgJ2FwcGxpY2F0aW9uL21hbmlmZXN0K2pzb24nLCB0cnVlKTsKCQkJaWYgKHRoaXMuX21hbkNzcykgewoJCQkJdGhpcy5fbWFuQ3NzLmF0dHIoImhyZWYiLCBocmVmKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX21hbkNzcyA9IHRoaXMuX2NzcyhocmVmLCAnbWFuaWZlc3QnKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gbG9hZGluZyBtYW5pZmVzdCIsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2V4cG9ydCh0bXAsIHNjb3BlLCBvcHRpb25zID0ge30pIHsKCQlzY29wZSA9IHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5jb250ZW50IHx8IGF3YWl0IGZldGNoKGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9P3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCWxldCByZXQgPSB0aGlzLl9pbmplY3QodGVtcGxhdGUsIHsKCQkJb1Njb3BlOiB3aW5kb3dbc2NvcGVdLAoJCQltZTogd2luZG93Lm1lLAoJCQlzY29wZSwKCQkJb3B0aW9ucywKCQl9LCBvcHRpb25zLmVuZ2luZSk7CgoJCWlmICh0aGlzLl9iZWF1dGlmeSkgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCB0bXAubGFuZ3VhZ2UpOwoJCWlmICghdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCAkLmdldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCXNjb3BlID0gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCkgfHwgIndpbmRvdyI7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgbGNzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0dlbmVyYXRlTGF5ZXJDbGFzcyIsIG51bGwsIGVjLmxpYnJhcnkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKGMuTGF5ZXJBdHRyaWJ1dGVzLCAoXywgbGEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogbGEuTmFtZSwKCQkJCVBsdXJhbDogbGEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IGxhLAoJCQkJSXNCb29sOiBsYS5OYXRpdmVUeXBlID09ICJib29sIiwKCQkJCUlzU3RyaW5nOiBsYS5OYXRpdmVUeXBlID09ICJzdHJpbmciLAoJCQkJSXNUZXh0OiBsYS5OYXRpdmVUeXBlID09ICJ0ZXh0IiwKCQkJCUlzTG9uZzogbGEuTmF0aXZlVHlwZSA9PSAibG9uZyIsCgkJCQlJc0Zsb2F0OiBsYS5OYXRpdmVUeXBlID09ICJmbG9hdCIsCgkJCQlJc0ludDogbGEuTmF0aXZlVHlwZSA9PSAiaW50ZWdlciIsCgkJCQlJc0RvdWJsZTogbGEuTmF0aXZlVHlwZSA9PSAiZG91YmxlIiwKCQkJCUlzRGF0ZTogbGEuTmF0aXZlVHlwZSA9PSAiZGF0ZXRpbWUiLAoJCQkJSXNGaWxlOiBsYS5OYXRpdmVUeXBlID09ICJmaWxlIiwKCQkJCUlzSW1hZ2U6IGxhLk5hdGl2ZVR5cGUgPT0gImltYWdlIiwKCQkJCUlzT2JqZWN0OiBsYS5OYXRpdmVUeXBlID09ICJvYmplY3QiLAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKCQuZ3JlcChjLlJlbGF0aW9uQXR0cmlidXRlcywgcmEgPT4gIXJhLklzQXJyYXkpLCAoXywgcmEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogcmEuTmFtZSwKCQkJCVBsdXJhbDogcmEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IHJhLAoJCQkJSXNCb29sOiBmYWxzZSwKCQkJCUlzU3RyaW5nOiBmYWxzZSwKCQkJCUlzVGV4dDogZmFsc2UsCgkJCQlJc0xvbmc6IGZhbHNlLAoJCQkJSXNGbG9hdDogZmFsc2UsCgkJCQlJc0ludDogZmFsc2UsCgkJCQlJc0RvdWJsZTogZmFsc2UsCgkJCQlJc0RhdGU6IGZhbHNlLAoJCQkJSXNGaWxlOiBmYWxzZSwKCQkJCUlzSW1hZ2U6IGZhbHNlLAoJCQkJRW50aXR5VHlwZTogewoJCQkJCUlkOiBzci5oYXNoQ29kZShyYS5SZWxhdGlvbkNsYXNzLk5hbWUpLAoJCQkJCU5hbWU6IHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSwKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJfSBlbHNlIGlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJdHJ5IHsKCQkJCWVjID0gYXdhaXQgdGhpcy5yZXF1aXJlKCdTY2hlbWEnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IGNvbXBhbnkuQ29kZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQl9CgoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmIChzY29wZSAhPT0gIndpbmRvdyIpIHsKCQkJaWYgKHR5cGVvZih3aW5kb3dbc2NvcGVdKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCS8vIGNsZWFudXAgdGhlIG9sZCBzY29wZQoJCQkJZGVsZXRlIHdpbmRvd1tzY29wZV07CgkJCX0KCQkJd2luZG93W3Njb3BlXSA9IHt9OwoJCX0KCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5FbnRpdHlDbGFzc2VzID0gcmV0OwoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0ID0gKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQgfHwge307CgkJaWYgKHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0LkRhdGUgPSB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUF0dHJpYnV0ZXMgPSBlYXM7CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpIHsKCQlpZiAoIW0pIHJldHVybjsKCQlsZXQgbU5hbWUgPSBtLkVudGl0eU1vZHVsZSA/IG0uRW50aXR5TW9kdWxlLk5hbWUgOiBtLk5hbWU7CgkJKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgPSAobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyB8fCAwOwoJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBMb2FkaW5nICIgKyBtTmFtZSk7CgoJCWxldCBlYXMgPSBbXTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJRW50aXR5Q2xhc3M6IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6IG1OYW1lCgkJCQl9CgkJCX0KCQl9KTsKCgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLnNyKCkuX19zY29wZShzY29wZSk7CgoJCW9TY29wZS5uTmFtZSA9IG9TY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJb1Njb3BlLm5Db2RlID0gb1Njb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSBodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJykpKTsKCgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICIiOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQljOiBjLAoJCQkJc2NvcGU6IHNjb3BlLAoJCQkJbk5hbWU6IG9TY29wZS5uTmFtZSwKCQkJCW5Db2RlOiBvU2NvcGUubkNvZGUsCgkJCX0pICsgJ1xuJyArIG9TY29wZS5uTmFtZShjKTsKCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgKz0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7b1Njb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke29TY29wZS5uTmFtZShjKX0gPSAke29TY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSBvU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbb1Njb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCX0KCgkJcmV0dXJuIF9jb2RlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXMgfHwge307CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfY2xvbmVGdW5jdGlvbihvLCBmLCBzY29wZSwgYykgewoJCWxldCBjb2RlID0gd2luZG93W29dW2ZdID8gd2luZG93W29dW2ZdLnRvU3RyaW5nKCkgOiBgICAgJHtmfSgpewoJCSAgICBjb25zb2xlLmxvZygnRXJyb3IgaW4gX0ZyRU1ELl9jbG9uZUZ1bmN0aW9uKCR7b30sICR7Zn0pOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUnKTsKCSAgICB9YDsKCQlsZXQgcyA9IGNvZGUucmVwbGFjZSgnKScsICcpID0+ICcpOwoJCWlmIChzLmluZGV4T2YoJ2Z1bmN0aW9uJykgPT0gMCB8fCBzLmluZGV4T2YoJ2FzeW5jIGZ1bmN0aW9uJykgPT0gMCkgewoJCQlzID0gcy5yZXBsYWNlKCdmdW5jdGlvbicsICcgJyk7CgkJfSBlbHNlIHsKCQkJcyA9IHMucmVwbGFjZShmLCAnJyk7CgkJfQoKCQlpZiAoYy5Jc01haW4gJiYgIXdpbmRvd1tvXVtmXSkgewoJCQljb25zb2xlLmxvZygnRXJyb3IgaW4gX0ZyRU1ELl9jbG9uZUZ1bmN0aW9uKCk6IEludmFsaWQgRnVuY3Rpb24gTmFtZSAnICsgZik7CgkJfQoKCQlyZXR1cm4gYAogICAgJHtmfSguLi5wYXJhbXMpewogICAgICAgIGlmKHR5cGVvZih3aW5kb3cpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy4ke299KSE9PSJ1bmRlZmluZWQiKXsKICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy4ke299LiR7Zn0oLi4ucGFyYW1zKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgYCArIChjLklzTWFpbiA/IGByZXR1cm4gKCR7c30pKC4uLnBhcmFtcyk7YCA6IGByZXR1cm4gbmV3ICR7c2NvcGV9LiR7d2luZG93W3Njb3BlXS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKX0oKS4ke2Z9KC4uLnBhcmFtcyk7YCkgKyBgCiAgICAgICAgfQoJfQpgOwoJfQoKCV9pbml0U2VydmljZVJvdXRlcigpIHsKCQlpZiAodHlwZW9mKFNlcnZpY2VSb3V0ZXIpID09PSAndW5kZWZpbmVkJykgewoJCQljb25zb2xlLmxvZygiRnJFTUQuX2luaXRTZXJ2aWNlUm91dGVyKCk6IFNlcnZpY2VSb3V0ZXIgbm90IGRlZmluZWQuIik7CgkJCXJldHVybjsKCQl9CgkJd2luZG93LnNyID0gd2luZG93LnNyIHx8IG5ldyBTZXJ2aWNlUm91dGVyKCk7CgoJCXRoaXMuc3IoKS5TdG9yZSA9IHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlN0b3JlIDogdW5kZWZpbmVkOwoJCXRoaXMuc3IoKS5pbml0KG51bGwsICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5saWJyYXJ5IDogdW5kZWZpbmVkKSB8fCAiRW50ZXJwcmlzZU1hbmFnZXIiLCB0cnVlLCB0aGlzLmJEZWJ1Zyk7CgkJaWYgKHR5cGVvZiBzclVSTCAhPT0gJ3VuZGVmaW5lZCcpIHRoaXMuc3IoKS5zclVSTCA9IHNyVVJMOwoJCXRoaXMuc3IoKS5mTG9hZGluZ1N0YXJ0ID0gKCkgPT4gewoJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmxvYWRpbmcoJ3Nob3cnKTsKCQl9OwoJCXRoaXMuc3IoKS5mTG9hZGluZ0VuZCA9ICgpID0+IHsKCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5sb2FkaW5nKCdoaWRlJyk7CgkJfTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCXJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDApIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiAnTG9hZGluZycsCgkJCQkJbXNnOiAnTG9hZGluZyBkYXRhLi4uJywKCQkJCQlpbnRlcnZhbDogaW50ZXJ2YWwsCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHJldHVybiBmYWxzZTsKCX0KCglhc3luYyByZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCkgewoJCWlmICghZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQpIHRoaXMuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyBvRWxlbWVudC5pbnRlcnZhbCA6IG51bGwpOwoJCXRyeSB7CgkJCWxldCB2ID0gYXdhaXQgbG9hZGVyKGZEYXRhLCBvRWxlbWVudCwgZWRpdG9yKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJbGV0IGRpZmYgPSAwOwoJCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgJiYgZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQuZ2V0VGltZSgpIC0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmID4gMCAmJiBkaWZmIDwgMTAwKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiTm90IGNoYW5nZWQgb24gdGhlIHNlcnZlciIpOwoJCQl9IGVsc2UgewoJCQkJLy8gY29uc29sZS5sb2coIlNlcnZlciBjaGFuZ2UsIHNldHRpbmcgdmFsdWUiLCBkaWZmKTsKCQkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkOwoJCQkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodik7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIExvYWQgZmlsZS5cbiIgKyBleCk7CgkJfQoJCXRoaXMuX2xvYWRpbmcoZmFsc2UpOwoKCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSB7CgkJCS8vYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDAuNSAqIDYwICogMTAwMCkpOwoJCQlhd2FpdCB0aGlzLl93YWl0KDAuNSAqIDYwICogMTAwMCk7CgkJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoJCX0KCX0KCglhc3luYyBPcGVuRWRpdG9yKGUsIGxhbmd1YWdlID0gbyA9PiAiaHRtbCIsIGxvYWRlciA9IG8gPT4ge30sIHNhdmVyID0gKHYsIG8pID0+IHt9LCBmRGF0YSwgb0VsZW1lbnQpIHsKCQl2YXIgZWRpdG9yID0gYWNlLmVkaXQoZSk7CgkJZGVsZXRlIGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTsKCQkvL2FjZS5jb25maWcuc2V0KCdiYXNlUGF0aCcsICcvbm9kZV9tb2R1bGVzL2FjZS1idWlsZHMvc3JjLW1pbi1ub2NvbmZsaWN0Jyk7CgkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUoJycpOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS8nICsgbGFuZ3VhZ2UoZkRhdGEpKTsKCQllZGl0b3Iub24oImNoYW5nZSIsIGUgPT4gewoJCQlsZXQgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQuZ2V0VGltZSgpIC0gc3Iuc2VydmVyRGF0ZSgpLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmIDwgMTAwICYmIGUuc3RhcnQucm93ID09IDAgJiYgZS5zdGFydC5jb2x1bW4gPT0gMCkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGNvbnNvbGUubG9nKCJDaGFuZ2VkIEV2ZW50IiwgZGlmZik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCX0pOwoJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoKCQlpZiAoc2F2ZXIpIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHsKCQkJbmFtZTogJ3NhdmUnLAoJCQliaW5kS2V5OiB7CgkJCQl3aW46ICJDdHJsLVMiLAoJCQkJbWFjOiAiQ21kLVMiCgkJCX0sCgkJCWV4ZWM6IGFzeW5jIGVkaXRvciA9PiB7CgkJCQl2YXIgdmFsdWUgPSB0aGlzLl9iZWF1dGlmeShlZGl0b3IuZ2V0VmFsdWUoKSwgbGFuZ3VhZ2UoZkRhdGEpKTsKCQkJCWlmICh2YWx1ZSAhPSBlZGl0b3Iuc2Vzc2lvbi5nZXRWYWx1ZSgpKSBlZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2YWx1ZSk7CgkJCQlpZiAoc2F2ZXIpIHsKCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQkJCXRpdGxlOiAnUGxlYXNlIHdhaXRpbmcnLAoJCQkJCQkJbXNnOiAnU2F2aW5nIGRhdGEuLi4nLAoJCQkJCQkJaW50ZXJ2YWw6IG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KTsKCX0KCglfYmVhdXRpZnkodmFsdWUsIHR5cGUpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzX2JlYXV0aWZ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBvcHRpb25zID0gewoJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJImU0eCI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoJCQkJdmFsdWUgPSB0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwoJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnLCAnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCXZhbHVlID0ganNfYmVhdXRpZnkodmFsdWUsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHt9CgkJcmV0dXJuIHZhbHVlOwoJfQoKCV9sYW5nKGNvZGUpIHsKCQl3aW5kb3cubGFuZyA9IGNvZGU7CgkJdGhpcy5zZXRVUkwoInBhZ2U9IiArICh0aGlzLmFsbERhdGEucGFnZS5fY29kZSB8fCAnaW5kZXgnKSk7Cgl9CgoJc2VsZWN0MlNSKG9TZWxlY3QpIHsKCQlsZXQgcyA9ICQob1NlbGVjdCk7CgkJbGV0IGNhbGxzID0gW107CgkJaWYgKHRoaXMuc2VsZWN0MlRlbXBsYXRlKSB7CgkJCWNhbGxzLnB1c2godGhpcy5zZWxlY3QyVGVtcGxhdGUpOwoJCX0gZWxzZSB7CgkJCWNhbGxzLnB1c2godGhpcy5zcigpLkdldCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvc2VsZWN0Mi10ZW1wbGF0ZS5odG0iKSkpOwoJCX0KCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQl0aGlzLnNlbGVjdDJUZW1wbGF0ZSA9IHJldFswXTsKCQkJcy5zZWxlY3QyKHsKCQkJCWFqYXg6IHsKCQkJCQl0cmFuc3BvcnQ6IChwYXJhbXMsIHN1Y2Nlc3MsIGZhaWx1cmUpID0+IHsKCQkJCQkJdmFyIGZGaWx0ZXIgPSB0aGlzLnNyKCkucnVuU2NyaXB0KCIobywgc3RhdGUpID0+IHsiICsgcy5kYXRhKCJzcl9maWx0ZXIiKSArICJ9Iik7CgkJCQkJCSQud2hlbih0aGlzLnNyKCkuXyhzLmRhdGEoInNyX21ldGhvZCIpLCBudWxsLCBmRmlsdGVyKHt9LCB0aGlzLnNyKCkucnVuU2NyaXB0KHMuZGF0YSgiY19zdGF0ZSIpKSkpKS50aGVuKHJldCA9PiB7CgkJCQkJCQlzdWNjZXNzKHsKCQkJCQkJCQlwYWdpbmF0aW9uOiB7CgkJCQkJCQkJCW1vcmU6IGZhbHNlCgkJCQkJCQkJfSwKCQkJCQkJCQlyZXN1bHRzOiAkLm1hcChyZXQsIHIgPT4gewoJCQkJCQkJCQlyLmlkID0gci5JZDsKCQkJCQkJCQkJci50ZXh0ID0gci5Ub1N0cmluZzsKCQkJCQkJCQkJcmV0dXJuIHI7CgkJCQkJCQkJfSksCgkJCQkJCQkJdG90YWxzOiByZXQubGVuZ3RoCgkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSwKCQkJCXRlbXBsYXRlUmVzdWx0OiAoX2UsIF9zKSA9PiB7CgkJCQkJcmV0dXJuIHRoaXMuX2luamVjdCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSwgewoJCQkJCQlkYXRhOiBfZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQkJcy5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCQljb25zb2xlLmxvZyhlLnRhcmdldCk7CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2Uuc2VsZWN0MiIsIGUgPT4gewoJCQkJLy92YXIgZGF0YSA9IGUucGFyYW1zLmRhdGE7CgkJCQl2YXIgX3MgPSAkKGUudGFyZ2V0KTsKCQkJfSk7CgkJfSk7Cgl9CgoJYXN5bmMgcHJlQ29tcGlsZShwYWdlLCBsb2NhdGlvbikgewoJCWlmICh0eXBlb2YgQmFiZWwgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mIFJlYWN0ICE9PSAidW5kZWZpbmVkIikgewoJCQlsZXQganN4ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWpzeCA9IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGpzeCA9PT0gbnVsbCB8fCBqc3ggPT09ICIiKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQl2YXIgcmVzID0gbnVsbDsKCQkJdHJ5IHsKCQkJCXJlcyA9IGF3YWl0IEJhYmVsLnRyYW5zZm9ybShqc3gsIHsKCQkJCQlwcmVzZXRzOiBbJ2xhdGVzdCcsICJyZWFjdCJdCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJCYWJlbCIsIGV4KTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXJldHVybiByZXMuY29kZTsKCQl9Cgl9CgoJYXN5bmMgX3Z1ZUNvbXBvbmVudChjb2RlKSB7CgkJaWYgKHR5cGVvZiBWdWUgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IHAuc2NyaXB0KCkgPyBwLl9hdG9iKHAuc2NyaXB0KCkpIDogJycsCgkJCQlCb2R5OiBwLmJvZHkoKSA/IHAuX2F0b2IocC5ib2R5KCkpIDogJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0KSByZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKENNU19ST09UKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKS5fKSByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBudWxsOwoJCQl0cnkgewoJCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuaHRtIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSB0cnkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKCFqcyB8fCAhanMub2spIGpzID0gbnVsbDsKCQkJaWYgKGpzICYmIGpzLm9rKSBwYWdlLlNjcmlwdCA9IGF3YWl0IGpzLnRleHQoKTsKCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBzY3JpcHQgaXMiICsgKGpzID8gJycgOiAnIG5vdCcpICsgIiByZXRyaWV2ZWQiKTsKCQkJdGhpcy5zdGVwKCk7CgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgkJcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJLy9jb25zb2xlLmxvZygicGFnZSBCb2R5IiwgcGFnZS5fYm9keSB8fCBwYWdlLkJvZHkpOwoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJdHJ5IHsKCQkJCWxldCBvYmogPSBuZXcgcGFnZS5TY3JpcHQocGFnZSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSB0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCArICh0aGlzLmJsb2Nrcy5jb250ZW50Lmh0bWwgfHwgX3BhZ2UuQm9keSB8fCBfcGFnZS5fYm9keSkgKyB0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbDsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGpzLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkJLy8gYSBjbGFzcyBkZWZpbml0aW9uLCBkbyBub3QgZW5jbG9zZSBpdCBpbiBhIGZ1bmN0aW9uCgkJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KGpzKTsKCQkJfSBlbHNlIHsKCQkJCWxldCBzQ29kZSA9IGpzOwoJCQkJaWYgKHNDb2RlLmluZGV4T2YoJ3JldHVybiAnKSAhPSAwKSB7CgkJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJCX0KCQkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoIihhc3luYyAoKSA9PiB7IiArIHNDb2RlICsgIlxufSkoKTsiKTsKCQkJfQoJCX0gZWxzZSBpZiAoZmFsc2UgJiYgdHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IHJldCA9IGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCXNjcmlwdC5hc3luYyA9IGJBc3luYzsKCQkJCXNjcmlwdC5zcmMgPSBgZGF0YTp0ZXh0L2phdmFzY3JpcHQ7YmFzZTY0LCR7dGhpcy5fYnRvYShqcyl9YDsKCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCX0pOwoJCQljb25zb2xlLmxvZyhyZXQsIGpzLnN1YnN0cmluZygwLCAyMCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXRyeSB7CgkJCQlyZXR1cm4gSlNPTi5wYXJzZShqcyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlyZXR1cm4gZXZhbChqcyk7CgkJCX0KCQl9Cgl9Cn07",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
{
	"Id": "3d74f76fc12676af8ea3910fbc591dacd339faa4",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSA8PCA0KSB8IChiMiA+PiA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgPDwgMikgfCAoYjMgPj4gNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfTsKCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIF9ocmVmcy5maWx0ZXIobCA9PiBsLmxpYiA9PT0gbGliTmFtZSAmJiB0aGlzLl9pbmNsdWRlKGwpKSkgewoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0KCgkJCWlmICh0eXBlb2Yobi5zcmMpID09PSAndW5kZWZpbmVkJyAmJiBuLnNjcmlwdCAmJiAhbW9kdWxlcy5sZW5ndGgpIHsKCQkJCWlmICh0eXBlb2Yobi5zY3JpcHQpID09PSAnZnVuY3Rpb24nKSBuLnNjcmlwdCA9IG4uc2NyaXB0KCk7CgkJCQltb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KG4uc2NyaXB0LCBuLm5vUnVuKSk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IGF3YWl0IHJlcy50ZXh0KCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJzsKCQkJCQlqcyA9IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCFqcykganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IGJsb2NrCgkJCX0sICJibG9ja3MiKTsKCgkJCWlmICghanMgJiYgd2luZG93LmJMb2NhbCkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5qcyIpKTsKCQkJCWpzID0ganMub2sgPyAoYXdhaXQganMudGV4dCgpKSA6IG51bGw7CgkJCX0KCgkJCWlmIChqcykgewoJCQkJanMgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcyk7CgkJCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJaWYgKCFodG1sICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQkJaHRtbCA9IGh0bWwub2sgPyAoYXdhaXQgaHRtbC50ZXh0KCkpIDogJyc7CgkJfQoJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbDsKCgkJaWYgKGpzICYmICF0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbYmxvY2sgKyAiQ29tcG9uZW50Il0pIHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSAiPCIgKyBibG9jayArICJDb21wb25lbnQvPiI7CgkJfQoJCXRoaXMuc3RlcCgpOwoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCIuLi8uLi8iICsgKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgZmV0Y2godXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQkvL3Njb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoIiArIHNjb3BlICsgIik6IGZhaWxlZCB0byBsb2FkIGNsYXNzZXMuLi4iKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcyk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJkYXRlIiwKCQkJCQkJSXNEYXRlOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiAnbmV3IERhdGUoKScsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJfV07CgkJCQkJYXR0TGlzdC5mb3JFYWNoKGEgPT4gcHJvcExpc3QuZmlsdGVyKHAgPT4gX2Jhc2VfW3BdKS5mb3JFYWNoKHAgPT4gYVtwXSA9IF9iYXNlX1twXVthLk5hbWVdKSk7CgkJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYXR0TGlzdC5jb25jYXQoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9PSAiX19CQVNFX18iKSk7CgkJCQl9CgoJCQkJWydFbnRpdHlBdHRyaWJ1dGVzJywgJ0VudGl0eUZpZWxkcyddLmZpbHRlcihlVHlwZSA9PiBjW2VUeXBlXSkuZm9yRWFjaChlVHlwZSA9PiBjW2VUeXBlXS5maWx0ZXIoZWEgPT4gZWEuRHVwbGljYXRlKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlsZXQgc2VhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzBdKVtlVHlwZV0uZmluZChzZWEgPT4gc2VhLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMV0pOwoJCQkJCU9iamVjdC5rZXlzKHNlYSkuZmlsdGVyKGsgPT4gWyJFbnRpdHlDbGFzcyJdLmluZGV4T2YoaykgPCAwKS5mb3JFYWNoKGsgPT4gewoJCQkJCQlpZiAoayA9PSAnRGVmYXVsdCcgJiYgdHlwZW9mKHNlYVtrXSkgPT09ICdzdHJpbmcnICYmICFzZWFba10uaW5kZXhPZignLyoqZ2VuZXJhdGVkKiovJykpIHJldHVybjsKCQkJCQkJZWFba10gPSBzZWFba107CgkJCQkJfSk7CgkJCQl9KSk7CgoJCQkJYy5UeXBlZEF0dHJpYnV0ZXMgPSBjLlR5cGVkQXR0cmlidXRlcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG0uTWV0aG9kUGFyYW1ldGVycyB8fCBbXTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5wdXNoKC4uLmMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gIXAuSWQpKS5mbGF0KCkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiB0eXBlb2YoZWEuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgZWEuQWN0aXZlKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5VHlwZSB8fCAoZWEuRW50aXR5VHlwZSAmJiBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gewoJCQkJCWlmICghZWEuTmFtZSkgewoJCQkJCQljb25zb2xlLmxvZyhjLk5hbWUgKyAiIGhhcyBBdHRyaWJ1dGUgd2l0aG91dCBOYW1lIiwgZWEpOwoJCQkJCX0KCQkJCQllYS5JZCA9IGVhLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQllYS5fVG9TdHJpbmcgPSBlYS5fVG9TdHJpbmcgfHwgZWEuTmFtZTsKCQkJCQllYS5Hcm91cCA9IGVhLkdyb3VwIHx8ICJNYWluIjsKCQkJCQllYS5FbnRpdHlDbGFzcyA9IGM7CgkJCQl9KTsKCgkJCQlvR3JvdXBlci5ncm91cEJ5KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbmQodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uSWQgPSBtLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQltLl9Ub1N0cmluZyA9IG0uX1RvU3RyaW5nIHx8IG0uTmFtZTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4gcC5FbnRpdHlNZXRob2QgPSBtKTsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlICYmICFwLkVudGl0eVR5cGUuSWQpLmZvckVhY2gocCA9PiB7CgkJCQkJCXAuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBwLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJfSk7CgoJCQkJCWlmICghbS5SZXNwb25zZUF0dHJpYnV0ZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgUmVzcG9uc2VBdHRyaWJ1dGUgZm9yIG1ldGhvZCAiICsgbS5OYW1lICsgIi4gRGVmYXVsdGluZyB0byBvYmplY3QgcmV0dXJuIChyZXQiICsgbS5OYW1lICsgIikiKTsKCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCQkJCUlzT2JqZWN0OiB0cnVlLAoJCQkJCQl9OwoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgPSBtLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgfHwgKCJyZXQiICsgbS5OYW1lKTsKCgkJCQkJaWYgKG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSB7CgkJCQkJCWxldCByYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJCWlmICghcmEpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBFbnRpdHlUeXBlIE5hbWU9IiArIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUgPSByYTsKCQkJCQkJfQoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eU1ldGhvZCA9IG07CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMgPSB0aGlzLl91bmlxdWUoYy5FbnRpdHlNZXRob2RzKTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzU3RyaW5nICYmICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkRlZmF1bHQgJiYgKGVhLlJlcXVpcmVkIHx8IGVhLklzVW5pcXVlKSkuZm9yRWFjaChlYSA9PiBlYS5EZWZhdWx0ID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihyYSA9PiAhcmEuRW50aXR5TWV0aG9kICYmIHJhLkVudGl0eVR5cGUgJiYgKHJhLklzVW5pcXVlIHx8IHJhLlJlcXVpcmVkKSkubWFwKHJhID0+IGAvKipnZW5lcmF0ZWQqKi8odGhpcy4ke3JhLk5hbWV9KCk/dGhpcy4ke3JhLk5hbWV9KCkuJHtlYS5OYW1lfSgpOidudWxsJylgKS5qb2luKGAgKyAnLScgKyBgKSk7CgkJCX0pOwoKCQkJLypvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5lYy5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCQllYy5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkKS5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoJCQl9KTsqLwoKCQkJcmV0ID0gdGhpcy5fdW5pcXVlKGVjKTsKCQl9IGVsc2UgaWYgKCFlYyB8fCAhQXJyYXkuaXNBcnJheShlYykpIHsKCQkJdmFyIGNsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIik7CgoJCQl2YXIgdENsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eVR5cGUiKTsKCQkJY2xhc3Nlcy5mb3JFYWNoKGMgPT4gewoJCQkJaWYgKCFjLmtleSkgewoJCQkJCWNvbnNvbGUubG9nKCJFbXB0eSBrZXkiLCBjKTsKCQkJCX0KCQkJCWMua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBjLnZhbHVlczsKCgkJCQl2YXIgdGFzID0gdENsYXNzZXMuZmluZCh0YyA9PiB0Yy5rZXkgJiYgYy5rZXkgJiYgdGMua2V5LklkID09PSBjLmtleS5JZCk7CgkJCQkvL2Mua2V5LlR5cGVkQXR0cmlidXRlcyA9IHRhcyA/IHRhcy52YWx1ZXMgOiBbXTsKCQkJCWMua2V5LkVudGl0eU1ldGhvZHMgPSBjLmtleS5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQl9KTsKCQkJcmV0ID0gY2xhc3Nlcy5tYXAoYSA9PiBhLmtleSk7CgoJCQlvR3JvdXBlci5ncm91cEJ5KGVhcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQltLkVudGl0eUNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLklkID09IG0uRW50aXR5Q2xhc3NpZCk7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpWzBdOwoKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQl9KTsKCQl9CgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMgPSAoYy5FbnRpdHlGaWVsZHMgfHwgW10pLmZpbHRlcihmID0+ICFmLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuRW50aXR5Q2xhc3MgPSBjKTsKCQl9KTsKCgkJbGV0IHRyQ2xhc3MgPSByZXQuZmluZChjID0+IGMuTmFtZSA9PSAiVHJhbnNhY3Rpb24iICYmIGMuRW50aXR5TW9kdWxlKTsKCQlpZiAodHJDbGFzcykgcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSXNTeW5jICYmICFtLlJlc3BvbnNlTWV0aG9kKS5mb3JFYWNoKG0gPT4gewoJCQltLlJlc3BvbnNlTWV0aG9kID0gewoJCQkJTmFtZTogbS5OYW1lICsgIlJlc3BvbnNlIiwKCQkJCU1ldGhvZFBhcmFtZXRlcnM6IFt7CgkJCQkJTmFtZTogInRyYW5zYWN0aW9uIiwKCQkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzCgkJCQl9XSwKCQkJCVNjcmlwdDogYHJldHVybiBhd2FpdCB0cmFuc2FjdGlvbi5jbGFzcygiJHtjLk5hbWV9IikubWV0aG9kKCIke20uTmFtZX0iKS5hc3luY1Jlc3VsdCgiJHttLlJlc3BvbnNlQXR0cmlidXRlPy5FbnRpdHlUeXBlPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJyl9IiwgJHttLlJlc3BvbnNlQXR0cmlidXRlLklzQXJyYXk/InRydWUiOiJmYWxzZSJ9KWAsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogbS5SZXNwb25zZUF0dHJpYnV0ZSwKCQkJfTsKCQkJYy5FbnRpdHlNZXRob2RzLnB1c2gobS5SZXNwb25zZU1ldGhvZCk7CgoJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJTmFtZTogYHJldCR7bS5OYW1lfWAsCgkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzLAoJCQl9CgkJfSkpOwoKCQlvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQlsZXQgX2MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCB8fCAoYy5OYW1lID09IGN0YS5rZXkuTmFtZSAvKiYmIGMuRW50aXR5TW9kdWxlICYmIGN0YS5rZXkuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gY3RhLmtleS5FbnRpdHlNb2R1bGUuTmFtZSovICkpOwoJCQlpZiAoIV9jKSB7CgkJCQljb25zb2xlLmxvZygiTm8gY2xhc3MgZm91bmQgdG8gbWF0Y2ggIiArIGN0YS5rZXkuTmFtZSk7CgkJCX0gZWxzZSB7CgkJCQlfYy5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoKCQkJCWN0YS52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gX2MpOyAvLz8/PwoJCQl9CgkJfSk7CgoJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCAmJiAhcmV0LmZpbmQoYyA9PiBjLklzTWFpbikpIHsKCQkJcmV0WzBdLklzTWFpbiA9IHRydWU7CgkJCXJldFswXS5PcmRlciA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoJCX0KCgkJbGV0IGNSYW5rID0gKGMsIHNvdXJjZXMgPSBbXSkgPT4gewoJCQlzb3VyY2VzLnB1c2goYy5OYW1lKTsKCQkJcmV0dXJuIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlICE9PSBjICYmIHNvdXJjZXMuaW5kZXhPZihlYS5FbnRpdHlUeXBlLk5hbWUpIDwgMCkubWFwKGVhID0+IGNSYW5rKGVhLkVudGl0eVR5cGUsIHNvdXJjZXMpKS5jb25jYXQoWzFdKS5yZWR1Y2UoKHN1bSwgeCkgPT4gc3VtICsgeCk7CgkJfTsKCgkJLy8gb3JkZXIgYnkgb3JkZXIKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5PcmRlciA9IGMuT3JkZXIgfHwgMDsKCQkJYy5SYW5rID0gY1JhbmsoYyk7CgkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IGVhLk9yZGVyID0gZWEuT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKGVtID0+IGVtLk9yZGVyID0gZW0uT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuT3JkZXIgPSBlZi5PcmRlciB8fCAwKTsKCQl9KTsKCQlyZXQuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUZpZWxkcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgoJCWlmIChyZXQubGVuZ3RoKSB7CgkJCVsnRGVidWcnLCAnQ29uZmlnJywgJ1Rlc3QnLCAnVG9vbHMnLCAnTWFwcGluZ3MnLCAnUm91dGluZycsICdWYWxpZGF0b3JzJywgJ01ldGhvZFJ1bGVzJywgJ0VudGl0eVJ1bGVzJ10uZm9yRWFjaChhID0+IHsKCQkJCWxldCBtY0EgPSByZXRbMF1bYV07CgkJCQlkZWxldGUgcmV0WzBdW2FdOwoJCQkJcmV0LmZvckVhY2goYyA9PiB7CgkJCQkJY1thXSA9IGNbYV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uW2MuTmFtZV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uWycqJ10gfHwgYy5FbnRpdHlNb2R1bGU/LlthXSB8fCBtY0E/LltjLk5hbWVdIHx8IG1jQT8uWycqJ10gfHwgbWNBIHx8IHt9OwoJCQkJCWlmIChhLmVuZHNXaXRoKCdzJykgJiYgIUFycmF5LmlzQXJyYXkoY1thXSkpIGNbYV0gPSBPYmplY3Qua2V5cyhjW2FdKTsKCQkJCX0pOwoJCQl9KTsKCgkJCXJldC5maWx0ZXIoYyA9PiAhYy5Jc01haW4pLmZvckVhY2goYyA9PiBjLkNvbmZpZyA9IE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXQuZmluZChfYyA9PiBfYy5Jc01haW4pLkNvbmZpZykpLCBjLkNvbmZpZykpOwoKCQkJcmV0LmZpbHRlcihjID0+IGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IGMuRW50aXR5TW9kdWxlID0gYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJX19zY29wZU5hbWUoc2NvcGUpIHsKCQlyZXR1cm4gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCkgfHwgIndpbmRvdyI7Cgl9CgoJX19zY29wZShzY29wZSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fID8gdGhpcy5zcigpLl9fc2NvcGUoc2NvcGUpIDogdGhpczsKCX0KCglhc3luYyBfYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHJTY29wZSA9IHsKCQkJRW50aXR5Q2xhc3NlczogcmV0LAoJCQlFbnRpdHlBdHRyaWJ1dGVzOiBlYXMsCgkJfTsKCgkJclNjb3BlLm5OYW1lID0gclNjb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlyU2NvcGUubkNvZGUgPSByU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIGh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKSkpOwoKCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gJyc7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9ICIiOwoJCQl0cnkgewoJCQkJY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQkJYzogYywKCQkJCQlzY29wZTogc2NvcGUsCgkJCQkJbk5hbWU6IHJTY29wZS5uTmFtZSwKCQkJCQluQ29kZTogclNjb3BlLm5Db2RlLAoJCQkJfSkgKyAnXG4nICsgclNjb3BlLm5OYW1lKGMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9idWlsZENsYXNzZXMoKTogX2luamVjdCBleGNlcHRpb246ICIgKyBleCk7CgkJCX0KCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtyU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7clNjb3BlLm5OYW1lKGMpfSA9ICR7clNjb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IHJTY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tyU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJfQoKCQlyZXR1cm4gclNjb3BlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKCk7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBkOwoJCW9TY29wZS5fX3RpbWVzID0gb1Njb3BlLl9fdGltZXMgfHwge307CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBvU2NvcGUuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gb1Njb3BlLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHdpbmRvdy5sb2NhdGlvbiA9PT0gd2luZG93LnBhcmVudC5sb2NhdGlvbiAmJiB0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJLy8gaW5zaWRlIGEgd2luZG93CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0gZWxzZSBpZiAodHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCXRoaXMuUmVuZGVyUGFnZSh7CgkJCQlfY29kZTogdXJsLnBhZ2UKCQkJfSwgdXJsKTsKCQl9CgkJbG9jYXRpb24uaGFzaCA9ICIjIiArIHVybDsKCX0KCglmcm9tSGFzaCgpIHsKCQl0aGlzLmhhc2ggPSB7fTsKCQkobG9jYXRpb24uc2VhcmNoICsgbG9jYXRpb24uaGFzaCkucmVwbGFjZSgvIy9nLCAiJiIpLnJlcGxhY2UoL1w/L2csICcnKS5zcGxpdCgiJiIpLmZpbHRlcihlID0+IGUpLmZvckVhY2goZSA9PiB7CgkJCXRyeSB7CgkJCQl0aGlzLmhhc2hbZS5zcGxpdCgiPSIpWzBdXSA9IGUuc3BsaXQoIj0iKVsxXTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coImVuZCgpIHdpdGggZGF0YSIsIGRhdGEpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJLy9vQ29udGVudC5oaWRlKCk7CgkJCS8vb0NvbnRlbnQuZmFkZUluKDEwMDApOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogJ0xvYWRpbmcnLAoJCQkJCW1zZzogJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJCQl0aXRsZTogJ1BsZWFzZSB3YWl0aW5nJywKCQkJCQkJCW1zZzogJ1NhdmluZyBkYXRhLi4uJywKCQkJCQkJCWludGVydmFsOiBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgc2F2ZXIodmFsdWUsIGZEYXRhKTsKCQkJCQkJZWRpdG9yLmxhc3RTYXZlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIFNhdmUgZmlsZS5cbiIgKyBleCk7CgkJCQkJfQoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF92dWVDb21wb25lbnQoY29kZSkgewoJCWlmICh0eXBlb2YgVnVlID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7Cgl9CgoJYXN5bmMgX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJY29uc29sZS5sb2coIlJlbmRlclBhZ2UiLCBwYWdlLCBkYXRhKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMucGFnZXNbaV0uX2NvZGUgPT0gcGFnZS5fY29kZSAmJiB0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSAmJiAodGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgPT0gKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpKSB7CgkJCQljb25zb2xlLmxvZygod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSk7CgkJCQlwYWdlID0gdGhpcy5wYWdlc1tpXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlmICghdGhpcy5zcigpLmJMb2NhbCAmJiAocGFnZS5Cb2R5IHx8IHBhZ2UudG9FbnRpdHlPYmplY3QpKSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBhbHJlYWR5IGxvYWRlZCwgc2VydmluZy4uLiIpOwoJCQkvLyBmb3VuZCB0aGUgcGFnZSBhbmQgaXQgaXMgYW4gb2JqZWN0CgkJCWlmICghcGFnZS5TY3JpcHQpIHsKCQkJCWxldCBlID0gYXdhaXQgdGhpcy5lbmQoKTsKCQkJCXJldHVybiBlOwoJCQl9CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQljb25zb2xlLmxvZygiX3JlbmRlcigpIHVzaW5nIGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyLlNjb3BlKTsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpLmZpbmQoKTsKCQkJaWYgKHApIHJldCA9IHsKCQkJCVNjcmlwdDogcC5zY3JpcHQoKSA/IHAuc2NyaXB0KCkgOiAnJywKCQkJCUJvZHk6IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCX0KCgkJaWYgKCFyZXQpIHJldCA9IGF3YWl0IHRoaXMuX3Z1ZUNvbXBvbmVudChwYWdlLl9jb2RlKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YoQ01TX1JPT1QpID09PSAnc3RyaW5nJykgewoJCQlyZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogcGFnZS5fY29kZS5pbmRleE9mKCcvJykgPj0gMCA/IHBhZ2UuX2NvZGUgOiAoQ01TX1JPT1QgKyBwYWdlLl9jb2RlKQoJCQl9KTsKCQl9CgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBDTVMsIGxvb2tpbmcgaW4gRU1TIik7CgkJCXZhciBlb1BhZ2UgPSBudWxsOwoJCQl0cnkgewoJCQkJZW9QYWdlID0gbmV3IFBhZ2UoKS5jb2RlKHBhZ2UuX2NvZGUsICI9Iik7CgkJCQlpZiAoZW9QYWdlLmxhbmd1YWdlKSBlb1BhZ2UubGFuZ3VhZ2Uod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iLCAiPSIpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZygiRU1TIGRvZXMgbm90IGhhdmUgYSBQYWdlIGNsYXNzLCBmYWlsaW5nIG9uIHB1cnBvc2U6ICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQlFbnRpdHlPYmplY3Q6IChlb1BhZ2UgPyBlb1BhZ2UudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQl9KTsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gRU1TLCB0cnlpbmcgdGVtcGxhdGVzIik7CgkJCQlwYWdlID0gcmV0WzBdOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBFTVMsIHNvIGdvaW5nIGxvY2FsIik7CgkJCX0KCgkJCWxldCBodG1sID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmh0bSIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChodG1sICYmICFodG1sLnN0YXR1cykgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGh0bWwgdGVtcGxhdGUgZm91bmQiLCBodG1sKTsKCQkJCXBhZ2UuQm9keSA9IGh0bWw7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaGFzIG5vIGh0bWwgdGVtcGxhdGUiKTsKCQkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlwYWdlLkJvZHkgPSAiPGRpdiBpZD0nZm9ybUNvbXBvbmVudCcvPiI7CgkJCQl9IGVsc2UgewoJCQkJCXBhZ2UuQm9keSA9IHBhZ2UuX2NvbnRlbnQgfHwgIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCQl9CgkJCX0KCgkJCWxldCBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZShwYWdlKTsKCQkJaWYgKCFqcykgdHJ5IHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5qcyIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmICghanMgfHwgIWpzLm9rKSBqcyA9IG51bGw7CgkJCWlmIChqcyAmJiBqcy5vaykgcGFnZS5TY3JpcHQgPSBhd2FpdCBqcy50ZXh0KCk7CgoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgc2NyaXB0IGlzIiArIChqcyA/ICcnIDogJyBub3QnKSArICIgcmV0cmlldmVkIik7CgkJCXRoaXMuc3RlcCgpOwoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCS8vY29uc29sZS5sb2coInBhZ2UgQm9keSIsIHBhZ2UuX2JvZHkgfHwgcGFnZS5Cb2R5KTsKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQlsZXQgb2JqID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UsIERGb3JtKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9ICh0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCB8fCAnJykgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkgfHwgJycpICsgKHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sIHx8ICcnKTsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCgkJdHJ5IHsKCQkJcmV0dXJuIEpTT04ucGFyc2Uoc0NvZGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQlsZXQgc0NvZGUgPSBqczsKCQlpZiAoc0NvZGUuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCX0gZWxzZSB7CgkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJfQoJCQlzQ29kZSA9ICIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7IjsKCQl9CgoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KHNDb2RlKTsKCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2Eoc0NvZGUpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBzQ29kZS5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChzQ29kZSk7CgkJfQoJfQp9Ow==",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSAwMTk1NmVlYjQ2YTk3NDA5ODVlN2ExNmRiOWE5NzYwNyA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgMDE5NTZlZWI0NmE5NzQwOTg1ZTdhN2I4MDMxZjk4ZDIgNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfTsKCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIF9ocmVmcy5maWx0ZXIobCA9PiBsLmxpYiA9PT0gbGliTmFtZSAmJiB0aGlzLl9pbmNsdWRlKGwpKSkgewoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0KCgkJCWlmICh0eXBlb2Yobi5zcmMpID09PSAndW5kZWZpbmVkJyAmJiBuLnNjcmlwdCAmJiAhbW9kdWxlcy5sZW5ndGgpIHsKCQkJCWlmICh0eXBlb2Yobi5zY3JpcHQpID09PSAnZnVuY3Rpb24nKSBuLnNjcmlwdCA9IG4uc2NyaXB0KCk7CgkJCQltb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KG4uc2NyaXB0LCBuLm5vUnVuKSk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IGF3YWl0IHJlcy50ZXh0KCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJzsKCQkJCQlqcyA9IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCFqcykganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IGJsb2NrCgkJCX0sICJibG9ja3MiKTsKCgkJCWlmICghanMgJiYgd2luZG93LmJMb2NhbCkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5qcyIpKTsKCQkJCWpzID0ganMub2sgPyAoYXdhaXQganMudGV4dCgpKSA6IG51bGw7CgkJCX0KCgkJCWlmIChqcykgewoJCQkJanMgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcyk7CgkJCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJaWYgKCFodG1sICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQkJaHRtbCA9IGh0bWwub2sgPyAoYXdhaXQgaHRtbC50ZXh0KCkpIDogJyc7CgkJfQoJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbDsKCgkJaWYgKGpzICYmICF0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbYmxvY2sgKyAiQ29tcG9uZW50Il0pIHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSAiPCIgKyBibG9jayArICJDb21wb25lbnQvPiI7CgkJfQoJCXRoaXMuc3RlcCgpOwoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCIuLi8uLi8iICsgKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgZmV0Y2godXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQkvL3Njb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoIiArIHNjb3BlICsgIik6IGZhaWxlZCB0byBsb2FkIGNsYXNzZXMuLi4iKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcyk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJkYXRlIiwKCQkJCQkJSXNEYXRlOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiAnbmV3IERhdGUoKScsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJfV07CgkJCQkJYXR0TGlzdC5mb3JFYWNoKGEgPT4gcHJvcExpc3QuZmlsdGVyKHAgPT4gX2Jhc2VfW3BdKS5mb3JFYWNoKHAgPT4gYVtwXSA9IF9iYXNlX1twXVthLk5hbWVdKSk7CgkJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYXR0TGlzdC5jb25jYXQoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9PSAiX19CQVNFX18iKSk7CgkJCQl9CgoJCQkJWydFbnRpdHlBdHRyaWJ1dGVzJywgJ0VudGl0eUZpZWxkcyddLmZpbHRlcihlVHlwZSA9PiBjW2VUeXBlXSkuZm9yRWFjaChlVHlwZSA9PiBjW2VUeXBlXS5maWx0ZXIoZWEgPT4gZWEuRHVwbGljYXRlKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlsZXQgc2VhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzBdKVtlVHlwZV0uZmluZChzZWEgPT4gc2VhLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMV0pOwoJCQkJCU9iamVjdC5rZXlzKHNlYSkuZmlsdGVyKGsgPT4gWyJFbnRpdHlDbGFzcyJdLmluZGV4T2YoaykgPCAwKS5mb3JFYWNoKGsgPT4gewoJCQkJCQlpZiAoayA9PSAnRGVmYXVsdCcgJiYgdHlwZW9mKHNlYVtrXSkgPT09ICdzdHJpbmcnICYmICFzZWFba10uaW5kZXhPZignLyoqZ2VuZXJhdGVkKiovJykpIHJldHVybjsKCQkJCQkJZWFba10gPSBzZWFba107CgkJCQkJfSk7CgkJCQl9KSk7CgoJCQkJYy5UeXBlZEF0dHJpYnV0ZXMgPSBjLlR5cGVkQXR0cmlidXRlcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG0uTWV0aG9kUGFyYW1ldGVycyB8fCBbXTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5wdXNoKC4uLmMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gIXAuSWQpKS5mbGF0KCkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiB0eXBlb2YoZWEuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgZWEuQWN0aXZlKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5VHlwZSB8fCAoZWEuRW50aXR5VHlwZSAmJiBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gewoJCQkJCWlmICghZWEuTmFtZSkgewoJCQkJCQljb25zb2xlLmxvZyhjLk5hbWUgKyAiIGhhcyBBdHRyaWJ1dGUgd2l0aG91dCBOYW1lIiwgZWEpOwoJCQkJCX0KCQkJCQllYS5JZCA9IGVhLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQllYS5fVG9TdHJpbmcgPSBlYS5fVG9TdHJpbmcgfHwgZWEuTmFtZTsKCQkJCQllYS5Hcm91cCA9IGVhLkdyb3VwIHx8ICJNYWluIjsKCQkJCQllYS5FbnRpdHlDbGFzcyA9IGM7CgkJCQl9KTsKCgkJCQlvR3JvdXBlci5ncm91cEJ5KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbmQodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uSWQgPSBtLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQltLl9Ub1N0cmluZyA9IG0uX1RvU3RyaW5nIHx8IG0uTmFtZTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4gcC5FbnRpdHlNZXRob2QgPSBtKTsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlICYmICFwLkVudGl0eVR5cGUuSWQpLmZvckVhY2gocCA9PiB7CgkJCQkJCXAuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBwLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJfSk7CgoJCQkJCWlmICghbS5SZXNwb25zZUF0dHJpYnV0ZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgUmVzcG9uc2VBdHRyaWJ1dGUgZm9yIG1ldGhvZCAiICsgbS5OYW1lICsgIi4gRGVmYXVsdGluZyB0byBvYmplY3QgcmV0dXJuIChyZXQiICsgbS5OYW1lICsgIikiKTsKCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCQkJCUlzT2JqZWN0OiB0cnVlLAoJCQkJCQl9OwoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgPSBtLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgfHwgKCJyZXQiICsgbS5OYW1lKTsKCgkJCQkJaWYgKG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSB7CgkJCQkJCWxldCByYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJCWlmICghcmEpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBFbnRpdHlUeXBlIE5hbWU9IiArIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUgPSByYTsKCQkJCQkJfQoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eU1ldGhvZCA9IG07CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMgPSB0aGlzLl91bmlxdWUoYy5FbnRpdHlNZXRob2RzKTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzU3RyaW5nICYmICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkRlZmF1bHQgJiYgKGVhLlJlcXVpcmVkIHx8IGVhLklzVW5pcXVlKSkuZm9yRWFjaChlYSA9PiBlYS5EZWZhdWx0ID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihyYSA9PiAhcmEuRW50aXR5TWV0aG9kICYmIHJhLkVudGl0eVR5cGUgJiYgKHJhLklzVW5pcXVlIHx8IHJhLlJlcXVpcmVkKSkubWFwKHJhID0+IGAvKipnZW5lcmF0ZWQqKi8odGhpcy4ke3JhLk5hbWV9KCk/dGhpcy4ke3JhLk5hbWV9KCkuJHtlYS5OYW1lfSgpOidudWxsJylgKS5qb2luKGAgKyAnLScgKyBgKSk7CgkJCX0pOwoKCQkJLypvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5lYy5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCQllYy5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkKS5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoJCQl9KTsqLwoKCQkJcmV0ID0gdGhpcy5fdW5pcXVlKGVjKTsKCQl9IGVsc2UgaWYgKCFlYyB8fCAhQXJyYXkuaXNBcnJheShlYykpIHsKCQkJdmFyIGNsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIik7CgoJCQl2YXIgdENsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eVR5cGUiKTsKCQkJY2xhc3Nlcy5mb3JFYWNoKGMgPT4gewoJCQkJaWYgKCFjLmtleSkgewoJCQkJCWNvbnNvbGUubG9nKCJFbXB0eSBrZXkiLCBjKTsKCQkJCX0KCQkJCWMua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBjLnZhbHVlczsKCgkJCQl2YXIgdGFzID0gdENsYXNzZXMuZmluZCh0YyA9PiB0Yy5rZXkgJiYgYy5rZXkgJiYgdGMua2V5LklkID09PSBjLmtleS5JZCk7CgkJCQkvL2Mua2V5LlR5cGVkQXR0cmlidXRlcyA9IHRhcyA/IHRhcy52YWx1ZXMgOiBbXTsKCQkJCWMua2V5LkVudGl0eU1ldGhvZHMgPSBjLmtleS5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQl9KTsKCQkJcmV0ID0gY2xhc3Nlcy5tYXAoYSA9PiBhLmtleSk7CgoJCQlvR3JvdXBlci5ncm91cEJ5KGVhcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQltLkVudGl0eUNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLklkID09IG0uRW50aXR5Q2xhc3NpZCk7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpWzBdOwoKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQl9KTsKCQl9CgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMgPSAoYy5FbnRpdHlGaWVsZHMgfHwgW10pLmZpbHRlcihmID0+ICFmLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuRW50aXR5Q2xhc3MgPSBjKTsKCQl9KTsKCgkJbGV0IHRyQ2xhc3MgPSByZXQuZmluZChjID0+IGMuTmFtZSA9PSAiVHJhbnNhY3Rpb24iICYmIGMuRW50aXR5TW9kdWxlKTsKCQlpZiAodHJDbGFzcykgcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSXNTeW5jICYmICFtLlJlc3BvbnNlTWV0aG9kKS5mb3JFYWNoKG0gPT4gewoJCQltLlJlc3BvbnNlTWV0aG9kID0gewoJCQkJTmFtZTogbS5OYW1lICsgIlJlc3BvbnNlIiwKCQkJCU1ldGhvZFBhcmFtZXRlcnM6IFt7CgkJCQkJTmFtZTogInRyYW5zYWN0aW9uIiwKCQkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzCgkJCQl9XSwKCQkJCVNjcmlwdDogYHJldHVybiBhd2FpdCB0cmFuc2FjdGlvbi5jbGFzcygiJHtjLk5hbWV9IikubWV0aG9kKCIke20uTmFtZX0iKS5hc3luY1Jlc3VsdCgiJHttLlJlc3BvbnNlQXR0cmlidXRlPy5FbnRpdHlUeXBlPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJyl9IiwgJHttLlJlc3BvbnNlQXR0cmlidXRlLklzQXJyYXk/InRydWUiOiJmYWxzZSJ9KWAsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogbS5SZXNwb25zZUF0dHJpYnV0ZSwKCQkJfTsKCQkJYy5FbnRpdHlNZXRob2RzLnB1c2gobS5SZXNwb25zZU1ldGhvZCk7CgoJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJTmFtZTogYHJldCR7bS5OYW1lfWAsCgkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzLAoJCQl9CgkJfSkpOwoKCQlvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQlsZXQgX2MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCB8fCAoYy5OYW1lID09IGN0YS5rZXkuTmFtZSAvKiYmIGMuRW50aXR5TW9kdWxlICYmIGN0YS5rZXkuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gY3RhLmtleS5FbnRpdHlNb2R1bGUuTmFtZSovICkpOwoJCQlpZiAoIV9jKSB7CgkJCQljb25zb2xlLmxvZygiTm8gY2xhc3MgZm91bmQgdG8gbWF0Y2ggIiArIGN0YS5rZXkuTmFtZSk7CgkJCX0gZWxzZSB7CgkJCQlfYy5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoKCQkJCWN0YS52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gX2MpOyAvLz8/PwoJCQl9CgkJfSk7CgoJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCAmJiAhcmV0LmZpbmQoYyA9PiBjLklzTWFpbikpIHsKCQkJcmV0WzBdLklzTWFpbiA9IHRydWU7CgkJCXJldFswXS5PcmRlciA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoJCX0KCgkJbGV0IGNSYW5rID0gKGMsIHNvdXJjZXMgPSBbXSkgPT4gewoJCQlzb3VyY2VzLnB1c2goYy5OYW1lKTsKCQkJcmV0dXJuIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlICE9PSBjICYmIHNvdXJjZXMuaW5kZXhPZihlYS5FbnRpdHlUeXBlLk5hbWUpIDwgMCkubWFwKGVhID0+IGNSYW5rKGVhLkVudGl0eVR5cGUsIHNvdXJjZXMpKS5jb25jYXQoWzFdKS5yZWR1Y2UoKHN1bSwgeCkgPT4gc3VtICsgeCk7CgkJfTsKCgkJLy8gb3JkZXIgYnkgb3JkZXIKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5PcmRlciA9IGMuT3JkZXIgfHwgMDsKCQkJYy5SYW5rID0gY1JhbmsoYyk7CgkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IGVhLk9yZGVyID0gZWEuT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKGVtID0+IGVtLk9yZGVyID0gZW0uT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuT3JkZXIgPSBlZi5PcmRlciB8fCAwKTsKCQl9KTsKCQlyZXQuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUZpZWxkcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgoJCWlmIChyZXQubGVuZ3RoKSB7CgkJCVsnRGVidWcnLCAnQ29uZmlnJywgJ1Rlc3QnLCAnVG9vbHMnLCAnTWFwcGluZ3MnLCAnUm91dGluZycsICdWYWxpZGF0b3JzJywgJ01ldGhvZFJ1bGVzJywgJ0VudGl0eVJ1bGVzJ10uZm9yRWFjaChhID0+IHsKCQkJCWxldCBtY0EgPSByZXRbMF1bYV07CgkJCQlkZWxldGUgcmV0WzBdW2FdOwoJCQkJcmV0LmZvckVhY2goYyA9PiB7CgkJCQkJY1thXSA9IGNbYV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uW2MuTmFtZV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uWycqJ10gfHwgYy5FbnRpdHlNb2R1bGU/LlthXSB8fCBtY0E/LltjLk5hbWVdIHx8IG1jQT8uWycqJ10gfHwgbWNBIHx8IHt9OwoJCQkJCWlmIChhLmVuZHNXaXRoKCdzJykgJiYgIUFycmF5LmlzQXJyYXkoY1thXSkpIGNbYV0gPSBPYmplY3Qua2V5cyhjW2FdKTsKCQkJCX0pOwoJCQl9KTsKCgkJCXJldC5maWx0ZXIoYyA9PiAhYy5Jc01haW4pLmZvckVhY2goYyA9PiBjLkNvbmZpZyA9IE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXQuZmluZChfYyA9PiBfYy5Jc01haW4pLkNvbmZpZykpLCBjLkNvbmZpZykpOwoKCQkJcmV0LmZpbHRlcihjID0+IGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IGMuRW50aXR5TW9kdWxlID0gYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJX19zY29wZU5hbWUoc2NvcGUpIHsKCQlyZXR1cm4gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCkgfHwgIndpbmRvdyI7Cgl9CgoJX19zY29wZShzY29wZSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fID8gdGhpcy5zcigpLl9fc2NvcGUoc2NvcGUpIDogdGhpczsKCX0KCglhc3luYyBfYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHJTY29wZSA9IHsKCQkJRW50aXR5Q2xhc3NlczogcmV0LAoJCQlFbnRpdHlBdHRyaWJ1dGVzOiBlYXMsCgkJfTsKCgkJclNjb3BlLm5OYW1lID0gclNjb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlyU2NvcGUubkNvZGUgPSByU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIGh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKSkpOwoKCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gJyc7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9ICIiOwoJCQl0cnkgewoJCQkJY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQkJYzogYywKCQkJCQlzY29wZTogc2NvcGUsCgkJCQkJbk5hbWU6IHJTY29wZS5uTmFtZSwKCQkJCQluQ29kZTogclNjb3BlLm5Db2RlLAoJCQkJfSkgKyAnXG4nICsgclNjb3BlLm5OYW1lKGMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9idWlsZENsYXNzZXMoKTogX2luamVjdCBleGNlcHRpb246ICIgKyBleCk7CgkJCX0KCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtyU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7clNjb3BlLm5OYW1lKGMpfSA9ICR7clNjb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IHJTY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tyU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJfQoKCQlyZXR1cm4gclNjb3BlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKCk7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBkOwoJCW9TY29wZS5fX3RpbWVzID0gb1Njb3BlLl9fdGltZXMgfHwge307CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBvU2NvcGUuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gb1Njb3BlLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHdpbmRvdy5sb2NhdGlvbiA9PT0gd2luZG93LnBhcmVudC5sb2NhdGlvbiAmJiB0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJLy8gaW5zaWRlIGEgd2luZG93CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0gZWxzZSBpZiAodHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCXRoaXMuUmVuZGVyUGFnZSh7CgkJCQlfY29kZTogdXJsLnBhZ2UKCQkJfSwgdXJsKTsKCQl9CgkJbG9jYXRpb24uaGFzaCA9ICIjIiArIHVybDsKCX0KCglmcm9tSGFzaCgpIHsKCQl0aGlzLmhhc2ggPSB7fTsKCQkobG9jYXRpb24uc2VhcmNoICsgbG9jYXRpb24uaGFzaCkucmVwbGFjZSgvIy9nLCAiJiIpLnJlcGxhY2UoL1w/L2csICcnKS5zcGxpdCgiJiIpLmZpbHRlcihlID0+IGUpLmZvckVhY2goZSA9PiB7CgkJCXRyeSB7CgkJCQl0aGlzLmhhc2hbZS5zcGxpdCgiPSIpWzBdXSA9IGUuc3BsaXQoIj0iKVsxXTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coImVuZCgpIHdpdGggZGF0YSIsIGRhdGEpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJLy9vQ29udGVudC5oaWRlKCk7CgkJCS8vb0NvbnRlbnQuZmFkZUluKDEwMDApOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogJ0xvYWRpbmcnLAoJCQkJCW1zZzogJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJCQl0aXRsZTogJ1BsZWFzZSB3YWl0aW5nJywKCQkJCQkJCW1zZzogJ1NhdmluZyBkYXRhLi4uJywKCQkJCQkJCWludGVydmFsOiBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgc2F2ZXIodmFsdWUsIGZEYXRhKTsKCQkJCQkJZWRpdG9yLmxhc3RTYXZlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIFNhdmUgZmlsZS5cbiIgKyBleCk7CgkJCQkJfQoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF92dWVDb21wb25lbnQoY29kZSkgewoJCWlmICh0eXBlb2YgVnVlID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7Cgl9CgoJYXN5bmMgX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJY29uc29sZS5sb2coIlJlbmRlclBhZ2UiLCBwYWdlLCBkYXRhKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMucGFnZXNbaV0uX2NvZGUgPT0gcGFnZS5fY29kZSAmJiB0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSAmJiAodGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgPT0gKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpKSB7CgkJCQljb25zb2xlLmxvZygod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSk7CgkJCQlwYWdlID0gdGhpcy5wYWdlc1tpXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlmICghdGhpcy5zcigpLmJMb2NhbCAmJiAocGFnZS5Cb2R5IHx8IHBhZ2UudG9FbnRpdHlPYmplY3QpKSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBhbHJlYWR5IGxvYWRlZCwgc2VydmluZy4uLiIpOwoJCQkvLyBmb3VuZCB0aGUgcGFnZSBhbmQgaXQgaXMgYW4gb2JqZWN0CgkJCWlmICghcGFnZS5TY3JpcHQpIHsKCQkJCWxldCBlID0gYXdhaXQgdGhpcy5lbmQoKTsKCQkJCXJldHVybiBlOwoJCQl9CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQljb25zb2xlLmxvZygiX3JlbmRlcigpIHVzaW5nIGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyLlNjb3BlKTsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpLmZpbmQoKTsKCQkJaWYgKHApIHJldCA9IHsKCQkJCVNjcmlwdDogcC5zY3JpcHQoKSA/IHAuc2NyaXB0KCkgOiAnJywKCQkJCUJvZHk6IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCX0KCgkJaWYgKCFyZXQpIHJldCA9IGF3YWl0IHRoaXMuX3Z1ZUNvbXBvbmVudChwYWdlLl9jb2RlKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YoQ01TX1JPT1QpID09PSAnc3RyaW5nJykgewoJCQlyZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogcGFnZS5fY29kZS5pbmRleE9mKCcvJykgPj0gMCA/IHBhZ2UuX2NvZGUgOiAoQ01TX1JPT1QgKyBwYWdlLl9jb2RlKQoJCQl9KTsKCQl9CgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBDTVMsIGxvb2tpbmcgaW4gRU1TIik7CgkJCXZhciBlb1BhZ2UgPSBudWxsOwoJCQl0cnkgewoJCQkJZW9QYWdlID0gbmV3IFBhZ2UoKS5jb2RlKHBhZ2UuX2NvZGUsICI9Iik7CgkJCQlpZiAoZW9QYWdlLmxhbmd1YWdlKSBlb1BhZ2UubGFuZ3VhZ2Uod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iLCAiPSIpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZygiRU1TIGRvZXMgbm90IGhhdmUgYSBQYWdlIGNsYXNzLCBmYWlsaW5nIG9uIHB1cnBvc2U6ICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQlFbnRpdHlPYmplY3Q6IChlb1BhZ2UgPyBlb1BhZ2UudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQl9KTsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gRU1TLCB0cnlpbmcgdGVtcGxhdGVzIik7CgkJCQlwYWdlID0gcmV0WzBdOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBFTVMsIHNvIGdvaW5nIGxvY2FsIik7CgkJCX0KCgkJCWxldCBodG1sID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmh0bSIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChodG1sICYmICFodG1sLnN0YXR1cykgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGh0bWwgdGVtcGxhdGUgZm91bmQiLCBodG1sKTsKCQkJCXBhZ2UuQm9keSA9IGh0bWw7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaGFzIG5vIGh0bWwgdGVtcGxhdGUiKTsKCQkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlwYWdlLkJvZHkgPSAiPGRpdiBpZD0nZm9ybUNvbXBvbmVudCcvPiI7CgkJCQl9IGVsc2UgewoJCQkJCXBhZ2UuQm9keSA9IHBhZ2UuX2NvbnRlbnQgfHwgIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCQl9CgkJCX0KCgkJCWxldCBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZShwYWdlKTsKCQkJaWYgKCFqcykgdHJ5IHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5qcyIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmICghanMgfHwgIWpzLm9rKSBqcyA9IG51bGw7CgkJCWlmIChqcyAmJiBqcy5vaykgcGFnZS5TY3JpcHQgPSBhd2FpdCBqcy50ZXh0KCk7CgoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgc2NyaXB0IGlzIiArIChqcyA/ICcnIDogJyBub3QnKSArICIgcmV0cmlldmVkIik7CgkJCXRoaXMuc3RlcCgpOwoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCS8vY29uc29sZS5sb2coInBhZ2UgQm9keSIsIHBhZ2UuX2JvZHkgfHwgcGFnZS5Cb2R5KTsKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQlsZXQgb2JqID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UsIERGb3JtKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9ICh0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCB8fCAnJykgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkgfHwgJycpICsgKHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sIHx8ICcnKTsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCgkJdHJ5IHsKCQkJcmV0dXJuIEpTT04ucGFyc2Uoc0NvZGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQlsZXQgc0NvZGUgPSBqczsKCQlpZiAoc0NvZGUuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCX0gZWxzZSB7CgkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJfQoJCQlzQ29kZSA9ICIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7IjsKCQl9CgoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KHNDb2RlKTsKCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2Eoc0NvZGUpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBzQ29kZS5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChzQ29kZSk7CgkJfQoJfQp9Ow==",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "01956eeb46a9740985e7a16db9a97607",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "01956eeb46a9740985e7a7b8031f98d2",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
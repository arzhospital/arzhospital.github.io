{
	"Id": "8a317b38038d0c1e310e1baada493be6de555812",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7Cgl9CgoJZ3JvdXBCeShhciwgZmllbGQpIHsKCQlpZiAoIWFyIHx8ICFmaWVsZCkgcmV0dXJuIG51bGw7CgoJCXZhciBrZXlzID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJdmFyIGtleSA9IG51bGw7CgkJCWZpZWxkLnNwbGl0KCcuJykuZm9yRWFjaChmID0+IGtleSA9IChrZXkgfHwgYSlbZl0pOwoJCQlsZXQgayA9IGtleXMuZmluZChrID0+IHRoaXMuRXF1YWxzKGsua2V5LCBrZXkpKTsKCQkJaWYgKGspIHsKCQkJCWsudmFsdWVzLnB1c2goYSk7CgkJCX0gZWxzZSB7CgkJCQlrZXlzLnB1c2goewoJCQkJCWtleToga2V5LAoJCQkJCXZhbHVlczogW2FdLAoJCQkJfSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4ga2V5czsKCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWlmICh0aGlzLnNyKCkuXykgewoJCQlsZXQgc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJYXN5bmMgX2luaXRDb250ZW50TWFuYWdlcigpIHsKCQlsZXQgYXJDbGFzc2VzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSk7CgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXJDbGFzc2VzLCAiY29udGVudG1hbmFnZXIiKTsKCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGMuTmFtZSwKCQkJCVRvb2xzOiBjLlRvb2xzLAoJCQkJRGVidWc6IGMuRGVidWcsCgkJCQlUZXN0OiBjLlRlc3QsCgkJCQlDb25maWc6IGMuQ29uZmlnLAoJCQkJRW5hYmxlZDogYy5FbmFibGVkLAoJCQkJRW50aXR5QXR0cmlidXRlczogYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gZWFNYXAoZWEpKSwKCQkJCUVudGl0eU1ldGhvZHM6IGMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiAoewoJCQkJCU5hbWU6IG0uTmFtZSwKCQkJCQlTY3JpcHQ6IG0uU2NyaXB0LAoJCQkJCVJvdXRpbmc6IG0uUm91dGluZywKCQkJCQlNZXRob2RQYXJhbWV0ZXJzOiBtLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gZWFNYXAocCkpLAoJCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBlYU1hcChtLlJlc3BvbnNlQXR0cmlidXRlKSwKCQkJCX0pKSwKCQkJfTsKCgkJCVsiVG9vbHMiLCAiRW50aXR5TWV0aG9kcyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIXJldFthXS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlbIkRlYnVnIiwgIlRlc3QiLCAiQ29uZmlnIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghT2JqZWN0LmtleXMocmV0W2FdKS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlyZXQuRW50aXR5QXR0cmlidXRlcyA9IHJldC5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9ICJpZCIpOwoJCQlyZXR1cm4gcmV0OwoJCX0pOwoJfQoKCWFzeW5jIF9ydW5TZXF1ZW5jZXMoc2Vxcywgc2NvcGUpIHsKCQlsZXQgY2FsbFNlcXVlbmNlcyA9IFtdOwoJCWlmICghc2NvcGUpIHJldHVybiBjYWxsU2VxdWVuY2VzOwoKCQlmb3IgYXdhaXQgKGNvbnN0IHNlcSBvZiBzZXFzKSB7CgkJCWxldCBjYWxsU2VxdWVuY2UgPSB7CgkJCQlhY3RpdmU6IHRydWUsCgkJCQl0aXRsZTogc2VxLnRpdGxlLAoJCQkJY2xhc3NpZmllcjogc2VxLmNsYXNzaWZpZXIsCgkJCQllbnRpdGllczogW10sCgkJCQl0aW1lbGluZTogW10sCgkJCX07CgoJCQlsZXQgX2VudGl0aWVzID0gc2VxLmVudGl0aWVzLmZpbHRlcihlID0+IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCWUub2JqID0gbmV3IHNjb3BlW2UudHlwZV0oKS5fZnJvbURvY3VtZW50KGUuY29udGVudCk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCS8vIGZpcnN0IGxldmVsIHJlZmVyZW5jZSBjbGVhbnVwOiBtYWtlIHN1cmUgb25seSBvbmUgcmVmZXJlbmNlIG9iamVjdCBpcyB1c2VkIHdpdGggdGhlIHNhbWUgIl9uYW1lIi4gbG93ZXIgbGV2ZWxzIHNob3VsZCBiZSBkb25lIHJlY3Vyc2l2ZWx5CgkJCQlzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKF9lYSA9PiBfZWEuTmFtZSA9PSAnbmFtZScgJiYgX2VhLklzU3RyaW5nKSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKGUub2JqWydfJyArIGVhLk5hbWVdKSB7CgkJCQkJCWUub2JqWydfJyArIGVhLk5hbWVdID0gKHNlcS5lbnRpdGllcy5maW5kKF9lID0+IF9lICE9PSBlICYmIF9lLm9iaiAmJiBfZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUgPT0gZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUpIHx8IGUpLm9ialsnXycgKyBlYS5OYW1lXTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJc2VxLnN0ZXBzID0gc2VxLnN0ZXBzLm1hcChzID0+IHsKCQkJCWlmICghcy5faWYpIHJldHVybiBbc107CgkJCQlyZXR1cm4gcy5fdGhlbi5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogdHJ1ZQoJCQkJCX0KCQkJCX0pKS5jb25jYXQocy5fZWxzZS5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogZmFsc2UKCQkJCQl9CgkJCQl9KSkpOwoJCQl9KTsKCQkJc2VxLnN0ZXBzID0gW10uY29uY2F0LmFwcGx5KFtdLCBzZXEuc3RlcHMpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIHNlcS5zdGVwcykgewoJCQkJaWYgKHMuaWdub3JlKSBjb250aW51ZTsKCgkJCQlsZXQgX2Zyb20gPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IHMuZnJvbSk7CgkJCQlpZiAoIV9mcm9tKSB7CgkJCQkJY29uc29sZS5sb2coIk1pc3NpbmcgRW50aXR5IERlZmluaXRpb246ICIgKyBzLmZyb20pOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJX2Zyb20gPSBfZnJvbS5vYmo7CgoJCQkJdHJ5IHsKCQkJCQlzLnBhcmFtcyA9IE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhzLnBhcmFtcykubWFwKGV0ID0+IHsKCQkJCQkJaWYgKGV0WzFdICYmIGV0WzFdLm5hbWUpIHsKCQkJCQkJCWxldCBvYmogPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IGV0WzFdLm5hbWUpOwoJCQkJCQkJcmV0dXJuIG9iaiA/IFtldFswXSwgb2JqLm9ial0gOiBldDsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldHVybiBldDsKCQkJCQkJfQoJCQkJCX0pKTsKCgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgX2Zyb21bcy5tZXRob2RdKC4uLk9iamVjdC52YWx1ZXMocy5wYXJhbXMpKTsKCgkJCQkJCXMuX21ldGhvZCA9IHMubWV0aG9kLmluZGV4T2YoJy4nKSA+IDAgPyBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID09IF9mcm9tLkVudGl0eUNsYXNzLklkKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2QpIDogc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMF0pLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzFdKTsKCQkJCQl9IGNhdGNoIChfZXgpIHt9CgoJCQkJCS8vIG5vdCBkZWZpbmVkIHRvIHdoaWNoIGVudGl0eSB0aGlzIGlzIGdvaW5nLCBmaW5kIGZpcnN0IGVudGl0eSBpbiB0aGUgcGFyYW1ldGVycywgb3RoZXJ3aXNlIGl0IGlzIGEgbG9vcCB0byBteXNlbGYKCQkJCQlsZXQgX3RvID0gKE9iamVjdC52YWx1ZXMocy5wYXJhbXMpIHx8IFtdKS5maW5kKHAgPT4gcCAmJiBwLkVudGl0eUNsYXNzKSB8fCBfZnJvbTsKCgkJCQkJY2FsbFNlcXVlbmNlLmVudGl0aWVzID0gY2FsbFNlcXVlbmNlLmVudGl0aWVzLmNvbmNhdChbX2Zyb20sIF90b10pLmZpbHRlcihlID0+IGUpLmZpbHRlcigob2JqLCBwb3MsIGFycikgPT4gewoJCQkJCQlyZXR1cm4gYXJyLm1hcChtYXBPYmogPT4gbWFwT2JqKS5pbmRleE9mKG9iaikgPT09IHBvczsKCQkJCQl9KTsKCgkJCQkJbGV0IHNPYmogPSB7CgkJCQkJCWRhdGU6IG5ldyBEYXRlKCksCgkJCQkJCWZyb206IF9mcm9tLAoJCQkJCQl0bzogX3RvLAoJCQkJCQlhY3RpdmF0ZTogcy5hY3RpdmF0ZSwKCQkJCQkJcGFyYW1zOiBzLnBhcmFtcywKCQkJCQkJbWV0aG9kOiBzLm1ldGhvZCwKCQkJCQkJX2lmOiBzLl9pZiwKCQkJCQl9OwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5wdXNoKHNPYmopOwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5zb3J0KChhLCBiKSA9PiBhLmRhdGUgPCBiLmRhdGUpOwoKCQkJCQlpZiAoX2Zyb20gIT09IF90byAmJiAodHlwZW9mKHMuYWN0aXZhdGUpID09PSAndW5kZWZpbmVkJyB8fCBzLmFjdGl2YXRlKSkgewoJCQkJCQkvLyBpcyB0aGlzIGNhbGwgY2xvc2luZyBhbiBhY3RpdmF0aW9uPyB0aGVuIGRlZmluZSBpdCBhcyBhY3RpdmF0ZWQgaW4gdGhlIGluaXRpYWwgY2FsbAoJCQkJCQlsZXQgaW5pdCA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKHQgPT4gdC5mcm9tID09IHNPYmoudG8gJiYgdC50byA9PSBzT2JqLmZyb20gJiYgdC5kYXRlIDwgc09iai5kYXRlICYmICF0LmFjdGl2YXRpbmcpOwoJCQkJCQlpZiAoaW5pdCkgewoJCQkJCQkJaW5pdC5hY3RpdmF0aW5nID0gc09iajsKCQkJCQkJfQoJCQkJCX0KCQkJCQlhd2FpdCB0aGlzLl93YWl0KHMud2FpdCB8fCBzZXEud2FpdCk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKF9mcm9tLCBzLCBleCk7CgkJCQl9CgkJCX0KCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZvckVhY2goKHQsIGkpID0+IHsKCQkJCXQuZnJvbSA9IHQuZnJvbSB8fCAibnVsbCI7CgkJCQl0LnRvID0gdC50byB8fCAibnVsbCI7CgkJCQl0Ll9wcmV2aW91cyA9IGkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSAtIDFdIDogbnVsbDsKCQkJCXQuX25leHQgPSAoaSA8IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5sZW5ndGggLSAxKSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpICsgMV0gOiBudWxsOwoJCQkJdC5fYWN0aXZhdG9yID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQoX3QgPT4gX3QuYWN0aXZhdGluZyA9PSB0KTsKCQkJfSk7CgoJCQljYWxsU2VxdWVuY2VzLnB1c2goY2FsbFNlcXVlbmNlKTsKCQl9CgoJCXJldHVybiBjYWxsU2VxdWVuY2VzOwoJfQoKCWFzeW5jIF93YWl0KG1zKSB7CgkJYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7Cgl9CgoJX2ZpbGVUeXBlKGJhc2U2NCkgewoJCXZhciBiaW5hcnlfc3RyaW5nID0gdGhpcy5fYXRvYihiYXNlNjQpOwoJCXZhciBsZW4gPSBiaW5hcnlfc3RyaW5nLmxlbmd0aDsKCQl2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheShsZW4pOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJYnl0ZXNbaV0gPSBiaW5hcnlfc3RyaW5nLmNoYXJDb2RlQXQoaSk7CgkJfQoKCQl2YXIgYXJyID0gKG5ldyBVaW50OEFycmF5KGJ5dGVzLmJ1ZmZlcikpLnN1YmFycmF5KDAsIDQpOwoJCXZhciBoZWFkZXIgPSAnJzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewoJCQloZWFkZXIgKz0gYXJyW2ldLnRvU3RyaW5nKDE2KTsKCQl9CgoJCS8vIENoZWNrIHRoZSBmaWxlIHNpZ25hdHVyZSBhZ2FpbnN0IGtub3duIHR5cGVzCgkJdmFyIHR5cGUgPSAndW5rbm93bic7CgkJc3dpdGNoIChoZWFkZXIpIHsKCQkJY2FzZSAnODk1MDRlNDcnOgoJCQkJdHlwZSA9ICdpbWFnZS9wbmcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzQ3NDk0NjM4JzoKCQkJCXR5cGUgPSAnaW1hZ2UvZ2lmJzsKCQkJCWJyZWFrOwoJCQljYXNlICdmZmQ4ZmZlMCc6CgkJCWNhc2UgJ2ZmZDhmZmUxJzoKCQkJY2FzZSAnZmZkOGZmZTInOgoJCQkJdHlwZSA9ICdpbWFnZS9qcGVnJzsKCQkJCWJyZWFrOwoJCQljYXNlICcyNTUwNDQ0Nic6CgkJCQl0eXBlID0gJ2FwcGxpY2F0aW9uL3BkZic7CgkJCQlicmVhazsKCQkJY2FzZSAnM2M3Mzc2NjcnOgoJCQkJdHlwZSA9ICdpbWFnZS9zdmcreG1sJzsKCQkJCWJyZWFrOwoJCX0KCQlyZXR1cm4gdHlwZTsKCX0KCglpbWcoZEltZywgbWltZVR5cGUpIHsKCQlyZXR1cm4gYGRhdGE6JHttaW1lVHlwZSB8fCB0aGlzLl9maWxlVHlwZShkSW1nKX07YmFzZTY0LGAgKyBkSW1nOwoJfQoKCV9mdWxsU2NyZWVuKGVsZW0pIHsKCQl0cnkgewoJCQlpZiAoZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIFNhZmFyaSAqLwoJCQkJZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogSUUxMSAqLwoJCQkJZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJfQoKCV9jb3B5VGV4dFRvQ2xpcGJvYXJkKHRleHQpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuY29weSkgPT09ICdmdW5jdGlvbicpIHsKCQkJd2luZG93LmNvcHkodGV4dCk7CgkJfSBlbHNlIGlmICghbmF2aWdhdG9yLmNsaXBib2FyZCkgewoJCQl2YXIgdGV4dEFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZXh0YXJlYSIpOwoJCQl0ZXh0QXJlYS52YWx1ZSA9IHRleHQ7CgoJCQkvLyBBdm9pZCBzY3JvbGxpbmcgdG8gYm90dG9tCgkJCXRleHRBcmVhLnN0eWxlLnRvcCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUubGVmdCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUucG9zaXRpb24gPSAiZml4ZWQiOwoKCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0QXJlYSk7CgkJCS8vdGV4dEFyZWEuZm9jdXMoKTsKCQkJdGV4dEFyZWEuc2VsZWN0KCk7CgoJCQl0cnkgewoJCQkJdmFyIHN1Y2Nlc3NmdWwgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwoJCQkJdmFyIG1zZyA9IHN1Y2Nlc3NmdWwgPyAnc3VjY2Vzc2Z1bCcgOiAndW5zdWNjZXNzZnVsJzsKCQkJCWNvbnNvbGUubG9nKCdGYWxsYmFjazogQ29weWluZyB0ZXh0IGNvbW1hbmQgd2FzICcgKyBtc2cpOwoJCQl9IGNhdGNoIChlcnIpIHsKCQkJCWNvbnNvbGUuZXJyb3IoJ0ZhbGxiYWNrOiBPb3BzLCB1bmFibGUgdG8gY29weScsIGVycik7CgkJCX0KCgkJCWRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dEFyZWEpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQluYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KS50aGVuKGZ1bmN0aW9uKCkgewoJCQkJCWNvbnNvbGUubG9nKCdBc3luYzogQ29weWluZyB0byBjbGlwYm9hcmQgd2FzIHN1Y2Nlc3NmdWwhJyk7CgkJCQkJcmVzb2x2ZSgpOwoJCQkJfSwgZnVuY3Rpb24oZXJyKSB7CgkJCQkJY29uc29sZS5lcnJvcignQXN5bmM6IENvdWxkIG5vdCBjb3B5IHRleHQ6ICcsIGVycik7CgkJCQkJcmVqZWN0KGVycik7CgkJCQl9KTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGV4dDsKCX0KCglhc3luYyBfcmVzaXplSW1nKGltZ0Jhc2U2NCwgd2lkdGgsIGhlaWdodCwgbWltZVR5cGUsIHRvX21pbWVUeXBlKSB7CgkJaWYgKGltZ0Jhc2U2NC5zcGxpdCgnLCcpLmxlbmd0aCA+IDEpIHsKCQkJaW1nQmFzZTY0ID0gaW1nQmFzZTY0LnNwbGl0KCcsJylbMV07CgkJfQoJCXZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKCQlpbWcuc3JjID0gdGhpcy5pbWcoaW1nQmFzZTY0LCBtaW1lVHlwZSk7CgoJCS8vIGNyZWF0ZSBhbiBvZmYtc2NyZWVuIGNhbnZhcwoJCXZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKCQkJY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CgoJCS8vIHNldCBpdHMgZGltZW5zaW9uIHRvIHRhcmdldCBzaXplCgkJY2FudmFzLndpZHRoID0gd2lkdGggfHwgaW1nLndpZHRoOwoJCWNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgfHwgaW1nLmhlaWdodDsKCgkJLy8gZHJhdyBzb3VyY2UgaW1hZ2UgaW50byB0aGUgb2ZmLXNjcmVlbiBjYW52YXM6CgkJY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKCQkvLyBlbmNvZGUgaW1hZ2UgdG8gZGF0YS11cmkgd2l0aCBiYXNlNjQgdmVyc2lvbiBvZiBjb21wcmVzc2VkIGltYWdlCgkJcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwodG9fbWltZVR5cGUgfHwgbWltZVR5cGUsIDEpOwoJfQoKCWFzeW5jIF90ZW1wbGF0ZSh0bXAsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKSB7CgkJc2NvcGUgPSBzY29wZSB8fCBjb21wYW55LlNjb3BlOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lIHx8IHRtcC50ZW1wbGF0ZSB8fCB0bXAsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogJz0nCgkJCX0KCQl9KSk7CgkJaWYgKCF0ZW1wbGF0ZSkgcmV0dXJuIG51bGw7CgoJCWxldCBzY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0ZW1wbGF0ZS5TY3JpcHQpOwoJCWxldCBvYmogPSBuZXcgc2NyaXB0KHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYyk7CgoJCXRyeSB7CgkJCW9iai5tYWluICYmIGF3YWl0IG9iai5tYWluKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLm1haW4oKSIsIGV4KTsKCQl9CgoJCXRyeSB7CgkJCW9iai5wcmVJbmplY3QgJiYgYXdhaXQgb2JqLnByZUluamVjdCgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wcmVJbmplY3QoKSIsIGV4KTsKCQl9CgoJCWxldCByZXQgPSB7CgkJCVNjcmlwdDogb2JqLAoJCX07CgoJCWxldCB0Q2FjaGUgPSB7fTsKCQlmb3IgYXdhaXQgKGNvbnN0IGYgb2YgWydCb2R5JywgJ0Zvb3RlcicsICdUaXRsZSddKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKHRlbXBsYXRlW2ZdLm1hdGNoQWxsKC8oXFtcWyU9KS5bXHdcLS5dK1tcLl0odG1wKVtcOlw6XT9bXiglXF1cXSldKltcOlw6XT9bXiglXF1cXSldKiglXF1cXSkvZ20pKV0pIHsKCQkJCWxldCB0TmFtZVBhcnRzID0gbVswXS5yZXBsYWNlKCdbWyU9JywgJycpLnJlcGxhY2UoJyVdXScsICcnKS5yZXBsYWNlKCcudG1wJywgJycpLnNwbGl0KCc6OicpOwoJCQkJbGV0IHROYW1lID0gdE5hbWVQYXJ0c1swXTsKCQkJCWxldCB0RGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwge30pOwoJCQkJaWYgKHROYW1lUGFydHMubGVuZ3RoID4gMSkgewoJCQkJCXREYXRhID0gT2JqZWN0LmFzc2lnbih0RGF0YSwgYXdhaXQgdGhpcy5ydW5TY3JpcHQodE5hbWVQYXJ0c1sxXSkpOwoJCQkJfQoJCQkJbGV0IHQgPSBhd2FpdCB0aGlzLl90ZW1wbGF0ZSh0TmFtZSwgc2NvcGUsIHREYXRhLCBwcnZGdW5jKTsKCQkJCXRDYWNoZVt0TmFtZV0gPSB0Q2FjaGVbdE5hbWVdIHx8IHRbZl07CgkJCQl0ZW1wbGF0ZVtmXSA9IHRlbXBsYXRlW2ZdLnJlcGxhY2UobVswXSwgdENhY2hlW3ROYW1lXSk7CgkJCX0KCgkJCXJldFtmXSA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZVtmXSwgb2JqKTsKCQl9CgkJY29uc29sZS5sb2codENhY2hlKTsKCgkJdHJ5IHsKCQkJb2JqLnBvc3RJbmplY3QgJiYgYXdhaXQgb2JqLnBvc3RJbmplY3QocmV0KTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucG9zdEluamVjdCgpIiwgZXgpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglUZW1wbGF0ZSA9IGNsYXNzIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKCQkJdGhpcy5zY29wZSA9IHNjb3BlOwoJCQl0aGlzLm9TY29wZSA9IHdpbmRvd1tzY29wZV07CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbbk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCXRoaXMucHJ2RnVuYygkKGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJScgc3JjPScke19GckVNRC5fc3ZnQmFzZTY0KHJldC5Cb2R5KX0nLz5gKSk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSA8PCA0KSB8IChiMiA+PiA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgPDwgMikgfCAoYjMgPj4gNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfQoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIGJBc3luYykgewoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIG1vZHVsZSkgewoJCQkJYXdhaXQgdGhpcy5pbXBvcnQobSwgYkFzeW5jKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkge30KCQl2YXIganMgPSBudWxsOwoJCXRyeSB7CgkJCWpzID0gKGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogbW9kdWxlCgkJCX0pKSB8fCAoYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBtb2R1bGUgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJaWYgKCFqcykgewoJCQlqcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBtb2R1bGUuaW5kZXhPZignLycpID49IDAgPyBtb2R1bGUgOiAoQ01TX1JPT1QgKyBtb2R1bGUpCgkJCX0pOwoJCQlpZiAoanMpIGpzID0ganMuU2NyaXB0OwoJCX0KCQlpZiAoIWpzKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMsIGJBc3luYyk7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJLy9uLnJlcXVpcmVkID0gdHJ1ZTsgLy8ubWFwKG4gPT4ge2RlbGV0ZSBuLnJlcXVpcmVkOyByZXR1cm4gbjt9KQoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCgkJCWlmIChsb2FkZXIpIHsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIChBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkuZmlsdGVyKHMgPT4gcykpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChzKTsKCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCB0aGlzLmltcG9ydChzKSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YocykgPT09ICdzdHJpbmcnKSB7CgkJCQkJCWxldCBqc0V4dCA9ICEoWydqc3QnXS5zb21lKGUgPT4gcy5lbmRzV2l0aCgnLicgKyBlKSkpOwoJCQkJCQlpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCS8vIGEgd2ViLXdvcmtlcgoJCQkJCQkJaW1wb3J0U2NyaXB0cyhzKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJiBqc0V4dCkgewoJCQkJCQkJLy8gZG9jdW1lbnQgc2hvdWxkIGxvYWQgdGhlIHNjcmlwdCB3aGVuZXZlciBwb3NzaWJsZQoJCQkJCQkJLypyZXR1cm4gKi8KCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJCQkJCXNjcmlwdC5hc3luYyA9IGZhbHNlOwoJCQkJCQkJCXNjcmlwdC5zcmMgPSBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKTsKCQkJCQkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKGpzRXh0KSByZXR1cm4gcmV0OwoJCQkJCQkJCWlmICghbi5sb2FkKSByZXR1cm4gYXdhaXQgcmVzLnRleHQoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCX0KCglhc3luYyBwb3N0SW5pdCgpIHsKCQl0cnkgewoJCQl3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyID8gd2luZG93LmZyYW1lc1swXS5yZVJlbmRlcigpIDogbnVsbDsKCQl9IGNhdGNoIChleCkge30KCgkJdHJ5IHsKCQkJbGV0IGV2ZW50cyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRXZlbnRzIik7CgkJCWlmICghZXZlbnRzICYmIGNvbXBhbnkuRXZlbnRzKSB7CgkJCQlldmVudHMgPSBhd2FpdCBjb21wYW55LkV2ZW50cygpOwoJCQl9CgkJCShldmVudHMgfHwgW10pLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5mb3JFYWNoKGV2ID0+IHsKCQkJCSQoZXYuX3BhdGgsIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQpLm9uKGV2Ll9ldmVudCwgZXYuX2hhbmRsZXIpOwoJCQl9KTsKCQl9IGNhdGNoIChleCkge30KCX0KCglleGNlbFRvSlNPTihkYXRhLCBzdGFydCwgY291bnQpIHsKCQlpZiAodHlwZW9mKFhMU1gpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIFtdOwoJCXRyeSB7CgkJCXZhciB3b3JrYm9vayA9IFhMU1gucmVhZChkYXRhLCB7CgkJCQl0eXBlOiAnYmluYXJ5JywKCQkJCXNoZWV0Um93czogMCAvKnN0YXJ0ICsgIi0iICsgKHN0YXJ0ICsgY291bnQpKi8KCQkJfSk7CgkJCS8vdmFyIHJhbmdlID0gWExTWC51dGlscy5kZWNvZGVfcmFuZ2Uod29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dWychcmVmJ10pOwoJCQl2YXIgc2hlZXQgPSB3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV07CgkJCXJldHVybiBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLy90aHJvdyBlOwoJCQljb25zb2xlLmxvZygiRVJST1I6IiwgZSk7CgkJCXJldHVybiBbXTsKCQl9Cgl9CgoJYXN5bmMgX3VuemlwKGZpbGUpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJbGV0IGYgPSBhd2FpdCB6aXAubG9hZChmaWxlLCB7CgkJCWJhc2U2NDogdHJ1ZQoJCX0pCgl9CgoJYXN5bmMgX3ppcChmaWxlcykgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlmaWxlcy5mb3JFYWNoKGYgPT4gewoJCQl6aXAuZmlsZShmLm5hbWUsIGYuZmlsZSk7CgkJfSk7CgkJbGV0IHJldCA9IGF3YWl0IHppcC5nZW5lcmF0ZSh7CgkJCXR5cGU6ICdibG9iJywKCQkJY29tcHJlc3Npb246ICJERUZMQVRFIgoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJVXRmOEFycmF5VG9TdHIoYXJyYXkpIHsKCQl2YXIgb3V0LCBpLCBsZW4sIGM7CgkJdmFyIGNoYXIyLCBjaGFyMzsKCgkJb3V0ID0gIiI7CgkJbGVuID0gYXJyYXkubGVuZ3RoOwoJCWkgPSAwOwoJCXdoaWxlIChpIDwgbGVuKSB7CgkJCWMgPSBhcnJheVtpKytdOwoJCQlzd2l0Y2ggKGMgPj4gNCkgewoJCQkJY2FzZSAwOgoJCQkJY2FzZSAxOgoJCQkJY2FzZSAyOgoJCQkJY2FzZSAzOgoJCQkJY2FzZSA0OgoJCQkJY2FzZSA1OgoJCQkJY2FzZSA2OgoJCQkJY2FzZSA3OgoJCQkJCS8vIDB4eHh4eHh4CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDEyOgoJCQkJY2FzZSAxMzoKCQkJCQkvLyAxMTB4IHh4eHggICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgxRikgPDwgNikgfCAoY2hhcjIgJiAweDNGKSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDE0OgoJCQkJCS8vIDExMTAgeHh4eCAgMTB4eCB4eHh4ICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJY2hhcjMgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MEYpIDw8IDEyKSB8CgkJCQkJCSgoY2hhcjIgJiAweDNGKSA8PCA2KSB8CgkJCQkJCSgoY2hhcjMgJiAweDNGKSA8PCAwKSk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBvdXQ7Cgl9CgoJYXN5bmMgX2NvbXByZXNzKHN0cikgewoJCWNvbnN0IGJ5dGVBcnJheSA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwoJCWNvbnN0IGNzID0gbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIik7CgkJY29uc3Qgd3JpdGVyID0gY3Mud3JpdGFibGUuZ2V0V3JpdGVyKCk7CgkJd3JpdGVyLndyaXRlKGJ5dGVBcnJheSk7CgkJd3JpdGVyLmNsb3NlKCk7CgkJcmV0dXJuIG5ldyBSZXNwb25zZShjcy5yZWFkYWJsZSkuYXJyYXlCdWZmZXIoKQoKCQkvLyBDb252ZXJ0IHRoZSBzdHJpbmcgdG8gYSBieXRlIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbc3RyXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJcmV0dXJuIGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7Cgl9CgoJYXN5bmMgX2RlY29tcHJlc3MoY29tcHJlc3NlZEJ5dGVzKSB7CgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW2NvbXByZXNzZWRCeXRlc10pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBkZWNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGRlY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IERlY29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgZGVjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJY29uc3Qgc3RyaW5nQnl0ZXMgPSBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmluZy4KCQlyZXR1cm4gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKHN0cmluZ0J5dGVzKTsKCX0KCglhc3luYyBkb3dubG9hZFNSQ2FjaGUoY29kZSwgZmlsZW5hbWUpIHsKCQkvLyB0byBiZSBtb3ZlZCBvdXQgb2YgdGhpcyBjbGFzcwoJCWNvZGUgPSBjb2RlIHx8IGNvbXBhbnkuQ29kZTsKCQlsZXQgZmlsZXMgPSBhd2FpdCB0aGlzLnNyKCkuXygnQ29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZGFsbCcsIG51bGwsIHsKCQkJQ29kZTogY29kZSArICctJywKCQl9KTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5femlwKGZpbGVzLm1hcChyID0+ICh7CgkJCW5hbWU6IHIuQ29kZS5yZXBsYWNlKGNvZGUgKyAnLScsICcnKSArICcuanMnLAoJCQlmaWxlOiByLlJlc3VsdAoJCX0pKSwgZmlsZW5hbWUgfHwgJ3NyQ2FjaGUuemlwJyk7Cgl9CgoJYXN5bmMgX2dldEJsb2NrKGJsb2NrKSB7CgkJdmFyIGpzID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIikgfHwgYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pOwoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgkJdHJ5IHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgkJdGhpcy5zdGVwKCk7CgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgJ2VuJzsKCQlpZiAoY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMTsKCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5pbXBvcnQoIi4uLy4uLyIgKyAod2luZG93LmJMb2NhbCA/ICIuLi9lbXMvIiA6ICIiKSArICJzY3JpcHQvbW9kdWxlcyIpOwoJCWF3YWl0IHRoaXMucmVxdWlyZSgiTW9kdWxlcyIpOwoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiQ29tcGFueSIpOwoJCWNvbXBhbnkuU2NvcGUgPSBjb21wYW55LlNjb3BlIHx8ICJ3aW5kb3ciOwoJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZSArICI6IGxvYWRpbmcuLi4iOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNlcnZpY2VSb3V0ZXIiKTsKCQl0aGlzLl9pbml0U2VydmljZVJvdXRlcigpOwoKCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoKTsKCgkJYXdhaXQgdGhpcy5faW5pdENvbnRlbnRNYW5hZ2VyKCk7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWxldCBvU2NvcGUgPSB0aGlzLnNyKCkuX19zY29wZShjb21wYW55LlNjb3BlKTsgLy93aW5kb3dbY29tcGFueS5TY29wZV07CgkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQob1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJbGV0IG1jID0gb1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCQlpZiAobWMpIHsKCQkJYXdhaXQgbmV3IG9TY29wZVttYy5OYW1lXSgpLl9zZXJ2ZXIoewoJCQkJbG9hZFRvb2xzOiB0cnVlLAoJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQlpbml0Tm9kZTogdHJ1ZQoJCQl9KTsKCQl9CgkJY29uc29sZS5sb2coIkRvbmUgTG9hZGluZyIpOwoJfQoKCWFzeW5jIF9tYW5pZmVzdChzY29wZSwganNvbikgewoJCXRyeSB7CgkJCWlmICghanNvbikgewoJCQkJanNvbiA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7CgkJCQkJdGVtcGxhdGU6ICJNQU5JRkVTVCIKCQkJCX0sIHNjb3BlKTsKCQkJfQoJCQlsZXQgaHJlZiA9IHRoaXMudG9CYXNlNjQobnVsbCwganNvbiwgJ2FwcGxpY2F0aW9uL21hbmlmZXN0K2pzb24nLCB0cnVlKTsKCQkJaWYgKHRoaXMuX21hbkNzcykgewoJCQkJdGhpcy5fbWFuQ3NzLmF0dHIoImhyZWYiLCBocmVmKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX21hbkNzcyA9IHRoaXMuX2NzcyhocmVmLCAnbWFuaWZlc3QnKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gbG9hZGluZyBtYW5pZmVzdCIsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2V4cG9ydCh0bXAsIHNjb3BlLCBvcHRpb25zID0ge30pIHsKCQlzY29wZSA9IHNjb3BlIHx8IGNvbXBhbnkuU2NvcGU7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCd0ZW1wbGF0ZXMvZC8nfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogd2luZG93W3Njb3BlXSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgJC5nZXQodXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUgPSBjb21wYW55LlNjb3BlKSB7CgkJLy9zY29wZSA9IHNjb3BlIHx8ICJ3aW5kb3ciOwoJCWxldCBlYXMgPSBbXTsKCgkJaWYgKGVjICYmIGVjLmxpYnJhcnkgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJdHJ5IHsKCQkJCWVjID0gYXdhaXQgdGhpcy5yZXF1aXJlKCdTY2hlbWEnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogY29tcGFueS5Db2RlLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCX0KCgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgewoJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCQl9CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKHNjb3BlICE9PSAid2luZG93IikgewoJCQlpZiAodHlwZW9mKHdpbmRvd1tzY29wZV0pICE9PSAidW5kZWZpbmVkIikgewoJCQkJLy8gY2xlYW51cCB0aGUgb2xkIHNjb3BlCgkJCQlkZWxldGUgd2luZG93W3Njb3BlXTsKCQkJfQoJCQl3aW5kb3dbc2NvcGVdID0ge307CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUNsYXNzZXMgPSByZXQ7CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQgPSAoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdCB8fCB7fTsKCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdC5EYXRlID0gdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCgkJaWYgKCFlYXMubGVuZ3RoKSB7CgkJCS8vIGNsYXNzZXMgZnJvbSBKU09OIEFycmF5CgkJCWVhcyA9IGVhcy5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcykpOwoJCX0KCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5FbnRpdHlBdHRyaWJ1dGVzID0gZWFzOwoKCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQlOYW1lOiAiQVBJU3lzdGVtIiwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLnNyKCkuX19zY29wZShzY29wZSk7CgoJCW9TY29wZS5uTmFtZSA9IG9TY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJb1Njb3BlLm5Db2RlID0gb1Njb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCS8vbGV0IGh0bWwgPSBhd2FpdCAkLmdldCgoc3IuYkxvY2FsID8gIi9uYW1tb3VyLmNvbS9lbXMvIiA6ICIiKSArICJzY3JpcHQvRW50aXR5Q2xhc3MuanN0IiArICI/cmFuZD0iICsgTWF0aC5yYW5kb20oKSk7CgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIHsKCQkJbGV0IHNOYW1lID0gbVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpOwoKCQkJaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUoc05hbWUpKTsKCgkJCS8qbGV0IGNvZGUgPSBhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiAoc3IuYkxvY2FsID8gIi9uYW1tb3VyLmNvbS9lbXMvIiA6ICIiKSArICJzY3JpcHQvIiArIG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpICsgIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpLAoJCQkJZGF0YVR5cGU6ICJzY3JpcHQiLAoJCQl9KTsKCQkJaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBjb2RlKTsqLwoJCX0KCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gIiI7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQlhckNsYXNzZXM6IHJldCwKCQkJCWM6IGMsCgkJCQlzY29wZTogc2NvcGUKCQkJfSkgKyAnXG4nICsgb1Njb3BlLm5OYW1lKGMpOwoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSArPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtvU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7b1Njb3BlLm5OYW1lKGMpfSA9ICR7b1Njb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IG9TY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tvU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJCWlmIChjLklzTWFpbikgewoJCQkJLy9hbGlhcy5HZW5lcmljU2VydmljZUFQSSA9IEdlbmVyaWNTZXJ2aWNlQVBJOwoJCQl9CgkJfQoKCQlyZXR1cm4gX2NvZGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lcyA9IHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lcyB8fCB7fTsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9jbG9uZUZ1bmN0aW9uKG8sIGYsIHNjb3BlLCBjKSB7CgkJbGV0IGNvZGUgPSB3aW5kb3dbb11bZl0gPyB3aW5kb3dbb11bZl0udG9TdHJpbmcoKSA6IGAgICAke2Z9KCl7CgkJICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oJHtvfSwgJHtmfSk6IEludmFsaWQgRnVuY3Rpb24gTmFtZScpOwoJICAgIH1gOwoJCWxldCBzID0gY29kZS5yZXBsYWNlKCcpJywgJykgPT4gJyk7CgkJaWYgKHMuaW5kZXhPZignZnVuY3Rpb24nKSA9PSAwIHx8IHMuaW5kZXhPZignYXN5bmMgZnVuY3Rpb24nKSA9PSAwKSB7CgkJCXMgPSBzLnJlcGxhY2UoJ2Z1bmN0aW9uJywgJyAnKTsKCQl9IGVsc2UgewoJCQlzID0gcy5yZXBsYWNlKGYsICcnKTsKCQl9CgoJCWlmIChjLklzTWFpbiAmJiAhd2luZG93W29dW2ZdKSB7CgkJCWNvbnNvbGUubG9nKCdFcnJvciBpbiBfRnJFTUQuX2Nsb25lRnVuY3Rpb24oKTogSW52YWxpZCBGdW5jdGlvbiBOYW1lICcgKyBmKTsKCQl9CgoJCXJldHVybiBgCiAgICAke2Z9KC4uLnBhcmFtcyl7CiAgICAgICAgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LiR7b30pIT09InVuZGVmaW5lZCIpewogICAgICAgICAgICByZXR1cm4gd2luZG93LiR7b30uJHtmfSguLi5wYXJhbXMpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBgICsgKGMuSXNNYWluID8gYHJldHVybiAoJHtzfSkoLi4ucGFyYW1zKTtgIDogYHJldHVybiBuZXcgJHtzY29wZX0uJHt3aW5kb3dbc2NvcGVdLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpfSgpLiR7Zn0oLi4ucGFyYW1zKTtgKSArIGAKICAgICAgICB9Cgl9CmA7Cgl9CgoJX2luaXRTZXJ2aWNlUm91dGVyKCkgewoJCXdpbmRvdy5zciA9IG5ldyBTZXJ2aWNlUm91dGVyKCk7CgoJCXRoaXMuc3IoKS5TdG9yZSA9IGNvbXBhbnkuU3RvcmU7CgkJdGhpcy5zcigpLmluaXQobnVsbCwgY29tcGFueS5saWJyYXJ5IHx8ICJFbnRlcnByaXNlTWFuYWdlciIsIHRydWUsIHRoaXMuYkRlYnVnKTsKCQlpZiAodHlwZW9mIHNyVVJMICE9PSAndW5kZWZpbmVkJykgdGhpcy5zcigpLnNyVVJMID0gc3JVUkw7CgkJdGhpcy5zcigpLmZMb2FkaW5nU3RhcnQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnc2hvdycpOwoJCX07CgkJdGhpcy5zcigpLmZMb2FkaW5nRW5kID0gKCkgPT4gewoJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmxvYWRpbmcoJ2hpZGUnKTsKCQl9OwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHR5cGVvZih1cmwpID09ICJvYmplY3QiKSB7CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiZW5kKCkgd2l0aCBkYXRhIiwgZGF0YSk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQkvL29Db250ZW50LmhpZGUoKTsKCQkJLy9vQ29udGVudC5mYWRlSW4oMTAwMCk7CgkJCWRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmIChjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAoY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAoY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCXJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDApIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiAnTG9hZGluZycsCgkJCQkJbXNnOiAnTG9hZGluZyBkYXRhLi4uJywKCQkJCQlpbnRlcnZhbDogaW50ZXJ2YWwsCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHJldHVybiBmYWxzZTsKCX0KCglhc3luYyByZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCkgewoJCWlmICghZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQpIHRoaXMuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyBvRWxlbWVudC5pbnRlcnZhbCA6IG51bGwpOwoJCXRyeSB7CgkJCWxldCB2ID0gYXdhaXQgbG9hZGVyKGZEYXRhLCBvRWxlbWVudCwgZWRpdG9yKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJbGV0IGRpZmYgPSAwOwoJCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgJiYgZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQuZ2V0VGltZSgpIC0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmID4gMCAmJiBkaWZmIDwgMTAwKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiTm90IGNoYW5nZWQgb24gdGhlIHNlcnZlciIpOwoJCQl9IGVsc2UgewoJCQkJLy8gY29uc29sZS5sb2coIlNlcnZlciBjaGFuZ2UsIHNldHRpbmcgdmFsdWUiLCBkaWZmKTsKCQkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkOwoJCQkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodik7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIExvYWQgZmlsZS5cbiIgKyBleCk7CgkJfQoJCXRoaXMuX2xvYWRpbmcoZmFsc2UpOwoKCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSB7CgkJCS8vYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDAuNSAqIDYwICogMTAwMCkpOwoJCQlhd2FpdCB0aGlzLl93YWl0KDAuNSAqIDYwICogMTAwMCk7CgkJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoJCX0KCX0KCglhc3luYyBPcGVuRWRpdG9yKGUsIGxhbmd1YWdlID0gbyA9PiAiaHRtbCIsIGxvYWRlciA9IG8gPT4ge30sIHNhdmVyID0gKHYsIG8pID0+IHt9LCBmRGF0YSwgb0VsZW1lbnQpIHsKCQl2YXIgZWRpdG9yID0gYWNlLmVkaXQoZSk7CgkJZGVsZXRlIGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTsKCQkvL2FjZS5jb25maWcuc2V0KCdiYXNlUGF0aCcsICcvbm9kZV9tb2R1bGVzL2FjZS1idWlsZHMvc3JjLW1pbi1ub2NvbmZsaWN0Jyk7CgkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUoJycpOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS8nICsgbGFuZ3VhZ2UoZkRhdGEpKTsKCQllZGl0b3Iub24oImNoYW5nZSIsIGUgPT4gewoJCQlsZXQgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQuZ2V0VGltZSgpIC0gc3Iuc2VydmVyRGF0ZSgpLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmIDwgMTAwICYmIGUuc3RhcnQucm93ID09IDAgJiYgZS5zdGFydC5jb2x1bW4gPT0gMCkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGNvbnNvbGUubG9nKCJDaGFuZ2VkIEV2ZW50IiwgZGlmZik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCX0pOwoJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoKCQlpZiAoc2F2ZXIpIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHsKCQkJbmFtZTogJ3NhdmUnLAoJCQliaW5kS2V5OiB7CgkJCQl3aW46ICJDdHJsLVMiLAoJCQkJbWFjOiAiQ21kLVMiCgkJCX0sCgkJCWV4ZWM6IGFzeW5jIGVkaXRvciA9PiB7CgkJCQl2YXIgdmFsdWUgPSB0aGlzLl9iZWF1dGlmeShlZGl0b3IuZ2V0VmFsdWUoKSwgbGFuZ3VhZ2UoZkRhdGEpKTsKCQkJCWlmICh2YWx1ZSAhPSBlZGl0b3Iuc2Vzc2lvbi5nZXRWYWx1ZSgpKSBlZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2YWx1ZSk7CgkJCQlpZiAoc2F2ZXIpIHsKCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQkJCXRpdGxlOiAnUGxlYXNlIHdhaXRpbmcnLAoJCQkJCQkJbXNnOiAnU2F2aW5nIGRhdGEuLi4nLAoJCQkJCQkJaW50ZXJ2YWw6IG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KTsKCX0KCglfYmVhdXRpZnkodmFsdWUsIHR5cGUpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzX2JlYXV0aWZ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBvcHRpb25zID0gewoJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJImU0eCI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoJCQkJdmFsdWUgPSB0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwoJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnLCAnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCXZhbHVlID0ganNfYmVhdXRpZnkodmFsdWUsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHt9CgkJcmV0dXJuIHZhbHVlOwoJfQoKCV9sYW5nKGNvZGUpIHsKCQl3aW5kb3cubGFuZyA9IGNvZGU7CgkJdGhpcy5zZXRVUkwoInBhZ2U9IiArICh0aGlzLmFsbERhdGEucGFnZS5fY29kZSB8fCAnaW5kZXgnKSk7Cgl9CgoJc2VsZWN0MlNSKG9TZWxlY3QpIHsKCQlsZXQgcyA9ICQob1NlbGVjdCk7CgkJbGV0IGNhbGxzID0gW107CgkJaWYgKHRoaXMuc2VsZWN0MlRlbXBsYXRlKSB7CgkJCWNhbGxzLnB1c2godGhpcy5zZWxlY3QyVGVtcGxhdGUpOwoJCX0gZWxzZSB7CgkJCWNhbGxzLnB1c2godGhpcy5zcigpLkdldCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvc2VsZWN0Mi10ZW1wbGF0ZS5odG0iKSkpOwoJCX0KCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQl0aGlzLnNlbGVjdDJUZW1wbGF0ZSA9IHJldFswXTsKCQkJcy5zZWxlY3QyKHsKCQkJCWFqYXg6IHsKCQkJCQl0cmFuc3BvcnQ6IChwYXJhbXMsIHN1Y2Nlc3MsIGZhaWx1cmUpID0+IHsKCQkJCQkJdmFyIGZGaWx0ZXIgPSB0aGlzLnNyKCkucnVuU2NyaXB0KCIobywgc3RhdGUpID0+IHsiICsgcy5kYXRhKCJzcl9maWx0ZXIiKSArICJ9Iik7CgkJCQkJCSQud2hlbih0aGlzLnNyKCkuXyhzLmRhdGEoInNyX21ldGhvZCIpLCBudWxsLCBmRmlsdGVyKHt9LCB0aGlzLnNyKCkucnVuU2NyaXB0KHMuZGF0YSgiY19zdGF0ZSIpKSkpKS50aGVuKHJldCA9PiB7CgkJCQkJCQlzdWNjZXNzKHsKCQkJCQkJCQlwYWdpbmF0aW9uOiB7CgkJCQkJCQkJCW1vcmU6IGZhbHNlCgkJCQkJCQkJfSwKCQkJCQkJCQlyZXN1bHRzOiAkLm1hcChyZXQsIHIgPT4gewoJCQkJCQkJCQlyLmlkID0gci5JZDsKCQkJCQkJCQkJci50ZXh0ID0gci5Ub1N0cmluZzsKCQkJCQkJCQkJcmV0dXJuIHI7CgkJCQkJCQkJfSksCgkJCQkJCQkJdG90YWxzOiByZXQubGVuZ3RoCgkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSwKCQkJCXRlbXBsYXRlUmVzdWx0OiAoX2UsIF9zKSA9PiB7CgkJCQkJcmV0dXJuIHRoaXMuX2luamVjdCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSwgewoJCQkJCQlkYXRhOiBfZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQkJcy5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCQljb25zb2xlLmxvZyhlLnRhcmdldCk7CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2Uuc2VsZWN0MiIsIGUgPT4gewoJCQkJLy92YXIgZGF0YSA9IGUucGFyYW1zLmRhdGE7CgkJCQl2YXIgX3MgPSAkKGUudGFyZ2V0KTsKCQkJfSk7CgkJfSk7Cgl9CgoJYXN5bmMgcHJlQ29tcGlsZShwYWdlLCBsb2NhdGlvbikgewoJCWlmICh0eXBlb2YgQmFiZWwgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mIFJlYWN0ICE9PSAidW5kZWZpbmVkIikgewoJCQlsZXQganN4ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWpzeCA9IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGpzeCA9PT0gbnVsbCB8fCBqc3ggPT09ICIiKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQl2YXIgcmVzID0gbnVsbDsKCQkJdHJ5IHsKCQkJCXJlcyA9IGF3YWl0IEJhYmVsLnRyYW5zZm9ybShqc3gsIHsKCQkJCQlwcmVzZXRzOiBbJ2xhdGVzdCcsICJyZWFjdCJdCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJCYWJlbCIsIGV4KTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXJldHVybiByZXMuY29kZTsKCQl9Cgl9CgoJYXN5bmMgX3Z1ZUNvbXBvbmVudChjb2RlKSB7CgkJaWYgKHR5cGVvZiBWdWUgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCQlyZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgQ01TX1JPT1QpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQlFbnRpdHlPYmplY3Q6IChlb1BhZ2UgPyBlb1BhZ2UudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQl9KTsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gRU1TLCB0cnlpbmcgdGVtcGxhdGVzIik7CgkJCQlwYWdlID0gcmV0WzBdOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBFTVMsIHNvIGdvaW5nIGxvY2FsIik7CgkJCX0KCgkJCWxldCBodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5odG0iKSk7CgkJCWlmIChodG1sICYmICFodG1sLnN0YXR1cykgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGh0bWwgdGVtcGxhdGUgZm91bmQiLCBodG1sKTsKCQkJCXBhZ2UuQm9keSA9IGh0bWw7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaGFzIG5vIGh0bWwgdGVtcGxhdGUiKTsKCQkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlwYWdlLkJvZHkgPSAiPGRpdiBpZD0nZm9ybUNvbXBvbmVudCcvPiI7CgkJCQl9IGVsc2UgewoJCQkJCXBhZ2UuQm9keSA9IHBhZ2UuX2NvbnRlbnQgfHwgIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCQl9CgkJCX0KCgkJCWxldCBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZShwYWdlKTsKCQkJaWYgKCFqcykganMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQlpZiAoIWpzIHx8ICFqcy5vaykganMgPSBudWxsOwoJCQlpZiAoanMgJiYganMub2spIHBhZ2UuU2NyaXB0ID0gYXdhaXQganMudGV4dCgpOwoKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIHNjcmlwdCBpcyIgKyAoanMgPyAnJyA6ICcgbm90JykgKyAiIHJldHJpZXZlZCIpOwoJCQl0aGlzLnN0ZXAoKTsKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQkvL2NvbnNvbGUubG9nKCJwYWdlIEJvZHkiLCBwYWdlLl9ib2R5IHx8IHBhZ2UuQm9keSk7CgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9IHRoaXMuYmxvY2tzLmhlYWRlci5odG1sICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5KSArIHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoanMuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoanMpOwoJCQl9IGVsc2UgewoJCQkJbGV0IHNDb2RlID0ganM7CgkJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQkJfQoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdCgiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyIpOwoJCQl9CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKGpzKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwganMuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoanMpOwoJCX0KCX0KfQ==",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
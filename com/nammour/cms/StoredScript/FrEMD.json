{
	"Id": "38d18bf2505b984323a3d87984842ba6c352fdd3",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "FrEMD",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfY2FtZWxDYXNlKHMpIHsKCQlyZXR1cm4gcy5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIGZ1bmN0aW9uKG1hdGNoLCBpbmRleCkgewoJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7IC8vIG9yIGlmICgvXHMrLy50ZXN0KG1hdGNoKSkgZm9yIHdoaXRlIHNwYWNlcwoJCQlyZXR1cm4gaW5kZXggPT09IDAgPyBtYXRjaC50b0xvd2VyQ2FzZSgpIDogbWF0Y2gudG9VcHBlckNhc2UoKTsKCQl9KS5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJycpOwoJfQoKCV90aXRsZUNhc2UocykgeyAvLyBzci5FbmdsaXNoTmFtZQoJCWNvbnN0IHJlc3VsdCA9IHMucmVwbGFjZSgvKFtBLVpdKS9nLCAiICQxIik7CgkJcmV0dXJuIHJlc3VsdC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHJlc3VsdC5zbGljZSgxKTsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldCh1cmwsIHJhbmQpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gYXdhaXQgZmV0Y2godXJsICsgKHJhbmQgPyAiP3JhbmQ9IiArIE1hdGgucmFuZG9tKCkgOiAnJyksIHsKCQkJCWhlYWRlcnM6IHsKCQkJCQkiQ29udGVudC1UeXBlIjogInRleHQvcGxhaW47Y2hhcnNldD1VVEYtOCIKCQkJCX0KCQkJfSk7CgkJCWlmIChyZXQub2spIHJldHVybiBhd2FpdCByZXQudGV4dCgpOwoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6X2dldCgpOiBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpKT8uU2NyaXB0OwoJCX0gZWxzZSBpZiAoIXRoaXMuYXBpU2VydmVyIHx8ICF0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKSkgewoJCQkvL2NvbnNvbGUubG9nKCJfZ2V0U3RvcmVkU2NyaXB0KCk6IG5vIGFwaVNlcnZlciwgcnVubmluZyBpbiBzY29wZSAiLCB0aGlzLl9fc2NvcGUoKSk7CgkJCXNjcmlwdCA9IGF0b2IoSlNPTi5wYXJzZShhd2FpdCB0aGlzLl9nZXQoYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uYCwgdHJ1ZSkpLnNjcmlwdCk7CgkJfSBlbHNlIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCXJhbmsoY2xhc3NlcykgewoJCQlyZXR1cm4gY2xhc3Nlcy5maWx0ZXIoYyA9PiAhYy5FeHRlbmRzKS5zb3J0KChhLCBiKSA9PiBiLlJhbmsgLSBhLlJhbmspLmNvbmNhdChjbGFzc2VzLmZpbHRlcihjID0+IGMuRXh0ZW5kcyAmJiAhYy5FeHRlbmRzLkV4dGVuZHMpLnNvcnQoKGEsIGIpID0+IGIuUmFuayAtIGEuUmFuaykpLmNvbmNhdChjbGFzc2VzLmZpbHRlcihjID0+IGMuRXh0ZW5kcyAmJiBjLkV4dGVuZHMuRXh0ZW5kcykuc29ydCgoYSwgYikgPT4gYi5SYW5rIC0gYS5SYW5rKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIFsiSXNBcnJheSIsICJJc1VuaXF1ZSJdLmluZGV4T2YoaykgPCAwKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglwYXRoVG9OYW1lKGZOYW1lLCBleHQpIHsKCQlpZiAoZk5hbWUuaW5kZXhPZignLycpID49IDApIGZOYW1lID0gZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnJldmVyc2UoKS5yZWR1Y2UoKHYsIGUpID0+IHYgKyAnX19bJyArIGUpICsgZk5hbWUuc3BsaXQoJy4nKVswXS5zcGxpdCgnLycpLnNsaWNlKDEpLnJlZHVjZSh2ID0+IHYgKyAnXScsICdfX251bGwnKSArICgoZk5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPiAxKSA/ICgnLicgKyBmTmFtZS5zcGxpdCgnLicpWzFdKSA6IGV4dCk7CgkJcmV0dXJuIGZOYW1lOwoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmV4dCA9IG9wdGlvbnMuZXh0IHx8ICdqcyc7CgoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJbGV0IHJldCA9IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgbW9kdWxlKSB7CgkJCQlyZXQucHVzaChhd2FpdCB0aGlzLmltcG9ydChtLCBvcHRpb25zKSk7CgkJCX0KCQkJcmV0dXJuIHJldDsKCQl9CgoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6OmltcG9ydCgiICsgbW9kdWxlICsgIikgRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCV9jb2RlOiBtb2R1bGUKCQl9KTsKCgkJbGV0IGZOYW1lID0gd2luZG93LmJMb2NhbCA/IChtb2R1bGUgKyAiLiIgKyBvcHRpb25zLmV4dCkgOiAoImNvbS9uYW1tb3VyL2Ntcy9IVE1MUGFnZS8iICsgdGhpcy5wYXRoVG9OYW1lKHRoaXMuaGFzaC5zY29wZS5yZXBsYWNlKC9cIC9nLCAnJykudG9Mb3dlckNhc2UoKSArICIvIiArIG1vZHVsZSArICIuanNvbiIpKTsKCgkJcmV0ID0gcmV0IHx8IGF3YWl0IHRoaXMuX2dldChmTmFtZSwgdHJ1ZSk7CgoJCWlmICghcmV0ICYmIHRoaXMuc3IoKSAmJiB0eXBlb2YodGhpcy5zcigpLl8pID09PSAnZnVuY3Rpb24nICYmIHdpbmRvdy5iTG9jYWwpIHJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCVBhZ2U6IG1vZHVsZQoJCX0pOwoKCQljb25zb2xlLmxvZygiRnJFTUQ6OmltcG9ydCgiICsgZk5hbWUgKyAiKTogIiArIChyZXQgPyAiU3VjY2VzcyIgOiAiRmFpbGVkIiksIG9wdGlvbnMpOwoKCQlpZiAocmV0ICYmICghd2luZG93LmJMb2NhbCB8fCBvcHRpb25zLmV4dCA9PSAnanMnKSkgcmV0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocmV0LCBvcHRpb25zLmFzeW5jKTsKCQlpZiAocmV0ICYmIG9wdGlvbnMuZmllbGQgJiYgdHlwZW9mKHJldFtvcHRpb25zLmZpZWxkXSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiBHT1QgSEVSRSIsIHJldCwgb3B0aW9ucyk7CgkJCXJldCA9IHJldFtvcHRpb25zLmZpZWxkXTsKCQkJaWYgKCF3aW5kb3cuYkxvY2FsKSByZXQgPSBhdG9iKHJldCk7CgkJCWlmIChvcHRpb25zLmV4dCA9PSAnanMnKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCX0KCgkJdGhpcy5zdGVwKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQlpZiAobG9hZGVyKSB7CgkJCQkvLyBjb25zb2xlLmxvZygibG9hZGVyKClbIiArIG4ubGliICsgIl06ICIsIHR5cGVvZihuLmxvYWQpKTsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZihuLnNyYykgPT09ICd1bmRlZmluZWQnICYmIG4uc2NyaXB0ICYmICFtb2R1bGVzLmxlbmd0aCkgewoJCQkJaWYgKHR5cGVvZihuLnNjcmlwdCkgPT09ICdmdW5jdGlvbicpIG4uc2NyaXB0ID0gbi5zY3JpcHQoKTsKCQkJCW1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQobi5zY3JpcHQsIG4ubm9SdW4pKTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIChBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkuZmlsdGVyKHMgPT4gcykpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChzKTsKCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCB0aGlzLmltcG9ydChzKSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YocykgPT09ICdzdHJpbmcnKSB7CgkJCQkJCWxldCBqc0V4dCA9ICEoWydqc3QnXS5zb21lKGUgPT4gcy5lbmRzV2l0aCgnLicgKyBlKSkpOwoJCQkJCQlpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCS8vIGEgd2ViLXdvcmtlcgoJCQkJCQkJaW1wb3J0U2NyaXB0cyhzKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJiBqc0V4dCkgewoJCQkJCQkJLy8gZG9jdW1lbnQgc2hvdWxkIGxvYWQgdGhlIHNjcmlwdCB3aGVuZXZlciBwb3NzaWJsZQoJCQkJCQkJLypyZXR1cm4gKi8KCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJCQkJCXNjcmlwdC5hc3luYyA9IGZhbHNlOwoJCQkJCQkJCXNjcmlwdC5zcmMgPSBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKTsKCQkJCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiAiICsgcyk7CgkJCQkJCQkJKGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuYm9keSkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJCQkJCX0pKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2hJbmplY3QpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlhd2FpdCBmZXRjaEluamVjdChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuX2dldChzLCB0cnVlKTsKCQkJCQkJCWlmIChyZXMpIHsKCQkJCQkJCQlpZiAoanNFeHQgfHwgbi5sb2FkKSBtb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocmVzKSk7CgkJCQkJCQkJaWYgKCFqc0V4dCAmJiAhbi5sb2FkKSByZXQgPSByZXM7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl2YXIgY3NzID0gbnVsbDsKCgkJdGhpcy5ibG9ja3NbYmxvY2tdID0gewoJCQlodG1sOiAiIiwKCQkJb2JqOiBudWxsLAoJCX0KCQlpZiAodGhpcy5hcGlTZXJ2ZXIgJiYgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKSkgewoJCQljb25zb2xlLmxvZygiX2dldEJsb2NrKCIgKyBibG9jayArICIpIHVzaW5nIGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyLlNjb3BlKTsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tU3RyaW5nKHRoaXMucGF0aFRvTmFtZSh0aGlzLmFwaVNlcnZlci5TY29wZSArIGJsb2NrLmluZGV4T2YoJy8nKSA+PSAwID8gYmxvY2sgOiAodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAnL2Jsb2NrcycgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrKSkpLmZpbmQoKTsKCQkJaWYgKHApIHsKCQkJCWh0bWwgPSBwLmJvZHkoKSB8fCAnJzsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocC5zY3JpcHQoKSk7CgkJCQljc3MgPSBwLnN0eWxlKCkgfHwgJyc7CgkJCX0KCQl9IGVsc2UgewoJCQlqcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaywgewoJCQkJZXh0OiAnanMnLAoJCQkJZmllbGQ6ICdzY3JpcHQnLAoJCQl9KTsKCgkJCWh0bWwgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2h0bScsCgkJCQlmaWVsZDogJ2JvZHknLAoJCQl9KTsKCQl9CgoJCWlmICghanMgJiYgIWh0bWwgJiYgdHlwZW9mKERGb3JtW3RoaXMuX3RpdGxlQ2FzZShibG9jaykgKyAiQ29tcG9uZW50Il0pID09PSAnZnVuY3Rpb24nKSB7CgkJCWpzID0gd2luZG93W3RoaXMuX3RpdGxlQ2FzZShibG9jaykgKyAiQ29tcG9uZW50Il0gPSBERm9ybVt0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCJdOwoJCQlodG1sID0gIiI7CgoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXRCbG9jaygiICsgYmxvY2sgKyAiKTogdXNpbmcgREZvcm0iLCB0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCIpOwoJCX0KCgkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5vYmogPSBvYmo7CgkJCQkJY29uc29sZS5sb2coIkZyRU1EOjpfZ2V0QmxvY2soIiArIGJsb2NrICsgIik6IENhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbDsKCgkJaWYgKGpzICYmICF0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbYmxvY2sgKyAiQ29tcG9uZW50Il0pIHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSAiPCIgKyBibG9jayArICJDb21wb25lbnQvPiI7CgkJfQoKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgod2luZG93LmJMb2NhbCA/ICIuLi9lbXMvIiA6ICIiKSArICJzY3JpcHQvbW9kdWxlcyIpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogJ01vZHVsZXMnCgkJCQl9KTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoJ0pRdWVyeScpOwoJCX0KCgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCSQod2luZG93KS5vbignaGFzaGNoYW5nZScsIGFzeW5jICgpID0+IHsKCQkJdGhpcy5mcm9tSGFzaCgpOwoJCQlpZiAodGhpcy5hbGxEYXRhICYmIHRoaXMuYWxsRGF0YS5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICE9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlICYmIHRoaXMuZW5kQ2FsbGVkKSB7CgkJCQlpZiAod2luZG93LmZyYW1lcy5sZW5ndGgpIHsKCQkJCQkvLyBmcmFtZS1iYXNlZCB0ZW1wbGF0ZQoJCQkJCWF3YWl0IHRoaXMuaW5pdERPTSgpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjb25zb2xlLmxvZygiRnJFTUQ6OnByZUluaXQoKTogaGFzaGNoYW5nZSB0cmlnZ2VyZWQsIGxvYWRpbmcgcGFnZSAiICsgdGhpcy5oYXNoLnBhZ2UpOwoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiU2NoZW1hIik7CgkJLy9hd2FpdCB0aGlzLnJlcXVpcmUoIkR5bmFGb3JtIik7IGNvbXBhbnkuUmVxdWlyZWQKCgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKSBhd2FpdCBjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCB8fCBbXSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCQl9CgkJfQoKCQkvLyBmYWlsc2FmZQoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCU5hbWU6ICJDb250ZW50IE1hbmFnZXIiLAoJCQlFbmFibGVkOiB0cnVlLAoJCX0pLCAiY29udGVudG1hbmFnZXIiKTsKCgkJYXdhaXQgdGhpcy5fbWFuaWZlc3QoKTsKCgkJY29uc29sZS5sb2coIkRvbmUgTG9hZGluZyIpOwoJfQoKCWFzeW5jIF9tYW5pZmVzdChzY29wZSwganNvbikgewoJCXRyeSB7CgkJCWlmICghanNvbikgewoJCQkJanNvbiA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7CgkJCQkJdGVtcGxhdGU6ICJNQU5JRkVTVCIKCQkJCX0sIHNjb3BlKTsKCQkJfQoJCQlsZXQgaHJlZiA9IHRoaXMudG9CYXNlNjQobnVsbCwganNvbiwgJ2FwcGxpY2F0aW9uL21hbmlmZXN0K2pzb24nLCB0cnVlKTsKCQkJaWYgKHRoaXMuX21hbkNzcykgewoJCQkJdGhpcy5fbWFuQ3NzLmF0dHIoImhyZWYiLCBocmVmKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX21hbkNzcyA9IHRoaXMuX2NzcyhocmVmLCAnbWFuaWZlc3QnKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gbG9hZGluZyBtYW5pZmVzdCIsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2V4cG9ydCh0bXAsIHNjb3BlLCBvcHRpb25zID0ge30pIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5jb250ZW50IHx8IGF3YWl0IHRoaXMuX2dldChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfWAsIHRydWUpOwoJCWxldCByZXQgPSB0aGlzLl9pbmplY3QodGVtcGxhdGUsIHsKCQkJb1Njb3BlOiB0aGlzLl9fc2NvcGUoc2NvcGUpLAoJCQltZTogd2luZG93Lm1lLAoJCQlzY29wZSwKCQkJb3B0aW9ucywKCQl9LCBvcHRpb25zLmVuZ2luZSk7CgoJCWlmICh0aGlzLl9iZWF1dGlmeSkgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCB0bXAubGFuZ3VhZ2UpOwoJCWlmIChyZXQgJiYgdHlwZW9mKHJldC5yZXBsYWNlKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLl9nZXQodXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbiwgYkludCkgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChiSW50KSByZXR1cm4gTWF0aC5mbG9vcihEYXRlLm5vdygpICsgTWF0aC5yYW5kb20oKSk7CgoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQkvL3Njb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoIiArIHNjb3BlICsgIik6IGZhaWxlZCB0byBsb2FkIGNsYXNzZXMuLi4iKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcyk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHRoaXMuX2F0dHIoZWEpKSk7CgkJcmV0LmZpbHRlcihjID0+IGMuRXh0ZW5kcykuZm9yRWFjaChjID0+IGMuRXh0ZW5kcyA9IHJldC5maW5kKF9jID0+IF9jLk5hbWUgPT0gYy5FeHRlbmRzLk5hbWUpKTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6X19zY29wZSgpOiBzY29wZSIsIHNjb3BlKTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5fID8gdGhpcy5zcigpLl9fc2NvcGUoc2NvcGUpIDogdGhpczsKCX0KCglhc3luYyBfYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHJTY29wZSA9IHsKCQkJRW50aXR5Q2xhc3NlczogcmV0LAoJCQlFbnRpdHlBdHRyaWJ1dGVzOiBlYXMsCgkJfTsKCgkJclNjb3BlLm5OYW1lID0gclNjb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlyU2NvcGUubkNvZGUgPSByU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIGh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKSkpOwoKCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gJyc7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9ICIiOwoJCQl0cnkgewoJCQkJY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQkJYzogYywKCQkJCQlzY29wZTogc2NvcGUsCgkJCQkJbk5hbWU6IHJTY29wZS5uTmFtZSwKCQkJCQluQ29kZTogclNjb3BlLm5Db2RlLAoJCQkJfSkgKyAnXG4nICsgclNjb3BlLm5OYW1lKGMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9idWlsZENsYXNzZXMoKTogX2luamVjdCBleGNlcHRpb246ICIgKyBleCk7CgkJCX0KCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtyU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7clNjb3BlLm5OYW1lKGMpfSA9ICR7clNjb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IHJTY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tyU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJfQoKCQlyZXR1cm4gclNjb3BlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKCk7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBkOwoJCW9TY29wZS5fX3RpbWVzID0gb1Njb3BlLl9fdGltZXMgfHwge307CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBvU2NvcGUuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gb1Njb3BlLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHdpbmRvdy5sb2NhdGlvbiA9PT0gd2luZG93LnBhcmVudC5sb2NhdGlvbiAmJiB0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJLy8gaW5zaWRlIGEgd2luZG93CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0gZWxzZSBpZiAodHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCXRoaXMuUmVuZGVyUGFnZSh7CgkJCQlfY29kZTogdXJsLnBhZ2UKCQkJfSwgdXJsKTsKCQl9CgkJbG9jYXRpb24uaGFzaCA9ICIjIiArIHVybDsKCX0KCglmcm9tSGFzaCgpIHsKCQl0aGlzLmhhc2ggPSB7fTsKCQkobG9jYXRpb24uc2VhcmNoICsgbG9jYXRpb24uaGFzaCkucmVwbGFjZSgvIy9nLCAiJiIpLnJlcGxhY2UoL1w/L2csICcnKS5zcGxpdCgiJiIpLmZpbHRlcihlID0+IGUpLmZvckVhY2goZSA9PiB7CgkJCXRyeSB7CgkJCQl0aGlzLmhhc2hbZS5zcGxpdCgiPSIpWzBdXSA9IGUuc3BsaXQoIj0iKVsxXTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfSk7CgkJT2JqZWN0LmtleXModGhpcy5oYXNoKS5mb3JFYWNoKGggPT4gdGhpcy5oYXNoW2hdID0gZGVjb2RlVVJJKHRoaXMuaGFzaFtoXSkpOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSBpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJCUVudGl0eU9iamVjdDogKGMub2JqID8gYy5vYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQkJfSkpOwoJCQl9CgkJfSk7CgkJcmV0dXJuICQud2hlbiguLi5hckNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJJC5lYWNoKHJldCwgKGksIHIpID0+IHsKCQkJCWlmIChyICYmIHIubGVuZ3RoICYmIHJbMF0uT3JkZXIpIHsKCQkJCQlyLnNvcnQoKGEsIGIpID0+IHsKCQkJCQkJaWYgKGEuT3JkZXIgPCBiLk9yZGVyKSByZXR1cm4gLTE7CgkJCQkJCWlmIChhLk9yZGVyID4gYi5PcmRlcikgcmV0dXJuIDE7CgkJCQkJCXJldHVybiAwOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKSB0aGlzLl9jYWxsc1tpXS5DYWxsYmFjayhyKTsKCQkJfSk7CgkJfSkudGhlbigoKSA9PiB7CgkJCXRoaXMuX2NhbGxzID0gW107CgkJfSk7Cgl9CgoJX28oZkNhbGxCYWNrLCBvYmopIHsKCQl0aGlzLnN0ZXAoKTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCwgbXNnLCB0aXRsZSkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6IHRpdGxlIHx8ICdMb2FkaW5nJywKCQkJCQltc2c6IG1zZyB8fCAnTG9hZGluZyBkYXRhLi4uJywKCQkJCQlpbnRlcnZhbDogaW50ZXJ2YWwsCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHJldHVybiBmYWxzZTsKCX0KCglhc3luYyByZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCkgewoJCWlmICghZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQpIHRoaXMuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyBvRWxlbWVudC5pbnRlcnZhbCA6IG51bGwpOwoJCXRyeSB7CgkJCWxldCB2ID0gYXdhaXQgbG9hZGVyKGZEYXRhLCBvRWxlbWVudCwgZWRpdG9yKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJbGV0IGRpZmYgPSAwOwoJCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgJiYgZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQuZ2V0VGltZSgpIC0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmID4gMCAmJiBkaWZmIDwgMTAwKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiTm90IGNoYW5nZWQgb24gdGhlIHNlcnZlciIpOwoJCQl9IGVsc2UgewoJCQkJLy8gY29uc29sZS5sb2coIlNlcnZlciBjaGFuZ2UsIHNldHRpbmcgdmFsdWUiLCBkaWZmKTsKCQkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkOwoJCQkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodik7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIExvYWQgZmlsZS5cbiIgKyBleCk7CgkJfQoJCXRoaXMuX2xvYWRpbmcoZmFsc2UpOwoKCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSB7CgkJCS8vYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDAuNSAqIDYwICogMTAwMCkpOwoJCQlhd2FpdCB0aGlzLl93YWl0KDAuNSAqIDYwICogMTAwMCk7CgkJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoJCX0KCX0KCglhc3luYyBPcGVuRWRpdG9yKGUsIGxhbmd1YWdlID0gbyA9PiAiaHRtbCIsIGxvYWRlciA9IG8gPT4ge30sIHNhdmVyID0gKHYsIG8pID0+IHt9LCBmRGF0YSwgb0VsZW1lbnQpIHsKCQl2YXIgZWRpdG9yID0gYWNlLmVkaXQoZSk7CgkJZGVsZXRlIGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTsKCQkvL2FjZS5jb25maWcuc2V0KCdiYXNlUGF0aCcsICcvbm9kZV9tb2R1bGVzL2FjZS1idWlsZHMvc3JjLW1pbi1ub2NvbmZsaWN0Jyk7CgkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUoJycpOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS8nICsgbGFuZ3VhZ2UoZkRhdGEpKTsKCQllZGl0b3Iub24oImNoYW5nZSIsIGUgPT4gewoJCQlsZXQgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQuZ2V0VGltZSgpIC0gc3Iuc2VydmVyRGF0ZSgpLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmIDwgMTAwICYmIGUuc3RhcnQucm93ID09IDAgJiYgZS5zdGFydC5jb2x1bW4gPT0gMCkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGNvbnNvbGUubG9nKCJDaGFuZ2VkIEV2ZW50IiwgZGlmZik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCX0pOwoJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoKCQlpZiAoc2F2ZXIpIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHsKCQkJbmFtZTogJ3NhdmUnLAoJCQliaW5kS2V5OiB7CgkJCQl3aW46ICJDdHJsLVMiLAoJCQkJbWFjOiAiQ21kLVMiCgkJCX0sCgkJCWV4ZWM6IGFzeW5jIGVkaXRvciA9PiB7CgkJCQl2YXIgdmFsdWUgPSB0aGlzLl9iZWF1dGlmeShlZGl0b3IuZ2V0VmFsdWUoKSwgbGFuZ3VhZ2UoZkRhdGEpKTsKCQkJCWlmICh2YWx1ZSAhPSBlZGl0b3Iuc2Vzc2lvbi5nZXRWYWx1ZSgpKSBlZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2YWx1ZSk7CgkJCQlpZiAoc2F2ZXIpIHsKCQkJCQlfRnJFTUQuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwgJ1NhdmluZyBkYXRhLi4uJywgJ1Byb2dyZXNzJyk7CgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgc2F2ZXIodmFsdWUsIGZEYXRhKTsKCQkJCQkJZWRpdG9yLmxhc3RTYXZlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIFNhdmUgZmlsZS5cbiIgKyBleCk7CgkJCQkJfQoJCQkJCV9GckVNRC5fbG9hZGluZyhmYWxzZSk7CgkJCQl9CgkJCX0KCQl9KTsKCX0KCglfYmVhdXRpZnkodmFsdWUsIHR5cGUpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzX2JlYXV0aWZ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBvcHRpb25zID0gewoJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJImU0eCI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoJCQkJdmFsdWUgPSB0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwoJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnLCAnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCXZhbHVlID0ganNfYmVhdXRpZnkodmFsdWUsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHt9CgkJcmV0dXJuIHZhbHVlOwoJfQoKCV9sYW5nKGNvZGUpIHsKCQl3aW5kb3cubGFuZyA9IGNvZGU7CgkJdGhpcy5zZXRVUkwoInBhZ2U9IiArICh0aGlzLmFsbERhdGEucGFnZS5fY29kZSB8fCAnaW5kZXgnKSk7Cgl9CgoJYXN5bmMgcHJlQ29tcGlsZShwYWdlLCBsb2NhdGlvbikgewoJCWlmICh0eXBlb2YgQmFiZWwgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mIFJlYWN0ICE9PSAidW5kZWZpbmVkIikgewoJCQlsZXQganN4ID0gbnVsbDsKCQkJanN4ID0gYXdhaXQgdGhpcy5fZ2V0KChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giLCB0cnVlKTsKCQkJaWYgKGpzeCA9PT0gbnVsbCB8fCBqc3ggPT09ICIiKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQl2YXIgcmVzID0gbnVsbDsKCQkJdHJ5IHsKCQkJCXJlcyA9IGF3YWl0IEJhYmVsLnRyYW5zZm9ybShqc3gsIHsKCQkJCQlwcmVzZXRzOiBbJ2xhdGVzdCcsICJyZWFjdCJdCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJCYWJlbCIsIGV4KTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXJldHVybiByZXMuY29kZTsKCQl9Cgl9CgoJYXN5bmMgX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJY29uc29sZS5sb2coIlJlbmRlclBhZ2UiLCBwYWdlLCBkYXRhKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMucGFnZXNbaV0uX2NvZGUgPT0gcGFnZS5fY29kZSAmJiB0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSAmJiAodGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgPT0gKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpKSB7CgkJCQljb25zb2xlLmxvZygod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSk7CgkJCQlwYWdlID0gdGhpcy5wYWdlc1tpXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlmICghdGhpcy5zcigpLmJMb2NhbCAmJiAocGFnZS5Cb2R5IHx8IHBhZ2UudG9FbnRpdHlPYmplY3QpKSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBhbHJlYWR5IGxvYWRlZCwgc2VydmluZy4uLiIpOwoJCQkvLyBmb3VuZCB0aGUgcGFnZSBhbmQgaXQgaXMgYW4gb2JqZWN0CgkJCWlmICghcGFnZS5TY3JpcHQpIHsKCQkJCWxldCBlID0gYXdhaXQgdGhpcy5lbmQoKTsKCQkJCXJldHVybiBlOwoJCQl9CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5fZnJvbVN0cmluZyh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkgfHwgJycpLAoJCQkJQm9keTogcC5ib2R5KCkgfHwgJycsCgkJCQlTdHlsZTogcC5zdHlsZSgpIHx8ICcnLAoJCQkJX2NvZGU6IHBhZ2UuX2NvZGUsCgkJCX07CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCIgKyB0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIpIHVzaW5nIGFwaVNlcnZlciIsIHAsIHJldCk7CgkJfQoKCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQlwYWdlLkJvZHkgPSBhd2FpdCB0aGlzLmltcG9ydCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSwgewoJCQkJZXh0OiAnaHRtJywKCQkJCWZpZWxkOiAnYm9keScsCgkJCX0pOwoKCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih2dWUpID09PSAndW5kZWZpbmVkJykgewoJCQkJLy9wYWdlLkJvZHkgPSAvKnBhZ2UuX2NvbnRlbnQgfHwgKi8gIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCX0KCgkJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5pbXBvcnQoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUsIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoKCQkJaWYgKCAvKiFwYWdlLlNjcmlwdCAmJiAhcGFnZS5Cb2R5ICYmICovIHR5cGVvZihERm9ybVt0aGlzLl90aXRsZUNhc2UocGFnZS5fY29kZSkgKyAiQ29tcG9uZW50Il0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQlwYWdlLlNjcmlwdCA9IHdpbmRvd1t0aGlzLl90aXRsZUNhc2UocGFnZS5fY29kZSkgKyAiQ29tcG9uZW50Il0gPSBERm9ybVt0aGlzLl90aXRsZUNhc2UocGFnZS5fY29kZSkgKyAiQ29tcG9uZW50Il07CgkJCQlwYWdlLkJvZHkgPSAiIjsKCgkJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogdXNpbmcgREZvcm0iLCB0aGlzLl90aXRsZUNhc2UocGFnZS5fY29kZSkgKyAiQ29tcG9uZW50Iik7CgkJCX0KCgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgoJCS8vaWYgKHBhZ2UuU2NyaXB0KSBwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl0cnkgewoJCQljdXN0b21FbGVtZW50cy5kZWZpbmUocGFnZS5fY29kZSwgcGFnZS5jb21wb25lbnQgPSB2dWUuZGVmaW5lQ3VzdG9tRWxlbWVudChPYmplY3QuYXNzaWduKG5ldyBwYWdlLlNjcmlwdCgpLCB7CgkJCQl0ZW1wbGF0ZTogcGFnZS5Cb2R5LAoJCQkJc3R5bGVzOiBbcGFnZS5TdHlsZV0KCQkJfSkpKTsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IHBhZ2UgYXMgdnVlanMgY3VzdG9tIGVsZW1lbnQiLCBwYWdlKTsKCQkJcGFnZS5Cb2R5ID0gbnVsbDsKCQkJLy9wYWdlLlNjcmlwdCA9IG51bGw7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IFZ1ZSBFeGNlcHRpb246ICIgKyBleCk7CgkJCXBhZ2UuY29tcG9uZW50ID0gbnVsbDsKCQl9CgoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIgJiYgIXBhZ2UuY29tcG9uZW50KSB7CgkJCXRyeSB7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG5ldyBwYWdlLlNjcmlwdChwYWdlKTsKCQkJCWlmIChwYWdlLmNvbXBvbmVudCAmJiBwYWdlLmNvbXBvbmVudC5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IHBhZ2UuY29tcG9uZW50Lm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBuZXcgcGFnZS5TY3JpcHQoKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coIkZyRU1EOjplbmQoKTogZGF0YSIsIGRhdGEsIHRoaXMuYWxsSFRNTCk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoKCQkJaWYgKHR5cGVvZih2dWUpICE9PSAndW5kZWZpbmVkJyAmJiBwYWdlLmNvbXBvbmVudCAmJiB0eXBlb2YocGFnZS5jb21wb25lbnQuZGVmKSA9PT0gJ29iamVjdCcpIHsKCQkJCWNvbnNvbGUubG9nKCJlbmQoKTogYWRkaW5nIFZ1ZUpTIENvbXBvbmVuZXQgdG8gcGFnZSIsIHBhZ2UpOwoJCQkJb0NvbnRlbnQuYXBwZW5kKG5ldyBwYWdlLmNvbXBvbmVudCgpKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9ICh0aGlzLmJsb2Nrcy5oZWFkZXIuaHRtbCB8fCAnJykgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkgfHwgJycpICsgKHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sIHx8ICcnKTsKCQl0aGlzLmFsbERhdGEgPSB7CgkJCXNldHRpbmdzOiB0aGlzLnNldHRpbmdzLAoJCQlwYWdlOiBfcGFnZSwKCQkJcGFnZXM6IHRoaXMucGFnZXMKCQl9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG9wdGlvbnM7CgoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgkJLy90aGlzLnNldFVSTCgicGFnZT0iICsgX3BhZ2UuX2NvZGUpOwoJCWF3YWl0IHRoaXMuZW5kKG51bGwsIHdpbmRvdy5wYWdlLmRhdGEgfHwgZGF0YSk7Cgl9CgoJYXN5bmMgcnVuU2NyaXB0KGpzLCBiQXN5bmMpIHsKCQlpZiAodHlwZW9mKGpzKSAhPT0gInN0cmluZyIpIHJldHVybiBqczsKCgkJdHJ5IHsKCQkJcmV0dXJuIEpTT04ucGFyc2Uoc0NvZGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQlsZXQgc0NvZGUgPSBqczsKCQlpZiAoc0NvZGUuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCX0gZWxzZSB7CgkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJc0NvZGUgPSAicmV0dXJuICIgKyBzQ29kZTsKCQkJfQoJCQlzQ29kZSA9ICIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7IjsKCQl9CgoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KHNDb2RlKTsKCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2Eoc0NvZGUpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBzQ29kZS5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChzQ29kZSk7CgkJfQoJfQp9Ow==",
	"Name": "FrEMD",
	"Script": "",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
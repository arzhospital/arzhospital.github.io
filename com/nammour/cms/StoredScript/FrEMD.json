{
	"Id": "44c7ae214e39e7614fe3a0dedf559703037bd4db",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IGF0b2IoKGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ1N0b3JlZFNjcmlwdCcpLm5hbWUocy5OYW1lIHx8IHMubmFtZSkuZmluZCgpKS5zY3JpcHQoKSk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCBhdG9iKHRlbXBsYXRlLnNjcmlwdCgpKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJaWYgKHRmICYmIHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gYXRvYih0Zik7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKHRmLm1hdGNoQWxsKC8oXFtcWyU9KS5bXHdcLS5dK1tcLl0odG1wKVtcOlw6XT9bXiglXF1cXSldKltcOlw6XT9bXiglXF1cXSldKiglXF1cXSkvZ20pKV0pIHsKCQkJCWxldCB0TmFtZVBhcnRzID0gbVswXS5yZXBsYWNlKCdbWyU9JywgJycpLnJlcGxhY2UoJyVdXScsICcnKS5yZXBsYWNlKCcudG1wJywgJycpLnNwbGl0KCc6OicpOwoJCQkJbGV0IHROYW1lID0gdE5hbWVQYXJ0c1swXTsKCQkJCWxldCB0RGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwge30pOwoJCQkJaWYgKHROYW1lUGFydHMubGVuZ3RoID4gMSkgewoJCQkJCXREYXRhID0gT2JqZWN0LmFzc2lnbih0RGF0YSwgYXdhaXQgdGhpcy5ydW5TY3JpcHQodE5hbWVQYXJ0c1sxXSkpOwoJCQkJfQoJCQkJbGV0IHQgPSBhd2FpdCB0aGlzLl90ZW1wbGF0ZSh0TmFtZSwgc2NvcGUsIHREYXRhLCBwcnZGdW5jKTsKCQkJCXRDYWNoZVt0TmFtZV0gPSB0Q2FjaGVbdE5hbWVdIHx8IHRbZl07CgkJCQl0ZiA9IHRmLnJlcGxhY2UobVswXSwgdENhY2hlW3ROYW1lXSk7CgkJCX0KCgkJCXJldFtmXSA9IHRoaXMuX2luamVjdCh0Ziwgb2JqKTsKCQl9CgkJY29uc29sZS5sb2codENhY2hlKTsKCgkJdHJ5IHsKCQkJb2JqLnBvc3RJbmplY3QgJiYgYXdhaXQgb2JqLnBvc3RJbmplY3QocmV0KTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucG9zdEluamVjdCgpIiwgZXgpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglUZW1wbGF0ZSA9IGNsYXNzIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKCQkJdGhpcy5zY29wZSA9IHNjb3BlOwoJCQl0aGlzLm9TY29wZSA9IF9GckVNRC5fX3Njb3BlKHNjb3BlKTsKCgkJCXRoaXMubmMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ05vZGUnKTsKCQkJdGhpcy5zYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnU3RvcmVkU2NyaXB0Jyk7CgkJCXRoaXMuZWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ0V2ZW50Jyk7CgkJCXRoaXMubWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklzTWFpbik7CgoJCQl0aGlzLmRTY29wZSA9ICh0aGlzLm5jICYmIHRoaXMubmMuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMubmMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJdGhpcy5jbVNjb3BlID0gKHRoaXMuc2MgJiYgdGhpcy5zYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5zYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJdGhpcy5kYXRhID0gZGF0YTsKCgkJCXRoaXMubk5hbWUgPSB0aGlzLm9TY29wZS5uTmFtZTsKCQkJdGhpcy5jTmFtZSA9IHRoaXMub1Njb3BlLmNOYW1lOwoJCQl0aGlzLm5Db2RlID0gdGhpcy5vU2NvcGUubkNvZGU7CgoJCQl0aGlzLnBydkZ1bmMgPSBwcnZGdW5jIHx8ICgoKSA9PiB7fSk7CgkJCXRoaXMubVJhbmsgPSAwOwoKCQkJaWYgKGJSYW5rKSB0aGlzLm1SYW5rID0gTWF0aC5tYXgoMCwgLi4udGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlJhbmspKTsgLy8gdXNlZnVsIGluIHRlbXBsYXRlcwoKCQkJdGhpcy5tYWluVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuc3BsaXQoJy0nKVswXTsKCQkJdGhpcy5zdWJUaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5pbmRleE9mKCctJykgPj0gMCA/IGRhdGEuVGl0bGUuc3BsaXQoJy0nKVsxXSA6ICIiOwoJCX0KCgkJX25ldyhjLCB0b29sLCBpZCkgewoJCQlpZiAoIWMpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKTsKCQkJaWYgKHR5cGVvZihjKSA9PT0gJ3N0cmluZycpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBjKTsKCQkJaWYgKCFjKSByZXR1cm4gbnVsbDsKCgkJCWxldCBtU2NvcGUgPSBjLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKGMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXJldHVybiBuZXcobVNjb3BlW3RoaXMub1Njb3BlLm5OYW1lKGMpXSkoaWQsIHRvb2wpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJY25mKF9jLCBpZCwgZGlkLCB0b29sKSB7CgkJCV9jID0gX2MgfHwgdGhpcy5tYzsKCQkJbGV0IG1TY29wZSA9IF9jLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKF9jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXJldHVybiBtU2NvcGUuX25vZGUgPyBtU2NvcGUuX25vZGUuX19jb25maWcoaWQsIGRpZCwgewoJCQkJdG9vbDogdG9vbAoJCQl9KSA6ICh0aGlzLl9uZXcoX2MsIHRvb2wpLl9fY29uZmlnKGlkLCBkaWQsIHRvb2wgPyB7CgkJCQl0b29sOiB0b29sCgkJCX0gOiB1bmRlZmluZWQpKTsKCQl9CgoJCW5UeXBlKGVhKSB7CgkJCWlmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Jvb2wpIHsKCQkJCXJldHVybiAiYm9vbGVhbiI7CgkJCX0gZWxzZSBpZiAoZWEuSXNGbG9hdCkgewoJCQkJcmV0dXJuICJmbG9hdCI7CgkJCX0gZWxzZSBpZiAoZWEuSXNJbnQgfHwgZWEuSXNMb25nKSB7CgkJCQlyZXR1cm4gIm51bWJlciI7CgkJCX0gZWxzZSBpZiAoZWEuSXNEYXRlKSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCgkJX3QocHJvcCwgb2JqLCBzZWFyY2gpIHsKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBvYmpbcHJvcF07CgoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl90IiwgZXgpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0U1ZHKHJldCkgewoJCQlsZXQgb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQlvRGl2LmlkID0gJ3N2Z1JlbmRlcmVyJzsKCQkJbGV0IHN2ZyA9IChhd2FpdCBtZXJtYWlkLnJlbmRlcihvRGl2LmlkLCByZXQuQm9keSkpLnN2ZzsKCQkJdGhpcy5wcnZGdW5jKGA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7d2lkdGg6MTAwJTsgaGVpZ2h0OiAxMDAlJz4ke3N2Z308L3N2Zz5gKTsKCQl9CgoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWF3YWl0IHRoaXMucHJ2RnVuYyhgPGRpdj4ke3JldC5Cb2R5fTwvZGl2PmApOwoJCX0KCgkJYXN5bmMgZGVwbG95KHJldCwgdHlwZU5hbWUsIGxhbmcpIHsKCQkJdHlwZU5hbWUgPSB0eXBlTmFtZSB8fCAiQnJvd3NlciI7CgkJCWxldCBzID0gcmV0LkJvZHk7CgkJCWlmIChsYW5nKSBfRnJFTUQuX2JlYXV0aWZ5KHJldC5Cb2R5LCBsYW5nKTsKCgkJCWlmICh0aGlzLm5jKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuZFNjb3BlLk5vZGVfVHlwZShudWxsLCAnR2l0SHViJykuY29kZSh0eXBlTmFtZS50b0xvd2VyQ2FzZSgpKS5uYW1lKHR5cGVOYW1lKS5yZW1hcmsocykuc3RvcmUoKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNjKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuY21TY29wZS5TdG9yZWRTY3JpcHQobnVsbCwgJ0dpdEh1YicpLmFjdGl2ZSh0cnVlKS5uYW1lKHR5cGVOYW1lKS5zY3JpcHQocykuc3RvcmUoKTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCdkZXBsb3koKTogTm8gZGVwbG95bWVudCBtb2R1bGUnKTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFRhYmxlKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoYAo8ZGl2IGlkID0gImR2UG9zdEluamVjdCIgc3R5bGU9J292ZXJmbG93WT1zY3JvbGwnPmAgKwoJCQkJREZvcm0ucmVuZGVyRWxlbWVudHModGhpcy5lbGVtZW50cy5tYXAoKHMsIGkpID0+ICh7CgkJCQkJbmFtZTogYFJPVyR7aX1gLAoJCQkJCXRpdGxlOiAnICcsCgkJCQkJdHlwZTogImdyaWQiLAoJCQkJCXdpZHRoOiAiMTAwJSIsCgkJCQkJcm93TnVtYmVyczogZmFsc2UsCgkJCQkJcGFnaW5hdGlvbjogZmFsc2UsCgkJCQkJZnJvemVuOiBbXSwKCQkJCQljb2x1bW5zOiBbewoJCQkJCQl0aXRsZTogIlByb3BlcnR5IiwKCQkJCQkJd2lkdGg6ICIzMCUiLAoJCQkJCX0sIHsKCQkJCQkJdGl0bGU6ICJEZXNjcmlwdGlvbiIsCgkJCQkJCXdpZHRoOiAiNzAlIiwKCQkJCQl9XSwKCQkJCQlkYXRhOiBPYmplY3QuZW50cmllcyhzKS5tYXAoZSA9PiAoewoJCQkJCQlQcm9wZXJ0eTogZVswXSwKCQkJCQkJRGVzY3JpcHRpb246IGVbMV0KCQkJCQl9KSksCgkJCQl9KSkpICsgYDwvZGl2Pgo8c2NyaXB0PgoJc2V0VGltZW91dCgoKSA9PiAkLnBhcnNlci5wYXJzZSgiI2R2UG9zdEluamVjdCIpLCAxMDApOwo8L3NjcmlwdD5gKTsKCQl9Cgl9OwoKCVByb3h5Tm9kZVRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXN1cGVyKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspOwoJCX0KCgkJYXN5bmMgcHJlSW5qZWN0KCkgewoJCQl0aGlzLnVybFJlZ2V4ID0gYCgoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KWA7CgkJfQoKCQljcnVkTWV0aG9kcyhjLCB0eXBlKSB7CgkJCXJldHVybiBbewoJCQkJTmFtZTogJ3N0b3JlJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZEFsbCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUlzQXJyYXk6IHRydWUsCgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfV0ubWFwKG0gPT4gewoJCQkJbVt0eXBlXSA9IGNbdHlwZV0gPyBjW3R5cGVdW20uTmFtZV0gOiBudWxsOwoJCQkJbS5Jc1B1YmxpYyA9IHRydWU7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBbXTsKCQkJCXJldHVybiBtOwoJCQl9KTsKCQl9Cgl9OwoKCVBsYW50VU1MVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWxldCBodG1sID0gcmV0LkJvZHkucmVwbGFjZSgvQGVuZHVtbC9nLCBgbGVmdCBmb290ZXIgJHsnXHUwMEE5J30ke25ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKX0gJHt0aGlzLmRhdGEuQ29weXJpZ2h0IHx8ICdGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIGJBc3luYykgewoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIG1vZHVsZSkgewoJCQkJYXdhaXQgdGhpcy5pbXBvcnQobSwgYkFzeW5jKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkge30KCQl2YXIganMgPSBudWxsOwoJCXRyeSB7CgkJCWpzID0gKGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogbW9kdWxlCgkJCX0pKSB8fCAoYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBtb2R1bGUgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJaWYgKCFqcykgewoJCQlqcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBtb2R1bGUuaW5kZXhPZignLycpID49IDAgPyBtb2R1bGUgOiAoQ01TX1JPT1QgKyBtb2R1bGUpCgkJCX0pOwoJCQlpZiAoanMpIGpzID0ganMuU2NyaXB0OwoJCX0KCQlpZiAoIWpzKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMsIGJBc3luYyk7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQlpZiAobG9hZGVyKSB7CgkJCQkvLyBjb25zb2xlLmxvZygibG9hZGVyKClbIiArIG4ubGliICsgIl06ICIsIHR5cGVvZihuLmxvYWQpKTsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZihuLnNyYykgPT09ICd1bmRlZmluZWQnICYmIG4uc2NyaXB0ICYmICFtb2R1bGVzLmxlbmd0aCkgewoJCQkJaWYgKHR5cGVvZihuLnNjcmlwdCkgPT09ICdmdW5jdGlvbicpIG4uc2NyaXB0ID0gbi5zY3JpcHQoKTsKCQkJCW1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQobi5zY3JpcHQsIG4ubm9SdW4pKTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIChBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkuZmlsdGVyKHMgPT4gcykpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChzKTsKCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCB0aGlzLmltcG9ydChzKSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YocykgPT09ICdzdHJpbmcnKSB7CgkJCQkJCWxldCBqc0V4dCA9ICEoWydqc3QnXS5zb21lKGUgPT4gcy5lbmRzV2l0aCgnLicgKyBlKSkpOwoJCQkJCQlpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCS8vIGEgd2ViLXdvcmtlcgoJCQkJCQkJaW1wb3J0U2NyaXB0cyhzKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJiBqc0V4dCkgewoJCQkJCQkJLy8gZG9jdW1lbnQgc2hvdWxkIGxvYWQgdGhlIHNjcmlwdCB3aGVuZXZlciBwb3NzaWJsZQoJCQkJCQkJLypyZXR1cm4gKi8KCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJCQkJCXNjcmlwdC5hc3luYyA9IGZhbHNlOwoJCQkJCQkJCXNjcmlwdC5zcmMgPSBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKTsKCQkJCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiAiICsgcyk7CgkJCQkJCQkJKGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuYm9keSkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJCQkJCX0pKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2hJbmplY3QpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlhd2FpdCBmZXRjaEluamVjdChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJbGV0IHJlcyA9IGF3YWl0IGZldGNoKG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJCWlmIChyZXMub2spIHsKCQkJCQkJCQlpZiAoanNFeHQgfHwgbi5sb2FkKSBtb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoYXdhaXQgcmVzLnRleHQoKSkpOwoJCQkJCQkJCWlmICghanNFeHQgJiYgIW4ubG9hZCkgcmV0ID0gYXdhaXQgcmVzLnRleHQoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiAnJzsKCQkJCQlqcyA9IHAuc2NyaXB0KCkgPyBwLl9hdG9iKHAuc2NyaXB0KCkpIDogbnVsbDsKCQkJCQljb25zb2xlLmxvZygiX2dldEJsb2NrKCIgKyBibG9jayArICIpOiBwIiwgaHRtbCwganMpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWpzKSBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogYmxvY2sKCQkJfSwgImJsb2NrcyIpOwoKCQkJaWYgKCFqcyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmpzIikpOwoJCQkJanMgPSBqcy5vayA/IChhd2FpdCBqcy50ZXh0KCkpIDogbnVsbDsKCQkJfQoKCQkJaWYgKGpzKSB7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzKTsKCQkJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5vYmogPSBvYmo7CgkJCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQlpZiAoIWh0bWwgJiYgd2luZG93LmJMb2NhbCkgewoJCQlodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuaHRtIikpOwoJCQlodG1sID0gaHRtbC5vayA/IChhd2FpdCBodG1sLnRleHQoKSkgOiAnJzsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sOwoJCX0KCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgkJdGhpcy5zdGVwKCk7CgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMSAmJiAhd2luZG93LmZyYW1lcy5sZW5ndGg7CgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgiTW9kdWxlcyIpOwoJCX0gZWxzZSB7CgkJCWlmICh3aW5kb3cuYkxvY2FsKSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5pbXBvcnQoIi4uLy4uLyIgKyAod2luZG93LmJMb2NhbCA/ICIuLi9lbXMvIiA6ICIiKSArICJzY3JpcHQvbW9kdWxlcyIpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogJ01vZHVsZXMnCgkJCQl9KTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoJ0pRdWVyeScpOwoJCX0KCgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCSQod2luZG93KS5vbignaGFzaGNoYW5nZScsIGFzeW5jICgpID0+IHsKCQkJdGhpcy5mcm9tSGFzaCgpOwoJCQlpZiAodGhpcy5hbGxEYXRhICYmIHRoaXMuYWxsRGF0YS5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICYmIHRoaXMuaGFzaC5wYWdlICE9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlICYmIHRoaXMuZW5kQ2FsbGVkKSB7CgkJCQlpZiAod2luZG93LmZyYW1lcy5sZW5ndGgpIHsKCQkJCQkvLyBmcmFtZS1iYXNlZCB0ZW1wbGF0ZQoJCQkJCWF3YWl0IHRoaXMuaW5pdERPTSgpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjb25zb2xlLmxvZygiRnJFTUQ6OnByZUluaXQoKTogaGFzaGNoYW5nZSB0cmlnZ2VyZWQsIGxvYWRpbmcgcGFnZSAiICsgdGhpcy5oYXNoLnBhZ2UpOwoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiU2NoZW1hIik7CgkJLy9hd2FpdCB0aGlzLnJlcXVpcmUoIkR5bmFGb3JtIik7IGNvbXBhbnkuUmVxdWlyZWQKCgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKSBhd2FpdCBjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCB8fCBbXSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCQl9CgkJfQoKCQkvLyBmYWlsc2FmZQoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCU5hbWU6ICJDb250ZW50IE1hbmFnZXIiLAoJCQlFbmFibGVkOiB0cnVlLAoJCX0pLCAiY29udGVudG1hbmFnZXIiKTsKCgkJYXdhaXQgdGhpcy5fbWFuaWZlc3QoKTsKCgkJY29uc29sZS5sb2coIkRvbmUgTG9hZGluZyIpOwoJfQoKCWFzeW5jIF9tYW5pZmVzdChzY29wZSwganNvbikgewoJCXRyeSB7CgkJCWlmICghanNvbikgewoJCQkJanNvbiA9IGF3YWl0IHRoaXMuX2V4cG9ydCh7CgkJCQkJdGVtcGxhdGU6ICJNQU5JRkVTVCIKCQkJCX0sIHNjb3BlKTsKCQkJfQoJCQlsZXQgaHJlZiA9IHRoaXMudG9CYXNlNjQobnVsbCwganNvbiwgJ2FwcGxpY2F0aW9uL21hbmlmZXN0K2pzb24nLCB0cnVlKTsKCQkJaWYgKHRoaXMuX21hbkNzcykgewoJCQkJdGhpcy5fbWFuQ3NzLmF0dHIoImhyZWYiLCBocmVmKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX21hbkNzcyA9IHRoaXMuX2NzcyhocmVmLCAnbWFuaWZlc3QnKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gbG9hZGluZyBtYW5pZmVzdCIsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2V4cG9ydCh0bXAsIHNjb3BlLCBvcHRpb25zID0ge30pIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5jb250ZW50IHx8IGF3YWl0IGZldGNoKGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9P3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCWxldCByZXQgPSB0aGlzLl9pbmplY3QodGVtcGxhdGUsIHsKCQkJb1Njb3BlOiB0aGlzLl9fc2NvcGUoc2NvcGUpLAoJCQltZTogd2luZG93Lm1lLAoJCQlzY29wZSwKCQkJb3B0aW9ucywKCQl9LCBvcHRpb25zLmVuZ2luZSk7CgoJCWlmICh0aGlzLl9iZWF1dGlmeSkgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCB0bXAubGFuZ3VhZ2UpOwoJCWlmICghdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCBmZXRjaCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglhc3luYyBfbG9hZFNjb3BlKGVjLCBzY29wZSkgewoJCXRyeSB7CgkJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJCWlmIChzY29wZSAhPT0gJ3dpbmRvdycpIHdpbmRvd1tzY29wZV0gPSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpOwoJCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQoKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQkJbGV0IG1jID0gKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5maW5kKGMgPT4gYy5Jc01haW4pOwoJCQlpZiAobWMpIHsKCQkJCXRoaXMuYXBpU2VydmVyID0gYXdhaXQgbmV3IG9TY29wZVttYy5OYW1lXSgpLl9zZXJ2ZXIoewoJCQkJCWxvYWRUb29sczogdHJ1ZSwKCQkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCQlpbml0Tm9kZTogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCWNvbnNvbGUubG9nKCJfbG9hZFNjb3BlKCk6IHJlcXVpcmluZyBzY2hlbWEuLi4iKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJkYXRlIiwKCQkJCQkJSXNEYXRlOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiAnbmV3IERhdGUoKScsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJfV07CgkJCQkJYXR0TGlzdC5mb3JFYWNoKGEgPT4gcHJvcExpc3QuZmlsdGVyKHAgPT4gX2Jhc2VfW3BdKS5mb3JFYWNoKHAgPT4gYVtwXSA9IF9iYXNlX1twXVthLk5hbWVdKSk7CgkJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYXR0TGlzdC5jb25jYXQoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9PSAiX19CQVNFX18iKSk7CgkJCQl9CgoJCQkJWydFbnRpdHlBdHRyaWJ1dGVzJywgJ0VudGl0eUZpZWxkcyddLmZpbHRlcihlVHlwZSA9PiBjW2VUeXBlXSkuZm9yRWFjaChlVHlwZSA9PiBjW2VUeXBlXS5maWx0ZXIoZWEgPT4gZWEuRHVwbGljYXRlKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlsZXQgc2VhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzBdKVtlVHlwZV0uZmluZChzZWEgPT4gc2VhLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMV0pOwoJCQkJCU9iamVjdC5rZXlzKHNlYSkuZmlsdGVyKGsgPT4gWyJFbnRpdHlDbGFzcyJdLmluZGV4T2YoaykgPCAwKS5mb3JFYWNoKGsgPT4gewoJCQkJCQlpZiAoayA9PSAnRGVmYXVsdCcgJiYgdHlwZW9mKHNlYVtrXSkgPT09ICdzdHJpbmcnICYmICFzZWFba10uaW5kZXhPZignLyoqZ2VuZXJhdGVkKiovJykpIHJldHVybjsKCQkJCQkJZWFba10gPSBzZWFba107CgkJCQkJfSk7CgkJCQl9KSk7CgoJCQkJYy5UeXBlZEF0dHJpYnV0ZXMgPSBjLlR5cGVkQXR0cmlidXRlcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG0uTWV0aG9kUGFyYW1ldGVycyB8fCBbXTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5wdXNoKC4uLmMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gIXAuSWQpKS5mbGF0KCkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiB0eXBlb2YoZWEuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgZWEuQWN0aXZlKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5VHlwZSB8fCAoZWEuRW50aXR5VHlwZSAmJiBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gewoJCQkJCWlmICghZWEuTmFtZSkgewoJCQkJCQljb25zb2xlLmxvZyhjLk5hbWUgKyAiIGhhcyBBdHRyaWJ1dGUgd2l0aG91dCBOYW1lIiwgZWEpOwoJCQkJCX0KCQkJCQllYS5JZCA9IGVhLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQllYS5fVG9TdHJpbmcgPSBlYS5fVG9TdHJpbmcgfHwgZWEuTmFtZTsKCQkJCQllYS5Hcm91cCA9IGVhLkdyb3VwIHx8ICJNYWluIjsKCQkJCQllYS5FbnRpdHlDbGFzcyA9IGM7CgkJCQl9KTsKCgkJCQlvR3JvdXBlci5ncm91cEJ5KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbmQodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uSWQgPSBtLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQltLl9Ub1N0cmluZyA9IG0uX1RvU3RyaW5nIHx8IG0uTmFtZTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4gcC5FbnRpdHlNZXRob2QgPSBtKTsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlICYmICFwLkVudGl0eVR5cGUuSWQpLmZvckVhY2gocCA9PiB7CgkJCQkJCXAuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBwLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJfSk7CgoJCQkJCWlmICghbS5SZXNwb25zZUF0dHJpYnV0ZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgUmVzcG9uc2VBdHRyaWJ1dGUgZm9yIG1ldGhvZCAiICsgbS5OYW1lICsgIi4gRGVmYXVsdGluZyB0byBvYmplY3QgcmV0dXJuIChyZXQiICsgbS5OYW1lICsgIikiKTsKCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCQkJCUlzT2JqZWN0OiB0cnVlLAoJCQkJCQl9OwoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgPSBtLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgfHwgKCJyZXQiICsgbS5OYW1lKTsKCgkJCQkJaWYgKG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSB7CgkJCQkJCWxldCByYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJCWlmICghcmEpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBFbnRpdHlUeXBlIE5hbWU9IiArIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUgPSByYTsKCQkJCQkJfQoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eU1ldGhvZCA9IG07CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMgPSB0aGlzLl91bmlxdWUoYy5FbnRpdHlNZXRob2RzKTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzU3RyaW5nICYmICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkRlZmF1bHQgJiYgKGVhLlJlcXVpcmVkIHx8IGVhLklzVW5pcXVlKSkuZm9yRWFjaChlYSA9PiBlYS5EZWZhdWx0ID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihyYSA9PiAhcmEuRW50aXR5TWV0aG9kICYmIHJhLkVudGl0eVR5cGUgJiYgKHJhLklzVW5pcXVlIHx8IHJhLlJlcXVpcmVkKSkubWFwKHJhID0+IGAvKipnZW5lcmF0ZWQqKi8odGhpcy4ke3JhLk5hbWV9KCk/dGhpcy4ke3JhLk5hbWV9KCkuJHtlYS5OYW1lfSgpOidudWxsJylgKS5qb2luKGAgKyAnLScgKyBgKSk7CgkJCX0pOwoKCQkJLypvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5lYy5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCQllYy5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkKS5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoJCQl9KTsqLwoKCQkJcmV0ID0gdGhpcy5fdW5pcXVlKGVjKTsKCQl9IGVsc2UgaWYgKCFlYyB8fCAhQXJyYXkuaXNBcnJheShlYykpIHsKCQkJdmFyIGNsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIik7CgoJCQl2YXIgdENsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eVR5cGUiKTsKCQkJY2xhc3Nlcy5mb3JFYWNoKGMgPT4gewoJCQkJaWYgKCFjLmtleSkgewoJCQkJCWNvbnNvbGUubG9nKCJFbXB0eSBrZXkiLCBjKTsKCQkJCX0KCQkJCWMua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBjLnZhbHVlczsKCgkJCQl2YXIgdGFzID0gdENsYXNzZXMuZmluZCh0YyA9PiB0Yy5rZXkgJiYgYy5rZXkgJiYgdGMua2V5LklkID09PSBjLmtleS5JZCk7CgkJCQkvL2Mua2V5LlR5cGVkQXR0cmlidXRlcyA9IHRhcyA/IHRhcy52YWx1ZXMgOiBbXTsKCQkJCWMua2V5LkVudGl0eU1ldGhvZHMgPSBjLmtleS5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQl9KTsKCQkJcmV0ID0gY2xhc3Nlcy5tYXAoYSA9PiBhLmtleSk7CgoJCQlvR3JvdXBlci5ncm91cEJ5KGVhcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQltLkVudGl0eUNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLklkID09IG0uRW50aXR5Q2xhc3NpZCk7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpWzBdOwoKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQl9KTsKCQl9CgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMgPSAoYy5FbnRpdHlGaWVsZHMgfHwgW10pLmZpbHRlcihmID0+ICFmLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuRW50aXR5Q2xhc3MgPSBjKTsKCQl9KTsKCgkJbGV0IHRyQ2xhc3MgPSByZXQuZmluZChjID0+IGMuTmFtZSA9PSAiVHJhbnNhY3Rpb24iICYmIGMuRW50aXR5TW9kdWxlKTsKCQlpZiAodHJDbGFzcykgcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSXNTeW5jICYmICFtLlJlc3BvbnNlTWV0aG9kKS5mb3JFYWNoKG0gPT4gewoJCQltLlJlc3BvbnNlTWV0aG9kID0gewoJCQkJTmFtZTogbS5OYW1lICsgIlJlc3BvbnNlIiwKCQkJCU1ldGhvZFBhcmFtZXRlcnM6IFt7CgkJCQkJTmFtZTogInRyYW5zYWN0aW9uIiwKCQkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzCgkJCQl9XSwKCQkJCVNjcmlwdDogYHJldHVybiBhd2FpdCB0cmFuc2FjdGlvbi5jbGFzcygiJHtjLk5hbWV9IikubWV0aG9kKCIke20uTmFtZX0iKS5hc3luY1Jlc3VsdCgiJHttLlJlc3BvbnNlQXR0cmlidXRlPy5FbnRpdHlUeXBlPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJyl9IiwgJHttLlJlc3BvbnNlQXR0cmlidXRlLklzQXJyYXk/InRydWUiOiJmYWxzZSJ9KWAsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogbS5SZXNwb25zZUF0dHJpYnV0ZSwKCQkJfTsKCQkJYy5FbnRpdHlNZXRob2RzLnB1c2gobS5SZXNwb25zZU1ldGhvZCk7CgoJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJTmFtZTogYHJldCR7bS5OYW1lfWAsCgkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzLAoJCQl9CgkJfSkpOwoKCQlvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQlsZXQgX2MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCB8fCAoYy5OYW1lID09IGN0YS5rZXkuTmFtZSAvKiYmIGMuRW50aXR5TW9kdWxlICYmIGN0YS5rZXkuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gY3RhLmtleS5FbnRpdHlNb2R1bGUuTmFtZSovICkpOwoJCQlpZiAoIV9jKSB7CgkJCQljb25zb2xlLmxvZygiTm8gY2xhc3MgZm91bmQgdG8gbWF0Y2ggIiArIGN0YS5rZXkuTmFtZSk7CgkJCX0gZWxzZSB7CgkJCQlfYy5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoKCQkJCWN0YS52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gX2MpOyAvLz8/PwoJCQl9CgkJfSk7CgoJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCAmJiAhcmV0LmZpbmQoYyA9PiBjLklzTWFpbikpIHsKCQkJcmV0WzBdLklzTWFpbiA9IHRydWU7CgkJCXJldFswXS5PcmRlciA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoJCX0KCgkJbGV0IGNSYW5rID0gKGMsIHNvdXJjZXMgPSBbXSkgPT4gewoJCQlzb3VyY2VzLnB1c2goYy5OYW1lKTsKCQkJcmV0dXJuIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlICE9PSBjICYmIHNvdXJjZXMuaW5kZXhPZihlYS5FbnRpdHlUeXBlLk5hbWUpIDwgMCkubWFwKGVhID0+IGNSYW5rKGVhLkVudGl0eVR5cGUsIHNvdXJjZXMpKS5jb25jYXQoWzFdKS5yZWR1Y2UoKHN1bSwgeCkgPT4gc3VtICsgeCk7CgkJfTsKCgkJLy8gb3JkZXIgYnkgb3JkZXIKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5PcmRlciA9IGMuT3JkZXIgfHwgMDsKCQkJYy5SYW5rID0gY1JhbmsoYyk7CgkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IGVhLk9yZGVyID0gZWEuT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKGVtID0+IGVtLk9yZGVyID0gZW0uT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuT3JkZXIgPSBlZi5PcmRlciB8fCAwKTsKCQl9KTsKCQlyZXQuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUZpZWxkcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgoJCWlmIChyZXQubGVuZ3RoKSB7CgkJCVsnRGVidWcnLCAnQ29uZmlnJywgJ1Rlc3QnLCAnVG9vbHMnLCAnTWFwcGluZ3MnLCAnUm91dGluZycsICdWYWxpZGF0b3JzJywgJ01ldGhvZFJ1bGVzJywgJ0VudGl0eVJ1bGVzJ10uZm9yRWFjaChhID0+IHsKCQkJCWxldCBtY0EgPSByZXRbMF1bYV07CgkJCQlkZWxldGUgcmV0WzBdW2FdOwoJCQkJcmV0LmZvckVhY2goYyA9PiB7CgkJCQkJY1thXSA9IGNbYV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uW2MuTmFtZV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uWycqJ10gfHwgYy5FbnRpdHlNb2R1bGU/LlthXSB8fCBtY0E/LltjLk5hbWVdIHx8IG1jQT8uWycqJ10gfHwgbWNBIHx8IHt9OwoJCQkJCWlmIChhLmVuZHNXaXRoKCdzJykgJiYgIUFycmF5LmlzQXJyYXkoY1thXSkpIGNbYV0gPSBPYmplY3Qua2V5cyhjW2FdKTsKCQkJCX0pOwoJCQl9KTsKCgkJCXJldC5maWx0ZXIoYyA9PiAhYy5Jc01haW4pLmZvckVhY2goYyA9PiBjLkNvbmZpZyA9IE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXQuZmluZChfYyA9PiBfYy5Jc01haW4pLkNvbmZpZykpLCBjLkNvbmZpZykpOwoKCQkJcmV0LmZpbHRlcihjID0+IGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IGMuRW50aXR5TW9kdWxlID0gYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJX19zY29wZU5hbWUoc2NvcGUpIHsKCQlyZXR1cm4gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCkgfHwgIndpbmRvdyI7Cgl9CgoJX19zY29wZShzY29wZSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fID8gdGhpcy5zcigpLl9fc2NvcGUoc2NvcGUpIDogdGhpczsKCX0KCglhc3luYyBfYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHJTY29wZSA9IHsKCQkJRW50aXR5Q2xhc3NlczogcmV0LAoJCQlFbnRpdHlBdHRyaWJ1dGVzOiBlYXMsCgkJfTsKCgkJclNjb3BlLm5OYW1lID0gclNjb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlyU2NvcGUubkNvZGUgPSByU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJbGV0IGh0bWwgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkVudGl0eUNsYXNzIik7CgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4oaHRtbC5tYXRjaEFsbCgvKDwlPSkuW1x3XC0uXStbXC5dKGpzKSglPikvZ20pKV0pIGh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKSkpOwoKCQl0aGlzLnN0ZXAoKTsKCgkJbGV0IF9jb2RlID0gJyc7CgkJZm9yIGF3YWl0IChjb25zdCBjIG9mIHJldCkgewoJCQlsZXQgY29kZSA9ICIiOwoJCQl0cnkgewoJCQkJY29kZSA9IHRoaXMuX2luamVjdChodG1sLCB7CgkJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQkJYzogYywKCQkJCQlzY29wZTogc2NvcGUsCgkJCQkJbk5hbWU6IHJTY29wZS5uTmFtZSwKCQkJCQluQ29kZTogclNjb3BlLm5Db2RlLAoJCQkJfSkgKyAnXG4nICsgclNjb3BlLm5OYW1lKGMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9idWlsZENsYXNzZXMoKTogX2luamVjdCBleGNlcHRpb246ICIgKyBleCk7CgkJCX0KCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgPSBjb2RlICsgYAoke3Njb3BlPyd3aW5kb3cuJytzY29wZTond2luZG93J30uJHtyU2NvcGUubkNvZGUoYy5FbnRpdHlNb2R1bGUpfHwneCd9LiR7clNjb3BlLm5OYW1lKGMpfSA9ICR7clNjb3BlLm5OYW1lKGMpfTsKYDsKCgkJCWxldCBhbGlhcyA9IHJTY29wZTsKCQkJaWYgKGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkFsaWFzKSBjLkVudGl0eU1vZHVsZS5BbGlhcy5zcGxpdCgnLicpLmZpbHRlcihhID0+IGEpLmZvckVhY2goYSA9PiBhbGlhcyA9IChhbGlhc1thXSA9IGFsaWFzW2FdIHx8IHt9KSk7CgoJCQlhbGlhc1tyU2NvcGUubk5hbWUoYyldID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoY29kZSk7CgkJfQoKCQlyZXR1cm4gclNjb3BlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzID0gdGhpcy5fX3Njb3BlKCkuX190aW1lcyB8fCB7fTsKCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCXJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDApIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiAnTG9hZGluZycsCgkJCQkJbXNnOiAnTG9hZGluZyBkYXRhLi4uJywKCQkJCQlpbnRlcnZhbDogaW50ZXJ2YWwsCgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHJldHVybiBmYWxzZTsKCX0KCglhc3luYyByZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCkgewoJCWlmICghZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQpIHRoaXMuX2xvYWRpbmcodHJ1ZSwgb0VsZW1lbnQgPyBvRWxlbWVudC5pbnRlcnZhbCA6IG51bGwpOwoJCXRyeSB7CgkJCWxldCB2ID0gYXdhaXQgbG9hZGVyKGZEYXRhLCBvRWxlbWVudCwgZWRpdG9yKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJbGV0IGRpZmYgPSAwOwoJCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgJiYgZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQuZ2V0VGltZSgpIC0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmID4gMCAmJiBkaWZmIDwgMTAwKSB7CgkJCQkvLyBjb25zb2xlLmxvZygiTm90IGNoYW5nZWQgb24gdGhlIHNlcnZlciIpOwoJCQl9IGVsc2UgewoJCQkJLy8gY29uc29sZS5sb2coIlNlcnZlciBjaGFuZ2UsIHNldHRpbmcgdmFsdWUiLCBkaWZmKTsKCQkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkOwoJCQkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodik7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIExvYWQgZmlsZS5cbiIgKyBleCk7CgkJfQoJCXRoaXMuX2xvYWRpbmcoZmFsc2UpOwoKCQlpZiAoZWRpdG9yLnNlc3Npb24ubGFzdFNhdmVkKSB7CgkJCS8vYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDAuNSAqIDYwICogMTAwMCkpOwoJCQlhd2FpdCB0aGlzLl93YWl0KDAuNSAqIDYwICogMTAwMCk7CgkJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoJCX0KCX0KCglhc3luYyBPcGVuRWRpdG9yKGUsIGxhbmd1YWdlID0gbyA9PiAiaHRtbCIsIGxvYWRlciA9IG8gPT4ge30sIHNhdmVyID0gKHYsIG8pID0+IHt9LCBmRGF0YSwgb0VsZW1lbnQpIHsKCQl2YXIgZWRpdG9yID0gYWNlLmVkaXQoZSk7CgkJZGVsZXRlIGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTsKCQkvL2FjZS5jb25maWcuc2V0KCdiYXNlUGF0aCcsICcvbm9kZV9tb2R1bGVzL2FjZS1idWlsZHMvc3JjLW1pbi1ub2NvbmZsaWN0Jyk7CgkJZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUoJycpOwoKCQllZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS8nICsgbGFuZ3VhZ2UoZkRhdGEpKTsKCQllZGl0b3Iub24oImNoYW5nZSIsIGUgPT4gewoJCQlsZXQgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQuZ2V0VGltZSgpIC0gc3Iuc2VydmVyRGF0ZSgpLmdldFRpbWUoKSk7CgkJCWlmIChkaWZmIDwgMTAwICYmIGUuc3RhcnQucm93ID09IDAgJiYgZS5zdGFydC5jb2x1bW4gPT0gMCkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGNvbnNvbGUubG9nKCJDaGFuZ2VkIEV2ZW50IiwgZGlmZik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCX0pOwoJCWF3YWl0IHRoaXMucmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpOwoKCQlpZiAoc2F2ZXIpIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHsKCQkJbmFtZTogJ3NhdmUnLAoJCQliaW5kS2V5OiB7CgkJCQl3aW46ICJDdHJsLVMiLAoJCQkJbWFjOiAiQ21kLVMiCgkJCX0sCgkJCWV4ZWM6IGFzeW5jIGVkaXRvciA9PiB7CgkJCQl2YXIgdmFsdWUgPSB0aGlzLl9iZWF1dGlmeShlZGl0b3IuZ2V0VmFsdWUoKSwgbGFuZ3VhZ2UoZkRhdGEpKTsKCQkJCWlmICh2YWx1ZSAhPSBlZGl0b3Iuc2Vzc2lvbi5nZXRWYWx1ZSgpKSBlZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2YWx1ZSk7CgkJCQlpZiAoc2F2ZXIpIHsKCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQkJCXRpdGxlOiAnUGxlYXNlIHdhaXRpbmcnLAoJCQkJCQkJbXNnOiAnU2F2aW5nIGRhdGEuLi4nLAoJCQkJCQkJaW50ZXJ2YWw6IG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KTsKCX0KCglfYmVhdXRpZnkodmFsdWUsIHR5cGUpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzX2JlYXV0aWZ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBvcHRpb25zID0gewoJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJImU0eCI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoJCQkJdmFsdWUgPSB0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwoJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnLCAnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCXZhbHVlID0ganNfYmVhdXRpZnkodmFsdWUsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHt9CgkJcmV0dXJuIHZhbHVlOwoJfQoKCV9sYW5nKGNvZGUpIHsKCQl3aW5kb3cubGFuZyA9IGNvZGU7CgkJdGhpcy5zZXRVUkwoInBhZ2U9IiArICh0aGlzLmFsbERhdGEucGFnZS5fY29kZSB8fCAnaW5kZXgnKSk7Cgl9CgoJc2VsZWN0MlNSKG9TZWxlY3QpIHsKCQlsZXQgcyA9ICQob1NlbGVjdCk7CgkJbGV0IGNhbGxzID0gW107CgkJaWYgKHRoaXMuc2VsZWN0MlRlbXBsYXRlKSB7CgkJCWNhbGxzLnB1c2godGhpcy5zZWxlY3QyVGVtcGxhdGUpOwoJCX0gZWxzZSB7CgkJCWNhbGxzLnB1c2godGhpcy5zcigpLkdldCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvc2VsZWN0Mi10ZW1wbGF0ZS5odG0iKSkpOwoJCX0KCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQl0aGlzLnNlbGVjdDJUZW1wbGF0ZSA9IHJldFswXTsKCQkJcy5zZWxlY3QyKHsKCQkJCWFqYXg6IHsKCQkJCQl0cmFuc3BvcnQ6IChwYXJhbXMsIHN1Y2Nlc3MsIGZhaWx1cmUpID0+IHsKCQkJCQkJdmFyIGZGaWx0ZXIgPSB0aGlzLnNyKCkucnVuU2NyaXB0KCIobywgc3RhdGUpID0+IHsiICsgcy5kYXRhKCJzcl9maWx0ZXIiKSArICJ9Iik7CgkJCQkJCSQud2hlbih0aGlzLnNyKCkuXyhzLmRhdGEoInNyX21ldGhvZCIpLCBudWxsLCBmRmlsdGVyKHt9LCB0aGlzLnNyKCkucnVuU2NyaXB0KHMuZGF0YSgiY19zdGF0ZSIpKSkpKS50aGVuKHJldCA9PiB7CgkJCQkJCQlzdWNjZXNzKHsKCQkJCQkJCQlwYWdpbmF0aW9uOiB7CgkJCQkJCQkJCW1vcmU6IGZhbHNlCgkJCQkJCQkJfSwKCQkJCQkJCQlyZXN1bHRzOiAkLm1hcChyZXQsIHIgPT4gewoJCQkJCQkJCQlyLmlkID0gci5JZDsKCQkJCQkJCQkJci50ZXh0ID0gci5Ub1N0cmluZzsKCQkJCQkJCQkJcmV0dXJuIHI7CgkJCQkJCQkJfSksCgkJCQkJCQkJdG90YWxzOiByZXQubGVuZ3RoCgkJCQkJCQl9KTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSwKCQkJCXRlbXBsYXRlUmVzdWx0OiAoX2UsIF9zKSA9PiB7CgkJCQkJcmV0dXJuIHRoaXMuX2luamVjdCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSwgewoJCQkJCQlkYXRhOiBfZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQkJcy5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCQljb25zb2xlLmxvZyhlLnRhcmdldCk7CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2Uuc2VsZWN0MiIsIGUgPT4gewoJCQkJLy92YXIgZGF0YSA9IGUucGFyYW1zLmRhdGE7CgkJCQl2YXIgX3MgPSAkKGUudGFyZ2V0KTsKCQkJfSk7CgkJfSk7Cgl9CgoJYXN5bmMgcHJlQ29tcGlsZShwYWdlLCBsb2NhdGlvbikgewoJCWlmICh0eXBlb2YgQmFiZWwgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mIFJlYWN0ICE9PSAidW5kZWZpbmVkIikgewoJCQlsZXQganN4ID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWpzeCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgobG9jYXRpb24gfHwgInRlbXBsYXRlcyIpICsgdGhpcy5tKCkgKyAiLyIgKyAocGFnZS5fY29kZSB8fCBwYWdlKSArICIuanN4IikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGpzeCA9PT0gbnVsbCB8fCBqc3ggPT09ICIiKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQl2YXIgcmVzID0gbnVsbDsKCQkJdHJ5IHsKCQkJCXJlcyA9IGF3YWl0IEJhYmVsLnRyYW5zZm9ybShqc3gsIHsKCQkJCQlwcmVzZXRzOiBbJ2xhdGVzdCcsICJyZWFjdCJdCgkJCQl9KTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJCYWJlbCIsIGV4KTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXJldHVybiByZXMuY29kZTsKCQl9Cgl9CgoJYXN5bmMgX3Z1ZUNvbXBvbmVudChjb2RlKSB7CgkJaWYgKHR5cGVvZiBWdWUgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCkgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykucGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBwLnNjcmlwdCgpID8gcC5fYXRvYihwLnNjcmlwdCgpKSA6ICcnLAoJCQkJQm9keTogcC5ib2R5KCkgPyBwLl9hdG9iKHAuYm9keSgpKSA6ICcnLAoJCQkJX2NvZGU6IHBhZ2UuX2NvZGUsCgkJCX07CgkJfQoKCQlpZiAoIXJldCkgcmV0ID0gYXdhaXQgdGhpcy5fdnVlQ29tcG9uZW50KHBhZ2UuX2NvZGUpOwoJCWlmICghcmV0ICYmIHR5cGVvZihDTVNfUk9PVCkgPT09ICdzdHJpbmcnKSB7CgkJCXJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBwYWdlLl9jb2RlLmluZGV4T2YoJy8nKSA+PSAwID8gcGFnZS5fY29kZSA6IChDTVNfUk9PVCArIHBhZ2UuX2NvZGUpCgkJCX0pOwoJCX0KCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIENNUywgbG9va2luZyBpbiBFTVMiKTsKCQkJdmFyIGVvUGFnZSA9IG51bGw7CgkJCXRyeSB7CgkJCQllb1BhZ2UgPSBuZXcgUGFnZSgpLmNvZGUocGFnZS5fY29kZSwgIj0iKTsKCQkJCWlmIChlb1BhZ2UubGFuZ3VhZ2UpIGVvUGFnZS5sYW5ndWFnZSh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIsICI9Iik7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWNvbnNvbGUubG9nKCJFTVMgZG9lcyBub3QgaGF2ZSBhIFBhZ2UgY2xhc3MsIGZhaWxpbmcgb24gcHVycG9zZTogIiArIGUubWVzc2FnZSk7CgkJCX0KCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkuXykgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQlFbnRpdHlPYmplY3Q6IChlb1BhZ2UgPyBlb1BhZ2UudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQl9KTsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gRU1TLCB0cnlpbmcgdGVtcGxhdGVzIik7CgkJCQlwYWdlID0gcmV0WzBdOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBFTVMsIHNvIGdvaW5nIGxvY2FsIik7CgkJCX0KCgkJCWxldCBodG1sID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmh0bSIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChodG1sICYmICFodG1sLnN0YXR1cykgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGh0bWwgdGVtcGxhdGUgZm91bmQiLCBodG1sKTsKCQkJCXBhZ2UuQm9keSA9IGh0bWw7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaGFzIG5vIGh0bWwgdGVtcGxhdGUiKTsKCQkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlwYWdlLkJvZHkgPSAiPGRpdiBpZD0nZm9ybUNvbXBvbmVudCcvPiI7CgkJCQl9IGVsc2UgewoJCQkJCXBhZ2UuQm9keSA9IHBhZ2UuX2NvbnRlbnQgfHwgIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCQl9CgkJCX0KCgkJCWxldCBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZShwYWdlKTsKCQkJaWYgKCFqcykgdHJ5IHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5qcyIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmICghanMgfHwgIWpzLm9rKSBqcyA9IG51bGw7CgkJCWlmIChqcyAmJiBqcy5vaykgcGFnZS5TY3JpcHQgPSBhd2FpdCBqcy50ZXh0KCk7CgoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgc2NyaXB0IGlzIiArIChqcyA/ICcnIDogJyBub3QnKSArICIgcmV0cmlldmVkIik7CgkJCXRoaXMuc3RlcCgpOwoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCS8vY29uc29sZS5sb2coInBhZ2UgQm9keSIsIHBhZ2UuX2JvZHkgfHwgcGFnZS5Cb2R5KTsKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQlsZXQgb2JqID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UsIERGb3JtKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9IHRoaXMuYmxvY2tzLmhlYWRlci5odG1sICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5KSArIHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoKCQl0cnkgewoJCQlyZXR1cm4gSlNPTi5wYXJzZShzQ29kZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCWxldCBzQ29kZSA9IGpzOwoJCWlmIChzQ29kZS5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJLy8gYSBjbGFzcyBkZWZpbml0aW9uLCBkbyBub3QgZW5jbG9zZSBpdCBpbiBhIGZ1bmN0aW9uCgkJfSBlbHNlIHsKCQkJaWYgKHNDb2RlLmluZGV4T2YoJ3JldHVybiAnKSAhPSAwKSB7CgkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQl9CgkJCXNDb2RlID0gIihhc3luYyAoKSA9PiB7IiArIHNDb2RlICsgIlxufSkoKTsiOwoJCX0KCgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoc0NvZGUpOwoJCX0gZWxzZSBpZiAoZmFsc2UgJiYgdHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IHJldCA9IGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCXNjcmlwdC5hc3luYyA9IGJBc3luYzsKCQkJCXNjcmlwdC5zcmMgPSBgZGF0YTp0ZXh0L2phdmFzY3JpcHQ7YmFzZTY0LCR7dGhpcy5fYnRvYShzQ29kZSl9YDsKCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCX0pOwoJCQljb25zb2xlLmxvZyhyZXQsIHNDb2RlLnN1YnN0cmluZygwLCAyMCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXJldHVybiBldmFsKHNDb2RlKTsKCQl9Cgl9Cn07",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
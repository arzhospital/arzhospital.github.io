{
	"Id": "a85a0c56068e0c555a65baaf488705c34c31da2d",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IGF0b2IoKGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ1N0b3JlZFNjcmlwdCcpLm5hbWUocy5OYW1lIHx8IHMubmFtZSkuZmluZCgpKS5zY3JpcHQoKSk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCBhdG9iKHRlbXBsYXRlLnNjcmlwdCgpKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJaWYgKHRmICYmIHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gYXRvYih0Zik7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKHRmLm1hdGNoQWxsKC8oXFtcWyU9KS5bXHdcLS5dK1tcLl0odG1wKVtcOlw6XT9bXiglXF1cXSldKltcOlw6XT9bXiglXF1cXSldKiglXF1cXSkvZ20pKV0pIHsKCQkJCWxldCB0TmFtZVBhcnRzID0gbVswXS5yZXBsYWNlKCdbWyU9JywgJycpLnJlcGxhY2UoJyVdXScsICcnKS5yZXBsYWNlKCcudG1wJywgJycpLnNwbGl0KCc6OicpOwoJCQkJbGV0IHROYW1lID0gdE5hbWVQYXJ0c1swXTsKCQkJCWxldCB0RGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwge30pOwoJCQkJaWYgKHROYW1lUGFydHMubGVuZ3RoID4gMSkgewoJCQkJCXREYXRhID0gT2JqZWN0LmFzc2lnbih0RGF0YSwgYXdhaXQgdGhpcy5ydW5TY3JpcHQodE5hbWVQYXJ0c1sxXSkpOwoJCQkJfQoJCQkJbGV0IHQgPSBhd2FpdCB0aGlzLl90ZW1wbGF0ZSh0TmFtZSwgc2NvcGUsIHREYXRhLCBwcnZGdW5jKTsKCQkJCXRDYWNoZVt0TmFtZV0gPSB0Q2FjaGVbdE5hbWVdIHx8IHRbZl07CgkJCQl0ZiA9IHRmLnJlcGxhY2UobVswXSwgdENhY2hlW3ROYW1lXSk7CgkJCX0KCgkJCXJldFtmXSA9IHRoaXMuX2luamVjdCh0Ziwgb2JqKTsKCQl9CgkJY29uc29sZS5sb2codENhY2hlKTsKCgkJdHJ5IHsKCQkJb2JqLnBvc3RJbmplY3QgJiYgYXdhaXQgb2JqLnBvc3RJbmplY3QocmV0KTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucG9zdEluamVjdCgpIiwgZXgpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglUZW1wbGF0ZSA9IGNsYXNzIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKCQkJdGhpcy5zY29wZSA9IHNjb3BlOwoJCQl0aGlzLm9TY29wZSA9IF9GckVNRC5fX3Njb3BlKHNjb3BlKTsKCgkJCXRoaXMubmMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ05vZGUnKTsKCQkJdGhpcy5zYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnU3RvcmVkU2NyaXB0Jyk7CgkJCXRoaXMuZWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ0V2ZW50Jyk7CgkJCXRoaXMubWMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklzTWFpbik7CgoJCQl0aGlzLmRTY29wZSA9ICh0aGlzLm5jICYmIHRoaXMubmMuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMubmMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJdGhpcy5jbVNjb3BlID0gKHRoaXMuc2MgJiYgdGhpcy5zYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5zYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJdGhpcy5kYXRhID0gZGF0YTsKCgkJCXRoaXMubk5hbWUgPSB0aGlzLm9TY29wZS5uTmFtZTsKCQkJdGhpcy5jTmFtZSA9IHRoaXMub1Njb3BlLmNOYW1lOwoJCQl0aGlzLm5Db2RlID0gdGhpcy5vU2NvcGUubkNvZGU7CgoJCQl0aGlzLnBydkZ1bmMgPSBwcnZGdW5jIHx8ICgoKSA9PiB7fSk7CgkJCXRoaXMubVJhbmsgPSAwOwoKCQkJaWYgKGJSYW5rKSB0aGlzLm1SYW5rID0gTWF0aC5tYXgoMCwgLi4udGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlJhbmspKTsgLy8gdXNlZnVsIGluIHRlbXBsYXRlcwoKCQkJdGhpcy5tYWluVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuc3BsaXQoJy0nKVswXTsKCQkJdGhpcy5zdWJUaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5pbmRleE9mKCctJykgPj0gMCA/IGRhdGEuVGl0bGUuc3BsaXQoJy0nKVsxXSA6ICIiOwoJCX0KCgkJX25ldyhjLCB0b29sLCBpZCkgewoJCQlpZiAoIWMpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKTsKCQkJaWYgKHR5cGVvZihjKSA9PT0gJ3N0cmluZycpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBjKTsKCQkJaWYgKCFjKSByZXR1cm4gbnVsbDsKCgkJCWxldCBtU2NvcGUgPSBjLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKGMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXJldHVybiBuZXcobVNjb3BlW3RoaXMub1Njb3BlLm5OYW1lKGMpXSkoaWQsIHRvb2wpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJY25mKF9jLCBpZCwgZGlkLCB0b29sKSB7CgkJCV9jID0gX2MgfHwgdGhpcy5tYzsKCQkJbGV0IG1TY29wZSA9IF9jLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKF9jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXJldHVybiBtU2NvcGUuX25vZGUgPyBtU2NvcGUuX25vZGUuX19jb25maWcoaWQsIGRpZCwgewoJCQkJdG9vbDogdG9vbAoJCQl9KSA6ICh0aGlzLl9uZXcoX2MsIHRvb2wpLl9fY29uZmlnKGlkLCBkaWQsIHRvb2wgPyB7CgkJCQl0b29sOiB0b29sCgkJCX0gOiB1bmRlZmluZWQpKTsKCQl9CgoJCW5UeXBlKGVhKSB7CgkJCWlmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Jvb2wpIHsKCQkJCXJldHVybiAiYm9vbGVhbiI7CgkJCX0gZWxzZSBpZiAoZWEuSXNGbG9hdCkgewoJCQkJcmV0dXJuICJmbG9hdCI7CgkJCX0gZWxzZSBpZiAoZWEuSXNJbnQgfHwgZWEuSXNMb25nKSB7CgkJCQlyZXR1cm4gIm51bWJlciI7CgkJCX0gZWxzZSBpZiAoZWEuSXNEYXRlKSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCgkJX3QocHJvcCwgb2JqLCBzZWFyY2gpIHsKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBvYmpbcHJvcF07CgoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl90IiwgZXgpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0U1ZHKHJldCkgewoJCQlsZXQgb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQlvRGl2LmlkID0gJ3N2Z1JlbmRlcmVyJzsKCQkJbGV0IHN2ZyA9IChhd2FpdCBtZXJtYWlkLnJlbmRlcihvRGl2LmlkLCByZXQuQm9keSkpLnN2ZzsKCQkJdGhpcy5wcnZGdW5jKGA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7d2lkdGg6MTAwJTsgaGVpZ2h0OiAxMDAlJz4ke3N2Z308L3N2Zz5gKTsKCQl9CgoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWF3YWl0IHRoaXMucHJ2RnVuYyhgPGRpdj4ke3JldC5Cb2R5fTwvZGl2PmApOwoJCX0KCgkJYXN5bmMgZGVwbG95KHJldCwgdHlwZU5hbWUsIGxhbmcpIHsKCQkJdHlwZU5hbWUgPSB0eXBlTmFtZSB8fCAiQnJvd3NlciI7CgkJCWxldCBzID0gcmV0LkJvZHk7CgkJCWlmIChsYW5nKSBfRnJFTUQuX2JlYXV0aWZ5KHJldC5Cb2R5LCBsYW5nKTsKCgkJCWlmICh0aGlzLm5jKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuZFNjb3BlLk5vZGVfVHlwZShudWxsLCAnR2l0SHViJykuY29kZSh0eXBlTmFtZS50b0xvd2VyQ2FzZSgpKS5uYW1lKHR5cGVOYW1lKS5yZW1hcmsocykuc3RvcmUoKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNjKSB7CgkJCQlyZXR1cm4gYXdhaXQgbmV3IHRoaXMuY21TY29wZS5TdG9yZWRTY3JpcHQobnVsbCwgJ0dpdEh1YicpLmFjdGl2ZSh0cnVlKS5uYW1lKHR5cGVOYW1lKS5zY3JpcHQocykuc3RvcmUoKTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCdkZXBsb3koKTogTm8gZGVwbG95bWVudCBtb2R1bGUnKTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFRhYmxlKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoYAo8ZGl2IGlkID0gImR2UG9zdEluamVjdCIgc3R5bGU9J292ZXJmbG93WT1zY3JvbGwnPmAgKwoJCQkJREZvcm0ucmVuZGVyRWxlbWVudHModGhpcy5lbGVtZW50cy5tYXAoKHMsIGkpID0+ICh7CgkJCQkJbmFtZTogYFJPVyR7aX1gLAoJCQkJCXRpdGxlOiAnICcsCgkJCQkJdHlwZTogImdyaWQiLAoJCQkJCXdpZHRoOiAiMTAwJSIsCgkJCQkJcm93TnVtYmVyczogZmFsc2UsCgkJCQkJcGFnaW5hdGlvbjogZmFsc2UsCgkJCQkJZnJvemVuOiBbXSwKCQkJCQljb2x1bW5zOiBbewoJCQkJCQl0aXRsZTogIlByb3BlcnR5IiwKCQkJCQkJd2lkdGg6ICIzMCUiLAoJCQkJCX0sIHsKCQkJCQkJdGl0bGU6ICJEZXNjcmlwdGlvbiIsCgkJCQkJCXdpZHRoOiAiNzAlIiwKCQkJCQl9XSwKCQkJCQlkYXRhOiBPYmplY3QuZW50cmllcyhzKS5tYXAoZSA9PiAoewoJCQkJCQlQcm9wZXJ0eTogZVswXSwKCQkJCQkJRGVzY3JpcHRpb246IGVbMV0KCQkJCQl9KSksCgkJCQl9KSkpICsgYDwvZGl2Pgo8c2NyaXB0PgoJc2V0VGltZW91dCgoKSA9PiAkLnBhcnNlci5wYXJzZSgiI2R2UG9zdEluamVjdCIpLCAxMDApOwo8L3NjcmlwdD5gKTsKCQl9Cgl9OwoKCVByb3h5Tm9kZVRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXN1cGVyKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspOwoJCX0KCgkJYXN5bmMgcHJlSW5qZWN0KCkgewoJCQl0aGlzLnVybFJlZ2V4ID0gYCgoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KWA7CgkJfQoKCQljcnVkTWV0aG9kcyhjLCB0eXBlKSB7CgkJCXJldHVybiBbewoJCQkJTmFtZTogJ3N0b3JlJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZEFsbCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUlzQXJyYXk6IHRydWUsCgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9LCB7CgkJCQlOYW1lOiAnZmluZCcsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfV0ubWFwKG0gPT4gewoJCQkJbVt0eXBlXSA9IGNbdHlwZV0gPyBjW3R5cGVdW20uTmFtZV0gOiBudWxsOwoJCQkJbS5Jc1B1YmxpYyA9IHRydWU7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBbXTsKCQkJCXJldHVybiBtOwoJCQl9KTsKCQl9Cgl9OwoKCVBsYW50VU1MVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWFzeW5jIHBvc3RJbmplY3QocmV0KSB7CgkJCWxldCBodG1sID0gcmV0LkJvZHkucmVwbGFjZSgvQGVuZHVtbC9nLCBgbGVmdCBmb290ZXIgJHsnXHUwMEE5J30ke25ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKX0gJHt0aGlzLmRhdGEuQ29weXJpZ2h0IHx8ICdGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIGJBc3luYykgewoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIG1vZHVsZSkgewoJCQkJYXdhaXQgdGhpcy5pbXBvcnQobSwgYkFzeW5jKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkge30KCQl2YXIganMgPSBudWxsOwoJCXRyeSB7CgkJCWpzID0gKGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogbW9kdWxlCgkJCX0pKSB8fCAoYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBtb2R1bGUgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJaWYgKCFqcykgewoJCQlqcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBtb2R1bGUuaW5kZXhPZignLycpID49IDAgPyBtb2R1bGUgOiAoQ01TX1JPT1QgKyBtb2R1bGUpCgkJCX0pOwoJCQlpZiAoanMpIGpzID0ganMuU2NyaXB0OwoJCX0KCQlpZiAoIWpzKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMsIGJBc3luYyk7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQlpZiAobG9hZGVyKSB7CgkJCQkvLyBjb25zb2xlLmxvZygibG9hZGVyKClbIiArIG4ubGliICsgIl06ICIsIHR5cGVvZihuLmxvYWQpKTsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZihuLnNyYykgPT09ICd1bmRlZmluZWQnICYmIG4uc2NyaXB0ICYmICFtb2R1bGVzLmxlbmd0aCkgewoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKCFqc0V4dCAmJiAhbi5sb2FkKSByZXQgPSBhd2FpdCByZXMudGV4dCgpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246IiwgZXgsIHMpOwoJCQkJfQoJCQl9CgoJCQlpZiAobi5sb2FkKSB7CgkJCQl0cnkgewoJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06IGNhbGxpbmcgbG9hZCgpIik7CgkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIG1vZHVsZXMsIGV4KTsKCQkJCX0KCQkJfQoJCX0KCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBwb3N0SW5pdCgpIHsKCQl0cnkgewoJCQl3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyID8gd2luZG93LmZyYW1lc1swXS5yZVJlbmRlcigpIDogbnVsbDsKCQl9IGNhdGNoIChleCkge30KCgkJdHJ5IHsKCQkJbGV0IGV2ZW50cyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRXZlbnRzIik7CgkJCWlmICghZXZlbnRzICYmIGNvbXBhbnkuRXZlbnRzKSB7CgkJCQlldmVudHMgPSBhd2FpdCBjb21wYW55LkV2ZW50cygpOwoJCQl9CgkJCShldmVudHMgfHwgW10pLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5mb3JFYWNoKGV2ID0+IHsKCQkJCSQoZXYuX3BhdGgsIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQpLm9uKGV2Ll9ldmVudCwgZXYuX2hhbmRsZXIpOwoJCQl9KTsKCQl9IGNhdGNoIChleCkge30KCX0KCglleGNlbFRvSlNPTihkYXRhLCBzdGFydCwgY291bnQpIHsKCQlpZiAodHlwZW9mKFhMU1gpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIFtdOwoJCXRyeSB7CgkJCXZhciB3b3JrYm9vayA9IFhMU1gucmVhZChkYXRhLCB7CgkJCQl0eXBlOiAnYmluYXJ5JywKCQkJCXNoZWV0Um93czogMCAvKnN0YXJ0ICsgIi0iICsgKHN0YXJ0ICsgY291bnQpKi8KCQkJfSk7CgkJCS8vdmFyIHJhbmdlID0gWExTWC51dGlscy5kZWNvZGVfcmFuZ2Uod29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dWychcmVmJ10pOwoJCQl2YXIgc2hlZXQgPSB3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV07CgkJCXJldHVybiBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLy90aHJvdyBlOwoJCQljb25zb2xlLmxvZygiRVJST1I6IiwgZSk7CgkJCXJldHVybiBbXTsKCQl9Cgl9CgoJYXN5bmMgX3VuemlwKGZpbGUpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJbGV0IGYgPSBhd2FpdCB6aXAubG9hZChmaWxlLCB7CgkJCWJhc2U2NDogdHJ1ZQoJCX0pCgl9CgoJYXN5bmMgX3ppcChmaWxlcykgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlmaWxlcy5mb3JFYWNoKGYgPT4gewoJCQl6aXAuZmlsZShmLm5hbWUsIGYuZmlsZSk7CgkJfSk7CgkJbGV0IHJldCA9IGF3YWl0IHppcC5nZW5lcmF0ZSh7CgkJCXR5cGU6ICdibG9iJywKCQkJY29tcHJlc3Npb246ICJERUZMQVRFIgoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJVXRmOEFycmF5VG9TdHIoYXJyYXkpIHsKCQl2YXIgb3V0LCBpLCBsZW4sIGM7CgkJdmFyIGNoYXIyLCBjaGFyMzsKCgkJb3V0ID0gIiI7CgkJbGVuID0gYXJyYXkubGVuZ3RoOwoJCWkgPSAwOwoJCXdoaWxlIChpIDwgbGVuKSB7CgkJCWMgPSBhcnJheVtpKytdOwoJCQlzd2l0Y2ggKGMgPj4gNCkgewoJCQkJY2FzZSAwOgoJCQkJY2FzZSAxOgoJCQkJY2FzZSAyOgoJCQkJY2FzZSAzOgoJCQkJY2FzZSA0OgoJCQkJY2FzZSA1OgoJCQkJY2FzZSA2OgoJCQkJY2FzZSA3OgoJCQkJCS8vIDB4eHh4eHh4CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDEyOgoJCQkJY2FzZSAxMzoKCQkJCQkvLyAxMTB4IHh4eHggICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgxRikgPDwgNikgfCAoY2hhcjIgJiAweDNGKSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDE0OgoJCQkJCS8vIDExMTAgeHh4eCAgMTB4eCB4eHh4ICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJY2hhcjMgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MEYpIDw8IDEyKSB8CgkJCQkJCSgoY2hhcjIgJiAweDNGKSA8PCA2KSB8CgkJCQkJCSgoY2hhcjMgJiAweDNGKSA8PCAwKSk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBvdXQ7Cgl9CgoJYXN5bmMgX2NvbXByZXNzKHN0cikgewoJCWNvbnN0IGJ5dGVBcnJheSA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwoJCWNvbnN0IGNzID0gbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIik7CgkJY29uc3Qgd3JpdGVyID0gY3Mud3JpdGFibGUuZ2V0V3JpdGVyKCk7CgkJd3JpdGVyLndyaXRlKGJ5dGVBcnJheSk7CgkJd3JpdGVyLmNsb3NlKCk7CgkJcmV0dXJuIG5ldyBSZXNwb25zZShjcy5yZWFkYWJsZSkuYXJyYXlCdWZmZXIoKQoKCQkvLyBDb252ZXJ0IHRoZSBzdHJpbmcgdG8gYSBieXRlIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbc3RyXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJcmV0dXJuIGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7Cgl9CgoJYXN5bmMgX2RlY29tcHJlc3MoY29tcHJlc3NlZEJ5dGVzKSB7CgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW2NvbXByZXNzZWRCeXRlc10pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBkZWNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGRlY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IERlY29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgZGVjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJY29uc3Qgc3RyaW5nQnl0ZXMgPSBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmluZy4KCQlyZXR1cm4gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKHN0cmluZ0J5dGVzKTsKCX0KCglhc3luYyBkb3dubG9hZFNSQ2FjaGUoY29kZSwgZmlsZW5hbWUpIHsKCQkvLyB0byBiZSBtb3ZlZCBvdXQgb2YgdGhpcyBjbGFzcwoJCWNvZGUgPSBjb2RlIHx8IGNvbXBhbnkuQ29kZTsKCQlsZXQgZmlsZXMgPSBhd2FpdCB0aGlzLnNyKCkuXygnQ29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZGFsbCcsIG51bGwsIHsKCQkJQ29kZTogY29kZSArICctJywKCQl9KTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5femlwKGZpbGVzLm1hcChyID0+ICh7CgkJCW5hbWU6IHIuQ29kZS5yZXBsYWNlKGNvZGUgKyAnLScsICcnKSArICcuanMnLAoJCQlmaWxlOiByLlJlc3VsdAoJCX0pKSwgZmlsZW5hbWUgfHwgJ3NyQ2FjaGUuemlwJyk7Cgl9CgoJYXN5bmMgX2dldEJsb2NrKGJsb2NrKSB7CgkJdmFyIGpzID0gbnVsbDsKCQl2YXIgaHRtbCA9IG51bGw7CgkJdGhpcy5ibG9ja3NbYmxvY2tdID0gewoJCQlodG1sOiAiIiwKCQkJb2JqOiBudWxsLAoJCX0KCQl0cnkgewoJCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgYmxvY2suaW5kZXhPZignLycpID49IDAgPyBibG9jayA6ICh0aGlzLmFwaVNlcnZlci5TY29wZSArICcvYmxvY2tzJyArIHRoaXMubSgpICsgIi8iICsgYmxvY2spKS5maW5kKCk7CgkJCQlpZiAocCkgewoJCQkJCWh0bWwgPSBwLmJvZHkoKSA/IHAuX2F0b2IocC5ib2R5KCkpIDogJyc7CgkJCQkJanMgPSBwLnNjcmlwdCgpID8gcC5fYXRvYihwLnNjcmlwdCgpKSA6IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICghanMpIGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIikgfHwgYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pOwoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgkJdHJ5IHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sIHx8IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTZXJ2aWNlUm91dGVyIik7CgkJdGhpcy5faW5pdFNlcnZpY2VSb3V0ZXIoKTsKCgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKSBhd2FpdCBjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCB8fCBbXSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCQl9CgkJfQoKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWlmICh0aGlzLl9fc2NvcGVOYW1lKCkgIT09ICd3aW5kb3cnKSB3aW5kb3dbdGhpcy5fX3Njb3BlTmFtZSgpXSA9IGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKCk7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlvU2NvcGUuaHJlZnMgPSBbLi4ubmV3IFNldChbLi4ubmV3IFNldCgob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLm1hcChjID0+IGMuVG9vbHMpLmZsYXQoKSldLm1hcCh0ID0+IHRoaXMuaHJlZnMuZmlsdGVyKG4gPT4gbi50b29scyAmJiAoIW4udG9vbHMubGVuZ3RoIHx8IG4udG9vbHMuaW5kZXhPZih0KSA+PSAwKSkpLmZsYXQoKSldOwoJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQlpZiAobWMpIHsKCQkJdGhpcy5hcGlTZXJ2ZXIgPSBhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCWluaXROb2RlOiB0cnVlCgkJCX0pOwoJCX0KCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J30/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKCF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0ICQuZ2V0KHVybCk7CgkJCWh0bWwgPSB0aGlzLl9pbmplY3QoaHRtbCwgd2luZG93LnBhcmVudCk7CgoJCQljb25zdCBkb21wID0gbmV3IERPTVBhcnNlcigpOwoJCQlsZXQgZG9jID0gZG9tcC5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQvaHRtbCIpOwoJCQlhd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKGRvYyk7CgkJCWNvbnNvbGUubG9nKCJodG1sIGJpbmRpbmcgZG9uZSEiKTsKCgkJCWh0bWwgPSBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKCQkJLy9odG1sID0gJ3Rlc3QnOwoKCQkJLy93aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uID0gdXJsOwoJCQl3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LndyaXRlKGh0bWwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fYmluZEtPKCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCWFzeW5jIF9iaW5kS08oKSB7CgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA+PSAwKSB7CgkJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQkJLy9hd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIHRydWUpOwoKCQkJCWtvLmNsZWFuTm9kZSh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJa28uYXBwbHlCaW5kaW5ncyh3aW5kb3csIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQl9LCAzMDApOwoJCX0KCX0KCglfc2V0KG9iaiwgcGF0aCwgdmFsKSB7CgkJdmFyIHN0cmluZ1RvUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCQkJLy8gSWYgdGhlIHBhdGggaXNuJ3QgYSBzdHJpbmcsIHJldHVybiBpdAoJCQlpZiAodHlwZW9mIHBhdGggIT09ICdzdHJpbmcnKSByZXR1cm4gcGF0aDsKCQkJLy8gQ3JlYXRlIG5ldyBhcnJheQoJCQl2YXIgb3V0cHV0ID0gW107CgkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggZG90IG5vdGF0aW9uCgkJCXBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CgkJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGJyYWNrZXQgbm90YXRpb24KCQkJCWl0ZW0uc3BsaXQoL1xbKFtefV0rKVxdL2cpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCQkJLy8gUHVzaCB0byB0aGUgbmV3IGFycmF5CgkJCQkJaWYgKGtleS5sZW5ndGggPiAwKSB7CgkJCQkJCW91dHB1dC5wdXNoKGtleSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0pOwoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgkJLy8gQ29udmVydCB0aGUgcGF0aCB0byBhbiBhcnJheSBpZiBub3QgYWxyZWFkeQoJCXBhdGggPSBzdHJpbmdUb1BhdGgocGF0aCk7CgkJLy8gQ2FjaGUgdGhlIHBhdGggbGVuZ3RoIGFuZCBjdXJyZW50IHNwb3QgaW4gdGhlIG9iamVjdAoJCXZhciBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCQl2YXIgY3VycmVudCA9IG9iajsKCQkvLyBMb29wIHRocm91Z2ggdGhlIHBhdGgKCQlwYXRoLmZvckVhY2goZnVuY3Rpb24oa2V5LCBpbmRleCkgewoJCQkvLyBDaGVjayBpZiB0aGUgYXNzaWduZWQga2V5IHNob3VsIGJlIGFuIGFycmF5CgkJCXZhciBpc0FycmF5ID0ga2V5LnNsaWNlKC0yKSA9PT0gJ1tdJzsKCQkJLy8gSWYgc28sIGdldCB0aGUgdHJ1ZSBrZXkgbmFtZSBieSByZW1vdmluZyB0aGUgdHJhaWxpbmcgW10KCQkJa2V5ID0gaXNBcnJheSA/IGtleS5zbGljZSgwLCAtMikgOiBrZXk7CgkJCS8vIElmIHRoZSBrZXkgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBpc24ndCwgY3JlYXRlIGFuIGFycmF5CgkJCWlmIChpc0FycmF5ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50W2tleV0pICE9PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCQljdXJyZW50W2tleV0gPSBbXTsKCQkJfQoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxvb3AsIGFzc2lnbiB0aGUgdmFsdWUKCQkJaWYgKGluZGV4ID09PSBsZW5ndGggLSAxKSB7CgkJCQkvLyBJZiBpdCdzIGFuIGFycmF5LCBwdXNoIHRoZSB2YWx1ZQoJCQkJLy8gT3RoZXJ3aXNlLCBhc3NpZ24gaXQKCQkJCWlmIChpc0FycmF5KSB7CgkJCQkJY3VycmVudFtrZXldLnB1c2godmFsKTsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFtrZXldID0gdmFsOwoJCQkJfQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJZWxzZSB7CgkJCQkvLyBJZiB0aGUga2V5IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdAoJCQkJaWYgKCFjdXJyZW50W2tleV0pIHsKCQkJCQljdXJyZW50W2tleV0gPSB7fTsKCQkJCX0KCQkJCS8vIFVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCQljdXJyZW50ID0gY3VycmVudFtrZXldOwoJCQl9CgkJfSk7Cgl9CgoJX3BhZ2VGaWx0ZXIoYikgewoJCWlmICghYi5fYWN0aXZlKSByZXR1cm4gZmFsc2U7CgkJbGV0IHBhZ2UgPSB0eXBlb2YoX0ZyRU1ELmhhc2gucGFnZSkgPT09ICd1bmRlZmluZWQnID8gJ2luZGV4JyA6IF9GckVNRC5oYXNoLnBhZ2U7CgkJaWYgKHR5cGVvZihiLl9wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGIuX3BhZ2UuX3VybCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gYi5fcGFnZS5fdXJsID09IHBhZ2U7Cgl9CgoJYXN5bmMgX2FwcGx5QmluZGluZ3MoZG9jID0gd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgYkFmdGVyID0gZmFsc2UpIHsKCQl0aGlzLmZyb21IYXNoKCk7CgkJaWYgKHRoaXMuaGFzaC5ub0JpbmRpbmcpIHJldHVybjsKCQlsZXQgYmluZGluZ3MgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkJpbmRpbmdzIik7CgkJaWYgKCFiaW5kaW5ncyAmJiBjb21wYW55LkJpbmRpbmdzKSB7CgkJCWJpbmRpbmdzID0gYXdhaXQgY29tcGFueS5CaW5kaW5ncygpOwoJCX0KCQliaW5kaW5ncyA9IGJpbmRpbmdzIHx8IFtdOwoKCQlzci5ncm91cEJ5KGJpbmRpbmdzLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5maWx0ZXIoYiA9PiBiQWZ0ZXIgPyBiLl9hZnRlciA6ICFiLl9hZnRlciksICJfcGF0aCIpLmZvckVhY2gocGIgPT4gewoJCQl0cnkgewoJCQkJbGV0IGUgPSBkb2MuZXZhbHVhdGUocGIua2V5LCBkb2MsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7CgkJCQlsZXQgZF9iaW5kID0ge307CgkJCQlwYi52YWx1ZXMuZm9yRWFjaChiID0+IHsKCQkJCQl0aGlzLl9zZXQoZF9iaW5kLCBiLl9hdHRyaWJ1dGUsIGIuX2NvZGUpOwoJCQkJfSk7CgkJCQkkKGUpLmF0dHIoImRhdGEtYmluZCIsIEpTT04uc3RyaW5naWZ5KGRfYmluZCkucmVwbGFjZSgvIi9nLCAnJykpOwoJCQkJLy9jb25zb2xlLmxvZyhwYi5rZXksIGUpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2cocGIua2V5LCBleCk7CgkJCX0KCQl9KTsKCX0KCglhc3luYyBpbml0KCkgewoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCWF3YWl0IHRoaXMuX2xvYWRDb250ZW50KCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCV91dWlkKGlkLCBsZW4pIHsKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoaWQpIHsKCQkJbGV0IGhjID0gTWF0aC5hYnMoTnVtYmVyKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnID8gc3IuaGFzaENvZGUoaWQpIDogaWQubGVuZ3RoKSk7CgkJCWxldCBocyA9IGggPT4gTnVtYmVyKFN0cmluZyhoKS5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpKTsKCQkJbGV0IHUgPSBocyhocyhoYykgKiBocyhoYykpLnRvU3RyaW5nKDE2KTsKCgkJCXJldCA9IHUgKyAnJyArIHUgKyAnJyArIHU7CgkJCWlmIChyZXQubGVuZ3RoID4gMzIpIHJldCA9IHJldC5zdWJzdHJpbmcoMCwgMzIpOwoJCX0KCgkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHYoKTsKCgkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpOwoKCQlyZXR1cm4gcmV0LnJlcGxhY2UoL1wtL2csICcnKTsKCX0KCglhc3luYyBfbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKSB7CgkJLy9zY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCBlYXMgPSBbXTsKCgkJaWYgKGVjICYmIGVjLmxpYnJhcnkgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCXRyeSB7CgkJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlDbGFzc2VzKCk6IHJlcXVpcmluZyBzY2hlbWEuLi4iKTsKCQkJCWVjID0gYXdhaXQgdGhpcy5yZXF1aXJlKCdTY2hlbWEnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoKTogc2NoZW1hIGV4Y2VwdGlvbiAiICsgZXgpOwoJCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogY29tcGFueS5TY2hlbWEgfHwgY29tcGFueS5Db2RlLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCX0KCgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShtLCBlYyk7CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKCFlYXMubGVuZ3RoKSB7CgkJCS8vIGNsYXNzZXMgZnJvbSBKU09OIEFycmF5CgkJCWVhcyA9IGVhcy5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcykpOwoJCX0KCgkJcmV0dXJuIGF3YWl0IHRoaXMuX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gW107CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgoJCWlmIChlYXMubGVuZ3RoKSB7CgkJCSh0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpKS5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIikuZm9yRWFjaChnID0+IHsKCQkJCWcua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBnLnZhbHVlczsKCQkJCWcua2V5LkVudGl0eU1vZHVsZSA9IG07CgkJCQlnLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eUNsYXNzID0gZy5rZXkpOwoKCQkJCWlmIChlYyAmJiBBcnJheS5pc0FycmF5KGVjKSkgZWMucHVzaChnLmtleSk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIG5vdCBzdG9yZWQgaW4gRU1TLCBjaGVjayBpZiBhdmFpbGFibGUgYXMgYSBzdG9yZWQgc2NyaXB0CgkJCXRyeSB7CgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlcik7CgkJCQlsZXQgbUVDcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogbU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJCW1FQ3MgPSBtRUNzLmZpbHRlcihjID0+IChtLkV4Y2x1ZGVzIHx8IFtdKS5pbmRleE9mKGMuTmFtZSkgPCAwKTsKCgkJCQltRUNzLmZpbHRlcihjID0+ICFjLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IHsKCQkJCQljLkVudGl0eVJ1bGVzID0gYy5FbnRpdHlSdWxlcyB8fCBbXTsKCQkJCQljLkVudGl0eVJ1bGVzLnB1c2goLi4uKCgobS5FbnRpdHlSdWxlcyB8fCB7fSlbYy5OYW1lXSkgfHwgW10pKTsKCQkJCQljLkVudGl0eU1vZHVsZSA9IG07CgkJCQl9KTsKCQkJCWRlbGV0ZSBtLkVudGl0eVJ1bGVzOwoJCQkJZWMucHVzaCguLi5tRUNzKTsKCgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDbGFzc2VzIiwgZWMubWFwKGMgPT4gYy5FbnRpdHlNb2R1bGUpKTsKCQkJCWZvciBhd2FpdCAoY29uc3QgZG0gb2YgZWMuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgIT0gbU5hbWUpKSB7CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2FuZGlkYXRlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGRtLkVudGl0eU1vZHVsZS5OYW1lKS5sZW5ndGgpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTW9kdWxlIGFscmVhZHkgbG9hZGVkISIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJCWNvbnRpbnVlOwoJCQkJCX0KCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiByZWN1cnNpdmUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZG0uRW50aXR5TW9kdWxlKSB7CgkJCQkJCShkbS5FbnRpdHlNb2R1bGUgfHwgZG0pLkltcG9ydHMrKzsKCQkJCQkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShkbS5FbnRpdHlNb2R1bGUsIGVjKTsKCQkJCQl9CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogRmFpbGVkIGxvYWRpbmcgbW9kdWxlICIgKyBtTmFtZSwgZXgpOwoJCQl9CgkJfQoJfQoKCV9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB7CgkJbGV0IG9Hcm91cGVyID0gdGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKTsKCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKEFycmF5LmlzQXJyYXkoZWMpICYmICEoZWFzIHx8IFtdKS5sZW5ndGgpIHsKCQkJZWMgPSBlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgKHR5cGVvZihjLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGMuQWN0aXZlKSk7CgoJCQllYy5mb3JFYWNoKGMgPT4gewoJCQkJYy5JZCA9IGMuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJYy5QbHVyYWwgPSBjLlBsdXJhbCB8fCAoYy5OYW1lICsgInMiKTsKCQkJCWMuX1RvU3RyaW5nID0gYy5fVG9TdHJpbmcgfHwgYy5OYW1lOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcyB8fCBbXTsKCgkJCQlsZXQgX2Jhc2VfID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZSA9PSAnX19CQVNFX18nKTsKCQkJCWlmIChfYmFzZV8pIHsKCQkJCQlsZXQgcHJvcExpc3QgPSBbJ0lzVW5pcXVlJywgJ0NvZGUnLCAnRGVmYXVsdCcsICdWYWx1ZScsICdSZXF1aXJlZCcsICdEdXBsaWNhdGUnXTsKCQkJCQlwcm9wTGlzdC5maWx0ZXIocCA9PiBBcnJheS5pc0FycmF5KF9iYXNlX1twXSkpLmZvckVhY2gocCA9PiBfYmFzZV9bcF0gPSBPYmplY3QuYXNzaWduKHt9LCAuLi5fYmFzZV9bcF0ubWFwKF9hID0+ICh7CgkJCQkJCVtfYV06IHRydWUKCQkJCQl9KSkpKTsKCgkJCQkJbGV0IGF0dExpc3QgPSBbewoJCQkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiY29kZSIsCgkJCQkJCUlzVW5pcXVlOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJvcmRlciIsCgkJCQkJCUlzSW50OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJuYW1lIiwKCQkJCQkJUmVxdWlyZWQ6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogInJlbWFyayIsCgkJCQkJCUlzVGV4dDogdHJ1ZSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCXRoaXMuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCXRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQlyZXR1cm4gKHMgKyAncycpOwoJfQoKCV9pbml0U2VydmljZVJvdXRlcigpIHsKCQlpZiAodHlwZW9mKFNlcnZpY2VSb3V0ZXIpID09PSAndW5kZWZpbmVkJykgewoJCQljb25zb2xlLmxvZygiRnJFTUQuX2luaXRTZXJ2aWNlUm91dGVyKCk6IFNlcnZpY2VSb3V0ZXIgbm90IGRlZmluZWQuIik7CgkJCXJldHVybjsKCQl9CgkJd2luZG93LnNyID0gd2luZG93LnNyIHx8IG5ldyBTZXJ2aWNlUm91dGVyKCk7CgoJCS8vY29uc29sZS5sb2coIl9pbml0U2VydmljZVJvdXRlcigpOiBjb21wYW55IiwgY29tcGFueSkKCgkJdGhpcy5zcigpLlN0b3JlID0gdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU3RvcmUgOiB1bmRlZmluZWQ7CgkJdGhpcy5zcigpLmluaXQobnVsbCwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LmxpYnJhcnkgOiB1bmRlZmluZWQpIHx8ICJFbnRlcnByaXNlTWFuYWdlciIsIHRydWUsIHRoaXMuYkRlYnVnKTsKCQlpZiAodHlwZW9mIHNyVVJMICE9PSAndW5kZWZpbmVkJykgdGhpcy5zcigpLnNyVVJMID0gc3JVUkw7CgkJdGhpcy5zcigpLmZMb2FkaW5nU3RhcnQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnc2hvdycpOwoJCX07CgkJdGhpcy5zcigpLmZMb2FkaW5nRW5kID0gKCkgPT4gewoJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmxvYWRpbmcoJ2hpZGUnKTsKCQl9OwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHdpbmRvdy5sb2NhdGlvbiA9PT0gd2luZG93LnBhcmVudC5sb2NhdGlvbiAmJiB0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJLy8gaW5zaWRlIGEgd2luZG93CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0gZWxzZSBpZiAodHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCXRoaXMuUmVuZGVyUGFnZSh7CgkJCQlfY29kZTogdXJsLnBhZ2UKCQkJfSwgdXJsKTsKCQl9CgkJbG9jYXRpb24uaGFzaCA9ICIjIiArIHVybDsKCX0KCglmcm9tSGFzaCgpIHsKCQl0aGlzLmhhc2ggPSB7fTsKCQkobG9jYXRpb24uc2VhcmNoICsgbG9jYXRpb24uaGFzaCkucmVwbGFjZSgvIy9nLCAiJiIpLnJlcGxhY2UoL1w/L2csICcnKS5zcGxpdCgiJiIpLmZpbHRlcihlID0+IGUpLmZvckVhY2goZSA9PiB7CgkJCXRyeSB7CgkJCQl0aGlzLmhhc2hbZS5zcGxpdCgiPSIpWzBdXSA9IGUuc3BsaXQoIj0iKVsxXTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coImVuZCgpIHdpdGggZGF0YSIsIGRhdGEpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJLy9vQ29udGVudC5oaWRlKCk7CgkJCS8vb0NvbnRlbnQuZmFkZUluKDEwMDApOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6ICdMb2FkaW5nJywKCQkJCQltc2c6ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCQkJdGl0bGU6ICdQbGVhc2Ugd2FpdGluZycsCgkJCQkJCQltc2c6ICdTYXZpbmcgZGF0YS4uLicsCgkJCQkJCQlpbnRlcnZhbDogb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglzZWxlY3QyU1Iob1NlbGVjdCkgewoJCWxldCBzID0gJChvU2VsZWN0KTsKCQlsZXQgY2FsbHMgPSBbXTsKCQlpZiAodGhpcy5zZWxlY3QyVGVtcGxhdGUpIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSk7CgkJfSBlbHNlIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNyKCkuR2V0KHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi9zZWxlY3QyLXRlbXBsYXRlLmh0bSIpKSk7CgkJfQoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCXRoaXMuc2VsZWN0MlRlbXBsYXRlID0gcmV0WzBdOwoJCQlzLnNlbGVjdDIoewoJCQkJYWpheDogewoJCQkJCXRyYW5zcG9ydDogKHBhcmFtcywgc3VjY2VzcywgZmFpbHVyZSkgPT4gewoJCQkJCQl2YXIgZkZpbHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQoIihvLCBzdGF0ZSkgPT4geyIgKyBzLmRhdGEoInNyX2ZpbHRlciIpICsgIn0iKTsKCQkJCQkJJC53aGVuKHRoaXMuc3IoKS5fKHMuZGF0YSgic3JfbWV0aG9kIiksIG51bGwsIGZGaWx0ZXIoe30sIHRoaXMuc3IoKS5ydW5TY3JpcHQocy5kYXRhKCJjX3N0YXRlIikpKSkpLnRoZW4ocmV0ID0+IHsKCQkJCQkJCXN1Y2Nlc3MoewoJCQkJCQkJCXBhZ2luYXRpb246IHsKCQkJCQkJCQkJbW9yZTogZmFsc2UKCQkJCQkJCQl9LAoJCQkJCQkJCXJlc3VsdHM6ICQubWFwKHJldCwgciA9PiB7CgkJCQkJCQkJCXIuaWQgPSByLklkOwoJCQkJCQkJCQlyLnRleHQgPSByLlRvU3RyaW5nOwoJCQkJCQkJCQlyZXR1cm4gcjsKCQkJCQkJCQl9KSwKCQkJCQkJCQl0b3RhbHM6IHJldC5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9LAoJCQkJdGVtcGxhdGVSZXN1bHQ6IChfZSwgX3MpID0+IHsKCQkJCQlyZXR1cm4gdGhpcy5faW5qZWN0KHRoaXMuc2VsZWN0MlRlbXBsYXRlLCB7CgkJCQkJCWRhdGE6IF9lCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJCWNvbnNvbGUubG9nKGUudGFyZ2V0KTsKCQkJfSk7CgkJCXMub24oImNoYW5nZS5zZWxlY3QyIiwgZSA9PiB7CgkJCQkvL3ZhciBkYXRhID0gZS5wYXJhbXMuZGF0YTsKCQkJCXZhciBfcyA9ICQoZS50YXJnZXQpOwoJCQl9KTsKCQl9KTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQl0cnkgewoJCQkJanN4ID0gYXdhaXQgJC5nZXQodGhpcy5yYW5kVVJMKChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfdnVlQ29tcG9uZW50KGNvZGUpIHsKCQlpZiAodHlwZW9mIFZ1ZSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9yZW5kZXIoKSB1c2luZyBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlci5TY29wZSk7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IHAuc2NyaXB0KCkgPyBwLl9hdG9iKHAuc2NyaXB0KCkpIDogJycsCgkJCQlCb2R5OiBwLmJvZHkoKSA/IHAuX2F0b2IocC5ib2R5KCkpIDogJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0KSByZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKENNU19ST09UKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKS5fKSByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBudWxsOwoJCQl0cnkgewoJCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuaHRtIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSB0cnkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKCFqcyB8fCAhanMub2spIGpzID0gbnVsbDsKCQkJaWYgKGpzICYmIGpzLm9rKSBwYWdlLlNjcmlwdCA9IGF3YWl0IGpzLnRleHQoKTsKCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBzY3JpcHQgaXMiICsgKGpzID8gJycgOiAnIG5vdCcpICsgIiByZXRyaWV2ZWQiKTsKCQkJdGhpcy5zdGVwKCk7CgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgkJcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJLy9jb25zb2xlLmxvZygicGFnZSBCb2R5IiwgcGFnZS5fYm9keSB8fCBwYWdlLkJvZHkpOwoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJdHJ5IHsKCQkJCWxldCBvYmogPSBuZXcgcGFnZS5TY3JpcHQocGFnZSwgREZvcm0pOwoJCQkJcGFnZS5jb21wb25lbnQgPSBvYmo7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgUmVuZGVyUGFnZShwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWRlbGV0ZSB3aW5kb3cuRm9ybUNvbXBvbmVudDsKCQkJJCgiI2Zvcm1Db21wb25lbnQiKS5lbXB0eSgpOwoJCX0KCQl2YXIgX3BhZ2UgPSBhd2FpdCB0aGlzLl9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucyk7CgkJaWYgKCFfcGFnZSkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihnYSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWdhKCdzZW5kJywgewoJCQkJaGl0VHlwZTogJ3BhZ2V2aWV3JywKCQkJCXBhZ2U6ICcvJyArIF9wYWdlLl9jb2RlICsgJy5keW5hbWljJywKCQkJCXRpdGxlOiBfcGFnZS5fdGl0bGUKCQkJfSk7CgkJCWNvbnNvbGUubG9nKCJTZW50IEdBIGhpdCBmb3IgcGFnZTogIiArIChfcGFnZS5fY29kZSB8fCBfcGFnZS5QYWdlIHx8IF9wYWdlKSk7CgkJfQoJCXdpbmRvdy5wYWdlID0gX3BhZ2U7CgkJdGhpcy5hbGxIVE1MID0gdGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkpICsgdGhpcy5ibG9ja3MuZm9vdGVyLmh0bWw7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChqcy5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChqcyk7CgkJCX0gZWxzZSB7CgkJCQlsZXQgc0NvZGUgPSBqczsKCQkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCQl9CgkJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KCIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7Iik7CgkJCX0KCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2EoanMpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBqcy5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQl0cnkgewoJCQkJcmV0dXJuIEpTT04ucGFyc2UoanMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJcmV0dXJuIGV2YWwoanMpOwoJCQl9CgkJfQoJfQp9Ow==",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
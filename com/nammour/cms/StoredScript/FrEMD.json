{
	"Id": "13c25d18de120ff23351e0dced95180beb4ef882",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXykgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlcikgewoJCQlsZXQgX3MgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9hcnpob3NwaXRhbC5naXRodWIuaW8vY29tL25hbW1vdXIvY21zL1N0b3JlZFNjcmlwdC8ke3MuTmFtZSB8fCBzLm5hbWV9Lmpzb24/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJCWlmIChfcy5vaykgc2NyaXB0ID0gYXRvYigoYXdhaXQgX3MuanNvbigpKS5zY3JpcHQpOwoJCX0KCgkJaWYgKHNjcmlwdCkgewoJCQlyZXR1cm4gKGJOb1J1biA/IHNjcmlwdCA6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHNjcmlwdCkpOwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJubyBzdG9yZWQgc2NyaXB0IGxvYWRlciB0byB1c2UiLCBzKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCWFzeW5jIF9pbml0Q29udGVudE1hbmFnZXIoKSB7CgkJbGV0IGFyQ2xhc3NlcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCU5hbWU6ICJDb250ZW50IE1hbmFnZXIiLAoJCQlFbmFibGVkOiB0cnVlLAoJCX0pOwoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGFyQ2xhc3NlcywgImNvbnRlbnRtYW5hZ2VyIik7Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLnNyKCkuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gc2NvcGUgfHwgY29tcGFueS5TY29wZTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuSWQgPyB0bXAgOiAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1BhZ2VUZW1wbGF0ZUZpbmQiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJVHlwZTogewoJCQkJTmFtZTogIkVudGl0eVRlbXBsYXRlIgoJCQl9LAoJCQlOYW1lOiB0bXAuTmFtZSB8fCB0bXAubmFtZSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0KTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0ZW1wbGF0ZVtmXS5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGVtcGxhdGVbZl0gPSB0ZW1wbGF0ZVtmXS5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGVtcGxhdGVbZl0sIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSB3aW5kb3dbc2NvcGVdOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoJCQl0aGlzLnBydkZ1bmMgPSBwcnZGdW5jIHx8ICgoKSA9PiB7fSk7CgkJCXRoaXMubVJhbmsgPSAwOwoKCQkJaWYgKGJSYW5rKSB0aGlzLm1SYW5rID0gTWF0aC5tYXgoMCwgLi4udGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlJhbmspKTsgLy8gdXNlZnVsIGluIHRlbXBsYXRlcwoKCQkJdGhpcy5tYWluVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuc3BsaXQoJy0nKVswXTsKCQkJdGhpcy5zdWJUaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5pbmRleE9mKCctJykgPj0gMCA/IGRhdGEuVGl0bGUuc3BsaXQoJy0nKVsxXSA6ICIiOwoJCX0KCgkJX25ldyhjLCB0b29sLCBpZCkgewoJCQlpZiAoIWMpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKTsKCQkJaWYgKHR5cGVvZihjKSA9PT0gJ3N0cmluZycpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBjKTsKCQkJaWYgKCFjKSByZXR1cm4gbnVsbDsKCgkJCWxldCBtU2NvcGUgPSBjLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKGMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXJldHVybiBuZXcobVNjb3BlW25OYW1lKGMpXSkoaWQsIHRvb2wpOwoJCX0KCgkJY25mKF9jLCBpZCwgZGlkLCB0b29sKSB7CgkJCV9jID0gX2MgfHwgdGhpcy5tYzsKCQkJbGV0IG1TY29wZSA9IF9jLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKF9jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXJldHVybiBtU2NvcGUuX25vZGUgPyBtU2NvcGUuX25vZGUuX19jb25maWcoaWQsIGRpZCwgewoJCQkJdG9vbDogdG9vbAoJCQl9KSA6ICh0aGlzLl9uZXcoX2MsIHRvb2wpLl9fY29uZmlnKGlkLCBkaWQsIHRvb2wgPyB7CgkJCQl0b29sOiB0b29sCgkJCX0gOiB1bmRlZmluZWQpKTsKCQl9CgoJCW5UeXBlKGVhKSB7CgkJCWlmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Jvb2wpIHsKCQkJCXJldHVybiAiYm9vbGVhbiI7CgkJCX0gZWxzZSBpZiAoZWEuSXNGbG9hdCkgewoJCQkJcmV0dXJuICJmbG9hdCI7CgkJCX0gZWxzZSBpZiAoZWEuSXNJbnQgfHwgZWEuSXNMb25nKSB7CgkJCQlyZXR1cm4gIm51bWJlciI7CgkJCX0gZWxzZSBpZiAoZWEuSXNEYXRlKSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCgkJX3QocHJvcCwgb2JqLCBzZWFyY2gpIHsKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBvYmpbcHJvcF07CgoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl90IiwgZXgpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0U1ZHKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoJChgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnIHNyYz0nJHtfRnJFTUQuX3N2Z0Jhc2U2NChyZXQuQm9keSl9Jy8+YCkpOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0ZhZGkgTmFtbW91cid9LCBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5AZW5kdW1sYCkuc3BsaXQoJ0BlbmR1bWwnKS5tYXAoYiA9PiBgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazsgaGVpZ2h0OiAxMDAlJyBzcmM9J2h0dHBzOi8vd3d3LnBsYW50dW1sLmNvbS9wbGFudHVtbC9wbmcvJHt0aGlzLnpvcChiKydAZW5kdW1sJyl9Jy8+YCkuam9pbignPGJyLz4nKTsKCgkJCXRoaXMucHJ2RnVuYygkKGA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBvdmVyZmxvdy15OiBzY3JvbGw7Ij4ke2h0bWx9PC9kaXY+YCkpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJem9wKHMpIHsKCQkJcyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzKSk7CgkJCXZhciBhcnIgPSBbXTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSBhcnIucHVzaChzLmNoYXJDb2RlQXQoaSkpOwoJCQlsZXQgeiA9IG5ldyBab3BmbGkuUmF3RGVmbGF0ZShhcnIpLmNvbXByZXNzKCk7CgkJCXJldHVybiB0aGlzLmVuY29kZTY0Xyh6KTsKCQl9CgoJCWVuY29kZTY0XyhkYXRhKSB7CgkJCWxldCByID0gIiI7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMykgewoJCQkJaWYgKGkgKyAyID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgMCk7CgkJCQl9IGVsc2UgaWYgKGkgKyAxID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCAwLCAwKTsKCQkJCX0gZWxzZSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgZGF0YVtpICsgMl0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiByOwoJCX0KCgkJYXBwZW5kM2J5dGVzKGIxLCBiMiwgYjMpIHsKCQkJbGV0IGMxID0gYjEgPj4gMjsKCQkJbGV0IGMyID0gKChiMSAmIDB4MykgPDwgNCkgfCAoYjIgPj4gNCk7CgkJCWxldCBjMyA9ICgoYjIgJiAweEYpIDw8IDIpIHwgKGIzID4+IDYpOwoJCQlsZXQgYzQgPSBiMyAmIDB4M0Y7CgkJCWxldCByID0gIiI7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMxICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMyICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMzICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGM0ICYgMHgzRik7CgkJCXJldHVybiByOwoJCX0KCgkJZW5jb2RlNmJpdChiKSB7CgkJCWlmIChiIDwgMTApIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDQ4ICsgYik7CgkJCX0KCQkJYiAtPSAxMDsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiID09IDApIHsKCQkJCXJldHVybiAnLSc7CgkJCX0KCQkJaWYgKGIgPT0gMSkgewoJCQkJcmV0dXJuICdfJzsKCQkJfQoJCQlyZXR1cm4gJz8nOwoJCX0KCX0KCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQpIHsKCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJbGV0IHJldCA9IG51bGw7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoanNFeHQpIHJldHVybiByZXQ7CgkJCQkJCQkJaWYgKCFuLmxvYWQpIHJldHVybiBhd2FpdCByZXMudGV4dCgpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246IiwgZXgsIHMpOwoJCQkJfQoJCQl9CgoJCQlpZiAobi5sb2FkKSB7CgkJCQl0cnkgewoJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06IGNhbGxpbmcgbG9hZCgpIik7CgkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIG1vZHVsZXMsIGV4KTsKCQkJCX0KCQkJfQoJCX0KCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXRoaXMuYmxvY2tzW2Jsb2NrXSA9IHsKCQkJaHRtbDogIiIsCgkJCW9iajogbnVsbCwKCQl9CgkJdHJ5IHsKCQkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykucGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArIGJsb2NrLmluZGV4T2YoJy8nKSA+PSAwID8gYmxvY2sgOiAodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAnL2Jsb2NrcycgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrKSkuZmluZCgpOwoJCQkJaWYgKHApIHsKCQkJCQlodG1sID0gcC5ib2R5KCkgPyBwLl9hdG9iKHAuYm9keSgpKSA6IG51bGw7CgkJCQkJanMgPSBwLnNjcmlwdCgpID8gcC5fYXRvYihwLnNjcmlwdCgpKSA6IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICghanMpIGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIikgfHwgYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pOwoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgkJdHJ5IHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sIHx8IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCIuLi8uLi8iICsgKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJDb21wYW55Iik7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29tcGFueS5TY29wZSA9IGNvbXBhbnkuU2NvcGUgfHwgIndpbmRvdyI7CgkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZSArICI6IGxvYWRpbmcuLi4iOwoJCX0KCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTZXJ2aWNlUm91dGVyIik7CgkJdGhpcy5faW5pdFNlcnZpY2VSb3V0ZXIoKTsKCgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJaWYgKGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKSBhd2FpdCBjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwpOwoJCQl9CgkJfQoKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcygpOwoJCWF3YWl0IHRoaXMuX2luaXRDb250ZW50TWFuYWdlcigpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQlsZXQgb1Njb3BlID0gdGhpcy5zcigpLl9fc2NvcGUoY29tcGFueS5TY29wZSk7IC8vd2luZG93W2NvbXBhbnkuU2NvcGVdOwoJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KG9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuVG9vbHMpLmZsYXQoKSldLm1hcCh0ID0+IHRoaXMuaHJlZnMuZmlsdGVyKG4gPT4gbi50b29scyAmJiAoIW4udG9vbHMubGVuZ3RoIHx8IG4udG9vbHMuaW5kZXhPZih0KSA+PSAwKSkpLmZsYXQoKSldOwoJCWxldCBtYyA9IG9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklzTWFpbik7CgkJaWYgKG1jKSB7CgkJCWF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCWxvYWRUb29sczogdHJ1ZSwKCQkJCWluaXRTZWxmOiB0cnVlLAoJCQkJaW5pdE5vZGU6IHRydWUKCQkJfSk7CgkJfQoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSBzY29wZSB8fCBjb21wYW55LlNjb3BlOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5jb250ZW50IHx8IGF3YWl0IGZldGNoKGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9P3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCWxldCByZXQgPSB0aGlzLl9pbmplY3QodGVtcGxhdGUsIHsKCQkJb1Njb3BlOiB3aW5kb3dbc2NvcGVdLAoJCQltZTogd2luZG93Lm1lLAoJCQlzY29wZSwKCQkJb3B0aW9ucywKCQl9LCBvcHRpb25zLmVuZ2luZSk7CgoJCWlmICh0aGlzLl9iZWF1dGlmeSkgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCB0bXAubGFuZ3VhZ2UpOwoJCWlmICghdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCAkLmdldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCXNjb3BlID0gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCkgfHwgIndpbmRvdyI7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCXRyeSB7CgkJCQllYyA9IGF3YWl0IHRoaXMucmVxdWlyZSgnU2NoZW1hJyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IGNvbXBhbnkuQ29kZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQl9CgoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIHsKCQkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShtLCBlYyk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmIChzY29wZSAhPT0gIndpbmRvdyIpIHsKCQkJaWYgKHR5cGVvZih3aW5kb3dbc2NvcGVdKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCS8vIGNsZWFudXAgdGhlIG9sZCBzY29wZQoJCQkJZGVsZXRlIHdpbmRvd1tzY29wZV07CgkJCX0KCQkJd2luZG93W3Njb3BlXSA9IHt9OwoJCX0KCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5FbnRpdHlDbGFzc2VzID0gcmV0OwoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0ID0gKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQgfHwge307CgkJaWYgKHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0LkRhdGUgPSB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUF0dHJpYnV0ZXMgPSBlYXM7CgoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6ICJBUElTeXN0ZW0iLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJfSk7CgkJfQoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJRW50aXR5Q2xhc3M6IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6IG1OYW1lCgkJCQl9CgkJCX0KCQl9KTsKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJkYXRlIiwKCQkJCQkJSXNEYXRlOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiAnbmV3IERhdGUoKScsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJfV07CgkJCQkJYXR0TGlzdC5mb3JFYWNoKGEgPT4gcHJvcExpc3QuZmlsdGVyKHAgPT4gX2Jhc2VfW3BdKS5mb3JFYWNoKHAgPT4gYVtwXSA9IF9iYXNlX1twXVthLk5hbWVdKSk7CgkJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYXR0TGlzdC5jb25jYXQoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9PSAiX19CQVNFX18iKSk7CgkJCQl9CgoJCQkJWydFbnRpdHlBdHRyaWJ1dGVzJywgJ0VudGl0eUZpZWxkcyddLmZpbHRlcihlVHlwZSA9PiBjW2VUeXBlXSkuZm9yRWFjaChlVHlwZSA9PiBjW2VUeXBlXS5maWx0ZXIoZWEgPT4gZWEuRHVwbGljYXRlKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlsZXQgc2VhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzBdKVtlVHlwZV0uZmluZChzZWEgPT4gc2VhLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMV0pOwoJCQkJCU9iamVjdC5rZXlzKHNlYSkuZmlsdGVyKGsgPT4gWyJFbnRpdHlDbGFzcyJdLmluZGV4T2YoaykgPCAwKS5mb3JFYWNoKGsgPT4gewoJCQkJCQlpZiAoayA9PSAnRGVmYXVsdCcgJiYgdHlwZW9mKHNlYVtrXSkgPT09ICdzdHJpbmcnICYmICFzZWFba10uaW5kZXhPZignLyoqZ2VuZXJhdGVkKiovJykpIHJldHVybjsKCQkJCQkJZWFba10gPSBzZWFba107CgkJCQkJfSk7CgkJCQl9KSk7CgoJCQkJYy5UeXBlZEF0dHJpYnV0ZXMgPSBjLlR5cGVkQXR0cmlidXRlcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG0uTWV0aG9kUGFyYW1ldGVycyB8fCBbXTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5wdXNoKC4uLmMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gIXAuSWQpKS5mbGF0KCkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiB0eXBlb2YoZWEuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgZWEuQWN0aXZlKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5VHlwZSB8fCAoZWEuRW50aXR5VHlwZSAmJiBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gewoJCQkJCWlmICghZWEuTmFtZSkgewoJCQkJCQljb25zb2xlLmxvZyhjLk5hbWUgKyAiIGhhcyBBdHRyaWJ1dGUgd2l0aG91dCBOYW1lIiwgZWEpOwoJCQkJCX0KCQkJCQllYS5JZCA9IGVhLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQllYS5fVG9TdHJpbmcgPSBlYS5fVG9TdHJpbmcgfHwgZWEuTmFtZTsKCQkJCQllYS5Hcm91cCA9IGVhLkdyb3VwIHx8ICJNYWluIjsKCQkJCQllYS5FbnRpdHlDbGFzcyA9IGM7CgkJCQl9KTsKCgkJCQlvR3JvdXBlci5ncm91cEJ5KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbmQodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uSWQgPSBtLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQltLl9Ub1N0cmluZyA9IG0uX1RvU3RyaW5nIHx8IG0uTmFtZTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4gcC5FbnRpdHlNZXRob2QgPSBtKTsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlICYmICFwLkVudGl0eVR5cGUuSWQpLmZvckVhY2gocCA9PiB7CgkJCQkJCXAuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBwLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJfSk7CgoJCQkJCWlmICghbS5SZXNwb25zZUF0dHJpYnV0ZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgUmVzcG9uc2VBdHRyaWJ1dGUgZm9yIG1ldGhvZCAiICsgbS5OYW1lICsgIi4gRGVmYXVsdGluZyB0byBvYmplY3QgcmV0dXJuIChyZXQiICsgbS5OYW1lICsgIikiKTsKCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCQkJCUlzT2JqZWN0OiB0cnVlLAoJCQkJCQl9OwoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgPSBtLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgfHwgKCJyZXQiICsgbS5OYW1lKTsKCgkJCQkJaWYgKG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSB7CgkJCQkJCWxldCByYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJCWlmICghcmEpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBFbnRpdHlUeXBlIE5hbWU9IiArIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUgPSByYTsKCQkJCQkJfQoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eU1ldGhvZCA9IG07CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMgPSB0aGlzLl91bmlxdWUoYy5FbnRpdHlNZXRob2RzKTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzU3RyaW5nICYmICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkRlZmF1bHQgJiYgKGVhLlJlcXVpcmVkIHx8IGVhLklzVW5pcXVlKSkuZm9yRWFjaChlYSA9PiBlYS5EZWZhdWx0ID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihyYSA9PiAhcmEuRW50aXR5TWV0aG9kICYmIHJhLkVudGl0eVR5cGUgJiYgKHJhLklzVW5pcXVlIHx8IHJhLlJlcXVpcmVkKSkubWFwKHJhID0+IGAvKipnZW5lcmF0ZWQqKi8odGhpcy4ke3JhLk5hbWV9KCk/dGhpcy4ke3JhLk5hbWV9KCkuJHtlYS5OYW1lfSgpOidudWxsJylgKS5qb2luKGAgKyAnLScgKyBgKSk7CgkJCX0pOwoKCQkJLypvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5lYy5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCQllYy5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkKS5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoJCQl9KTsqLwoKCQkJcmV0ID0gdGhpcy5fdW5pcXVlKGVjKTsKCQl9IGVsc2UgaWYgKCFlYyB8fCAhQXJyYXkuaXNBcnJheShlYykpIHsKCQkJdmFyIGNsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIik7CgoJCQl2YXIgdENsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eVR5cGUiKTsKCQkJY2xhc3Nlcy5mb3JFYWNoKGMgPT4gewoJCQkJaWYgKCFjLmtleSkgewoJCQkJCWNvbnNvbGUubG9nKCJFbXB0eSBrZXkiLCBjKTsKCQkJCX0KCQkJCWMua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBjLnZhbHVlczsKCgkJCQl2YXIgdGFzID0gdENsYXNzZXMuZmluZCh0YyA9PiB0Yy5rZXkgJiYgYy5rZXkgJiYgdGMua2V5LklkID09PSBjLmtleS5JZCk7CgkJCQkvL2Mua2V5LlR5cGVkQXR0cmlidXRlcyA9IHRhcyA/IHRhcy52YWx1ZXMgOiBbXTsKCQkJCWMua2V5LkVudGl0eU1ldGhvZHMgPSBjLmtleS5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQl9KTsKCQkJcmV0ID0gY2xhc3Nlcy5tYXAoYSA9PiBhLmtleSk7CgoJCQlvR3JvdXBlci5ncm91cEJ5KGVhcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQltLkVudGl0eUNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLklkID09IG0uRW50aXR5Q2xhc3NpZCk7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpWzBdOwoKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQl9KTsKCQl9CgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMgPSAoYy5FbnRpdHlGaWVsZHMgfHwgW10pLmZpbHRlcihmID0+ICFmLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuRW50aXR5Q2xhc3MgPSBjKTsKCQl9KTsKCgkJbGV0IHRyQ2xhc3MgPSByZXQuZmluZChjID0+IGMuTmFtZSA9PSAiVHJhbnNhY3Rpb24iICYmIGMuRW50aXR5TW9kdWxlKTsKCQlpZiAodHJDbGFzcykgcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSXNTeW5jICYmICFtLlJlc3BvbnNlTWV0aG9kKS5mb3JFYWNoKG0gPT4gewoJCQltLlJlc3BvbnNlTWV0aG9kID0gewoJCQkJTmFtZTogbS5OYW1lICsgIlJlc3BvbnNlIiwKCQkJCU1ldGhvZFBhcmFtZXRlcnM6IFt7CgkJCQkJTmFtZTogInRyYW5zYWN0aW9uIiwKCQkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzCgkJCQl9XSwKCQkJCVNjcmlwdDogYHJldHVybiBhd2FpdCB0cmFuc2FjdGlvbi5jbGFzcygiJHtjLk5hbWV9IikubWV0aG9kKCIke20uTmFtZX0iKS5hc3luY1Jlc3VsdCgiJHttLlJlc3BvbnNlQXR0cmlidXRlPy5FbnRpdHlUeXBlPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJyl9IiwgJHttLlJlc3BvbnNlQXR0cmlidXRlLklzQXJyYXk/InRydWUiOiJmYWxzZSJ9KWAsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogbS5SZXNwb25zZUF0dHJpYnV0ZSwKCQkJfTsKCQkJYy5FbnRpdHlNZXRob2RzLnB1c2gobS5SZXNwb25zZU1ldGhvZCk7CgoJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJTmFtZTogYHJldCR7bS5OYW1lfWAsCgkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzLAoJCQl9CgkJfSkpOwoKCQlvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQlsZXQgX2MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCB8fCAoYy5OYW1lID09IGN0YS5rZXkuTmFtZSAvKiYmIGMuRW50aXR5TW9kdWxlICYmIGN0YS5rZXkuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gY3RhLmtleS5FbnRpdHlNb2R1bGUuTmFtZSovICkpOwoJCQlpZiAoIV9jKSB7CgkJCQljb25zb2xlLmxvZygiTm8gY2xhc3MgZm91bmQgdG8gbWF0Y2ggIiArIGN0YS5rZXkuTmFtZSk7CgkJCX0gZWxzZSB7CgkJCQlfYy5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoKCQkJCWN0YS52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gX2MpOyAvLz8/PwoJCQl9CgkJfSk7CgoJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCAmJiAhcmV0LmZpbmQoYyA9PiBjLklzTWFpbikpIHsKCQkJcmV0WzBdLklzTWFpbiA9IHRydWU7CgkJCXJldFswXS5PcmRlciA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoJCX0KCgkJbGV0IGNSYW5rID0gKGMsIHNvdXJjZXMgPSBbXSkgPT4gewoJCQlzb3VyY2VzLnB1c2goYy5OYW1lKTsKCQkJcmV0dXJuIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlICE9PSBjICYmIHNvdXJjZXMuaW5kZXhPZihlYS5FbnRpdHlUeXBlLk5hbWUpIDwgMCkubWFwKGVhID0+IGNSYW5rKGVhLkVudGl0eVR5cGUsIHNvdXJjZXMpKS5jb25jYXQoWzFdKS5yZWR1Y2UoKHN1bSwgeCkgPT4gc3VtICsgeCk7CgkJfTsKCgkJLy8gb3JkZXIgYnkgb3JkZXIKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5PcmRlciA9IGMuT3JkZXIgfHwgMDsKCQkJYy5SYW5rID0gY1JhbmsoYyk7CgkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IGVhLk9yZGVyID0gZWEuT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKGVtID0+IGVtLk9yZGVyID0gZW0uT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuT3JkZXIgPSBlZi5PcmRlciB8fCAwKTsKCQl9KTsKCQlyZXQuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUZpZWxkcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgoJCWlmIChyZXQubGVuZ3RoKSB7CgkJCVsnRGVidWcnLCAnQ29uZmlnJywgJ1Rlc3QnLCAnVG9vbHMnLCAnTWFwcGluZ3MnLCAnUm91dGluZycsICdWYWxpZGF0b3JzJywgJ01ldGhvZFJ1bGVzJywgJ0VudGl0eVJ1bGVzJ10uZm9yRWFjaChhID0+IHsKCQkJCWxldCBtY0EgPSByZXRbMF1bYV07CgkJCQlkZWxldGUgcmV0WzBdW2FdOwoJCQkJcmV0LmZvckVhY2goYyA9PiB7CgkJCQkJY1thXSA9IGNbYV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uW2MuTmFtZV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uWycqJ10gfHwgYy5FbnRpdHlNb2R1bGU/LlthXSB8fCBtY0E/LltjLk5hbWVdIHx8IG1jQT8uWycqJ10gfHwgbWNBIHx8IHt9OwoJCQkJCWlmIChhLmVuZHNXaXRoKCdzJykgJiYgIUFycmF5LmlzQXJyYXkoY1thXSkpIGNbYV0gPSBPYmplY3Qua2V5cyhjW2FdKTsKCQkJCX0pOwoJCQl9KTsKCgkJCXJldC5maWx0ZXIoYyA9PiAhYy5Jc01haW4pLmZvckVhY2goYyA9PiBjLkNvbmZpZyA9IE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXQuZmluZChfYyA9PiBfYy5Jc01haW4pLkNvbmZpZykpLCBjLkNvbmZpZykpOwoKCQkJcmV0LmZpbHRlcihjID0+IGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IGMuRW50aXR5TW9kdWxlID0gYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJX19zY29wZShzY29wZSkgewoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlKSB7CgkJbGV0IG9TY29wZSA9IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKTsKCgkJb1Njb3BlLm5OYW1lID0gb1Njb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlvU2NvcGUubkNvZGUgPSBvU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJLy9sZXQgaHRtbCA9IGF3YWl0ICQuZ2V0KChzci5iTG9jYWwgPyAiL25hbW1vdXIuY29tL2Vtcy8iIDogIiIpICsgInNjcmlwdC9FbnRpdHlDbGFzcy5qc3QiICsgIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpKTsKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgewoJCQlsZXQgc05hbWUgPSBtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJyk7CgoJCQlodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShzTmFtZSkpOwoKCQkJLypsZXQgY29kZSA9IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IChzci5iTG9jYWwgPyAiL25hbW1vdXIuY29tL2Vtcy8iIDogIiIpICsgInNjcmlwdC8iICsgbVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikgKyAiP3JhbmQ9IiArIE1hdGgucmFuZG9tKCksCgkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCX0pOwoJCQlodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGNvZGUpOyovCgkJfQoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAiIjsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJYzogYywKCQkJCXNjb3BlOiBzY29wZSwKCQkJCW5OYW1lOiBvU2NvcGUubk5hbWUsCgkJCQluQ29kZTogb1Njb3BlLm5Db2RlLAoJCQl9KSArICdcbicgKyBvU2NvcGUubk5hbWUoYyk7CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlICs9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke29TY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtvU2NvcGUubk5hbWUoYyl9ID0gJHtvU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gb1Njb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW29TY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQkJaWYgKGMuSXNNYWluKSB7CgkJCQkvL2FsaWFzLkdlbmVyaWNTZXJ2aWNlQVBJID0gR2VuZXJpY1NlcnZpY2VBUEk7CgkJCX0KCQl9CgoJCXJldHVybiBfY29kZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzID0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2Nsb25lRnVuY3Rpb24obywgZiwgc2NvcGUsIGMpIHsKCQlsZXQgY29kZSA9IHdpbmRvd1tvXVtmXSA/IHdpbmRvd1tvXVtmXS50b1N0cmluZygpIDogYCAgICR7Zn0oKXsKCQkgICAgY29uc29sZS5sb2coJ0Vycm9yIGluIF9GckVNRC5fY2xvbmVGdW5jdGlvbigke299LCAke2Z9KTogSW52YWxpZCBGdW5jdGlvbiBOYW1lJyk7CgkgICAgfWA7CgkJbGV0IHMgPSBjb2RlLnJlcGxhY2UoJyknLCAnKSA9PiAnKTsKCQlpZiAocy5pbmRleE9mKCdmdW5jdGlvbicpID09IDAgfHwgcy5pbmRleE9mKCdhc3luYyBmdW5jdGlvbicpID09IDApIHsKCQkJcyA9IHMucmVwbGFjZSgnZnVuY3Rpb24nLCAnICcpOwoJCX0gZWxzZSB7CgkJCXMgPSBzLnJlcGxhY2UoZiwgJycpOwoJCX0KCgkJaWYgKGMuSXNNYWluICYmICF3aW5kb3dbb11bZl0pIHsKCQkJY29uc29sZS5sb2coJ0Vycm9yIGluIF9GckVNRC5fY2xvbmVGdW5jdGlvbigpOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUgJyArIGYpOwoJCX0KCgkJcmV0dXJuIGAKICAgICR7Zn0oLi4ucGFyYW1zKXsKICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuJHtvfSkhPT0idW5kZWZpbmVkIil7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuJHtvfS4ke2Z9KC4uLnBhcmFtcyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGAgKyAoYy5Jc01haW4gPyBgcmV0dXJuICgke3N9KSguLi5wYXJhbXMpO2AgOiBgcmV0dXJuIG5ldyAke3Njb3BlfS4ke3dpbmRvd1tzY29wZV0uRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbikuTmFtZS5yZXBsYWNlKC8gL2csICdfJyl9KCkuJHtmfSguLi5wYXJhbXMpO2ApICsgYAogICAgICAgIH0KCX0KYDsKCX0KCglfaW5pdFNlcnZpY2VSb3V0ZXIoKSB7CgkJaWYgKHR5cGVvZihTZXJ2aWNlUm91dGVyKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELl9pbml0U2VydmljZVJvdXRlcigpOiBTZXJ2aWNlUm91dGVyIG5vdCBkZWZpbmVkLiIpOwoJCQlyZXR1cm47CgkJfQoJCXdpbmRvdy5zciA9IG5ldyBTZXJ2aWNlUm91dGVyKCk7CgoJCXRoaXMuc3IoKS5TdG9yZSA9IGNvbXBhbnkuU3RvcmU7CgkJdGhpcy5zcigpLmluaXQobnVsbCwgY29tcGFueS5saWJyYXJ5IHx8ICJFbnRlcnByaXNlTWFuYWdlciIsIHRydWUsIHRoaXMuYkRlYnVnKTsKCQlpZiAodHlwZW9mIHNyVVJMICE9PSAndW5kZWZpbmVkJykgdGhpcy5zcigpLnNyVVJMID0gc3JVUkw7CgkJdGhpcy5zcigpLmZMb2FkaW5nU3RhcnQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnc2hvdycpOwoJCX07CgkJdGhpcy5zcigpLmZMb2FkaW5nRW5kID0gKCkgPT4gewoJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmxvYWRpbmcoJ2hpZGUnKTsKCQl9OwoJfQoKCV9pbmNsdWRlKF9ocmVmKSB7CgkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJfQoKCV9jc3MobGluaywgcmVsID0gInN0eWxlc2hlZXQiKSB7CgkJY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKCQlsLnNldEF0dHJpYnV0ZSgncmVsJywgcmVsKTsKCQlsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxpbmspOwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobCk7Cgl9CgoJdG9QREYoZmlsZW5hbWUsIHBhZ2VzKSB7CgkJaWYgKCFwYWdlcyB8fCAhcGFnZXMubGVuZ3RoKSBwYWdlcyA9IFtkb2N1bWVudC5ib2R5XTsKCQlsZXQgcGRmID0gbmV3IGpzUERGKCdwJywgJ21tJywgJ2E0Jyk7CgkJdmFyIGNhbGxzID0gJC5tYXAocGFnZXMsIHAgPT4gaHRtbDJjYW52YXMocCwgewoJCQlzY2FsZTogMQoJCX0pKTsKCQkkLndoZW4oLi4uY2FsbHMpLnRoZW4oKC4uLmFyQ2FudmFzKSA9PiB7CgkJCSQuZWFjaChhckNhbnZhcywgKGksIGMpID0+IHsKCQkJCWlmIChpKSBwZGYuYWRkUGFnZSgpOwoJCQkJcGRmLmFkZEltYWdlKGMudG9EYXRhVVJMKCdpbWFnZS9wbmcnKSwgJ1BORycsIDAsIDAsIDIwMCwgMjAwKTsKCQkJfSk7CgkJCXBkZi5zYXZlKGZpbGVuYW1lKTsKCQl9KTsKCX0KCglzdGVwKCkgewoJCXRyeSB7CgkJCWlmICghbG9hZGluZy5sb2FkZXIpIHsKCQkJCSQoImJvZHkiKS5hcHBlbmQoIjxjZW50ZXI+PGRpdiBpZD0ndG9wTG9hZGVyJz48L2Rpdj48L2NlbnRlcj4iKTsKCQkJCWxvYWRpbmcubG9hZGVyID0gJCgiI3RvcExvYWRlciIpLnBlcmNlbnRhZ2VMb2FkZXIoewoJCQkJCXdpZHRoOiAyNTYsCgkJCQkJaGVpZ2h0OiAyNTYsCgkJCQkJY29udHJvbGxhYmxlOiB0cnVlLAoJCQkJCXByb2dyZXNzOiAwLAoJCQkJCW9uUHJvZ3Jlc3NVcGRhdGU6ICh2YWwpID0+IHsKCQkJCQkJbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoTWF0aC5yb3VuZCh2YWwgKiAxMDAuMCkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCQl0cnkgewoJCQlsb2FkaW5nLmxvYWRlci5zZXRQcm9ncmVzcygobG9hZGluZy5wb3NpdGlvbisrKSAvIGxvYWRpbmcuc3RlcHMpOwoJCQkvL2xvYWRpbmcubG9hZGVyLnNldFZhbHVlKDEwMCpsb2FkaW5nLnBvc2l0aW9uL2xvYWRpbmcuc3RlcHMgKyAnJScpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9Cgl9CgoJX2FwcGx5KG8sIGZuLCBzY29wZSA9IFtdKSB7CgkJZm9yIChsZXQgaSBpbiBvKSB7CgkJCWZuLmFwcGx5KHRoaXMsIFtpLCBvW2ldLCBzY29wZV0pOwoJCQlpZiAob1tpXSAhPT0gbnVsbCAmJiB0eXBlb2Ygb1tpXSA9PT0gIm9iamVjdCIpIHsKCQkJCXRoaXMuX2FwcGx5KG9baV0sIGZuLCBzY29wZS5jb25jYXQoaSkpOwoJCQl9CgkJfQoJfQoKCXNldFVSTCh1cmwpIHsKCQlpZiAodGhpcy5hbGxEYXRhLnBhZ2UpIGhpc3RvcnkucHVzaFN0YXRlKHsKCQkJX2NvZGU6IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlCgkJfSwgdGhpcy5hbGxEYXRhLnBhZ2UuX3RpdGxlLCB0aGlzLnRvSGFzaCgpKTsKCgkJaWYgKHdpbmRvdy5sb2NhdGlvbiA9PT0gd2luZG93LnBhcmVudC5sb2NhdGlvbiAmJiB0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJLy8gaW5zaWRlIGEgd2luZG93CgkJCWxldCBzVVJMID0gIiI7CgkJCXRoaXMuX2FwcGx5KHVybCwgKGtleSwgdmFsdWUsIHNjb3BlKSA9PiBzVVJMICs9ICh0eXBlb2YodmFsdWUpICE9PSAib2JqZWN0IiA/IChzY29wZS5tYXAoeCA9PiB4ICsgIi4iKS5qb2luKCcnKSArIGtleSArICI9IiArIHZhbHVlICsgIiYiKSA6ICIiKSk7CgkJCXVybCA9IHNVUkw7CgkJCS8vY29uc29sZS5sb2coInNldFVSTDogdXJsIiwgdXJsKQoJCX0gZWxzZSBpZiAodHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCXRoaXMuUmVuZGVyUGFnZSh7CgkJCQlfY29kZTogdXJsLnBhZ2UKCQkJfSwgdXJsKTsKCQl9CgkJbG9jYXRpb24uaGFzaCA9ICIjIiArIHVybDsKCX0KCglmcm9tSGFzaCgpIHsKCQl0aGlzLmhhc2ggPSB7fTsKCQkobG9jYXRpb24uc2VhcmNoICsgbG9jYXRpb24uaGFzaCkucmVwbGFjZSgvIy9nLCAiJiIpLnJlcGxhY2UoL1w/L2csICcnKS5zcGxpdCgiJiIpLmZpbHRlcihlID0+IGUpLmZvckVhY2goZSA9PiB7CgkJCXRyeSB7CgkJCQl0aGlzLmhhc2hbZS5zcGxpdCgiPSIpWzBdXSA9IGUuc3BsaXQoIj0iKVsxXTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJfSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJYXN5bmMgZW5kKGZDYWxsQmFjaywgZGF0YSkgewoJCWlmICh0aGlzLmVuZENhbGxlZCkgcmV0dXJuOwoJCXRoaXMuZW5kQ2FsbGVkID0gdHJ1ZTsKCQlpZiAoIWRhdGEpIGRhdGEgPSB3aW5kb3cucGFnZS5kYXRhIHx8IHt9OwoJCS8vZGF0YS5wYWdlcyA9IHRoaXMuYWxsRGF0YS5wYWdlczsKCQkvL2RhdGEucGFnZSA9IHRoaXMuYWxsRGF0YS5wYWdlOwoJCWF3YWl0IHRoaXMuZG9DYWxscygpOwoJCWlmIChmQ2FsbEJhY2spIHsKCQkJYXdhaXQgZkNhbGxCYWNrKCk7CgkJfQoJCS8vY29uc29sZS5sb2coImVuZCgpIHdpdGggZGF0YSIsIGRhdGEpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCQlpZiAoIXRoaXMuaXNNb2JpbGUoKSkgewoJCQlvQ29udGVudC5odG1sKHNIVE1MKTsKCQkJLy9vQ29udGVudC5oaWRlKCk7CgkJCS8vb0NvbnRlbnQuZmFkZUluKDEwMDApOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6ICdMb2FkaW5nJywKCQkJCQltc2c6ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCQkJdGl0bGU6ICdQbGVhc2Ugd2FpdGluZycsCgkJCQkJCQltc2c6ICdTYXZpbmcgZGF0YS4uLicsCgkJCQkJCQlpbnRlcnZhbDogb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglzZWxlY3QyU1Iob1NlbGVjdCkgewoJCWxldCBzID0gJChvU2VsZWN0KTsKCQlsZXQgY2FsbHMgPSBbXTsKCQlpZiAodGhpcy5zZWxlY3QyVGVtcGxhdGUpIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSk7CgkJfSBlbHNlIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNyKCkuR2V0KHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi9zZWxlY3QyLXRlbXBsYXRlLmh0bSIpKSk7CgkJfQoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCXRoaXMuc2VsZWN0MlRlbXBsYXRlID0gcmV0WzBdOwoJCQlzLnNlbGVjdDIoewoJCQkJYWpheDogewoJCQkJCXRyYW5zcG9ydDogKHBhcmFtcywgc3VjY2VzcywgZmFpbHVyZSkgPT4gewoJCQkJCQl2YXIgZkZpbHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQoIihvLCBzdGF0ZSkgPT4geyIgKyBzLmRhdGEoInNyX2ZpbHRlciIpICsgIn0iKTsKCQkJCQkJJC53aGVuKHRoaXMuc3IoKS5fKHMuZGF0YSgic3JfbWV0aG9kIiksIG51bGwsIGZGaWx0ZXIoe30sIHRoaXMuc3IoKS5ydW5TY3JpcHQocy5kYXRhKCJjX3N0YXRlIikpKSkpLnRoZW4ocmV0ID0+IHsKCQkJCQkJCXN1Y2Nlc3MoewoJCQkJCQkJCXBhZ2luYXRpb246IHsKCQkJCQkJCQkJbW9yZTogZmFsc2UKCQkJCQkJCQl9LAoJCQkJCQkJCXJlc3VsdHM6ICQubWFwKHJldCwgciA9PiB7CgkJCQkJCQkJCXIuaWQgPSByLklkOwoJCQkJCQkJCQlyLnRleHQgPSByLlRvU3RyaW5nOwoJCQkJCQkJCQlyZXR1cm4gcjsKCQkJCQkJCQl9KSwKCQkJCQkJCQl0b3RhbHM6IHJldC5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9LAoJCQkJdGVtcGxhdGVSZXN1bHQ6IChfZSwgX3MpID0+IHsKCQkJCQlyZXR1cm4gdGhpcy5faW5qZWN0KHRoaXMuc2VsZWN0MlRlbXBsYXRlLCB7CgkJCQkJCWRhdGE6IF9lCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJCWNvbnNvbGUubG9nKGUudGFyZ2V0KTsKCQkJfSk7CgkJCXMub24oImNoYW5nZS5zZWxlY3QyIiwgZSA9PiB7CgkJCQkvL3ZhciBkYXRhID0gZS5wYXJhbXMuZGF0YTsKCQkJCXZhciBfcyA9ICQoZS50YXJnZXQpOwoJCQl9KTsKCQl9KTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQl0cnkgewoJCQkJanN4ID0gYXdhaXQgJC5nZXQodGhpcy5yYW5kVVJMKChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfdnVlQ29tcG9uZW50KGNvZGUpIHsKCQlpZiAodHlwZW9mIFZ1ZSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUpLmZpbmQoKTsKCQkJaWYgKHApIHJldCA9IHsKCQkJCVNjcmlwdDogcC5zY3JpcHQoKSA/IHAuX2F0b2IocC5zY3JpcHQoKSkgOiAnJywKCQkJCUJvZHk6IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCX0KCgkJaWYgKCFyZXQpIHJldCA9IGF3YWl0IHRoaXMuX3Z1ZUNvbXBvbmVudChwYWdlLl9jb2RlKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YoQ01TX1JPT1QpID09PSAnc3RyaW5nJykgewoJCQlyZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogcGFnZS5fY29kZS5pbmRleE9mKCcvJykgPj0gMCA/IHBhZ2UuX2NvZGUgOiAoQ01TX1JPT1QgKyBwYWdlLl9jb2RlKQoJCQl9KTsKCQl9CgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBDTVMsIGxvb2tpbmcgaW4gRU1TIik7CgkJCXZhciBlb1BhZ2UgPSBudWxsOwoJCQl0cnkgewoJCQkJZW9QYWdlID0gbmV3IFBhZ2UoKS5jb2RlKHBhZ2UuX2NvZGUsICI9Iik7CgkJCQlpZiAoZW9QYWdlLmxhbmd1YWdlKSBlb1BhZ2UubGFuZ3VhZ2Uod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iLCAiPSIpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZygiRU1TIGRvZXMgbm90IGhhdmUgYSBQYWdlIGNsYXNzLCBmYWlsaW5nIG9uIHB1cnBvc2U6ICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAodGhpcy5zcigpLl8pIHJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJRW50aXR5T2JqZWN0OiAoZW9QYWdlID8gZW9QYWdlLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJfSk7CgkJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCkgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIEVNUywgdHJ5aW5nIHRlbXBsYXRlcyIpOwoJCQkJcGFnZSA9IHJldFswXTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gRU1TLCBzbyBnb2luZyBsb2NhbCIpOwoJCQl9CgoJCQlsZXQgaHRtbCA9IG51bGw7CgkJCXRyeSB7CgkJCQlodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5odG0iKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoaHRtbCAmJiAhaHRtbC5zdGF0dXMpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBodG1sIHRlbXBsYXRlIGZvdW5kIiwgaHRtbCk7CgkJCQlwYWdlLkJvZHkgPSBodG1sOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGhhcyBubyBodG1sIHRlbXBsYXRlIik7CgkJCQlpZiAoIXBhZ2UuQm9keSAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoTWFpbkNvbXBvbmVudCkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQkJfSBlbHNlIHsKCQkJCQlwYWdlLkJvZHkgPSBwYWdlLl9jb250ZW50IHx8ICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQkJfQoJCQl9CgoJCQlsZXQganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUocGFnZSk7CgkJCWlmICghanMpIHRyeSB7CgkJCQlqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuanMiKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoIWpzIHx8ICFqcy5vaykganMgPSBudWxsOwoJCQlpZiAoanMgJiYganMub2spIHBhZ2UuU2NyaXB0ID0gYXdhaXQganMudGV4dCgpOwoKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIHNjcmlwdCBpcyIgKyAoanMgPyAnJyA6ICcgbm90JykgKyAiIHJldHJpZXZlZCIpOwoJCQl0aGlzLnN0ZXAoKTsKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQkvL2NvbnNvbGUubG9nKCJwYWdlIEJvZHkiLCBwYWdlLl9ib2R5IHx8IHBhZ2UuQm9keSk7CgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlKTsKCQkJCXBhZ2UuY29tcG9uZW50ID0gb2JqOwoJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIFJlbmRlclBhZ2UocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAndW5kZWZpbmVkJykgewoJCQlkZWxldGUgd2luZG93LkZvcm1Db21wb25lbnQ7CgkJCSQoIiNmb3JtQ29tcG9uZW50IikuZW1wdHkoKTsKCQl9CgkJdmFyIF9wYWdlID0gYXdhaXQgdGhpcy5fcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpOwoJCWlmICghX3BhZ2UpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YoZ2EpICE9PSAidW5kZWZpbmVkIikgewoJCQlnYSgnc2VuZCcsIHsKCQkJCWhpdFR5cGU6ICdwYWdldmlldycsCgkJCQlwYWdlOiAnLycgKyBfcGFnZS5fY29kZSArICcuZHluYW1pYycsCgkJCQl0aXRsZTogX3BhZ2UuX3RpdGxlCgkJCX0pOwoJCQljb25zb2xlLmxvZygiU2VudCBHQSBoaXQgZm9yIHBhZ2U6ICIgKyAoX3BhZ2UuX2NvZGUgfHwgX3BhZ2UuUGFnZSB8fCBfcGFnZSkpOwoJCX0KCQl3aW5kb3cucGFnZSA9IF9wYWdlOwoJCXRoaXMuYWxsSFRNTCA9IHRoaXMuYmxvY2tzLmhlYWRlci5odG1sICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5KSArIHRoaXMuYmxvY2tzLmZvb3Rlci5odG1sOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoJCWlmICh0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoanMuaW5kZXhPZignY2xhc3MgJykgPj0gMCAmJiAhYkFzeW5jKSB7CgkJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoanMpOwoJCQl9IGVsc2UgewoJCQkJbGV0IHNDb2RlID0ganM7CgkJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQkJfQoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdCgiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyIpOwoJCQl9CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKGpzKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwganMuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJdHJ5IHsKCQkJCXJldHVybiBKU09OLnBhcnNlKGpzKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXJldHVybiBldmFsKGpzKTsKCQkJfQoJCX0KCX0KfTs=",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
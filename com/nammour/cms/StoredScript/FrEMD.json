{
	"Id": "e4b6963f2092b466dfb0d2d67741f09e4eb1c38d",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "FrEMD",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAoIWpzICYmICFodG1sICYmIHR5cGVvZihERm9ybVt0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCJdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQlqcyA9IHdpbmRvd1t0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCJdID0gREZvcm1bdGhpcy5fdGl0bGVDYXNlKGJsb2NrKSArICJDb21wb25lbnQiXTsKCQkJaHRtbCA9ICIiOwoKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfZ2V0QmxvY2soIiArIGJsb2NrICsgIik6IHVzaW5nIERGb3JtIiwgdGhpcy5fdGl0bGVDYXNlKGJsb2NrKSArICJDb21wb25lbnQiKTsKCQl9CgoJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJdHJ5IHsKCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCWNvbnNvbGUubG9nKCJGckVNRDo6X2dldEJsb2NrKCIgKyBibG9jayArICIpOiBDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9IGh0bWw7CgoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMSAmJiAhd2luZG93LmZyYW1lcy5sZW5ndGg7CgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgiTW9kdWxlcyIpOwoJCX0gZWxzZSB7CgkJCWlmICh3aW5kb3cuYkxvY2FsKSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5pbXBvcnQoKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCB0aGlzLl9nZXQoYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J31gLCB0cnVlKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAocmV0ICYmIHR5cGVvZihyZXQucmVwbGFjZSkgPT09ICdmdW5jdGlvbicgJiYgIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgdGhpcy5fZ2V0KHVybCk7CgkJCWh0bWwgPSB0aGlzLl9pbmplY3QoaHRtbCwgd2luZG93LnBhcmVudCk7CgoJCQljb25zdCBkb21wID0gbmV3IERPTVBhcnNlcigpOwoJCQlsZXQgZG9jID0gZG9tcC5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQvaHRtbCIpOwoJCQlhd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKGRvYyk7CgkJCWNvbnNvbGUubG9nKCJodG1sIGJpbmRpbmcgZG9uZSEiKTsKCgkJCWh0bWwgPSBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKCQkJLy9odG1sID0gJ3Rlc3QnOwoKCQkJLy93aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uID0gdXJsOwoJCQl3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LndyaXRlKGh0bWwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fYmluZEtPKCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCWFzeW5jIF9iaW5kS08oKSB7CgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA+PSAwKSB7CgkJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQkJLy9hd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIHRydWUpOwoKCQkJCWtvLmNsZWFuTm9kZSh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJa28uYXBwbHlCaW5kaW5ncyh3aW5kb3csIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQl9LCAzMDApOwoJCX0KCX0KCglfc2V0KG9iaiwgcGF0aCwgdmFsKSB7CgkJdmFyIHN0cmluZ1RvUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCQkJLy8gSWYgdGhlIHBhdGggaXNuJ3QgYSBzdHJpbmcsIHJldHVybiBpdAoJCQlpZiAodHlwZW9mIHBhdGggIT09ICdzdHJpbmcnKSByZXR1cm4gcGF0aDsKCQkJLy8gQ3JlYXRlIG5ldyBhcnJheQoJCQl2YXIgb3V0cHV0ID0gW107CgkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggZG90IG5vdGF0aW9uCgkJCXBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CgkJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGJyYWNrZXQgbm90YXRpb24KCQkJCWl0ZW0uc3BsaXQoL1xbKFtefV0rKVxdL2cpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCQkJLy8gUHVzaCB0byB0aGUgbmV3IGFycmF5CgkJCQkJaWYgKGtleS5sZW5ndGggPiAwKSB7CgkJCQkJCW91dHB1dC5wdXNoKGtleSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0pOwoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgkJLy8gQ29udmVydCB0aGUgcGF0aCB0byBhbiBhcnJheSBpZiBub3QgYWxyZWFkeQoJCXBhdGggPSBzdHJpbmdUb1BhdGgocGF0aCk7CgkJLy8gQ2FjaGUgdGhlIHBhdGggbGVuZ3RoIGFuZCBjdXJyZW50IHNwb3QgaW4gdGhlIG9iamVjdAoJCXZhciBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCQl2YXIgY3VycmVudCA9IG9iajsKCQkvLyBMb29wIHRocm91Z2ggdGhlIHBhdGgKCQlwYXRoLmZvckVhY2goZnVuY3Rpb24oa2V5LCBpbmRleCkgewoJCQkvLyBDaGVjayBpZiB0aGUgYXNzaWduZWQga2V5IHNob3VsIGJlIGFuIGFycmF5CgkJCXZhciBpc0FycmF5ID0ga2V5LnNsaWNlKC0yKSA9PT0gJ1tdJzsKCQkJLy8gSWYgc28sIGdldCB0aGUgdHJ1ZSBrZXkgbmFtZSBieSByZW1vdmluZyB0aGUgdHJhaWxpbmcgW10KCQkJa2V5ID0gaXNBcnJheSA/IGtleS5zbGljZSgwLCAtMikgOiBrZXk7CgkJCS8vIElmIHRoZSBrZXkgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBpc24ndCwgY3JlYXRlIGFuIGFycmF5CgkJCWlmIChpc0FycmF5ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50W2tleV0pICE9PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCQljdXJyZW50W2tleV0gPSBbXTsKCQkJfQoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxvb3AsIGFzc2lnbiB0aGUgdmFsdWUKCQkJaWYgKGluZGV4ID09PSBsZW5ndGggLSAxKSB7CgkJCQkvLyBJZiBpdCdzIGFuIGFycmF5LCBwdXNoIHRoZSB2YWx1ZQoJCQkJLy8gT3RoZXJ3aXNlLCBhc3NpZ24gaXQKCQkJCWlmIChpc0FycmF5KSB7CgkJCQkJY3VycmVudFtrZXldLnB1c2godmFsKTsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFtrZXldID0gdmFsOwoJCQkJfQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJZWxzZSB7CgkJCQkvLyBJZiB0aGUga2V5IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdAoJCQkJaWYgKCFjdXJyZW50W2tleV0pIHsKCQkJCQljdXJyZW50W2tleV0gPSB7fTsKCQkJCX0KCQkJCS8vIFVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCQljdXJyZW50ID0gY3VycmVudFtrZXldOwoJCQl9CgkJfSk7Cgl9CgoJX3BhZ2VGaWx0ZXIoYikgewoJCWlmICghYi5fYWN0aXZlKSByZXR1cm4gZmFsc2U7CgkJbGV0IHBhZ2UgPSB0eXBlb2YoX0ZyRU1ELmhhc2gucGFnZSkgPT09ICd1bmRlZmluZWQnID8gJ2luZGV4JyA6IF9GckVNRC5oYXNoLnBhZ2U7CgkJaWYgKHR5cGVvZihiLl9wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGIuX3BhZ2UuX3VybCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gYi5fcGFnZS5fdXJsID09IHBhZ2U7Cgl9CgoJYXN5bmMgX2FwcGx5QmluZGluZ3MoZG9jID0gd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgYkFmdGVyID0gZmFsc2UpIHsKCQl0aGlzLmZyb21IYXNoKCk7CgkJaWYgKHRoaXMuaGFzaC5ub0JpbmRpbmcpIHJldHVybjsKCQlsZXQgYmluZGluZ3MgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkJpbmRpbmdzIik7CgkJaWYgKCFiaW5kaW5ncyAmJiBjb21wYW55LkJpbmRpbmdzKSB7CgkJCWJpbmRpbmdzID0gYXdhaXQgY29tcGFueS5CaW5kaW5ncygpOwoJCX0KCQliaW5kaW5ncyA9IGJpbmRpbmdzIHx8IFtdOwoKCQlzci5ncm91cEJ5KGJpbmRpbmdzLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5maWx0ZXIoYiA9PiBiQWZ0ZXIgPyBiLl9hZnRlciA6ICFiLl9hZnRlciksICJfcGF0aCIpLmZvckVhY2gocGIgPT4gewoJCQl0cnkgewoJCQkJbGV0IGUgPSBkb2MuZXZhbHVhdGUocGIua2V5LCBkb2MsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7CgkJCQlsZXQgZF9iaW5kID0ge307CgkJCQlwYi52YWx1ZXMuZm9yRWFjaChiID0+IHsKCQkJCQl0aGlzLl9zZXQoZF9iaW5kLCBiLl9hdHRyaWJ1dGUsIGIuX2NvZGUpOwoJCQkJfSk7CgkJCQkkKGUpLmF0dHIoImRhdGEtYmluZCIsIEpTT04uc3RyaW5naWZ5KGRfYmluZCkucmVwbGFjZSgvIi9nLCAnJykpOwoJCQkJLy9jb25zb2xlLmxvZyhwYi5rZXksIGUpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2cocGIua2V5LCBleCk7CgkJCX0KCQl9KTsKCX0KCglhc3luYyBpbml0KCkgewoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCWF3YWl0IHRoaXMuX2xvYWRDb250ZW50KCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCV91dWlkKGlkLCBsZW4sIGJJbnQpIHsKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoYkludCkgcmV0dXJuIE1hdGguZmxvb3IoRGF0ZS5ub3coKSArIE1hdGgucmFuZG9tKCkpOwoKCQlpZiAoaWQpIHsKCQkJbGV0IGhjID0gTWF0aC5hYnMoTnVtYmVyKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnID8gc3IuaGFzaENvZGUoaWQpIDogaWQubGVuZ3RoKSk7CgkJCWxldCBocyA9IGggPT4gTnVtYmVyKFN0cmluZyhoKS5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpKTsKCQkJbGV0IHUgPSBocyhocyhoYykgKiBocyhoYykpLnRvU3RyaW5nKDE2KTsKCgkJCXJldCA9IHUgKyAnJyArIHUgKyAnJyArIHU7CgkJCWlmIChyZXQubGVuZ3RoID4gMzIpIHJldCA9IHJldC5zdWJzdHJpbmcoMCwgMzIpOwoJCX0KCgkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHYoKTsKCgkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpOwoKCQlyZXR1cm4gcmV0LnJlcGxhY2UoL1wtL2csICcnKTsKCX0KCglhc3luYyBfbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKSB7CgkJLy9zY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCBlYXMgPSBbXTsKCgkJaWYgKGVjICYmIGVjLmxpYnJhcnkgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmJMb2NhbCkgewoJCQlsZXQgbGNzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0dlbmVyYXRlTGF5ZXJDbGFzcyIsIG51bGwsIGVjLmxpYnJhcnkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKGMuTGF5ZXJBdHRyaWJ1dGVzLCAoXywgbGEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogbGEuTmFtZSwKCQkJCVBsdXJhbDogbGEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IGxhLAoJCQkJSXNCb29sOiBsYS5OYXRpdmVUeXBlID09ICJib29sIiwKCQkJCUlzU3RyaW5nOiBsYS5OYXRpdmVUeXBlID09ICJzdHJpbmciLAoJCQkJSXNUZXh0OiBsYS5OYXRpdmVUeXBlID09ICJ0ZXh0IiwKCQkJCUlzTG9uZzogbGEuTmF0aXZlVHlwZSA9PSAibG9uZyIsCgkJCQlJc0Zsb2F0OiBsYS5OYXRpdmVUeXBlID09ICJmbG9hdCIsCgkJCQlJc0ludDogbGEuTmF0aXZlVHlwZSA9PSAiaW50ZWdlciIsCgkJCQlJc0RvdWJsZTogbGEuTmF0aXZlVHlwZSA9PSAiZG91YmxlIiwKCQkJCUlzRGF0ZTogbGEuTmF0aXZlVHlwZSA9PSAiZGF0ZXRpbWUiLAoJCQkJSXNGaWxlOiBsYS5OYXRpdmVUeXBlID09ICJmaWxlIiwKCQkJCUlzSW1hZ2U6IGxhLk5hdGl2ZVR5cGUgPT0gImltYWdlIiwKCQkJCUlzT2JqZWN0OiBsYS5OYXRpdmVUeXBlID09ICJvYmplY3QiLAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKCQuZ3JlcChjLlJlbGF0aW9uQXR0cmlidXRlcywgcmEgPT4gIXJhLklzQXJyYXkpLCAoXywgcmEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogcmEuTmFtZSwKCQkJCVBsdXJhbDogcmEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IHJhLAoJCQkJSXNCb29sOiBmYWxzZSwKCQkJCUlzU3RyaW5nOiBmYWxzZSwKCQkJCUlzVGV4dDogZmFsc2UsCgkJCQlJc0xvbmc6IGZhbHNlLAoJCQkJSXNGbG9hdDogZmFsc2UsCgkJCQlJc0ludDogZmFsc2UsCgkJCQlJc0RvdWJsZTogZmFsc2UsCgkJCQlJc0RhdGU6IGZhbHNlLAoJCQkJSXNGaWxlOiBmYWxzZSwKCQkJCUlzSW1hZ2U6IGZhbHNlLAoJCQkJRW50aXR5VHlwZTogewoJCQkJCUlkOiBzci5oYXNoQ29kZShyYS5SZWxhdGlvbkNsYXNzLk5hbWUpLAoJCQkJCU5hbWU6IHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSwKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJfSBlbHNlIGlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQllYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJCVRISVM6IGVjID8gW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IGVjCgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlFbnRpdHlDbGFzc2VzOiBbZWNdCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0gOiBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUNvbXBhbnk6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQl9CgkJCQkJfQoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0sCgkJCX0pOwoJCX0KCgkJdGhpcy5zdGVwKCk7CgoJCWlmICgoIWVhcyB8fCAhZWFzLmxlbmd0aCkgJiYgKCFlYyB8fCAhZWMubGVuZ3RoKSkgewoJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlDbGFzc2VzKCIgKyBzY29wZSArICIpOiBmYWlsZWQgdG8gbG9hZCBjbGFzc2VzLi4uIik7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShtLCBlYyk7CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKCFlYXMubGVuZ3RoKSB7CgkJCS8vIGNsYXNzZXMgZnJvbSBKU09OIEFycmF5CgkJCWVhcyA9IGVhcy5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcykpOwoJCX0KCgkJcmV0dXJuIGF3YWl0IHRoaXMuX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpOwoJfQoKCV9tZW51Q2xhc3NlcyhzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIkZyRU1EOjpfbWVudUNsYXNzZXMoIiArIHNjb3BlICsgIik6IG9TY29wZSIsIHNjb3BlLCBvU2NvcGUsIHRoaXMuYXBpU2VydmVyKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIFtdOwoKCQlyZXR1cm4gdGhpcy5zcigpLmdyb3VwQnkob1Njb3BlLkVudGl0eUNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5tYXAoZyA9PiAoewoJCQlsYWJlbDogKGcua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGcua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQlzdWJNZW51czogdGhpcy5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJbGFiZWw6IChndi5rZXkgPyB0aGlzLl90aXRsZUNhc2UoZ3Yua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQkJc3ViTWVudXM6IGd2LnZhbHVlcy5tYXAoZ3Z2ID0+ICh7CgkJCQkJbGFiZWw6IHRoaXMuX3RpdGxlQ2FzZShndnYuTmFtZSksCgkJCQkJY29kZTogJ3N0b3JlJywKCQkJCQlkYXRhOiBndnYuTmFtZQoJCQkJfSkpCgkJCX0pKQoJCX0pKTsKCX0KCglhc3luYyBfbG9hZFNjb3BlKGVjLCBzY29wZSkgewoJCXRyeSB7CgkJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJCWlmIChzY29wZSAhPT0gJ3dpbmRvdycpIHdpbmRvd1tzY29wZV0gPSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpOwoJCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQoKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQkJbGV0IG1jID0gKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5maW5kKGMgPT4gYy5Jc01haW4pOwoJCQlpZiAobWMpIHsKCQkJCXRoaXMuYXBpU2VydmVyID0gYXdhaXQgbmV3IG9TY29wZVttYy5OYW1lXSgpLl9zZXJ2ZXIoewoJCQkJCWxvYWRUb29sczogdHJ1ZSwKCQkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCQlpbml0Tm9kZTogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCWNvbnNvbGUubG9nKCJfbG9hZFNjb3BlKCIgKyBzY29wZSArICIpOiBkb25lISIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZFNjb3BlKCk6IHNjaGVtYSBleGNlcHRpb24gIiArIGV4KTsKCQkJaWYgKGZhbHNlICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJTmFtZTogY29tcGFueS5TY2hlbWEgfHwgY29tcGFueS5Db2RlLAoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJfSk7CgkJfQoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gW107CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgoJCWlmIChlYXMubGVuZ3RoKSB7CgkJCSh0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpKS5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIikuZm9yRWFjaChnID0+IHsKCQkJCWcua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBnLnZhbHVlczsKCQkJCWcua2V5LkVudGl0eU1vZHVsZSA9IG07CgkJCQlnLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eUNsYXNzID0gZy5rZXkpOwoKCQkJCWlmIChlYyAmJiBBcnJheS5pc0FycmF5KGVjKSkgZWMucHVzaChnLmtleSk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIG5vdCBzdG9yZWQgaW4gRU1TLCBjaGVjayBpZiBhdmFpbGFibGUgYXMgYSBzdG9yZWQgc2NyaXB0CgkJCXRyeSB7CgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlcik7CgkJCQlsZXQgbUVDcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogbU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJCW1FQ3MgPSBtRUNzLmZpbHRlcihjID0+IChtLkV4Y2x1ZGVzIHx8IFtdKS5pbmRleE9mKGMuTmFtZSkgPCAwKTsKCgkJCQltRUNzLmZpbHRlcihjID0+ICFjLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IHsKCQkJCQljLkVudGl0eVJ1bGVzID0gYy5FbnRpdHlSdWxlcyB8fCBbXTsKCQkJCQljLkVudGl0eVJ1bGVzLnB1c2goLi4uKCgobS5FbnRpdHlSdWxlcyB8fCB7fSlbYy5OYW1lXSkgfHwgW10pKTsKCQkJCQljLkVudGl0eU1vZHVsZSA9IG07CgkJCQl9KTsKCQkJCWRlbGV0ZSBtLkVudGl0eVJ1bGVzOwoJCQkJZWMucHVzaCguLi5tRUNzKTsKCgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDbGFzc2VzIiwgZWMubWFwKGMgPT4gYy5FbnRpdHlNb2R1bGUpKTsKCQkJCWZvciBhd2FpdCAoY29uc3QgZG0gb2YgZWMuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgIT0gbU5hbWUpKSB7CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2FuZGlkYXRlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGRtLkVudGl0eU1vZHVsZS5OYW1lKS5sZW5ndGgpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTW9kdWxlIGFscmVhZHkgbG9hZGVkISIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJCWNvbnRpbnVlOwoJCQkJCX0KCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiByZWN1cnNpdmUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZG0uRW50aXR5TW9kdWxlKSB7CgkJCQkJCShkbS5FbnRpdHlNb2R1bGUgfHwgZG0pLkltcG9ydHMrKzsKCQkJCQkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShkbS5FbnRpdHlNb2R1bGUsIGVjKTsKCQkJCQl9CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogRmFpbGVkIGxvYWRpbmcgbW9kdWxlICIgKyBtTmFtZSwgZXgpOwoJCQl9CgkJfQoJfQoKCV9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB7CgkJbGV0IG9Hcm91cGVyID0gdGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKTsKCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKEFycmF5LmlzQXJyYXkoZWMpICYmICEoZWFzIHx8IFtdKS5sZW5ndGgpIHsKCQkJZWMgPSBlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgKHR5cGVvZihjLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGMuQWN0aXZlKSk7CgoJCQllYy5mb3JFYWNoKGMgPT4gewoJCQkJYy5JZCA9IGMuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJYy5QbHVyYWwgPSBjLlBsdXJhbCB8fCAoYy5OYW1lICsgInMiKTsKCQkJCWMuX1RvU3RyaW5nID0gYy5fVG9TdHJpbmcgfHwgYy5OYW1lOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcyB8fCBbXTsKCgkJCQlsZXQgX2Jhc2VfID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZSA9PSAnX19CQVNFX18nKTsKCQkJCWlmIChfYmFzZV8pIHsKCQkJCQlsZXQgcHJvcExpc3QgPSBbJ0lzVW5pcXVlJywgJ0NvZGUnLCAnRGVmYXVsdCcsICdWYWx1ZScsICdSZXF1aXJlZCcsICdEdXBsaWNhdGUnXTsKCQkJCQlwcm9wTGlzdC5maWx0ZXIocCA9PiBBcnJheS5pc0FycmF5KF9iYXNlX1twXSkpLmZvckVhY2gocCA9PiBfYmFzZV9bcF0gPSBPYmplY3QuYXNzaWduKHt9LCAuLi5fYmFzZV9bcF0ubWFwKF9hID0+ICh7CgkJCQkJCVtfYV06IHRydWUKCQkJCQl9KSkpKTsKCgkJCQkJbGV0IGF0dExpc3QgPSBbewoJCQkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJvcmRlciIsCgkJCQkJCUlzSW50OiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJJbmZvIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogInJlbWFyayIsCgkJCQkJCUlzVGV4dDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJJbmZvIgoJCQkJCQl9LAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGVOYW1lKHNjb3BlKSB7CgkJcmV0dXJuIHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpIHx8ICJ3aW5kb3ciOwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIkZyRU1EOjpfX3Njb3BlKCk6IHNjb3BlIiwgc2NvcGUpOwoKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlPYmplY3Qua2V5cyh0aGlzLmhhc2gpLmZvckVhY2goaCA9PiB0aGlzLmhhc2hbaF0gPSBkZWNvZGVVUkkodGhpcy5oYXNoW2hdKSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwLCBtc2csIHRpdGxlKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogdGl0bGUgfHwgJ0xvYWRpbmcnLAoJCQkJCW1zZzogbXNnIHx8ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCV9GckVNRC5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLCAnU2F2aW5nIGRhdGEuLi4nLCAnUHJvZ3Jlc3MnKTsKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKGZhbHNlKTsKCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQlqc3ggPSBhd2FpdCB0aGlzLl9nZXQoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIsIHRydWUpOwoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyICYmIHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykpIHsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUodGhpcy5wYXRoVG9OYW1lKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBhd2FpdCB0aGlzLnJ1blNjcmlwdChwLnNjcmlwdCgpIHx8ICcnKSwKCQkJCUJvZHk6IHAuYm9keSgpIHx8ICcnLAoJCQkJU3R5bGU6IHAuc3R5bGUoKSB8fCAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCQljb25zb2xlLmxvZygiX3JlbmRlcigiICsgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiKSB1c2luZyBhcGlTZXJ2ZXIiLCBwLCByZXQpOwoJCX0KCgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJcGFnZS5Cb2R5ID0gYXdhaXQgdGhpcy5pbXBvcnQoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUsIHsKCQkJCWV4dDogJ2h0bScsCgkJCQlmaWVsZDogJ2JvZHknLAoJCQl9KTsKCgkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJfSBlbHNlIGlmICh0eXBlb2YodnVlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCS8vcGFnZS5Cb2R5ID0gLypwYWdlLl9jb250ZW50IHx8ICovICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQl9CgoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMuaW1wb3J0KCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlLCB7CgkJCQlleHQ6ICdqcycsCgkJCQlmaWVsZDogJ3NjcmlwdCcsCgkJCX0pOwoKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCgkJCWlmICggLyohcGFnZS5TY3JpcHQgJiYgIXBhZ2UuQm9keSAmJiAqLyB0eXBlb2YoREZvcm1bdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJcGFnZS5TY3JpcHQgPSB3aW5kb3dbdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdID0gREZvcm1bdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdOwoJCQkJcGFnZS5Cb2R5ID0gIiI7CgoJCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IHVzaW5nIERGb3JtIiwgdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCIpOwoJCQl9CgoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoKCQkvL2lmIChwYWdlLlNjcmlwdCkgcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJdHJ5IHsKCQkJY3VzdG9tRWxlbWVudHMuZGVmaW5lKHBhZ2UuX2NvZGUsIHBhZ2UuY29tcG9uZW50ID0gdnVlLmRlZmluZUN1c3RvbUVsZW1lbnQoT2JqZWN0LmFzc2lnbihuZXcgcGFnZS5TY3JpcHQoKSwgewoJCQkJdGVtcGxhdGU6IHBhZ2UuQm9keSwKCQkJCXN0eWxlczogW3BhZ2UuU3R5bGVdCgkJCX0pKSk7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBwYWdlIGFzIHZ1ZWpzIGN1c3RvbSBlbGVtZW50IiwgcGFnZSk7CgkJCXBhZ2UuQm9keSA9IG51bGw7CgkJCS8vcGFnZS5TY3JpcHQgPSBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBWdWUgRXhjZXB0aW9uOiAiICsgZXgpOwoJCQlwYWdlLmNvbXBvbmVudCA9IG51bGw7CgkJfQoKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iICYmICFwYWdlLmNvbXBvbmVudCkgewoJCQl0cnkgewoJCQkJcGFnZS5jb21wb25lbnQgPSBuZXcgcGFnZS5TY3JpcHQocGFnZSwgREZvcm0pOwoJCQkJaWYgKHBhZ2UuY29tcG9uZW50ICYmIHBhZ2UuY29tcG9uZW50Lm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgcGFnZS5jb21wb25lbnQubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IG5ldyBwYWdlLlNjcmlwdCgpIEV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiRnJFTUQ6OmVuZCgpOiBkYXRhIiwgZGF0YSwgdGhpcy5hbGxIVE1MKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgoJCQlpZiAodHlwZW9mKHZ1ZSkgIT09ICd1bmRlZmluZWQnICYmIHBhZ2UuY29tcG9uZW50ICYmIHR5cGVvZihwYWdlLmNvbXBvbmVudC5kZWYpID09PSAnb2JqZWN0JykgewoJCQkJY29uc29sZS5sb2coImVuZCgpOiBhZGRpbmcgVnVlSlMgQ29tcG9uZW5ldCB0byBwYWdlIiwgcGFnZSk7CgkJCQlvQ29udGVudC5hcHBlbmQobmV3IHBhZ2UuY29tcG9uZW50KCkpOwoJCQl9CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJYXN5bmMgUmVuZGVyUGFnZShwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWRlbGV0ZSB3aW5kb3cuRm9ybUNvbXBvbmVudDsKCQkJJCgiI2Zvcm1Db21wb25lbnQiKS5lbXB0eSgpOwoJCX0KCQl2YXIgX3BhZ2UgPSBhd2FpdCB0aGlzLl9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucyk7CgkJaWYgKCFfcGFnZSkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihnYSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWdhKCdzZW5kJywgewoJCQkJaGl0VHlwZTogJ3BhZ2V2aWV3JywKCQkJCXBhZ2U6ICcvJyArIF9wYWdlLl9jb2RlICsgJy5keW5hbWljJywKCQkJCXRpdGxlOiBfcGFnZS5fdGl0bGUKCQkJfSk7CgkJCWNvbnNvbGUubG9nKCJTZW50IEdBIGhpdCBmb3IgcGFnZTogIiArIChfcGFnZS5fY29kZSB8fCBfcGFnZS5QYWdlIHx8IF9wYWdlKSk7CgkJfQoJCXdpbmRvdy5wYWdlID0gX3BhZ2U7CgkJdGhpcy5hbGxIVE1MID0gKHRoaXMuYmxvY2tzLmhlYWRlci5odG1sIHx8ICcnKSArICh0aGlzLmJsb2Nrcy5jb250ZW50Lmh0bWwgfHwgX3BhZ2UuQm9keSB8fCBfcGFnZS5fYm9keSB8fCAnJykgKyAodGhpcy5ibG9ja3MuZm9vdGVyLmh0bWwgfHwgJycpOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoKCQl0cnkgewoJCQlyZXR1cm4gSlNPTi5wYXJzZShzQ29kZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCWxldCBzQ29kZSA9IGpzOwoJCWlmIChzQ29kZS5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJLy8gYSBjbGFzcyBkZWZpbml0aW9uLCBkbyBub3QgZW5jbG9zZSBpdCBpbiBhIGZ1bmN0aW9uCgkJfSBlbHNlIHsKCQkJaWYgKHNDb2RlLmluZGV4T2YoJ3JldHVybiAnKSAhPSAwKSB7CgkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQl9CgkJCXNDb2RlID0gIihhc3luYyAoKSA9PiB7IiArIHNDb2RlICsgIlxufSkoKTsiOwoJCX0KCgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoc0NvZGUpOwoJCX0gZWxzZSBpZiAoZmFsc2UgJiYgdHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IHJldCA9IGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCXNjcmlwdC5hc3luYyA9IGJBc3luYzsKCQkJCXNjcmlwdC5zcmMgPSBgZGF0YTp0ZXh0L2phdmFzY3JpcHQ7YmFzZTY0LCR7dGhpcy5fYnRvYShzQ29kZSl9YDsKCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCX0pOwoJCQljb25zb2xlLmxvZyhyZXQsIHNDb2RlLnN1YnN0cmluZygwLCAyMCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXJldHVybiBldmFsKHNDb2RlKTsKCQl9Cgl9Cn07",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDAxOTVlYTkwMjg1MTcxYjliMTFlNzYwNWYyZjg2YTQ2IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSAwMTk1ZWE5MDI4NTE3MWI5YjExZTc4MmUwNTQ1YmUyNSA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAoIWpzICYmICFodG1sICYmIHR5cGVvZihERm9ybVt0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCJdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQlqcyA9IHdpbmRvd1t0aGlzLl90aXRsZUNhc2UoYmxvY2spICsgIkNvbXBvbmVudCJdID0gREZvcm1bdGhpcy5fdGl0bGVDYXNlKGJsb2NrKSArICJDb21wb25lbnQiXTsKCQkJaHRtbCA9ICIiOwoKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfZ2V0QmxvY2soIiArIGJsb2NrICsgIik6IHVzaW5nIERGb3JtIiwgdGhpcy5fdGl0bGVDYXNlKGJsb2NrKSArICJDb21wb25lbnQiKTsKCQl9CgoJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJdHJ5IHsKCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCWNvbnNvbGUubG9nKCJGckVNRDo6X2dldEJsb2NrKCIgKyBibG9jayArICIpOiBDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9IGh0bWw7CgoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMSAmJiAhd2luZG93LmZyYW1lcy5sZW5ndGg7CgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgiTW9kdWxlcyIpOwoJCX0gZWxzZSB7CgkJCWlmICh3aW5kb3cuYkxvY2FsKSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5pbXBvcnQoKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCB0aGlzLl9nZXQoYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J31gLCB0cnVlKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAocmV0ICYmIHR5cGVvZihyZXQucmVwbGFjZSkgPT09ICdmdW5jdGlvbicgJiYgIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgdGhpcy5fZ2V0KHVybCk7CgkJCWh0bWwgPSB0aGlzLl9pbmplY3QoaHRtbCwgd2luZG93LnBhcmVudCk7CgoJCQljb25zdCBkb21wID0gbmV3IERPTVBhcnNlcigpOwoJCQlsZXQgZG9jID0gZG9tcC5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQvaHRtbCIpOwoJCQlhd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKGRvYyk7CgkJCWNvbnNvbGUubG9nKCJodG1sIGJpbmRpbmcgZG9uZSEiKTsKCgkJCWh0bWwgPSBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKCQkJLy9odG1sID0gJ3Rlc3QnOwoKCQkJLy93aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uID0gdXJsOwoJCQl3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LndyaXRlKGh0bWwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fYmluZEtPKCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCWFzeW5jIF9iaW5kS08oKSB7CgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA+PSAwKSB7CgkJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQkJLy9hd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIHRydWUpOwoKCQkJCWtvLmNsZWFuTm9kZSh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJa28uYXBwbHlCaW5kaW5ncyh3aW5kb3csIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQl9LCAzMDApOwoJCX0KCX0KCglfc2V0KG9iaiwgcGF0aCwgdmFsKSB7CgkJdmFyIHN0cmluZ1RvUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCQkJLy8gSWYgdGhlIHBhdGggaXNuJ3QgYSBzdHJpbmcsIHJldHVybiBpdAoJCQlpZiAodHlwZW9mIHBhdGggIT09ICdzdHJpbmcnKSByZXR1cm4gcGF0aDsKCQkJLy8gQ3JlYXRlIG5ldyBhcnJheQoJCQl2YXIgb3V0cHV0ID0gW107CgkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggZG90IG5vdGF0aW9uCgkJCXBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CgkJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGJyYWNrZXQgbm90YXRpb24KCQkJCWl0ZW0uc3BsaXQoL1xbKFtefV0rKVxdL2cpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCQkJLy8gUHVzaCB0byB0aGUgbmV3IGFycmF5CgkJCQkJaWYgKGtleS5sZW5ndGggPiAwKSB7CgkJCQkJCW91dHB1dC5wdXNoKGtleSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0pOwoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgkJLy8gQ29udmVydCB0aGUgcGF0aCB0byBhbiBhcnJheSBpZiBub3QgYWxyZWFkeQoJCXBhdGggPSBzdHJpbmdUb1BhdGgocGF0aCk7CgkJLy8gQ2FjaGUgdGhlIHBhdGggbGVuZ3RoIGFuZCBjdXJyZW50IHNwb3QgaW4gdGhlIG9iamVjdAoJCXZhciBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCQl2YXIgY3VycmVudCA9IG9iajsKCQkvLyBMb29wIHRocm91Z2ggdGhlIHBhdGgKCQlwYXRoLmZvckVhY2goZnVuY3Rpb24oa2V5LCBpbmRleCkgewoJCQkvLyBDaGVjayBpZiB0aGUgYXNzaWduZWQga2V5IHNob3VsIGJlIGFuIGFycmF5CgkJCXZhciBpc0FycmF5ID0ga2V5LnNsaWNlKC0yKSA9PT0gJ1tdJzsKCQkJLy8gSWYgc28sIGdldCB0aGUgdHJ1ZSBrZXkgbmFtZSBieSByZW1vdmluZyB0aGUgdHJhaWxpbmcgW10KCQkJa2V5ID0gaXNBcnJheSA/IGtleS5zbGljZSgwLCAtMikgOiBrZXk7CgkJCS8vIElmIHRoZSBrZXkgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBpc24ndCwgY3JlYXRlIGFuIGFycmF5CgkJCWlmIChpc0FycmF5ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50W2tleV0pICE9PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCQljdXJyZW50W2tleV0gPSBbXTsKCQkJfQoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxvb3AsIGFzc2lnbiB0aGUgdmFsdWUKCQkJaWYgKGluZGV4ID09PSBsZW5ndGggLSAxKSB7CgkJCQkvLyBJZiBpdCdzIGFuIGFycmF5LCBwdXNoIHRoZSB2YWx1ZQoJCQkJLy8gT3RoZXJ3aXNlLCBhc3NpZ24gaXQKCQkJCWlmIChpc0FycmF5KSB7CgkJCQkJY3VycmVudFtrZXldLnB1c2godmFsKTsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFtrZXldID0gdmFsOwoJCQkJfQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJZWxzZSB7CgkJCQkvLyBJZiB0aGUga2V5IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdAoJCQkJaWYgKCFjdXJyZW50W2tleV0pIHsKCQkJCQljdXJyZW50W2tleV0gPSB7fTsKCQkJCX0KCQkJCS8vIFVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCQljdXJyZW50ID0gY3VycmVudFtrZXldOwoJCQl9CgkJfSk7Cgl9CgoJX3BhZ2VGaWx0ZXIoYikgewoJCWlmICghYi5fYWN0aXZlKSByZXR1cm4gZmFsc2U7CgkJbGV0IHBhZ2UgPSB0eXBlb2YoX0ZyRU1ELmhhc2gucGFnZSkgPT09ICd1bmRlZmluZWQnID8gJ2luZGV4JyA6IF9GckVNRC5oYXNoLnBhZ2U7CgkJaWYgKHR5cGVvZihiLl9wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGIuX3BhZ2UuX3VybCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gYi5fcGFnZS5fdXJsID09IHBhZ2U7Cgl9CgoJYXN5bmMgX2FwcGx5QmluZGluZ3MoZG9jID0gd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgYkFmdGVyID0gZmFsc2UpIHsKCQl0aGlzLmZyb21IYXNoKCk7CgkJaWYgKHRoaXMuaGFzaC5ub0JpbmRpbmcpIHJldHVybjsKCQlsZXQgYmluZGluZ3MgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkJpbmRpbmdzIik7CgkJaWYgKCFiaW5kaW5ncyAmJiBjb21wYW55LkJpbmRpbmdzKSB7CgkJCWJpbmRpbmdzID0gYXdhaXQgY29tcGFueS5CaW5kaW5ncygpOwoJCX0KCQliaW5kaW5ncyA9IGJpbmRpbmdzIHx8IFtdOwoKCQlzci5ncm91cEJ5KGJpbmRpbmdzLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5maWx0ZXIoYiA9PiBiQWZ0ZXIgPyBiLl9hZnRlciA6ICFiLl9hZnRlciksICJfcGF0aCIpLmZvckVhY2gocGIgPT4gewoJCQl0cnkgewoJCQkJbGV0IGUgPSBkb2MuZXZhbHVhdGUocGIua2V5LCBkb2MsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7CgkJCQlsZXQgZF9iaW5kID0ge307CgkJCQlwYi52YWx1ZXMuZm9yRWFjaChiID0+IHsKCQkJCQl0aGlzLl9zZXQoZF9iaW5kLCBiLl9hdHRyaWJ1dGUsIGIuX2NvZGUpOwoJCQkJfSk7CgkJCQkkKGUpLmF0dHIoImRhdGEtYmluZCIsIEpTT04uc3RyaW5naWZ5KGRfYmluZCkucmVwbGFjZSgvIi9nLCAnJykpOwoJCQkJLy9jb25zb2xlLmxvZyhwYi5rZXksIGUpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2cocGIua2V5LCBleCk7CgkJCX0KCQl9KTsKCX0KCglhc3luYyBpbml0KCkgewoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCWF3YWl0IHRoaXMuX2xvYWRDb250ZW50KCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCV91dWlkKGlkLCBsZW4sIGJJbnQpIHsKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoYkludCkgcmV0dXJuIE1hdGguZmxvb3IoRGF0ZS5ub3coKSArIE1hdGgucmFuZG9tKCkpOwoKCQlpZiAoaWQpIHsKCQkJbGV0IGhjID0gTWF0aC5hYnMoTnVtYmVyKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnID8gc3IuaGFzaENvZGUoaWQpIDogaWQubGVuZ3RoKSk7CgkJCWxldCBocyA9IGggPT4gTnVtYmVyKFN0cmluZyhoKS5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpKTsKCQkJbGV0IHUgPSBocyhocyhoYykgKiBocyhoYykpLnRvU3RyaW5nKDE2KTsKCgkJCXJldCA9IHUgKyAnJyArIHUgKyAnJyArIHU7CgkJCWlmIChyZXQubGVuZ3RoID4gMzIpIHJldCA9IHJldC5zdWJzdHJpbmcoMCwgMzIpOwoJCX0KCgkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHYoKTsKCgkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpOwoKCQlyZXR1cm4gcmV0LnJlcGxhY2UoL1wtL2csICcnKTsKCX0KCglhc3luYyBfbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKSB7CgkJLy9zY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCBlYXMgPSBbXTsKCgkJaWYgKGVjICYmIGVjLmxpYnJhcnkgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmJMb2NhbCkgewoJCQlsZXQgbGNzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0dlbmVyYXRlTGF5ZXJDbGFzcyIsIG51bGwsIGVjLmxpYnJhcnkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKGMuTGF5ZXJBdHRyaWJ1dGVzLCAoXywgbGEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogbGEuTmFtZSwKCQkJCVBsdXJhbDogbGEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IGxhLAoJCQkJSXNCb29sOiBsYS5OYXRpdmVUeXBlID09ICJib29sIiwKCQkJCUlzU3RyaW5nOiBsYS5OYXRpdmVUeXBlID09ICJzdHJpbmciLAoJCQkJSXNUZXh0OiBsYS5OYXRpdmVUeXBlID09ICJ0ZXh0IiwKCQkJCUlzTG9uZzogbGEuTmF0aXZlVHlwZSA9PSAibG9uZyIsCgkJCQlJc0Zsb2F0OiBsYS5OYXRpdmVUeXBlID09ICJmbG9hdCIsCgkJCQlJc0ludDogbGEuTmF0aXZlVHlwZSA9PSAiaW50ZWdlciIsCgkJCQlJc0RvdWJsZTogbGEuTmF0aXZlVHlwZSA9PSAiZG91YmxlIiwKCQkJCUlzRGF0ZTogbGEuTmF0aXZlVHlwZSA9PSAiZGF0ZXRpbWUiLAoJCQkJSXNGaWxlOiBsYS5OYXRpdmVUeXBlID09ICJmaWxlIiwKCQkJCUlzSW1hZ2U6IGxhLk5hdGl2ZVR5cGUgPT0gImltYWdlIiwKCQkJCUlzT2JqZWN0OiBsYS5OYXRpdmVUeXBlID09ICJvYmplY3QiLAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKCQuZ3JlcChjLlJlbGF0aW9uQXR0cmlidXRlcywgcmEgPT4gIXJhLklzQXJyYXkpLCAoXywgcmEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogcmEuTmFtZSwKCQkJCVBsdXJhbDogcmEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IHJhLAoJCQkJSXNCb29sOiBmYWxzZSwKCQkJCUlzU3RyaW5nOiBmYWxzZSwKCQkJCUlzVGV4dDogZmFsc2UsCgkJCQlJc0xvbmc6IGZhbHNlLAoJCQkJSXNGbG9hdDogZmFsc2UsCgkJCQlJc0ludDogZmFsc2UsCgkJCQlJc0RvdWJsZTogZmFsc2UsCgkJCQlJc0RhdGU6IGZhbHNlLAoJCQkJSXNGaWxlOiBmYWxzZSwKCQkJCUlzSW1hZ2U6IGZhbHNlLAoJCQkJRW50aXR5VHlwZTogewoJCQkJCUlkOiBzci5oYXNoQ29kZShyYS5SZWxhdGlvbkNsYXNzLk5hbWUpLAoJCQkJCU5hbWU6IHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSwKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJfSBlbHNlIGlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQllYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJCVRISVM6IGVjID8gW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IGVjCgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlFbnRpdHlDbGFzc2VzOiBbZWNdCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0gOiBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUNvbXBhbnk6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQl9CgkJCQkJfQoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0sCgkJCX0pOwoJCX0KCgkJdGhpcy5zdGVwKCk7CgoJCWlmICgoIWVhcyB8fCAhZWFzLmxlbmd0aCkgJiYgKCFlYyB8fCAhZWMubGVuZ3RoKSkgewoJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlDbGFzc2VzKCIgKyBzY29wZSArICIpOiBmYWlsZWQgdG8gbG9hZCBjbGFzc2VzLi4uIik7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShtLCBlYyk7CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKCFlYXMubGVuZ3RoKSB7CgkJCS8vIGNsYXNzZXMgZnJvbSBKU09OIEFycmF5CgkJCWVhcyA9IGVhcy5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcykpOwoJCX0KCgkJcmV0dXJuIGF3YWl0IHRoaXMuX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpOwoJfQoKCV9tZW51Q2xhc3NlcyhzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIkZyRU1EOjpfbWVudUNsYXNzZXMoIiArIHNjb3BlICsgIik6IG9TY29wZSIsIHNjb3BlLCBvU2NvcGUsIHRoaXMuYXBpU2VydmVyKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIFtdOwoKCQlyZXR1cm4gdGhpcy5zcigpLmdyb3VwQnkob1Njb3BlLkVudGl0eUNsYXNzZXMsICdFbnRpdHlNb2R1bGUnKS5tYXAoZyA9PiAoewoJCQlsYWJlbDogKGcua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGcua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQlzdWJNZW51czogdGhpcy5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJbGFiZWw6IChndi5rZXkgPyB0aGlzLl90aXRsZUNhc2UoZ3Yua2V5Lk5hbWUpIDogbnVsbCkgfHwgJ01haW4nLAoJCQkJc3ViTWVudXM6IGd2LnZhbHVlcy5tYXAoZ3Z2ID0+ICh7CgkJCQkJbGFiZWw6IHRoaXMuX3RpdGxlQ2FzZShndnYuTmFtZSksCgkJCQkJY29kZTogJ3N0b3JlJywKCQkJCQlkYXRhOiBndnYuTmFtZQoJCQkJfSkpCgkJCX0pKQoJCX0pKTsKCX0KCglhc3luYyBfbG9hZFNjb3BlKGVjLCBzY29wZSkgewoJCXRyeSB7CgkJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJCWlmIChzY29wZSAhPT0gJ3dpbmRvdycpIHdpbmRvd1tzY29wZV0gPSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpOwoJCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkJb1Njb3BlLmhyZWZzID0gWy4uLm5ldyBTZXQoWy4uLm5ldyBTZXQoKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQkJbGV0IG1jID0gKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5maW5kKGMgPT4gYy5Jc01haW4pOwoJCQlpZiAobWMpIHsKCQkJCXRoaXMuYXBpU2VydmVyID0gYXdhaXQgbmV3IG9TY29wZVttYy5OYW1lXSgpLl9zZXJ2ZXIoewoJCQkJCWxvYWRUb29sczogdHJ1ZSwKCQkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCQlpbml0Tm9kZTogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCWNvbnNvbGUubG9nKCJfbG9hZFNjb3BlKCIgKyBzY29wZSArICIpOiBkb25lISIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZFNjb3BlKCk6IHNjaGVtYSBleGNlcHRpb24gIiArIGV4KTsKCQkJaWYgKGZhbHNlICYmIHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJTmFtZTogY29tcGFueS5TY2hlbWEgfHwgY29tcGFueS5Db2RlLAoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJfSk7CgkJfQoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gW107CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgoJCWlmIChlYXMubGVuZ3RoKSB7CgkJCSh0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpKS5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIikuZm9yRWFjaChnID0+IHsKCQkJCWcua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBnLnZhbHVlczsKCQkJCWcua2V5LkVudGl0eU1vZHVsZSA9IG07CgkJCQlnLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eUNsYXNzID0gZy5rZXkpOwoKCQkJCWlmIChlYyAmJiBBcnJheS5pc0FycmF5KGVjKSkgZWMucHVzaChnLmtleSk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIG5vdCBzdG9yZWQgaW4gRU1TLCBjaGVjayBpZiBhdmFpbGFibGUgYXMgYSBzdG9yZWQgc2NyaXB0CgkJCXRyeSB7CgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlcik7CgkJCQlsZXQgbUVDcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogbU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJCW1FQ3MgPSBtRUNzLmZpbHRlcihjID0+IChtLkV4Y2x1ZGVzIHx8IFtdKS5pbmRleE9mKGMuTmFtZSkgPCAwKTsKCgkJCQltRUNzLmZpbHRlcihjID0+ICFjLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IHsKCQkJCQljLkVudGl0eVJ1bGVzID0gYy5FbnRpdHlSdWxlcyB8fCBbXTsKCQkJCQljLkVudGl0eVJ1bGVzLnB1c2goLi4uKCgobS5FbnRpdHlSdWxlcyB8fCB7fSlbYy5OYW1lXSkgfHwgW10pKTsKCQkJCQljLkVudGl0eU1vZHVsZSA9IG07CgkJCQl9KTsKCQkJCWRlbGV0ZSBtLkVudGl0eVJ1bGVzOwoJCQkJZWMucHVzaCguLi5tRUNzKTsKCgkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDbGFzc2VzIiwgZWMubWFwKGMgPT4gYy5FbnRpdHlNb2R1bGUpKTsKCQkJCWZvciBhd2FpdCAoY29uc3QgZG0gb2YgZWMuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgIT0gbU5hbWUpKSB7CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2FuZGlkYXRlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGRtLkVudGl0eU1vZHVsZS5OYW1lKS5sZW5ndGgpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTW9kdWxlIGFscmVhZHkgbG9hZGVkISIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJCWNvbnRpbnVlOwoJCQkJCX0KCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiByZWN1cnNpdmUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZG0uRW50aXR5TW9kdWxlKSB7CgkJCQkJCShkbS5FbnRpdHlNb2R1bGUgfHwgZG0pLkltcG9ydHMrKzsKCQkJCQkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eU1vZHVsZShkbS5FbnRpdHlNb2R1bGUsIGVjKTsKCQkJCQl9CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogRmFpbGVkIGxvYWRpbmcgbW9kdWxlICIgKyBtTmFtZSwgZXgpOwoJCQl9CgkJfQoJfQoKCV9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB7CgkJbGV0IG9Hcm91cGVyID0gdGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKTsKCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKEFycmF5LmlzQXJyYXkoZWMpICYmICEoZWFzIHx8IFtdKS5sZW5ndGgpIHsKCQkJZWMgPSBlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgKHR5cGVvZihjLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGMuQWN0aXZlKSk7CgoJCQllYy5mb3JFYWNoKGMgPT4gewoJCQkJYy5JZCA9IGMuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJYy5QbHVyYWwgPSBjLlBsdXJhbCB8fCAoYy5OYW1lICsgInMiKTsKCQkJCWMuX1RvU3RyaW5nID0gYy5fVG9TdHJpbmcgfHwgYy5OYW1lOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcyB8fCBbXTsKCgkJCQlsZXQgX2Jhc2VfID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoZWEgPT4gZWEuTmFtZSA9PSAnX19CQVNFX18nKTsKCQkJCWlmIChfYmFzZV8pIHsKCQkJCQlsZXQgcHJvcExpc3QgPSBbJ0lzVW5pcXVlJywgJ0NvZGUnLCAnRGVmYXVsdCcsICdWYWx1ZScsICdSZXF1aXJlZCcsICdEdXBsaWNhdGUnXTsKCQkJCQlwcm9wTGlzdC5maWx0ZXIocCA9PiBBcnJheS5pc0FycmF5KF9iYXNlX1twXSkpLmZvckVhY2gocCA9PiBfYmFzZV9bcF0gPSBPYmplY3QuYXNzaWduKHt9LCAuLi5fYmFzZV9bcF0ubWFwKF9hID0+ICh7CgkJCQkJCVtfYV06IHRydWUKCQkJCQl9KSkpKTsKCgkJCQkJbGV0IGF0dExpc3QgPSBbewoJCQkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJvcmRlciIsCgkJCQkJCUlzSW50OiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkNvbnRyb2wiCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJJbmZvIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogInJlbWFyayIsCgkJCQkJCUlzVGV4dDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJJbmZvIgoJCQkJCQl9LAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGVOYW1lKHNjb3BlKSB7CgkJcmV0dXJuIHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpIHx8ICJ3aW5kb3ciOwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIkZyRU1EOjpfX3Njb3BlKCk6IHNjb3BlIiwgc2NvcGUpOwoKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlPYmplY3Qua2V5cyh0aGlzLmhhc2gpLmZvckVhY2goaCA9PiB0aGlzLmhhc2hbaF0gPSBkZWNvZGVVUkkodGhpcy5oYXNoW2hdKSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwLCBtc2csIHRpdGxlKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogdGl0bGUgfHwgJ0xvYWRpbmcnLAoJCQkJCW1zZzogbXNnIHx8ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCV9GckVNRC5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLCAnU2F2aW5nIGRhdGEuLi4nLCAnUHJvZ3Jlc3MnKTsKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKGZhbHNlKTsKCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQlqc3ggPSBhd2FpdCB0aGlzLl9nZXQoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIsIHRydWUpOwoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyICYmIHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykpIHsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUodGhpcy5wYXRoVG9OYW1lKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBhd2FpdCB0aGlzLnJ1blNjcmlwdChwLnNjcmlwdCgpIHx8ICcnKSwKCQkJCUJvZHk6IHAuYm9keSgpIHx8ICcnLAoJCQkJU3R5bGU6IHAuc3R5bGUoKSB8fCAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCQljb25zb2xlLmxvZygiX3JlbmRlcigiICsgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiKSB1c2luZyBhcGlTZXJ2ZXIiLCBwLCByZXQpOwoJCX0KCgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJcGFnZS5Cb2R5ID0gYXdhaXQgdGhpcy5pbXBvcnQoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUsIHsKCQkJCWV4dDogJ2h0bScsCgkJCQlmaWVsZDogJ2JvZHknLAoJCQl9KTsKCgkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJfSBlbHNlIGlmICh0eXBlb2YodnVlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCS8vcGFnZS5Cb2R5ID0gLypwYWdlLl9jb250ZW50IHx8ICovICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQl9CgoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMuaW1wb3J0KCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlLCB7CgkJCQlleHQ6ICdqcycsCgkJCQlmaWVsZDogJ3NjcmlwdCcsCgkJCX0pOwoKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCgkJCWlmICggLyohcGFnZS5TY3JpcHQgJiYgIXBhZ2UuQm9keSAmJiAqLyB0eXBlb2YoREZvcm1bdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJcGFnZS5TY3JpcHQgPSB3aW5kb3dbdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdID0gREZvcm1bdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCJdOwoJCQkJcGFnZS5Cb2R5ID0gIiI7CgoJCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IHVzaW5nIERGb3JtIiwgdGhpcy5fdGl0bGVDYXNlKHBhZ2UuX2NvZGUpICsgIkNvbXBvbmVudCIpOwoJCQl9CgoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoKCQkvL2lmIChwYWdlLlNjcmlwdCkgcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJdHJ5IHsKCQkJY3VzdG9tRWxlbWVudHMuZGVmaW5lKHBhZ2UuX2NvZGUsIHBhZ2UuY29tcG9uZW50ID0gdnVlLmRlZmluZUN1c3RvbUVsZW1lbnQoT2JqZWN0LmFzc2lnbihuZXcgcGFnZS5TY3JpcHQoKSwgewoJCQkJdGVtcGxhdGU6IHBhZ2UuQm9keSwKCQkJCXN0eWxlczogW3BhZ2UuU3R5bGVdCgkJCX0pKSk7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBwYWdlIGFzIHZ1ZWpzIGN1c3RvbSBlbGVtZW50IiwgcGFnZSk7CgkJCXBhZ2UuQm9keSA9IG51bGw7CgkJCS8vcGFnZS5TY3JpcHQgPSBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6X3JlbmRlcigiICsgcGFnZS5fY29kZSArICIpOiBWdWUgRXhjZXB0aW9uOiAiICsgZXgpOwoJCQlwYWdlLmNvbXBvbmVudCA9IG51bGw7CgkJfQoKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iICYmICFwYWdlLmNvbXBvbmVudCkgewoJCQl0cnkgewoJCQkJcGFnZS5jb21wb25lbnQgPSBuZXcgcGFnZS5TY3JpcHQocGFnZSwgREZvcm0pOwoJCQkJaWYgKHBhZ2UuY29tcG9uZW50ICYmIHBhZ2UuY29tcG9uZW50Lm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgcGFnZS5jb21wb25lbnQubWFpbigpOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IG5ldyBwYWdlLlNjcmlwdCgpIEV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiRnJFTUQ6OmVuZCgpOiBkYXRhIiwgZGF0YSwgdGhpcy5hbGxIVE1MKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgoJCQlpZiAodHlwZW9mKHZ1ZSkgIT09ICd1bmRlZmluZWQnICYmIHBhZ2UuY29tcG9uZW50ICYmIHR5cGVvZihwYWdlLmNvbXBvbmVudC5kZWYpID09PSAnb2JqZWN0JykgewoJCQkJY29uc29sZS5sb2coImVuZCgpOiBhZGRpbmcgVnVlSlMgQ29tcG9uZW5ldCB0byBwYWdlIiwgcGFnZSk7CgkJCQlvQ29udGVudC5hcHBlbmQobmV3IHBhZ2UuY29tcG9uZW50KCkpOwoJCQl9CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5jc3MpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5tb2JpbGUpIHsKCQkJCWNvbXBhbnkuY3NzLm1vYmlsZS5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLmRlc2t0b3ApIHsKCQkJCWNvbXBhbnkuY3NzLmRlc2t0b3AuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5qcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMubW9iaWxlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMubW9iaWxlLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLm1vYmlsZVtpXSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLmRlc2t0b3ApIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5kZXNrdG9wLmxlbmd0aDsgaSsrKSAkLmdldFNjcmlwdChjb21wYW55LmpzLmRlc2t0b3BbaV0pOwoJCQl9CgkJfQoKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKHR5cGVvZihNYWluQ29tcG9uZW50KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5Db21wb25lbnQnKTsKCQkJCWlmICghZSkgewoJCQkJCWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllLnNldEF0dHJpYnV0ZSgiaWQiLCAibWFpbkNvbXBvbmVudCIpOwoJCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSk7CgkJCQl9CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluQ29tcG9uZW50LCBudWxsKSwgZSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKEZvcm1Db21wb25lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoRm9ybUNvbXBvbmVudCwgbnVsbCksIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtQ29tcG9uZW50JykpOwoJCQl9CgkJfQoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJdHJ5IHsKCQkJCXdpbmRvdy5ERm9ybS5pbml0KCk7CgkJCQl3aW5kb3cuREZvcm0ucGFyc2UoKTsKCQkJCXdpbmRvdy5ERm9ybS5iaW5kKCk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiREZvcm0gRnVuY3Rpb25zIGZhaWxlZCIsIGV4KTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJYXN5bmMgUmVuZGVyUGFnZShwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWRlbGV0ZSB3aW5kb3cuRm9ybUNvbXBvbmVudDsKCQkJJCgiI2Zvcm1Db21wb25lbnQiKS5lbXB0eSgpOwoJCX0KCQl2YXIgX3BhZ2UgPSBhd2FpdCB0aGlzLl9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucyk7CgkJaWYgKCFfcGFnZSkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihnYSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWdhKCdzZW5kJywgewoJCQkJaGl0VHlwZTogJ3BhZ2V2aWV3JywKCQkJCXBhZ2U6ICcvJyArIF9wYWdlLl9jb2RlICsgJy5keW5hbWljJywKCQkJCXRpdGxlOiBfcGFnZS5fdGl0bGUKCQkJfSk7CgkJCWNvbnNvbGUubG9nKCJTZW50IEdBIGhpdCBmb3IgcGFnZTogIiArIChfcGFnZS5fY29kZSB8fCBfcGFnZS5QYWdlIHx8IF9wYWdlKSk7CgkJfQoJCXdpbmRvdy5wYWdlID0gX3BhZ2U7CgkJdGhpcy5hbGxIVE1MID0gKHRoaXMuYmxvY2tzLmhlYWRlci5odG1sIHx8ICcnKSArICh0aGlzLmJsb2Nrcy5jb250ZW50Lmh0bWwgfHwgX3BhZ2UuQm9keSB8fCBfcGFnZS5fYm9keSB8fCAnJykgKyAodGhpcy5ibG9ja3MuZm9vdGVyLmh0bWwgfHwgJycpOwoJCXRoaXMuYWxsRGF0YSA9IHsKCQkJc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsCgkJCXBhZ2U6IF9wYWdlLAoJCQlwYWdlczogdGhpcy5wYWdlcwoJCX07CgkJdGhpcy5hbGxPcHRpb25zID0gb3B0aW9uczsKCgkJdGhpcy5lbmRDYWxsZWQgPSBmYWxzZTsKCQkvL3RoaXMuc2V0VVJMKCJwYWdlPSIgKyBfcGFnZS5fY29kZSk7CgkJYXdhaXQgdGhpcy5lbmQobnVsbCwgd2luZG93LnBhZ2UuZGF0YSB8fCBkYXRhKTsKCX0KCglhc3luYyBydW5TY3JpcHQoanMsIGJBc3luYykgewoJCWlmICh0eXBlb2YoanMpICE9PSAic3RyaW5nIikgcmV0dXJuIGpzOwoKCQl0cnkgewoJCQlyZXR1cm4gSlNPTi5wYXJzZShzQ29kZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCWxldCBzQ29kZSA9IGpzOwoJCWlmIChzQ29kZS5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJLy8gYSBjbGFzcyBkZWZpbml0aW9uLCBkbyBub3QgZW5jbG9zZSBpdCBpbiBhIGZ1bmN0aW9uCgkJfSBlbHNlIHsKCQkJaWYgKHNDb2RlLmluZGV4T2YoJ3JldHVybiAnKSAhPSAwKSB7CgkJCQlzQ29kZSA9ICJyZXR1cm4gIiArIHNDb2RlOwoJCQl9CgkJCXNDb2RlID0gIihhc3luYyAoKSA9PiB7IiArIHNDb2RlICsgIlxufSkoKTsiOwoJCX0KCgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCXJldHVybiBhd2FpdCBzci5ydW5TY3JpcHQoc0NvZGUpOwoJCX0gZWxzZSBpZiAoZmFsc2UgJiYgdHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJbGV0IHJldCA9IGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCXNjcmlwdC5hc3luYyA9IGJBc3luYzsKCQkJCXNjcmlwdC5zcmMgPSBgZGF0YTp0ZXh0L2phdmFzY3JpcHQ7YmFzZTY0LCR7dGhpcy5fYnRvYShzQ29kZSl9YDsKCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCX0pOwoJCQljb25zb2xlLmxvZyhyZXQsIHNDb2RlLnN1YnN0cmluZygwLCAyMCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXJldHVybiBldmFsKHNDb2RlKTsKCQl9Cgl9Cn07",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195ea90285171b9b11e7605f2f86a46",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "0195ea90285171b9b11e782e0545be25",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
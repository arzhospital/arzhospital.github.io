{
	"Id": "d496cc3ed8c382d4d6f286f379ca300d0d8c9a86",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7Cgl9CgoJZ3JvdXBCeShhciwgZmllbGQpIHsKCQlpZiAoIWFyIHx8ICFmaWVsZCkgcmV0dXJuIG51bGw7CgoJCXZhciBrZXlzID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJdmFyIGtleSA9IG51bGw7CgkJCWZpZWxkLnNwbGl0KCcuJykuZm9yRWFjaChmID0+IGtleSA9IChrZXkgfHwgYSlbZl0pOwoJCQlsZXQgayA9IGtleXMuZmluZChrID0+IHRoaXMuRXF1YWxzKGsua2V5LCBrZXkpKTsKCQkJaWYgKGspIHsKCQkJCWsudmFsdWVzLnB1c2goYSk7CgkJCX0gZWxzZSB7CgkJCQlrZXlzLnB1c2goewoJCQkJCWtleToga2V5LAoJCQkJCXZhbHVlczogW2FdLAoJCQkJfSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4ga2V5czsKCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWlmICh0aGlzLnNyKCkuXykgewoJCQlsZXQgc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJYXN5bmMgX2luaXRDb250ZW50TWFuYWdlcigpIHsKCQlsZXQgYXJDbGFzc2VzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSk7CgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXJDbGFzc2VzLCAiY29udGVudG1hbmFnZXIiKTsKCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGMuTmFtZSwKCQkJCVRvb2xzOiBjLlRvb2xzLAoJCQkJRGVidWc6IGMuRGVidWcsCgkJCQlUZXN0OiBjLlRlc3QsCgkJCQlDb25maWc6IGMuQ29uZmlnLAoJCQkJRW5hYmxlZDogYy5FbmFibGVkLAoJCQkJRW50aXR5QXR0cmlidXRlczogYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5TWV0aG9kKS5tYXAoZWEgPT4gZWFNYXAoZWEpKSwKCQkJCUVudGl0eU1ldGhvZHM6IGMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiAoewoJCQkJCU5hbWU6IG0uTmFtZSwKCQkJCQlTY3JpcHQ6IG0uU2NyaXB0LAoJCQkJCVJvdXRpbmc6IG0uUm91dGluZywKCQkJCQlNZXRob2RQYXJhbWV0ZXJzOiBtLk1ldGhvZFBhcmFtZXRlcnMubWFwKHAgPT4gZWFNYXAocCkpLAoJCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBlYU1hcChtLlJlc3BvbnNlQXR0cmlidXRlKSwKCQkJCX0pKSwKCQkJfTsKCgkJCVsiVG9vbHMiLCAiRW50aXR5TWV0aG9kcyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIXJldFthXS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlbIkRlYnVnIiwgIlRlc3QiLCAiQ29uZmlnIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghT2JqZWN0LmtleXMocmV0W2FdKS5sZW5ndGgpIGRlbGV0ZSByZXRbYV07CgkJCX0pOwoJCQlyZXQuRW50aXR5QXR0cmlidXRlcyA9IHJldC5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9ICJpZCIpOwoJCQlyZXR1cm4gcmV0OwoJCX0pOwoJfQoKCWFzeW5jIF9ydW5TZXF1ZW5jZXMoc2Vxcywgc2NvcGUpIHsKCQlsZXQgY2FsbFNlcXVlbmNlcyA9IFtdOwoJCWlmICghc2NvcGUpIHJldHVybiBjYWxsU2VxdWVuY2VzOwoKCQlmb3IgYXdhaXQgKGNvbnN0IHNlcSBvZiBzZXFzKSB7CgkJCWxldCBjYWxsU2VxdWVuY2UgPSB7CgkJCQlhY3RpdmU6IHRydWUsCgkJCQl0aXRsZTogc2VxLnRpdGxlLAoJCQkJY2xhc3NpZmllcjogc2VxLmNsYXNzaWZpZXIsCgkJCQllbnRpdGllczogW10sCgkJCQl0aW1lbGluZTogW10sCgkJCX07CgoJCQlsZXQgX2VudGl0aWVzID0gc2VxLmVudGl0aWVzLmZpbHRlcihlID0+IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCWUub2JqID0gbmV3IHNjb3BlW2UudHlwZV0oKS5fZnJvbURvY3VtZW50KGUuY29udGVudCk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiBfZW50aXRpZXMpIHsKCQkJCS8vIGZpcnN0IGxldmVsIHJlZmVyZW5jZSBjbGVhbnVwOiBtYWtlIHN1cmUgb25seSBvbmUgcmVmZXJlbmNlIG9iamVjdCBpcyB1c2VkIHdpdGggdGhlIHNhbWUgIl9uYW1lIi4gbG93ZXIgbGV2ZWxzIHNob3VsZCBiZSBkb25lIHJlY3Vyc2l2ZWx5CgkJCQlzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKS5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUuRW50aXR5QXR0cmlidXRlcy5maW5kKF9lYSA9PiBfZWEuTmFtZSA9PSAnbmFtZScgJiYgX2VhLklzU3RyaW5nKSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKGUub2JqWydfJyArIGVhLk5hbWVdKSB7CgkJCQkJCWUub2JqWydfJyArIGVhLk5hbWVdID0gKHNlcS5lbnRpdGllcy5maW5kKF9lID0+IF9lICE9PSBlICYmIF9lLm9iaiAmJiBfZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUgPT0gZS5vYmpbJ18nICsgZWEuTmFtZV0uX25hbWUpIHx8IGUpLm9ialsnXycgKyBlYS5OYW1lXTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJc2VxLnN0ZXBzID0gc2VxLnN0ZXBzLm1hcChzID0+IHsKCQkJCWlmICghcy5faWYpIHJldHVybiBbc107CgkJCQlyZXR1cm4gcy5fdGhlbi5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogdHJ1ZQoJCQkJCX0KCQkJCX0pKS5jb25jYXQocy5fZWxzZS5tYXAoc3QgPT4gJC5leHRlbmQoc3QsIHsKCQkJCQlfaWY6IHsKCQkJCQkJbGFiZWw6IHMuX2lmLAoJCQkJCQl2YWx1ZTogZmFsc2UKCQkJCQl9CgkJCQl9KSkpOwoJCQl9KTsKCQkJc2VxLnN0ZXBzID0gW10uY29uY2F0LmFwcGx5KFtdLCBzZXEuc3RlcHMpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIHNlcS5zdGVwcykgewoJCQkJaWYgKHMuaWdub3JlKSBjb250aW51ZTsKCgkJCQlsZXQgX2Zyb20gPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IHMuZnJvbSk7CgkJCQlpZiAoIV9mcm9tKSB7CgkJCQkJY29uc29sZS5sb2coIk1pc3NpbmcgRW50aXR5IERlZmluaXRpb246ICIgKyBzLmZyb20pOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJX2Zyb20gPSBfZnJvbS5vYmo7CgoJCQkJdHJ5IHsKCQkJCQlzLnBhcmFtcyA9IE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhzLnBhcmFtcykubWFwKGV0ID0+IHsKCQkJCQkJaWYgKGV0WzFdICYmIGV0WzFdLm5hbWUpIHsKCQkJCQkJCWxldCBvYmogPSBzZXEuZW50aXRpZXMuZmluZChlID0+IGUub2JqICYmIChlLm5hbWUgfHwgZS5vYmouX25hbWUpID09IGV0WzFdLm5hbWUpOwoJCQkJCQkJcmV0dXJuIG9iaiA/IFtldFswXSwgb2JqLm9ial0gOiBldDsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldHVybiBldDsKCQkJCQkJfQoJCQkJCX0pKTsKCgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgX2Zyb21bcy5tZXRob2RdKC4uLk9iamVjdC52YWx1ZXMocy5wYXJhbXMpKTsKCgkJCQkJCXMuX21ldGhvZCA9IHMubWV0aG9kLmluZGV4T2YoJy4nKSA+IDAgPyBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLklkID09IF9mcm9tLkVudGl0eUNsYXNzLklkKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2QpIDogc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMF0pLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzFdKTsKCQkJCQl9IGNhdGNoIChfZXgpIHt9CgoJCQkJCS8vIG5vdCBkZWZpbmVkIHRvIHdoaWNoIGVudGl0eSB0aGlzIGlzIGdvaW5nLCBmaW5kIGZpcnN0IGVudGl0eSBpbiB0aGUgcGFyYW1ldGVycywgb3RoZXJ3aXNlIGl0IGlzIGEgbG9vcCB0byBteXNlbGYKCQkJCQlsZXQgX3RvID0gKE9iamVjdC52YWx1ZXMocy5wYXJhbXMpIHx8IFtdKS5maW5kKHAgPT4gcCAmJiBwLkVudGl0eUNsYXNzKSB8fCBfZnJvbTsKCgkJCQkJY2FsbFNlcXVlbmNlLmVudGl0aWVzID0gY2FsbFNlcXVlbmNlLmVudGl0aWVzLmNvbmNhdChbX2Zyb20sIF90b10pLmZpbHRlcihlID0+IGUpLmZpbHRlcigob2JqLCBwb3MsIGFycikgPT4gewoJCQkJCQlyZXR1cm4gYXJyLm1hcChtYXBPYmogPT4gbWFwT2JqKS5pbmRleE9mKG9iaikgPT09IHBvczsKCQkJCQl9KTsKCgkJCQkJbGV0IHNPYmogPSB7CgkJCQkJCWRhdGU6IG5ldyBEYXRlKCksCgkJCQkJCWZyb206IF9mcm9tLAoJCQkJCQl0bzogX3RvLAoJCQkJCQlhY3RpdmF0ZTogcy5hY3RpdmF0ZSwKCQkJCQkJcGFyYW1zOiBzLnBhcmFtcywKCQkJCQkJbWV0aG9kOiBzLm1ldGhvZCwKCQkJCQkJX2lmOiBzLl9pZiwKCQkJCQl9OwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5wdXNoKHNPYmopOwoJCQkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5zb3J0KChhLCBiKSA9PiBhLmRhdGUgPCBiLmRhdGUpOwoKCQkJCQlpZiAoX2Zyb20gIT09IF90byAmJiAodHlwZW9mKHMuYWN0aXZhdGUpID09PSAndW5kZWZpbmVkJyB8fCBzLmFjdGl2YXRlKSkgewoJCQkJCQkvLyBpcyB0aGlzIGNhbGwgY2xvc2luZyBhbiBhY3RpdmF0aW9uPyB0aGVuIGRlZmluZSBpdCBhcyBhY3RpdmF0ZWQgaW4gdGhlIGluaXRpYWwgY2FsbAoJCQkJCQlsZXQgaW5pdCA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKHQgPT4gdC5mcm9tID09IHNPYmoudG8gJiYgdC50byA9PSBzT2JqLmZyb20gJiYgdC5kYXRlIDwgc09iai5kYXRlICYmICF0LmFjdGl2YXRpbmcpOwoJCQkJCQlpZiAoaW5pdCkgewoJCQkJCQkJaW5pdC5hY3RpdmF0aW5nID0gc09iajsKCQkJCQkJfQoJCQkJCX0KCQkJCQlhd2FpdCB0aGlzLl93YWl0KHMud2FpdCB8fCBzZXEud2FpdCk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKF9mcm9tLCBzLCBleCk7CgkJCQl9CgkJCX0KCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZvckVhY2goKHQsIGkpID0+IHsKCQkJCXQuZnJvbSA9IHQuZnJvbSB8fCAibnVsbCI7CgkJCQl0LnRvID0gdC50byB8fCAibnVsbCI7CgkJCQl0Ll9wcmV2aW91cyA9IGkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSAtIDFdIDogbnVsbDsKCQkJCXQuX25leHQgPSAoaSA8IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5sZW5ndGggLSAxKSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpICsgMV0gOiBudWxsOwoJCQkJdC5fYWN0aXZhdG9yID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQoX3QgPT4gX3QuYWN0aXZhdGluZyA9PSB0KTsKCQkJfSk7CgoJCQljYWxsU2VxdWVuY2VzLnB1c2goY2FsbFNlcXVlbmNlKTsKCQl9CgoJCXJldHVybiBjYWxsU2VxdWVuY2VzOwoJfQoKCWFzeW5jIF93YWl0KG1zKSB7CgkJYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7Cgl9CgoJX2ZpbGVUeXBlKGJhc2U2NCkgewoJCXZhciBiaW5hcnlfc3RyaW5nID0gdGhpcy5fYXRvYihiYXNlNjQpOwoJCXZhciBsZW4gPSBiaW5hcnlfc3RyaW5nLmxlbmd0aDsKCQl2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheShsZW4pOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQkJYnl0ZXNbaV0gPSBiaW5hcnlfc3RyaW5nLmNoYXJDb2RlQXQoaSk7CgkJfQoKCQl2YXIgYXJyID0gKG5ldyBVaW50OEFycmF5KGJ5dGVzLmJ1ZmZlcikpLnN1YmFycmF5KDAsIDQpOwoJCXZhciBoZWFkZXIgPSAnJzsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewoJCQloZWFkZXIgKz0gYXJyW2ldLnRvU3RyaW5nKDE2KTsKCQl9CgoJCS8vIENoZWNrIHRoZSBmaWxlIHNpZ25hdHVyZSBhZ2FpbnN0IGtub3duIHR5cGVzCgkJdmFyIHR5cGUgPSAndW5rbm93bic7CgkJc3dpdGNoIChoZWFkZXIpIHsKCQkJY2FzZSAnODk1MDRlNDcnOgoJCQkJdHlwZSA9ICdpbWFnZS9wbmcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzQ3NDk0NjM4JzoKCQkJCXR5cGUgPSAnaW1hZ2UvZ2lmJzsKCQkJCWJyZWFrOwoJCQljYXNlICdmZmQ4ZmZlMCc6CgkJCWNhc2UgJ2ZmZDhmZmUxJzoKCQkJY2FzZSAnZmZkOGZmZTInOgoJCQkJdHlwZSA9ICdpbWFnZS9qcGVnJzsKCQkJCWJyZWFrOwoJCQljYXNlICcyNTUwNDQ0Nic6CgkJCQl0eXBlID0gJ2FwcGxpY2F0aW9uL3BkZic7CgkJCQlicmVhazsKCQkJY2FzZSAnM2M3Mzc2NjcnOgoJCQkJdHlwZSA9ICdpbWFnZS9zdmcreG1sJzsKCQkJCWJyZWFrOwoJCX0KCQlyZXR1cm4gdHlwZTsKCX0KCglpbWcoZEltZywgbWltZVR5cGUpIHsKCQlyZXR1cm4gYGRhdGE6JHttaW1lVHlwZSB8fCB0aGlzLl9maWxlVHlwZShkSW1nKX07YmFzZTY0LGAgKyBkSW1nOwoJfQoKCV9mdWxsU2NyZWVuKGVsZW0pIHsKCQl0cnkgewoJCQlpZiAoZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJZWxlbS5yZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIFNhZmFyaSAqLwoJCQkJZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9IGVsc2UgaWYgKGVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogSUUxMSAqLwoJCQkJZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJfQoKCV9jb3B5VGV4dFRvQ2xpcGJvYXJkKHRleHQpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuY29weSkgPT09ICdmdW5jdGlvbicpIHsKCQkJd2luZG93LmNvcHkodGV4dCk7CgkJfSBlbHNlIGlmICghbmF2aWdhdG9yLmNsaXBib2FyZCkgewoJCQl2YXIgdGV4dEFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZXh0YXJlYSIpOwoJCQl0ZXh0QXJlYS52YWx1ZSA9IHRleHQ7CgoJCQkvLyBBdm9pZCBzY3JvbGxpbmcgdG8gYm90dG9tCgkJCXRleHRBcmVhLnN0eWxlLnRvcCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUubGVmdCA9ICIwIjsKCQkJdGV4dEFyZWEuc3R5bGUucG9zaXRpb24gPSAiZml4ZWQiOwoKCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0QXJlYSk7CgkJCS8vdGV4dEFyZWEuZm9jdXMoKTsKCQkJdGV4dEFyZWEuc2VsZWN0KCk7CgoJCQl0cnkgewoJCQkJdmFyIHN1Y2Nlc3NmdWwgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwoJCQkJdmFyIG1zZyA9IHN1Y2Nlc3NmdWwgPyAnc3VjY2Vzc2Z1bCcgOiAndW5zdWNjZXNzZnVsJzsKCQkJCWNvbnNvbGUubG9nKCdGYWxsYmFjazogQ29weWluZyB0ZXh0IGNvbW1hbmQgd2FzICcgKyBtc2cpOwoJCQl9IGNhdGNoIChlcnIpIHsKCQkJCWNvbnNvbGUuZXJyb3IoJ0ZhbGxiYWNrOiBPb3BzLCB1bmFibGUgdG8gY29weScsIGVycik7CgkJCX0KCgkJCWRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dEFyZWEpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQluYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KS50aGVuKGZ1bmN0aW9uKCkgewoJCQkJCWNvbnNvbGUubG9nKCdBc3luYzogQ29weWluZyB0byBjbGlwYm9hcmQgd2FzIHN1Y2Nlc3NmdWwhJyk7CgkJCQkJcmVzb2x2ZSgpOwoJCQkJfSwgZnVuY3Rpb24oZXJyKSB7CgkJCQkJY29uc29sZS5lcnJvcignQXN5bmM6IENvdWxkIG5vdCBjb3B5IHRleHQ6ICcsIGVycik7CgkJCQkJcmVqZWN0KGVycik7CgkJCQl9KTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGV4dDsKCX0KCglhc3luYyBfcmVzaXplSW1nKGltZ0Jhc2U2NCwgd2lkdGgsIGhlaWdodCwgbWltZVR5cGUsIHRvX21pbWVUeXBlKSB7CgkJaWYgKGltZ0Jhc2U2NC5zcGxpdCgnLCcpLmxlbmd0aCA+IDEpIHsKCQkJaW1nQmFzZTY0ID0gaW1nQmFzZTY0LnNwbGl0KCcsJylbMV07CgkJfQoJCXZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKCQlpbWcuc3JjID0gdGhpcy5pbWcoaW1nQmFzZTY0LCBtaW1lVHlwZSk7CgoJCS8vIGNyZWF0ZSBhbiBvZmYtc2NyZWVuIGNhbnZhcwoJCXZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKCQkJY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CgoJCS8vIHNldCBpdHMgZGltZW5zaW9uIHRvIHRhcmdldCBzaXplCgkJY2FudmFzLndpZHRoID0gd2lkdGggfHwgaW1nLndpZHRoOwoJCWNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgfHwgaW1nLmhlaWdodDsKCgkJLy8gZHJhdyBzb3VyY2UgaW1hZ2UgaW50byB0aGUgb2ZmLXNjcmVlbiBjYW52YXM6CgkJY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKCQkvLyBlbmNvZGUgaW1hZ2UgdG8gZGF0YS11cmkgd2l0aCBiYXNlNjQgdmVyc2lvbiBvZiBjb21wcmVzc2VkIGltYWdlCgkJcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwodG9fbWltZVR5cGUgfHwgbWltZVR5cGUsIDEpOwoJfQoKCWFzeW5jIF90ZW1wbGF0ZSh0bXAsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKSB7CgkJc2NvcGUgPSBzY29wZSB8fCBjb21wYW55LlNjb3BlOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lIHx8IHRtcC50ZW1wbGF0ZSB8fCB0bXAsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogJz0nCgkJCX0KCQl9KSk7CgkJaWYgKCF0ZW1wbGF0ZSkgcmV0dXJuIG51bGw7CgoJCWxldCBzY3JpcHQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0ZW1wbGF0ZS5TY3JpcHQpOwoJCWxldCBvYmogPSBuZXcgc2NyaXB0KHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYyk7CgoJCXRyeSB7CgkJCW9iai5tYWluICYmIGF3YWl0IG9iai5tYWluKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLm1haW4oKSIsIGV4KTsKCQl9CgoJCXRyeSB7CgkJCW9iai5wcmVJbmplY3QgJiYgYXdhaXQgb2JqLnByZUluamVjdCgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wcmVJbmplY3QoKSIsIGV4KTsKCQl9CgoJCWxldCByZXQgPSB7CgkJCVNjcmlwdDogb2JqLAoJCX07CgoJCWxldCB0Q2FjaGUgPSB7fTsKCQlmb3IgYXdhaXQgKGNvbnN0IGYgb2YgWydCb2R5JywgJ0Zvb3RlcicsICdUaXRsZSddKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKHRlbXBsYXRlW2ZdLm1hdGNoQWxsKC8oXFtcWyU9KS5bXHdcLS5dK1tcLl0odG1wKVtcOlw6XT9bXiglXF1cXSldKltcOlw6XT9bXiglXF1cXSldKiglXF1cXSkvZ20pKV0pIHsKCQkJCWxldCB0TmFtZVBhcnRzID0gbVswXS5yZXBsYWNlKCdbWyU9JywgJycpLnJlcGxhY2UoJyVdXScsICcnKS5yZXBsYWNlKCcudG1wJywgJycpLnNwbGl0KCc6OicpOwoJCQkJbGV0IHROYW1lID0gdE5hbWVQYXJ0c1swXTsKCQkJCWxldCB0RGF0YSA9IE9iamVjdC5hc3NpZ24oZGF0YSwge30pOwoJCQkJaWYgKHROYW1lUGFydHMubGVuZ3RoID4gMSkgewoJCQkJCXREYXRhID0gT2JqZWN0LmFzc2lnbih0RGF0YSwgYXdhaXQgdGhpcy5ydW5TY3JpcHQodE5hbWVQYXJ0c1sxXSkpOwoJCQkJfQoJCQkJbGV0IHQgPSBhd2FpdCB0aGlzLl90ZW1wbGF0ZSh0TmFtZSwgc2NvcGUsIHREYXRhLCBwcnZGdW5jKTsKCQkJCXRDYWNoZVt0TmFtZV0gPSB0Q2FjaGVbdE5hbWVdIHx8IHRbZl07CgkJCQl0ZW1wbGF0ZVtmXSA9IHRlbXBsYXRlW2ZdLnJlcGxhY2UobVswXSwgdENhY2hlW3ROYW1lXSk7CgkJCX0KCgkJCXJldFtmXSA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZVtmXSwgb2JqKTsKCQl9CgkJY29uc29sZS5sb2codENhY2hlKTsKCgkJdHJ5IHsKCQkJb2JqLnBvc3RJbmplY3QgJiYgYXdhaXQgb2JqLnBvc3RJbmplY3QocmV0KTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucG9zdEluamVjdCgpIiwgZXgpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglUZW1wbGF0ZSA9IGNsYXNzIHsKCQljb25zdHJ1Y3Rvcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKSB7CgkJCXRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKCQkJdGhpcy5zY29wZSA9IHNjb3BlOwoJCQl0aGlzLm9TY29wZSA9IHdpbmRvd1tzY29wZV07CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbbk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCXRoaXMucHJ2RnVuYygkKGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJScgc3JjPScke19GckVNRC5fc3ZnQmFzZTY0KHJldC5Cb2R5KX0nLz5gKSk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSA8PCA0KSB8IChiMiA+PiA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgPDwgMikgfCAoYjMgPj4gNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfQoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCWFzeW5jIGltcG9ydChtb2R1bGUsIGJBc3luYykgewoJCWlmIChBcnJheS5pc0FycmF5KG1vZHVsZSkpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIG1vZHVsZSkgewoJCQkJYXdhaXQgdGhpcy5pbXBvcnQobSwgYkFzeW5jKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCBpbXBvcnQobW9kdWxlKTsKCQl9IGNhdGNoIChleCkge30KCQl2YXIganMgPSBudWxsOwoJCXRyeSB7CgkJCWpzID0gKGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogbW9kdWxlCgkJCX0pKSB8fCAoYXdhaXQgJC5hamF4KHsKCQkJCXVybDogdGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBtb2R1bGUgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJaWYgKCFqcykgewoJCQlqcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBtb2R1bGUuaW5kZXhPZignLycpID49IDAgPyBtb2R1bGUgOiAoQ01TX1JPT1QgKyBtb2R1bGUpCgkJCX0pOwoJCQlpZiAoanMpIGpzID0ganMuU2NyaXB0OwoJCX0KCQlpZiAoIWpzKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMsIGJBc3luYyk7Cgl9CgoJYXN5bmMgcmVxdWlyZShsaWJOYW1lLCBocmVmcywgbG9hZGVyKSB7CgkJbGV0IF9ocmVmcyA9IFtdOwoJCWlmIChocmVmcyAmJiB0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IChocmVmcy5sZW5ndGggPiB0aGlzLmhyZWZzLmxlbmd0aCkgPyBocmVmcyA6IHRoaXMuaHJlZnM7CgkJfSBlbHNlIGlmICghdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSBocmVmczsKCQl9IGVsc2UgaWYgKHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gdGhpcy5ocmVmczsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJLy9uLnJlcXVpcmVkID0gdHJ1ZTsgLy8ubWFwKG4gPT4ge2RlbGV0ZSBuLnJlcXVpcmVkOyByZXR1cm4gbjt9KQoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCgkJCWlmIChsb2FkZXIpIHsKCQkJCWxldCBsZHIgPSBhd2FpdCBsb2FkZXIobik7CgkJCQlpZiAobGRyKSBtb2R1bGVzLnB1c2gobGRyKTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIChBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkuZmlsdGVyKHMgPT4gcykpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChzKTsKCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCB0aGlzLmltcG9ydChzKSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YocykgPT09ICdzdHJpbmcnKSB7CgkJCQkJCWxldCBqc0V4dCA9ICEoWydqc3QnXS5zb21lKGUgPT4gcy5lbmRzV2l0aCgnLicgKyBlKSkpOwoJCQkJCQlpZiAodHlwZW9mKFdvcmtlckdsb2JhbFNjb3BlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCS8vIGEgd2ViLXdvcmtlcgoJCQkJCQkJaW1wb3J0U2NyaXB0cyhzKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJiBqc0V4dCkgewoJCQkJCQkJLy8gZG9jdW1lbnQgc2hvdWxkIGxvYWQgdGhlIHNjcmlwdCB3aGVuZXZlciBwb3NzaWJsZQoJCQkJCQkJLypyZXR1cm4gKi8KCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQkJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJCQkJCXNjcmlwdC5hc3luYyA9IGZhbHNlOwoJCQkJCQkJCXNjcmlwdC5zcmMgPSBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKTsKCQkJCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJbGV0IHJldCA9IG51bGw7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoanNFeHQpIHJldHVybiByZXQ7CgkJCQkJCQkJaWYgKCFuLmxvYWQpIHJldHVybiBhd2FpdCByZXMudGV4dCgpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246IiwgZXgsIHMpOwoJCQkJfQoJCQl9CgoJCQlpZiAobi5sb2FkKSB7CgkJCQl0cnkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXRoaXMuYmxvY2tzW2Jsb2NrXSA9IHsKCQkJaHRtbDogIiIsCgkJCW9iajogbnVsbCwKCQl9CgkJdHJ5IHsKCQkJanMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IGJsb2NrCgkJCX0sICJibG9ja3MiKSB8fCBhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiB0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSk7CgkJCWlmIChqcykgewoJCQkJanMgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcyk7CgkJCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCQl0cnkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9IGF3YWl0ICQuZ2V0KHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAnZW4nOwoJCWlmIChjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xOwoJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJDb21wYW55Iik7CgkJY29tcGFueS5TY29wZSA9IGNvbXBhbnkuU2NvcGUgfHwgIndpbmRvdyI7CgkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lICsgIjogbG9hZGluZy4uLiI7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiU2VydmljZVJvdXRlciIpOwoJCXRoaXMuX2luaXRTZXJ2aWNlUm91dGVyKCk7CgoJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2YgY29tcGFueS5SZXF1aXJlZCkgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3NlcygpOwoKCQlhd2FpdCB0aGlzLl9pbml0Q29udGVudE1hbmFnZXIoKTsKCgkJYXdhaXQgdGhpcy5fbWFuaWZlc3QoKTsKCgkJbGV0IG9TY29wZSA9IHRoaXMuc3IoKS5fX3Njb3BlKGNvbXBhbnkuU2NvcGUpOyAvL3dpbmRvd1tjb21wYW55LlNjb3BlXTsKCQlvU2NvcGUuaHJlZnMgPSBbLi4ubmV3IFNldChbLi4ubmV3IFNldChvU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlRvb2xzKS5mbGF0KCkpXS5tYXAodCA9PiB0aGlzLmhyZWZzLmZpbHRlcihuID0+IG4udG9vbHMgJiYgKCFuLnRvb2xzLmxlbmd0aCB8fCBuLnRvb2xzLmluZGV4T2YodCkgPj0gMCkpKS5mbGF0KCkpXTsKCQlsZXQgbWMgPSBvU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoJCWlmIChtYykgewoJCQlhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCWluaXROb2RlOiB0cnVlCgkJCX0pOwoJCX0KCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gc2NvcGUgfHwgY29tcGFueS5TY29wZTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8J3RlbXBsYXRlcy9kLyd9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9P3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCWxldCByZXQgPSB0aGlzLl9pbmplY3QodGVtcGxhdGUsIHsKCQkJb1Njb3BlOiB3aW5kb3dbc2NvcGVdLAoJCQltZTogd2luZG93Lm1lLAoJCQlzY29wZSwKCQkJb3B0aW9ucywKCQl9LCBvcHRpb25zLmVuZ2luZSk7CgoJCWlmICh0aGlzLl9iZWF1dGlmeSkgcmV0ID0gdGhpcy5fYmVhdXRpZnkocmV0LCB0bXAubGFuZ3VhZ2UpOwoJCWlmICghdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCAkLmdldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSA9IGNvbXBhbnkuU2NvcGUpIHsKCQkvL3Njb3BlID0gc2NvcGUgfHwgIndpbmRvdyI7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAoY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXykgewoJCQllYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJCVRISVM6IGVjID8gW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IGVjCgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlFbnRpdHlDbGFzc2VzOiBbZWNdCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0gOiBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUNvbXBhbnk6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQl9CgkJCQkJfQoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCQl9XQoJCQkJCQl9CgkJCQkJfQoJCQkJfV0sCgkJCX0pOwoJCX0KCgkJdGhpcy5zdGVwKCk7CgoJCWlmICgoIWVhcyB8fCAhZWFzLmxlbmd0aCkgJiYgKCFlYyB8fCAhZWMubGVuZ3RoKSkgewoJCQl0cnkgewoJCQkJZWMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoJ1NjaGVtYScpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBjb21wYW55LkNvZGUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQl9KTsKCQkJfQoKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSB7CgkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoJCX0KCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoc2NvcGUgIT09ICJ3aW5kb3ciKSB7CgkJCWlmICh0eXBlb2Yod2luZG93W3Njb3BlXSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkvLyBjbGVhbnVwIHRoZSBvbGQgc2NvcGUKCQkJCWRlbGV0ZSB3aW5kb3dbc2NvcGVdOwoJCQl9CgkJCXdpbmRvd1tzY29wZV0gPSB7fTsKCQl9CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuRW50aXR5Q2xhc3NlcyA9IHJldDsKCQkoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdCA9IChzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0IHx8IHt9OwoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLl9fc2NyaXB0LkRhdGUgPSB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUF0dHJpYnV0ZXMgPSBlYXM7CgoJCXRyeSB7CgkJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6ICJBUElTeXN0ZW0iLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJfSk7CgkJfQoJfQoKCWFzeW5jIF9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKSB7CgkJaWYgKCFtKSByZXR1cm47CgkJbGV0IG1OYW1lID0gbS5FbnRpdHlNb2R1bGUgPyBtLkVudGl0eU1vZHVsZS5OYW1lIDogbS5OYW1lOwoJCShtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzID0gKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgfHwgMDsKCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogTG9hZGluZyAiICsgbU5hbWUpOwoKCQlsZXQgZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJRW50aXR5Q2xhc3M6IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6IG1OYW1lCgkJCQl9CgkJCX0KCQl9KTsKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCQkJSXNCb29sOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImNvZGUiLAoJCQkJCQlJc1VuaXF1ZTogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJkYXRlIiwKCQkJCQkJSXNEYXRlOiB0cnVlLAoJCQkJCQlEZWZhdWx0OiAnbmV3IERhdGUoKScsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAibmFtZSIsCgkJCQkJCVJlcXVpcmVkOiB0cnVlLAoJCQkJCQlJc1N0cmluZzogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJfV07CgkJCQkJYXR0TGlzdC5mb3JFYWNoKGEgPT4gcHJvcExpc3QuZmlsdGVyKHAgPT4gX2Jhc2VfW3BdKS5mb3JFYWNoKHAgPT4gYVtwXSA9IF9iYXNlX1twXVthLk5hbWVdKSk7CgkJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYXR0TGlzdC5jb25jYXQoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5OYW1lICE9PSAiX19CQVNFX18iKSk7CgkJCQl9CgoJCQkJWydFbnRpdHlBdHRyaWJ1dGVzJywgJ0VudGl0eUZpZWxkcyddLmZpbHRlcihlVHlwZSA9PiBjW2VUeXBlXSkuZm9yRWFjaChlVHlwZSA9PiBjW2VUeXBlXS5maWx0ZXIoZWEgPT4gZWEuRHVwbGljYXRlKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlsZXQgc2VhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzBdKVtlVHlwZV0uZmluZChzZWEgPT4gc2VhLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMV0pOwoJCQkJCU9iamVjdC5rZXlzKHNlYSkuZmlsdGVyKGsgPT4gWyJFbnRpdHlDbGFzcyJdLmluZGV4T2YoaykgPCAwKS5mb3JFYWNoKGsgPT4gewoJCQkJCQlpZiAoayA9PSAnRGVmYXVsdCcgJiYgdHlwZW9mKHNlYVtrXSkgPT09ICdzdHJpbmcnICYmICFzZWFba10uaW5kZXhPZignLyoqZ2VuZXJhdGVkKiovJykpIHJldHVybjsKCQkJCQkJZWFba10gPSBzZWFba107CgkJCQkJfSk7CgkJCQl9KSk7CgoJCQkJYy5UeXBlZEF0dHJpYnV0ZXMgPSBjLlR5cGVkQXR0cmlidXRlcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG0uTWV0aG9kUGFyYW1ldGVycyB8fCBbXTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5wdXNoKC4uLmMuRW50aXR5TWV0aG9kcy5tYXAobSA9PiBtLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gIXAuSWQpKS5mbGF0KCkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiB0eXBlb2YoZWEuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgZWEuQWN0aXZlKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiAhZWEuRW50aXR5VHlwZSB8fCAoZWEuRW50aXR5VHlwZSAmJiBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSkpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gewoJCQkJCWlmICghZWEuTmFtZSkgewoJCQkJCQljb25zb2xlLmxvZyhjLk5hbWUgKyAiIGhhcyBBdHRyaWJ1dGUgd2l0aG91dCBOYW1lIiwgZWEpOwoJCQkJCX0KCQkJCQllYS5JZCA9IGVhLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQllYS5fVG9TdHJpbmcgPSBlYS5fVG9TdHJpbmcgfHwgZWEuTmFtZTsKCQkJCQllYS5Hcm91cCA9IGVhLkdyb3VwIHx8ICJNYWluIjsKCQkJCQllYS5FbnRpdHlDbGFzcyA9IGM7CgkJCQl9KTsKCgkJCQlvR3JvdXBlci5ncm91cEJ5KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbmQodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKG0gPT4gewoJCQkJCW0uSWQgPSBtLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCQltLl9Ub1N0cmluZyA9IG0uX1RvU3RyaW5nIHx8IG0uTmFtZTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5mb3JFYWNoKHAgPT4gcC5FbnRpdHlNZXRob2QgPSBtKTsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZmlsdGVyKHAgPT4gcC5FbnRpdHlUeXBlICYmICFwLkVudGl0eVR5cGUuSWQpLmZvckVhY2gocCA9PiB7CgkJCQkJCXAuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBwLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJfSk7CgoJCQkJCWlmICghbS5SZXNwb25zZUF0dHJpYnV0ZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBjb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgUmVzcG9uc2VBdHRyaWJ1dGUgZm9yIG1ldGhvZCAiICsgbS5OYW1lICsgIi4gRGVmYXVsdGluZyB0byBvYmplY3QgcmV0dXJuIChyZXQiICsgbS5OYW1lICsgIikiKTsKCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCQkJCUlzT2JqZWN0OiB0cnVlLAoJCQkJCQl9OwoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgPSBtLlJlc3BvbnNlQXR0cmlidXRlLk5hbWUgfHwgKCJyZXQiICsgbS5OYW1lKTsKCgkJCQkJaWYgKG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKSB7CgkJCQkJCWxldCByYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUuTmFtZSk7CgkJCQkJCWlmICghcmEpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBFbnRpdHlUeXBlIE5hbWU9IiArIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUgPSByYTsKCQkJCQkJfQoJCQkJCX0KCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eU1ldGhvZCA9IG07CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMgPSB0aGlzLl91bmlxdWUoYy5FbnRpdHlNZXRob2RzKTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLklzU3RyaW5nICYmICFlYS5FbnRpdHlNZXRob2QgJiYgIWVhLkRlZmF1bHQgJiYgKGVhLlJlcXVpcmVkIHx8IGVhLklzVW5pcXVlKSkuZm9yRWFjaChlYSA9PiBlYS5EZWZhdWx0ID0gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihyYSA9PiAhcmEuRW50aXR5TWV0aG9kICYmIHJhLkVudGl0eVR5cGUgJiYgKHJhLklzVW5pcXVlIHx8IHJhLlJlcXVpcmVkKSkubWFwKHJhID0+IGAvKipnZW5lcmF0ZWQqKi8odGhpcy4ke3JhLk5hbWV9KCk/dGhpcy4ke3JhLk5hbWV9KCkuJHtlYS5OYW1lfSgpOidudWxsJylgKS5qb2luKGAgKyAnLScgKyBgKSk7CgkJCX0pOwoKCQkJLypvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5lYy5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCQllYy5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkKS5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoJCQl9KTsqLwoKCQkJcmV0ID0gdGhpcy5fdW5pcXVlKGVjKTsKCQl9IGVsc2UgaWYgKCFlYyB8fCAhQXJyYXkuaXNBcnJheShlYykpIHsKCQkJdmFyIGNsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eUNsYXNzIik7CgoJCQl2YXIgdENsYXNzZXMgPSBvR3JvdXBlci5ncm91cEJ5KGVhcywgIkVudGl0eVR5cGUiKTsKCQkJY2xhc3Nlcy5mb3JFYWNoKGMgPT4gewoJCQkJaWYgKCFjLmtleSkgewoJCQkJCWNvbnNvbGUubG9nKCJFbXB0eSBrZXkiLCBjKTsKCQkJCX0KCQkJCWMua2V5LkVudGl0eUF0dHJpYnV0ZXMgPSBjLnZhbHVlczsKCgkJCQl2YXIgdGFzID0gdENsYXNzZXMuZmluZCh0YyA9PiB0Yy5rZXkgJiYgYy5rZXkgJiYgdGMua2V5LklkID09PSBjLmtleS5JZCk7CgkJCQkvL2Mua2V5LlR5cGVkQXR0cmlidXRlcyA9IHRhcyA/IHRhcy52YWx1ZXMgOiBbXTsKCQkJCWMua2V5LkVudGl0eU1ldGhvZHMgPSBjLmtleS5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQl9KTsKCQkJcmV0ID0gY2xhc3Nlcy5tYXAoYSA9PiBhLmtleSk7CgoJCQlvR3JvdXBlci5ncm91cEJ5KGVhcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5TWV0aG9kKSwgIkVudGl0eU1ldGhvZCIpLmZvckVhY2gobWVhID0+IHsKCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQltLkVudGl0eUNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLklkID09IG0uRW50aXR5Q2xhc3NpZCk7CgkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpWzBdOwoKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyA9IG0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQl9KTsKCQl9CgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMgPSAoYy5FbnRpdHlGaWVsZHMgfHwgW10pLmZpbHRlcihmID0+ICFmLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuRW50aXR5Q2xhc3MgPSBjKTsKCQl9KTsKCgkJbGV0IHRyQ2xhc3MgPSByZXQuZmluZChjID0+IGMuTmFtZSA9PSAiVHJhbnNhY3Rpb24iICYmIGMuRW50aXR5TW9kdWxlKTsKCQlpZiAodHJDbGFzcykgcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuZmlsdGVyKG0gPT4gIW0uSXNTeW5jICYmICFtLlJlc3BvbnNlTWV0aG9kKS5mb3JFYWNoKG0gPT4gewoJCQltLlJlc3BvbnNlTWV0aG9kID0gewoJCQkJTmFtZTogbS5OYW1lICsgIlJlc3BvbnNlIiwKCQkJCU1ldGhvZFBhcmFtZXRlcnM6IFt7CgkJCQkJTmFtZTogInRyYW5zYWN0aW9uIiwKCQkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzCgkJCQl9XSwKCQkJCVNjcmlwdDogYHJldHVybiBhd2FpdCB0cmFuc2FjdGlvbi5jbGFzcygiJHtjLk5hbWV9IikubWV0aG9kKCIke20uTmFtZX0iKS5hc3luY1Jlc3VsdCgiJHttLlJlc3BvbnNlQXR0cmlidXRlPy5FbnRpdHlUeXBlPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJyl9IiwgJHttLlJlc3BvbnNlQXR0cmlidXRlLklzQXJyYXk/InRydWUiOiJmYWxzZSJ9KWAsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogbS5SZXNwb25zZUF0dHJpYnV0ZSwKCQkJfTsKCQkJYy5FbnRpdHlNZXRob2RzLnB1c2gobS5SZXNwb25zZU1ldGhvZCk7CgoJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJTmFtZTogYHJldCR7bS5OYW1lfWAsCgkJCQlFbnRpdHlUeXBlOiB0ckNsYXNzLAoJCQl9CgkJfSkpOwoKCQlvR3JvdXBlci5ncm91cEJ5KFtdLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQlsZXQgX2MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCB8fCAoYy5OYW1lID09IGN0YS5rZXkuTmFtZSAvKiYmIGMuRW50aXR5TW9kdWxlICYmIGN0YS5rZXkuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gY3RhLmtleS5FbnRpdHlNb2R1bGUuTmFtZSovICkpOwoJCQlpZiAoIV9jKSB7CgkJCQljb25zb2xlLmxvZygiTm8gY2xhc3MgZm91bmQgdG8gbWF0Y2ggIiArIGN0YS5rZXkuTmFtZSk7CgkJCX0gZWxzZSB7CgkJCQlfYy5UeXBlZEF0dHJpYnV0ZXMgPSBjdGEudmFsdWVzOwoKCQkJCWN0YS52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlUeXBlID0gX2MpOyAvLz8/PwoJCQl9CgkJfSk7CgoJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCAmJiAhcmV0LmZpbmQoYyA9PiBjLklzTWFpbikpIHsKCQkJcmV0WzBdLklzTWFpbiA9IHRydWU7CgkJCXJldFswXS5PcmRlciA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoJCX0KCgkJbGV0IGNSYW5rID0gKGMsIHNvdXJjZXMgPSBbXSkgPT4gewoJCQlzb3VyY2VzLnB1c2goYy5OYW1lKTsKCQkJcmV0dXJuIGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlICE9PSBjICYmIHNvdXJjZXMuaW5kZXhPZihlYS5FbnRpdHlUeXBlLk5hbWUpIDwgMCkubWFwKGVhID0+IGNSYW5rKGVhLkVudGl0eVR5cGUsIHNvdXJjZXMpKS5jb25jYXQoWzFdKS5yZWR1Y2UoKHN1bSwgeCkgPT4gc3VtICsgeCk7CgkJfTsKCgkJLy8gb3JkZXIgYnkgb3JkZXIKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5PcmRlciA9IGMuT3JkZXIgfHwgMDsKCQkJYy5SYW5rID0gY1JhbmsoYyk7CgkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IGVhLk9yZGVyID0gZWEuT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5TWV0aG9kcy5mb3JFYWNoKGVtID0+IGVtLk9yZGVyID0gZW0uT3JkZXIgfHwgMCk7CgkJCWMuRW50aXR5RmllbGRzLmZvckVhY2goZWYgPT4gZWYuT3JkZXIgPSBlZi5PcmRlciB8fCAwKTsKCQl9KTsKCQlyZXQuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUZpZWxkcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgoJCWlmIChyZXQubGVuZ3RoKSB7CgkJCVsnRGVidWcnLCAnQ29uZmlnJywgJ1Rlc3QnLCAnVG9vbHMnLCAnTWFwcGluZ3MnLCAnUm91dGluZycsICdWYWxpZGF0b3JzJywgJ01ldGhvZFJ1bGVzJywgJ0VudGl0eVJ1bGVzJ10uZm9yRWFjaChhID0+IHsKCQkJCWxldCBtY0EgPSByZXRbMF1bYV07CgkJCQlkZWxldGUgcmV0WzBdW2FdOwoJCQkJcmV0LmZvckVhY2goYyA9PiB7CgkJCQkJY1thXSA9IGNbYV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uW2MuTmFtZV0gfHwgYy5FbnRpdHlNb2R1bGU/LlthXT8uWycqJ10gfHwgYy5FbnRpdHlNb2R1bGU/LlthXSB8fCBtY0E/LltjLk5hbWVdIHx8IG1jQT8uWycqJ10gfHwgbWNBIHx8IHt9OwoJCQkJCWlmIChhLmVuZHNXaXRoKCdzJykgJiYgIUFycmF5LmlzQXJyYXkoY1thXSkpIGNbYV0gPSBPYmplY3Qua2V5cyhjW2FdKTsKCQkJCX0pOwoJCQl9KTsKCgkJCXJldC5maWx0ZXIoYyA9PiAhYy5Jc01haW4pLmZvckVhY2goYyA9PiBjLkNvbmZpZyA9IE9iamVjdC5hc3NpZ24oSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXQuZmluZChfYyA9PiBfYy5Jc01haW4pLkNvbmZpZykpLCBjLkNvbmZpZykpOwoKCQkJcmV0LmZpbHRlcihjID0+IGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSkuZm9yRWFjaChjID0+IGMuRW50aXR5TW9kdWxlID0gYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJX19zY29wZShzY29wZSkgewoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlKSB7CgkJbGV0IG9TY29wZSA9IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKTsKCgkJb1Njb3BlLm5OYW1lID0gb1Njb3BlLm5OYW1lIHx8ICgobiwgYkFsaWFzKSA9PiAoKGJBbGlhcyAmJiBuLkVudGl0eU1vZHVsZT8uQWxpYXMpID8gbi5FbnRpdHlNb2R1bGU/LkFsaWFzICsgJy4nIDogJycpICsgbj8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpKTsKCQlvU2NvcGUubkNvZGUgPSBvU2NvcGUubkNvZGUgfHwgKG4gPT4gewoJCQlpZiAoIW4pIHJldHVybiAiIjsKCQkJbGV0IHJldCA9IG4uTmFtZSB8fCAiIjsKCQkJaWYgKHR5cGVvZihuLkNvZGUpID09PSAic3RyaW5nIikgewoJCQkJcmV0ID0gbi5Db2RlOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuLkNvZGUpID09PSAib2JqZWN0IikgewoJCQkJbGV0IG8gPSAobi5FbnRpdHlDbGFzcyB8fCBuKTsKCQkJCWlmIChvLlRvb2wpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sLk5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoby5Ub29scy5sZW5ndGggJiYgby5Ub29sc1swXSAmJiBvLlRvb2xzWzBdLnR5cGUpIHsKCQkJCQlyZXQgPSBuLkNvZGVbby5Ub29sc1swXS50eXBlLm5hbWVdIHx8IG4uTmFtZTsKCQkJCX0gZWxzZSBpZiAoT2JqZWN0LmtleXMobi5Db2RlKS5sZW5ndGgpIHsKCQkJCQlyZXQgPSBuLkNvZGVbT2JqZWN0LmtleXMobi5Db2RlKVswXV07CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG4uTmFtZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcmV0LnJlcGxhY2UoLyAvZywgJ18nKTsKCQl9KTsKCgkJLy9sZXQgaHRtbCA9IGF3YWl0ICQuZ2V0KChzci5iTG9jYWwgPyAiL25hbW1vdXIuY29tL2Vtcy8iIDogIiIpICsgInNjcmlwdC9FbnRpdHlDbGFzcy5qc3QiICsgIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpKTsKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgewoJCQlsZXQgc05hbWUgPSBtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJyk7CgoJCQlodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShzTmFtZSkpOwoKCQkJLypsZXQgY29kZSA9IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IChzci5iTG9jYWwgPyAiL25hbW1vdXIuY29tL2Vtcy8iIDogIiIpICsgInNjcmlwdC8iICsgbVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikgKyAiP3JhbmQ9IiArIE1hdGgucmFuZG9tKCksCgkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCX0pOwoJCQlodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGNvZGUpOyovCgkJfQoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAiIjsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJYzogYywKCQkJCXNjb3BlOiBzY29wZQoJCQl9KSArICdcbicgKyBvU2NvcGUubk5hbWUoYyk7CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlICs9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke29TY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtvU2NvcGUubk5hbWUoYyl9ID0gJHtvU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gb1Njb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW29TY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQkJaWYgKGMuSXNNYWluKSB7CgkJCQkvL2FsaWFzLkdlbmVyaWNTZXJ2aWNlQVBJID0gR2VuZXJpY1NlcnZpY2VBUEk7CgkJCX0KCQl9CgoJCXJldHVybiBfY29kZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzID0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IHRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSB8fCBkOwoKCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2Nsb25lRnVuY3Rpb24obywgZiwgc2NvcGUsIGMpIHsKCQlsZXQgY29kZSA9IHdpbmRvd1tvXVtmXSA/IHdpbmRvd1tvXVtmXS50b1N0cmluZygpIDogYCAgICR7Zn0oKXsKCQkgICAgY29uc29sZS5sb2coJ0Vycm9yIGluIF9GckVNRC5fY2xvbmVGdW5jdGlvbigke299LCAke2Z9KTogSW52YWxpZCBGdW5jdGlvbiBOYW1lJyk7CgkgICAgfWA7CgkJbGV0IHMgPSBjb2RlLnJlcGxhY2UoJyknLCAnKSA9PiAnKTsKCQlpZiAocy5pbmRleE9mKCdmdW5jdGlvbicpID09IDAgfHwgcy5pbmRleE9mKCdhc3luYyBmdW5jdGlvbicpID09IDApIHsKCQkJcyA9IHMucmVwbGFjZSgnZnVuY3Rpb24nLCAnICcpOwoJCX0gZWxzZSB7CgkJCXMgPSBzLnJlcGxhY2UoZiwgJycpOwoJCX0KCgkJaWYgKGMuSXNNYWluICYmICF3aW5kb3dbb11bZl0pIHsKCQkJY29uc29sZS5sb2coJ0Vycm9yIGluIF9GckVNRC5fY2xvbmVGdW5jdGlvbigpOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUgJyArIGYpOwoJCX0KCgkJcmV0dXJuIGAKICAgICR7Zn0oLi4ucGFyYW1zKXsKICAgICAgICBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuJHtvfSkhPT0idW5kZWZpbmVkIil7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuJHtvfS4ke2Z9KC4uLnBhcmFtcyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGAgKyAoYy5Jc01haW4gPyBgcmV0dXJuICgke3N9KSguLi5wYXJhbXMpO2AgOiBgcmV0dXJuIG5ldyAke3Njb3BlfS4ke3dpbmRvd1tzY29wZV0uRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbikuTmFtZS5yZXBsYWNlKC8gL2csICdfJyl9KCkuJHtmfSguLi5wYXJhbXMpO2ApICsgYAogICAgICAgIH0KCX0KYDsKCX0KCglfaW5pdFNlcnZpY2VSb3V0ZXIoKSB7CgkJd2luZG93LnNyID0gbmV3IFNlcnZpY2VSb3V0ZXIoKTsKCgkJdGhpcy5zcigpLlN0b3JlID0gY29tcGFueS5TdG9yZTsKCQl0aGlzLnNyKCkuaW5pdChudWxsLCBjb21wYW55LmxpYnJhcnkgfHwgIkVudGVycHJpc2VNYW5hZ2VyIiwgdHJ1ZSwgdGhpcy5iRGVidWcpOwoJCWlmICh0eXBlb2Ygc3JVUkwgIT09ICd1bmRlZmluZWQnKSB0aGlzLnNyKCkuc3JVUkwgPSBzclVSTDsKCQl0aGlzLnNyKCkuZkxvYWRpbmdTdGFydCA9ICgpID0+IHsKCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5sb2FkaW5nKCdzaG93Jyk7CgkJfTsKCQl0aGlzLnNyKCkuZkxvYWRpbmdFbmQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnaGlkZScpOwoJCX07Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAodHlwZW9mKHVybCkgPT0gIm9iamVjdCIpIHsKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJfSBlbHNlIHsKCQkJdmFyIG9QYWdlID0gJChzSFRNTCk7CgkJCW9QYWdlLmFwcGVuZFRvKCQubW9iaWxlLnBhZ2VDb250YWluZXIpOwoJCQl2YXIgb2xkID0gdHJ1ZTsKCQkJdGhpcy5hbGxPcHRpb25zID0gdGhpcy5hbGxPcHRpb25zIHx8IHt9OwoJCQlpZiAob2xkKSB7CgkJCQl0aGlzLmFsbE9wdGlvbnMuZGF0YVVybCA9IHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5hY3RpdmVQYWdlLnJlbW92ZSgpOwoJCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5jaGFuZ2VQYWdlKG9QYWdlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJJCgiZG9jdW1lbnQiKS5wYWdlY29udGFpbmVyKCJnZXRBY3RpdmVQYWdlIikucmVtb3ZlKCk7CgkJCQlvUGFnZS5lbmhhbmNlV2l0aGluKCk7CgkJCQkkKCI6bW9iaWxlLXBhZ2Vjb250YWluZXIiKS5wYWdlY29udGFpbmVyKCJjaGFuZ2UiLCAnIycgKyBkYXRhLnBhZ2UuX2NvZGUsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCQljb25zb2xlLmxvZygic2hvd2VkIik7CgkJCX0KCQl9CgkJaWYgKGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmIChjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmIChjb21wYW55Lk9uUGFnZUxvYWQpIHsKCQkJdHJ5IHsKCQkJCWF3YWl0IGNvbXBhbnkuT25QYWdlTG9hZChkYXRhKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJGckVNRC5lbmQuT25QYWdlTG9hZCIsIGV4KTsKCQkJfQoJCX0KCgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQlhd2FpdCB3aW5kb3cuREZvcm0uX2VuZCgpOwoJCX0KCgkJdHJ5IHsKCQkJLy8gZmluZCBhIGJldHRlciB3YXkgdG8gcmUtaW52b2tlIGFsbCB3aW5kb3cgbG9hZCBldmVudHMuCgkJCWxldCBsb2FkZXJzID0gKGpRdWVyeS5fZGF0YSB8fCBqUXVlcnkuZGF0YSkod2luZG93LCAnZXZlbnRzJykubG9hZCB8fCBbXTsKCQkJbG9hZGVycy5mb3JFYWNoKGYgPT4gZi5oYW5kbGVyKCkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWNvbnNvbGUubG9nKCJQYWdlIExvYWRlZDogIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSk7Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6ICdMb2FkaW5nJywKCQkJCQltc2c6ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCQkJdGl0bGU6ICdQbGVhc2Ugd2FpdGluZycsCgkJCQkJCQltc2c6ICdTYXZpbmcgZGF0YS4uLicsCgkJCQkJCQlpbnRlcnZhbDogb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglzZWxlY3QyU1Iob1NlbGVjdCkgewoJCWxldCBzID0gJChvU2VsZWN0KTsKCQlsZXQgY2FsbHMgPSBbXTsKCQlpZiAodGhpcy5zZWxlY3QyVGVtcGxhdGUpIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSk7CgkJfSBlbHNlIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNyKCkuR2V0KHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi9zZWxlY3QyLXRlbXBsYXRlLmh0bSIpKSk7CgkJfQoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCXRoaXMuc2VsZWN0MlRlbXBsYXRlID0gcmV0WzBdOwoJCQlzLnNlbGVjdDIoewoJCQkJYWpheDogewoJCQkJCXRyYW5zcG9ydDogKHBhcmFtcywgc3VjY2VzcywgZmFpbHVyZSkgPT4gewoJCQkJCQl2YXIgZkZpbHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQoIihvLCBzdGF0ZSkgPT4geyIgKyBzLmRhdGEoInNyX2ZpbHRlciIpICsgIn0iKTsKCQkJCQkJJC53aGVuKHRoaXMuc3IoKS5fKHMuZGF0YSgic3JfbWV0aG9kIiksIG51bGwsIGZGaWx0ZXIoe30sIHRoaXMuc3IoKS5ydW5TY3JpcHQocy5kYXRhKCJjX3N0YXRlIikpKSkpLnRoZW4ocmV0ID0+IHsKCQkJCQkJCXN1Y2Nlc3MoewoJCQkJCQkJCXBhZ2luYXRpb246IHsKCQkJCQkJCQkJbW9yZTogZmFsc2UKCQkJCQkJCQl9LAoJCQkJCQkJCXJlc3VsdHM6ICQubWFwKHJldCwgciA9PiB7CgkJCQkJCQkJCXIuaWQgPSByLklkOwoJCQkJCQkJCQlyLnRleHQgPSByLlRvU3RyaW5nOwoJCQkJCQkJCQlyZXR1cm4gcjsKCQkJCQkJCQl9KSwKCQkJCQkJCQl0b3RhbHM6IHJldC5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9LAoJCQkJdGVtcGxhdGVSZXN1bHQ6IChfZSwgX3MpID0+IHsKCQkJCQlyZXR1cm4gdGhpcy5faW5qZWN0KHRoaXMuc2VsZWN0MlRlbXBsYXRlLCB7CgkJCQkJCWRhdGE6IF9lCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJCWNvbnNvbGUubG9nKGUudGFyZ2V0KTsKCQkJfSk7CgkJCXMub24oImNoYW5nZS5zZWxlY3QyIiwgZSA9PiB7CgkJCQkvL3ZhciBkYXRhID0gZS5wYXJhbXMuZGF0YTsKCQkJCXZhciBfcyA9ICQoZS50YXJnZXQpOwoJCQl9KTsKCQl9KTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQl0cnkgewoJCQkJanN4ID0gYXdhaXQgJC5nZXQodGhpcy5yYW5kVVJMKChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfdnVlQ29tcG9uZW50KGNvZGUpIHsKCQlpZiAodHlwZW9mIFZ1ZSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoJCXJldCA9IGF3YWl0IHRoaXMuX3Z1ZUNvbXBvbmVudChwYWdlLl9jb2RlKTsKCQlpZiAoIXJldCAmJiBDTVNfUk9PVCkgewoJCQlyZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogcGFnZS5fY29kZS5pbmRleE9mKCcvJykgPj0gMCA/IHBhZ2UuX2NvZGUgOiAoQ01TX1JPT1QgKyBwYWdlLl9jb2RlKQoJCQl9KTsKCQl9CgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBDTVMsIGxvb2tpbmcgaW4gRU1TIik7CgkJCXZhciBlb1BhZ2UgPSBudWxsOwoJCQl0cnkgewoJCQkJZW9QYWdlID0gbmV3IFBhZ2UoKS5jb2RlKHBhZ2UuX2NvZGUsICI9Iik7CgkJCQlpZiAoZW9QYWdlLmxhbmd1YWdlKSBlb1BhZ2UubGFuZ3VhZ2Uod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iLCAiPSIpOwoJCQl9IGNhdGNoIChlKSB7CgkJCQljb25zb2xlLmxvZygiRU1TIGRvZXMgbm90IGhhdmUgYSBQYWdlIGNsYXNzLCBmYWlsaW5nIG9uIHB1cnBvc2U6ICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJCWxldCByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmh0bSIpKTsKCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSBqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuanMiKSk7CgkJCWlmICghanMgfHwgIWpzLm9rKSBqcyA9IG51bGw7CgkJCWlmIChqcyAmJiBqcy5vaykgcGFnZS5TY3JpcHQgPSBhd2FpdCBqcy50ZXh0KCk7CgoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgc2NyaXB0IGlzIiArIChqcyA/ICcnIDogJyBub3QnKSArICIgcmV0cmlldmVkIik7CgkJCXRoaXMuc3RlcCgpOwoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCS8vY29uc29sZS5sb2coInBhZ2UgQm9keSIsIHBhZ2UuX2JvZHkgfHwgcGFnZS5Cb2R5KTsKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQlsZXQgb2JqID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UpOwoJCQkJcGFnZS5jb21wb25lbnQgPSBvYmo7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgUmVuZGVyUGFnZShwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWRlbGV0ZSB3aW5kb3cuRm9ybUNvbXBvbmVudDsKCQkJJCgiI2Zvcm1Db21wb25lbnQiKS5lbXB0eSgpOwoJCX0KCQl2YXIgX3BhZ2UgPSBhd2FpdCB0aGlzLl9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucyk7CgkJaWYgKCFfcGFnZSkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihnYSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWdhKCdzZW5kJywgewoJCQkJaGl0VHlwZTogJ3BhZ2V2aWV3JywKCQkJCXBhZ2U6ICcvJyArIF9wYWdlLl9jb2RlICsgJy5keW5hbWljJywKCQkJCXRpdGxlOiBfcGFnZS5fdGl0bGUKCQkJfSk7CgkJCWNvbnNvbGUubG9nKCJTZW50IEdBIGhpdCBmb3IgcGFnZTogIiArIChfcGFnZS5fY29kZSB8fCBfcGFnZS5QYWdlIHx8IF9wYWdlKSk7CgkJfQoJCXdpbmRvdy5wYWdlID0gX3BhZ2U7CgkJdGhpcy5hbGxIVE1MID0gdGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkpICsgdGhpcy5ibG9ja3MuZm9vdGVyLmh0bWw7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChqcy5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChqcyk7CgkJCX0gZWxzZSB7CgkJCQlsZXQgc0NvZGUgPSBqczsKCQkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCQl9CgkJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KCIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7Iik7CgkJCX0KCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2EoanMpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBqcy5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZXZhbChqcyk7CgkJfQoJfQp9",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
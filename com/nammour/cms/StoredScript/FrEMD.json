{
	"Id": "bd7460ca2c3a72ca3218f42d3c012dcfaa1e81f0",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "FrEMD",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpKT8uU2NyaXB0OwoJCX0gZWxzZSBpZiAoIXRoaXMuYXBpU2VydmVyIHx8ICF0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKSkgewoJCQkvL2NvbnNvbGUubG9nKCJfZ2V0U3RvcmVkU2NyaXB0KCk6IG5vIGFwaVNlcnZlciwgcnVubmluZyBpbiBzY29wZSAiLCB0aGlzLl9fc2NvcGUoKSk7CgkJCWxldCBfcyA9IGF3YWl0IGZldGNoKGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbj9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQkJaWYgKF9zLm9rKSBzY3JpcHQgPSBhdG9iKChhd2FpdCBfcy5qc29uKCkpLnNjcmlwdCk7CgkJfSBlbHNlIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRHIuIEZhZGkgTmFtbW91cid9LCBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5AZW5kdW1sYCkuc3BsaXQoJ0BlbmR1bWwnKS5tYXAoYiA9PiBgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazsgaGVpZ2h0OiAxMDAlJyBzcmM9J2h0dHBzOi8vd3d3LnBsYW50dW1sLmNvbS9wbGFudHVtbC9wbmcvJHt0aGlzLnpvcChiKydAZW5kdW1sJyl9Jy8+YCkuam9pbignPGJyLz4nKTsKCgkJCXRoaXMucHJ2RnVuYygkKGA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBvdmVyZmxvdy15OiBzY3JvbGw7Ij4ke2h0bWx9PC9kaXY+YCkpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJem9wKHMpIHsKCQkJcyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzKSk7CgkJCXZhciBhcnIgPSBbXTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSBhcnIucHVzaChzLmNoYXJDb2RlQXQoaSkpOwoJCQlsZXQgeiA9IG5ldyBab3BmbGkuUmF3RGVmbGF0ZShhcnIpLmNvbXByZXNzKCk7CgkJCXJldHVybiB0aGlzLmVuY29kZTY0Xyh6KTsKCQl9CgoJCWVuY29kZTY0XyhkYXRhKSB7CgkJCWxldCByID0gIiI7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMykgewoJCQkJaWYgKGkgKyAyID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgMCk7CgkJCQl9IGVsc2UgaWYgKGkgKyAxID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCAwLCAwKTsKCQkJCX0gZWxzZSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgZGF0YVtpICsgMl0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiByOwoJCX0KCgkJYXBwZW5kM2J5dGVzKGIxLCBiMiwgYjMpIHsKCQkJbGV0IGMxID0gYjEgPj4gMjsKCQkJbGV0IGMyID0gKChiMSAmIDB4MykgPDwgNCkgfCAoYjIgPj4gNCk7CgkJCWxldCBjMyA9ICgoYjIgJiAweEYpIDw8IDIpIHwgKGIzID4+IDYpOwoJCQlsZXQgYzQgPSBiMyAmIDB4M0Y7CgkJCWxldCByID0gIiI7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMxICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMyICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMzICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGM0ICYgMHgzRik7CgkJCXJldHVybiByOwoJCX0KCgkJZW5jb2RlNmJpdChiKSB7CgkJCWlmIChiIDwgMTApIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDQ4ICsgYik7CgkJCX0KCQkJYiAtPSAxMDsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiID09IDApIHsKCQkJCXJldHVybiAnLSc7CgkJCX0KCQkJaWYgKGIgPT0gMSkgewoJCQkJcmV0dXJuICdfJzsKCQkJfQoJCQlyZXR1cm4gJz8nOwoJCX0KCX07CgoJdG9CYXNlNjQodXJsLCBkYXRhLCBtaW1lID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsIGJSYXcpIHsKCQlyZXR1cm4gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3VybCA/IHRoaXMuX2luamVjdCgkLmFqYXgoewoJCQl1cmw6IHVybCArICc/JyArIE1hdGgucmFuZG9tKCksCgkJCWFzeW5jOiBmYWxzZQoJCX0pLnJlc3BvbnNlVGV4dCwgZGF0YSkgOiAoYlJhdyA/IGRhdGEgOiBKU09OLnN0cmluZ2lmeShkYXRhKSldLCB7CgkJCXR5cGU6IG1pbWUKCQl9KSk7Cgl9CgoJX3N2Z0Jhc2U2NCh0eHQpIHsKCQl0cnkgewoJCQltZXJtYWlkLm1lcm1haWRBUEkuaW5pdGlhbGl6ZSh7CgkJCQkidGhlbWUiOiAiZGVmYXVsdCIsCgkJCQkic2VjdXJpdHlMZXZlbCI6ICJsb29zZSIsCgkJCQkibWF4VGV4dFNpemUiOiA5MDAwMDAwMCwKCQkJfSk7CgoJCQlyZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsJyArIHRoaXMuX2J0b2EobmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZygkKG1lcm1haWQubWVybWFpZEFQSS5yZW5kZXIoJ2dyYXBoRGl2JywgdHh0KSlbMF0pKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gdHh0OwoJCX0KCX0KCglfcHJ1bmUob2JqKSB7CgkJaWYgKHR5cGVvZihvYmopID09PSAidW5kZWZpbmVkIiB8fCBvYmogPT09IG51bGwpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gIm9iamVjdCIpIHJldHVybiBvYmo7CgkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewoJCQlsZXQgcmV0ID0gb2JqLm1hcCh2ID0+IHRoaXMuX3BydW5lKHYpKS5maWx0ZXIodiA9PiB2KTsKCQkJcmV0dXJuIHJldC5sZW5ndGggPyByZXQgOiBudWxsOwoJCX0KCgkJbGV0IHJldCA9IE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5lbnRyaWVzKG9iaikubWFwKChba2V5LCB2YWx1ZV0pID0+IHZhbHVlID8gKHsKCQkJW2tleV06IHRoaXMuX3BydW5lKHZhbHVlKQoJCX0pIDogbnVsbCkpOwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLmxlbmd0aCA/IHJldCA6IG51bGw7Cgl9CgoJdmFsaWRVUkwoc3RyKSB7CgkJdmFyIHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeKGh0dHBzPzpcXC9cXC8pPycgKyAvLyBwcm90b2NvbAoJCQknKCgoW2EtelxcZF0oW2EtelxcZC1dKlthLXpcXGRdKSopXFwuKStbYS16XXsyLH18JyArIC8vIGRvbWFpbiBuYW1lCgkJCScoKFxcZHsxLDN9XFwuKXszfVxcZHsxLDN9KSknICsgLy8gT1IgaXAgKHY0KSBhZGRyZXNzCgkJCScoXFw6XFxkKyk/KFxcL1stYS16XFxkJV8ufitdKikqJyArIC8vIHBvcnQgYW5kIHBhdGgKCQkJJyhcXD9bOyZhLXpcXGQlXy5+Kz0tXSopPycgKyAvLyBxdWVyeSBzdHJpbmcKCQkJJyhcXCNbLWEtelxcZF9dKik/JCcsICdpJyk7IC8vIGZyYWdtZW50IGxvY2F0b3IKCQlyZXR1cm4gISFwYXR0ZXJuLnRlc3Qoc3RyKTsKCX0KCglfdG9KUyhvKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihvKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiAndW5kZWZpbmVkJzsKCgkJCXJldHVybiBgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoXGAke3RoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkobywgKHQsbik9PiJmdW5jdGlvbiI9PT10eXBlb2Ygbj9uLnRvU3RyaW5nKCk6bikpfVxgKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KWA7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl90b0pTOiAiICsgZXgudG9TdHJpbmcoKSk7CgkJfQoJfQoKCV9hdG9iKGEpIHsKCQlyZXR1cm4gdHlwZW9mKGF0b2IpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGEsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JykgOiBhdG9iKGEpOwoJfQoKCV9idG9hKGIpIHsKCQlyZXR1cm4gdHlwZW9mKGJ0b2EpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGIpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGIpKSk7Cgl9CgoJX2F0dHIoZWEpIHsKCQl0cnkgewoJCQlpZiAoZWEuRW50aXR5VHlwZSkgcmV0dXJuICJFbnRpdHkiOwoJCQlyZXR1cm4gT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+ICFrLmluZGV4T2YoIklzIikgJiYgayAhPT0gIklzVW5pcXVlIikuZmluZChrID0+IGVhW2tdKS5yZXBsYWNlKCdJcycsICcnKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3NxbFR5cGUoZWEsIGRiVHlwZSkgewoJCWxldCB0eXBlID0gdHlwZW9mKGVhKSA9PT0gInN0cmluZyIgPyBlYSA6IHRoaXMuX2F0dHIoZWEpOwoJCXN3aXRjaCAodHlwZSkgewoJCQljYXNlICJTdHJpbmciOgoJCQljYXNlICcnOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJUZXh0IjoKCQkJY2FzZSAiT2JqZWN0IjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdzcWxpdGUnPydWQVJDSEFSJzonVEVYVCd9JHtkYlR5cGU9PSdwb3N0Z3Jlcyc/Jyc6Jyg0MDAwKSd9YDsKCQkJY2FzZSAiQm9vbCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCSVQoMSknOidUSU5ZSU5UJ31gOyAvL0JJVAoJCQljYXNlICJEYXRlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J1RJTUVTVEFNUCc6J0RBVEVUSU1FJ31gOwoJCQljYXNlICJJbnQiOgoJCQkJcmV0dXJuICJJTlRFR0VSIjsKCQkJY2FzZSAiTG9uZyI6CgkJCQlyZXR1cm4gIkJJR0lOVCI7CgkJCWNhc2UgIkVudGl0eSI6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIkltYWdlIjoKCQkJY2FzZSAiRmlsZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCWVRFQSc6IkJMT0IifWA7CgkJCWRlZmF1bHQ6CgkJCQlyZXR1cm4gdHlwZSArICIoNDApIjsKCQl9Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgYkFzeW5jKSB7CgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgbW9kdWxlKSB7CgkJCQlhd2FpdCB0aGlzLmltcG9ydChtLCBiQXN5bmMpOwoJCQl9CgkJCXJldHVybjsKCQl9CgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCXZhciBqcyA9IG51bGw7CgkJdHJ5IHsKCQkJanMgPSAoYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBtb2R1bGUKCQkJfSkpIHx8IChhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiB0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIG1vZHVsZSArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pKTsKCQl9IGNhdGNoIChleCkge30KCQlpZiAoIWpzKSB7CgkJCWpzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IG1vZHVsZS5pbmRleE9mKCcvJykgPj0gMCA/IG1vZHVsZSA6IChDTVNfUk9PVCArIG1vZHVsZSkKCQkJfSk7CgkJCWlmIChqcykganMgPSBqcy5TY3JpcHQ7CgkJfQoJCWlmICghanMpIHJldHVybiBudWxsOwoJCXJldHVybiBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcywgYkFzeW5jKTsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKCFqc0V4dCAmJiAhbi5sb2FkKSByZXQgPSBhd2FpdCByZXMudGV4dCgpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246IiwgZXgsIHMpOwoJCQkJfQoJCQl9CgoJCQlpZiAobi5sb2FkKSB7CgkJCQl0cnkgewoJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06IGNhbGxpbmcgbG9hZCgpIik7CgkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIG1vZHVsZXMsIGV4KTsKCQkJCX0KCQkJfQoJCX0KCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBwb3N0SW5pdCgpIHsKCQl0cnkgewoJCQl3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyID8gd2luZG93LmZyYW1lc1swXS5yZVJlbmRlcigpIDogbnVsbDsKCQl9IGNhdGNoIChleCkge30KCgkJdHJ5IHsKCQkJbGV0IGV2ZW50cyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRXZlbnRzIik7CgkJCWlmICghZXZlbnRzICYmIGNvbXBhbnkuRXZlbnRzKSB7CgkJCQlldmVudHMgPSBhd2FpdCBjb21wYW55LkV2ZW50cygpOwoJCQl9CgkJCShldmVudHMgfHwgW10pLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5mb3JFYWNoKGV2ID0+IHsKCQkJCSQoZXYuX3BhdGgsIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQpLm9uKGV2Ll9ldmVudCwgZXYuX2hhbmRsZXIpOwoJCQl9KTsKCQl9IGNhdGNoIChleCkge30KCX0KCglleGNlbFRvSlNPTihkYXRhLCBzdGFydCwgY291bnQpIHsKCQlpZiAodHlwZW9mKFhMU1gpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIFtdOwoJCXRyeSB7CgkJCXZhciB3b3JrYm9vayA9IFhMU1gucmVhZChkYXRhLCB7CgkJCQl0eXBlOiAnYmluYXJ5JywKCQkJCXNoZWV0Um93czogMCAvKnN0YXJ0ICsgIi0iICsgKHN0YXJ0ICsgY291bnQpKi8KCQkJfSk7CgkJCS8vdmFyIHJhbmdlID0gWExTWC51dGlscy5kZWNvZGVfcmFuZ2Uod29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dWychcmVmJ10pOwoJCQl2YXIgc2hlZXQgPSB3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV07CgkJCXJldHVybiBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLy90aHJvdyBlOwoJCQljb25zb2xlLmxvZygiRVJST1I6IiwgZSk7CgkJCXJldHVybiBbXTsKCQl9Cgl9CgoJYXN5bmMgX3VuemlwKGZpbGUpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJbGV0IGYgPSBhd2FpdCB6aXAubG9hZChmaWxlLCB7CgkJCWJhc2U2NDogdHJ1ZQoJCX0pCgl9CgoJYXN5bmMgX3ppcChmaWxlcykgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlmaWxlcy5mb3JFYWNoKGYgPT4gewoJCQl6aXAuZmlsZShmLm5hbWUsIGYuZmlsZSk7CgkJfSk7CgkJbGV0IHJldCA9IGF3YWl0IHppcC5nZW5lcmF0ZSh7CgkJCXR5cGU6ICdibG9iJywKCQkJY29tcHJlc3Npb246ICJERUZMQVRFIgoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJVXRmOEFycmF5VG9TdHIoYXJyYXkpIHsKCQl2YXIgb3V0LCBpLCBsZW4sIGM7CgkJdmFyIGNoYXIyLCBjaGFyMzsKCgkJb3V0ID0gIiI7CgkJbGVuID0gYXJyYXkubGVuZ3RoOwoJCWkgPSAwOwoJCXdoaWxlIChpIDwgbGVuKSB7CgkJCWMgPSBhcnJheVtpKytdOwoJCQlzd2l0Y2ggKGMgPj4gNCkgewoJCQkJY2FzZSAwOgoJCQkJY2FzZSAxOgoJCQkJY2FzZSAyOgoJCQkJY2FzZSAzOgoJCQkJY2FzZSA0OgoJCQkJY2FzZSA1OgoJCQkJY2FzZSA2OgoJCQkJY2FzZSA3OgoJCQkJCS8vIDB4eHh4eHh4CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDEyOgoJCQkJY2FzZSAxMzoKCQkJCQkvLyAxMTB4IHh4eHggICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgxRikgPDwgNikgfCAoY2hhcjIgJiAweDNGKSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDE0OgoJCQkJCS8vIDExMTAgeHh4eCAgMTB4eCB4eHh4ICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJY2hhcjMgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MEYpIDw8IDEyKSB8CgkJCQkJCSgoY2hhcjIgJiAweDNGKSA8PCA2KSB8CgkJCQkJCSgoY2hhcjMgJiAweDNGKSA8PCAwKSk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBvdXQ7Cgl9CgoJYXN5bmMgX2NvbXByZXNzKHN0cikgewoJCWNvbnN0IGJ5dGVBcnJheSA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwoJCWNvbnN0IGNzID0gbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIik7CgkJY29uc3Qgd3JpdGVyID0gY3Mud3JpdGFibGUuZ2V0V3JpdGVyKCk7CgkJd3JpdGVyLndyaXRlKGJ5dGVBcnJheSk7CgkJd3JpdGVyLmNsb3NlKCk7CgkJcmV0dXJuIG5ldyBSZXNwb25zZShjcy5yZWFkYWJsZSkuYXJyYXlCdWZmZXIoKQoKCQkvLyBDb252ZXJ0IHRoZSBzdHJpbmcgdG8gYSBieXRlIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbc3RyXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJcmV0dXJuIGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7Cgl9CgoJYXN5bmMgX2RlY29tcHJlc3MoY29tcHJlc3NlZEJ5dGVzKSB7CgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW2NvbXByZXNzZWRCeXRlc10pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBkZWNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGRlY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IERlY29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgZGVjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJY29uc3Qgc3RyaW5nQnl0ZXMgPSBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmluZy4KCQlyZXR1cm4gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKHN0cmluZ0J5dGVzKTsKCX0KCglhc3luYyBkb3dubG9hZFNSQ2FjaGUoY29kZSwgZmlsZW5hbWUpIHsKCQkvLyB0byBiZSBtb3ZlZCBvdXQgb2YgdGhpcyBjbGFzcwoJCWNvZGUgPSBjb2RlIHx8IGNvbXBhbnkuQ29kZTsKCQlsZXQgZmlsZXMgPSBhd2FpdCB0aGlzLnNyKCkuXygnQ29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZGFsbCcsIG51bGwsIHsKCQkJQ29kZTogY29kZSArICctJywKCQl9KTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5femlwKGZpbGVzLm1hcChyID0+ICh7CgkJCW5hbWU6IHIuQ29kZS5yZXBsYWNlKGNvZGUgKyAnLScsICcnKSArICcuanMnLAoJCQlmaWxlOiByLlJlc3VsdAoJCX0pKSwgZmlsZW5hbWUgfHwgJ3NyQ2FjaGUuemlwJyk7Cgl9CgoJYXN5bmMgX2dldEJsb2NrKGJsb2NrKSB7CgkJdmFyIGpzID0gbnVsbDsKCQl2YXIgaHRtbCA9IG51bGw7CgkJdGhpcy5ibG9ja3NbYmxvY2tdID0gewoJCQlodG1sOiAiIiwKCQkJb2JqOiBudWxsLAoJCX0KCQl0cnkgewoJCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJCWxldCBwID0gYXdhaXQgdGhpcy5fZm9sZGVyVG9QYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgYmxvY2suaW5kZXhPZignLycpID49IDAgPyBibG9jayA6ICh0aGlzLmFwaVNlcnZlci5TY29wZSArICcvYmxvY2tzJyArIHRoaXMubSgpICsgIi8iICsgYmxvY2spKS5maW5kKCk7CgkJCQlpZiAocCkgewoJCQkJCWh0bWwgPSBwLmJvZHkoKSA/IHAuYm9keSgpIDogJyc7CgkJCQkJanMgPSBwLnNjcmlwdCgpID8gcC5zY3JpcHQoKSA6IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICghanMpIGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIik7CgoJCQlpZiAoIWpzICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSk7CgkJCQlqcyA9IGpzLm9rID8gKGF3YWl0IGpzLnRleHQoKSkgOiBudWxsOwoJCQl9CgoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWlmICghaHRtbCAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJCWh0bWwgPSBodG1sLm9rID8gKGF3YWl0IGh0bWwudGV4dCgpKSA6ICcnOwoJCX0KCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9IGh0bWw7CgoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J30/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiAhdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCBmZXRjaCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKCk7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiZW5kKCkgd2l0aCBkYXRhIiwgZGF0YSk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQkvL29Db250ZW50LmhpZGUoKTsKCQkJLy9vQ29udGVudC5mYWRlSW4oMTAwMCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDAsIG1zZywgdGl0bGUpIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiB0aXRsZSB8fCAnTG9hZGluZycsCgkJCQkJbXNnOiBtc2cgfHwgJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsICdTYXZpbmcgZGF0YS4uLicsICdQcm9ncmVzcycpOwoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlfRnJFTUQuX2xvYWRpbmcoZmFsc2UpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCV9mb2xkZXJUb1BhZ2UoZm9sZGVyKSB7CgkJbGV0IGZOYW1lID0gZm9sZGVyLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmb2xkZXIuc3BsaXQoJy8nKS5zbGljZSgxKS5yZWR1Y2UodiA9PiB2ICsgJ10nLCAnX19udWxsJykgKyAnLmpzb24nOwoJCWlmICghdGhpcy5hcGlTZXJ2ZXIpIHJldHVybiBmTmFtZTsKCgkJbGV0IHAgPSB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUoZk5hbWUpOwoJCXAuY29kZShwLmNvZGUoKSwgJz0nKTsKCQlyZXR1cm4gcDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCkgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuX2ZvbGRlclRvUGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBwLnNjcmlwdCgpIHx8ICcnLAoJCQkJQm9keTogcC5ib2R5KCkgfHwgJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihDTVNfUk9PVCkgPT09ICdzdHJpbmcnKSB7CgkJCXJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBwYWdlLl9jb2RlLmluZGV4T2YoJy8nKSA+PSAwID8gcGFnZS5fY29kZSA6IChDTVNfUk9PVCArIHBhZ2UuX2NvZGUpCgkJCX0pOwoJCX0KCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIENNUywgbG9va2luZyBpbiBFTVMiKTsKCQkJdmFyIGVvUGFnZSA9IG51bGw7CgkJCXRyeSB7CgkJCQllb1BhZ2UgPSBuZXcgUGFnZSgpLmNvZGUocGFnZS5fY29kZSwgIj0iKTsKCQkJCWlmIChlb1BhZ2UubGFuZ3VhZ2UpIGVvUGFnZS5sYW5ndWFnZSh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIsICI9Iik7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWNvbnNvbGUubG9nKCJFTVMgZG9lcyBub3QgaGF2ZSBhIFBhZ2UgY2xhc3MsIGZhaWxpbmcgb24gcHVycG9zZTogIiArIGUubWVzc2FnZSk7CgkJCX0KCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBudWxsOwoJCQl0cnkgewoJCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuaHRtIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSB0cnkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKCFqcyB8fCAhanMub2spIGpzID0gbnVsbDsKCQkJaWYgKGpzICYmIGpzLm9rKSBwYWdlLlNjcmlwdCA9IGF3YWl0IGpzLnRleHQoKTsKCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBzY3JpcHQgaXMiICsgKGpzID8gJycgOiAnIG5vdCcpICsgIiByZXRyaWV2ZWQiKTsKCQkJdGhpcy5zdGVwKCk7CgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgoJCWlmIChwYWdlLlNjcmlwdCkgewoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9IGVsc2UgaWYgKHR5cGVvZih2dWUpICE9PSAndW5kZWZpbmVkJykgewoJCQkvL3RyeSB7CgkJCWN1c3RvbUVsZW1lbnRzLmRlZmluZShwYWdlLl9jb2RlLCBwYWdlLlNjcmlwdCA9IHZ1ZS5kZWZpbmVDdXN0b21FbGVtZW50KHsKCQkJCS8vIG5vcm1hbCBWdWUgY29tcG9uZW50IG9wdGlvbnMgaGVyZQoJCQkJcHJvcHM6IHBhZ2UuZGF0YSwKCQkJCWVtaXRzOiB7fSwKCQkJCXRlbXBsYXRlOiBwYWdlLkJvZHksCgoJCQkJLy8gZGVmaW5lQ3VzdG9tRWxlbWVudCBvbmx5OiBDU1MgdG8gYmUgaW5qZWN0ZWQgaW50byBzaGFkb3cgcm9vdAoJCQkJc3R5bGVzOiBbYC8qIGlubGluZWQgY3NzICovYF0KCQkJfSkpOwoJCQkvKn0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3JlbmRlcigpIFZ1ZSBFeGNlcHRpb246ICIgKyBwYWdlLl9jb2RlICsgIjogIiArIGV4LCBleCk7CgkJCX0qLwoJCX0KCgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpKT8uU2NyaXB0OwoJCX0gZWxzZSBpZiAoIXRoaXMuYXBpU2VydmVyIHx8ICF0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKSkgewoJCQkvL2NvbnNvbGUubG9nKCJfZ2V0U3RvcmVkU2NyaXB0KCk6IG5vIGFwaVNlcnZlciwgcnVubmluZyBpbiBzY29wZSAiLCB0aGlzLl9fc2NvcGUoKSk7CgkJCWxldCBfcyA9IGF3YWl0IGZldGNoKGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbj9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQkJaWYgKF9zLm9rKSBzY3JpcHQgPSBhdG9iKChhd2FpdCBfcy5qc29uKCkpLnNjcmlwdCk7CgkJfSBlbHNlIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRHIuIEZhZGkgTmFtbW91cid9LCBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5AZW5kdW1sYCkuc3BsaXQoJ0BlbmR1bWwnKS5tYXAoYiA9PiBgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazsgaGVpZ2h0OiAxMDAlJyBzcmM9J2h0dHBzOi8vd3d3LnBsYW50dW1sLmNvbS9wbGFudHVtbC9wbmcvJHt0aGlzLnpvcChiKydAZW5kdW1sJyl9Jy8+YCkuam9pbignPGJyLz4nKTsKCgkJCXRoaXMucHJ2RnVuYygkKGA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBvdmVyZmxvdy15OiBzY3JvbGw7Ij4ke2h0bWx9PC9kaXY+YCkpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJem9wKHMpIHsKCQkJcyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzKSk7CgkJCXZhciBhcnIgPSBbXTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSBhcnIucHVzaChzLmNoYXJDb2RlQXQoaSkpOwoJCQlsZXQgeiA9IG5ldyBab3BmbGkuUmF3RGVmbGF0ZShhcnIpLmNvbXByZXNzKCk7CgkJCXJldHVybiB0aGlzLmVuY29kZTY0Xyh6KTsKCQl9CgoJCWVuY29kZTY0XyhkYXRhKSB7CgkJCWxldCByID0gIiI7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMykgewoJCQkJaWYgKGkgKyAyID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgMCk7CgkJCQl9IGVsc2UgaWYgKGkgKyAxID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCAwLCAwKTsKCQkJCX0gZWxzZSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgZGF0YVtpICsgMl0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiByOwoJCX0KCgkJYXBwZW5kM2J5dGVzKGIxLCBiMiwgYjMpIHsKCQkJbGV0IGMxID0gYjEgPj4gMjsKCQkJbGV0IGMyID0gKChiMSAmIDB4MykgMDE5NWJmYjUyODViNzM0ZWJmNzgwNWFlMDU4ZDk3ZmYgNCk7CgkJCWxldCBjMyA9ICgoYjIgJiAweEYpIDAxOTViZmI1Mjg1YjczNGViZjc4MGE0YzU3NTA4Mjk2IDYpOwoJCQlsZXQgYzQgPSBiMyAmIDB4M0Y7CgkJCWxldCByID0gIiI7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMxICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMyICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMzICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGM0ICYgMHgzRik7CgkJCXJldHVybiByOwoJCX0KCgkJZW5jb2RlNmJpdChiKSB7CgkJCWlmIChiIDwgMTApIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDQ4ICsgYik7CgkJCX0KCQkJYiAtPSAxMDsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiID09IDApIHsKCQkJCXJldHVybiAnLSc7CgkJCX0KCQkJaWYgKGIgPT0gMSkgewoJCQkJcmV0dXJuICdfJzsKCQkJfQoJCQlyZXR1cm4gJz8nOwoJCX0KCX07CgoJdG9CYXNlNjQodXJsLCBkYXRhLCBtaW1lID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsIGJSYXcpIHsKCQlyZXR1cm4gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3VybCA/IHRoaXMuX2luamVjdCgkLmFqYXgoewoJCQl1cmw6IHVybCArICc/JyArIE1hdGgucmFuZG9tKCksCgkJCWFzeW5jOiBmYWxzZQoJCX0pLnJlc3BvbnNlVGV4dCwgZGF0YSkgOiAoYlJhdyA/IGRhdGEgOiBKU09OLnN0cmluZ2lmeShkYXRhKSldLCB7CgkJCXR5cGU6IG1pbWUKCQl9KSk7Cgl9CgoJX3N2Z0Jhc2U2NCh0eHQpIHsKCQl0cnkgewoJCQltZXJtYWlkLm1lcm1haWRBUEkuaW5pdGlhbGl6ZSh7CgkJCQkidGhlbWUiOiAiZGVmYXVsdCIsCgkJCQkic2VjdXJpdHlMZXZlbCI6ICJsb29zZSIsCgkJCQkibWF4VGV4dFNpemUiOiA5MDAwMDAwMCwKCQkJfSk7CgoJCQlyZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsJyArIHRoaXMuX2J0b2EobmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZygkKG1lcm1haWQubWVybWFpZEFQSS5yZW5kZXIoJ2dyYXBoRGl2JywgdHh0KSlbMF0pKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gdHh0OwoJCX0KCX0KCglfcHJ1bmUob2JqKSB7CgkJaWYgKHR5cGVvZihvYmopID09PSAidW5kZWZpbmVkIiB8fCBvYmogPT09IG51bGwpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gIm9iamVjdCIpIHJldHVybiBvYmo7CgkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewoJCQlsZXQgcmV0ID0gb2JqLm1hcCh2ID0+IHRoaXMuX3BydW5lKHYpKS5maWx0ZXIodiA9PiB2KTsKCQkJcmV0dXJuIHJldC5sZW5ndGggPyByZXQgOiBudWxsOwoJCX0KCgkJbGV0IHJldCA9IE9iamVjdC5hc3NpZ24oe30sIC4uLk9iamVjdC5lbnRyaWVzKG9iaikubWFwKChba2V5LCB2YWx1ZV0pID0+IHZhbHVlID8gKHsKCQkJW2tleV06IHRoaXMuX3BydW5lKHZhbHVlKQoJCX0pIDogbnVsbCkpOwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLmxlbmd0aCA/IHJldCA6IG51bGw7Cgl9CgoJdmFsaWRVUkwoc3RyKSB7CgkJdmFyIHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeKGh0dHBzPzpcXC9cXC8pPycgKyAvLyBwcm90b2NvbAoJCQknKCgoW2EtelxcZF0oW2EtelxcZC1dKlthLXpcXGRdKSopXFwuKStbYS16XXsyLH18JyArIC8vIGRvbWFpbiBuYW1lCgkJCScoKFxcZHsxLDN9XFwuKXszfVxcZHsxLDN9KSknICsgLy8gT1IgaXAgKHY0KSBhZGRyZXNzCgkJCScoXFw6XFxkKyk/KFxcL1stYS16XFxkJV8ufitdKikqJyArIC8vIHBvcnQgYW5kIHBhdGgKCQkJJyhcXD9bOyZhLXpcXGQlXy5+Kz0tXSopPycgKyAvLyBxdWVyeSBzdHJpbmcKCQkJJyhcXCNbLWEtelxcZF9dKik/JCcsICdpJyk7IC8vIGZyYWdtZW50IGxvY2F0b3IKCQlyZXR1cm4gISFwYXR0ZXJuLnRlc3Qoc3RyKTsKCX0KCglfdG9KUyhvKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihvKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiAndW5kZWZpbmVkJzsKCgkJCXJldHVybiBgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoXGAke3RoaXMuX2J0b2EoSlNPTi5zdHJpbmdpZnkobywgKHQsbik9PiJmdW5jdGlvbiI9PT10eXBlb2Ygbj9uLnRvU3RyaW5nKCk6bikpfVxgKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KWA7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl90b0pTOiAiICsgZXgudG9TdHJpbmcoKSk7CgkJfQoJfQoKCV9hdG9iKGEpIHsKCQlyZXR1cm4gdHlwZW9mKGF0b2IpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGEsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JykgOiBhdG9iKGEpOwoJfQoKCV9idG9hKGIpIHsKCQlyZXR1cm4gdHlwZW9mKGJ0b2EpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGIpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGIpKSk7Cgl9CgoJX2F0dHIoZWEpIHsKCQl0cnkgewoJCQlpZiAoZWEuRW50aXR5VHlwZSkgcmV0dXJuICJFbnRpdHkiOwoJCQlyZXR1cm4gT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+ICFrLmluZGV4T2YoIklzIikgJiYgayAhPT0gIklzVW5pcXVlIikuZmluZChrID0+IGVhW2tdKS5yZXBsYWNlKCdJcycsICcnKTsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3NxbFR5cGUoZWEsIGRiVHlwZSkgewoJCWxldCB0eXBlID0gdHlwZW9mKGVhKSA9PT0gInN0cmluZyIgPyBlYSA6IHRoaXMuX2F0dHIoZWEpOwoJCXN3aXRjaCAodHlwZSkgewoJCQljYXNlICJTdHJpbmciOgoJCQljYXNlICcnOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJUZXh0IjoKCQkJY2FzZSAiT2JqZWN0IjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdzcWxpdGUnPydWQVJDSEFSJzonVEVYVCd9JHtkYlR5cGU9PSdwb3N0Z3Jlcyc/Jyc6Jyg0MDAwKSd9YDsKCQkJY2FzZSAiQm9vbCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCSVQoMSknOidUSU5ZSU5UJ31gOyAvL0JJVAoJCQljYXNlICJEYXRlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J1RJTUVTVEFNUCc6J0RBVEVUSU1FJ31gOwoJCQljYXNlICJJbnQiOgoJCQkJcmV0dXJuICJJTlRFR0VSIjsKCQkJY2FzZSAiTG9uZyI6CgkJCQlyZXR1cm4gIkJJR0lOVCI7CgkJCWNhc2UgIkVudGl0eSI6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIkltYWdlIjoKCQkJY2FzZSAiRmlsZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydCWVRFQSc6IkJMT0IifWA7CgkJCWRlZmF1bHQ6CgkJCQlyZXR1cm4gdHlwZSArICIoNDApIjsKCQl9Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgYkFzeW5jKSB7CgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgbW9kdWxlKSB7CgkJCQlhd2FpdCB0aGlzLmltcG9ydChtLCBiQXN5bmMpOwoJCQl9CgkJCXJldHVybjsKCQl9CgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCXZhciBqcyA9IG51bGw7CgkJdHJ5IHsKCQkJanMgPSAoYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBtb2R1bGUKCQkJfSkpIHx8IChhd2FpdCAkLmFqYXgoewoJCQkJdXJsOiB0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIG1vZHVsZSArICIuanMiKSwKCQkJCWRhdGFUeXBlOiAidGV4dCIsCgkJCX0pKTsKCQl9IGNhdGNoIChleCkge30KCQlpZiAoIWpzKSB7CgkJCWpzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IG1vZHVsZS5pbmRleE9mKCcvJykgPj0gMCA/IG1vZHVsZSA6IChDTVNfUk9PVCArIG1vZHVsZSkKCQkJfSk7CgkJCWlmIChqcykganMgPSBqcy5TY3JpcHQ7CgkJfQoJCWlmICghanMpIHJldHVybiBudWxsOwoJCXJldHVybiBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcywgYkFzeW5jKTsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKCFqc0V4dCAmJiAhbi5sb2FkKSByZXQgPSBhd2FpdCByZXMudGV4dCgpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246IiwgZXgsIHMpOwoJCQkJfQoJCQl9CgoJCQlpZiAobi5sb2FkKSB7CgkJCQl0cnkgewoJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06IGNhbGxpbmcgbG9hZCgpIik7CgkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIG1vZHVsZXMsIGV4KTsKCQkJCX0KCQkJfQoJCX0KCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBwb3N0SW5pdCgpIHsKCQl0cnkgewoJCQl3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyID8gd2luZG93LmZyYW1lc1swXS5yZVJlbmRlcigpIDogbnVsbDsKCQl9IGNhdGNoIChleCkge30KCgkJdHJ5IHsKCQkJbGV0IGV2ZW50cyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRXZlbnRzIik7CgkJCWlmICghZXZlbnRzICYmIGNvbXBhbnkuRXZlbnRzKSB7CgkJCQlldmVudHMgPSBhd2FpdCBjb21wYW55LkV2ZW50cygpOwoJCQl9CgkJCShldmVudHMgfHwgW10pLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5mb3JFYWNoKGV2ID0+IHsKCQkJCSQoZXYuX3BhdGgsIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQpLm9uKGV2Ll9ldmVudCwgZXYuX2hhbmRsZXIpOwoJCQl9KTsKCQl9IGNhdGNoIChleCkge30KCX0KCglleGNlbFRvSlNPTihkYXRhLCBzdGFydCwgY291bnQpIHsKCQlpZiAodHlwZW9mKFhMU1gpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIFtdOwoJCXRyeSB7CgkJCXZhciB3b3JrYm9vayA9IFhMU1gucmVhZChkYXRhLCB7CgkJCQl0eXBlOiAnYmluYXJ5JywKCQkJCXNoZWV0Um93czogMCAvKnN0YXJ0ICsgIi0iICsgKHN0YXJ0ICsgY291bnQpKi8KCQkJfSk7CgkJCS8vdmFyIHJhbmdlID0gWExTWC51dGlscy5kZWNvZGVfcmFuZ2Uod29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dWychcmVmJ10pOwoJCQl2YXIgc2hlZXQgPSB3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV07CgkJCXJldHVybiBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLy90aHJvdyBlOwoJCQljb25zb2xlLmxvZygiRVJST1I6IiwgZSk7CgkJCXJldHVybiBbXTsKCQl9Cgl9CgoJYXN5bmMgX3VuemlwKGZpbGUpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJbGV0IGYgPSBhd2FpdCB6aXAubG9hZChmaWxlLCB7CgkJCWJhc2U2NDogdHJ1ZQoJCX0pCgl9CgoJYXN5bmMgX3ppcChmaWxlcykgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlmaWxlcy5mb3JFYWNoKGYgPT4gewoJCQl6aXAuZmlsZShmLm5hbWUsIGYuZmlsZSk7CgkJfSk7CgkJbGV0IHJldCA9IGF3YWl0IHppcC5nZW5lcmF0ZSh7CgkJCXR5cGU6ICdibG9iJywKCQkJY29tcHJlc3Npb246ICJERUZMQVRFIgoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJVXRmOEFycmF5VG9TdHIoYXJyYXkpIHsKCQl2YXIgb3V0LCBpLCBsZW4sIGM7CgkJdmFyIGNoYXIyLCBjaGFyMzsKCgkJb3V0ID0gIiI7CgkJbGVuID0gYXJyYXkubGVuZ3RoOwoJCWkgPSAwOwoJCXdoaWxlIChpIDwgbGVuKSB7CgkJCWMgPSBhcnJheVtpKytdOwoJCQlzd2l0Y2ggKGMgPj4gNCkgewoJCQkJY2FzZSAwOgoJCQkJY2FzZSAxOgoJCQkJY2FzZSAyOgoJCQkJY2FzZSAzOgoJCQkJY2FzZSA0OgoJCQkJY2FzZSA1OgoJCQkJY2FzZSA2OgoJCQkJY2FzZSA3OgoJCQkJCS8vIDB4eHh4eHh4CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDEyOgoJCQkJY2FzZSAxMzoKCQkJCQkvLyAxMTB4IHh4eHggICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgxRikgPDwgNikgfCAoY2hhcjIgJiAweDNGKSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDE0OgoJCQkJCS8vIDExMTAgeHh4eCAgMTB4eCB4eHh4ICAxMHh4IHh4eHgKCQkJCQljaGFyMiA9IGFycmF5W2krK107CgkJCQkJY2hhcjMgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MEYpIDw8IDEyKSB8CgkJCQkJCSgoY2hhcjIgJiAweDNGKSA8PCA2KSB8CgkJCQkJCSgoY2hhcjMgJiAweDNGKSA8PCAwKSk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBvdXQ7Cgl9CgoJYXN5bmMgX2NvbXByZXNzKHN0cikgewoJCWNvbnN0IGJ5dGVBcnJheSA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwoJCWNvbnN0IGNzID0gbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIik7CgkJY29uc3Qgd3JpdGVyID0gY3Mud3JpdGFibGUuZ2V0V3JpdGVyKCk7CgkJd3JpdGVyLndyaXRlKGJ5dGVBcnJheSk7CgkJd3JpdGVyLmNsb3NlKCk7CgkJcmV0dXJuIG5ldyBSZXNwb25zZShjcy5yZWFkYWJsZSkuYXJyYXlCdWZmZXIoKQoKCQkvLyBDb252ZXJ0IHRoZSBzdHJpbmcgdG8gYSBieXRlIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbc3RyXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJcmV0dXJuIGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7Cgl9CgoJYXN5bmMgX2RlY29tcHJlc3MoY29tcHJlc3NlZEJ5dGVzKSB7CgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW2NvbXByZXNzZWRCeXRlc10pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBkZWNvbXByZXNzZWQgc3RyZWFtLgoJCWNvbnN0IGRlY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IERlY29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgZGVjb21wcmVzc2VkU3RyZWFtKSB7CgkJCWNodW5rcy5wdXNoKGNodW5rKTsKCQl9CgkJY29uc3Qgc3RyaW5nQnl0ZXMgPSBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmluZy4KCQlyZXR1cm4gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKHN0cmluZ0J5dGVzKTsKCX0KCglhc3luYyBkb3dubG9hZFNSQ2FjaGUoY29kZSwgZmlsZW5hbWUpIHsKCQkvLyB0byBiZSBtb3ZlZCBvdXQgb2YgdGhpcyBjbGFzcwoJCWNvZGUgPSBjb2RlIHx8IGNvbXBhbnkuQ29kZTsKCQlsZXQgZmlsZXMgPSBhd2FpdCB0aGlzLnNyKCkuXygnQ29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZGFsbCcsIG51bGwsIHsKCQkJQ29kZTogY29kZSArICctJywKCQl9KTsKCQlyZXR1cm4gYXdhaXQgdGhpcy5femlwKGZpbGVzLm1hcChyID0+ICh7CgkJCW5hbWU6IHIuQ29kZS5yZXBsYWNlKGNvZGUgKyAnLScsICcnKSArICcuanMnLAoJCQlmaWxlOiByLlJlc3VsdAoJCX0pKSwgZmlsZW5hbWUgfHwgJ3NyQ2FjaGUuemlwJyk7Cgl9CgoJYXN5bmMgX2dldEJsb2NrKGJsb2NrKSB7CgkJdmFyIGpzID0gbnVsbDsKCQl2YXIgaHRtbCA9IG51bGw7CgkJdGhpcy5ibG9ja3NbYmxvY2tdID0gewoJCQlodG1sOiAiIiwKCQkJb2JqOiBudWxsLAoJCX0KCQl0cnkgewoJCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJCWxldCBwID0gYXdhaXQgdGhpcy5fZm9sZGVyVG9QYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgYmxvY2suaW5kZXhPZignLycpID49IDAgPyBibG9jayA6ICh0aGlzLmFwaVNlcnZlci5TY29wZSArICcvYmxvY2tzJyArIHRoaXMubSgpICsgIi8iICsgYmxvY2spKS5maW5kKCk7CgkJCQlpZiAocCkgewoJCQkJCWh0bWwgPSBwLmJvZHkoKSA/IHAuYm9keSgpIDogJyc7CgkJCQkJanMgPSBwLnNjcmlwdCgpID8gcC5zY3JpcHQoKSA6IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICghanMpIGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJCV9jb2RlOiBibG9jawoJCQl9LCAiYmxvY2tzIik7CgoJCQlpZiAoIWpzICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJibG9ja3MiICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jayArICIuanMiKSk7CgkJCQlqcyA9IGpzLm9rID8gKGF3YWl0IGpzLnRleHQoKSkgOiBudWxsOwoJCQl9CgoJCQlpZiAoanMpIHsKCQkJCWpzID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQoanMpOwoJCQkJaWYgKHR5cGVvZihqcykgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKGpzLmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBvYmogPSBuZXcganMoKTsKCQkJCQkJaWYgKG9iaiAmJiBvYmoubWFpbikgewoJCQkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nICIgKyBibG9jayArICIubWFpbigpIik7CgkJCQkJCQlhd2FpdCBvYmoubWFpbigpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9CgoJCWlmICghaHRtbCAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJCWh0bWwgPSBodG1sLm9rID8gKGF3YWl0IGh0bWwudGV4dCgpKSA6ICcnOwoJCX0KCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9IGh0bWw7CgoJCWlmIChqcyAmJiAhdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93W2Jsb2NrICsgIkNvbXBvbmVudCJdKSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gIjwiICsgYmxvY2sgKyAiQ29tcG9uZW50Lz4iOwoJCX0KCQl0aGlzLnN0ZXAoKTsKCQljb25zb2xlLmxvZyhibG9jayArICIgbG9hZGVkIik7CgkJcmV0dXJuIHRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sIHx8ICIiOwoJfQoKCWFzeW5jIF9sb2FkQ29udGVudCgpIHsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygibWFpbiIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJoZWFkZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiZm9vdGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImNvbnRlbnQiKTsKCQl0aGlzLmZyb21IYXNoKCk7CgoJCXdpbmRvdy5sYW5nID0gdGhpcy5oYXNoLmxhbmcgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55Lkxhbmd1YWdlIDogbnVsbCkgfHwgJ2VuJzsKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkdBQ29kZSkgewoJCQkvLyBnb29nbGUgYW5hbHl0aWNzCgkJCWNvbnNvbGUubG9nKCJpbmNsdWRpbmcgZ29vZ2xlIGFuYWx5dGljcyIpOwoJCQkoZnVuY3Rpb24oaSwgcywgbywgZywgciwgYSwgbSkgewoJCQkJaVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J10gPSByOwoJCQkJaVtyXSA9IGlbcl0gfHwgZnVuY3Rpb24oKSB7CgkJCQkJKGlbcl0ucSA9IGlbcl0ucSB8fCBbXSkucHVzaChhcmd1bWVudHMpOwoJCQkJfSwgaVtyXS5sID0gMSAqIG5ldyBEYXRlKCk7CgkJCQlhID0gcy5jcmVhdGVFbGVtZW50KG8pLAoJCQkJCW0gPSBzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdOwoJCQkJYS5hc3luYyA9IDE7CgkJCQlhLnNyYyA9IGc7CgkJCQltLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsIG0pOwoJCQl9KSh3aW5kb3csIGRvY3VtZW50LCAnc2NyaXB0JywgJ2h0dHBzOi8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsICdnYScpOwoJCQlnYSgnY3JlYXRlJywgY29tcGFueS5HQUNvZGUsICdhdXRvJyk7CgkJfQoJCXJldHVybiB0aGlzLlJlbmRlclBhZ2UoewoJCQlfY29kZTogKHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCcpCgkJfSk7Cgl9CgoJYXN5bmMgcHJlSW5pdCgpIHsKCQl3aW5kb3cuYkxvY2FsID0gbG9jYXRpb24uaHJlZi5pbmRleE9mKCcvbmFtbW91ci5jb20nKSA+IC0xICYmICF3aW5kb3cuZnJhbWVzLmxlbmd0aDsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J30/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiAhdG1wLmxhbmd1YWdlKSB7CgkJCXJldCA9IHJldC5yZXBsYWNlKC9eXHMqJCg/OlxyXG4/fFxuKS9nbSwgJycpOyAvLyByZW1vdmUgZW1wdHkgbGluZXMKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBpbml0RE9NKCkgewoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQl0aGlzLmhhc2gucGFnZSA9IHRoaXMuaGFzaC5wYWdlIHx8ICdpbmRleCc7CgoJCXRyeSB7CgkJCWF3YWl0ICgoY29tcGFueSAmJiBjb21wYW55Lk9uUGFnZUxvYWQpID8gY29tcGFueS5PblBhZ2VMb2FkIDogYXN5bmMgKCkgPT4ge30pKCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1ELmluaXRET00uT25QYWdlTG9hZCIsIGV4KTsKCQl9CgoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPCAwICYmICF3aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCWxldCB1cmwgPSAnd2Vic2l0ZS8nICsgdGhpcy5oYXNoLnBhZ2UgKyAnLicgKyAoY29tcGFueS5leHRlbnNpb24gfHwgJ2h0bScpICsgJz9yYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoKCQkJbGV0IGh0bWwgPSBhd2FpdCBmZXRjaCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuKSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKCk7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiZW5kKCkgd2l0aCBkYXRhIiwgZGF0YSk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQkvL29Db250ZW50LmhpZGUoKTsKCQkJLy9vQ29udGVudC5mYWRlSW4oMTAwMCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCQlFbnRpdHlPYmplY3Q6IChjLm9iaiA/IGMub2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJCX0pKTsKCQkJfQoJCX0pOwoJCXJldHVybiAkLndoZW4oLi4uYXJDYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCSQuZWFjaChyZXQsIChpLCByKSA9PiB7CgkJCQlpZiAociAmJiByLmxlbmd0aCAmJiByWzBdLk9yZGVyKSB7CgkJCQkJci5zb3J0KChhLCBiKSA9PiB7CgkJCQkJCWlmIChhLk9yZGVyIDwgYi5PcmRlcikgcmV0dXJuIC0xOwoJCQkJCQlpZiAoYS5PcmRlciA+IGIuT3JkZXIpIHJldHVybiAxOwoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmICh0aGlzLl9jYWxsc1tpXS5DYWxsYmFjaykgdGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2socik7CgkJCX0pOwoJCX0pLnRoZW4oKCkgPT4gewoJCQl0aGlzLl9jYWxscyA9IFtdOwoJCX0pOwoJfQoKCV9vKGZDYWxsQmFjaywgb2JqKSB7CgkJdGhpcy5zdGVwKCk7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldHVybiB0aGlzLnNyKCkuXygiZW1zRm9ybVZhbHVlcyIsIGZDYWxsQmFjaywgewoJCQlFbnRpdHlPYmplY3Q6ICgob2JqICYmIG9iai50b0VudGl0eU9iamVjdCkgPyBvYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCX0pOwoJfQoKCXJhbmRVUkwodXJsID0gJycpIHsKCQlyZXR1cm4gdXJsICsgIj9fX3JhbmQ9IiArIE1hdGgucmFuZG9tKCk7Cgl9CgoJdG9TZXR0aW5ncyhzLCBvKSB7CgkJcmV0dXJuIHM7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghc1tpXS5QYXJlbnQpIHt9CgkJfQoJfQoKCWV4dFR5cGUodikgewoJCXJldHVybiAoewoJCQlodG1sOiAnaHRtbCcsCgkJCWh0bTogJ2h0bWwnLAoJCQl4bWw6ICdodG1sJywKCQkJanM6ICdqYXZhc2NyaXB0JywKCQkJY3M6ICdjc2hhcnAnLAoJCQlweTogJ3B5dGhvbicsCgkJCWpzeDogJ2phdmFzY3JpcHQnLAoJCX0gW3YubWF0Y2goL1wuW14uXFwvOio/Ijw+fFxyXG5dKyQvKVswXS5yZXBsYWNlKCcuJywgJycpXSB8fCAidGV4dCIpOwoJfQoKCV9sb2FkaW5nKG9uID0gdHJ1ZSwgaW50ZXJ2YWwgPSAzMDAsIG1zZywgdGl0bGUpIHsKCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAob24pIHsKCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCXRpdGxlOiB0aXRsZSB8fCAnTG9hZGluZycsCgkJCQkJbXNnOiBtc2cgfHwgJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gKG9FbGVtZW50LmludGVydmFsIHx8IDYwMCkgOiA2MDAsICdTYXZpbmcgZGF0YS4uLicsICdQcm9ncmVzcycpOwoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlfRnJFTUQuX2xvYWRpbmcoZmFsc2UpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCV9mb2xkZXJUb1BhZ2UoZm9sZGVyKSB7CgkJbGV0IGZOYW1lID0gZm9sZGVyLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmb2xkZXIuc3BsaXQoJy8nKS5zbGljZSgxKS5yZWR1Y2UodiA9PiB2ICsgJ10nLCAnX19udWxsJykgKyAnLmpzb24nOwoJCWlmICghdGhpcy5hcGlTZXJ2ZXIpIHJldHVybiBmTmFtZTsKCgkJbGV0IHAgPSB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUoZk5hbWUpOwoJCXAuY29kZShwLmNvZGUoKSwgJz0nKTsKCQlyZXR1cm4gcDsKCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyKSB7CgkJCWNvbnNvbGUubG9nKCJfcmVuZGVyKCkgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuX2ZvbGRlclRvUGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBwLnNjcmlwdCgpIHx8ICcnLAoJCQkJQm9keTogcC5ib2R5KCkgfHwgJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihDTVNfUk9PVCkgPT09ICdzdHJpbmcnKSB7CgkJCXJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBwYWdlLl9jb2RlLmluZGV4T2YoJy8nKSA+PSAwID8gcGFnZS5fY29kZSA6IChDTVNfUk9PVCArIHBhZ2UuX2NvZGUpCgkJCX0pOwoJCX0KCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIENNUywgbG9va2luZyBpbiBFTVMiKTsKCQkJdmFyIGVvUGFnZSA9IG51bGw7CgkJCXRyeSB7CgkJCQllb1BhZ2UgPSBuZXcgUGFnZSgpLmNvZGUocGFnZS5fY29kZSwgIj0iKTsKCQkJCWlmIChlb1BhZ2UubGFuZ3VhZ2UpIGVvUGFnZS5sYW5ndWFnZSh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIsICI9Iik7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWNvbnNvbGUubG9nKCJFTVMgZG9lcyBub3QgaGF2ZSBhIFBhZ2UgY2xhc3MsIGZhaWxpbmcgb24gcHVycG9zZTogIiArIGUubWVzc2FnZSk7CgkJCX0KCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXQgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRm9ybVZhbHVlcyIsIG51bGwsIHsKCQkJCUVudGl0eU9iamVjdDogKGVvUGFnZSA/IGVvUGFnZS50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCX0pOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBFTVMsIHRyeWluZyB0ZW1wbGF0ZXMiKTsKCQkJCXBhZ2UgPSByZXRbMF07CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIEVNUywgc28gZ29pbmcgbG9jYWwiKTsKCQkJfQoKCQkJbGV0IGh0bWwgPSBudWxsOwoJCQl0cnkgewoJCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuaHRtIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKGh0bWwgJiYgIWh0bWwuc3RhdHVzKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaHRtbCB0ZW1wbGF0ZSBmb3VuZCIsIGh0bWwpOwoJCQkJcGFnZS5Cb2R5ID0gaHRtbDsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBoYXMgbm8gaHRtbCB0ZW1wbGF0ZSIpOwoJCQkJaWYgKCFwYWdlLkJvZHkgJiYgdHlwZW9mKFJlYWN0KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKE1haW5Db21wb25lbnQpID09PSAidW5kZWZpbmVkIikgewoJCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJCX0gZWxzZSB7CgkJCQkJcGFnZS5Cb2R5ID0gcGFnZS5fY29udGVudCB8fCAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJCX0KCQkJfQoKCQkJbGV0IGpzID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHBhZ2UpOwoJCQlpZiAoIWpzKSB0cnkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmpzIikpOwoJCQl9IGNhdGNoIChleCkge30KCQkJaWYgKCFqcyB8fCAhanMub2spIGpzID0gbnVsbDsKCQkJaWYgKGpzICYmIGpzLm9rKSBwYWdlLlNjcmlwdCA9IGF3YWl0IGpzLnRleHQoKTsKCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBzY3JpcHQgaXMiICsgKGpzID8gJycgOiAnIG5vdCcpICsgIiByZXRyaWV2ZWQiKTsKCQkJdGhpcy5zdGVwKCk7CgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgoJCWlmIChwYWdlLlNjcmlwdCkgewoJCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9IGVsc2UgaWYgKHR5cGVvZih2dWUpICE9PSAndW5kZWZpbmVkJykgewoJCQkvL3RyeSB7CgkJCWN1c3RvbUVsZW1lbnRzLmRlZmluZShwYWdlLl9jb2RlLCBwYWdlLlNjcmlwdCA9IHZ1ZS5kZWZpbmVDdXN0b21FbGVtZW50KHsKCQkJCS8vIG5vcm1hbCBWdWUgY29tcG9uZW50IG9wdGlvbnMgaGVyZQoJCQkJcHJvcHM6IHBhZ2UuZGF0YSwKCQkJCWVtaXRzOiB7fSwKCQkJCXRlbXBsYXRlOiBwYWdlLkJvZHksCgoJCQkJLy8gZGVmaW5lQ3VzdG9tRWxlbWVudCBvbmx5OiBDU1MgdG8gYmUgaW5qZWN0ZWQgaW50byBzaGFkb3cgcm9vdAoJCQkJc3R5bGVzOiBbYC8qIGlubGluZWQgY3NzICovYF0KCQkJfSkpOwoJCQkvKn0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3JlbmRlcigpIFZ1ZSBFeGNlcHRpb246ICIgKyBwYWdlLl9jb2RlICsgIjogIiArIGV4LCBleCk7CgkJCX0qLwoJCX0KCgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195bfb5285b734ebf7805ae058d97ff",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "0195bfb5285b734ebf780a4c57508296",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
{
	"Id": "4a0ebc29803cb395bf84a1f844d5ba818c542d9a",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXRTdG9yZWRTY3JpcHQocywgYk5vUnVuKSB7CgkJbGV0IHNjcmlwdCA9ICcnOwoJCWlmICh0aGlzLnNyKCkuXykgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlcikgewoJCQlsZXQgX3MgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9hcnpob3NwaXRhbC5naXRodWIuaW8vY29tL25hbW1vdXIvY21zL1N0b3JlZFNjcmlwdC8ke3MuTmFtZSB8fCBzLm5hbWV9Lmpzb24/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJCWlmIChfcy5vaykgc2NyaXB0ID0gYXRvYigoYXdhaXQgX3MuanNvbigpKS5zY3JpcHQpOwoJCX0KCgkJaWYgKHNjcmlwdCkgewoJCQlyZXR1cm4gKGJOb1J1biA/IHNjcmlwdCA6IGF3YWl0IHRoaXMucnVuU2NyaXB0KHNjcmlwdCkpOwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJubyBzdG9yZWQgc2NyaXB0IGxvYWRlciB0byB1c2UiLCBzKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCWFzeW5jIF9pbml0Q29udGVudE1hbmFnZXIoKSB7CgkJbGV0IGFyQ2xhc3NlcyA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCU5hbWU6ICJDb250ZW50IE1hbmFnZXIiLAoJCQlFbmFibGVkOiB0cnVlLAoJCX0pOwoJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGFyQ2xhc3NlcywgImNvbnRlbnRtYW5hZ2VyIik7Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLnNyKCkuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gc2NvcGUgfHwgY29tcGFueS5TY29wZTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuSWQgPyB0bXAgOiAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1BhZ2VUZW1wbGF0ZUZpbmQiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJVHlwZTogewoJCQkJTmFtZTogIkVudGl0eVRlbXBsYXRlIgoJCQl9LAoJCQlOYW1lOiB0bXAuTmFtZSB8fCB0bXAubmFtZSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0KTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0ZW1wbGF0ZVtmXS5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGVtcGxhdGVbZl0gPSB0ZW1wbGF0ZVtmXS5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGVtcGxhdGVbZl0sIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSB3aW5kb3dbc2NvcGVdOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoJCQl0aGlzLnBydkZ1bmMgPSBwcnZGdW5jIHx8ICgoKSA9PiB7fSk7CgkJCXRoaXMubVJhbmsgPSAwOwoKCQkJaWYgKGJSYW5rKSB0aGlzLm1SYW5rID0gTWF0aC5tYXgoMCwgLi4udGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiBjLlJhbmspKTsgLy8gdXNlZnVsIGluIHRlbXBsYXRlcwoKCQkJdGhpcy5tYWluVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuc3BsaXQoJy0nKVswXTsKCQkJdGhpcy5zdWJUaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5pbmRleE9mKCctJykgPj0gMCA/IGRhdGEuVGl0bGUuc3BsaXQoJy0nKVsxXSA6ICIiOwoJCX0KCgkJX25ldyhjLCB0b29sLCBpZCkgewoJCQlpZiAoIWMpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKTsKCQkJaWYgKHR5cGVvZihjKSA9PT0gJ3N0cmluZycpIGMgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBjKTsKCQkJaWYgKCFjKSByZXR1cm4gbnVsbDsKCgkJCWxldCBtU2NvcGUgPSBjLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKGMuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXJldHVybiBuZXcobVNjb3BlW25OYW1lKGMpXSkoaWQsIHRvb2wpOwoJCX0KCgkJY25mKF9jLCBpZCwgZGlkLCB0b29sKSB7CgkJCV9jID0gX2MgfHwgdGhpcy5tYzsKCQkJbGV0IG1TY29wZSA9IF9jLkVudGl0eU1vZHVsZSA/IERvdE9iamVjdC5waWNrKF9jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXJldHVybiBtU2NvcGUuX25vZGUgPyBtU2NvcGUuX25vZGUuX19jb25maWcoaWQsIGRpZCwgewoJCQkJdG9vbDogdG9vbAoJCQl9KSA6ICh0aGlzLl9uZXcoX2MsIHRvb2wpLl9fY29uZmlnKGlkLCBkaWQsIHRvb2wgPyB7CgkJCQl0b29sOiB0b29sCgkJCX0gOiB1bmRlZmluZWQpKTsKCQl9CgoJCW5UeXBlKGVhKSB7CgkJCWlmIChlYS5Jc1N0cmluZyB8fCBlYS5Jc1RleHQpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Jvb2wpIHsKCQkJCXJldHVybiAiYm9vbGVhbiI7CgkJCX0gZWxzZSBpZiAoZWEuSXNGbG9hdCkgewoJCQkJcmV0dXJuICJmbG9hdCI7CgkJCX0gZWxzZSBpZiAoZWEuSXNJbnQgfHwgZWEuSXNMb25nKSB7CgkJCQlyZXR1cm4gIm51bWJlciI7CgkJCX0gZWxzZSBpZiAoZWEuSXNEYXRlKSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCX0KCgkJX3QocHJvcCwgb2JqLCBzZWFyY2gpIHsKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBvYmpbcHJvcF07CgoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl90IiwgZXgpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0U1ZHKHJldCkgewoJCQl0aGlzLnBydkZ1bmMoJChgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnIHNyYz0nJHtfRnJFTUQuX3N2Z0Jhc2U2NChyZXQuQm9keSl9Jy8+YCkpOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0ZhZGkgTmFtbW91cid9LCBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5AZW5kdW1sYCkuc3BsaXQoJ0BlbmR1bWwnKS5tYXAoYiA9PiBgPGltZyBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazsgaGVpZ2h0OiAxMDAlJyBzcmM9J2h0dHBzOi8vd3d3LnBsYW50dW1sLmNvbS9wbGFudHVtbC9wbmcvJHt0aGlzLnpvcChiKydAZW5kdW1sJyl9Jy8+YCkuam9pbignPGJyLz4nKTsKCgkJCXRoaXMucHJ2RnVuYygkKGA8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBvdmVyZmxvdy15OiBzY3JvbGw7Ij4ke2h0bWx9PC9kaXY+YCkpOwoJCX0KCgkJX2F0dHIoZWEpIHsKCQkJcmV0dXJuIGVhLkVudGl0eVR5cGUgPyBlYS5FbnRpdHlUeXBlLk5hbWUgOiBfRnJFTUQuX2F0dHIoZWEpOwoJCX0KCgkJem9wKHMpIHsKCQkJcyA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzKSk7CgkJCXZhciBhcnIgPSBbXTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSBhcnIucHVzaChzLmNoYXJDb2RlQXQoaSkpOwoJCQlsZXQgeiA9IG5ldyBab3BmbGkuUmF3RGVmbGF0ZShhcnIpLmNvbXByZXNzKCk7CgkJCXJldHVybiB0aGlzLmVuY29kZTY0Xyh6KTsKCQl9CgoJCWVuY29kZTY0XyhkYXRhKSB7CgkJCWxldCByID0gIiI7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMykgewoJCQkJaWYgKGkgKyAyID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgMCk7CgkJCQl9IGVsc2UgaWYgKGkgKyAxID09IGRhdGEubGVuZ3RoKSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCAwLCAwKTsKCQkJCX0gZWxzZSB7CgkJCQkJciArPSB0aGlzLmFwcGVuZDNieXRlcyhkYXRhW2ldLCBkYXRhW2kgKyAxXSwgZGF0YVtpICsgMl0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiByOwoJCX0KCgkJYXBwZW5kM2J5dGVzKGIxLCBiMiwgYjMpIHsKCQkJbGV0IGMxID0gYjEgPj4gMjsKCQkJbGV0IGMyID0gKChiMSAmIDB4MykgPDwgNCkgfCAoYjIgPj4gNCk7CgkJCWxldCBjMyA9ICgoYjIgJiAweEYpIDw8IDIpIHwgKGIzID4+IDYpOwoJCQlsZXQgYzQgPSBiMyAmIDB4M0Y7CgkJCWxldCByID0gIiI7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMxICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMyICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGMzICYgMHgzRik7CgkJCXIgKz0gdGhpcy5lbmNvZGU2Yml0KGM0ICYgMHgzRik7CgkJCXJldHVybiByOwoJCX0KCgkJZW5jb2RlNmJpdChiKSB7CgkJCWlmIChiIDwgMTApIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDQ4ICsgYik7CgkJCX0KCQkJYiAtPSAxMDsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiID09IDApIHsKCQkJCXJldHVybiAnLSc7CgkJCX0KCQkJaWYgKGIgPT0gMSkgewoJCQkJcmV0dXJuICdfJzsKCQkJfQoJCQlyZXR1cm4gJz8nOwoJCX0KCX0KCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgX2hyZWZzLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgX2hyZWZzLCBsb2FkZXIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQlpZiAoYykgdGhpcy5fY3NzKGMpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbW9kdWxlcyA9IFtdOwoKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQpIHsKCQkJCXJldHVybiBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQobi5zY3JpcHQsIG4ubm9SdW4pOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgZmV0Y2gobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQkJaWYgKHJlcy5vaykgewoJCQkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChhd2FpdCByZXMudGV4dCgpKSk7CgkJCQkJCQkJaWYgKGpzRXh0KSByZXR1cm4gcmV0OwoJCQkJCQkJCWlmICghbi5sb2FkKSByZXR1cm4gYXdhaXQgcmVzLnRleHQoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5fYXRvYihwLmJvZHkoKSkgOiBudWxsOwoJCQkJCWpzID0gcC5zY3JpcHQoKSA/IHAuX2F0b2IocC5zY3JpcHQoKSkgOiBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWpzKSBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZSh7CgkJCQlfY29kZTogYmxvY2sKCQkJfSwgImJsb2NrcyIpIHx8IGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmpzIiksCgkJCQlkYXRhVHlwZTogInRleHQiLAoJCQl9KTsKCQkJaWYgKGpzKSB7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzKTsKCQkJCWlmICh0eXBlb2YoanMpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihqcy5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5vYmogPSBvYmo7CgkJCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoJCXRyeSB7CgkJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbCB8fCBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5odG0iKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgkJdGhpcy5zdGVwKCk7CgkJY29uc29sZS5sb2coYmxvY2sgKyAiIGxvYWRlZCIpOwoJCXJldHVybiB0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCB8fCAiIjsKCX0KCglhc3luYyBfbG9hZENvbnRlbnQoKSB7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soIm1haW4iKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiaGVhZGVyIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImZvb3RlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJjb250ZW50Iik7CgkJdGhpcy5mcm9tSGFzaCgpOwoKCQl3aW5kb3cubGFuZyA9IHRoaXMuaGFzaC5sYW5nIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5MYW5ndWFnZSA6IG51bGwpIHx8ICdlbic7CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5HQUNvZGUpIHsKCQkJLy8gZ29vZ2xlIGFuYWx5dGljcwoJCQljb25zb2xlLmxvZygiaW5jbHVkaW5nIGdvb2dsZSBhbmFseXRpY3MiKTsKCQkJKGZ1bmN0aW9uKGksIHMsIG8sIGcsIHIsIGEsIG0pIHsKCQkJCWlbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddID0gcjsKCQkJCWlbcl0gPSBpW3JdIHx8IGZ1bmN0aW9uKCkgewoJCQkJCShpW3JdLnEgPSBpW3JdLnEgfHwgW10pLnB1c2goYXJndW1lbnRzKTsKCQkJCX0sIGlbcl0ubCA9IDEgKiBuZXcgRGF0ZSgpOwoJCQkJYSA9IHMuY3JlYXRlRWxlbWVudChvKSwKCQkJCQltID0gcy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTsKCQkJCWEuYXN5bmMgPSAxOwoJCQkJYS5zcmMgPSBnOwoJCQkJbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCBtKTsKCQkJfSkod2luZG93LCBkb2N1bWVudCwgJ3NjcmlwdCcsICdodHRwczovL3d3dy5nb29nbGUtYW5hbHl0aWNzLmNvbS9hbmFseXRpY3MuanMnLCAnZ2EnKTsKCQkJZ2EoJ2NyZWF0ZScsIGNvbXBhbnkuR0FDb2RlLCAnYXV0bycpOwoJCX0KCQlyZXR1cm4gdGhpcy5SZW5kZXJQYWdlKHsKCQkJX2NvZGU6ICh0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnKQoJCX0pOwoJfQoKCWFzeW5jIHByZUluaXQoKSB7CgkJd2luZG93LmJMb2NhbCA9IGxvY2F0aW9uLmhyZWYuaW5kZXhPZignL25hbW1vdXIuY29tJykgPiAtMTsKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCJNb2R1bGVzIik7CgkJfSBlbHNlIHsKCQkJaWYgKHdpbmRvdy5iTG9jYWwpIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLmltcG9ydCgiLi4vLi4vIiArICh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCWF3YWl0IHRoaXMuUmVuZGVyUGFnZSh7CgkJCQkJCV9jb2RlOiB0aGlzLmhhc2gucGFnZQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiQ29tcGFueSIpOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWNvbXBhbnkuU2NvcGUgPSBjb21wYW55LlNjb3BlIHx8ICJ3aW5kb3ciOwoJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWUgKyAiOiBsb2FkaW5nLi4uIjsKCQl9CgoJCWF3YWl0IHRoaXMucmVxdWlyZSgiU2VydmljZVJvdXRlciIpOwoJCXRoaXMuX2luaXRTZXJ2aWNlUm91dGVyKCk7CgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoKTsKCQlhd2FpdCB0aGlzLl9pbml0Q29udGVudE1hbmFnZXIoKTsKCgkJYXdhaXQgdGhpcy5fbWFuaWZlc3QoKTsKCgkJbGV0IG9TY29wZSA9IHRoaXMuc3IoKS5fX3Njb3BlKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCk7IC8vd2luZG93W2NvbXBhbnkuU2NvcGVdOwoJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJbGV0IG1jID0gKG9TY29wZS5FbnRpdHlDbGFzc2VzIHx8IFtdKS5maW5kKGMgPT4gYy5Jc01haW4pOwoJCWlmIChtYykgewoJCQlhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQlpbml0U2VsZjogdHJ1ZSwKCQkJCWluaXROb2RlOiB0cnVlCgkJCX0pOwoJCX0KCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gc2NvcGUgfHwgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgPyBjb21wYW55LlNjb3BlIDogbnVsbCk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgZmV0Y2goYCR7dG1wLnBhdGh8fCgndGVtcGxhdGVzJyArIHRoaXMubSgpICsgJy8nKX0ke3RtcC50ZW1wbGF0ZX0uJHt0bXAuZXh0fHwnanN0J30/cmFuZD0ke01hdGgucmFuZG9tKCl9YCk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHdpbmRvd1tzY29wZV0sCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKCF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0ICQuZ2V0KHVybCk7CgkJCWh0bWwgPSB0aGlzLl9pbmplY3QoaHRtbCwgd2luZG93LnBhcmVudCk7CgoJCQljb25zdCBkb21wID0gbmV3IERPTVBhcnNlcigpOwoJCQlsZXQgZG9jID0gZG9tcC5wYXJzZUZyb21TdHJpbmcoaHRtbCwgInRleHQvaHRtbCIpOwoJCQlhd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKGRvYyk7CgkJCWNvbnNvbGUubG9nKCJodG1sIGJpbmRpbmcgZG9uZSEiKTsKCgkJCWh0bWwgPSBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTDsKCQkJLy9odG1sID0gJ3Rlc3QnOwoKCQkJLy93aW5kb3cuZnJhbWVzWzBdLmxvY2F0aW9uID0gdXJsOwoJCQl3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LndyaXRlKGh0bWwpOwoJCX0KCgkJYXdhaXQgdGhpcy5fYmluZEtPKCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCWFzeW5jIF9iaW5kS08oKSB7CgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA+PSAwKSB7CgkJCXNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewoJCQkJLy9hd2FpdCB0aGlzLl9hcHBseUJpbmRpbmdzKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIHRydWUpOwoKCQkJCWtvLmNsZWFuTm9kZSh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJa28uYXBwbHlCaW5kaW5ncyh3aW5kb3csIHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQl3aW5kb3cuZG9jdW1lbnQudGl0bGUgPSBjb21wYW55Lk5hbWU7CgkJCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQl9LCAzMDApOwoJCX0KCX0KCglfc2V0KG9iaiwgcGF0aCwgdmFsKSB7CgkJdmFyIHN0cmluZ1RvUGF0aCA9IGZ1bmN0aW9uKHBhdGgpIHsKCQkJLy8gSWYgdGhlIHBhdGggaXNuJ3QgYSBzdHJpbmcsIHJldHVybiBpdAoJCQlpZiAodHlwZW9mIHBhdGggIT09ICdzdHJpbmcnKSByZXR1cm4gcGF0aDsKCQkJLy8gQ3JlYXRlIG5ldyBhcnJheQoJCQl2YXIgb3V0cHV0ID0gW107CgkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggZG90IG5vdGF0aW9uCgkJCXBhdGguc3BsaXQoJy4nKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CgkJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGJyYWNrZXQgbm90YXRpb24KCQkJCWl0ZW0uc3BsaXQoL1xbKFtefV0rKVxdL2cpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCQkJLy8gUHVzaCB0byB0aGUgbmV3IGFycmF5CgkJCQkJaWYgKGtleS5sZW5ndGggPiAwKSB7CgkJCQkJCW91dHB1dC5wdXNoKGtleSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0pOwoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgkJLy8gQ29udmVydCB0aGUgcGF0aCB0byBhbiBhcnJheSBpZiBub3QgYWxyZWFkeQoJCXBhdGggPSBzdHJpbmdUb1BhdGgocGF0aCk7CgkJLy8gQ2FjaGUgdGhlIHBhdGggbGVuZ3RoIGFuZCBjdXJyZW50IHNwb3QgaW4gdGhlIG9iamVjdAoJCXZhciBsZW5ndGggPSBwYXRoLmxlbmd0aDsKCQl2YXIgY3VycmVudCA9IG9iajsKCQkvLyBMb29wIHRocm91Z2ggdGhlIHBhdGgKCQlwYXRoLmZvckVhY2goZnVuY3Rpb24oa2V5LCBpbmRleCkgewoJCQkvLyBDaGVjayBpZiB0aGUgYXNzaWduZWQga2V5IHNob3VsIGJlIGFuIGFycmF5CgkJCXZhciBpc0FycmF5ID0ga2V5LnNsaWNlKC0yKSA9PT0gJ1tdJzsKCQkJLy8gSWYgc28sIGdldCB0aGUgdHJ1ZSBrZXkgbmFtZSBieSByZW1vdmluZyB0aGUgdHJhaWxpbmcgW10KCQkJa2V5ID0gaXNBcnJheSA/IGtleS5zbGljZSgwLCAtMikgOiBrZXk7CgkJCS8vIElmIHRoZSBrZXkgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBpc24ndCwgY3JlYXRlIGFuIGFycmF5CgkJCWlmIChpc0FycmF5ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50W2tleV0pICE9PSAnW29iamVjdCBBcnJheV0nKSB7CgkJCQljdXJyZW50W2tleV0gPSBbXTsKCQkJfQoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxvb3AsIGFzc2lnbiB0aGUgdmFsdWUKCQkJaWYgKGluZGV4ID09PSBsZW5ndGggLSAxKSB7CgkJCQkvLyBJZiBpdCdzIGFuIGFycmF5LCBwdXNoIHRoZSB2YWx1ZQoJCQkJLy8gT3RoZXJ3aXNlLCBhc3NpZ24gaXQKCQkJCWlmIChpc0FycmF5KSB7CgkJCQkJY3VycmVudFtrZXldLnB1c2godmFsKTsKCQkJCX0gZWxzZSB7CgkJCQkJY3VycmVudFtrZXldID0gdmFsOwoJCQkJfQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJZWxzZSB7CgkJCQkvLyBJZiB0aGUga2V5IGRvZXNuJ3QgZXhpc3QsIGNyZWF0ZSBpdAoJCQkJaWYgKCFjdXJyZW50W2tleV0pIHsKCQkJCQljdXJyZW50W2tleV0gPSB7fTsKCQkJCX0KCQkJCS8vIFVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCQljdXJyZW50ID0gY3VycmVudFtrZXldOwoJCQl9CgkJfSk7Cgl9CgoJX3BhZ2VGaWx0ZXIoYikgewoJCWlmICghYi5fYWN0aXZlKSByZXR1cm4gZmFsc2U7CgkJbGV0IHBhZ2UgPSB0eXBlb2YoX0ZyRU1ELmhhc2gucGFnZSkgPT09ICd1bmRlZmluZWQnID8gJ2luZGV4JyA6IF9GckVNRC5oYXNoLnBhZ2U7CgkJaWYgKHR5cGVvZihiLl9wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGIuX3BhZ2UuX3VybCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gYi5fcGFnZS5fdXJsID09IHBhZ2U7Cgl9CgoJYXN5bmMgX2FwcGx5QmluZGluZ3MoZG9jID0gd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgYkFmdGVyID0gZmFsc2UpIHsKCQl0aGlzLmZyb21IYXNoKCk7CgkJaWYgKHRoaXMuaGFzaC5ub0JpbmRpbmcpIHJldHVybjsKCQlsZXQgYmluZGluZ3MgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkJpbmRpbmdzIik7CgkJaWYgKCFiaW5kaW5ncyAmJiBjb21wYW55LkJpbmRpbmdzKSB7CgkJCWJpbmRpbmdzID0gYXdhaXQgY29tcGFueS5CaW5kaW5ncygpOwoJCX0KCQliaW5kaW5ncyA9IGJpbmRpbmdzIHx8IFtdOwoKCQlzci5ncm91cEJ5KGJpbmRpbmdzLmZpbHRlcih0aGlzLl9wYWdlRmlsdGVyKS5maWx0ZXIoYiA9PiBiQWZ0ZXIgPyBiLl9hZnRlciA6ICFiLl9hZnRlciksICJfcGF0aCIpLmZvckVhY2gocGIgPT4gewoJCQl0cnkgewoJCQkJbGV0IGUgPSBkb2MuZXZhbHVhdGUocGIua2V5LCBkb2MsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7CgkJCQlsZXQgZF9iaW5kID0ge307CgkJCQlwYi52YWx1ZXMuZm9yRWFjaChiID0+IHsKCQkJCQl0aGlzLl9zZXQoZF9iaW5kLCBiLl9hdHRyaWJ1dGUsIGIuX2NvZGUpOwoJCQkJfSk7CgkJCQkkKGUpLmF0dHIoImRhdGEtYmluZCIsIEpTT04uc3RyaW5naWZ5KGRfYmluZCkucmVwbGFjZSgvIi9nLCAnJykpOwoJCQkJLy9jb25zb2xlLmxvZyhwYi5rZXksIGUpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2cocGIua2V5LCBleCk7CgkJCX0KCQl9KTsKCX0KCglhc3luYyBpbml0KCkgewoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCWF3YWl0IHRoaXMuX2xvYWRDb250ZW50KCk7CgkJYXdhaXQgdGhpcy5wb3N0SW5pdCgpOwoJfQoKCV91dWlkKGlkLCBsZW4pIHsKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoaWQpIHsKCQkJbGV0IGhjID0gTWF0aC5hYnMoTnVtYmVyKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnID8gc3IuaGFzaENvZGUoaWQpIDogaWQubGVuZ3RoKSk7CgkJCWxldCBocyA9IGggPT4gTnVtYmVyKFN0cmluZyhoKS5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpKTsKCQkJbGV0IHUgPSBocyhocyhoYykgKiBocyhoYykpLnRvU3RyaW5nKDE2KTsKCgkJCXJldCA9IHUgKyAnJyArIHUgKyAnJyArIHU7CgkJCWlmIChyZXQubGVuZ3RoID4gMzIpIHJldCA9IHJldC5zdWJzdHJpbmcoMCwgMzIpOwoJCX0KCgkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHYoKTsKCgkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpOwoKCQlyZXR1cm4gcmV0LnJlcGxhY2UoL1wtL2csICcnKTsKCX0KCglhc3luYyBfbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKSB7CgkJc2NvcGUgPSBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAid2luZG93IjsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXykgewoJCQlsZXQgbGNzID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0dlbmVyYXRlTGF5ZXJDbGFzcyIsIG51bGwsIGVjLmxpYnJhcnkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKGMuTGF5ZXJBdHRyaWJ1dGVzLCAoXywgbGEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogbGEuTmFtZSwKCQkJCVBsdXJhbDogbGEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IGxhLAoJCQkJSXNCb29sOiBsYS5OYXRpdmVUeXBlID09ICJib29sIiwKCQkJCUlzU3RyaW5nOiBsYS5OYXRpdmVUeXBlID09ICJzdHJpbmciLAoJCQkJSXNUZXh0OiBsYS5OYXRpdmVUeXBlID09ICJ0ZXh0IiwKCQkJCUlzTG9uZzogbGEuTmF0aXZlVHlwZSA9PSAibG9uZyIsCgkJCQlJc0Zsb2F0OiBsYS5OYXRpdmVUeXBlID09ICJmbG9hdCIsCgkJCQlJc0ludDogbGEuTmF0aXZlVHlwZSA9PSAiaW50ZWdlciIsCgkJCQlJc0RvdWJsZTogbGEuTmF0aXZlVHlwZSA9PSAiZG91YmxlIiwKCQkJCUlzRGF0ZTogbGEuTmF0aXZlVHlwZSA9PSAiZGF0ZXRpbWUiLAoJCQkJSXNGaWxlOiBsYS5OYXRpdmVUeXBlID09ICJmaWxlIiwKCQkJCUlzSW1hZ2U6IGxhLk5hdGl2ZVR5cGUgPT0gImltYWdlIiwKCQkJCUlzT2JqZWN0OiBsYS5OYXRpdmVUeXBlID09ICJvYmplY3QiLAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCQkkLmVhY2gobGNzLCAoXywgYykgPT4gJC5lYWNoKCQuZ3JlcChjLlJlbGF0aW9uQXR0cmlidXRlcywgcmEgPT4gIXJhLklzQXJyYXkpLCAoXywgcmEpID0+IGVhcy5wdXNoKHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQlJZDogdGhpcy5fdXVpZCgpLAoJCQkJTmFtZTogcmEuTmFtZSwKCQkJCVBsdXJhbDogcmEuTmFtZSArICJzIiwKCQkJCS8vTGF5ZXJBdHRyaWJ1dGU6IHJhLAoJCQkJSXNCb29sOiBmYWxzZSwKCQkJCUlzU3RyaW5nOiBmYWxzZSwKCQkJCUlzVGV4dDogZmFsc2UsCgkJCQlJc0xvbmc6IGZhbHNlLAoJCQkJSXNGbG9hdDogZmFsc2UsCgkJCQlJc0ludDogZmFsc2UsCgkJCQlJc0RvdWJsZTogZmFsc2UsCgkJCQlJc0RhdGU6IGZhbHNlLAoJCQkJSXNGaWxlOiBmYWxzZSwKCQkJCUlzSW1hZ2U6IGZhbHNlLAoJCQkJRW50aXR5VHlwZTogewoJCQkJCUlkOiBzci5oYXNoQ29kZShyYS5SZWxhdGlvbkNsYXNzLk5hbWUpLAoJCQkJCU5hbWU6IHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSwKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJfSBlbHNlIGlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuQ29kZSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8pIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJdHJ5IHsKCQkJCWVjID0gYXdhaXQgdGhpcy5yZXF1aXJlKCdTY2hlbWEnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQkJTmFtZTogY29tcGFueS5Db2RlLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCX0KCgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgKEFycmF5LmlzQXJyYXkoZWMpID8gZWMgOiBbXSkuZmlsdGVyKGMgPT4gIWMuTmFtZSAmJiBjLkVudGl0eU1vZHVsZSAmJiAhYy5FbnRpdHlNb2R1bGUuSWdub3JlKSkgewoJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCQl9CgoJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9jb3JyZWN0Q2xhc3NlcyhlYywgZWFzKSB8fCBbXTsKCgkJaWYgKHNjb3BlICE9PSAid2luZG93IikgewoJCQlpZiAodHlwZW9mKHdpbmRvd1tzY29wZV0pICE9PSAidW5kZWZpbmVkIikgewoJCQkJLy8gY2xlYW51cCB0aGUgb2xkIHNjb3BlCgkJCQlkZWxldGUgd2luZG93W3Njb3BlXTsKCQkJfQoJCQl3aW5kb3dbc2NvcGVdID0ge307CgkJfQoJCShzY29wZSA/IHdpbmRvd1tzY29wZV0gOiB3aW5kb3cpLkVudGl0eUNsYXNzZXMgPSByZXQ7CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQgPSAoc2NvcGUgPyB3aW5kb3dbc2NvcGVdIDogd2luZG93KS5fX3NjcmlwdCB8fCB7fTsKCQlpZiAodGhpcy5zcigpLnNlcnZlckRhdGUpKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuX19zY3JpcHQuRGF0ZSA9IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgkJKHNjb3BlID8gd2luZG93W3Njb3BlXSA6IHdpbmRvdykuRW50aXR5QXR0cmlidXRlcyA9IGVhczsKCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IHRoaXMuX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRFbnRpdHlDbGFzc2VzKCk6IEV4Y2VwdGlvbiIsIGV4KTsKCQkJLyphd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJTmFtZTogIkFQSVN5c3RlbSIsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQl9KTsqLwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCUVudGl0eUNsYXNzOiB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiBtTmFtZQoJCQkJfQoJCQl9CgkJfSk7CgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSkgewoJCWxldCBvU2NvcGUgPSB0aGlzLnNyKCkuX19zY29wZShzY29wZSk7CgoJCW9TY29wZS5uTmFtZSA9IG9TY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJb1Njb3BlLm5Db2RlID0gb1Njb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSB7CgkJCWxldCBzTmFtZSA9IG1bMF0ucmVwbGFjZSgiPCU9IiwgIiIpLnJlcGxhY2UoIiU+IiwgIiIpLnJlcGxhY2UoJy5qcycsICcnKTsKCgkJCWh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgYXdhaXQgdGhpcy5yZXF1aXJlKHNOYW1lKSk7CgoJCQkvKmxldCBjb2RlID0gYXdhaXQgJC5hamF4KHsKCQkJCXVybDogKHNyLmJMb2NhbCA/ICIvbmFtbW91ci5jb20vZW1zLyIgOiAiIikgKyAic2NyaXB0LyIgKyBtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKSArICI/cmFuZD0iICsgTWF0aC5yYW5kb20oKSwKCQkJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQkJfSk7CgkJCWh0bWwgPSBodG1sLnJlcGxhY2UobVswXSwgY29kZSk7Ki8KCQl9CgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICIiOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJYXJDbGFzc2VzOiByZXQsCgkJCQljOiBjLAoJCQkJc2NvcGU6IHNjb3BlLAoJCQkJbk5hbWU6IG9TY29wZS5uTmFtZSwKCQkJCW5Db2RlOiBvU2NvcGUubkNvZGUsCgkJCX0pICsgJ1xuJyArIG9TY29wZS5uTmFtZShjKTsKCgkJCWNvZGUgPSB0aGlzLl9iZWF1dGlmeShjb2RlLCAiamF2YXNjcmlwdCIpOwoKCQkJX2NvZGUgKz0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7b1Njb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke29TY29wZS5uTmFtZShjKX0gPSAke29TY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSBvU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbb1Njb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCQlpZiAoYy5Jc01haW4pIHsKCQkJCS8vYWxpYXMuR2VuZXJpY1NlcnZpY2VBUEkgPSBHZW5lcmljU2VydmljZUFQSTsKCQkJfQoJCX0KCgkJcmV0dXJuIF9jb2RlOwoJfQoKCXNyKCkgewoJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zcikgPyB3aW5kb3cuc3IgOiB0aGlzOwoJfQoKCV9fdGltZShuYW1lID0gImdsb2JhbCIpIHsKCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQl0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXMgfHwge307CgkJdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gdGhpcy5zcigpLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSB0aGlzLnNyKCkuX19zY29wZSgpLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCXRoaXMuc3IoKS5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfY2xvbmVGdW5jdGlvbihvLCBmLCBzY29wZSwgYykgewoJCWxldCBjb2RlID0gd2luZG93W29dW2ZdID8gd2luZG93W29dW2ZdLnRvU3RyaW5nKCkgOiBgICAgJHtmfSgpewoJCSAgICBjb25zb2xlLmxvZygnRXJyb3IgaW4gX0ZyRU1ELl9jbG9uZUZ1bmN0aW9uKCR7b30sICR7Zn0pOiBJbnZhbGlkIEZ1bmN0aW9uIE5hbWUnKTsKCSAgICB9YDsKCQlsZXQgcyA9IGNvZGUucmVwbGFjZSgnKScsICcpID0+ICcpOwoJCWlmIChzLmluZGV4T2YoJ2Z1bmN0aW9uJykgPT0gMCB8fCBzLmluZGV4T2YoJ2FzeW5jIGZ1bmN0aW9uJykgPT0gMCkgewoJCQlzID0gcy5yZXBsYWNlKCdmdW5jdGlvbicsICcgJyk7CgkJfSBlbHNlIHsKCQkJcyA9IHMucmVwbGFjZShmLCAnJyk7CgkJfQoKCQlpZiAoYy5Jc01haW4gJiYgIXdpbmRvd1tvXVtmXSkgewoJCQljb25zb2xlLmxvZygnRXJyb3IgaW4gX0ZyRU1ELl9jbG9uZUZ1bmN0aW9uKCk6IEludmFsaWQgRnVuY3Rpb24gTmFtZSAnICsgZik7CgkJfQoKCQlyZXR1cm4gYAogICAgJHtmfSguLi5wYXJhbXMpewogICAgICAgIGlmKHR5cGVvZih3aW5kb3cpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy4ke299KSE9PSJ1bmRlZmluZWQiKXsKICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy4ke299LiR7Zn0oLi4ucGFyYW1zKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgYCArIChjLklzTWFpbiA/IGByZXR1cm4gKCR7c30pKC4uLnBhcmFtcyk7YCA6IGByZXR1cm4gbmV3ICR7c2NvcGV9LiR7d2luZG93W3Njb3BlXS5FbnRpdHlDbGFzc2VzLmZpbmQoX2MgPT4gX2MuSXNNYWluKS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKX0oKS4ke2Z9KC4uLnBhcmFtcyk7YCkgKyBgCiAgICAgICAgfQoJfQpgOwoJfQoKCV9pbml0U2VydmljZVJvdXRlcigpIHsKCQlpZiAodHlwZW9mKFNlcnZpY2VSb3V0ZXIpID09PSAndW5kZWZpbmVkJykgewoJCQljb25zb2xlLmxvZygiRnJFTUQuX2luaXRTZXJ2aWNlUm91dGVyKCk6IFNlcnZpY2VSb3V0ZXIgbm90IGRlZmluZWQuIik7CgkJCXJldHVybjsKCQl9CgkJd2luZG93LnNyID0gbmV3IFNlcnZpY2VSb3V0ZXIoKTsKCgkJdGhpcy5zcigpLlN0b3JlID0gY29tcGFueS5TdG9yZTsKCQl0aGlzLnNyKCkuaW5pdChudWxsLCBjb21wYW55LmxpYnJhcnkgfHwgIkVudGVycHJpc2VNYW5hZ2VyIiwgdHJ1ZSwgdGhpcy5iRGVidWcpOwoJCWlmICh0eXBlb2Ygc3JVUkwgIT09ICd1bmRlZmluZWQnKSB0aGlzLnNyKCkuc3JVUkwgPSBzclVSTDsKCQl0aGlzLnNyKCkuZkxvYWRpbmdTdGFydCA9ICgpID0+IHsKCQkJaWYgKCQubW9iaWxlKSAkLm1vYmlsZS5sb2FkaW5nKCdzaG93Jyk7CgkJfTsKCQl0aGlzLnNyKCkuZkxvYWRpbmdFbmQgPSAoKSA9PiB7CgkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUubG9hZGluZygnaGlkZScpOwoJCX07Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlyZXR1cm4gdGhpcy5oYXNoOwoJfQoKCXRvSGFzaCgpIHsKCQl2YXIgcmV0ID0gIiMiOwoJCWZvciAodmFyIHAgaW4gdGhpcy5oYXNoKSB7CgkJCXJldCArPSBwICsgIj0iICsgdGhpcy5oYXNoW3BdOwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCXN0cmlwSFRNTChkaXJ0eVN0cmluZykgewoJCXJldHVybiBkaXJ0eVN0cmluZy5yZXBsYWNlKC88W14+XSo+L2csICIiKTsKCX0KCglFcXVhbHMoYSwgYikgewoJCS8vIG51bGwgYW5kIHVuZGVmaW5lZCBhcmUgdHJlYXRlZCBhcyB0aGUgc2FtZTogZXF1YWwKCQl2YXIgX2EgPSBhIHx8IG51bGw7CgkJdmFyIF9iID0gYiB8fCBudWxsOwoJCWlmIChfYSA9PT0gX2IpIHJldHVybiB0cnVlOwoJCWlmICghX2EgfHwgIV9iKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyBudWxsIGFuZCB0aGUgb3RoZXIgaXMgbm90CgkJLy8gaWYodHlwZW9mIGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBiID09PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgdW5kZWZpbmVkCgkJaWYgKChfYS50b0VudGl0eU9iamVjdCAmJiAhX2IudG9FbnRpdHlPYmplY3QpIHx8IChfYi50b0VudGl0eU9iamVjdCAmJiAhX2EudG9FbnRpdHlPYmplY3QpKSByZXR1cm4gZmFsc2U7IC8vIGJvdGggc2hvdWxkIGJlIGVpdGhlciBFTVMgb3Igbm9uIEVNUyBvYmplY3RzCgkJLy9jb25zb2xlLmxvZygiRXF1YWxzOiBhdCB0aGlzIHBvaW50OiBhPSIrX2ErIiwgYj0iK19iKTsKCQkvLyBzYWZlOiBib3RoIGVpdGhlciBFTVMgb3Igbm9uIEVNUwoJCWlmIChfYS50b0VudGl0eU9iamVjdCkgcmV0dXJuIF9hLkVxdWFscyhfYik7IC8vIEVNUyBidW5kZWxzIHRoZSBFcXVhbHMgZnVuY3Rpb25zCgkJaWYgKF9hLklkICYmIF9iLklkICYmIF9hLklkID09IF9iLklkKSByZXR1cm4gdHJ1ZTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgblBhcmVudCkgewoJCS8vIGZpbmQgdGhlIGNoaWxkcmVuIG9mIHRoZSBuUGFyZW50IG5vZGUKCQl2YXIgY2hpbGRyZW4gPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJdHJ5IHsKCQkJCWlmIChuUGFyZW50KSB7CgkJCQkJdHJ5IHsKCQkJCQkJLy9jb25zb2xlLmxvZygiTm9kZTogIiArIGFyTm9kZXNbaV0uX25hbWUgKyAiLCBQYXJlbnQ6ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgRXF1YWw6ICIgKyAoYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIldIQVQ/ICIgKyBuUGFyZW50Ll9uYW1lICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCQkJfQoJCQkJfQoJCQkJaWYgKGFyTm9kZXNbaV1bc1BhcmVudF0gPT0gblBhcmVudCB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XSAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCA9PSBuUGFyZW50LklkKSkgewoJCQkJCS8vaWYoblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIGNoaWxkIG9mICIgKyBuUGFyZW50Ll9uYW1lICsgIjogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCS8vaWYoIW5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCByb290IG5vZGUgOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoXSA9IGFyTm9kZXNbaV07CgkJCQl9CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCS8vY29uc29sZS5sb2coImk9IiArIGkgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCX0KCQlpZiAoblBhcmVudCkgblBhcmVudFtzQ2hpbGRyZW5dID0gY2hpbGRyZW47CgkJZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CgkJCS8vY29uc29sZS5sb2coIkJ1aWxkaW5nIHN1YnRyZWUiKTsKCQkJYnVpbGRUcmVlKGFyTm9kZXMsIHNQYXJlbnQsIHNDaGlsZHJlbiwgY2hpbGRyZW5baV0pOwoJCX0KCX0KCgltKCkgewoJCS8vcmV0dXJuICh0aGlzLmlzTW9iaWxlKCkgPyAiIiA6ICIvZCIpOwoJCXJldHVybiAiL2QiOwoJfQoKCWlzTW9iaWxlKCkgewoJCS8vcmV0dXJuIHRoaXMuc3IoKS5pc01vYmlsZTsKCQl0cnkgewoJCQlpZiAoY29tcGFueS5SZXNwb25zaXZlKSByZXR1cm4gZmFsc2U7CgkJfSBjYXRjaCAoZSkge30KCQl2YXIgY2hlY2sgPSBmYWxzZTsKCQkoKGEsIGIpID0+IHsKCQkJaWYgKC8oYW5kcm9pZHxiYlxkK3xtZWVnbykuK21vYmlsZXxhdmFudGdvfGJhZGFcL3xibGFja2JlcnJ5fGJsYXplcnxjb21wYWx8ZWxhaW5lfGZlbm5lY3xoaXB0b3B8aWVtb2JpbGV8aXAoaG9uZXxvZCl8aXJpc3xraW5kbGV8bGdlIHxtYWVtb3xtaWRwfG1tcHxtb2JpbGUuK2ZpcmVmb3h8bmV0ZnJvbnR8b3BlcmEgbShvYnxpbilpfHBhbG0oIG9zKT98cGhvbmV8cChpeGl8cmUpXC98cGx1Y2tlcnxwb2NrZXR8cHNwfHNlcmllcyg0fDYpMHxzeW1iaWFufHRyZW98dXBcLihicm93c2VyfGxpbmspfHZvZGFmb25lfHdhcHx3aW5kb3dzIGNlfHhkYXx4aWluby9pLnRlc3QoYSkgfHwgLzEyMDd8NjMxMHw2NTkwfDNnc298NHRocHw1MFsxLTZdaXw3NzBzfDgwMnN8YSB3YXxhYmFjfGFjKGVyfG9vfHNcLSl8YWkoa298cm4pfGFsKGF2fGNhfGNvKXxhbW9pfGFuKGV4fG55fHl3KXxhcHR1fGFyKGNofGdvKXxhcyh0ZXx1cyl8YXR0d3xhdShkaXxcLW18ciB8cyApfGF2YW58YmUoY2t8bGx8bnEpfGJpKGxifHJkKXxibChhY3xheil8YnIoZXx2KXd8YnVtYnxid1wtKG58dSl8YzU1XC98Y2FwaXxjY3dhfGNkbVwtfGNlbGx8Y2h0bXxjbGRjfGNtZFwtfGNvKG1wfG5kKXxjcmF3fGRhKGl0fGxsfG5nKXxkYnRlfGRjXC1zfGRldml8ZGljYXxkbW9ifGRvKGN8cClvfGRzKDEyfFwtZCl8ZWwoNDl8YWkpfGVtKGwyfHVsKXxlcihpY3xrMCl8ZXNsOHxleihbNC03XTB8b3N8d2F8emUpfGZldGN8Zmx5KFwtfF8pfGcxIHV8ZzU2MHxnZW5lfGdmXC01fGdcLW1vfGdvKFwud3xvZCl8Z3IoYWR8dW4pfGhhaWV8aGNpdHxoZFwtKG18cHx0KXxoZWlcLXxoaShwdHx0YSl8aHAoIGl8aXApfGhzXC1jfGh0KGMoXC18IHxffGF8Z3xwfHN8dCl8dHApfGh1KGF3fHRjKXxpXC0oMjB8Z298bWEpfGkyMzB8aWFjKCB8XC18XC8pfGlicm98aWRlYXxpZzAxfGlrb218aW0xa3xpbm5vfGlwYXF8aXJpc3xqYSh0fHYpYXxqYnJvfGplbXV8amlnc3xrZGRpfGtlaml8a2d0KCB8XC8pfGtsb258a3B0IHxrd2NcLXxreW8oY3xrKXxsZShub3x4aSl8bGcoIGd8XC8oa3xsfHUpfDUwfDU0fFwtW2Etd10pfGxpYnd8bHlueHxtMVwtd3xtM2dhfG01MFwvfG1hKHRlfHVpfHhvKXxtYygwMXwyMXxjYSl8bVwtY3J8bWUocmN8cmkpfG1pKG84fG9hfHRzKXxtbWVmfG1vKDAxfDAyfGJpfGRlfGRvfHQoXC18IHxvfHYpfHp6KXxtdCg1MHxwMXx2ICl8bXdicHxteXdhfG4xMFswLTJdfG4yMFsyLTNdfG4zMCgwfDIpfG41MCgwfDJ8NSl8bjcoMCgwfDEpfDEwKXxuZSgoY3xtKVwtfG9ufHRmfHdmfHdnfHd0KXxub2soNnxpKXxuenBofG8yaW18b3AodGl8d3YpfG9yYW58b3dnMXxwODAwfHBhbihhfGR8dCl8cGR4Z3xwZygxM3xcLShbMS04XXxjKSl8cGhpbHxwaXJlfHBsKGF5fHVjKXxwblwtMnxwbyhja3xydHxzZSl8cHJveHxwc2lvfHB0XC1nfHFhXC1hfHFjKDA3fDEyfDIxfDMyfDYwfFwtWzItN118aVwtKXxxdGVrfHIzODB8cjYwMHxyYWtzfHJpbTl8cm8odmV8em8pfHM1NVwvfHNhKGdlfG1hfG1tfG1zfG55fHZhKXxzYygwMXxoXC18b298cFwtKXxzZGtcL3xzZShjKFwtfDB8MSl8NDd8bWN8bmR8cmkpfHNnaFwtfHNoYXJ8c2llKFwtfG0pfHNrXC0wfHNsKDQ1fGlkKXxzbShhbHxhcnxiM3xpdHx0NSl8c28oZnR8bnkpfHNwKDAxfGhcLXx2XC18diApfHN5KDAxfG1iKXx0MigxOHw1MCl8dDYoMDB8MTB8MTgpfHRhKGd0fGxrKXx0Y2xcLXx0ZGdcLXx0ZWwoaXxtKXx0aW1cLXx0XC1tb3x0byhwbHxzaCl8dHMoNzB8bVwtfG0zfG01KXx0eFwtOXx1cChcLmJ8ZzF8c2kpfHV0c3R8djQwMHx2NzUwfHZlcml8dmkocmd8dGUpfHZrKDQwfDVbMC0zXXxcLXYpfHZtNDB8dm9kYXx2dWxjfHZ4KDUyfDUzfDYwfDYxfDcwfDgwfDgxfDgzfDg1fDk4KXx3M2MoXC18ICl8d2ViY3x3aGl0fHdpKGcgfG5jfG53KXx3bWxifHdvbnV8eDcwMHx5YXNcLXx5b3VyfHpldG98enRlXC0vaS50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgY2hlY2sgPSB0cnVlCgkJfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CgkJcmV0dXJuIGNoZWNrOwoJfQoKCV9lcnJvcihtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnZXJyb3InLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nRXJyb3InPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglfYWxlcnQobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ3N1Y2Nlc3MnLAoJCQkJdGltZW91dDogZGVsYXkKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gdGhlIGRlZmF1bHQKCQkJJCgiPGRpdiB0aXRsZT0nSW5mb3JtYXRpb24nPjxwPiIgKyBtc2cgKyAiPC9wPjwvZGl2PiIpLmRpYWxvZygpOwoJCX0KCX0KCglteVJlcGxhY2UocywgYXJGcm9tLCBhclRvKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhckZyb20ubGVuZ3RoOyBpKyspIHsKCQkJcyA9IHMucmVwbGFjZShuZXcgUmVnRXhwKGFyRnJvbVtpXSwgJ2cnKSwgYXJUb1tpXSk7CgkJfQoJCXJldHVybiBzOwoJfQoKCV9pbmplY3QoaHRtbCwgZGF0YSwgZW5naW5lKSB7CgkJaWYgKCFodG1sKSByZXR1cm4gaHRtbDsKCQlpZiAodHlwZW9mKGh0bWwpID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gJC5leHRlbmQoe30sIC4uLk9iamVjdC5rZXlzKGh0bWwpLm1hcChrID0+ICh7CgkJCQlba106IHRoaXMuX2luamVjdChodG1sW2tdLCBkYXRhKQoJCQl9KSkpOwoJCX0KCQlpZiAodHlwZW9mKGh0bWwpICE9PSAnc3RyaW5nJykgcmV0dXJuIGh0bWw7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNvbmF0YSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBqc29uYXRhKGh0bWwpLmV2YWx1YXRlKGRhdGEpOwoJCQkJfSBjYXRjaCAoX2V4KSB7fQoJCQl9CgoJCQlpZiAodHlwZW9mIEVKUyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0VKUycpKSB7CgkJCQlyZXR1cm4gbmV3IEVKUyh7CgkJCQkJdGV4dDogaHRtbAoJCQkJfSkucmVuZGVyKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBkb1QgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdkb1QnKSkgewoJCQkJcmV0dXJuIGRvVC50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgXy50ZW1wbGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ3VuZGVyc2NvcmUnKSkgewoJCQkJcmV0dXJuIF8udGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIE11c3RhY2hlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnTXVzdGFjaGUnKSkgewoJCQkJcmV0dXJuIE11c3RhY2hlLnJlbmRlcihodG1sLCBkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgSGFuZGxlYmFycyAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ0hhbmRsZWJhcnMnKSkgewoJCQkJcmV0dXJuIEhhbmRsZWJhcnMuY29tcGlsZShodG1sKS50ZW1wbGF0ZShkYXRhKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBodG1sOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9pbmplY3QgRXhjZXB0aW9uOiAiLCBleCwgZGF0YSAvKiwgaHRtbCovICk7CgkJCXJldHVybiBodG1sOwoJCX0KCX0KCglhc3luYyBlbmQoZkNhbGxCYWNrLCBkYXRhKSB7CgkJaWYgKHRoaXMuZW5kQ2FsbGVkKSByZXR1cm47CgkJdGhpcy5lbmRDYWxsZWQgPSB0cnVlOwoJCWlmICghZGF0YSkgZGF0YSA9IHdpbmRvdy5wYWdlLmRhdGEgfHwge307CgkJLy9kYXRhLnBhZ2VzID0gdGhpcy5hbGxEYXRhLnBhZ2VzOwoJCS8vZGF0YS5wYWdlID0gdGhpcy5hbGxEYXRhLnBhZ2U7CgkJYXdhaXQgdGhpcy5kb0NhbGxzKCk7CgkJaWYgKGZDYWxsQmFjaykgewoJCQlhd2FpdCBmQ2FsbEJhY2soKTsKCQl9CgkJLy9jb25zb2xlLmxvZygiZW5kKCkgd2l0aCBkYXRhIiwgZGF0YSk7CgkJdmFyIHNIVE1MID0gdGhpcy5faW5qZWN0KHRoaXMuYWxsSFRNTCwgZGF0YSk7CgkJdmFyIG9Db250ZW50ID0gJCgnYm9keScpOwoJCWlmICghdGhpcy5pc01vYmlsZSgpKSB7CgkJCW9Db250ZW50Lmh0bWwoc0hUTUwpOwoJCQkvL29Db250ZW50LmhpZGUoKTsKCQkJLy9vQ29udGVudC5mYWRlSW4oMTAwMCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglfYyhvYmosIGZDYWxsQmFjaywgc01ldGhvZCwgLi4uYXJSZXN0KSB7CgkJdGhpcy5fY2FsbHMuc3BsaWNlKDAsIDAsIHsKCQkJQ2FsbGJhY2s6IGZDYWxsQmFjaywKCQkJb2JqOiBvYmosCgkJCU5hbWU6IHNNZXRob2QsCgkJCWFyZ3M6IGFyUmVzdCwKCQl9KTsKCX0KCglhc3luYyBkb0NhbGxzKCkgewoJCXRoaXMuX2NhbGxzLnJldmVyc2UoKTsKCQl2YXIgYXJDYWxscyA9IFtdOwoJCSQuZWFjaCh0aGlzLl9jYWxscywgKF8sIGMpID0+IHsKCQkJaWYgKGMuTmFtZSkgewoJCQkJdmFyIGFyZ3MgPSBbYy5vYmpdOwoJCQkJaWYgKGMuYXJncy5sZW5ndGgpIGFyZ3MgPSBhcmdzLmNvbmNhdChjLmFyZ3MpOwoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKGMuTmFtZSwgbnVsbCwgLi4uYXJncykpOwoJCQl9IGVsc2UgewoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJCUVudGl0eU9iamVjdDogKGMub2JqID8gYy5vYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQkJfSkpOwoJCQl9CgkJfSk7CgkJcmV0dXJuICQud2hlbiguLi5hckNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJJC5lYWNoKHJldCwgKGksIHIpID0+IHsKCQkJCWlmIChyICYmIHIubGVuZ3RoICYmIHJbMF0uT3JkZXIpIHsKCQkJCQlyLnNvcnQoKGEsIGIpID0+IHsKCQkJCQkJaWYgKGEuT3JkZXIgPCBiLk9yZGVyKSByZXR1cm4gLTE7CgkJCQkJCWlmIChhLk9yZGVyID4gYi5PcmRlcikgcmV0dXJuIDE7CgkJCQkJCXJldHVybiAwOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKSB0aGlzLl9jYWxsc1tpXS5DYWxsYmFjayhyKTsKCQkJfSk7CgkJfSkudGhlbigoKSA9PiB7CgkJCXRoaXMuX2NhbGxzID0gW107CgkJfSk7Cgl9CgoJX28oZkNhbGxCYWNrLCBvYmopIHsKCQl0aGlzLnN0ZXAoKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogJ0xvYWRpbmcnLAoJCQkJCW1zZzogJ0xvYWRpbmcgZGF0YS4uLicsCgkJCQkJaW50ZXJ2YWw6IGludGVydmFsLAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSByZXR1cm4gZmFsc2U7Cgl9CgoJYXN5bmMgcmVsb2FkRWRpdG9yKGVkaXRvciwgbG9hZGVyLCBmRGF0YSwgb0VsZW1lbnQpIHsKCQlpZiAoIWVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkKSB0aGlzLl9sb2FkaW5nKHRydWUsIG9FbGVtZW50ID8gb0VsZW1lbnQuaW50ZXJ2YWwgOiBudWxsKTsKCQl0cnkgewoJCQlsZXQgdiA9IGF3YWl0IGxvYWRlcihmRGF0YSwgb0VsZW1lbnQsIGVkaXRvcik7CgkJCWVkaXRvci5zZXNzaW9uLmxhc3RMb2FkZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCWxldCBkaWZmID0gMDsKCQkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkICYmIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgZGlmZiA9IE1hdGguYWJzKGVkaXRvci5zZXNzaW9uLmxhc3RDaGFuZ2VkLmdldFRpbWUoKSAtIGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZC5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA+IDAgJiYgZGlmZiA8IDEwMCkgewoJCQkJLy8gY29uc29sZS5sb2coIk5vdCBjaGFuZ2VkIG9uIHRoZSBzZXJ2ZXIiKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJTZXJ2ZXIgY2hhbmdlLCBzZXR0aW5nIHZhbHVlIiwgZGlmZik7CgkJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZDsKCQkJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHYpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBMb2FkIGZpbGUuXG4iICsgZXgpOwoJCX0KCQl0aGlzLl9sb2FkaW5nKGZhbHNlKTsKCgkJaWYgKGVkaXRvci5zZXNzaW9uLmxhc3RTYXZlZCkgewoJCQkvL2F3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAwLjUgKiA2MCAqIDEwMDApKTsKCQkJYXdhaXQgdGhpcy5fd2FpdCgwLjUgKiA2MCAqIDEwMDApOwoJCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCQl9Cgl9CgoJYXN5bmMgT3BlbkVkaXRvcihlLCBsYW5ndWFnZSA9IG8gPT4gImh0bWwiLCBsb2FkZXIgPSBvID0+IHt9LCBzYXZlciA9ICh2LCBvKSA9PiB7fSwgZkRhdGEsIG9FbGVtZW50KSB7CgkJdmFyIGVkaXRvciA9IGFjZS5lZGl0KGUpOwoJCWRlbGV0ZSBlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZDsKCgkJZWRpdG9yLnNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7CgkJLy9hY2UuY29uZmlnLnNldCgnYmFzZVBhdGgnLCAnL25vZGVfbW9kdWxlcy9hY2UtYnVpbGRzL3NyYy1taW4tbm9jb25mbGljdCcpOwoJCWVkaXRvci5zZXNzaW9uLnNldFZhbHVlKCcnKTsKCgkJZWRpdG9yLnNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvJyArIGxhbmd1YWdlKGZEYXRhKSk7CgkJZWRpdG9yLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJbGV0IGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkLmdldFRpbWUoKSAtIHNyLnNlcnZlckRhdGUoKS5nZXRUaW1lKCkpOwoJCQlpZiAoZGlmZiA8IDEwMCAmJiBlLnN0YXJ0LnJvdyA9PSAwICYmIGUuc3RhcnQuY29sdW1uID09IDApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBjb25zb2xlLmxvZygiQ2hhbmdlZCBFdmVudCIsIGRpZmYpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQl9KTsKCQlhd2FpdCB0aGlzLnJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KTsKCgkJaWYgKHNhdmVyKSBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7CgkJCW5hbWU6ICdzYXZlJywKCQkJYmluZEtleTogewoJCQkJd2luOiAiQ3RybC1TIiwKCQkJCW1hYzogIkNtZC1TIgoJCQl9LAoJCQlleGVjOiBhc3luYyBlZGl0b3IgPT4gewoJCQkJdmFyIHZhbHVlID0gdGhpcy5fYmVhdXRpZnkoZWRpdG9yLmdldFZhbHVlKCksIGxhbmd1YWdlKGZEYXRhKSk7CgkJCQlpZiAodmFsdWUgIT0gZWRpdG9yLnNlc3Npb24uZ2V0VmFsdWUoKSkgZWRpdG9yLnNlc3Npb24uc2V0VmFsdWUodmFsdWUpOwoJCQkJaWYgKHNhdmVyKSB7CgkJCQkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJCQl0aXRsZTogJ1BsZWFzZSB3YWl0aW5nJywKCQkJCQkJCW1zZzogJ1NhdmluZyBkYXRhLi4uJywKCQkJCQkJCWludGVydmFsOiBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJdHJ5IHsKCQkJCQkJYXdhaXQgc2F2ZXIodmFsdWUsIGZEYXRhKTsKCQkJCQkJZWRpdG9yLmxhc3RTYXZlZCA9IHNyLnNlcnZlckRhdGUoKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLl9lcnJvcigiVW5hYmxlIHRvIFNhdmUgZmlsZS5cbiIgKyBleCk7CgkJCQkJfQoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoJ2Nsb3NlJyk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSk7Cgl9CgoJX2JlYXV0aWZ5KHZhbHVlLCB0eXBlKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc19iZWF1dGlmeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCSJlNHgiOiBmYWxzZSwKCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCX07CgoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICdmdW5jdGlvbicpIHZhbHVlID0gU3RyaW5nKHZhbHVlKTsKCQkJCXZhbHVlID0gdHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0JywgJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQl2YWx1ZSA9IGpzX2JlYXV0aWZ5KHZhbHVlLCBvcHRpb25zKTsKCQkJCX0KCQkJfQoJCX0gY2F0Y2ggKGV4KSB7fQoJCXJldHVybiB2YWx1ZTsKCX0KCglfbGFuZyhjb2RlKSB7CgkJd2luZG93LmxhbmcgPSBjb2RlOwoJCXRoaXMuc2V0VVJMKCJwYWdlPSIgKyAodGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgfHwgJ2luZGV4JykpOwoJfQoKCXNlbGVjdDJTUihvU2VsZWN0KSB7CgkJbGV0IHMgPSAkKG9TZWxlY3QpOwoJCWxldCBjYWxscyA9IFtdOwoJCWlmICh0aGlzLnNlbGVjdDJUZW1wbGF0ZSkgewoJCQljYWxscy5wdXNoKHRoaXMuc2VsZWN0MlRlbXBsYXRlKTsKCQl9IGVsc2UgewoJCQljYWxscy5wdXNoKHRoaXMuc3IoKS5HZXQodGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiL3NlbGVjdDItdGVtcGxhdGUuaHRtIikpKTsKCQl9CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJdGhpcy5zZWxlY3QyVGVtcGxhdGUgPSByZXRbMF07CgkJCXMuc2VsZWN0Mih7CgkJCQlhamF4OiB7CgkJCQkJdHJhbnNwb3J0OiAocGFyYW1zLCBzdWNjZXNzLCBmYWlsdXJlKSA9PiB7CgkJCQkJCXZhciBmRmlsdGVyID0gdGhpcy5zcigpLnJ1blNjcmlwdCgiKG8sIHN0YXRlKSA9PiB7IiArIHMuZGF0YSgic3JfZmlsdGVyIikgKyAifSIpOwoJCQkJCQkkLndoZW4odGhpcy5zcigpLl8ocy5kYXRhKCJzcl9tZXRob2QiKSwgbnVsbCwgZkZpbHRlcih7fSwgdGhpcy5zcigpLnJ1blNjcmlwdChzLmRhdGEoImNfc3RhdGUiKSkpKSkudGhlbihyZXQgPT4gewoJCQkJCQkJc3VjY2Vzcyh7CgkJCQkJCQkJcGFnaW5hdGlvbjogewoJCQkJCQkJCQltb3JlOiBmYWxzZQoJCQkJCQkJCX0sCgkJCQkJCQkJcmVzdWx0czogJC5tYXAocmV0LCByID0+IHsKCQkJCQkJCQkJci5pZCA9IHIuSWQ7CgkJCQkJCQkJCXIudGV4dCA9IHIuVG9TdHJpbmc7CgkJCQkJCQkJCXJldHVybiByOwoJCQkJCQkJCX0pLAoJCQkJCQkJCXRvdGFsczogcmV0Lmxlbmd0aAoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0sCgkJCQl0ZW1wbGF0ZVJlc3VsdDogKF9lLCBfcykgPT4gewoJCQkJCXJldHVybiB0aGlzLl9pbmplY3QodGhpcy5zZWxlY3QyVGVtcGxhdGUsIHsKCQkJCQkJZGF0YTogX2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJCXMub24oImNoYW5nZSIsIGUgPT4gewoJCQkJY29uc29sZS5sb2coZS50YXJnZXQpOwoJCQl9KTsKCQkJcy5vbigiY2hhbmdlLnNlbGVjdDIiLCBlID0+IHsKCQkJCS8vdmFyIGRhdGEgPSBlLnBhcmFtcy5kYXRhOwoJCQkJdmFyIF9zID0gJChlLnRhcmdldCk7CgkJCX0pOwoJCX0pOwoJfQoKCWFzeW5jIHByZUNvbXBpbGUocGFnZSwgbG9jYXRpb24pIHsKCQlpZiAodHlwZW9mIEJhYmVsID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZiBSZWFjdCAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbGV0IGpzeCA9IG51bGw7CgkJCXRyeSB7CgkJCQlqc3ggPSBhd2FpdCAkLmdldCh0aGlzLnJhbmRVUkwoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChqc3ggPT09IG51bGwgfHwganN4ID09PSAiIikgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJdmFyIHJlcyA9IG51bGw7CgkJCXRyeSB7CgkJCQlyZXMgPSBhd2FpdCBCYWJlbC50cmFuc2Zvcm0oanN4LCB7CgkJCQkJcHJlc2V0czogWydsYXRlc3QnLCAicmVhY3QiXQoJCQkJfSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiQmFiZWwiLCBleCk7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoJCQlyZXR1cm4gcmVzLmNvZGU7CgkJfQoJfQoKCWFzeW5jIF92dWVDb21wb25lbnQoY29kZSkgewoJCWlmICh0eXBlb2YgVnVlID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7Cgl9CgoJYXN5bmMgX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJY29uc29sZS5sb2coIlJlbmRlclBhZ2UiLCBwYWdlLCBkYXRhKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucGFnZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXMucGFnZXNbaV0uX2NvZGUgPT0gcGFnZS5fY29kZSAmJiB0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSAmJiAodGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgPT0gKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpKSB7CgkJCQljb25zb2xlLmxvZygod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSk7CgkJCQlwYWdlID0gdGhpcy5wYWdlc1tpXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlmICghdGhpcy5zcigpLmJMb2NhbCAmJiAocGFnZS5Cb2R5IHx8IHBhZ2UudG9FbnRpdHlPYmplY3QpKSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBhbHJlYWR5IGxvYWRlZCwgc2VydmluZy4uLiIpOwoJCQkvLyBmb3VuZCB0aGUgcGFnZSBhbmQgaXQgaXMgYW4gb2JqZWN0CgkJCWlmICghcGFnZS5TY3JpcHQpIHsKCQkJCWxldCBlID0gYXdhaXQgdGhpcy5lbmQoKTsKCQkJCXJldHVybiBlOwoJCQl9CgkJCWF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl9CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykucGFnZSh0aGlzLmFwaVNlcnZlci5TY29wZSArICIvdGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBwLnNjcmlwdCgpID8gcC5fYXRvYihwLnNjcmlwdCgpKSA6ICcnLAoJCQkJQm9keTogcC5ib2R5KCkgPyBwLl9hdG9iKHAuYm9keSgpKSA6ICcnLAoJCQkJX2NvZGU6IHBhZ2UuX2NvZGUsCgkJCX07CgkJfQoKCQlpZiAoIXJldCkgcmV0ID0gYXdhaXQgdGhpcy5fdnVlQ29tcG9uZW50KHBhZ2UuX2NvZGUpOwoJCWlmICghcmV0ICYmIHR5cGVvZihDTVNfUk9PVCkgPT09ICdzdHJpbmcnKSB7CgkJCXJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNIVE1MUGFnZUZpbmQiLCBudWxsLCB7CgkJCQlQYWdlOiBwYWdlLl9jb2RlLmluZGV4T2YoJy8nKSA+PSAwID8gcGFnZS5fY29kZSA6IChDTVNfUk9PVCArIHBhZ2UuX2NvZGUpCgkJCX0pOwoJCX0KCQlpZiAocmV0KSB7CgkJCS8vIHN0b3JlIHRvIGF2b2lkIHJlZHVuZGFudCBsb2FkaW5nCgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBmb3VuZCBpbiBDTVMsIHNlcnZpbmcuLi4iKTsKCQkJcGFnZSA9IHJldDsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgbm90IGZvdW5kIGluIENNUywgbG9va2luZyBpbiBFTVMiKTsKCQkJdmFyIGVvUGFnZSA9IG51bGw7CgkJCXRyeSB7CgkJCQllb1BhZ2UgPSBuZXcgUGFnZSgpLmNvZGUocGFnZS5fY29kZSwgIj0iKTsKCQkJCWlmIChlb1BhZ2UubGFuZ3VhZ2UpIGVvUGFnZS5sYW5ndWFnZSh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIsICI9Iik7CgkJCX0gY2F0Y2ggKGUpIHsKCQkJCWNvbnNvbGUubG9nKCJFTVMgZG9lcyBub3QgaGF2ZSBhIFBhZ2UgY2xhc3MsIGZhaWxpbmcgb24gcHVycG9zZTogIiArIGUubWVzc2FnZSk7CgkJCX0KCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkuXykgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQlFbnRpdHlPYmplY3Q6IChlb1BhZ2UgPyBlb1BhZ2UudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQl9KTsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gRU1TLCB0cnlpbmcgdGVtcGxhdGVzIik7CgkJCQlwYWdlID0gcmV0WzBdOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIG5vdCBmb3VuZCBpbiBFTVMsIHNvIGdvaW5nIGxvY2FsIik7CgkJCX0KCgkJCWxldCBodG1sID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWh0bWwgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiLmh0bSIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmIChodG1sICYmICFodG1sLnN0YXR1cykgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGh0bWwgdGVtcGxhdGUgZm91bmQiLCBodG1sKTsKCQkJCXBhZ2UuQm9keSA9IGh0bWw7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgaGFzIG5vIGh0bWwgdGVtcGxhdGUiKTsKCQkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQlwYWdlLkJvZHkgPSAiPGRpdiBpZD0nZm9ybUNvbXBvbmVudCcvPiI7CgkJCQl9IGVsc2UgewoJCQkJCXBhZ2UuQm9keSA9IHBhZ2UuX2NvbnRlbnQgfHwgIjwhLS0iICsgKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBkb2VzIG5vdCBleGlzdCIpICsgIi0tPiI7CgkJCQl9CgkJCX0KCgkJCWxldCBqcyA9IGF3YWl0IHRoaXMucHJlQ29tcGlsZShwYWdlKTsKCQkJaWYgKCFqcykgdHJ5IHsKCQkJCWpzID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5qcyIpKTsKCQkJfSBjYXRjaCAoZXgpIHt9CgkJCWlmICghanMgfHwgIWpzLm9rKSBqcyA9IG51bGw7CgkJCWlmIChqcyAmJiBqcy5vaykgcGFnZS5TY3JpcHQgPSBhd2FpdCBqcy50ZXh0KCk7CgoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgc2NyaXB0IGlzIiArIChqcyA/ICcnIDogJyBub3QnKSArICIgcmV0cmlldmVkIik7CgkJCXRoaXMuc3RlcCgpOwoJCQkvLyBvbmx5IGNhY2hlIHBhZ2VzIHRoYXQgY29tZSBmcm9tIEVNUwoJCQlpZiAocGFnZS50b0VudGl0eU9iamVjdCkgdGhpcy5wYWdlcy5wdXNoKHBhZ2UpOwoJCX0KCQlwYWdlLmRhdGEgPSBkYXRhOwoJCXBhZ2UuU2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCS8vY29uc29sZS5sb2coInBhZ2UgQm9keSIsIHBhZ2UuX2JvZHkgfHwgcGFnZS5Cb2R5KTsKCQlpZiAodHlwZW9mKHBhZ2UuU2NyaXB0KSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YocGFnZS5TY3JpcHQuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQlsZXQgb2JqID0gbmV3IHBhZ2UuU2NyaXB0KHBhZ2UpOwoJCQkJcGFnZS5jb21wb25lbnQgPSBvYmo7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgcGFnZVsiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpICsgIl0uU2NyaXB0Lm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJcmV0dXJuIHBhZ2U7Cgl9CgoJYXN5bmMgUmVuZGVyUGFnZShwYWdlLCBkYXRhLCBvcHRpb25zKSB7CgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWRlbGV0ZSB3aW5kb3cuRm9ybUNvbXBvbmVudDsKCQkJJCgiI2Zvcm1Db21wb25lbnQiKS5lbXB0eSgpOwoJCX0KCQl2YXIgX3BhZ2UgPSBhd2FpdCB0aGlzLl9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucyk7CgkJaWYgKCFfcGFnZSkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihnYSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWdhKCdzZW5kJywgewoJCQkJaGl0VHlwZTogJ3BhZ2V2aWV3JywKCQkJCXBhZ2U6ICcvJyArIF9wYWdlLl9jb2RlICsgJy5keW5hbWljJywKCQkJCXRpdGxlOiBfcGFnZS5fdGl0bGUKCQkJfSk7CgkJCWNvbnNvbGUubG9nKCJTZW50IEdBIGhpdCBmb3IgcGFnZTogIiArIChfcGFnZS5fY29kZSB8fCBfcGFnZS5QYWdlIHx8IF9wYWdlKSk7CgkJfQoJCXdpbmRvdy5wYWdlID0gX3BhZ2U7CgkJdGhpcy5hbGxIVE1MID0gdGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgKyAodGhpcy5ibG9ja3MuY29udGVudC5odG1sIHx8IF9wYWdlLkJvZHkgfHwgX3BhZ2UuX2JvZHkpICsgdGhpcy5ibG9ja3MuZm9vdGVyLmh0bWw7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgkJaWYgKHR5cGVvZihzcikgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChqcy5pbmRleE9mKCdjbGFzcyAnKSA+PSAwICYmICFiQXN5bmMpIHsKCQkJCS8vIGEgY2xhc3MgZGVmaW5pdGlvbiwgZG8gbm90IGVuY2xvc2UgaXQgaW4gYSBmdW5jdGlvbgoJCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChqcyk7CgkJCX0gZWxzZSB7CgkJCQlsZXQgc0NvZGUgPSBqczsKCQkJCWlmIChzQ29kZS5pbmRleE9mKCdyZXR1cm4gJykgIT0gMCkgewoJCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCQl9CgkJCQlyZXR1cm4gYXdhaXQgc3IucnVuU2NyaXB0KCIoYXN5bmMgKCkgPT4geyIgKyBzQ29kZSArICJcbn0pKCk7Iik7CgkJCX0KCQl9IGVsc2UgaWYgKGZhbHNlICYmIHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWxldCByZXQgPSBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHI7CgkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQlzY3JpcHQuYXN5bmMgPSBiQXN5bmM7CgkJCQlzY3JpcHQuc3JjID0gYGRhdGE6dGV4dC9qYXZhc2NyaXB0O2Jhc2U2NCwke3RoaXMuX2J0b2EoanMpfWA7CgkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQl9KTsKCQkJY29uc29sZS5sb2cocmV0LCBqcy5zdWJzdHJpbmcoMCwgMjApKTsKCQkJcmV0dXJuIHJldDsKCQl9IGVsc2UgewoJCQl0cnkgewoJCQkJcmV0dXJuIEpTT04ucGFyc2UoanMpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJcmV0dXJuIGV2YWwoanMpOwoJCQl9CgkJfQoJfQp9Ow==",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": []
}
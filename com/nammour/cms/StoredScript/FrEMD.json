{
	"Id": "17391579b552779f2ca6ef580dac8f18bfbbaf1e",
	"after": null,
	"async": null,
	"before": null,
	"date": "undefined",
	"name": "FrEMD",
	"order": null,
	"remark": "dW5kZWZpbmVk",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDw8IDQpIHwgKGIyID4+IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSA8PCAyKSB8IChiMyA+PiA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sOwoKCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgdGhpcy5fZ2V0KGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9YCwgdHJ1ZSk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiB0eXBlb2YocmV0LnJlcGxhY2UpID09PSAnZnVuY3Rpb24nICYmICF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMuX2dldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuLCBiSW50KSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGJJbnQpIHJldHVybiBNYXRoLmZsb29yKERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpKTsKCgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6X21lbnVDbGFzc2VzKCIgKyBzY29wZSArICIpOiBvU2NvcGUiLCBzY29wZSwgb1Njb3BlLCB0aGlzLmFwaVNlcnZlcik7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAodGhpcy5oYXNoLnNjb3BlIHx8ICcnKS5yZXBsYWNlKC9cIC9nLCAnJykudG9Mb3dlckNhc2UoKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlPYmplY3Qua2V5cyh0aGlzLmhhc2gpLmZvckVhY2goaCA9PiB0aGlzLmhhc2hbaF0gPSBkZWNvZGVVUkkodGhpcy5oYXNoW2hdKSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwLCBtc2csIHRpdGxlKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogdGl0bGUgfHwgJ0xvYWRpbmcnLAoJCQkJCW1zZzogbXNnIHx8ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCV9GckVNRC5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLCAnU2F2aW5nIGRhdGEuLi4nLCAnUHJvZ3Jlc3MnKTsKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKGZhbHNlKTsKCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQlqc3ggPSBhd2FpdCB0aGlzLl9nZXQoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIsIHRydWUpOwoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyICYmIHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykpIHsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUodGhpcy5wYXRoVG9OYW1lKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBhd2FpdCB0aGlzLnJ1blNjcmlwdChwLnNjcmlwdCgpIHx8ICcnKSwKCQkJCUJvZHk6IHAuYm9keSgpIHx8ICcnLAoJCQkJU3R5bGU6IHAuc3R5bGUoKSB8fCAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCQljb25zb2xlLmxvZygiX3JlbmRlcigiICsgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiKSB1c2luZyBhcGlTZXJ2ZXIiLCBwLCByZXQpOwoJCX0KCgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJcGFnZS5Cb2R5ID0gYXdhaXQgdGhpcy5pbXBvcnQoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUsIHsKCQkJCWV4dDogJ2h0bScsCgkJCQlmaWVsZDogJ2JvZHknLAoJCQl9KTsKCgkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJfSBlbHNlIGlmICh0eXBlb2YodnVlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXBhZ2UuQm9keSA9IC8qcGFnZS5fY29udGVudCB8fCAqLyAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJfQoKCQkJcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLmltcG9ydCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSwgewoJCQkJZXh0OiAnanMnLAoJCQkJZmllbGQ6ICdzY3JpcHQnLAoJCQl9KTsKCgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgoJCS8vaWYgKHBhZ2UuU2NyaXB0KSBwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl0cnkgewoJCQljdXN0b21FbGVtZW50cy5kZWZpbmUocGFnZS5fY29kZSwgcGFnZS5jb21wb25lbnQgPSB2dWUuZGVmaW5lQ3VzdG9tRWxlbWVudChPYmplY3QuYXNzaWduKG5ldyBwYWdlLlNjcmlwdCgpLCB7CgkJCQl0ZW1wbGF0ZTogcGFnZS5Cb2R5LAoJCQkJc3R5bGVzOiBbcGFnZS5TdHlsZV0KCQkJfSkpKTsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IHBhZ2UgYXMgdnVlanMgY3VzdG9tIGVsZW1lbnQiLCBwYWdlKTsKCQkJcGFnZS5Cb2R5ID0gbnVsbDsKCQkJLy9wYWdlLlNjcmlwdCA9IG51bGw7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IFZ1ZSBFeGNlcHRpb246ICIgKyBleCk7CgkJCXBhZ2UuY29tcG9uZW50ID0gbnVsbDsKCQl9CgoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIgJiYgIXBhZ2UuY29tcG9uZW50KSB7CgkJCXRyeSB7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlpZiAocGFnZS5jb21wb25lbnQgJiYgcGFnZS5jb21wb25lbnQubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBwYWdlLmNvbXBvbmVudC5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogbmV3IHBhZ2UuU2NyaXB0KCkgRXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6ZW5kKCk6IGRhdGEiLCBkYXRhLCB0aGlzLmFsbEhUTUwpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCgkJCWlmICh0eXBlb2YodnVlKSAhPT0gJ3VuZGVmaW5lZCcgJiYgcGFnZS5jb21wb25lbnQgJiYgdHlwZW9mKHBhZ2UuY29tcG9uZW50LmRlZikgPT09ICdvYmplY3QnKSB7CgkJCQljb25zb2xlLmxvZygiZW5kKCk6IGFkZGluZyBWdWVKUyBDb21wb25lbmV0IHRvIHBhZ2UiLCBwYWdlKTsKCQkJCW9Db250ZW50LmFwcGVuZChuZXcgcGFnZS5jb21wb25lbnQoKSk7CgkJCX0KCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdGl0bGVDYXNlKHMpIHsgLy8gc3IuRW5nbGlzaE5hbWUKCQljb25zdCByZXN1bHQgPSBzLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpOwoJCXJldHVybiByZXN1bHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyByZXN1bHQuc2xpY2UoMSk7Cgl9CgoJX3VybEdldChwKSB7CgkJdHJ5IHsKCQkJcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KHApIHx8IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cigxKS5zcGxpdCgnJicpLnJlZHVjZSgocmVzLCBpdGVtKSA9PiB7CgkJCQl2YXIgcGFydHMgPSBpdGVtLnNwbGl0KCc9Jyk7CgkJCQlyZXNbcGFydHNbMF1dID0gcGFydHNbMV07CgkJCQlyZXR1cm4gcmVzOwoJCQl9LCB7fSlbcF0gfHwgJyc7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuICcnOwoJCX0KCX0KCglncm91cEJ5KGFyLCBmaWVsZCkgewoJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJdmFyIGtleXMgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQl2YXIga2V5ID0gbnVsbDsKCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQlpZiAoaykgewoJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJfSBlbHNlIHsKCQkJCWtleXMucHVzaCh7CgkJCQkJa2V5OiBrZXksCgkJCQkJdmFsdWVzOiBbYV0sCgkJCQl9KTsKCQkJfQoJCX0pOwoJCXJldHVybiBrZXlzOwoJfQoKCWFzeW5jIF9nZXQodXJsLCByYW5kKSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IGF3YWl0IGZldGNoKHVybCArIChyYW5kID8gIj9yYW5kPSIgKyBNYXRoLnJhbmRvbSgpIDogJycpLCB7CgkJCQloZWFkZXJzOiB7CgkJCQkJIkNvbnRlbnQtVHlwZSI6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiCgkJCQl9CgkJCX0pOwoJCQlpZiAocmV0Lm9rKSByZXR1cm4gYXdhaXQgcmV0LnRleHQoKTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9nZXQoKTogRXhjZXB0aW9uOiAiICsgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2V0U3RvcmVkU2NyaXB0KHMsIGJOb1J1bikgewoJCWxldCBzY3JpcHQgPSAnJzsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKSk/LlNjcmlwdDsKCQl9IGVsc2UgaWYgKCF0aGlzLmFwaVNlcnZlciB8fCAhdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykpIHsKCQkJLy9jb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiBubyBhcGlTZXJ2ZXIsIHJ1bm5pbmcgaW4gc2NvcGUgIiwgdGhpcy5fX3Njb3BlKCkpOwoJCQlzY3JpcHQgPSBhdG9iKEpTT04ucGFyc2UoYXdhaXQgdGhpcy5fZ2V0KGBodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9jb20vbmFtbW91ci9jbXMvU3RvcmVkU2NyaXB0LyR7cy5OYW1lIHx8IHMubmFtZX0uanNvbmAsIHRydWUpKS5zY3JpcHQpOwoJCX0gZWxzZSB7CgkJCS8vY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogdXNpbmcgYXBpU2VydmVyISEhIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUsIHMsIHRoaXMuX19zY29wZSh0aGlzLmFwaVNlcnZlci5TY29wZSkpOwoJCQlzY3JpcHQgPSAoYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnU3RvcmVkU2NyaXB0JykubmFtZShzLk5hbWUgfHwgcy5uYW1lLCAnPScpLmZpbmQoKSkuc2NyaXB0KCk7CgkJfQoKCQlpZiAoc2NyaXB0KSB7CgkJCXJldHVybiAoYk5vUnVuID8gc2NyaXB0IDogYXdhaXQgdGhpcy5ydW5TY3JpcHQoc2NyaXB0KSk7CgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2coIm5vIHN0b3JlZCBzY3JpcHQgbG9hZGVyIHRvIHVzZSIsIHMpOwoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9CgoJX3VuaXF1ZShkYXRhLCBrZXkpIHsKCQlyZXR1cm4gWy4uLm5ldyBNYXAoZGF0YS5tYXAoeCA9PiBbIXggPyB4IDogeFtrZXkgfHwgJ05hbWUnXSwgeF0pKS52YWx1ZXMoKV07Cgl9CgoJX3RvRW50aXR5Q2xhc3NlcyhzY29wZSkgewoJCWxldCBlYU1hcCA9IGVhID0+IHsKCQkJbGV0IHJldCA9IHsKCQkJCU5hbWU6IGVhLk5hbWUucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJfSksCgkJCQlSZXF1aXJlZDogZWEuUmVxdWlyZWQsCgkJCX07CgkJCU9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykpLmZvckVhY2goayA9PiByZXRba10gPSBlYVtrXSk7CgkJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCdJcycpICYmICFyZXRba10pLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHsKCQkJCXJldC5FbnRpdHlUeXBlID0gewoJCQkJCU5hbWU6IGVhLkVudGl0eVR5cGUuTmFtZQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCXJldHVybiB0aGlzLl9fc2NvcGUoc2NvcGUpLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogYy5OYW1lLAoJCQkJVG9vbHM6IGMuVG9vbHMsCgkJCQlEZWJ1ZzogYy5EZWJ1ZywKCQkJCVRlc3Q6IGMuVGVzdCwKCQkJCUNvbmZpZzogYy5Db25maWcsCgkJCQlFbmFibGVkOiBjLkVuYWJsZWQsCgkJCQlFbnRpdHlBdHRyaWJ1dGVzOiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlNZXRob2QpLm1hcChlYSA9PiBlYU1hcChlYSkpLAoJCQkJRW50aXR5TWV0aG9kczogYy5FbnRpdHlNZXRob2RzLm1hcChtID0+ICh7CgkJCQkJTmFtZTogbS5OYW1lLAoJCQkJCVNjcmlwdDogbS5TY3JpcHQsCgkJCQkJUm91dGluZzogbS5Sb3V0aW5nLAoJCQkJCU1ldGhvZFBhcmFtZXRlcnM6IG0uTWV0aG9kUGFyYW1ldGVycy5tYXAocCA9PiBlYU1hcChwKSksCgkJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IGVhTWFwKG0uUmVzcG9uc2VBdHRyaWJ1dGUpLAoJCQkJfSkpLAoJCQl9OwoKCQkJWyJUb29scyIsICJFbnRpdHlNZXRob2RzIl0uZm9yRWFjaChhID0+IHsKCQkJCWlmICghcmV0W2FdLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCVsiRGVidWciLCAiVGVzdCIsICJDb25maWciXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFPYmplY3Qua2V5cyhyZXRbYV0pLmxlbmd0aCkgZGVsZXRlIHJldFthXTsKCQkJfSk7CgkJCXJldC5FbnRpdHlBdHRyaWJ1dGVzID0gcmV0LkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT0gImlkIik7CgkJCXJldHVybiByZXQ7CgkJfSk7Cgl9CgoJYXN5bmMgX3J1blNlcXVlbmNlcyhzZXFzLCBzY29wZSkgewoJCWxldCBjYWxsU2VxdWVuY2VzID0gW107CgkJaWYgKCFzY29wZSkgcmV0dXJuIGNhbGxTZXF1ZW5jZXM7CgoJCWZvciBhd2FpdCAoY29uc3Qgc2VxIG9mIHNlcXMpIHsKCQkJbGV0IGNhbGxTZXF1ZW5jZSA9IHsKCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCXRpdGxlOiBzZXEudGl0bGUsCgkJCQljbGFzc2lmaWVyOiBzZXEuY2xhc3NpZmllciwKCQkJCWVudGl0aWVzOiBbXSwKCQkJCXRpbWVsaW5lOiBbXSwKCQkJfTsKCgkJCWxldCBfZW50aXRpZXMgPSBzZXEuZW50aXRpZXMuZmlsdGVyKGUgPT4gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkpOwoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJZS5vYmogPSBuZXcgc2NvcGVbZS50eXBlXSgpLl9mcm9tRG9jdW1lbnQoZS5jb250ZW50KTsKCQkJfQoKCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIF9lbnRpdGllcykgewoJCQkJLy8gZmlyc3QgbGV2ZWwgcmVmZXJlbmNlIGNsZWFudXA6IG1ha2Ugc3VyZSBvbmx5IG9uZSByZWZlcmVuY2Ugb2JqZWN0IGlzIHVzZWQgd2l0aCB0aGUgc2FtZSAiX25hbWUiLiBsb3dlciBsZXZlbHMgc2hvdWxkIGJlIGRvbmUgcmVjdXJzaXZlbHkKCQkJCXNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBlLnR5cGUpLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZS5FbnRpdHlBdHRyaWJ1dGVzLmZpbmQoX2VhID0+IF9lYS5OYW1lID09ICduYW1lJyAmJiBfZWEuSXNTdHJpbmcpKS5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoZS5vYmpbJ18nICsgZWEuTmFtZV0pIHsKCQkJCQkJZS5vYmpbJ18nICsgZWEuTmFtZV0gPSAoc2VxLmVudGl0aWVzLmZpbmQoX2UgPT4gX2UgIT09IGUgJiYgX2Uub2JqICYmIF9lLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSA9PSBlLm9ialsnXycgKyBlYS5OYW1lXS5fbmFtZSkgfHwgZSkub2JqWydfJyArIGVhLk5hbWVdOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQlzZXEuc3RlcHMgPSBzZXEuc3RlcHMubWFwKHMgPT4gewoJCQkJaWYgKCFzLl9pZikgcmV0dXJuIFtzXTsKCQkJCXJldHVybiBzLl90aGVuLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiB0cnVlCgkJCQkJfQoJCQkJfSkpLmNvbmNhdChzLl9lbHNlLm1hcChzdCA9PiAkLmV4dGVuZChzdCwgewoJCQkJCV9pZjogewoJCQkJCQlsYWJlbDogcy5faWYsCgkJCQkJCXZhbHVlOiBmYWxzZQoJCQkJCX0KCQkJCX0pKSk7CgkJCX0pOwoJCQlzZXEuc3RlcHMgPSBbXS5jb25jYXQuYXBwbHkoW10sIHNlcS5zdGVwcyk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2Ygc2VxLnN0ZXBzKSB7CgkJCQlpZiAocy5pZ25vcmUpIGNvbnRpbnVlOwoKCQkJCWxldCBfZnJvbSA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gcy5mcm9tKTsKCQkJCWlmICghX2Zyb20pIHsKCQkJCQljb25zb2xlLmxvZygiTWlzc2luZyBFbnRpdHkgRGVmaW5pdGlvbjogIiArIHMuZnJvbSk7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlfZnJvbSA9IF9mcm9tLm9iajsKCgkJCQl0cnkgewoJCQkJCXMucGFyYW1zID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHMucGFyYW1zKS5tYXAoZXQgPT4gewoJCQkJCQlpZiAoZXRbMV0gJiYgZXRbMV0ubmFtZSkgewoJCQkJCQkJbGV0IG9iaiA9IHNlcS5lbnRpdGllcy5maW5kKGUgPT4gZS5vYmogJiYgKGUubmFtZSB8fCBlLm9iai5fbmFtZSkgPT0gZXRbMV0ubmFtZSk7CgkJCQkJCQlyZXR1cm4gb2JqID8gW2V0WzBdLCBvYmoub2JqXSA6IGV0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIGV0OwoJCQkJCQl9CgkJCQkJfSkpOwoKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBfZnJvbVtzLm1ldGhvZF0oLi4uT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykpOwoKCQkJCQkJcy5fbWV0aG9kID0gcy5tZXRob2QuaW5kZXhPZignLicpID4gMCA/IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSWQgPT0gX2Zyb20uRW50aXR5Q2xhc3MuSWQpLkVudGl0eU1ldGhvZHMuZmluZChtID0+IG0uTmFtZSA9PSBzLm1ldGhvZCkgOiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVswXSkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kLnNwbGl0KCcuJylbMV0pOwoJCQkJCX0gY2F0Y2ggKF9leCkge30KCgkJCQkJLy8gbm90IGRlZmluZWQgdG8gd2hpY2ggZW50aXR5IHRoaXMgaXMgZ29pbmcsIGZpbmQgZmlyc3QgZW50aXR5IGluIHRoZSBwYXJhbWV0ZXJzLCBvdGhlcndpc2UgaXQgaXMgYSBsb29wIHRvIG15c2VsZgoJCQkJCWxldCBfdG8gPSAoT2JqZWN0LnZhbHVlcyhzLnBhcmFtcykgfHwgW10pLmZpbmQocCA9PiBwICYmIHAuRW50aXR5Q2xhc3MpIHx8IF9mcm9tOwoKCQkJCQljYWxsU2VxdWVuY2UuZW50aXRpZXMgPSBjYWxsU2VxdWVuY2UuZW50aXRpZXMuY29uY2F0KFtfZnJvbSwgX3RvXSkuZmlsdGVyKGUgPT4gZSkuZmlsdGVyKChvYmosIHBvcywgYXJyKSA9PiB7CgkJCQkJCXJldHVybiBhcnIubWFwKG1hcE9iaiA9PiBtYXBPYmopLmluZGV4T2Yob2JqKSA9PT0gcG9zOwoJCQkJCX0pOwoKCQkJCQlsZXQgc09iaiA9IHsKCQkJCQkJZGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJZnJvbTogX2Zyb20sCgkJCQkJCXRvOiBfdG8sCgkJCQkJCWFjdGl2YXRlOiBzLmFjdGl2YXRlLAoJCQkJCQlwYXJhbXM6IHMucGFyYW1zLAoJCQkJCQltZXRob2Q6IHMubWV0aG9kLAoJCQkJCQlfaWY6IHMuX2lmLAoJCQkJCX07CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnB1c2goc09iaik7CgkJCQkJY2FsbFNlcXVlbmNlLnRpbWVsaW5lLnNvcnQoKGEsIGIpID0+IGEuZGF0ZSA8IGIuZGF0ZSk7CgoJCQkJCWlmIChfZnJvbSAhPT0gX3RvICYmICh0eXBlb2Yocy5hY3RpdmF0ZSkgPT09ICd1bmRlZmluZWQnIHx8IHMuYWN0aXZhdGUpKSB7CgkJCQkJCS8vIGlzIHRoaXMgY2FsbCBjbG9zaW5nIGFuIGFjdGl2YXRpb24/IHRoZW4gZGVmaW5lIGl0IGFzIGFjdGl2YXRlZCBpbiB0aGUgaW5pdGlhbCBjYWxsCgkJCQkJCWxldCBpbml0ID0gY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmZpbmQodCA9PiB0LmZyb20gPT0gc09iai50byAmJiB0LnRvID09IHNPYmouZnJvbSAmJiB0LmRhdGUgPCBzT2JqLmRhdGUgJiYgIXQuYWN0aXZhdGluZyk7CgkJCQkJCWlmIChpbml0KSB7CgkJCQkJCQlpbml0LmFjdGl2YXRpbmcgPSBzT2JqOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWF3YWl0IHRoaXMuX3dhaXQocy53YWl0IHx8IHNlcS53YWl0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coX2Zyb20sIHMsIGV4KTsKCQkJCX0KCQkJfQoJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuZm9yRWFjaCgodCwgaSkgPT4gewoJCQkJdC5mcm9tID0gdC5mcm9tIHx8ICJudWxsIjsKCQkJCXQudG8gPSB0LnRvIHx8ICJudWxsIjsKCQkJCXQuX3ByZXZpb3VzID0gaSA/IGNhbGxTZXF1ZW5jZS50aW1lbGluZVtpIC0gMV0gOiBudWxsOwoJCQkJdC5fbmV4dCA9IChpIDwgY2FsbFNlcXVlbmNlLnRpbWVsaW5lLmxlbmd0aCAtIDEpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgKyAxXSA6IG51bGw7CgkJCQl0Ll9hY3RpdmF0b3IgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZChfdCA9PiBfdC5hY3RpdmF0aW5nID09IHQpOwoJCQl9KTsKCgkJCWNhbGxTZXF1ZW5jZXMucHVzaChjYWxsU2VxdWVuY2UpOwoJCX0KCgkJcmV0dXJuIGNhbGxTZXF1ZW5jZXM7Cgl9CgoJYXN5bmMgX3dhaXQobXMpIHsKCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCX0KCglfZmlsZVR5cGUoYmFzZTY0KSB7CgkJdmFyIGJpbmFyeV9zdHJpbmcgPSB0aGlzLl9hdG9iKGJhc2U2NCk7CgkJdmFyIGxlbiA9IGJpbmFyeV9zdHJpbmcubGVuZ3RoOwoJCXZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KGxlbik7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQlieXRlc1tpXSA9IGJpbmFyeV9zdHJpbmcuY2hhckNvZGVBdChpKTsKCQl9CgoJCXZhciBhcnIgPSAobmV3IFVpbnQ4QXJyYXkoYnl0ZXMuYnVmZmVyKSkuc3ViYXJyYXkoMCwgNCk7CgkJdmFyIGhlYWRlciA9ICcnOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CgkJCWhlYWRlciArPSBhcnJbaV0udG9TdHJpbmcoMTYpOwoJCX0KCgkJLy8gQ2hlY2sgdGhlIGZpbGUgc2lnbmF0dXJlIGFnYWluc3Qga25vd24gdHlwZXMKCQl2YXIgdHlwZSA9ICd1bmtub3duJzsKCQlzd2l0Y2ggKGhlYWRlcikgewoJCQljYXNlICc4OTUwNGU0Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3BuZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnNDc0OTQ2MzgnOgoJCQkJdHlwZSA9ICdpbWFnZS9naWYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ2ZmZDhmZmUwJzoKCQkJY2FzZSAnZmZkOGZmZTEnOgoJCQljYXNlICdmZmQ4ZmZlMic6CgkJCQl0eXBlID0gJ2ltYWdlL2pwZWcnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzI1NTA0NDQ2JzoKCQkJCXR5cGUgPSAnYXBwbGljYXRpb24vcGRmJzsKCQkJCWJyZWFrOwoJCQljYXNlICczYzczNzY2Nyc6CgkJCQl0eXBlID0gJ2ltYWdlL3N2Zyt4bWwnOwoJCQkJYnJlYWs7CgkJfQoJCXJldHVybiB0eXBlOwoJfQoKCWltZyhkSW1nLCBtaW1lVHlwZSkgewoJCXJldHVybiBgZGF0YToke21pbWVUeXBlIHx8IHRoaXMuX2ZpbGVUeXBlKGRJbWcpfTtiYXNlNjQsYCArIGRJbWc7Cgl9CgoJX2Z1bGxTY3JlZW4oZWxlbSkgewoJCXRyeSB7CgkJCWlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQllbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewoJCQkJLyogU2FmYXJpICovCgkJCQllbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKCk7CgkJCX0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBJRTExICovCgkJCQllbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQl9Cgl9CgoJX2NvcHlUZXh0VG9DbGlwYm9hcmQodGV4dCkgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHdpbmRvdy5jb3B5KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQl3aW5kb3cuY29weSh0ZXh0KTsKCQl9IGVsc2UgaWYgKCFuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CgkJCXZhciB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CgkJCXRleHRBcmVhLnZhbHVlID0gdGV4dDsKCgkJCS8vIEF2b2lkIHNjcm9sbGluZyB0byBib3R0b20KCQkJdGV4dEFyZWEuc3R5bGUudG9wID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5sZWZ0ID0gIjAiOwoJCQl0ZXh0QXJlYS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CgoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKCQkJLy90ZXh0QXJlYS5mb2N1cygpOwoJCQl0ZXh0QXJlYS5zZWxlY3QoKTsKCgkJCXRyeSB7CgkJCQl2YXIgc3VjY2Vzc2Z1bCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7CgkJCQl2YXIgbXNnID0gc3VjY2Vzc2Z1bCA/ICdzdWNjZXNzZnVsJyA6ICd1bnN1Y2Nlc3NmdWwnOwoJCQkJY29uc29sZS5sb2coJ0ZhbGxiYWNrOiBDb3B5aW5nIHRleHQgY29tbWFuZCB3YXMgJyArIG1zZyk7CgkJCX0gY2F0Y2ggKGVycikgewoJCQkJY29uc29sZS5lcnJvcignRmFsbGJhY2s6IE9vcHMsIHVuYWJsZSB0byBjb3B5JywgZXJyKTsKCQkJfQoKCQkJZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0ZXh0QXJlYSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCW5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ0FzeW5jOiBDb3B5aW5nIHRvIGNsaXBib2FyZCB3YXMgc3VjY2Vzc2Z1bCEnKTsKCQkJCQlyZXNvbHZlKCk7CgkJCQl9LCBmdW5jdGlvbihlcnIpIHsKCQkJCQljb25zb2xlLmVycm9yKCdBc3luYzogQ291bGQgbm90IGNvcHkgdGV4dDogJywgZXJyKTsKCQkJCQlyZWplY3QoZXJyKTsKCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0ZXh0OwoJfQoKCWFzeW5jIF9yZXNpemVJbWcoaW1nQmFzZTY0LCB3aWR0aCwgaGVpZ2h0LCBtaW1lVHlwZSwgdG9fbWltZVR5cGUpIHsKCQlpZiAoaW1nQmFzZTY0LnNwbGl0KCcsJykubGVuZ3RoID4gMSkgewoJCQlpbWdCYXNlNjQgPSBpbWdCYXNlNjQuc3BsaXQoJywnKVsxXTsKCQl9CgkJdmFyIGltZyA9IG5ldyBJbWFnZSgpOwoJCWltZy5zcmMgPSB0aGlzLmltZyhpbWdCYXNlNjQsIG1pbWVUeXBlKTsKCgkJLy8gY3JlYXRlIGFuIG9mZi1zY3JlZW4gY2FudmFzCgkJdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAoJCQljdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCgkJLy8gc2V0IGl0cyBkaW1lbnNpb24gdG8gdGFyZ2V0IHNpemUKCQljYW52YXMud2lkdGggPSB3aWR0aCB8fCBpbWcud2lkdGg7CgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCB8fCBpbWcuaGVpZ2h0OwoKCQkvLyBkcmF3IHNvdXJjZSBpbWFnZSBpbnRvIHRoZSBvZmYtc2NyZWVuIGNhbnZhczoKCQljdHguZHJhd0ltYWdlKGltZywgMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJCS8vIGVuY29kZSBpbWFnZSB0byBkYXRhLXVyaSB3aXRoIGJhc2U2NCB2ZXJzaW9uIG9mIGNvbXByZXNzZWQgaW1hZ2UKCQlyZXR1cm4gY2FudmFzLnRvRGF0YVVSTCh0b19taW1lVHlwZSB8fCBtaW1lVHlwZSwgMSk7Cgl9CgoJYXN5bmMgX3RlbXBsYXRlKHRtcCwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCS8vY29uc29sZS5sb2coIl9GckVNRDo6X3RlbXBsYXRlKCkiLCB0bXAsIHRtcC5fOwoJCWxldCB0ZW1wbGF0ZSA9IHRtcC5JZCA/IHRtcCA6IChhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zUGFnZVRlbXBsYXRlRmluZCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlUeXBlOiB7CgkJCQlOYW1lOiAiRW50aXR5VGVtcGxhdGUiCgkJCX0sCgkJCU5hbWU6IHRtcC5OYW1lIHx8IHRtcC5uYW1lKCkgfHwgdG1wLnRlbXBsYXRlIHx8IHRtcCwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAnPScKCQkJfQoJCX0pKTsKCQlpZiAodGVtcGxhdGUgJiYgdHlwZW9mKHRlbXBsYXRlLmZpbmQpID09PSAnZnVuY3Rpb24nKSB0ZW1wbGF0ZSA9IGF3YWl0IHRlbXBsYXRlLmZpbmQoKTsKCQlpZiAoIXRlbXBsYXRlKSByZXR1cm4gbnVsbDsKCgkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHRlbXBsYXRlLlNjcmlwdCB8fCB0ZW1wbGF0ZS5zY3JpcHQoKSk7CgkJbGV0IG9iaiA9IG5ldyBzY3JpcHQodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jKTsKCgkJdHJ5IHsKCQkJb2JqLm1haW4gJiYgYXdhaXQgb2JqLm1haW4oKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUubWFpbigpIiwgZXgpOwoJCX0KCgkJdHJ5IHsKCQkJb2JqLnByZUluamVjdCAmJiBhd2FpdCBvYmoucHJlSW5qZWN0KCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnByZUluamVjdCgpIiwgZXgpOwoJCX0KCgkJbGV0IHJldCA9IHsKCQkJU2NyaXB0OiBvYmosCgkJfTsKCgkJbGV0IHRDYWNoZSA9IHt9OwoJCWZvciBhd2FpdCAoY29uc3QgZiBvZiBbJ0JvZHknLCAnRm9vdGVyJywgJ1RpdGxlJ10pIHsKCQkJbGV0IHRmID0gdGVtcGxhdGVbZl07CgkJCWlmICh0eXBlb2YodGVtcGxhdGUuc3RvcmUpID09PSAnZnVuY3Rpb24nKSB0ZiA9IHRlbXBsYXRlW2YudG9Mb3dlckNhc2UoKV0oKTsKCQkJZm9yIGF3YWl0IChjb25zdCBtIG9mIFsuLi4odGYubWF0Y2hBbGwoLyhcW1xbJT0pLltcd1wtLl0rW1wuXSh0bXApW1w6XDpdP1teKCVcXVxdKV0qW1w6XDpdP1teKCVcXVxdKV0qKCVcXVxdKS9nbSkpXSkgewoJCQkJbGV0IHROYW1lUGFydHMgPSBtWzBdLnJlcGxhY2UoJ1tbJT0nLCAnJykucmVwbGFjZSgnJV1dJywgJycpLnJlcGxhY2UoJy50bXAnLCAnJykuc3BsaXQoJzo6Jyk7CgkJCQlsZXQgdE5hbWUgPSB0TmFtZVBhcnRzWzBdOwoJCQkJbGV0IHREYXRhID0gT2JqZWN0LmFzc2lnbihkYXRhLCB7fSk7CgkJCQlpZiAodE5hbWVQYXJ0cy5sZW5ndGggPiAxKSB7CgkJCQkJdERhdGEgPSBPYmplY3QuYXNzaWduKHREYXRhLCBhd2FpdCB0aGlzLnJ1blNjcmlwdCh0TmFtZVBhcnRzWzFdKSk7CgkJCQl9CgkJCQlsZXQgdCA9IGF3YWl0IHRoaXMuX3RlbXBsYXRlKHROYW1lLCBzY29wZSwgdERhdGEsIHBydkZ1bmMpOwoJCQkJdENhY2hlW3ROYW1lXSA9IHRDYWNoZVt0TmFtZV0gfHwgdFtmXTsKCQkJCXRmID0gdGYucmVwbGFjZShtWzBdLCB0Q2FjaGVbdE5hbWVdKTsKCQkJfQoKCQkJcmV0W2ZdID0gdGhpcy5faW5qZWN0KHRmLCBvYmopOwoJCX0KCQljb25zb2xlLmxvZyh0Q2FjaGUpOwoKCQl0cnkgewoJCQlvYmoucG9zdEluamVjdCAmJiBhd2FpdCBvYmoucG9zdEluamVjdChyZXQpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5wb3N0SW5qZWN0KCkiLCBleCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCVRlbXBsYXRlID0gY2xhc3MgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwoJCQl0aGlzLnNjb3BlID0gc2NvcGU7CgkJCXRoaXMub1Njb3BlID0gX0ZyRU1ELl9fc2NvcGUoc2NvcGUpOwoKCQkJdGhpcy5uYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnTm9kZScpOwoJCQl0aGlzLnNjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdTdG9yZWRTY3JpcHQnKTsKCQkJdGhpcy5lYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSAnRXZlbnQnKTsKCQkJdGhpcy5tYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuSXNNYWluKTsKCgkJCXRoaXMuZFNjb3BlID0gKHRoaXMubmMgJiYgdGhpcy5uYy5FbnRpdHlNb2R1bGUpID8gRG90T2JqZWN0LnBpY2sodGhpcy5uYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQl0aGlzLmNtU2NvcGUgPSAodGhpcy5zYyAmJiB0aGlzLnNjLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLnNjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQl0aGlzLmRhdGEgPSBkYXRhOwoKCQkJdGhpcy5uTmFtZSA9IHRoaXMub1Njb3BlLm5OYW1lOwoJCQl0aGlzLmNOYW1lID0gdGhpcy5vU2NvcGUuY05hbWU7CgkJCXRoaXMubkNvZGUgPSB0aGlzLm9TY29wZS5uQ29kZTsKCgkJCXRoaXMucHJ2RnVuYyA9IHBydkZ1bmMgfHwgKCgpID0+IHt9KTsKCQkJdGhpcy5tUmFuayA9IDA7CgoJCQlpZiAoYlJhbmspIHRoaXMubVJhbmsgPSBNYXRoLm1heCgwLCAuLi50aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLm1hcChjID0+IGMuUmFuaykpOyAvLyB1c2VmdWwgaW4gdGVtcGxhdGVzCgoJCQl0aGlzLm1haW5UaXRsZSA9IHRoaXMuZGF0YS5UaXRsZS5zcGxpdCgnLScpWzBdOwoJCQl0aGlzLnN1YlRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLmluZGV4T2YoJy0nKSA+PSAwID8gZGF0YS5UaXRsZS5zcGxpdCgnLScpWzFdIDogIiI7CgkJfQoKCQlfbmV3KGMsIHRvb2wsIGlkKSB7CgkJCWlmICghYykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5Jc01haW4pOwoJCQlpZiAodHlwZW9mKGMpID09PSAnc3RyaW5nJykgYyA9IHRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IGMpOwoJCQlpZiAoIWMpIHJldHVybiBudWxsOwoKCQkJbGV0IG1TY29wZSA9IGMuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoKCQkJcmV0dXJuIG5ldyhtU2NvcGVbdGhpcy5vU2NvcGUubk5hbWUoYyldKShpZCwgdG9vbCk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQljbmYoX2MsIGlkLCBkaWQsIHRvb2wpIHsKCQkJX2MgPSBfYyB8fCB0aGlzLm1jOwoJCQlsZXQgbVNjb3BlID0gX2MuRW50aXR5TW9kdWxlID8gRG90T2JqZWN0LnBpY2soX2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCQkJcmV0dXJuIG1TY29wZS5fbm9kZSA/IG1TY29wZS5fbm9kZS5fX2NvbmZpZyhpZCwgZGlkLCB7CgkJCQl0b29sOiB0b29sCgkJCX0pIDogKHRoaXMuX25ldyhfYywgdG9vbCkuX19jb25maWcoaWQsIGRpZCwgdG9vbCA/IHsKCQkJCXRvb2w6IHRvb2wKCQkJfSA6IHVuZGVmaW5lZCkpOwoJCX0KCgkJblR5cGUoZWEpIHsKCQkJaWYgKGVhLklzU3RyaW5nIHx8IGVhLklzVGV4dCkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgaWYgKGVhLklzQm9vbCkgewoJCQkJcmV0dXJuICJib29sZWFuIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0Zsb2F0KSB7CgkJCQlyZXR1cm4gImZsb2F0IjsKCQkJfSBlbHNlIGlmIChlYS5Jc0ludCB8fCBlYS5Jc0xvbmcpIHsKCQkJCXJldHVybiAibnVtYmVyIjsKCQkJfSBlbHNlIGlmIChlYS5Jc0RhdGUpIHsKCQkJCXJldHVybiAic3RyaW5nIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJfQoKCQlfdChwcm9wLCBvYmosIHNlYXJjaCkgewoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG9ialtwcm9wXTsKCgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX3QiLCBleCk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RTVkcocmV0KSB7CgkJCWxldCBvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCW9EaXYuaWQgPSAnc3ZnUmVuZGVyZXInOwoJCQlsZXQgc3ZnID0gKGF3YWl0IG1lcm1haWQucmVuZGVyKG9EaXYuaWQsIHJldC5Cb2R5KSkuc3ZnOwoJCQl0aGlzLnBydkZ1bmMoYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHlsZT0nb3ZlcmZsb3cteDogYXV0bztkaXNwbGF5OiBibG9jazt3aWR0aDoxMDAlOyBoZWlnaHQ6IDEwMCUnPiR7c3ZnfTwvc3ZnPmApOwoJCX0KCgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJYXdhaXQgdGhpcy5wcnZGdW5jKGA8ZGl2PiR7cmV0LkJvZHl9PC9kaXY+YCk7CgkJfQoKCQlhc3luYyBkZXBsb3kocmV0LCB0eXBlTmFtZSwgbGFuZykgewoJCQl0eXBlTmFtZSA9IHR5cGVOYW1lIHx8ICJCcm93c2VyIjsKCQkJbGV0IHMgPSByZXQuQm9keTsKCQkJaWYgKGxhbmcpIF9GckVNRC5fYmVhdXRpZnkocmV0LkJvZHksIGxhbmcpOwoKCQkJaWYgKHRoaXMubmMpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5kU2NvcGUuTm9kZV9UeXBlKG51bGwsICdHaXRIdWInKS5jb2RlKHR5cGVOYW1lLnRvTG93ZXJDYXNlKCkpLm5hbWUodHlwZU5hbWUpLnJlbWFyayhzKS5zdG9yZSgpOwoJCQl9IGVsc2UgaWYgKHRoaXMuc2MpIHsKCQkJCXJldHVybiBhd2FpdCBuZXcgdGhpcy5jbVNjb3BlLlN0b3JlZFNjcmlwdChudWxsLCAnR2l0SHViJykuYWN0aXZlKHRydWUpLm5hbWUodHlwZU5hbWUpLnNjcmlwdChzKS5zdG9yZSgpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coJ2RlcGxveSgpOiBObyBkZXBsb3ltZW50IG1vZHVsZScpOwoJCQl9CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0VGFibGUocmV0KSB7CgkJCXRoaXMucHJ2RnVuYyhgCjxkaXYgaWQgPSAiZHZQb3N0SW5qZWN0IiBzdHlsZT0nb3ZlcmZsb3dZPXNjcm9sbCc+YCArCgkJCQlERm9ybS5yZW5kZXJFbGVtZW50cyh0aGlzLmVsZW1lbnRzLm1hcCgocywgaSkgPT4gKHsKCQkJCQluYW1lOiBgUk9XJHtpfWAsCgkJCQkJdGl0bGU6ICcgJywKCQkJCQl0eXBlOiAiZ3JpZCIsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlyb3dOdW1iZXJzOiBmYWxzZSwKCQkJCQlwYWdpbmF0aW9uOiBmYWxzZSwKCQkJCQlmcm96ZW46IFtdLAoJCQkJCWNvbHVtbnM6IFt7CgkJCQkJCXRpdGxlOiAiUHJvcGVydHkiLAoJCQkJCQl3aWR0aDogIjMwJSIsCgkJCQkJfSwgewoJCQkJCQl0aXRsZTogIkRlc2NyaXB0aW9uIiwKCQkJCQkJd2lkdGg6ICI3MCUiLAoJCQkJCX1dLAoJCQkJCWRhdGE6IE9iamVjdC5lbnRyaWVzKHMpLm1hcChlID0+ICh7CgkJCQkJCVByb3BlcnR5OiBlWzBdLAoJCQkJCQlEZXNjcmlwdGlvbjogZVsxXQoJCQkJCX0pKSwKCQkJCX0pKSkgKyBgPC9kaXY+CjxzY3JpcHQ+CglzZXRUaW1lb3V0KCgpID0+ICQucGFyc2VyLnBhcnNlKCIjZHZQb3N0SW5qZWN0IiksIDEwMCk7Cjwvc2NyaXB0PmApOwoJCX0KCX07CgoJUHJveHlOb2RlVGVtcGxhdGUgPSBjbGFzcyBleHRlbmRzIHRoaXMuVGVtcGxhdGUgewoJCWNvbnN0cnVjdG9yKHRlbXBsYXRlLCBzY29wZSwgZGF0YSwgcHJ2RnVuYywgYlJhbmspIHsKCQkJc3VwZXIodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuayk7CgkJfQoKCQlhc3luYyBwcmVJbmplY3QoKSB7CgkJCXRoaXMudXJsUmVnZXggPSBgKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pYDsKCQl9CgoJCWNydWRNZXRob2RzKGMsIHR5cGUpIHsKCQkJcmV0dXJuIFt7CgkJCQlOYW1lOiAnc3RvcmUnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kQWxsJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJSXNBcnJheTogdHJ1ZSwKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX0sIHsKCQkJCU5hbWU6ICdmaW5kJywKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiB7CgkJCQkJRW50aXR5VHlwZTogYwoJCQkJfQoJCQl9XS5tYXAobSA9PiB7CgkJCQltW3R5cGVdID0gY1t0eXBlXSA/IGNbdHlwZV1bbS5OYW1lXSA6IG51bGw7CgkJCQltLklzUHVibGljID0gdHJ1ZTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IFtdOwoJCQkJcmV0dXJuIG07CgkJCX0pOwoJCX0KCX07CgoJUGxhbnRVTUxUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJYXN5bmMgcG9zdEluamVjdChyZXQpIHsKCQkJbGV0IGh0bWwgPSByZXQuQm9keS5yZXBsYWNlKC9AZW5kdW1sL2csIGBsZWZ0IGZvb3RlciAkeydcdTAwQTknfSR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke3RoaXMuZGF0YS5Db3B5cmlnaHQgfHwgJ0RyLiBGYWRpIE5hbW1vdXInfSwgQWxsIHJpZ2h0cyByZXNlcnZlZC5cblxuQGVuZHVtbGApLnNwbGl0KCdAZW5kdW1sJykubWFwKGIgPT4gYDxpbWcgc3R5bGU9J292ZXJmbG93LXg6IGF1dG87ZGlzcGxheTogYmxvY2s7IGhlaWdodDogMTAwJScgc3JjPSdodHRwczovL3d3dy5wbGFudHVtbC5jb20vcGxhbnR1bWwvcG5nLyR7dGhpcy56b3AoYisnQGVuZHVtbCcpfScvPmApLmpvaW4oJzxici8+Jyk7CgoJCQl0aGlzLnBydkZ1bmMoJChgPGRpdiBzdHlsZT0id2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb3ZlcmZsb3cteTogc2Nyb2xsOyI+JHtodG1sfTwvZGl2PmApKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCXpvcChzKSB7CgkJCXMgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQocykpOwoJCQl2YXIgYXJyID0gW107CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgYXJyLnB1c2gocy5jaGFyQ29kZUF0KGkpKTsKCQkJbGV0IHogPSBuZXcgWm9wZmxpLlJhd0RlZmxhdGUoYXJyKS5jb21wcmVzcygpOwoJCQlyZXR1cm4gdGhpcy5lbmNvZGU2NF8oeik7CgkJfQoKCQllbmNvZGU2NF8oZGF0YSkgewoJCQlsZXQgciA9ICIiOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDMpIHsKCQkJCWlmIChpICsgMiA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIDApOwoJCQkJfSBlbHNlIGlmIChpICsgMSA9PSBkYXRhLmxlbmd0aCkgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgMCwgMCk7CgkJCQl9IGVsc2UgewoJCQkJCXIgKz0gdGhpcy5hcHBlbmQzYnl0ZXMoZGF0YVtpXSwgZGF0YVtpICsgMV0sIGRhdGFbaSArIDJdKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcjsKCQl9CgoJCWFwcGVuZDNieXRlcyhiMSwgYjIsIGIzKSB7CgkJCWxldCBjMSA9IGIxID4+IDI7CgkJCWxldCBjMiA9ICgoYjEgJiAweDMpIDAxOTVlNmZlZmZmODc3OTliMWI0NDg5NTAyZmU0Y2Y0IDQpOwoJCQlsZXQgYzMgPSAoKGIyICYgMHhGKSAwMTk1ZTZmZWZmZjg3Nzk5YjFiNDRmNzI3Njg2OWVmZCA2KTsKCQkJbGV0IGM0ID0gYjMgJiAweDNGOwoJCQlsZXQgciA9ICIiOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMSAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMiAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjMyAmIDB4M0YpOwoJCQlyICs9IHRoaXMuZW5jb2RlNmJpdChjNCAmIDB4M0YpOwoJCQlyZXR1cm4gcjsKCQl9CgoJCWVuY29kZTZiaXQoYikgewoJCQlpZiAoYiA8IDEwKSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg0OCArIGIpOwoJCQl9CgkJCWIgLT0gMTA7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPCAyNikgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBiKTsKCQkJfQoJCQliIC09IDI2OwoJCQlpZiAoYiA9PSAwKSB7CgkJCQlyZXR1cm4gJy0nOwoJCQl9CgkJCWlmIChiID09IDEpIHsKCQkJCXJldHVybiAnXyc7CgkJCX0KCQkJcmV0dXJuICc/JzsKCQl9Cgl9OwoKCXRvQmFzZTY0KHVybCwgZGF0YSwgbWltZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLCBiUmF3KSB7CgkJcmV0dXJuIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt1cmwgPyB0aGlzLl9pbmplY3QoJC5hamF4KHsKCQkJdXJsOiB1cmwgKyAnPycgKyBNYXRoLnJhbmRvbSgpLAoJCQlhc3luYzogZmFsc2UKCQl9KS5yZXNwb25zZVRleHQsIGRhdGEpIDogKGJSYXcgPyBkYXRhIDogSlNPTi5zdHJpbmdpZnkoZGF0YSkpXSwgewoJCQl0eXBlOiBtaW1lCgkJfSkpOwoJfQoKCV9zdmdCYXNlNjQodHh0KSB7CgkJdHJ5IHsKCQkJbWVybWFpZC5tZXJtYWlkQVBJLmluaXRpYWxpemUoewoJCQkJInRoZW1lIjogImRlZmF1bHQiLAoJCQkJInNlY3VyaXR5TGV2ZWwiOiAibG9vc2UiLAoJCQkJIm1heFRleHRTaXplIjogOTAwMDAwMDAsCgkJCX0pOwoKCQkJcmV0dXJuICdkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LCcgKyB0aGlzLl9idG9hKG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoJChtZXJtYWlkLm1lcm1haWRBUEkucmVuZGVyKCdncmFwaERpdicsIHR4dCkpWzBdKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIHR4dDsKCQl9Cgl9CgoJX3BydW5lKG9iaikgewoJCWlmICh0eXBlb2Yob2JqKSA9PT0gInVuZGVmaW5lZCIgfHwgb2JqID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiKSByZXR1cm4gb2JqOwoJCWlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKCQkJbGV0IHJldCA9IG9iai5tYXAodiA9PiB0aGlzLl9wcnVuZSh2KSkuZmlsdGVyKHYgPT4gdik7CgkJCXJldHVybiByZXQubGVuZ3RoID8gcmV0IDogbnVsbDsKCQl9CgoJCWxldCByZXQgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5PYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB2YWx1ZSA/ICh7CgkJCVtrZXldOiB0aGlzLl9wcnVuZSh2YWx1ZSkKCQl9KSA6IG51bGwpKTsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5sZW5ndGggPyByZXQgOiBudWxsOwoJfQoKCXZhbGlkVVJMKHN0cikgewoJCXZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXihodHRwcz86XFwvXFwvKT8nICsgLy8gcHJvdG9jb2wKCQkJJygoKFthLXpcXGRdKFthLXpcXGQtXSpbYS16XFxkXSkqKVxcLikrW2Etel17Mix9fCcgKyAvLyBkb21haW4gbmFtZQoJCQknKChcXGR7MSwzfVxcLil7M31cXGR7MSwzfSkpJyArIC8vIE9SIGlwICh2NCkgYWRkcmVzcwoJCQknKFxcOlxcZCspPyhcXC9bLWEtelxcZCVfLn4rXSopKicgKyAvLyBwb3J0IGFuZCBwYXRoCgkJCScoXFw/WzsmYS16XFxkJV8ufis9LV0qKT8nICsgLy8gcXVlcnkgc3RyaW5nCgkJCScoXFwjWy1hLXpcXGRfXSopPyQnLCAnaScpOyAvLyBmcmFnbWVudCBsb2NhdG9yCgkJcmV0dXJuICEhcGF0dGVybi50ZXN0KHN0cik7Cgl9CgoJX3RvSlMobykgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YobykgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gJ3VuZGVmaW5lZCc7CgoJCQlyZXR1cm4gYEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKFxgJHt0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KG8sICh0LG4pPT4iZnVuY3Rpb24iPT09dHlwZW9mIG4/bi50b1N0cmluZygpOm4pKX1cYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSlgOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfdG9KUzogIiArIGV4LnRvU3RyaW5nKCkpOwoJCX0KCX0KCglfYXRvYihhKSB7CgkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCX0KCglfYnRvYShiKSB7CgkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJfQoKCV9hdHRyKGVhKSB7CgkJdHJ5IHsKCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfQoKCV9zcWxUeXBlKGVhLCBkYlR5cGUpIHsKCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJY2FzZSAiU3RyaW5nIjoKCQkJY2FzZSAnJzoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiVGV4dCI6CgkJCWNhc2UgIk9iamVjdCI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSR7ZGJUeXBlPT0ncG9zdGdyZXMnPycnOicoNDAwMCknfWA7CgkJCWNhc2UgIkJvb2wiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQklUKDEpJzonVElOWUlOVCd9YDsgLy9CSVQKCQkJY2FzZSAiRGF0ZSI6CgkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0ncG9zdGdyZXMnPydUSU1FU1RBTVAnOidEQVRFVElNRSd9YDsKCQkJY2FzZSAiSW50IjoKCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCWNhc2UgIkxvbmciOgoJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQljYXNlICJFbnRpdHkiOgoJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQljYXNlICJJbWFnZSI6CgkJCWNhc2UgIkZpbGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nQllURUEnOiJCTE9CIn1gOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJfQoJfQoKCXBhdGhUb05hbWUoZk5hbWUsIGV4dCkgewoJCWlmIChmTmFtZS5pbmRleE9mKCcvJykgPj0gMCkgZk5hbWUgPSBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykucmV2ZXJzZSgpLnJlZHVjZSgodiwgZSkgPT4gdiArICdfX1snICsgZSkgKyBmTmFtZS5zcGxpdCgnLicpWzBdLnNwbGl0KCcvJykuc2xpY2UoMSkucmVkdWNlKHYgPT4gdiArICddJywgJ19fbnVsbCcpICsgKChmTmFtZS5zcGxpdCgnLicpLmxlbmd0aCA+IDEpID8gKCcuJyArIGZOYW1lLnNwbGl0KCcuJylbMV0pIDogZXh0KTsKCQlyZXR1cm4gZk5hbWU7Cgl9CgoJYXN5bmMgaW1wb3J0KG1vZHVsZSwgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuZXh0ID0gb3B0aW9ucy5leHQgfHwgJ2pzJzsKCgkJaWYgKEFycmF5LmlzQXJyYXkobW9kdWxlKSkgewoJCQlsZXQgcmV0ID0gW107CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCXJldC5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KG0sIG9wdGlvbnMpKTsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdHJ5IHsKCQkJcmV0dXJuIGF3YWl0IGltcG9ydChtb2R1bGUpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBtb2R1bGUgKyAiKSBFeGNlcHRpb246ICIgKyBleCk7CgkJfQoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5wcmVDb21waWxlKHsKCQkJX2NvZGU6IG1vZHVsZQoJCX0pOwoKCQlsZXQgZk5hbWUgPSB3aW5kb3cuYkxvY2FsID8gKG1vZHVsZSArICIuIiArIG9wdGlvbnMuZXh0KSA6ICgiY29tL25hbW1vdXIvY21zL0hUTUxQYWdlLyIgKyB0aGlzLnBhdGhUb05hbWUodGhpcy5oYXNoLnNjb3BlLnJlcGxhY2UoL1wgL2csICcnKS50b0xvd2VyQ2FzZSgpICsgIi8iICsgbW9kdWxlICsgIi5qc29uIikpOwoKCQlyZXQgPSByZXQgfHwgYXdhaXQgdGhpcy5fZ2V0KGZOYW1lLCB0cnVlKTsKCgkJaWYgKCFyZXQgJiYgdGhpcy5zcigpICYmIHR5cGVvZih0aGlzLnNyKCkuXykgPT09ICdmdW5jdGlvbicgJiYgd2luZG93LmJMb2NhbCkgcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJUGFnZTogbW9kdWxlCgkJfSk7CgoJCWNvbnNvbGUubG9nKCJGckVNRDo6aW1wb3J0KCIgKyBmTmFtZSArICIpOiAiICsgKHJldCA/ICJTdWNjZXNzIiA6ICJGYWlsZWQiKSwgb3B0aW9ucyk7CgoJCWlmIChyZXQgJiYgKCF3aW5kb3cuYkxvY2FsIHx8IG9wdGlvbnMuZXh0ID09ICdqcycpKSByZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXQsIG9wdGlvbnMuYXN5bmMpOwoJCWlmIChyZXQgJiYgb3B0aW9ucy5maWVsZCAmJiB0eXBlb2YocmV0W29wdGlvbnMuZmllbGRdKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjppbXBvcnQoIiArIGZOYW1lICsgIik6IEdPVCBIRVJFIiwgcmV0LCBvcHRpb25zKTsKCQkJcmV0ID0gcmV0W29wdGlvbnMuZmllbGRdOwoJCQlpZiAoIXdpbmRvdy5iTG9jYWwpIHJldCA9IGF0b2IocmV0KTsKCQkJaWYgKG9wdGlvbnMuZXh0ID09ICdqcycpIHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHJldCwgb3B0aW9ucy5hc3luYyk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyByZXF1aXJlKGxpYk5hbWUsIGhyZWZzLCBsb2FkZXIpIHsKCQlsZXQgX2hyZWZzID0gW107CgkJaWYgKGhyZWZzICYmIHRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gKGhyZWZzLmxlbmd0aCA+IHRoaXMuaHJlZnMubGVuZ3RoKSA/IGhyZWZzIDogdGhpcy5ocmVmczsKCQl9IGVsc2UgaWYgKCF0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IGhyZWZzOwoJCX0gZWxzZSBpZiAodGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSB0aGlzLmhyZWZzOwoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBfaHJlZnMuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBfaHJlZnMsIGxvYWRlcik7CgkJCX0KCgkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCWlmIChjKSB0aGlzLl9jc3MoYyk7CgkJCQl9CgkJCX0KCgkJCXZhciBtb2R1bGVzID0gW107CgkJCWlmIChsb2FkZXIpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJsb2FkZXIoKVsiICsgbi5saWIgKyAiXTogIiwgdHlwZW9mKG4ubG9hZCkpOwoJCQkJbGV0IGxkciA9IGF3YWl0IGxvYWRlcihuKTsKCQkJCWlmIChsZHIpIG1vZHVsZXMucHVzaChsZHIpOwoJCQl9CgoJCQlpZiAodHlwZW9mKG4uc3JjKSA9PT0gJ3VuZGVmaW5lZCcgJiYgbi5zY3JpcHQgJiYgIW1vZHVsZXMubGVuZ3RoKSB7CgkJCQlpZiAodHlwZW9mKG4uc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgbi5zY3JpcHQgPSBuLnNjcmlwdCgpOwoJCQkJbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdChuLnNjcmlwdCwgbi5ub1J1bikpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgKEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKS5maWx0ZXIocyA9PiBzKSkgewoJCQkJdHJ5IHsKCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHMpOwoJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IHRoaXMuaW1wb3J0KHMpKTsKCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihzKSA9PT0gJ3N0cmluZycpIHsKCQkJCQkJbGV0IGpzRXh0ID0gIShbJ2pzdCddLnNvbWUoZSA9PiBzLmVuZHNXaXRoKCcuJyArIGUpKSk7CgkJCQkJCWlmICh0eXBlb2YoV29ya2VyR2xvYmFsU2NvcGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQkJLy8gYSB3ZWItd29ya2VyCgkJCQkJCQlpbXBvcnRTY3JpcHRzKHMpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICd1bmRlZmluZWQnICYmIGpzRXh0KSB7CgkJCQkJCQkvLyBkb2N1bWVudCBzaG91bGQgbG9hZCB0aGUgc2NyaXB0IHdoZW5ldmVyIHBvc3NpYmxlCgkJCQkJCQkvKnJldHVybiAqLwoJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCQkJCQlzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcjsKCQkJCQkJCQlzY3JpcHQub25lcnJvciA9IHI7CgkJCQkJCQkJc2NyaXB0LmFzeW5jID0gZmFsc2U7CgkJCQkJCQkJc2NyaXB0LnNyYyA9IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpOwoJCQkJCQkJCS8vY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl06ICIgKyBzKTsKCQkJCQkJCQkoZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5ib2R5KS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJfSkpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaEluamVjdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWF3YWl0IGZldGNoSW5qZWN0KG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpKTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZmV0Y2gpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5fZ2V0KHMsIHRydWUpOwoJCQkJCQkJaWYgKHJlcykgewoJCQkJCQkJCWlmIChqc0V4dCB8fCBuLmxvYWQpIG1vZHVsZXMucHVzaChyZXQgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChyZXMpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IHJlczsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiIsIGV4LCBzKTsKCQkJCX0KCQkJfQoKCQkJaWYgKG4ubG9hZCkgewoJCQkJdHJ5IHsKCQkJCQkvL2NvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdOiBjYWxsaW5nIGxvYWQoKSIpOwoJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBtb2R1bGVzLCBleCk7CgkJCQl9CgkJCX0KCQl9CgkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgcG9zdEluaXQoKSB7CgkJdHJ5IHsKCQkJd2luZG93LmZyYW1lc1swXS5yZVJlbmRlciA/IHdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIoKSA6IG51bGw7CgkJfSBjYXRjaCAoZXgpIHt9CgoJCXRyeSB7CgkJCWxldCBldmVudHMgPSBhd2FpdCB0aGlzLnJlcXVpcmUoIkV2ZW50cyIpOwoJCQlpZiAoIWV2ZW50cyAmJiBjb21wYW55LkV2ZW50cykgewoJCQkJZXZlbnRzID0gYXdhaXQgY29tcGFueS5FdmVudHMoKTsKCQkJfQoJCQkoZXZlbnRzIHx8IFtdKS5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZm9yRWFjaChldiA9PiB7CgkJCQkkKGV2Ll9wYXRoLCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50KS5vbihldi5fZXZlbnQsIGV2Ll9oYW5kbGVyKTsKCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHt9Cgl9CgoJZXhjZWxUb0pTT04oZGF0YSwgc3RhcnQsIGNvdW50KSB7CgkJaWYgKHR5cGVvZihYTFNYKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKCQl0cnkgewoJCQl2YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZGF0YSwgewoJCQkJdHlwZTogJ2JpbmFyeScsCgkJCQlzaGVldFJvd3M6IDAgLypzdGFydCArICItIiArIChzdGFydCArIGNvdW50KSovCgkJCX0pOwoJCQkvL3ZhciByYW5nZSA9IFhMU1gudXRpbHMuZGVjb2RlX3JhbmdlKHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXVsnIXJlZiddKTsKCQkJdmFyIHNoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3dvcmtib29rLlNoZWV0TmFtZXNbMF1dOwoJCQlyZXR1cm4gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vdGhyb3cgZTsKCQkJY29uc29sZS5sb2coIkVSUk9SOiIsIGUpOwoJCQlyZXR1cm4gW107CgkJfQoJfQoKCWFzeW5jIF91bnppcChmaWxlKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWxldCBmID0gYXdhaXQgemlwLmxvYWQoZmlsZSwgewoJCQliYXNlNjQ6IHRydWUKCQl9KQoJfQoKCWFzeW5jIF96aXAoZmlsZXMpIHsKCQl2YXIgemlwID0gbmV3IEpTWmlwKCk7CgkJZmlsZXMuZm9yRWFjaChmID0+IHsKCQkJemlwLmZpbGUoZi5uYW1lLCBmLmZpbGUpOwoJCX0pOwoJCWxldCByZXQgPSBhd2FpdCB6aXAuZ2VuZXJhdGUoewoJCQl0eXBlOiAnYmxvYicsCgkJCWNvbXByZXNzaW9uOiAiREVGTEFURSIKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCVV0ZjhBcnJheVRvU3RyKGFycmF5KSB7CgkJdmFyIG91dCwgaSwgbGVuLCBjOwoJCXZhciBjaGFyMiwgY2hhcjM7CgoJCW91dCA9ICIiOwoJCWxlbiA9IGFycmF5Lmxlbmd0aDsKCQlpID0gMDsKCQl3aGlsZSAoaSA8IGxlbikgewoJCQljID0gYXJyYXlbaSsrXTsKCQkJc3dpdGNoIChjID4+IDQpIHsKCQkJCWNhc2UgMDoKCQkJCWNhc2UgMToKCQkJCWNhc2UgMjoKCQkJCWNhc2UgMzoKCQkJCWNhc2UgNDoKCQkJCWNhc2UgNToKCQkJCWNhc2UgNjoKCQkJCWNhc2UgNzoKCQkJCQkvLyAweHh4eHh4eAoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxMjoKCQkJCWNhc2UgMTM6CgkJCQkJLy8gMTEweCB4eHh4ICAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCW91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MUYpIDw8IDYpIHwgKGNoYXIyICYgMHgzRikpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAxNDoKCQkJCQkvLyAxMTEwIHh4eHggIDEweHggeHh4eCAgMTB4eCB4eHh4CgkJCQkJY2hhcjIgPSBhcnJheVtpKytdOwoJCQkJCWNoYXIzID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDBGKSA8PCAxMikgfAoJCQkJCQkoKGNoYXIyICYgMHgzRikgPDwgNikgfAoJCQkJCQkoKGNoYXIzICYgMHgzRikgPDwgMCkpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3V0OwoJfQoKCWFzeW5jIF9jb21wcmVzcyhzdHIpIHsKCQljb25zdCBieXRlQXJyYXkgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3RyKTsKCQljb25zdCBjcyA9IG5ldyBDb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpOwoJCWNvbnN0IHdyaXRlciA9IGNzLndyaXRhYmxlLmdldFdyaXRlcigpOwoJCXdyaXRlci53cml0ZShieXRlQXJyYXkpOwoJCXdyaXRlci5jbG9zZSgpOwoJCXJldHVybiBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCkKCgkJLy8gQ29udmVydCB0aGUgc3RyaW5nIHRvIGEgYnl0ZSBzdHJlYW0uCgkJY29uc3Qgc3RyZWFtID0gbmV3IEJsb2IoW3N0cl0pLnN0cmVhbSgpOwoKCQkvLyBDcmVhdGUgYSBjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKQoJCSk7CgoJCS8vIFJlYWQgYWxsIHRoZSBieXRlcyBmcm9tIHRoaXMgc3RyZWFtLgoJCWNvbnN0IGNodW5rcyA9IFtdOwoJCWZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCXJldHVybiBhd2FpdCBuZXcgVWludDhBcnJheShhd2FpdCBuZXcgQmxvYihjaHVua3MpLmFycmF5QnVmZmVyKCkpOwoJfQoKCWFzeW5jIF9kZWNvbXByZXNzKGNvbXByZXNzZWRCeXRlcykgewoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtjb21wcmVzc2VkQnl0ZXNdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgZGVjb21wcmVzc2VkIHN0cmVhbS4KCQljb25zdCBkZWNvbXByZXNzZWRTdHJlYW0gPSBzdHJlYW0ucGlwZVRocm91Z2goCgkJCW5ldyBEZWNvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGRlY29tcHJlc3NlZFN0cmVhbSkgewoJCQljaHVua3MucHVzaChjaHVuayk7CgkJfQoJCWNvbnN0IHN0cmluZ0J5dGVzID0gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCgkJLy8gQ29udmVydCB0aGUgYnl0ZXMgdG8gYSBzdHJpbmcuCgkJcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShzdHJpbmdCeXRlcyk7Cgl9CgoJYXN5bmMgZG93bmxvYWRTUkNhY2hlKGNvZGUsIGZpbGVuYW1lKSB7CgkJLy8gdG8gYmUgbW92ZWQgb3V0IG9mIHRoaXMgY2xhc3MKCQljb2RlID0gY29kZSB8fCBjb21wYW55LkNvZGU7CgkJbGV0IGZpbGVzID0gYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmRhbGwnLCBudWxsLCB7CgkJCUNvZGU6IGNvZGUgKyAnLScsCgkJfSk7CgkJcmV0dXJuIGF3YWl0IHRoaXMuX3ppcChmaWxlcy5tYXAociA9PiAoewoJCQluYW1lOiByLkNvZGUucmVwbGFjZShjb2RlICsgJy0nLCAnJykgKyAnLmpzJywKCQkJZmlsZTogci5SZXN1bHQKCQl9KSksIGZpbGVuYW1lIHx8ICdzckNhY2hlLnppcCcpOwoJfQoKCWFzeW5jIF9nZXRCbG9jayhibG9jaykgewoJCXZhciBqcyA9IG51bGw7CgkJdmFyIGh0bWwgPSBudWxsOwoJCXZhciBjc3MgPSBudWxsOwoKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCWlmICh0aGlzLmFwaVNlcnZlciAmJiB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpKSB7CgkJCWNvbnNvbGUubG9nKCJfZ2V0QmxvY2soIiArIGJsb2NrICsgIikgdXNpbmcgYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUpOwoJCQlsZXQgcCA9IGF3YWl0IHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykuX2Zyb21GaWxlTmFtZSh0aGlzLnBhdGhUb05hbWUodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpKS5maW5kKCk7CgkJCWlmIChwKSB7CgkJCQlodG1sID0gcC5ib2R5KCkgfHwgJyc7CgkJCQlqcyA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHAuc2NyaXB0KCkpOwoJCQkJY3NzID0gcC5zdHlsZSgpIHx8ICcnOwoJCQl9CgkJfSBlbHNlIHsKCQkJanMgPSBhd2FpdCB0aGlzLmltcG9ydCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2ssIHsKCQkJCWV4dDogJ2pzJywKCQkJCWZpZWxkOiAnc2NyaXB0JywKCQkJfSk7CgoJCQlodG1sID0gYXdhaXQgdGhpcy5pbXBvcnQoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrLCB7CgkJCQlleHQ6ICdodG0nLAoJCQkJZmllbGQ6ICdib2R5JywKCQkJfSk7CgkJfQoKCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCXRyeSB7CgkJCQl2YXIgb2JqID0gbmV3IGpzKCk7CgkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJdGhpcy5ibG9ja3NbYmxvY2tdLm9iaiA9IG9iajsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyAiICsgYmxvY2sgKyAiLm1haW4oKSIpOwoJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhleCk7CgkJCX0KCQl9CgkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSBodG1sOwoKCQlpZiAoanMgJiYgIXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvd1tibG9jayArICJDb21wb25lbnQiXSkgewoJCQl0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCA9ICI8IiArIGJsb2NrICsgIkNvbXBvbmVudC8+IjsKCQl9CgoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCh3aW5kb3cuYkxvY2FsID8gIi4uL2Vtcy8iIDogIiIpICsgInNjcmlwdC9tb2R1bGVzIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmhyZWZzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiAnTW9kdWxlcycKCQkJCX0pOwoJCQl9CgkJCWF3YWl0IHRoaXMucmVxdWlyZSgnSlF1ZXJ5Jyk7CgkJfQoKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl0aGlzLmZyb21IYXNoKCk7CgkJJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgYXN5bmMgKCkgPT4gewoJCQl0aGlzLmZyb21IYXNoKCk7CgkJCWlmICh0aGlzLmFsbERhdGEgJiYgdGhpcy5hbGxEYXRhLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgJiYgdGhpcy5oYXNoLnBhZ2UgIT0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUgJiYgdGhpcy5lbmRDYWxsZWQpIHsKCQkJCWlmICh3aW5kb3cuZnJhbWVzLmxlbmd0aCkgewoJCQkJCS8vIGZyYW1lLWJhc2VkIHRlbXBsYXRlCgkJCQkJYXdhaXQgdGhpcy5pbml0RE9NKCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJGckVNRDo6cHJlSW5pdCgpOiBoYXNoY2hhbmdlIHRyaWdnZXJlZCwgbG9hZGluZyBwYWdlICIgKyB0aGlzLmhhc2gucGFnZSk7CgkJCQkJYXdhaXQgdGhpcy5SZW5kZXJQYWdlKHsKCQkJCQkJX2NvZGU6IHRoaXMuaGFzaC5wYWdlCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJYXdhaXQgdGhpcy5yZXF1aXJlKCJTY2hlbWEiKTsKCQkvL2F3YWl0IHRoaXMucmVxdWlyZSgiRHluYUZvcm0iKTsgY29tcGFueS5SZXF1aXJlZAoKCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgewoJCQlpZiAoY29tcGFueS5PbkJlZm9yZVJlcXVpcmUpIGF3YWl0IGNvbXBhbnkuT25CZWZvcmVSZXF1aXJlKCk7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBjb21wYW55LlJlcXVpcmVkIHx8IFtdKSB7CgkJCQlhd2FpdCB0aGlzLnJlcXVpcmUobCk7CgkJCX0KCQl9CgoJCS8vIGZhaWxzYWZlCgkJYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJTmFtZTogIkNvbnRlbnQgTWFuYWdlciIsCgkJCUVuYWJsZWQ6IHRydWUsCgkJfSksICJjb250ZW50bWFuYWdlciIpOwoKCQlhd2FpdCB0aGlzLl9tYW5pZmVzdCgpOwoKCQljb25zb2xlLmxvZygiRG9uZSBMb2FkaW5nIik7Cgl9CgoJYXN5bmMgX21hbmlmZXN0KHNjb3BlLCBqc29uKSB7CgkJdHJ5IHsKCQkJaWYgKCFqc29uKSB7CgkJCQlqc29uID0gYXdhaXQgdGhpcy5fZXhwb3J0KHsKCQkJCQl0ZW1wbGF0ZTogIk1BTklGRVNUIgoJCQkJfSwgc2NvcGUpOwoJCQl9CgkJCWxldCBocmVmID0gdGhpcy50b0Jhc2U2NChudWxsLCBqc29uLCAnYXBwbGljYXRpb24vbWFuaWZlc3QranNvbicsIHRydWUpOwoJCQlpZiAodGhpcy5fbWFuQ3NzKSB7CgkJCQl0aGlzLl9tYW5Dc3MuYXR0cigiaHJlZiIsIGhyZWYpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5fbWFuQ3NzID0gdGhpcy5fY3NzKGhyZWYsICdtYW5pZmVzdCcpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBsb2FkaW5nIG1hbmlmZXN0IiwgZXgpOwoJCX0KCX0KCglhc3luYyBfZXhwb3J0KHRtcCwgc2NvcGUsIG9wdGlvbnMgPSB7fSkgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IHRlbXBsYXRlID0gdG1wLmNvbnRlbnQgfHwgYXdhaXQgdGhpcy5fZ2V0KGAke3RtcC5wYXRofHwoJ3RlbXBsYXRlcycgKyB0aGlzLm0oKSArICcvJyl9JHt0bXAudGVtcGxhdGV9LiR7dG1wLmV4dHx8J2pzdCd9YCwgdHJ1ZSk7CgkJbGV0IHJldCA9IHRoaXMuX2luamVjdCh0ZW1wbGF0ZSwgewoJCQlvU2NvcGU6IHRoaXMuX19zY29wZShzY29wZSksCgkJCW1lOiB3aW5kb3cubWUsCgkJCXNjb3BlLAoJCQlvcHRpb25zLAoJCX0sIG9wdGlvbnMuZW5naW5lKTsKCgkJaWYgKHRoaXMuX2JlYXV0aWZ5KSByZXQgPSB0aGlzLl9iZWF1dGlmeShyZXQsIHRtcC5sYW5ndWFnZSk7CgkJaWYgKHJldCAmJiB0eXBlb2YocmV0LnJlcGxhY2UpID09PSAnZnVuY3Rpb24nICYmICF0bXAubGFuZ3VhZ2UpIHsKCQkJcmV0ID0gcmV0LnJlcGxhY2UoL15ccyokKD86XHJcbj98XG4pL2dtLCAnJyk7IC8vIHJlbW92ZSBlbXB0eSBsaW5lcwoJCX0KCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGluaXRET00oKSB7CgkJd2luZG93Ll9GckVNRCA9IHRoaXM7CgkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwoJCWF3YWl0IHRoaXMucHJlSW5pdCgpOwoJCXRoaXMuaGFzaC5wYWdlID0gdGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JzsKCgkJdHJ5IHsKCQkJYXdhaXQgKChjb21wYW55ICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgPyBjb21wYW55Lk9uUGFnZUxvYWQgOiBhc3luYyAoKSA9PiB7fSkoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRnJFTUQuaW5pdERPTS5PblBhZ2VMb2FkIiwgZXgpOwoJCX0KCgkJaWYgKGNvbXBhbnkuUmVxdWlyZWQuaW5kZXhPZigna25vY2tvdXQnKSA8IDAgJiYgIXdpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24uaG9zdG5hbWUpIHsKCQkJbGV0IHVybCA9ICd3ZWJzaXRlLycgKyB0aGlzLmhhc2gucGFnZSArICcuJyArIChjb21wYW55LmV4dGVuc2lvbiB8fCAnaHRtJykgKyAnP3JhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMuX2dldCh1cmwpOwoJCQlodG1sID0gdGhpcy5faW5qZWN0KGh0bWwsIHdpbmRvdy5wYXJlbnQpOwoKCQkJY29uc3QgZG9tcCA9IG5ldyBET01QYXJzZXIoKTsKCQkJbGV0IGRvYyA9IGRvbXAucGFyc2VGcm9tU3RyaW5nKGh0bWwsICJ0ZXh0L2h0bWwiKTsKCQkJYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyhkb2MpOwoJCQljb25zb2xlLmxvZygiaHRtbCBiaW5kaW5nIGRvbmUhIik7CgoJCQlodG1sID0gZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUw7CgkJCS8vaHRtbCA9ICd0ZXN0JzsKCgkJCS8vd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbiA9IHVybDsKCQkJd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC53cml0ZShodG1sKTsKCQl9CgoJCWF3YWl0IHRoaXMuX2JpbmRLTygpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglhc3luYyBfYmluZEtPKCkgewoJCWlmIChjb21wYW55LlJlcXVpcmVkLmluZGV4T2YoJ2tub2Nrb3V0JykgPj0gMCkgewoJCQlzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKCQkJCS8vYXdhaXQgdGhpcy5fYXBwbHlCaW5kaW5ncyh3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCB0cnVlKTsKCgkJCQlrby5jbGVhbk5vZGUod2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCWtvLmFwcGx5QmluZGluZ3Mod2luZG93LCB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LmJvZHkpOwoJCQkJd2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJfSwgMzAwKTsKCQl9Cgl9CgoJX3NldChvYmosIHBhdGgsIHZhbCkgewoJCXZhciBzdHJpbmdUb1BhdGggPSBmdW5jdGlvbihwYXRoKSB7CgkJCS8vIElmIHRoZSBwYXRoIGlzbid0IGEgc3RyaW5nLCByZXR1cm4gaXQKCQkJaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgcmV0dXJuIHBhdGg7CgkJCS8vIENyZWF0ZSBuZXcgYXJyYXkKCQkJdmFyIG91dHB1dCA9IFtdOwoJCQkvLyBTcGxpdCB0byBhbiBhcnJheSB3aXRoIGRvdCBub3RhdGlvbgoJCQlwYXRoLnNwbGl0KCcuJykuZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpbmRleCkgewoJCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBicmFja2V0IG5vdGF0aW9uCgkJCQlpdGVtLnNwbGl0KC9cWyhbXn1dKylcXS9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQkJCS8vIFB1c2ggdG8gdGhlIG5ldyBhcnJheQoJCQkJCWlmIChrZXkubGVuZ3RoID4gMCkgewoJCQkJCQlvdXRwdXQucHVzaChrZXkpOwoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9OwoJCS8vIENvbnZlcnQgdGhlIHBhdGggdG8gYW4gYXJyYXkgaWYgbm90IGFscmVhZHkKCQlwYXRoID0gc3RyaW5nVG9QYXRoKHBhdGgpOwoJCS8vIENhY2hlIHRoZSBwYXRoIGxlbmd0aCBhbmQgY3VycmVudCBzcG90IGluIHRoZSBvYmplY3QKCQl2YXIgbGVuZ3RoID0gcGF0aC5sZW5ndGg7CgkJdmFyIGN1cnJlbnQgPSBvYmo7CgkJLy8gTG9vcCB0aHJvdWdoIHRoZSBwYXRoCgkJcGF0aC5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKCQkJLy8gQ2hlY2sgaWYgdGhlIGFzc2lnbmVkIGtleSBzaG91bCBiZSBhbiBhcnJheQoJCQl2YXIgaXNBcnJheSA9IGtleS5zbGljZSgtMikgPT09ICdbXSc7CgkJCS8vIElmIHNvLCBnZXQgdGhlIHRydWUga2V5IG5hbWUgYnkgcmVtb3ZpbmcgdGhlIHRyYWlsaW5nIFtdCgkJCWtleSA9IGlzQXJyYXkgPyBrZXkuc2xpY2UoMCwgLTIpIDoga2V5OwoJCQkvLyBJZiB0aGUga2V5IHNob3VsZCBiZSBhbiBhcnJheSBhbmQgaXNuJ3QsIGNyZWF0ZSBhbiBhcnJheQoJCQlpZiAoaXNBcnJheSAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudFtrZXldKSAhPT0gJ1tvYmplY3QgQXJyYXldJykgewoJCQkJY3VycmVudFtrZXldID0gW107CgkJCX0KCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCBpdGVtIGluIHRoZSBsb29wLCBhc3NpZ24gdGhlIHZhbHVlCgkJCWlmIChpbmRleCA9PT0gbGVuZ3RoIC0gMSkgewoJCQkJLy8gSWYgaXQncyBhbiBhcnJheSwgcHVzaCB0aGUgdmFsdWUKCQkJCS8vIE90aGVyd2lzZSwgYXNzaWduIGl0CgkJCQlpZiAoaXNBcnJheSkgewoJCQkJCWN1cnJlbnRba2V5XS5wdXNoKHZhbCk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRba2V5XSA9IHZhbDsKCQkJCX0KCQkJfQoJCQkvLyBPdGhlcndpc2UsIHVwZGF0ZSB0aGUgY3VycmVudCBwbGFjZSBpbiB0aGUgb2JqZWN0CgkJCWVsc2UgewoJCQkJLy8gSWYgdGhlIGtleSBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQKCQkJCWlmICghY3VycmVudFtrZXldKSB7CgkJCQkJY3VycmVudFtrZXldID0ge307CgkJCQl9CgkJCQkvLyBVcGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQkJY3VycmVudCA9IGN1cnJlbnRba2V5XTsKCQkJfQoJCX0pOwoJfQoKCV9wYWdlRmlsdGVyKGIpIHsKCQlpZiAoIWIuX2FjdGl2ZSkgcmV0dXJuIGZhbHNlOwoJCWxldCBwYWdlID0gdHlwZW9mKF9GckVNRC5oYXNoLnBhZ2UpID09PSAndW5kZWZpbmVkJyA/ICdpbmRleCcgOiBfRnJFTUQuaGFzaC5wYWdlOwoJCWlmICh0eXBlb2YoYi5fcGFnZSkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihiLl9wYWdlLl91cmwpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGIuX3BhZ2UuX3VybCA9PSBwYWdlOwoJfQoKCWFzeW5jIF9hcHBseUJpbmRpbmdzKGRvYyA9IHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQsIGJBZnRlciA9IGZhbHNlKSB7CgkJdGhpcy5mcm9tSGFzaCgpOwoJCWlmICh0aGlzLmhhc2gubm9CaW5kaW5nKSByZXR1cm47CgkJbGV0IGJpbmRpbmdzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJCaW5kaW5ncyIpOwoJCWlmICghYmluZGluZ3MgJiYgY29tcGFueS5CaW5kaW5ncykgewoJCQliaW5kaW5ncyA9IGF3YWl0IGNvbXBhbnkuQmluZGluZ3MoKTsKCQl9CgkJYmluZGluZ3MgPSBiaW5kaW5ncyB8fCBbXTsKCgkJc3IuZ3JvdXBCeShiaW5kaW5ncy5maWx0ZXIodGhpcy5fcGFnZUZpbHRlcikuZmlsdGVyKGIgPT4gYkFmdGVyID8gYi5fYWZ0ZXIgOiAhYi5fYWZ0ZXIpLCAiX3BhdGgiKS5mb3JFYWNoKHBiID0+IHsKCQkJdHJ5IHsKCQkJCWxldCBlID0gZG9jLmV2YWx1YXRlKHBiLmtleSwgZG9jLCBudWxsLCBYUGF0aFJlc3VsdC5GSVJTVF9PUkRFUkVEX05PREVfVFlQRSwgbnVsbCkuc2luZ2xlTm9kZVZhbHVlOwoJCQkJbGV0IGRfYmluZCA9IHt9OwoJCQkJcGIudmFsdWVzLmZvckVhY2goYiA9PiB7CgkJCQkJdGhpcy5fc2V0KGRfYmluZCwgYi5fYXR0cmlidXRlLCBiLl9jb2RlKTsKCQkJCX0pOwoJCQkJJChlKS5hdHRyKCJkYXRhLWJpbmQiLCBKU09OLnN0cmluZ2lmeShkX2JpbmQpLnJlcGxhY2UoLyIvZywgJycpKTsKCQkJCS8vY29uc29sZS5sb2cocGIua2V5LCBlKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKHBiLmtleSwgZXgpOwoJCQl9CgkJfSk7Cgl9CgoJYXN5bmMgaW5pdCgpIHsKCQlhd2FpdCB0aGlzLnByZUluaXQoKTsKCQlhd2FpdCB0aGlzLl9sb2FkQ29udGVudCgpOwoJCWF3YWl0IHRoaXMucG9zdEluaXQoKTsKCX0KCglfdXVpZChpZCwgbGVuLCBiSW50KSB7CgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKGJJbnQpIHJldHVybiBNYXRoLmZsb29yKERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpKTsKCgkJaWYgKGlkKSB7CgkJCWxldCBoYyA9IE1hdGguYWJzKE51bWJlcih0eXBlb2Yoc3IpICE9PSAndW5kZWZpbmVkJyA/IHNyLmhhc2hDb2RlKGlkKSA6IGlkLmxlbmd0aCkpOwoJCQlsZXQgaHMgPSBoID0+IE51bWJlcihTdHJpbmcoaCkuc3BsaXQoIiIpLnJldmVyc2UoKS5qb2luKCIiKSk7CgkJCWxldCB1ID0gaHMoaHMoaGMpICogaHMoaGMpKS50b1N0cmluZygxNik7CgoJCQlyZXQgPSB1ICsgJycgKyB1ICsgJycgKyB1OwoJCQlpZiAocmV0Lmxlbmd0aCA+IDMyKSByZXQgPSByZXQuc3Vic3RyaW5nKDAsIDMyKTsKCQl9CgoJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2KCk7CgoJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KTsKCgkJcmV0dXJuIHJldC5yZXBsYWNlKC9cLS9nLCAnJyk7Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSkgewoJCS8vc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgZWFzID0gW107CgoJCWlmIChlYyAmJiBlYy5saWJyYXJ5ICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJbGV0IGxjcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNHZW5lcmF0ZUxheWVyQ2xhc3MiLCBudWxsLCBlYy5saWJyYXJ5KTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaChjLkxheWVyQXR0cmlidXRlcywgKF8sIGxhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IGxhLk5hbWUsCgkJCQlQbHVyYWw6IGxhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiBsYSwKCQkJCUlzQm9vbDogbGEuTmF0aXZlVHlwZSA9PSAiYm9vbCIsCgkJCQlJc1N0cmluZzogbGEuTmF0aXZlVHlwZSA9PSAic3RyaW5nIiwKCQkJCUlzVGV4dDogbGEuTmF0aXZlVHlwZSA9PSAidGV4dCIsCgkJCQlJc0xvbmc6IGxhLk5hdGl2ZVR5cGUgPT0gImxvbmciLAoJCQkJSXNGbG9hdDogbGEuTmF0aXZlVHlwZSA9PSAiZmxvYXQiLAoJCQkJSXNJbnQ6IGxhLk5hdGl2ZVR5cGUgPT0gImludGVnZXIiLAoJCQkJSXNEb3VibGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRvdWJsZSIsCgkJCQlJc0RhdGU6IGxhLk5hdGl2ZVR5cGUgPT0gImRhdGV0aW1lIiwKCQkJCUlzRmlsZTogbGEuTmF0aXZlVHlwZSA9PSAiZmlsZSIsCgkJCQlJc0ltYWdlOiBsYS5OYXRpdmVUeXBlID09ICJpbWFnZSIsCgkJCQlJc09iamVjdDogbGEuTmF0aXZlVHlwZSA9PSAib2JqZWN0IiwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQkJJC5lYWNoKGxjcywgKF8sIGMpID0+ICQuZWFjaCgkLmdyZXAoYy5SZWxhdGlvbkF0dHJpYnV0ZXMsIHJhID0+ICFyYS5Jc0FycmF5KSwgKF8sIHJhKSA9PiBlYXMucHVzaCh7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQkJSWQ6IHRoaXMuX3V1aWQoKSwKCQkJCU5hbWU6IHJhLk5hbWUsCgkJCQlQbHVyYWw6IHJhLk5hbWUgKyAicyIsCgkJCQkvL0xheWVyQXR0cmlidXRlOiByYSwKCQkJCUlzQm9vbDogZmFsc2UsCgkJCQlJc1N0cmluZzogZmFsc2UsCgkJCQlJc1RleHQ6IGZhbHNlLAoJCQkJSXNMb25nOiBmYWxzZSwKCQkJCUlzRmxvYXQ6IGZhbHNlLAoJCQkJSXNJbnQ6IGZhbHNlLAoJCQkJSXNEb3VibGU6IGZhbHNlLAoJCQkJSXNEYXRlOiBmYWxzZSwKCQkJCUlzRmlsZTogZmFsc2UsCgkJCQlJc0ltYWdlOiBmYWxzZSwKCQkJCUVudGl0eVR5cGU6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUocmEuUmVsYXRpb25DbGFzcy5OYW1lKSwKCQkJCQlOYW1lOiByYS5SZWxhdGlvbkNsYXNzLk5hbWUsCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQlJZDogc3IuaGFzaENvZGUoYy5OYW1lKSwKCQkJCQlOYW1lOiBjLk5hbWUsCgkJCQkJUGx1cmFsOiBjLk5hbWUgKyAicyIsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJUmVtYXJrOiAiIiwKCQkJCQlDb21wYW55OiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZShjb21wYW55Lk5hbWUpLAoJCQkJCQlOYW1lOiBjb21wYW55Lk5hbWUKCQkJCQl9LAoJCQkJCUdyb3VwOiB7CgkJCQkJCUlkOiBzci5oYXNoQ29kZSgiTWFpbiIpLAoJCQkJCQlOYW1lOiAiTWFpbiIKCQkJCQl9CgkJCQl9LAoJCQl9KSkpOwoJCX0gZWxzZSBpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LkNvZGUgJiYgIUFycmF5LmlzQXJyYXkoZWMpICYmIHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCQlUSElTOiBlYyA/IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiBlYwoJCQkJfSwgewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQkJCUNvbXBhbmllczogW3sKCQkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQkJRW50aXR5Q2xhc3NlczogW2VjXQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dIDogW3sKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlDb21wYW55OiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZQoJCQkJCQkJfV0KCQkJCQkJfQoJCQkJCX0KCQkJCX1dLAoJCQl9KTsKCQl9CgoJCXRoaXMuc3RlcCgpOwoKCQlpZiAoKCFlYXMgfHwgIWVhcy5sZW5ndGgpICYmICghZWMgfHwgIWVjLmxlbmd0aCkpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5Q2xhc3NlcygiICsgc2NvcGUgKyAiKTogZmFpbGVkIHRvIGxvYWQgY2xhc3Nlcy4uLiIpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBtIG9mIChBcnJheS5pc0FycmF5KGVjKSA/IGVjIDogW10pLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSkpIGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpOwoKCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fY29ycmVjdENsYXNzZXMoZWMsIGVhcykgfHwgW107CgoJCWlmICghZWFzLmxlbmd0aCkgewoJCQkvLyBjbGFzc2VzIGZyb20gSlNPTiBBcnJheQoJCQllYXMgPSBlYXMuY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMpKTsKCQl9CgoJCXJldHVybiBhd2FpdCB0aGlzLl9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKTsKCX0KCglfbWVudUNsYXNzZXMoc2NvcGUpIHsKCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6X21lbnVDbGFzc2VzKCIgKyBzY29wZSArICIpOiBvU2NvcGUiLCBzY29wZSwgb1Njb3BlLCB0aGlzLmFwaVNlcnZlcik7CgkJaWYgKCFvU2NvcGUpIHJldHVybiBbXTsKCgkJcmV0dXJuIHRoaXMuc3IoKS5ncm91cEJ5KG9TY29wZS5FbnRpdHlDbGFzc2VzLCAnRW50aXR5TW9kdWxlJykubWFwKGcgPT4gKHsKCQkJbGFiZWw6IChnLmtleSA/IHRoaXMuX3RpdGxlQ2FzZShnLmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJc3ViTWVudXM6IHRoaXMuc3IoKS5ncm91cEJ5KGcudmFsdWVzLCAnR3JvdXAnKS5tYXAoZ3YgPT4gKHsKCQkJCWxhYmVsOiAoZ3Yua2V5ID8gdGhpcy5fdGl0bGVDYXNlKGd2LmtleS5OYW1lKSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiB0aGlzLl90aXRsZUNhc2UoZ3Z2Lk5hbWUpLAoJCQkJCWNvZGU6ICdzdG9yZScsCgkJCQkJZGF0YTogZ3Z2Lk5hbWUKCQkJCX0pKQoJCQl9KSkKCQl9KSk7Cgl9CgoJYXN5bmMgX2xvYWRTY29wZShlYywgc2NvcGUpIHsKCQl0cnkgewoJCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCQlpZiAoc2NvcGUgIT09ICd3aW5kb3cnKSB3aW5kb3dbc2NvcGVdID0gYXdhaXQgdGhpcy5fbG9hZEVudGl0eUNsYXNzZXMoZWMsIHNjb3BlKTsKCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgkJCW9TY29wZS5ocmVmcyA9IFsuLi5uZXcgU2V0KFsuLi5uZXcgU2V0KChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkubWFwKGMgPT4gYy5Ub29scykuZmxhdCgpKV0ubWFwKHQgPT4gdGhpcy5ocmVmcy5maWx0ZXIobiA9PiBuLnRvb2xzICYmICghbi50b29scy5sZW5ndGggfHwgbi50b29scy5pbmRleE9mKHQpID49IDApKSkuZmxhdCgpKV07CgkJCWxldCBtYyA9IChvU2NvcGUuRW50aXR5Q2xhc3NlcyB8fCBbXSkuZmluZChjID0+IGMuSXNNYWluKTsKCQkJaWYgKG1jKSB7CgkJCQl0aGlzLmFwaVNlcnZlciA9IGF3YWl0IG5ldyBvU2NvcGVbbWMuTmFtZV0oKS5fc2VydmVyKHsKCQkJCQlsb2FkVG9vbHM6IHRydWUsCgkJCQkJaW5pdFNlbGY6IHRydWUsCgkJCQkJaW5pdE5vZGU6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgiICsgc2NvcGUgKyAiKTogZG9uZSEiKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2xvYWRTY29wZSgpOiBzY2hlbWEgZXhjZXB0aW9uICIgKyBleCk7CgkJCWlmIChmYWxzZSAmJiB0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCU5hbWU6IGNvbXBhbnkuU2NoZW1hIHx8IGNvbXBhbnkuQ29kZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUsCgkJCX0pOwoJCX0KCX0KCglhc3luYyBfbG9hZEVudGl0eU1vZHVsZShtLCBlYykgewoJCWlmICghbSkgcmV0dXJuOwoJCWxldCBtTmFtZSA9IG0uRW50aXR5TW9kdWxlID8gbS5FbnRpdHlNb2R1bGUuTmFtZSA6IG0uTmFtZTsKCQkobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyA9IChtLkVudGl0eU1vZHVsZSB8fCBtKS5JbXBvcnRzIHx8IDA7CgkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IExvYWRpbmcgIiArIG1OYW1lKTsKCgkJbGV0IGVhcyA9IFtdOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSBlYXMgPSBhd2FpdCB0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5QXR0cmlidXRlRmluZGFsbCIsIG51bGwsIHsKCQkJQWN0aXZlOiB0cnVlLAoJCQlFbnRpdHlDbGFzczogewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogbU5hbWUKCQkJCX0KCQkJfQoJCX0pOwoKCQlpZiAoZWFzLmxlbmd0aCkgewoJCQkodGhpc1siZ3JvdXBCeSJdID8gdGhpcyA6IHRoaXMuc3IoKSkuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpLmZvckVhY2goZyA9PiB7CgkJCQlnLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gZy52YWx1ZXM7CgkJCQlnLmtleS5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJZy52YWx1ZXMuZm9yRWFjaChlYSA9PiBlYS5FbnRpdHlDbGFzcyA9IGcua2V5KTsKCgkJCQlpZiAoZWMgJiYgQXJyYXkuaXNBcnJheShlYykpIGVjLnB1c2goZy5rZXkpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyBub3Qgc3RvcmVkIGluIEVNUywgY2hlY2sgaWYgYXZhaWxhYmxlIGFzIGEgc3RvcmVkIHNjcmlwdAoJCQl0cnkgewoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogYXBpU2VydmVyIiwgdGhpcy5hcGlTZXJ2ZXIpOwoJCQkJbGV0IG1FQ3MgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6IG1OYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJfSk7CgkJCQltRUNzID0gbUVDcy5maWx0ZXIoYyA9PiAobS5FeGNsdWRlcyB8fCBbXSkuaW5kZXhPZihjLk5hbWUpIDwgMCk7CgoJCQkJbUVDcy5maWx0ZXIoYyA9PiAhYy5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiB7CgkJCQkJYy5FbnRpdHlSdWxlcyA9IGMuRW50aXR5UnVsZXMgfHwgW107CgkJCQkJYy5FbnRpdHlSdWxlcy5wdXNoKC4uLigoKG0uRW50aXR5UnVsZXMgfHwge30pW2MuTmFtZV0pIHx8IFtdKSk7CgkJCQkJYy5FbnRpdHlNb2R1bGUgPSBtOwoJCQkJfSk7CgkJCQlkZWxldGUgbS5FbnRpdHlSdWxlczsKCQkJCWVjLnB1c2goLi4ubUVDcyk7CgoJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogQ2xhc3NlcyIsIGVjLm1hcChjID0+IGMuRW50aXR5TW9kdWxlKSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGRtIG9mIGVjLmZpbHRlcihjID0+ICFjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgIWMuRW50aXR5TW9kdWxlLklnbm9yZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lICE9IG1OYW1lKSkgewoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENhbmRpZGF0ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChlYy5maWx0ZXIoYyA9PiBjLk5hbWUgJiYgYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBkbS5FbnRpdHlNb2R1bGUuTmFtZSkubGVuZ3RoKSB7CgkJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IE1vZHVsZSBhbHJlYWR5IGxvYWRlZCEiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQkJLy9jb25zb2xlLmxvZygiX2xvYWRFbnRpdHlNb2R1bGUoKTogcmVjdXJzaXZlIG1vZHVsZSIsIGRtLkVudGl0eU1vZHVsZSk7CgkJCQkJaWYgKGRtLkVudGl0eU1vZHVsZSkgewoJCQkJCQkoZG0uRW50aXR5TW9kdWxlIHx8IGRtKS5JbXBvcnRzKys7CgkJCQkJCWF3YWl0IHRoaXMuX2xvYWRFbnRpdHlNb2R1bGUoZG0uRW50aXR5TW9kdWxlLCBlYyk7CgkJCQkJfQoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IEZhaWxlZCBsb2FkaW5nIG1vZHVsZSAiICsgbU5hbWUsIGV4KTsKCQkJfQoJCX0KCX0KCglfY29ycmVjdENsYXNzZXMoZWMsIGVhcykgewoJCWxldCBvR3JvdXBlciA9IHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCk7CgkJbGV0IHJldCA9IG51bGw7CgoJCWlmIChBcnJheS5pc0FycmF5KGVjKSAmJiAhKGVhcyB8fCBbXSkubGVuZ3RoKSB7CgkJCWVjID0gZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmICh0eXBlb2YoYy5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBjLkFjdGl2ZSkpOwoKCQkJZWMuZm9yRWFjaChjID0+IHsKCQkJCWMuSWQgPSBjLklkIHx8IHRoaXMuX3V1aWQoKTsKCQkJCWMuUGx1cmFsID0gYy5QbHVyYWwgfHwgKGMuTmFtZSArICJzIik7CgkJCQljLl9Ub1N0cmluZyA9IGMuX1RvU3RyaW5nIHx8IGMuTmFtZTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMgfHwgW107CgoJCQkJbGV0IF9iYXNlXyA9IGMuRW50aXR5QXR0cmlidXRlcy5maW5kKGVhID0+IGVhLk5hbWUgPT0gJ19fQkFTRV9fJyk7CgkJCQlpZiAoX2Jhc2VfKSB7CgkJCQkJbGV0IHByb3BMaXN0ID0gWydJc1VuaXF1ZScsICdDb2RlJywgJ0RlZmF1bHQnLCAnVmFsdWUnLCAnUmVxdWlyZWQnLCAnRHVwbGljYXRlJ107CgkJCQkJcHJvcExpc3QuZmlsdGVyKHAgPT4gQXJyYXkuaXNBcnJheShfYmFzZV9bcF0pKS5mb3JFYWNoKHAgPT4gX2Jhc2VfW3BdID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uX2Jhc2VfW3BdLm1hcChfYSA9PiAoewoJCQkJCQlbX2FdOiB0cnVlCgkJCQkJfSkpKSk7CgoJCQkJCWxldCBhdHRMaXN0ID0gW3sKCQkJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiQ29udHJvbCIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCQlHcm91cDogewoJCQkJCQkJTmFtZTogIkluZm8iCgkJCQkJCX0sCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAib3JkZXIiLAoJCQkJCQlJc0ludDogdHJ1ZSwKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogImRhdGUiLAoJCQkJCQlJc0RhdGU6IHRydWUsCgkJCQkJCURlZmF1bHQ6ICduZXcgRGF0ZSgpJywKCQkJCQkJR3JvdXA6IHsKCQkJCQkJCU5hbWU6ICJDb250cm9sIgoJCQkJCQl9LAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJCQlJc1RleHQ6IHRydWUsCgkJCQkJCUdyb3VwOiB7CgkJCQkJCQlOYW1lOiAiSW5mbyIKCQkJCQkJfSwKCQkJCQl9XTsKCQkJCQlhdHRMaXN0LmZvckVhY2goYSA9PiBwcm9wTGlzdC5maWx0ZXIocCA9PiBfYmFzZV9bcF0pLmZvckVhY2gocCA9PiBhW3BdID0gX2Jhc2VfW3BdW2EuTmFtZV0pKTsKCQkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBhdHRMaXN0LmNvbmNhdChjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLk5hbWUgIT09ICJfX0JBU0VfXyIpKTsKCQkJCX0KCgkJCQlbJ0VudGl0eUF0dHJpYnV0ZXMnLCAnRW50aXR5RmllbGRzJ10uZmlsdGVyKGVUeXBlID0+IGNbZVR5cGVdKS5mb3JFYWNoKGVUeXBlID0+IGNbZVR5cGVdLmZpbHRlcihlYSA9PiBlYS5EdXBsaWNhdGUpLmZvckVhY2goZWEgPT4gewoJCQkJCWxldCBzZWEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRHVwbGljYXRlLnNwbGl0KCcuJylbMF0pW2VUeXBlXS5maW5kKHNlYSA9PiBzZWEuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVsxXSk7CgkJCQkJT2JqZWN0LmtleXMoc2VhKS5maWx0ZXIoayA9PiBbIkVudGl0eUNsYXNzIl0uaW5kZXhPZihrKSA8IDApLmZvckVhY2goayA9PiB7CgkJCQkJCWlmIChrID09ICdEZWZhdWx0JyAmJiB0eXBlb2Yoc2VhW2tdKSA9PT0gJ3N0cmluZycgJiYgIXNlYVtrXS5pbmRleE9mKCcvKipnZW5lcmF0ZWQqKi8nKSkgcmV0dXJuOwoJCQkJCQllYVtrXSA9IHNlYVtrXTsKCQkJCQl9KTsKCQkJCX0pKTsKCgkJCQljLlR5cGVkQXR0cmlidXRlcyA9IGMuVHlwZWRBdHRyaWJ1dGVzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbS5NZXRob2RQYXJhbWV0ZXJzIHx8IFtdOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLnB1c2goLi4uYy5FbnRpdHlNZXRob2RzLm1hcChtID0+IG0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiAhcC5JZCkpLmZsYXQoKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IHR5cGVvZihlYS5BY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCBlYS5BY3RpdmUpOwoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gZWEuRW50aXR5VHlwZS5OYW1lKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+ICFlYS5FbnRpdHlUeXBlIHx8IChlYS5FbnRpdHlUeXBlICYmIGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiB7CgkJCQkJaWYgKCFlYS5OYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKGMuTmFtZSArICIgaGFzIEF0dHJpYnV0ZSB3aXRob3V0IE5hbWUiLCBlYSk7CgkJCQkJfQoJCQkJCWVhLklkID0gZWEuSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCWVhLl9Ub1N0cmluZyA9IGVhLl9Ub1N0cmluZyB8fCBlYS5OYW1lOwoJCQkJCWVhLkdyb3VwID0gZWEuR3JvdXAgfHwgIk1haW4iOwoJCQkJCWVhLkVudGl0eUNsYXNzID0gYzsKCQkJCX0pOwoKCQkJCW9Hcm91cGVyLmdyb3VwQnkoYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJCWxldCBtID0gbWVhLmtleTsKCgkJCQkJbS5FbnRpdHlDbGFzcyA9IGM7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiBtLlJlc3BvbnNlQXR0cmlidXRlICYmIHYuSWQgIT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZCk7CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmluZCh2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJCW0uRW50aXR5Q2xhc3MuRW50aXR5TWV0aG9kcy5wdXNoKG0pOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2gobSA9PiB7CgkJCQkJbS5JZCA9IG0uSWQgfHwgdGhpcy5fdXVpZCgpOwoJCQkJCW0uX1RvU3RyaW5nID0gbS5fVG9TdHJpbmcgfHwgbS5OYW1lOwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZvckVhY2gocCA9PiBwLkVudGl0eU1ldGhvZCA9IG0pOwoJCQkJCW0uTWV0aG9kUGFyYW1ldGVycy5maWx0ZXIocCA9PiBwLkVudGl0eVR5cGUgJiYgIXAuRW50aXR5VHlwZS5JZCkuZm9yRWFjaChwID0+IHsKCQkJCQkJcC5FbnRpdHlUeXBlID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IHAuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQl9KTsKCgkJCQkJaWYgKCFtLlJlc3BvbnNlQXR0cmlidXRlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGUubG9nKCJfY29ycmVjdENsYXNzZXMoKTogSW52YWxpZCBSZXNwb25zZUF0dHJpYnV0ZSBmb3IgbWV0aG9kICIgKyBtLk5hbWUgKyAiLiBEZWZhdWx0aW5nIHRvIG9iamVjdCByZXR1cm4gKHJldCIgKyBtLk5hbWUgKyAiKSIpOwoJCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gewoJCQkJCQkJSXNPYmplY3Q6IHRydWUsCgkJCQkJCX07CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSA9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuTmFtZSB8fCAoInJldCIgKyBtLk5hbWUpOwoKCQkJCQlpZiAobS5SZXNwb25zZUF0dHJpYnV0ZSAmJiBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpIHsKCQkJCQkJbGV0IHJhID0gZWMuZmluZChfYyA9PiBfYy5OYW1lID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZS5OYW1lKTsKCQkJCQkJaWYgKCFyYSkgewoJCQkJCQkJY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIEVudGl0eVR5cGUgTmFtZT0iICsgbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSA9IHJhOwoJCQkJCQl9CgkJCQkJfQoJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5TWV0aG9kID0gbTsKCQkJCX0pOwoKCQkJCWMuRW50aXR5TWV0aG9kcyA9IHRoaXMuX3VuaXF1ZShjLkVudGl0eU1ldGhvZHMpOwoKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuSXNTdHJpbmcgJiYgIWVhLkVudGl0eU1ldGhvZCAmJiAhZWEuRGVmYXVsdCAmJiAoZWEuUmVxdWlyZWQgfHwgZWEuSXNVbmlxdWUpKS5mb3JFYWNoKGVhID0+IGVhLkRlZmF1bHQgPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKHJhID0+ICFyYS5FbnRpdHlNZXRob2QgJiYgcmEuRW50aXR5VHlwZSAmJiAocmEuSXNVbmlxdWUgfHwgcmEuUmVxdWlyZWQpKS5tYXAocmEgPT4gYC8qKmdlbmVyYXRlZCoqLyh0aGlzLiR7cmEuTmFtZX0oKT90aGlzLiR7cmEuTmFtZX0oKS4ke2VhLk5hbWV9KCk6J251bGwnKWApLmpvaW4oYCArICctJyArIGApKTsKCQkJfSk7CgoJCQkvKm9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLmVjLm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJCWVjLmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQpLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgkJCX0pOyovCgoJCQlyZXQgPSB0aGlzLl91bmlxdWUoZWMpOwoJCX0gZWxzZSBpZiAoIWVjIHx8ICFBcnJheS5pc0FycmF5KGVjKSkgewoJCQl2YXIgY2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKTsKCgkJCXZhciB0Q2xhc3NlcyA9IG9Hcm91cGVyLmdyb3VwQnkoZWFzLCAiRW50aXR5VHlwZSIpOwoJCQljbGFzc2VzLmZvckVhY2goYyA9PiB7CgkJCQlpZiAoIWMua2V5KSB7CgkJCQkJY29uc29sZS5sb2coIkVtcHR5IGtleSIsIGMpOwoJCQkJfQoJCQkJYy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGMudmFsdWVzOwoKCQkJCXZhciB0YXMgPSB0Q2xhc3Nlcy5maW5kKHRjID0+IHRjLmtleSAmJiBjLmtleSAmJiB0Yy5rZXkuSWQgPT09IGMua2V5LklkKTsKCQkJCS8vYy5rZXkuVHlwZWRBdHRyaWJ1dGVzID0gdGFzID8gdGFzLnZhbHVlcyA6IFtdOwoJCQkJYy5rZXkuRW50aXR5TWV0aG9kcyA9IGMua2V5LkVudGl0eU1ldGhvZHMgfHwgW107CgkJCX0pOwoJCQlyZXQgPSBjbGFzc2VzLm1hcChhID0+IGEua2V5KTsKCgkJCW9Hcm91cGVyLmdyb3VwQnkoZWFzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlNZXRob2QpLCAiRW50aXR5TWV0aG9kIikuZm9yRWFjaChtZWEgPT4gewoJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCW0uRW50aXR5Q2xhc3MgPSByZXQuZmluZChjID0+IGMuSWQgPT0gbS5FbnRpdHlDbGFzc2lkKTsKCQkJCW0uTWV0aG9kUGFyYW1ldGVycyA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IHYuSWQgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5JZClbMF07CgoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzID0gbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzIHx8IFtdOwoJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCX0pOwoJCX0KCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuRW50aXR5TWV0aG9kcyA9IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcyA9IChjLkVudGl0eUZpZWxkcyB8fCBbXSkuZmlsdGVyKGYgPT4gIWYuSWdub3JlKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5FbnRpdHlDbGFzcyA9IGMpOwoJCX0pOwoKCQlsZXQgdHJDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5OYW1lID09ICJUcmFuc2FjdGlvbiIgJiYgYy5FbnRpdHlNb2R1bGUpOwoJCWlmICh0ckNsYXNzKSByZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5maWx0ZXIobSA9PiAhbS5Jc1N5bmMgJiYgIW0uUmVzcG9uc2VNZXRob2QpLmZvckVhY2gobSA9PiB7CgkJCW0uUmVzcG9uc2VNZXRob2QgPSB7CgkJCQlOYW1lOiBtLk5hbWUgKyAiUmVzcG9uc2UiLAoJCQkJTWV0aG9kUGFyYW1ldGVyczogW3sKCQkJCQlOYW1lOiAidHJhbnNhY3Rpb24iLAoJCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MKCQkJCX1dLAoJCQkJU2NyaXB0OiBgcmV0dXJuIGF3YWl0IHRyYW5zYWN0aW9uLmNsYXNzKCIke2MuTmFtZX0iKS5tZXRob2QoIiR7bS5OYW1lfSIpLmFzeW5jUmVzdWx0KCIke20uUmVzcG9uc2VBdHRyaWJ1dGU/LkVudGl0eVR5cGU/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKX0iLCAke20uUmVzcG9uc2VBdHRyaWJ1dGUuSXNBcnJheT8idHJ1ZSI6ImZhbHNlIn0pYCwKCQkJCVJlc3BvbnNlQXR0cmlidXRlOiBtLlJlc3BvbnNlQXR0cmlidXRlLAoJCQl9OwoJCQljLkVudGl0eU1ldGhvZHMucHVzaChtLlJlc3BvbnNlTWV0aG9kKTsKCgkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQlOYW1lOiBgcmV0JHttLk5hbWV9YCwKCQkJCUVudGl0eVR5cGU6IHRyQ2xhc3MsCgkJCX0KCQl9KSk7CgoJCW9Hcm91cGVyLmdyb3VwQnkoW10uY29uY2F0KC4uLnJldC5tYXAoYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eU1ldGhvZCkpKSwgJ0VudGl0eVR5cGUnKS5mb3JFYWNoKGN0YSA9PiB7CgkJCWxldCBfYyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBjdGEua2V5LklkIHx8IChjLk5hbWUgPT0gY3RhLmtleS5OYW1lIC8qJiYgYy5FbnRpdHlNb2R1bGUgJiYgY3RhLmtleS5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSA9PSBjdGEua2V5LkVudGl0eU1vZHVsZS5OYW1lKi8gKSk7CgkJCWlmICghX2MpIHsKCQkJCWNvbnNvbGUubG9nKCJObyBjbGFzcyBmb3VuZCB0byBtYXRjaCAiICsgY3RhLmtleS5OYW1lKTsKCQkJfSBlbHNlIHsKCQkJCV9jLlR5cGVkQXR0cmlidXRlcyA9IGN0YS52YWx1ZXM7CgoJCQkJY3RhLnZhbHVlcy5mb3JFYWNoKGVhID0+IGVhLkVudGl0eVR5cGUgPSBfYyk7IC8vPz8/CgkJCX0KCQl9KTsKCgkJaWYgKHJldCAmJiByZXQubGVuZ3RoICYmICFyZXQuZmluZChjID0+IGMuSXNNYWluKSkgewoJCQlyZXRbMF0uSXNNYWluID0gdHJ1ZTsKCQkJcmV0WzBdLk9yZGVyID0gLU51bWJlci5NQVhfVkFMVUU7CgkJfQoKCQlsZXQgY1JhbmsgPSAoYywgc291cmNlcyA9IFtdKSA9PiB7CgkJCXNvdXJjZXMucHVzaChjLk5hbWUpOwoJCQlyZXR1cm4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmIGVhLkVudGl0eVR5cGUgIT09IGMgJiYgc291cmNlcy5pbmRleE9mKGVhLkVudGl0eVR5cGUuTmFtZSkgPCAwKS5tYXAoZWEgPT4gY1JhbmsoZWEuRW50aXR5VHlwZSwgc291cmNlcykpLmNvbmNhdChbMV0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KTsKCQl9OwoKCQkvLyBvcmRlciBieSBvcmRlcgoJCXJldC5mb3JFYWNoKGMgPT4gewoJCQljLk9yZGVyID0gYy5PcmRlciB8fCAwOwoJCQljLlJhbmsgPSBjUmFuayhjKTsKCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZvckVhY2goZWEgPT4gZWEuT3JkZXIgPSBlYS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlNZXRob2RzLmZvckVhY2goZW0gPT4gZW0uT3JkZXIgPSBlbS5PcmRlciB8fCAwKTsKCQkJYy5FbnRpdHlGaWVsZHMuZm9yRWFjaChlZiA9PiBlZi5PcmRlciA9IGVmLk9yZGVyIHx8IDApOwoJCX0pOwoJCXJldC5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcik7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eUF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5RmllbGRzLnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKSk7CgkJcmV0LmZvckVhY2goYyA9PiBjLkVudGl0eU1ldGhvZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCgkJaWYgKHJldC5sZW5ndGgpIHsKCQkJWydEZWJ1ZycsICdDb25maWcnLCAnVGVzdCcsICdUb29scycsICdNYXBwaW5ncycsICdSb3V0aW5nJywgJ1ZhbGlkYXRvcnMnLCAnTWV0aG9kUnVsZXMnLCAnRW50aXR5UnVsZXMnXS5mb3JFYWNoKGEgPT4gewoJCQkJbGV0IG1jQSA9IHJldFswXVthXTsKCQkJCWRlbGV0ZSByZXRbMF1bYV07CgkJCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJCQljW2FdID0gY1thXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bYy5OYW1lXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdPy5bJyonXSB8fCBjLkVudGl0eU1vZHVsZT8uW2FdIHx8IG1jQT8uW2MuTmFtZV0gfHwgbWNBPy5bJyonXSB8fCBtY0EgfHwge307CgkJCQkJaWYgKGEuZW5kc1dpdGgoJ3MnKSAmJiAhQXJyYXkuaXNBcnJheShjW2FdKSkgY1thXSA9IE9iamVjdC5rZXlzKGNbYV0pOwoJCQkJfSk7CgkJCX0pOwoKCQkJcmV0LmZpbHRlcihjID0+ICFjLklzTWFpbikuZm9yRWFjaChjID0+IGMuQ29uZmlnID0gT2JqZWN0LmFzc2lnbihKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJldC5maW5kKF9jID0+IF9jLklzTWFpbikuQ29uZmlnKSksIGMuQ29uZmlnKSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNb2R1bGUgPSBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglfX3Njb3BlTmFtZShzY29wZSkgewoJCXJldHVybiBzY29wZSB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuU2NvcGUgOiBudWxsKSB8fCAodGhpcy5oYXNoLnNjb3BlIHx8ICcnKS5yZXBsYWNlKC9cIC9nLCAnJykudG9Mb3dlckNhc2UoKSB8fCAid2luZG93IjsKCX0KCglfX3Njb3BlKHNjb3BlKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlyZXR1cm4gdGhpcy5zcigpLl8gPyB0aGlzLnNyKCkuX19zY29wZShzY29wZSkgOiB0aGlzOwoJfQoKCWFzeW5jIF9idWlsZENsYXNzZXMocmV0LCBzY29wZSwgZWFzKSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgclNjb3BlID0gewoJCQlFbnRpdHlDbGFzc2VzOiByZXQsCgkJCUVudGl0eUF0dHJpYnV0ZXM6IGVhcywKCQl9OwoKCQlyU2NvcGUubk5hbWUgPSByU2NvcGUubk5hbWUgfHwgKChuLCBiQWxpYXMpID0+ICgoYkFsaWFzICYmIG4uRW50aXR5TW9kdWxlPy5BbGlhcykgPyBuLkVudGl0eU1vZHVsZT8uQWxpYXMgKyAnLicgOiAnJykgKyBuPy5OYW1lPy5yZXBsYWNlKC8gL2csICdfJykpOwoJCXJTY29wZS5uQ29kZSA9IHJTY29wZS5uQ29kZSB8fCAobiA9PiB7CgkJCWlmICghbikgcmV0dXJuICIiOwoJCQlsZXQgcmV0ID0gbi5OYW1lIHx8ICIiOwoJCQlpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJzdHJpbmciKSB7CgkJCQlyZXQgPSBuLkNvZGU7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG4uQ29kZSkgPT09ICJvYmplY3QiKSB7CgkJCQlsZXQgbyA9IChuLkVudGl0eUNsYXNzIHx8IG4pOwoJCQkJaWYgKG8uVG9vbCkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2wuTmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChvLlRvb2xzLmxlbmd0aCAmJiBvLlRvb2xzWzBdICYmIG8uVG9vbHNbMF0udHlwZSkgewoJCQkJCXJldCA9IG4uQ29kZVtvLlRvb2xzWzBdLnR5cGUubmFtZV0gfHwgbi5OYW1lOwoJCQkJfSBlbHNlIGlmIChPYmplY3Qua2V5cyhuLkNvZGUpLmxlbmd0aCkgewoJCQkJCXJldCA9IG4uQ29kZVtPYmplY3Qua2V5cyhuLkNvZGUpWzBdXTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbi5OYW1lOwoJCQkJfQoJCQl9CgkJCXJldHVybiByZXQucmVwbGFjZSgvIC9nLCAnXycpOwoJCX0pOwoKCQlsZXQgaHRtbCA9IGF3YWl0IHRoaXMucmVxdWlyZSgiRW50aXR5Q2xhc3MiKTsKCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLihodG1sLm1hdGNoQWxsKC8oPCU9KS5bXHdcLS5dK1tcLl0oanMpKCU+KS9nbSkpXSkgaHRtbCA9IGh0bWwucmVwbGFjZShtWzBdLCBhd2FpdCB0aGlzLnJlcXVpcmUobVswXS5yZXBsYWNlKCI8JT0iLCAiIikucmVwbGFjZSgiJT4iLCAiIikucmVwbGFjZSgnLmpzJywgJycpKSk7CgoJCXRoaXMuc3RlcCgpOwoKCQlsZXQgX2NvZGUgPSAnJzsKCQlmb3IgYXdhaXQgKGNvbnN0IGMgb2YgcmV0KSB7CgkJCWxldCBjb2RlID0gIiI7CgkJCXRyeSB7CgkJCQljb2RlID0gdGhpcy5faW5qZWN0KGh0bWwsIHsKCQkJCQlhckNsYXNzZXM6IHJldCwKCQkJCQljOiBjLAoJCQkJCXNjb3BlOiBzY29wZSwKCQkJCQluTmFtZTogclNjb3BlLm5OYW1lLAoJCQkJCW5Db2RlOiByU2NvcGUubkNvZGUsCgkJCQl9KSArICdcbicgKyByU2NvcGUubk5hbWUoYyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiX2J1aWxkQ2xhc3NlcygpOiBfaW5qZWN0IGV4Y2VwdGlvbjogIiArIGV4KTsKCQkJfQoKCQkJY29kZSA9IHRoaXMuX2JlYXV0aWZ5KGNvZGUsICJqYXZhc2NyaXB0Iik7CgoJCQlfY29kZSA9IGNvZGUgKyBgCiR7c2NvcGU/J3dpbmRvdy4nK3Njb3BlOid3aW5kb3cnfS4ke3JTY29wZS5uQ29kZShjLkVudGl0eU1vZHVsZSl8fCd4J30uJHtyU2NvcGUubk5hbWUoYyl9ID0gJHtyU2NvcGUubk5hbWUoYyl9OwpgOwoKCQkJbGV0IGFsaWFzID0gclNjb3BlOwoJCQlpZiAoYy5FbnRpdHlNb2R1bGUgJiYgYy5FbnRpdHlNb2R1bGUuQWxpYXMpIGMuRW50aXR5TW9kdWxlLkFsaWFzLnNwbGl0KCcuJykuZmlsdGVyKGEgPT4gYSkuZm9yRWFjaChhID0+IGFsaWFzID0gKGFsaWFzW2FdID0gYWxpYXNbYV0gfHwge30pKTsKCgkJCWFsaWFzW3JTY29wZS5uTmFtZShjKV0gPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChjb2RlKTsKCQl9CgoJCXJldHVybiByU2NvcGU7Cgl9CgoJc3IoKSB7CgkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LnNyKSA/IHdpbmRvdy5zciA6IHRoaXM7Cgl9CgoJX190aW1lKG5hbWUgPSAiZ2xvYmFsIikgewoJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoKTsKCQlpZiAoIW9TY29wZSkgcmV0dXJuIGQ7CgkJb1Njb3BlLl9fdGltZXMgPSBvU2NvcGUuX190aW1lcyB8fCB7fTsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IG9TY29wZS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSBvU2NvcGUuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJb1Njb3BlLl9fdGltZXNbbmFtZV0gPSBkOwoJCXJldHVybiAocyArICdzJyk7Cgl9CgoJX2luY2x1ZGUoX2hyZWYpIHsKCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7Cgl9CgoJX2NzcyhsaW5rLCByZWwgPSAic3R5bGVzaGVldCIpIHsKCQljb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwoJCWwuc2V0QXR0cmlidXRlKCdyZWwnLCByZWwpOwoJCWwuc2V0QXR0cmlidXRlKCdocmVmJywgbGluayk7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsKCX0KCgl0b1BERihmaWxlbmFtZSwgcGFnZXMpIHsKCQlpZiAoIXBhZ2VzIHx8ICFwYWdlcy5sZW5ndGgpIHBhZ2VzID0gW2RvY3VtZW50LmJvZHldOwoJCWxldCBwZGYgPSBuZXcganNQREYoJ3AnLCAnbW0nLCAnYTQnKTsKCQl2YXIgY2FsbHMgPSAkLm1hcChwYWdlcywgcCA9PiBodG1sMmNhbnZhcyhwLCB7CgkJCXNjYWxlOiAxCgkJfSkpOwoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4uYXJDYW52YXMpID0+IHsKCQkJJC5lYWNoKGFyQ2FudmFzLCAoaSwgYykgPT4gewoJCQkJaWYgKGkpIHBkZi5hZGRQYWdlKCk7CgkJCQlwZGYuYWRkSW1hZ2UoYy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCAnUE5HJywgMCwgMCwgMjAwLCAyMDApOwoJCQl9KTsKCQkJcGRmLnNhdmUoZmlsZW5hbWUpOwoJCX0pOwoJfQoKCXN0ZXAoKSB7CgkJdHJ5IHsKCQkJaWYgKCFsb2FkaW5nLmxvYWRlcikgewoJCQkJJCgiYm9keSIpLmFwcGVuZCgiPGNlbnRlcj48ZGl2IGlkPSd0b3BMb2FkZXInPjwvZGl2PjwvY2VudGVyPiIpOwoJCQkJbG9hZGluZy5sb2FkZXIgPSAkKCIjdG9wTG9hZGVyIikucGVyY2VudGFnZUxvYWRlcih7CgkJCQkJd2lkdGg6IDI1NiwKCQkJCQloZWlnaHQ6IDI1NiwKCQkJCQljb250cm9sbGFibGU6IHRydWUsCgkJCQkJcHJvZ3Jlc3M6IDAsCgkJCQkJb25Qcm9ncmVzc1VwZGF0ZTogKHZhbCkgPT4gewoJCQkJCQlsb2FkaW5nLmxvYWRlci5zZXRWYWx1ZShNYXRoLnJvdW5kKHZhbCAqIDEwMC4wKSk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJCXRyeSB7CgkJCWxvYWRpbmcubG9hZGVyLnNldFByb2dyZXNzKChsb2FkaW5nLnBvc2l0aW9uKyspIC8gbG9hZGluZy5zdGVwcyk7CgkJCS8vbG9hZGluZy5sb2FkZXIuc2V0VmFsdWUoMTAwKmxvYWRpbmcucG9zaXRpb24vbG9hZGluZy5zdGVwcyArICclJyk7CgkJfSBjYXRjaCAoZSkgewoJCQkvKmNvbnNvbGUubG9nKCIlTE9BREVSOiAiICsgZS5tZXNzYWdlKTsqLwoJCX0KCX0KCglfYXBwbHkobywgZm4sIHNjb3BlID0gW10pIHsKCQlmb3IgKGxldCBpIGluIG8pIHsKCQkJZm4uYXBwbHkodGhpcywgW2ksIG9baV0sIHNjb3BlXSk7CgkJCWlmIChvW2ldICE9PSBudWxsICYmIHR5cGVvZiBvW2ldID09PSAib2JqZWN0IikgewoJCQkJdGhpcy5fYXBwbHkob1tpXSwgZm4sIHNjb3BlLmNvbmNhdChpKSk7CgkJCX0KCQl9Cgl9CgoJc2V0VVJMKHVybCkgewoJCWlmICh0aGlzLmFsbERhdGEucGFnZSkgaGlzdG9yeS5wdXNoU3RhdGUoewoJCQlfY29kZTogdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGUKCQl9LCB0aGlzLmFsbERhdGEucGFnZS5fdGl0bGUsIHRoaXMudG9IYXNoKCkpOwoKCQlpZiAod2luZG93LmxvY2F0aW9uID09PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uICYmIHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQkvLyBpbnNpZGUgYSB3aW5kb3cKCQkJbGV0IHNVUkwgPSAiIjsKCQkJdGhpcy5fYXBwbHkodXJsLCAoa2V5LCB2YWx1ZSwgc2NvcGUpID0+IHNVUkwgKz0gKHR5cGVvZih2YWx1ZSkgIT09ICJvYmplY3QiID8gKHNjb3BlLm1hcCh4ID0+IHggKyAiLiIpLmpvaW4oJycpICsga2V5ICsgIj0iICsgdmFsdWUgKyAiJiIpIDogIiIpKTsKCQkJdXJsID0gc1VSTDsKCQkJLy9jb25zb2xlLmxvZygic2V0VVJMOiB1cmwiLCB1cmwpCgkJfSBlbHNlIGlmICh0eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKCQkJdGhpcy5SZW5kZXJQYWdlKHsKCQkJCV9jb2RlOiB1cmwucGFnZQoJCQl9LCB1cmwpOwoJCX0KCQlsb2NhdGlvbi5oYXNoID0gIiMiICsgdXJsOwoJfQoKCWZyb21IYXNoKCkgewoJCXRoaXMuaGFzaCA9IHt9OwoJCShsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoKS5yZXBsYWNlKC8jL2csICImIikucmVwbGFjZSgvXD8vZywgJycpLnNwbGl0KCImIikuZmlsdGVyKGUgPT4gZSkuZm9yRWFjaChlID0+IHsKCQkJdHJ5IHsKCQkJCXRoaXMuaGFzaFtlLnNwbGl0KCI9IilbMF1dID0gZS5zcGxpdCgiPSIpWzFdOwoJCQl9IGNhdGNoIChleCkge30KCQl9KTsKCQlPYmplY3Qua2V5cyh0aGlzLmhhc2gpLmZvckVhY2goaCA9PiB0aGlzLmhhc2hbaF0gPSBkZWNvZGVVUkkodGhpcy5oYXNoW2hdKSk7CgkJcmV0dXJuIHRoaXMuaGFzaDsKCX0KCgl0b0hhc2goKSB7CgkJdmFyIHJldCA9ICIjIjsKCQlmb3IgKHZhciBwIGluIHRoaXMuaGFzaCkgewoJCQlyZXQgKz0gcCArICI9IiArIHRoaXMuaGFzaFtwXTsKCQl9CgkJcmV0dXJuIHJldDsKCX0KCglzdHJpcEhUTUwoZGlydHlTdHJpbmcpIHsKCQlyZXR1cm4gZGlydHlTdHJpbmcucmVwbGFjZSgvPFtePl0qPi9nLCAiIik7Cgl9CgoJRXF1YWxzKGEsIGIpIHsKCQkvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIHRyZWF0ZWQgYXMgdGhlIHNhbWU6IGVxdWFsCgkJdmFyIF9hID0gYSB8fCBudWxsOwoJCXZhciBfYiA9IGIgfHwgbnVsbDsKCQlpZiAoX2EgPT09IF9iKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIV9hIHx8ICFfYikgcmV0dXJuIGZhbHNlOyAvLyBvbmUgaXMgbnVsbCBhbmQgdGhlIG90aGVyIGlzIG5vdAoJCS8vIGlmKHR5cGVvZiBhID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgYiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIHVuZGVmaW5lZAoJCWlmICgoX2EudG9FbnRpdHlPYmplY3QgJiYgIV9iLnRvRW50aXR5T2JqZWN0KSB8fCAoX2IudG9FbnRpdHlPYmplY3QgJiYgIV9hLnRvRW50aXR5T2JqZWN0KSkgcmV0dXJuIGZhbHNlOyAvLyBib3RoIHNob3VsZCBiZSBlaXRoZXIgRU1TIG9yIG5vbiBFTVMgb2JqZWN0cwoJCS8vY29uc29sZS5sb2coIkVxdWFsczogYXQgdGhpcyBwb2ludDogYT0iK19hKyIsIGI9IitfYik7CgkJLy8gc2FmZTogYm90aCBlaXRoZXIgRU1TIG9yIG5vbiBFTVMKCQlpZiAoX2EudG9FbnRpdHlPYmplY3QpIHJldHVybiBfYS5FcXVhbHMoX2IpOyAvLyBFTVMgYnVuZGVscyB0aGUgRXF1YWxzIGZ1bmN0aW9ucwoJCWlmIChfYS5JZCAmJiBfYi5JZCAmJiBfYS5JZCA9PSBfYi5JZCkgcmV0dXJuIHRydWU7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIG5QYXJlbnQpIHsKCQkvLyBmaW5kIHRoZSBjaGlsZHJlbiBvZiB0aGUgblBhcmVudCBub2RlCgkJdmFyIGNoaWxkcmVuID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhck5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCXRyeSB7CgkJCQlpZiAoblBhcmVudCkgewoJCQkJCXRyeSB7CgkJCQkJCS8vY29uc29sZS5sb2coIk5vZGU6ICIgKyBhck5vZGVzW2ldLl9uYW1lICsgIiwgUGFyZW50OiAiICsgblBhcmVudC5fbmFtZSArICIsIEVxdWFsOiAiICsgKGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJXSEFUPyAiICsgblBhcmVudC5fbmFtZSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChhck5vZGVzW2ldW3NQYXJlbnRdID09IG5QYXJlbnQgfHwgKGFyTm9kZXNbaV1bc1BhcmVudF0gJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMgJiYgYXJOb2Rlc1tpXVtzUGFyZW50XS5FcXVhbHMoblBhcmVudCkpIHx8IChhck5vZGVzW2ldW3NQYXJlbnRdLklkICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uSWQgPT0gblBhcmVudC5JZCkpIHsKCQkJCQkvL2lmKG5QYXJlbnQpIGNvbnNvbGUubG9nKCJmb3VuZCBjaGlsZCBvZiAiICsgblBhcmVudC5fbmFtZSArICI6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQkvL2lmKCFuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgcm9vdCBub2RlIDogIiArIGFyTm9kZXNbaV0uX25hbWUpOwoJCQkJCWNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aF0gPSBhck5vZGVzW2ldOwoJCQkJfQoJCQl9IGNhdGNoIChlKSB7CgkJCQkvL2NvbnNvbGUubG9nKCJpPSIgKyBpICsgIiwgIiArIGUubWVzc2FnZSk7CgkJCX0KCQl9CgkJaWYgKG5QYXJlbnQpIG5QYXJlbnRbc0NoaWxkcmVuXSA9IGNoaWxkcmVuOwoJCWZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewoJCQkvL2NvbnNvbGUubG9nKCJCdWlsZGluZyBzdWJ0cmVlIik7CgkJCWJ1aWxkVHJlZShhck5vZGVzLCBzUGFyZW50LCBzQ2hpbGRyZW4sIGNoaWxkcmVuW2ldKTsKCQl9Cgl9CgoJbSgpIHsKCQkvL3JldHVybiAodGhpcy5pc01vYmlsZSgpID8gIiIgOiAiL2QiKTsKCQlyZXR1cm4gIi9kIjsKCX0KCglpc01vYmlsZSgpIHsKCQkvL3JldHVybiB0aGlzLnNyKCkuaXNNb2JpbGU7CgkJdHJ5IHsKCQkJaWYgKGNvbXBhbnkuUmVzcG9uc2l2ZSkgcmV0dXJuIGZhbHNlOwoJCX0gY2F0Y2ggKGUpIHt9CgkJdmFyIGNoZWNrID0gZmFsc2U7CgkJKChhLCBiKSA9PiB7CgkJCWlmICgvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm8vaS50ZXN0KGEpIHx8IC8xMjA3fDYzMTB8NjU5MHwzZ3NvfDR0aHB8NTBbMS02XWl8Nzcwc3w4MDJzfGEgd2F8YWJhY3xhYyhlcnxvb3xzXC0pfGFpKGtvfHJuKXxhbChhdnxjYXxjbyl8YW1vaXxhbihleHxueXx5dyl8YXB0dXxhcihjaHxnbyl8YXModGV8dXMpfGF0dHd8YXUoZGl8XC1tfHIgfHMgKXxhdmFufGJlKGNrfGxsfG5xKXxiaShsYnxyZCl8YmwoYWN8YXopfGJyKGV8dil3fGJ1bWJ8YndcLShufHUpfGM1NVwvfGNhcGl8Y2N3YXxjZG1cLXxjZWxsfGNodG18Y2xkY3xjbWRcLXxjbyhtcHxuZCl8Y3Jhd3xkYShpdHxsbHxuZyl8ZGJ0ZXxkY1wtc3xkZXZpfGRpY2F8ZG1vYnxkbyhjfHApb3xkcygxMnxcLWQpfGVsKDQ5fGFpKXxlbShsMnx1bCl8ZXIoaWN8azApfGVzbDh8ZXooWzQtN10wfG9zfHdhfHplKXxmZXRjfGZseShcLXxfKXxnMSB1fGc1NjB8Z2VuZXxnZlwtNXxnXC1tb3xnbyhcLnd8b2QpfGdyKGFkfHVuKXxoYWllfGhjaXR8aGRcLShtfHB8dCl8aGVpXC18aGkocHR8dGEpfGhwKCBpfGlwKXxoc1wtY3xodChjKFwtfCB8X3xhfGd8cHxzfHQpfHRwKXxodShhd3x0Yyl8aVwtKDIwfGdvfG1hKXxpMjMwfGlhYyggfFwtfFwvKXxpYnJvfGlkZWF8aWcwMXxpa29tfGltMWt8aW5ub3xpcGFxfGlyaXN8amEodHx2KWF8amJyb3xqZW11fGppZ3N8a2RkaXxrZWppfGtndCggfFwvKXxrbG9ufGtwdCB8a3djXC18a3lvKGN8ayl8bGUobm98eGkpfGxnKCBnfFwvKGt8bHx1KXw1MHw1NHxcLVthLXddKXxsaWJ3fGx5bnh8bTFcLXd8bTNnYXxtNTBcL3xtYSh0ZXx1aXx4byl8bWMoMDF8MjF8Y2EpfG1cLWNyfG1lKHJjfHJpKXxtaShvOHxvYXx0cyl8bW1lZnxtbygwMXwwMnxiaXxkZXxkb3x0KFwtfCB8b3x2KXx6eil8bXQoNTB8cDF8diApfG13YnB8bXl3YXxuMTBbMC0yXXxuMjBbMi0zXXxuMzAoMHwyKXxuNTAoMHwyfDUpfG43KDAoMHwxKXwxMCl8bmUoKGN8bSlcLXxvbnx0Znx3Znx3Z3x3dCl8bm9rKDZ8aSl8bnpwaHxvMmltfG9wKHRpfHd2KXxvcmFufG93ZzF8cDgwMHxwYW4oYXxkfHQpfHBkeGd8cGcoMTN8XC0oWzEtOF18YykpfHBoaWx8cGlyZXxwbChheXx1Yyl8cG5cLTJ8cG8oY2t8cnR8c2UpfHByb3h8cHNpb3xwdFwtZ3xxYVwtYXxxYygwN3wxMnwyMXwzMnw2MHxcLVsyLTddfGlcLSl8cXRla3xyMzgwfHI2MDB8cmFrc3xyaW05fHJvKHZlfHpvKXxzNTVcL3xzYShnZXxtYXxtbXxtc3xueXx2YSl8c2MoMDF8aFwtfG9vfHBcLSl8c2RrXC98c2UoYyhcLXwwfDEpfDQ3fG1jfG5kfHJpKXxzZ2hcLXxzaGFyfHNpZShcLXxtKXxza1wtMHxzbCg0NXxpZCl8c20oYWx8YXJ8YjN8aXR8dDUpfHNvKGZ0fG55KXxzcCgwMXxoXC18dlwtfHYgKXxzeSgwMXxtYil8dDIoMTh8NTApfHQ2KDAwfDEwfDE4KXx0YShndHxsayl8dGNsXC18dGRnXC18dGVsKGl8bSl8dGltXC18dFwtbW98dG8ocGx8c2gpfHRzKDcwfG1cLXxtM3xtNSl8dHhcLTl8dXAoXC5ifGcxfHNpKXx1dHN0fHY0MDB8djc1MHx2ZXJpfHZpKHJnfHRlKXx2ayg0MHw1WzAtM118XC12KXx2bTQwfHZvZGF8dnVsY3x2eCg1Mnw1M3w2MHw2MXw3MHw4MHw4MXw4M3w4NXw5OCl8dzNjKFwtfCApfHdlYmN8d2hpdHx3aShnIHxuY3xudyl8d21sYnx3b251fHg3MDB8eWFzXC18eW91cnx6ZXRvfHp0ZVwtL2kudGVzdChhLnN1YnN0cigwLCA0KSkpIGNoZWNrID0gdHJ1ZQoJCX0pKG5hdmlnYXRvci51c2VyQWdlbnQgfHwgbmF2aWdhdG9yLnZlbmRvciB8fCB3aW5kb3cub3BlcmEpOwoJCXJldHVybiBjaGVjazsKCX0KCglfZXJyb3IobXNnLCBkZWxheSkgewoJCWlmICh0eXBlb2Yobm90eSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW5vdHkoewoJCQkJdGV4dDogbXNnLAoJCQkJdHlwZTogJ2Vycm9yJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0Vycm9yJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJX2FsZXJ0KG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdzdWNjZXNzJywKCQkJCXRpbWVvdXQ6IGRlbGF5CgkJCX0pOwoJCX0gZWxzZSB7CgkJCS8vIHRoZSBkZWZhdWx0CgkJCSQoIjxkaXYgdGl0bGU9J0luZm9ybWF0aW9uJz48cD4iICsgbXNnICsgIjwvcD48L2Rpdj4iKS5kaWFsb2coKTsKCQl9Cgl9CgoJbXlSZXBsYWNlKHMsIGFyRnJvbSwgYXJUbykgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJGcm9tLmxlbmd0aDsgaSsrKSB7CgkJCXMgPSBzLnJlcGxhY2UobmV3IFJlZ0V4cChhckZyb21baV0sICdnJyksIGFyVG9baV0pOwoJCX0KCQlyZXR1cm4gczsKCX0KCglfaW5qZWN0KGh0bWwsIGRhdGEsIGVuZ2luZSkgewoJCWlmICghaHRtbCkgcmV0dXJuIGh0bWw7CgkJaWYgKHR5cGVvZihodG1sKSA9PT0gJ29iamVjdCcpIHsKCQkJcmV0dXJuICQuZXh0ZW5kKHt9LCAuLi5PYmplY3Qua2V5cyhodG1sKS5tYXAoayA9PiAoewoJCQkJW2tdOiB0aGlzLl9pbmplY3QoaHRtbFtrXSwgZGF0YSkKCQkJfSkpKTsKCQl9CgkJaWYgKHR5cGVvZihodG1sKSAhPT0gJ3N0cmluZycpIHJldHVybiBodG1sOwoKCQl0cnkgewoJCQlpZiAodHlwZW9mKGpzb25hdGEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4ganNvbmF0YShodG1sKS5ldmFsdWF0ZShkYXRhKTsKCQkJCX0gY2F0Y2ggKF9leCkge30KCQkJfQoKCQkJaWYgKHR5cGVvZiBFSlMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdFSlMnKSkgewoJCQkJcmV0dXJuIG5ldyBFSlMoewoJCQkJCXRleHQ6IGh0bWwKCQkJCX0pLnJlbmRlcihkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgZG9UICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnZG9UJykpIHsKCQkJCXJldHVybiBkb1QudGVtcGxhdGUoaHRtbCkoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIF8gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIF8udGVtcGxhdGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICd1bmRlcnNjb3JlJykpIHsKCQkJCXJldHVybiBfLnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBNdXN0YWNoZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ011c3RhY2hlJykpIHsKCQkJCXJldHVybiBNdXN0YWNoZS5yZW5kZXIoaHRtbCwgZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIEhhbmRsZWJhcnMgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdIYW5kbGViYXJzJykpIHsKCQkJCXJldHVybiBIYW5kbGViYXJzLmNvbXBpbGUoaHRtbCkudGVtcGxhdGUoZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gaHRtbDsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJfaW5qZWN0IEV4Y2VwdGlvbjogIiwgZXgsIGRhdGEgLyosIGh0bWwqLyApOwoJCQlyZXR1cm4gaHRtbDsKCQl9Cgl9CgoJX2Mob2JqLCBmQ2FsbEJhY2ssIHNNZXRob2QsIC4uLmFyUmVzdCkgewoJCXRoaXMuX2NhbGxzLnNwbGljZSgwLCAwLCB7CgkJCUNhbGxiYWNrOiBmQ2FsbEJhY2ssCgkJCW9iajogb2JqLAoJCQlOYW1lOiBzTWV0aG9kLAoJCQlhcmdzOiBhclJlc3QsCgkJfSk7Cgl9CgoJYXN5bmMgZG9DYWxscygpIHsKCQl0aGlzLl9jYWxscy5yZXZlcnNlKCk7CgkJdmFyIGFyQ2FsbHMgPSBbXTsKCQkkLmVhY2godGhpcy5fY2FsbHMsIChfLCBjKSA9PiB7CgkJCWlmIChjLk5hbWUpIHsKCQkJCXZhciBhcmdzID0gW2Mub2JqXTsKCQkJCWlmIChjLmFyZ3MubGVuZ3RoKSBhcmdzID0gYXJncy5jb25jYXQoYy5hcmdzKTsKCQkJCWFyQ2FsbHMucHVzaCh0aGlzLnNyKCkuXyhjLk5hbWUsIG51bGwsIC4uLmFyZ3MpKTsKCQkJfSBlbHNlIGlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBudWxsLCB7CgkJCQkJRW50aXR5T2JqZWN0OiAoYy5vYmogPyBjLm9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJCQl9KSk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gJC53aGVuKC4uLmFyQ2FsbHMpLnRoZW4oKC4uLnJldCkgPT4gewoJCQkkLmVhY2gocmV0LCAoaSwgcikgPT4gewoJCQkJaWYgKHIgJiYgci5sZW5ndGggJiYgclswXS5PcmRlcikgewoJCQkJCXIuc29ydCgoYSwgYikgPT4gewoJCQkJCQlpZiAoYS5PcmRlciA8IGIuT3JkZXIpIHJldHVybiAtMTsKCQkJCQkJaWYgKGEuT3JkZXIgPiBiLk9yZGVyKSByZXR1cm4gMTsKCQkJCQkJcmV0dXJuIDA7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAodGhpcy5fY2FsbHNbaV0uQ2FsbGJhY2spIHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKHIpOwoJCQl9KTsKCQl9KS50aGVuKCgpID0+IHsKCQkJdGhpcy5fY2FsbHMgPSBbXTsKCQl9KTsKCX0KCglfbyhmQ2FsbEJhY2ssIG9iaikgewoJCXRoaXMuc3RlcCgpOwoJCWlmICh0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSByZXR1cm4gdGhpcy5zcigpLl8oImVtc0Zvcm1WYWx1ZXMiLCBmQ2FsbEJhY2ssIHsKCQkJRW50aXR5T2JqZWN0OiAoKG9iaiAmJiBvYmoudG9FbnRpdHlPYmplY3QpID8gb2JqLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQl9KTsKCX0KCglyYW5kVVJMKHVybCA9ICcnKSB7CgkJcmV0dXJuIHVybCArICI/X19yYW5kPSIgKyBNYXRoLnJhbmRvbSgpOwoJfQoKCXRvU2V0dGluZ3MocywgbykgewoJCXJldHVybiBzOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoIXNbaV0uUGFyZW50KSB7fQoJCX0KCX0KCglleHRUeXBlKHYpIHsKCQlyZXR1cm4gKHsKCQkJaHRtbDogJ2h0bWwnLAoJCQlodG06ICdodG1sJywKCQkJeG1sOiAnaHRtbCcsCgkJCWpzOiAnamF2YXNjcmlwdCcsCgkJCWNzOiAnY3NoYXJwJywKCQkJcHk6ICdweXRob24nLAoJCQlqc3g6ICdqYXZhc2NyaXB0JywKCQl9IFt2Lm1hdGNoKC9cLlteLlxcLzoqPyI8PnxcclxuXSskLylbMF0ucmVwbGFjZSgnLicsICcnKV0gfHwgInRleHQiKTsKCX0KCglfbG9hZGluZyhvbiA9IHRydWUsIGludGVydmFsID0gMzAwLCBtc2csIHRpdGxlKSB7CgkJaWYgKHR5cGVvZigkLm1lc3NhZ2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJaWYgKG9uKSB7CgkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKHsKCQkJCQl0aXRsZTogdGl0bGUgfHwgJ0xvYWRpbmcnLAoJCQkJCW1zZzogbXNnIHx8ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCV9GckVNRC5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IChvRWxlbWVudC5pbnRlcnZhbCB8fCA2MDApIDogNjAwLCAnU2F2aW5nIGRhdGEuLi4nLCAnUHJvZ3Jlc3MnKTsKCQkJCQl0cnkgewoJCQkJCQlhd2FpdCBzYXZlcih2YWx1ZSwgZkRhdGEpOwoJCQkJCQllZGl0b3IubGFzdFNhdmVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gU2F2ZSBmaWxlLlxuIiArIGV4KTsKCQkJCQl9CgkJCQkJX0ZyRU1ELl9sb2FkaW5nKGZhbHNlKTsKCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQlqc3ggPSBhd2FpdCB0aGlzLl9nZXQoKGxvY2F0aW9uIHx8ICJ0ZW1wbGF0ZXMiKSArIHRoaXMubSgpICsgIi8iICsgKHBhZ2UuX2NvZGUgfHwgcGFnZSkgKyAiLmpzeCIsIHRydWUpOwoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfcmVuZGVyKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQljb25zb2xlLmxvZygiUmVuZGVyUGFnZSIsIHBhZ2UsIGRhdGEpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYWdlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5wYWdlc1tpXS5fY29kZSA9PSBwYWdlLl9jb2RlICYmIHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlICYmICh0aGlzLnBhZ2VzW2ldLl9sYW5ndWFnZSA9PSAod2luZG93LmxhbmcgfHwgY29tcGFueS5MYW5ndWFnZSB8fCAiZW4iKSkpIHsKCQkJCWNvbnNvbGUubG9nKCh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKTsKCQkJCXBhZ2UgPSB0aGlzLnBhZ2VzW2ldOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJaWYgKCF0aGlzLnNyKCkuYkxvY2FsICYmIChwYWdlLkJvZHkgfHwgcGFnZS50b0VudGl0eU9iamVjdCkpIHsKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGFscmVhZHkgbG9hZGVkLCBzZXJ2aW5nLi4uIik7CgkJCS8vIGZvdW5kIHRoZSBwYWdlIGFuZCBpdCBpcyBhbiBvYmplY3QKCQkJaWYgKCFwYWdlLlNjcmlwdCkgewoJCQkJbGV0IGUgPSBhd2FpdCB0aGlzLmVuZCgpOwoJCQkJcmV0dXJuIGU7CgkJCX0KCQkJYXdhaXQgdGhpcy5ydW5TY3JpcHQocGFnZS5TY3JpcHQpOwoJCX0KCQlsZXQgcmV0ID0gbnVsbDsKCgkJaWYgKHRoaXMuYXBpU2VydmVyICYmIHRoaXMuYXBpU2VydmVyLl9uZXcoJ0hUTUxQYWdlJykpIHsKCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLl9mcm9tRmlsZU5hbWUodGhpcy5wYXRoVG9OYW1lKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKSkuZmluZCgpOwoJCQlpZiAocCkgcmV0ID0gewoJCQkJU2NyaXB0OiBhd2FpdCB0aGlzLnJ1blNjcmlwdChwLnNjcmlwdCgpIHx8ICcnKSwKCQkJCUJvZHk6IHAuYm9keSgpIHx8ICcnLAoJCQkJU3R5bGU6IHAuc3R5bGUoKSB8fCAnJywKCQkJCV9jb2RlOiBwYWdlLl9jb2RlLAoJCQl9OwoJCQljb25zb2xlLmxvZygiX3JlbmRlcigiICsgdGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyAiL3RlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUgKyAiKSB1c2luZyBhcGlTZXJ2ZXIiLCBwLCByZXQpOwoJCX0KCgkJaWYgKHJldCkgewoJCQkvLyBzdG9yZSB0byBhdm9pZCByZWR1bmRhbnQgbG9hZGluZwoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZm91bmQgaW4gQ01TLCBzZXJ2aW5nLi4uIik7CgkJCXBhZ2UgPSByZXQ7CgkJfSBlbHNlIHsKCQkJcGFnZS5Cb2R5ID0gYXdhaXQgdGhpcy5pbXBvcnQoInRlbXBsYXRlcyIgKyB0aGlzLm0oKSArICIvIiArIHBhZ2UuX2NvZGUsIHsKCQkJCWV4dDogJ2h0bScsCgkJCQlmaWVsZDogJ2JvZHknLAoJCQl9KTsKCgkJCWlmICghcGFnZS5Cb2R5ICYmIHR5cGVvZihSZWFjdCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihNYWluQ29tcG9uZW50KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXBhZ2UuQm9keSA9ICI8ZGl2IGlkPSdmb3JtQ29tcG9uZW50Jy8+IjsKCQkJfSBlbHNlIGlmICh0eXBlb2YodnVlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXBhZ2UuQm9keSA9IC8qcGFnZS5fY29udGVudCB8fCAqLyAiPCEtLSIgKyAoIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGRvZXMgbm90IGV4aXN0IikgKyAiLS0+IjsKCQkJfQoKCQkJcGFnZS5TY3JpcHQgPSBhd2FpdCB0aGlzLmltcG9ydCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSwgewoJCQkJZXh0OiAnanMnLAoJCQkJZmllbGQ6ICdzY3JpcHQnLAoJCQl9KTsKCgkJCS8vIG9ubHkgY2FjaGUgcGFnZXMgdGhhdCBjb21lIGZyb20gRU1TCgkJCWlmIChwYWdlLnRvRW50aXR5T2JqZWN0KSB0aGlzLnBhZ2VzLnB1c2gocGFnZSk7CgkJfQoJCXBhZ2UuZGF0YSA9IGRhdGE7CgoJCS8vaWYgKHBhZ2UuU2NyaXB0KSBwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQl0cnkgewoJCQljdXN0b21FbGVtZW50cy5kZWZpbmUocGFnZS5fY29kZSwgcGFnZS5jb21wb25lbnQgPSB2dWUuZGVmaW5lQ3VzdG9tRWxlbWVudChPYmplY3QuYXNzaWduKG5ldyBwYWdlLlNjcmlwdCgpLCB7CgkJCQl0ZW1wbGF0ZTogcGFnZS5Cb2R5LAoJCQkJc3R5bGVzOiBbcGFnZS5TdHlsZV0KCQkJfSkpKTsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IHBhZ2UgYXMgdnVlanMgY3VzdG9tIGVsZW1lbnQiLCBwYWdlKTsKCQkJcGFnZS5Cb2R5ID0gbnVsbDsKCQkJLy9wYWdlLlNjcmlwdCA9IG51bGw7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIkZyRU1EOjpfcmVuZGVyKCIgKyBwYWdlLl9jb2RlICsgIik6IFZ1ZSBFeGNlcHRpb246ICIgKyBleCk7CgkJCXBhZ2UuY29tcG9uZW50ID0gbnVsbDsKCQl9CgoJCWlmICh0eXBlb2YocGFnZS5TY3JpcHQpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZihwYWdlLlNjcmlwdC5jb25zdHJ1Y3RvcikgPT09ICJmdW5jdGlvbiIgJiYgIXBhZ2UuY29tcG9uZW50KSB7CgkJCXRyeSB7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlpZiAocGFnZS5jb21wb25lbnQgJiYgcGFnZS5jb21wb25lbnQubWFpbikgewoJCQkJCWNvbnNvbGUubG9nKCJDYWxsaW5nIHBhZ2VbIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UuUGFnZSB8fCBwYWdlKSArICJdLlNjcmlwdC5tYWluKCkiKTsKCQkJCQlhd2FpdCBwYWdlLmNvbXBvbmVudC5tYWluKCk7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQ6Ol9yZW5kZXIoIiArIHBhZ2UuX2NvZGUgKyAiKTogbmV3IHBhZ2UuU2NyaXB0KCkgRXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgkJfQoJCXJldHVybiBwYWdlOwoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJGckVNRDo6ZW5kKCk6IGRhdGEiLCBkYXRhLCB0aGlzLmFsbEhUTUwpOwoJCXZhciBzSFRNTCA9IHRoaXMuX2luamVjdCh0aGlzLmFsbEhUTUwsIGRhdGEpOwoJCXZhciBvQ29udGVudCA9ICQoJ2JvZHknKTsKCgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSBkb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCgkJCWlmICh0eXBlb2YodnVlKSAhPT0gJ3VuZGVmaW5lZCcgJiYgcGFnZS5jb21wb25lbnQgJiYgdHlwZW9mKHBhZ2UuY29tcG9uZW50LmRlZikgPT09ICdvYmplY3QnKSB7CgkJCQljb25zb2xlLmxvZygiZW5kKCk6IGFkZGluZyBWdWVKUyBDb21wb25lbmV0IHRvIHBhZ2UiLCBwYWdlKTsKCQkJCW9Db250ZW50LmFwcGVuZChuZXcgcGFnZS5jb21wb25lbnQoKSk7CgkJCX0KCQl9IGVsc2UgewoJCQl2YXIgb1BhZ2UgPSAkKHNIVE1MKTsKCQkJb1BhZ2UuYXBwZW5kVG8oJC5tb2JpbGUucGFnZUNvbnRhaW5lcik7CgkJCXZhciBvbGQgPSB0cnVlOwoJCQl0aGlzLmFsbE9wdGlvbnMgPSB0aGlzLmFsbE9wdGlvbnMgfHwge307CgkJCWlmIChvbGQpIHsKCQkJCXRoaXMuYWxsT3B0aW9ucy5kYXRhVXJsID0gdGhpcy5hbGxEYXRhLnBhZ2UuX2NvZGU7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmFjdGl2ZVBhZ2UucmVtb3ZlKCk7CgkJCQlpZiAoJC5tb2JpbGUpICQubW9iaWxlLmNoYW5nZVBhZ2Uob1BhZ2UsIHRoaXMuYWxsT3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQkkKCJkb2N1bWVudCIpLnBhZ2Vjb250YWluZXIoImdldEFjdGl2ZVBhZ2UiKS5yZW1vdmUoKTsKCQkJCW9QYWdlLmVuaGFuY2VXaXRoaW4oKTsKCQkJCSQoIjptb2JpbGUtcGFnZWNvbnRhaW5lciIpLnBhZ2Vjb250YWluZXIoImNoYW5nZSIsICcjJyArIGRhdGEucGFnZS5fY29kZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJCWNvbnNvbGUubG9nKCJzaG93ZWQiKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmNzcykgewoJCQlpZiAodGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuY3NzLm1vYmlsZSkgewoJCQkJY29tcGFueS5jc3MubW9iaWxlLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MuZGVza3RvcCkgewoJCQkJY29tcGFueS5jc3MuZGVza3RvcC5mb3JFYWNoKG0gPT4gdGhpcy5fY3NzKG0pKTsKCQkJfQoJCX0KCQlpZiAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55LmpzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5tb2JpbGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgY29tcGFueS5qcy5tb2JpbGUubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMubW9iaWxlW2ldKTsKCQkJfSBlbHNlIGlmICghdGhpcy5pc01vYmlsZSgpICYmIGNvbXBhbnkuanMuZGVza3RvcCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLmRlc2t0b3AubGVuZ3RoOyBpKyspICQuZ2V0U2NyaXB0KGNvbXBhbnkuanMuZGVza3RvcFtpXSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoUmVhY3RET00pICE9PSAidW5kZWZpbmVkIikgewoJCQlpZiAodHlwZW9mKE1haW5Db21wb25lbnQpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbkNvbXBvbmVudCcpOwoJCQkJaWYgKCFlKSB7CgkJCQkJZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQkJCWUuc2V0QXR0cmlidXRlKCJpZCIsICJtYWluQ29tcG9uZW50Iik7CgkJCQkJZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsKCQkJCX0KCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5Db21wb25lbnQsIG51bGwpLCBlKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoRm9ybUNvbXBvbmVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQlSZWFjdERPTS5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChGb3JtQ29tcG9uZW50LCBudWxsKSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm1Db21wb25lbnQnKSk7CgkJCX0KCQl9CgkJaWYgKHdpbmRvdy5ERm9ybSkgewoJCQl0cnkgewoJCQkJd2luZG93LkRGb3JtLmluaXQoKTsKCQkJCXdpbmRvdy5ERm9ybS5wYXJzZSgpOwoJCQkJd2luZG93LkRGb3JtLmJpbmQoKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJERm9ybSBGdW5jdGlvbnMgZmFpbGVkIiwgZXgpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuT25QYWdlTG9hZCkgewoJCQl0cnkgewoJCQkJYXdhaXQgY29tcGFueS5PblBhZ2VMb2FkKGRhdGEpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkZyRU1ELmVuZC5PblBhZ2VMb2FkIiwgZXgpOwoJCQl9CgkJfQoKCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCWF3YWl0IHdpbmRvdy5ERm9ybS5fZW5kKCk7CgkJfQoKCQl0cnkgewoJCQkvLyBmaW5kIGEgYmV0dGVyIHdheSB0byByZS1pbnZva2UgYWxsIHdpbmRvdyBsb2FkIGV2ZW50cy4KCQkJbGV0IGxvYWRlcnMgPSAoalF1ZXJ5Ll9kYXRhIHx8IGpRdWVyeS5kYXRhKSh3aW5kb3csICdldmVudHMnKS5sb2FkIHx8IFtdOwoJCQlsb2FkZXJzLmZvckVhY2goZiA9PiBmLmhhbmRsZXIoKSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJY29uc29sZS5sb2coIlBhZ2UgTG9hZGVkOiAiICsgKHBhZ2UuX2NvZGUgfHwgcGFnZS5QYWdlIHx8IHBhZ2UpKTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"storedMethod": null,
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195e6fefff87799b1b4489502fe4cf4",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "0195e6fefff87799b1b44f7276869efd",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
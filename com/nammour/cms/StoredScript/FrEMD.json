{
	"Id": "1410b651fddd2da6964125e383251482ccfd3ed6",
	"name": "FrEMD",
	"script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSA8PCA0KSB8IChiMiA+PiA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgPDwgMikgfCAoYjMgPj4gNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfTsKCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIF9ocmVmcy5maWx0ZXIobCA9PiBsLmxpYiA9PT0gbGliTmFtZSAmJiB0aGlzLl9pbmNsdWRlKGwpKSkgewoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0KCgkJCWlmICh0eXBlb2Yobi5zcmMpID09PSAndW5kZWZpbmVkJyAmJiBuLnNjcmlwdCAmJiAhbW9kdWxlcy5sZW5ndGgpIHsKCQkJCWlmICh0eXBlb2Yobi5zY3JpcHQpID09PSAnZnVuY3Rpb24nKSBuLnNjcmlwdCA9IG4uc2NyaXB0KCk7CgkJCQltb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KG4uc2NyaXB0LCBuLm5vUnVuKSk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IGF3YWl0IHJlcy50ZXh0KCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJzsKCQkJCQlqcyA9IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCFqcykganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IGJsb2NrCgkJCX0sICJibG9ja3MiKTsKCgkJCWlmICghanMgJiYgd2luZG93LmJMb2NhbCkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5qcyIpKTsKCQkJCWpzID0ganMub2sgPyAoYXdhaXQganMudGV4dCgpKSA6IG51bGw7CgkJCX0KCgkJCWlmIChqcykgewoJCQkJanMgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcyk7CgkJCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJaWYgKCFodG1sICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQkJaHRtbCA9IGh0bWwub2sgPyAoYXdhaXQgaHRtbC50ZXh0KCkpIDogJyc7CgkJfQoJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbDsKCgkJaWYgKGpzICYmICF0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbYmxvY2sgKyAiQ29tcG9uZW50Il0pIHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSAiPCIgKyBibG9jayArICJDb21wb25lbnQvPiI7CgkJfQoJCXRoaXMuc3RlcCgpOwoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCIuLi8uLi8iICsgKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgZmV0Y2godXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQkvL3Njb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoIiArIHNjb3BlICsgIik6IGZhaWxlZCB0byBsb2FkIGNsYXNzZXMuLi4iKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcyk7Cgl9CgoJX21lbnVDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gW107CgoJCXJldHVybiB0aGlzLnNyKCkuZ3JvdXBCeShvU2NvcGUuRW50aXR5Q2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLm1hcChnID0+ICh7CgkJCWxhYmVsOiAoZy5rZXkgPyBnLmtleS5OYW1lIDogbnVsbCkgfHwgJ01haW4nLAoJCQlzdWJNZW51czogdGhpcy5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJbGFiZWw6IChndi5rZXkgPyBndi5rZXkuTmFtZSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiBndnYuTmFtZSwKCQkJCQljb2RlOiAnc3RvcmUnLAoJCQkJCWRhdGE6IGd2di5OYW1lCgkJCQl9KSkKCQkJfSkpCgkJfSkpOwoJfQoKCWFzeW5jIF9sb2FkU2NvcGUoZWMsIHNjb3BlKSB7CgkJdHJ5IHsKCQkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQkJaWYgKHNjb3BlICE9PSAnd2luZG93Jykgd2luZG93W3Njb3BlXSA9IGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSk7CgkJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoJCQlvU2NvcGUuaHJlZnMgPSBbLi4ubmV3IFNldChbLi4ubmV3IFNldCgob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLm1hcChjID0+IGMuVG9vbHMpLmZsYXQoKSldLm1hcCh0ID0+IHRoaXMuaHJlZnMuZmlsdGVyKG4gPT4gbi50b29scyAmJiAoIW4udG9vbHMubGVuZ3RoIHx8IG4udG9vbHMuaW5kZXhPZih0KSA+PSAwKSkpLmZsYXQoKSldOwoJCQlsZXQgbWMgPSAob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLmZpbmQoYyA9PiBjLklzTWFpbik7CgkJCWlmIChtYykgewoJCQkJdGhpcy5hcGlTZXJ2ZXIgPSBhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQkJbG9hZFRvb2xzOiB0cnVlLAoJCQkJCWluaXRTZWxmOiB0cnVlLAoJCQkJCWluaXROb2RlOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJY29uc29sZS5sb2coIl9sb2FkU2NvcGUoIiArIHNjb3BlICsgIik6IGRvbmUhIik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkU2NvcGUoKTogc2NoZW1hIGV4Y2VwdGlvbiAiICsgZXgpOwoJCQlpZiAoZmFsc2UgJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQlOYW1lOiBjb21wYW55LlNjaGVtYSB8fCBjb21wYW55LkNvZGUsCgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQl9KTsKCQl9Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpIHsKCQlpZiAoIW0pIHJldHVybjsKCQlsZXQgbU5hbWUgPSBtLkVudGl0eU1vZHVsZSA/IG0uRW50aXR5TW9kdWxlLk5hbWUgOiBtLk5hbWU7CgkJKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgPSAobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyB8fCAwOwoJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBMb2FkaW5nICIgKyBtTmFtZSk7CgoJCWxldCBlYXMgPSBbXTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJRW50aXR5Q2xhc3M6IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6IG1OYW1lCgkJCQl9CgkJCX0KCQl9KTsKCgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyKTsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGVOYW1lKHNjb3BlKSB7CgkJcmV0dXJuIHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpIHx8ICJ3aW5kb3ciOwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCByU2NvcGUgPSB7CgkJCUVudGl0eUNsYXNzZXM6IHJldCwKCQkJRW50aXR5QXR0cmlidXRlczogZWFzLAoJCX07CgoJCXJTY29wZS5uTmFtZSA9IHJTY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJclNjb3BlLm5Db2RlID0gclNjb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSBodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJykpKTsKCgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICcnOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSAiIjsKCQkJdHJ5IHsKCQkJCWNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJCWM6IGMsCgkJCQkJc2NvcGU6IHNjb3BlLAoJCQkJCW5OYW1lOiByU2NvcGUubk5hbWUsCgkJCQkJbkNvZGU6IHJTY29wZS5uQ29kZSwKCQkJCX0pICsgJ1xuJyArIHJTY29wZS5uTmFtZShjKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfYnVpbGRDbGFzc2VzKCk6IF9pbmplY3QgZXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlID0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7clNjb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke3JTY29wZS5uTmFtZShjKX0gPSAke3JTY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSByU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbclNjb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCX0KCgkJcmV0dXJuIHJTY29wZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gZDsKCQlvU2NvcGUuX190aW1lcyA9IG9TY29wZS5fX3RpbWVzIHx8IHt9OwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gb1Njb3BlLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIG9TY29wZS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSBpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJCUVudGl0eU9iamVjdDogKGMub2JqID8gYy5vYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQkJfSkpOwoJCQl9CgkJfSk7CgkJcmV0dXJuICQud2hlbiguLi5hckNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJJC5lYWNoKHJldCwgKGksIHIpID0+IHsKCQkJCWlmIChyICYmIHIubGVuZ3RoICYmIHJbMF0uT3JkZXIpIHsKCQkJCQlyLnNvcnQoKGEsIGIpID0+IHsKCQkJCQkJaWYgKGEuT3JkZXIgPCBiLk9yZGVyKSByZXR1cm4gLTE7CgkJCQkJCWlmIChhLk9yZGVyID4gYi5PcmRlcikgcmV0dXJuIDE7CgkJCQkJCXJldHVybiAwOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKSB0aGlzLl9jYWxsc1tpXS5DYWxsYmFjayhyKTsKCQkJfSk7CgkJfSkudGhlbigoKSA9PiB7CgkJCXRoaXMuX2NhbGxzID0gW107CgkJfSk7Cgl9CgoJX28oZkNhbGxCYWNrLCBvYmopIHsKCQl0aGlzLnN0ZXAoKTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6ICdMb2FkaW5nJywKCQkJCQltc2c6ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCQkJdGl0bGU6ICdQbGVhc2Ugd2FpdGluZycsCgkJCQkJCQltc2c6ICdTYXZpbmcgZGF0YS4uLicsCgkJCQkJCQlpbnRlcnZhbDogb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglzZWxlY3QyU1Iob1NlbGVjdCkgewoJCWxldCBzID0gJChvU2VsZWN0KTsKCQlsZXQgY2FsbHMgPSBbXTsKCQlpZiAodGhpcy5zZWxlY3QyVGVtcGxhdGUpIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSk7CgkJfSBlbHNlIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNyKCkuR2V0KHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi9zZWxlY3QyLXRlbXBsYXRlLmh0bSIpKSk7CgkJfQoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCXRoaXMuc2VsZWN0MlRlbXBsYXRlID0gcmV0WzBdOwoJCQlzLnNlbGVjdDIoewoJCQkJYWpheDogewoJCQkJCXRyYW5zcG9ydDogKHBhcmFtcywgc3VjY2VzcywgZmFpbHVyZSkgPT4gewoJCQkJCQl2YXIgZkZpbHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQoIihvLCBzdGF0ZSkgPT4geyIgKyBzLmRhdGEoInNyX2ZpbHRlciIpICsgIn0iKTsKCQkJCQkJJC53aGVuKHRoaXMuc3IoKS5fKHMuZGF0YSgic3JfbWV0aG9kIiksIG51bGwsIGZGaWx0ZXIoe30sIHRoaXMuc3IoKS5ydW5TY3JpcHQocy5kYXRhKCJjX3N0YXRlIikpKSkpLnRoZW4ocmV0ID0+IHsKCQkJCQkJCXN1Y2Nlc3MoewoJCQkJCQkJCXBhZ2luYXRpb246IHsKCQkJCQkJCQkJbW9yZTogZmFsc2UKCQkJCQkJCQl9LAoJCQkJCQkJCXJlc3VsdHM6ICQubWFwKHJldCwgciA9PiB7CgkJCQkJCQkJCXIuaWQgPSByLklkOwoJCQkJCQkJCQlyLnRleHQgPSByLlRvU3RyaW5nOwoJCQkJCQkJCQlyZXR1cm4gcjsKCQkJCQkJCQl9KSwKCQkJCQkJCQl0b3RhbHM6IHJldC5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9LAoJCQkJdGVtcGxhdGVSZXN1bHQ6IChfZSwgX3MpID0+IHsKCQkJCQlyZXR1cm4gdGhpcy5faW5qZWN0KHRoaXMuc2VsZWN0MlRlbXBsYXRlLCB7CgkJCQkJCWRhdGE6IF9lCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJCWNvbnNvbGUubG9nKGUudGFyZ2V0KTsKCQkJfSk7CgkJCXMub24oImNoYW5nZS5zZWxlY3QyIiwgZSA9PiB7CgkJCQkvL3ZhciBkYXRhID0gZS5wYXJhbXMuZGF0YTsKCQkJCXZhciBfcyA9ICQoZS50YXJnZXQpOwoJCQl9KTsKCQl9KTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQl0cnkgewoJCQkJanN4ID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfdnVlQ29tcG9uZW50KGNvZGUpIHsKCQlpZiAodHlwZW9mIFZ1ZSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9yZW5kZXIoKSB1c2luZyBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlci5TY29wZSk7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogJycsCgkJCQlCb2R5OiBwLmJvZHkoKSA/IHAuYm9keSgpIDogJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0KSByZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKENNU19ST09UKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJRW50aXR5T2JqZWN0OiAoZW9QYWdlID8gZW9QYWdlLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJfSk7CgkJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCkgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIEVNUywgdHJ5aW5nIHRlbXBsYXRlcyIpOwoJCQkJcGFnZSA9IHJldFswXTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gRU1TLCBzbyBnb2luZyBsb2NhbCIpOwoJCQl9CgoJCQlsZXQgaHRtbCA9IG51bGw7CgkJCXRyeSB7CgkJCQlodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5odG0iKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoaHRtbCAmJiAhaHRtbC5zdGF0dXMpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBodG1sIHRlbXBsYXRlIGZvdW5kIiwgaHRtbCk7CgkJCQlwYWdlLkJvZHkgPSBodG1sOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGhhcyBubyBodG1sIHRlbXBsYXRlIik7CgkJCQlpZiAoIXBhZ2UuQm9keSAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoTWFpbkNvbXBvbmVudCkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQkJfSBlbHNlIHsKCQkJCQlwYWdlLkJvZHkgPSBwYWdlLl9jb250ZW50IHx8ICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQkJfQoJCQl9CgoJCQlsZXQganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUocGFnZSk7CgkJCWlmICghanMpIHRyeSB7CgkJCQlqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuanMiKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoIWpzIHx8ICFqcy5vaykganMgPSBudWxsOwoJCQlpZiAoanMgJiYganMub2spIHBhZ2UuU2NyaXB0ID0gYXdhaXQganMudGV4dCgpOwoKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIHNjcmlwdCBpcyIgKyAoanMgPyAnJyA6ICcgbm90JykgKyAiIHJldHJpZXZlZCIpOwoJCQl0aGlzLnN0ZXAoKTsKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQkvL2NvbnNvbGUubG9nKCJwYWdlIEJvZHkiLCBwYWdlLl9ib2R5IHx8IHBhZ2UuQm9keSk7CgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"Name": "RnJFTUQ=",
	"Script": "d2luZG93LkZyRU1EID0gY2xhc3MgewoJLy9leHBvcnQgZGVmYXVsdCBjbGFzcyBGckVNRCB7Cgljb25zdHJ1Y3RvcigpIHsKCQl0aGlzLnNldHRpbmdzID0gbnVsbDsKCQl0aGlzLmJEZWJ1ZyA9IGZhbHNlOwoJCXRoaXMuYmxvY2tzID0ge307CgkJdGhpcy5sYW5kaW5nUGFnZSA9IHRydWU7CgkJdGhpcy5wYWdlcyA9IFtdOwoJCXRoaXMuYWxsSFRNTCA9ICIiOwoJCXRoaXMuYWxsRGF0YSA9IHt9OwoJCXRoaXMuYWxsT3B0aW9ucyA9IG51bGw7CgkJdGhpcy5yZXF1aXJlZCA9IFtdOwoJCXRoaXMubG9hZGluZyA9IHsKCQkJc3RlcHM6IDE1LAoJCQlsb2FkZXI6IG51bGwsCgkJCXBvc2l0aW9uOiAwCgkJfTsKCQl0aGlzLmhhc2ggPSB7fTsKCQl0aGlzLl9jYWxscyA9IFtdOwoJCXRoaXMuZW5kQ2FsbGVkID0gZmFsc2U7CgoJCXRoaXMuYXBpU2VydmVyID0gbnVsbDsKCX0KCglfdXJsR2V0KHApIHsKCQl0cnkgewoJCQlyZXR1cm4gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQocCkgfHwgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDEpLnNwbGl0KCcmJykucmVkdWNlKChyZXMsIGl0ZW0pID0+IHsKCQkJCXZhciBwYXJ0cyA9IGl0ZW0uc3BsaXQoJz0nKTsKCQkJCXJlc1twYXJ0c1swXV0gPSBwYXJ0c1sxXTsKCQkJCXJldHVybiByZXM7CgkJCX0sIHt9KVtwXSB8fCAnJzsKCQl9IGNhdGNoIChleCkgewoJCQlyZXR1cm4gJyc7CgkJfQoJfQoKCWdyb3VwQnkoYXIsIGZpZWxkKSB7CgkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQl2YXIga2V5cyA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXZhciBrZXkgPSBudWxsOwoJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCWlmIChrKSB7CgkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQl9IGVsc2UgewoJCQkJa2V5cy5wdXNoKHsKCQkJCQlrZXk6IGtleSwKCQkJCQl2YWx1ZXM6IFthXSwKCQkJCX0pOwoJCQl9CgkJfSk7CgkJcmV0dXJuIGtleXM7Cgl9CgoJYXN5bmMgX2dldFN0b3JlZFNjcmlwdChzLCBiTm9SdW4pIHsKCQlsZXQgc2NyaXB0ID0gJyc7CgkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJc2NyaXB0ID0gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcykpPy5TY3JpcHQ7CgkJfSBlbHNlIGlmICghdGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9nZXRTdG9yZWRTY3JpcHQoKTogbm8gYXBpU2VydmVyLCBydW5uaW5nIGluIHNjb3BlICIsIHRoaXMuX19zY29wZSgpKTsKCQkJbGV0IF9zID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvL2NvbS9uYW1tb3VyL2Ntcy9TdG9yZWRTY3JpcHQvJHtzLk5hbWUgfHwgcy5uYW1lfS5qc29uP3JhbmQ9JHtNYXRoLnJhbmRvbSgpfWApOwoJCQlpZiAoX3Mub2spIHNjcmlwdCA9IGF0b2IoKGF3YWl0IF9zLmpzb24oKSkuc2NyaXB0KTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygiX2dldFN0b3JlZFNjcmlwdCgpOiB1c2luZyBhcGlTZXJ2ZXIhISEiLCB0aGlzLmFwaVNlcnZlci5TY29wZSwgcywgdGhpcy5fX3Njb3BlKHRoaXMuYXBpU2VydmVyLlNjb3BlKSk7CgkJCXNjcmlwdCA9IChhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdTdG9yZWRTY3JpcHQnKS5uYW1lKHMuTmFtZSB8fCBzLm5hbWUsICc9JykuZmluZCgpKS5zY3JpcHQoKTsKCQl9CgoJCWlmIChzY3JpcHQpIHsKCQkJcmV0dXJuIChiTm9SdW4gPyBzY3JpcHQgOiBhd2FpdCB0aGlzLnJ1blNjcmlwdChzY3JpcHQpKTsKCQl9IGVsc2UgewoJCQljb25zb2xlLmxvZygibm8gc3RvcmVkIHNjcmlwdCBsb2FkZXIgdG8gdXNlIiwgcyk7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfdW5pcXVlKGRhdGEsIGtleSkgewoJCXJldHVybiBbLi4ubmV3IE1hcChkYXRhLm1hcCh4ID0+IFsheCA/IHggOiB4W2tleSB8fCAnTmFtZSddLCB4XSkpLnZhbHVlcygpXTsKCX0KCglfdG9FbnRpdHlDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IGVhTWFwID0gZWEgPT4gewoJCQlsZXQgcmV0ID0gewoJCQkJTmFtZTogZWEuTmFtZS5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQl9KSwKCQkJCVJlcXVpcmVkOiBlYS5SZXF1aXJlZCwKCQkJfTsKCQkJT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnSXMnKSkuZm9yRWFjaChrID0+IHJldFtrXSA9IGVhW2tdKTsKCQkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJ0lzJykgJiYgIXJldFtrXSkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoJCQlpZiAoZWEuRW50aXR5VHlwZSkgewoJCQkJcmV0LkVudGl0eVR5cGUgPSB7CgkJCQkJTmFtZTogZWEuRW50aXR5VHlwZS5OYW1lCgkJCQl9OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfTsKCgkJcmV0dXJuIHRoaXMuX19zY29wZShzY29wZSkuRW50aXR5Q2xhc3Nlcy5tYXAoYyA9PiB7CgkJCWxldCByZXQgPSB7CgkJCQlOYW1lOiBjLk5hbWUsCgkJCQlUb29sczogYy5Ub29scywKCQkJCURlYnVnOiBjLkRlYnVnLAoJCQkJVGVzdDogYy5UZXN0LAoJCQkJQ29uZmlnOiBjLkNvbmZpZywKCQkJCUVuYWJsZWQ6IGMuRW5hYmxlZCwKCQkJCUVudGl0eUF0dHJpYnV0ZXM6IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eU1ldGhvZCkubWFwKGVhID0+IGVhTWFwKGVhKSksCgkJCQlFbnRpdHlNZXRob2RzOiBjLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gKHsKCQkJCQlOYW1lOiBtLk5hbWUsCgkJCQkJU2NyaXB0OiBtLlNjcmlwdCwKCQkJCQlSb3V0aW5nOiBtLlJvdXRpbmcsCgkJCQkJTWV0aG9kUGFyYW1ldGVyczogbS5NZXRob2RQYXJhbWV0ZXJzLm1hcChwID0+IGVhTWFwKHApKSwKCQkJCQlSZXNwb25zZUF0dHJpYnV0ZTogZWFNYXAobS5SZXNwb25zZUF0dHJpYnV0ZSksCgkJCQl9KSksCgkJCX07CgoJCQlbIlRvb2xzIiwgIkVudGl0eU1ldGhvZHMiXS5mb3JFYWNoKGEgPT4gewoJCQkJaWYgKCFyZXRbYV0ubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJWyJEZWJ1ZyIsICJUZXN0IiwgIkNvbmZpZyJdLmZvckVhY2goYSA9PiB7CgkJCQlpZiAoIU9iamVjdC5rZXlzKHJldFthXSkubGVuZ3RoKSBkZWxldGUgcmV0W2FdOwoJCQl9KTsKCQkJcmV0LkVudGl0eUF0dHJpYnV0ZXMgPSByZXQuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPSAiaWQiKTsKCQkJcmV0dXJuIHJldDsKCQl9KTsKCX0KCglhc3luYyBfcnVuU2VxdWVuY2VzKHNlcXMsIHNjb3BlKSB7CgkJbGV0IGNhbGxTZXF1ZW5jZXMgPSBbXTsKCQlpZiAoIXNjb3BlKSByZXR1cm4gY2FsbFNlcXVlbmNlczsKCgkJZm9yIGF3YWl0IChjb25zdCBzZXEgb2Ygc2VxcykgewoJCQlsZXQgY2FsbFNlcXVlbmNlID0gewoJCQkJYWN0aXZlOiB0cnVlLAoJCQkJdGl0bGU6IHNlcS50aXRsZSwKCQkJCWNsYXNzaWZpZXI6IHNlcS5jbGFzc2lmaWVyLAoJCQkJZW50aXRpZXM6IFtdLAoJCQkJdGltZWxpbmU6IFtdLAoJCQl9OwoKCQkJbGV0IF9lbnRpdGllcyA9IHNlcS5lbnRpdGllcy5maWx0ZXIoZSA9PiBzY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gZS50eXBlKSk7CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQllLm9iaiA9IG5ldyBzY29wZVtlLnR5cGVdKCkuX2Zyb21Eb2N1bWVudChlLmNvbnRlbnQpOwoJCQl9CgoJCQlmb3IgYXdhaXQgKGNvbnN0IGUgb2YgX2VudGl0aWVzKSB7CgkJCQkvLyBmaXJzdCBsZXZlbCByZWZlcmVuY2UgY2xlYW51cDogbWFrZSBzdXJlIG9ubHkgb25lIHJlZmVyZW5jZSBvYmplY3QgaXMgdXNlZCB3aXRoIHRoZSBzYW1lICJfbmFtZSIuIGxvd2VyIGxldmVscyBzaG91bGQgYmUgZG9uZSByZWN1cnNpdmVseQoJCQkJc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09IGUudHlwZSkuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiBlYS5FbnRpdHlUeXBlLkVudGl0eUF0dHJpYnV0ZXMuZmluZChfZWEgPT4gX2VhLk5hbWUgPT0gJ25hbWUnICYmIF9lYS5Jc1N0cmluZykpLmZvckVhY2goZWEgPT4gewoJCQkJCWlmIChlLm9ialsnXycgKyBlYS5OYW1lXSkgewoJCQkJCQllLm9ialsnXycgKyBlYS5OYW1lXSA9IChzZXEuZW50aXRpZXMuZmluZChfZSA9PiBfZSAhPT0gZSAmJiBfZS5vYmogJiYgX2Uub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lID09IGUub2JqWydfJyArIGVhLk5hbWVdLl9uYW1lKSB8fCBlKS5vYmpbJ18nICsgZWEuTmFtZV07CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCXNlcS5zdGVwcyA9IHNlcS5zdGVwcy5tYXAocyA9PiB7CgkJCQlpZiAoIXMuX2lmKSByZXR1cm4gW3NdOwoJCQkJcmV0dXJuIHMuX3RoZW4ubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IHRydWUKCQkJCQl9CgkJCQl9KSkuY29uY2F0KHMuX2Vsc2UubWFwKHN0ID0+ICQuZXh0ZW5kKHN0LCB7CgkJCQkJX2lmOiB7CgkJCQkJCWxhYmVsOiBzLl9pZiwKCQkJCQkJdmFsdWU6IGZhbHNlCgkJCQkJfQoJCQkJfSkpKTsKCQkJfSk7CgkJCXNlcS5zdGVwcyA9IFtdLmNvbmNhdC5hcHBseShbXSwgc2VxLnN0ZXBzKTsKCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBzZXEuc3RlcHMpIHsKCQkJCWlmIChzLmlnbm9yZSkgY29udGludWU7CgoJCQkJbGV0IF9mcm9tID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBzLmZyb20pOwoJCQkJaWYgKCFfZnJvbSkgewoJCQkJCWNvbnNvbGUubG9nKCJNaXNzaW5nIEVudGl0eSBEZWZpbml0aW9uOiAiICsgcy5mcm9tKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCV9mcm9tID0gX2Zyb20ub2JqOwoKCQkJCXRyeSB7CgkJCQkJcy5wYXJhbXMgPSBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMocy5wYXJhbXMpLm1hcChldCA9PiB7CgkJCQkJCWlmIChldFsxXSAmJiBldFsxXS5uYW1lKSB7CgkJCQkJCQlsZXQgb2JqID0gc2VxLmVudGl0aWVzLmZpbmQoZSA9PiBlLm9iaiAmJiAoZS5uYW1lIHx8IGUub2JqLl9uYW1lKSA9PSBldFsxXS5uYW1lKTsKCQkJCQkJCXJldHVybiBvYmogPyBbZXRbMF0sIG9iai5vYmpdIDogZXQ7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gZXQ7CgkJCQkJCX0KCQkJCQl9KSk7CgoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IF9mcm9tW3MubWV0aG9kXSguLi5PYmplY3QudmFsdWVzKHMucGFyYW1zKSk7CgoJCQkJCQlzLl9tZXRob2QgPSBzLm1ldGhvZC5pbmRleE9mKCcuJykgPiAwID8gc2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5JZCA9PSBfZnJvbS5FbnRpdHlDbGFzcy5JZCkuRW50aXR5TWV0aG9kcy5maW5kKG0gPT4gbS5OYW1lID09IHMubWV0aG9kKSA6IHNjb3BlLkVudGl0eUNsYXNzZXMuZmluZChjID0+IGMuTmFtZSA9PSBzLm1ldGhvZC5zcGxpdCgnLicpWzBdKS5FbnRpdHlNZXRob2RzLmZpbmQobSA9PiBtLk5hbWUgPT0gcy5tZXRob2Quc3BsaXQoJy4nKVsxXSk7CgkJCQkJfSBjYXRjaCAoX2V4KSB7fQoKCQkJCQkvLyBub3QgZGVmaW5lZCB0byB3aGljaCBlbnRpdHkgdGhpcyBpcyBnb2luZywgZmluZCBmaXJzdCBlbnRpdHkgaW4gdGhlIHBhcmFtZXRlcnMsIG90aGVyd2lzZSBpdCBpcyBhIGxvb3AgdG8gbXlzZWxmCgkJCQkJbGV0IF90byA9IChPYmplY3QudmFsdWVzKHMucGFyYW1zKSB8fCBbXSkuZmluZChwID0+IHAgJiYgcC5FbnRpdHlDbGFzcykgfHwgX2Zyb207CgoJCQkJCWNhbGxTZXF1ZW5jZS5lbnRpdGllcyA9IGNhbGxTZXF1ZW5jZS5lbnRpdGllcy5jb25jYXQoW19mcm9tLCBfdG9dKS5maWx0ZXIoZSA9PiBlKS5maWx0ZXIoKG9iaiwgcG9zLCBhcnIpID0+IHsKCQkJCQkJcmV0dXJuIGFyci5tYXAobWFwT2JqID0+IG1hcE9iaikuaW5kZXhPZihvYmopID09PSBwb3M7CgkJCQkJfSk7CgoJCQkJCWxldCBzT2JqID0gewoJCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlmcm9tOiBfZnJvbSwKCQkJCQkJdG86IF90bywKCQkJCQkJYWN0aXZhdGU6IHMuYWN0aXZhdGUsCgkJCQkJCXBhcmFtczogcy5wYXJhbXMsCgkJCQkJCW1ldGhvZDogcy5tZXRob2QsCgkJCQkJCV9pZjogcy5faWYsCgkJCQkJfTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUucHVzaChzT2JqKTsKCQkJCQljYWxsU2VxdWVuY2UudGltZWxpbmUuc29ydCgoYSwgYikgPT4gYS5kYXRlIDwgYi5kYXRlKTsKCgkJCQkJaWYgKF9mcm9tICE9PSBfdG8gJiYgKHR5cGVvZihzLmFjdGl2YXRlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgcy5hY3RpdmF0ZSkpIHsKCQkJCQkJLy8gaXMgdGhpcyBjYWxsIGNsb3NpbmcgYW4gYWN0aXZhdGlvbj8gdGhlbiBkZWZpbmUgaXQgYXMgYWN0aXZhdGVkIGluIHRoZSBpbml0aWFsIGNhbGwKCQkJCQkJbGV0IGluaXQgPSBjYWxsU2VxdWVuY2UudGltZWxpbmUuZmluZCh0ID0+IHQuZnJvbSA9PSBzT2JqLnRvICYmIHQudG8gPT0gc09iai5mcm9tICYmIHQuZGF0ZSA8IHNPYmouZGF0ZSAmJiAhdC5hY3RpdmF0aW5nKTsKCQkJCQkJaWYgKGluaXQpIHsKCQkJCQkJCWluaXQuYWN0aXZhdGluZyA9IHNPYmo7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYXdhaXQgdGhpcy5fd2FpdChzLndhaXQgfHwgc2VxLndhaXQpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhfZnJvbSwgcywgZXgpOwoJCQkJfQoJCQl9CgkJCWNhbGxTZXF1ZW5jZS50aW1lbGluZS5mb3JFYWNoKCh0LCBpKSA9PiB7CgkJCQl0LmZyb20gPSB0LmZyb20gfHwgIm51bGwiOwoJCQkJdC50byA9IHQudG8gfHwgIm51bGwiOwoJCQkJdC5fcHJldmlvdXMgPSBpID8gY2FsbFNlcXVlbmNlLnRpbWVsaW5lW2kgLSAxXSA6IG51bGw7CgkJCQl0Ll9uZXh0ID0gKGkgPCBjYWxsU2VxdWVuY2UudGltZWxpbmUubGVuZ3RoIC0gMSkgPyBjYWxsU2VxdWVuY2UudGltZWxpbmVbaSArIDFdIDogbnVsbDsKCQkJCXQuX2FjdGl2YXRvciA9IGNhbGxTZXF1ZW5jZS50aW1lbGluZS5maW5kKF90ID0+IF90LmFjdGl2YXRpbmcgPT0gdCk7CgkJCX0pOwoKCQkJY2FsbFNlcXVlbmNlcy5wdXNoKGNhbGxTZXF1ZW5jZSk7CgkJfQoKCQlyZXR1cm4gY2FsbFNlcXVlbmNlczsKCX0KCglhc3luYyBfd2FpdChtcykgewoJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJfQoKCV9maWxlVHlwZShiYXNlNjQpIHsKCQl2YXIgYmluYXJ5X3N0cmluZyA9IHRoaXMuX2F0b2IoYmFzZTY0KTsKCQl2YXIgbGVuID0gYmluYXJ5X3N0cmluZy5sZW5ndGg7CgkJdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCWJ5dGVzW2ldID0gYmluYXJ5X3N0cmluZy5jaGFyQ29kZUF0KGkpOwoJCX0KCgkJdmFyIGFyciA9IChuZXcgVWludDhBcnJheShieXRlcy5idWZmZXIpKS5zdWJhcnJheSgwLCA0KTsKCQl2YXIgaGVhZGVyID0gJyc7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKCQkJaGVhZGVyICs9IGFycltpXS50b1N0cmluZygxNik7CgkJfQoKCQkvLyBDaGVjayB0aGUgZmlsZSBzaWduYXR1cmUgYWdhaW5zdCBrbm93biB0eXBlcwoJCXZhciB0eXBlID0gJ3Vua25vd24nOwoJCXN3aXRjaCAoaGVhZGVyKSB7CgkJCWNhc2UgJzg5NTA0ZTQ3JzoKCQkJCXR5cGUgPSAnaW1hZ2UvcG5nJzsKCQkJCWJyZWFrOwoJCQljYXNlICc0NzQ5NDYzOCc6CgkJCQl0eXBlID0gJ2ltYWdlL2dpZic7CgkJCQlicmVhazsKCQkJY2FzZSAnZmZkOGZmZTAnOgoJCQljYXNlICdmZmQ4ZmZlMSc6CgkJCWNhc2UgJ2ZmZDhmZmUyJzoKCQkJCXR5cGUgPSAnaW1hZ2UvanBlZyc7CgkJCQlicmVhazsKCQkJY2FzZSAnMjU1MDQ0NDYnOgoJCQkJdHlwZSA9ICdhcHBsaWNhdGlvbi9wZGYnOwoJCQkJYnJlYWs7CgkJCWNhc2UgJzNjNzM3NjY3JzoKCQkJCXR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCc7CgkJCQlicmVhazsKCQl9CgkJcmV0dXJuIHR5cGU7Cgl9CgoJaW1nKGRJbWcsIG1pbWVUeXBlKSB7CgkJcmV0dXJuIGBkYXRhOiR7bWltZVR5cGUgfHwgdGhpcy5fZmlsZVR5cGUoZEltZyl9O2Jhc2U2NCxgICsgZEltZzsKCX0KCglfZnVsbFNjcmVlbihlbGVtKSB7CgkJdHJ5IHsKCQkJaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCWVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuKSB7CgkJCQkvKiBTYWZhcmkgKi8KCQkJCWVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKCQkJfSBlbHNlIGlmIChlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHsKCQkJCS8qIElFMTEgKi8KCQkJCWVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCX0KCglfY29weVRleHRUb0NsaXBib2FyZCh0ZXh0KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Yod2luZG93LmNvcHkpID09PSAnZnVuY3Rpb24nKSB7CgkJCXdpbmRvdy5jb3B5KHRleHQpOwoJCX0gZWxzZSBpZiAoIW5hdmlnYXRvci5jbGlwYm9hcmQpIHsKCQkJdmFyIHRleHRBcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKCQkJdGV4dEFyZWEudmFsdWUgPSB0ZXh0OwoKCQkJLy8gQXZvaWQgc2Nyb2xsaW5nIHRvIGJvdHRvbQoJCQl0ZXh0QXJlYS5zdHlsZS50b3AgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLmxlZnQgPSAiMCI7CgkJCXRleHRBcmVhLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKCgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGV4dEFyZWEpOwoJCQkvL3RleHRBcmVhLmZvY3VzKCk7CgkJCXRleHRBcmVhLnNlbGVjdCgpOwoKCQkJdHJ5IHsKCQkJCXZhciBzdWNjZXNzZnVsID0gZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKCQkJCXZhciBtc2cgPSBzdWNjZXNzZnVsID8gJ3N1Y2Nlc3NmdWwnIDogJ3Vuc3VjY2Vzc2Z1bCc7CgkJCQljb25zb2xlLmxvZygnRmFsbGJhY2s6IENvcHlpbmcgdGV4dCBjb21tYW5kIHdhcyAnICsgbXNnKTsKCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQljb25zb2xlLmVycm9yKCdGYWxsYmFjazogT29wcywgdW5hYmxlIHRvIGNvcHknLCBlcnIpOwoJCQl9CgoJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRBcmVhKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCkudGhlbihmdW5jdGlvbigpIHsKCQkJCQljb25zb2xlLmxvZygnQXN5bmM6IENvcHlpbmcgdG8gY2xpcGJvYXJkIHdhcyBzdWNjZXNzZnVsIScpOwoJCQkJCXJlc29sdmUoKTsKCQkJCX0sIGZ1bmN0aW9uKGVycikgewoJCQkJCWNvbnNvbGUuZXJyb3IoJ0FzeW5jOiBDb3VsZCBub3QgY29weSB0ZXh0OiAnLCBlcnIpOwoJCQkJCXJlamVjdChlcnIpOwoJCQkJfSk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRleHQ7Cgl9CgoJYXN5bmMgX3Jlc2l6ZUltZyhpbWdCYXNlNjQsIHdpZHRoLCBoZWlnaHQsIG1pbWVUeXBlLCB0b19taW1lVHlwZSkgewoJCWlmIChpbWdCYXNlNjQuc3BsaXQoJywnKS5sZW5ndGggPiAxKSB7CgkJCWltZ0Jhc2U2NCA9IGltZ0Jhc2U2NC5zcGxpdCgnLCcpWzFdOwoJCX0KCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJaW1nLnNyYyA9IHRoaXMuaW1nKGltZ0Jhc2U2NCwgbWltZVR5cGUpOwoKCQkvLyBjcmVhdGUgYW4gb2ZmLXNjcmVlbiBjYW52YXMKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksCgkJCWN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBzZXQgaXRzIGRpbWVuc2lvbiB0byB0YXJnZXQgc2l6ZQoJCWNhbnZhcy53aWR0aCA9IHdpZHRoIHx8IGltZy53aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IGltZy5oZWlnaHQ7CgoJCS8vIGRyYXcgc291cmNlIGltYWdlIGludG8gdGhlIG9mZi1zY3JlZW4gY2FudmFzOgoJCWN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCgkJLy8gZW5jb2RlIGltYWdlIHRvIGRhdGEtdXJpIHdpdGggYmFzZTY0IHZlcnNpb24gb2YgY29tcHJlc3NlZCBpbWFnZQoJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKHRvX21pbWVUeXBlIHx8IG1pbWVUeXBlLCAxKTsKCX0KCglhc3luYyBfdGVtcGxhdGUodG1wLCBzY29wZSwgZGF0YSwgcHJ2RnVuYykgewoJCXNjb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJLy9jb25zb2xlLmxvZygiX0ZyRU1EOjpfdGVtcGxhdGUoKSIsIHRtcCwgdG1wLl87CgkJbGV0IHRlbXBsYXRlID0gdG1wLklkID8gdG1wIDogKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNQYWdlVGVtcGxhdGVGaW5kIiwgbnVsbCwgewoJCQlBY3RpdmU6IHRydWUsCgkJCVR5cGU6IHsKCQkJCU5hbWU6ICJFbnRpdHlUZW1wbGF0ZSIKCQkJfSwKCQkJTmFtZTogdG1wLk5hbWUgfHwgdG1wLm5hbWUoKSB8fCB0bXAudGVtcGxhdGUgfHwgdG1wLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICc9JwoJCQl9CgkJfSkpOwoJCWlmICh0ZW1wbGF0ZSAmJiB0eXBlb2YodGVtcGxhdGUuZmluZCkgPT09ICdmdW5jdGlvbicpIHRlbXBsYXRlID0gYXdhaXQgdGVtcGxhdGUuZmluZCgpOwoJCWlmICghdGVtcGxhdGUpIHJldHVybiBudWxsOwoKCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5ydW5TY3JpcHQodGVtcGxhdGUuU2NyaXB0IHx8IHRlbXBsYXRlLnNjcmlwdCgpKTsKCQlsZXQgb2JqID0gbmV3IHNjcmlwdCh0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMpOwoKCQl0cnkgewoJCQlvYmoubWFpbiAmJiBhd2FpdCBvYmoubWFpbigpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJUZW1wbGF0ZS5tYWluKCkiLCBleCk7CgkJfQoKCQl0cnkgewoJCQlvYmoucHJlSW5qZWN0ICYmIGF3YWl0IG9iai5wcmVJbmplY3QoKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiVGVtcGxhdGUucHJlSW5qZWN0KCkiLCBleCk7CgkJfQoKCQlsZXQgcmV0ID0gewoJCQlTY3JpcHQ6IG9iaiwKCQl9OwoKCQlsZXQgdENhY2hlID0ge307CgkJZm9yIGF3YWl0IChjb25zdCBmIG9mIFsnQm9keScsICdGb290ZXInLCAnVGl0bGUnXSkgewoJCQlsZXQgdGYgPSB0ZW1wbGF0ZVtmXTsKCQkJaWYgKHR5cGVvZih0ZW1wbGF0ZS5zdG9yZSkgPT09ICdmdW5jdGlvbicpIHRmID0gdGVtcGxhdGVbZi50b0xvd2VyQ2FzZSgpXSgpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG0gb2YgWy4uLih0Zi5tYXRjaEFsbCgvKFxbXFslPSkuW1x3XC0uXStbXC5dKHRtcClbXDpcOl0/W14oJVxdXF0pXSpbXDpcOl0/W14oJVxdXF0pXSooJVxdXF0pL2dtKSldKSB7CgkJCQlsZXQgdE5hbWVQYXJ0cyA9IG1bMF0ucmVwbGFjZSgnW1slPScsICcnKS5yZXBsYWNlKCclXV0nLCAnJykucmVwbGFjZSgnLnRtcCcsICcnKS5zcGxpdCgnOjonKTsKCQkJCWxldCB0TmFtZSA9IHROYW1lUGFydHNbMF07CgkJCQlsZXQgdERhdGEgPSBPYmplY3QuYXNzaWduKGRhdGEsIHt9KTsKCQkJCWlmICh0TmFtZVBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJCQl0RGF0YSA9IE9iamVjdC5hc3NpZ24odERhdGEsIGF3YWl0IHRoaXMucnVuU2NyaXB0KHROYW1lUGFydHNbMV0pKTsKCQkJCX0KCQkJCWxldCB0ID0gYXdhaXQgdGhpcy5fdGVtcGxhdGUodE5hbWUsIHNjb3BlLCB0RGF0YSwgcHJ2RnVuYyk7CgkJCQl0Q2FjaGVbdE5hbWVdID0gdENhY2hlW3ROYW1lXSB8fCB0W2ZdOwoJCQkJdGYgPSB0Zi5yZXBsYWNlKG1bMF0sIHRDYWNoZVt0TmFtZV0pOwoJCQl9CgoJCQlyZXRbZl0gPSB0aGlzLl9pbmplY3QodGYsIG9iaik7CgkJfQoJCWNvbnNvbGUubG9nKHRDYWNoZSk7CgoJCXRyeSB7CgkJCW9iai5wb3N0SW5qZWN0ICYmIGF3YWl0IG9iai5wb3N0SW5qZWN0KHJldCk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIlRlbXBsYXRlLnBvc3RJbmplY3QoKSIsIGV4KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJVGVtcGxhdGUgPSBjbGFzcyB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQl0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CgkJCXRoaXMuc2NvcGUgPSBzY29wZTsKCQkJdGhpcy5vU2NvcGUgPSBfRnJFTUQuX19zY29wZShzY29wZSk7CgoJCQl0aGlzLm5jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdOb2RlJyk7CgkJCXRoaXMuc2MgPSB0aGlzLm9TY29wZS5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBjLk5hbWUgPT0gJ1N0b3JlZFNjcmlwdCcpOwoJCQl0aGlzLmVjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5OYW1lID09ICdFdmVudCcpOwoJCQl0aGlzLm1jID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gYy5Jc01haW4pOwoKCQkJdGhpcy5kU2NvcGUgPSAodGhpcy5uYyAmJiB0aGlzLm5jLkVudGl0eU1vZHVsZSkgPyBEb3RPYmplY3QucGljayh0aGlzLm5jLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgkJCXRoaXMuY21TY29wZSA9ICh0aGlzLnNjICYmIHRoaXMuc2MuRW50aXR5TW9kdWxlKSA/IERvdE9iamVjdC5waWNrKHRoaXMuc2MuRW50aXR5TW9kdWxlLkFsaWFzLCB0aGlzLm9TY29wZSkgOiB0aGlzLm9TY29wZTsKCgkJCXRoaXMuZGF0YSA9IGRhdGE7CgoJCQl0aGlzLm5OYW1lID0gdGhpcy5vU2NvcGUubk5hbWU7CgkJCXRoaXMuY05hbWUgPSB0aGlzLm9TY29wZS5jTmFtZTsKCQkJdGhpcy5uQ29kZSA9IHRoaXMub1Njb3BlLm5Db2RlOwoKCQkJdGhpcy5wcnZGdW5jID0gcHJ2RnVuYyB8fCAoKCkgPT4ge30pOwoJCQl0aGlzLm1SYW5rID0gMDsKCgkJCWlmIChiUmFuaykgdGhpcy5tUmFuayA9IE1hdGgubWF4KDAsIC4uLnRoaXMub1Njb3BlLkVudGl0eUNsYXNzZXMubWFwKGMgPT4gYy5SYW5rKSk7IC8vIHVzZWZ1bCBpbiB0ZW1wbGF0ZXMKCgkJCXRoaXMubWFpblRpdGxlID0gdGhpcy5kYXRhLlRpdGxlLnNwbGl0KCctJylbMF07CgkJCXRoaXMuc3ViVGl0bGUgPSB0aGlzLmRhdGEuVGl0bGUuaW5kZXhPZignLScpID49IDAgPyBkYXRhLlRpdGxlLnNwbGl0KCctJylbMV0gOiAiIjsKCQl9CgoJCV9uZXcoYywgdG9vbCwgaWQpIHsKCQkJaWYgKCFjKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLklzTWFpbik7CgkJCWlmICh0eXBlb2YoYykgPT09ICdzdHJpbmcnKSBjID0gdGhpcy5vU2NvcGUuRW50aXR5Q2xhc3Nlcy5maW5kKF9jID0+IF9jLk5hbWUgPT0gYyk7CgkJCWlmICghYykgcmV0dXJuIG51bGw7CgoJCQlsZXQgbVNjb3BlID0gYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhjLkVudGl0eU1vZHVsZS5BbGlhcywgdGhpcy5vU2NvcGUpIDogdGhpcy5vU2NvcGU7CgoJCQlyZXR1cm4gbmV3KG1TY29wZVt0aGlzLm9TY29wZS5uTmFtZShjKV0pKGlkLCB0b29sKTsKCQl9CgoJCV9hdHRyKGVhKSB7CgkJCXJldHVybiBlYS5FbnRpdHlUeXBlID8gZWEuRW50aXR5VHlwZS5OYW1lIDogX0ZyRU1ELl9hdHRyKGVhKTsKCQl9CgoJCWNuZihfYywgaWQsIGRpZCwgdG9vbCkgewoJCQlfYyA9IF9jIHx8IHRoaXMubWM7CgkJCWxldCBtU2NvcGUgPSBfYy5FbnRpdHlNb2R1bGUgPyBEb3RPYmplY3QucGljayhfYy5FbnRpdHlNb2R1bGUuQWxpYXMsIHRoaXMub1Njb3BlKSA6IHRoaXMub1Njb3BlOwoJCQlyZXR1cm4gbVNjb3BlLl9ub2RlID8gbVNjb3BlLl9ub2RlLl9fY29uZmlnKGlkLCBkaWQsIHsKCQkJCXRvb2w6IHRvb2wKCQkJfSkgOiAodGhpcy5fbmV3KF9jLCB0b29sKS5fX2NvbmZpZyhpZCwgZGlkLCB0b29sID8gewoJCQkJdG9vbDogdG9vbAoJCQl9IDogdW5kZWZpbmVkKSk7CgkJfQoKCQluVHlwZShlYSkgewoJCQlpZiAoZWEuSXNTdHJpbmcgfHwgZWEuSXNUZXh0KSB7CgkJCQlyZXR1cm4gInN0cmluZyI7CgkJCX0gZWxzZSBpZiAoZWEuSXNCb29sKSB7CgkJCQlyZXR1cm4gImJvb2xlYW4iOwoJCQl9IGVsc2UgaWYgKGVhLklzRmxvYXQpIHsKCQkJCXJldHVybiAiZmxvYXQiOwoJCQl9IGVsc2UgaWYgKGVhLklzSW50IHx8IGVhLklzTG9uZykgewoJCQkJcmV0dXJuICJudW1iZXIiOwoJCQl9IGVsc2UgaWYgKGVhLklzRGF0ZSkgewoJCQkJcmV0dXJuICJzdHJpbmciOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQl9CgoJCV90KHByb3AsIG9iaiwgc2VhcmNoKSB7CgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gb2JqW3Byb3BdOwoKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfdCIsIGV4KTsKCQkJfQoJCX0KCgkJYXN5bmMgcG9zdEluamVjdFNWRyhyZXQpIHsKCQkJbGV0IG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJb0Rpdi5pZCA9ICdzdmdSZW5kZXJlcic7CgkJCWxldCBzdmcgPSAoYXdhaXQgbWVybWFpZC5yZW5kZXIob0Rpdi5pZCwgcmV0LkJvZHkpKS5zdmc7CgkJCXRoaXMucHJ2RnVuYyhgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrO3dpZHRoOjEwMCU7IGhlaWdodDogMTAwJSc+JHtzdmd9PC9zdmc+YCk7CgkJfQoKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlhd2FpdCB0aGlzLnBydkZ1bmMoYDxkaXY+JHtyZXQuQm9keX08L2Rpdj5gKTsKCQl9CgoJCWFzeW5jIGRlcGxveShyZXQsIHR5cGVOYW1lLCBsYW5nKSB7CgkJCXR5cGVOYW1lID0gdHlwZU5hbWUgfHwgIkJyb3dzZXIiOwoJCQlsZXQgcyA9IHJldC5Cb2R5OwoJCQlpZiAobGFuZykgX0ZyRU1ELl9iZWF1dGlmeShyZXQuQm9keSwgbGFuZyk7CgoJCQlpZiAodGhpcy5uYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmRTY29wZS5Ob2RlX1R5cGUobnVsbCwgJ0dpdEh1YicpLmNvZGUodHlwZU5hbWUudG9Mb3dlckNhc2UoKSkubmFtZSh0eXBlTmFtZSkucmVtYXJrKHMpLnN0b3JlKCk7CgkJCX0gZWxzZSBpZiAodGhpcy5zYykgewoJCQkJcmV0dXJuIGF3YWl0IG5ldyB0aGlzLmNtU2NvcGUuU3RvcmVkU2NyaXB0KG51bGwsICdHaXRIdWInKS5hY3RpdmUodHJ1ZSkubmFtZSh0eXBlTmFtZSkuc2NyaXB0KHMpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZygnZGVwbG95KCk6IE5vIGRlcGxveW1lbnQgbW9kdWxlJyk7CgkJCX0KCQl9CgoJCWFzeW5jIHBvc3RJbmplY3RUYWJsZShyZXQpIHsKCQkJdGhpcy5wcnZGdW5jKGAKPGRpdiBpZCA9ICJkdlBvc3RJbmplY3QiIHN0eWxlPSdvdmVyZmxvd1k9c2Nyb2xsJz5gICsKCQkJCURGb3JtLnJlbmRlckVsZW1lbnRzKHRoaXMuZWxlbWVudHMubWFwKChzLCBpKSA9PiAoewoJCQkJCW5hbWU6IGBST1cke2l9YCwKCQkJCQl0aXRsZTogJyAnLAoJCQkJCXR5cGU6ICJncmlkIiwKCQkJCQl3aWR0aDogIjEwMCUiLAoJCQkJCXJvd051bWJlcnM6IGZhbHNlLAoJCQkJCXBhZ2luYXRpb246IGZhbHNlLAoJCQkJCWZyb3plbjogW10sCgkJCQkJY29sdW1uczogW3sKCQkJCQkJdGl0bGU6ICJQcm9wZXJ0eSIsCgkJCQkJCXdpZHRoOiAiMzAlIiwKCQkJCQl9LCB7CgkJCQkJCXRpdGxlOiAiRGVzY3JpcHRpb24iLAoJCQkJCQl3aWR0aDogIjcwJSIsCgkJCQkJfV0sCgkJCQkJZGF0YTogT2JqZWN0LmVudHJpZXMocykubWFwKGUgPT4gKHsKCQkJCQkJUHJvcGVydHk6IGVbMF0sCgkJCQkJCURlc2NyaXB0aW9uOiBlWzFdCgkJCQkJfSkpLAoJCQkJfSkpKSArIGA8L2Rpdj4KPHNjcmlwdD4KCXNldFRpbWVvdXQoKCkgPT4gJC5wYXJzZXIucGFyc2UoIiNkdlBvc3RJbmplY3QiKSwgMTAwKTsKPC9zY3JpcHQ+YCk7CgkJfQoJfTsKCglQcm94eU5vZGVUZW1wbGF0ZSA9IGNsYXNzIGV4dGVuZHMgdGhpcy5UZW1wbGF0ZSB7CgkJY29uc3RydWN0b3IodGVtcGxhdGUsIHNjb3BlLCBkYXRhLCBwcnZGdW5jLCBiUmFuaykgewoJCQlzdXBlcih0ZW1wbGF0ZSwgc2NvcGUsIGRhdGEsIHBydkZ1bmMsIGJSYW5rKTsKCQl9CgoJCWFzeW5jIHByZUluamVjdCgpIHsKCQkJdGhpcy51cmxSZWdleCA9IGAoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPylgOwoJCX0KCgkJY3J1ZE1ldGhvZHMoYywgdHlwZSkgewoJCQlyZXR1cm4gW3sKCQkJCU5hbWU6ICdzdG9yZScsCgkJCQlSZXNwb25zZUF0dHJpYnV0ZTogewoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmRBbGwnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlJc0FycmF5OiB0cnVlLAoJCQkJCUVudGl0eVR5cGU6IGMKCQkJCX0KCQkJfSwgewoJCQkJTmFtZTogJ2ZpbmQnLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IHsKCQkJCQlFbnRpdHlUeXBlOiBjCgkJCQl9CgkJCX1dLm1hcChtID0+IHsKCQkJCW1bdHlwZV0gPSBjW3R5cGVdID8gY1t0eXBlXVttLk5hbWVdIDogbnVsbDsKCQkJCW0uSXNQdWJsaWMgPSB0cnVlOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gW107CgkJCQlyZXR1cm4gbTsKCQkJfSk7CgkJfQoJfTsKCglQbGFudFVNTFRlbXBsYXRlID0gY2xhc3MgZXh0ZW5kcyB0aGlzLlRlbXBsYXRlIHsKCQlhc3luYyBwb3N0SW5qZWN0KHJldCkgewoJCQlsZXQgaHRtbCA9IHJldC5Cb2R5LnJlcGxhY2UoL0BlbmR1bWwvZywgYGxlZnQgZm9vdGVyICR7J1x1MDBBOSd9JHtuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCl9ICR7dGhpcy5kYXRhLkNvcHlyaWdodCB8fCAnRmFkaSBOYW1tb3VyJ30sIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbkBlbmR1bWxgKS5zcGxpdCgnQGVuZHVtbCcpLm1hcChiID0+IGA8aW1nIHN0eWxlPSdvdmVyZmxvdy14OiBhdXRvO2Rpc3BsYXk6IGJsb2NrOyBoZWlnaHQ6IDEwMCUnIHNyYz0naHR0cHM6Ly93d3cucGxhbnR1bWwuY29tL3BsYW50dW1sL3BuZy8ke3RoaXMuem9wKGIrJ0BlbmR1bWwnKX0nLz5gKS5qb2luKCc8YnIvPicpOwoKCQkJdGhpcy5wcnZGdW5jKCQoYDxkaXYgc3R5bGU9IndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IG92ZXJmbG93LXk6IHNjcm9sbDsiPiR7aHRtbH08L2Rpdj5gKSk7CgkJfQoKCQlfYXR0cihlYSkgewoJCQlyZXR1cm4gZWEuRW50aXR5VHlwZSA/IGVhLkVudGl0eVR5cGUuTmFtZSA6IF9GckVNRC5fYXR0cihlYSk7CgkJfQoKCQl6b3AocykgewoJCQlzID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHMpKTsKCQkJdmFyIGFyciA9IFtdOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIGFyci5wdXNoKHMuY2hhckNvZGVBdChpKSk7CgkJCWxldCB6ID0gbmV3IFpvcGZsaS5SYXdEZWZsYXRlKGFycikuY29tcHJlc3MoKTsKCQkJcmV0dXJuIHRoaXMuZW5jb2RlNjRfKHopOwoJCX0KCgkJZW5jb2RlNjRfKGRhdGEpIHsKCQkJbGV0IHIgPSAiIjsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAzKSB7CgkJCQlpZiAoaSArIDIgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCAwKTsKCQkJCX0gZWxzZSBpZiAoaSArIDEgPT0gZGF0YS5sZW5ndGgpIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIDAsIDApOwoJCQkJfSBlbHNlIHsKCQkJCQlyICs9IHRoaXMuYXBwZW5kM2J5dGVzKGRhdGFbaV0sIGRhdGFbaSArIDFdLCBkYXRhW2kgKyAyXSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHI7CgkJfQoKCQlhcHBlbmQzYnl0ZXMoYjEsIGIyLCBiMykgewoJCQlsZXQgYzEgPSBiMSA+PiAyOwoJCQlsZXQgYzIgPSAoKGIxICYgMHgzKSAwMTk1NzE2OTU5ZDE3MDRkYWExYWMzYTgzMTE2MjkxOCA0KTsKCQkJbGV0IGMzID0gKChiMiAmIDB4RikgMDE5NTcxNjk1OWQxNzA0ZGFhMWFjNDIwMDNmNmRmMDYgNik7CgkJCWxldCBjNCA9IGIzICYgMHgzRjsKCQkJbGV0IHIgPSAiIjsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzEgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzIgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzMgJiAweDNGKTsKCQkJciArPSB0aGlzLmVuY29kZTZiaXQoYzQgJiAweDNGKTsKCQkJcmV0dXJuIHI7CgkJfQoKCQllbmNvZGU2Yml0KGIpIHsKCQkJaWYgKGIgPCAxMCkgewoJCQkJcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoNDggKyBiKTsKCQkJfQoJCQliIC09IDEwOwoJCQlpZiAoYiA8IDI2KSB7CgkJCQlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSg2NSArIGIpOwoJCQl9CgkJCWIgLT0gMjY7CgkJCWlmIChiIDwgMjYpIHsKCQkJCXJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgYik7CgkJCX0KCQkJYiAtPSAyNjsKCQkJaWYgKGIgPT0gMCkgewoJCQkJcmV0dXJuICctJzsKCQkJfQoJCQlpZiAoYiA9PSAxKSB7CgkJCQlyZXR1cm4gJ18nOwoJCQl9CgkJCXJldHVybiAnPyc7CgkJfQoJfTsKCgl0b0Jhc2U2NCh1cmwsIGRhdGEsIG1pbWUgPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgYlJhdykgewoJCXJldHVybiB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbdXJsID8gdGhpcy5faW5qZWN0KCQuYWpheCh7CgkJCXVybDogdXJsICsgJz8nICsgTWF0aC5yYW5kb20oKSwKCQkJYXN5bmM6IGZhbHNlCgkJfSkucmVzcG9uc2VUZXh0LCBkYXRhKSA6IChiUmF3ID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpKV0sIHsKCQkJdHlwZTogbWltZQoJCX0pKTsKCX0KCglfc3ZnQmFzZTY0KHR4dCkgewoJCXRyeSB7CgkJCW1lcm1haWQubWVybWFpZEFQSS5pbml0aWFsaXplKHsKCQkJCSJ0aGVtZSI6ICJkZWZhdWx0IiwKCQkJCSJzZWN1cml0eUxldmVsIjogImxvb3NlIiwKCQkJCSJtYXhUZXh0U2l6ZSI6IDkwMDAwMDAwLAoJCQl9KTsKCgkJCXJldHVybiAnZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCwnICsgdGhpcy5fYnRvYShuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKCQobWVybWFpZC5tZXJtYWlkQVBJLnJlbmRlcignZ3JhcGhEaXYnLCB0eHQpKVswXSkpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiB0eHQ7CgkJfQoJfQoKCV9wcnVuZShvYmopIHsKCQlpZiAodHlwZW9mKG9iaikgPT09ICJ1bmRlZmluZWQiIHx8IG9iaiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKCQlpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CgkJCWxldCByZXQgPSBvYmoubWFwKHYgPT4gdGhpcy5fcHJ1bmUodikpLmZpbHRlcih2ID0+IHYpOwoJCQlyZXR1cm4gcmV0Lmxlbmd0aCA/IHJldCA6IG51bGw7CgkJfQoKCQlsZXQgcmV0ID0gT2JqZWN0LmFzc2lnbih7fSwgLi4uT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgPyAoewoJCQlba2V5XTogdGhpcy5fcHJ1bmUodmFsdWUpCgkJfSkgOiBudWxsKSk7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubGVuZ3RoID8gcmV0IDogbnVsbDsKCX0KCgl2YWxpZFVSTChzdHIpIHsKCQl2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14oaHR0cHM/OlxcL1xcLyk/JyArIC8vIHByb3RvY29sCgkJCScoKChbYS16XFxkXShbYS16XFxkLV0qW2EtelxcZF0pKilcXC4pK1thLXpdezIsfXwnICsgLy8gZG9tYWluIG5hbWUKCQkJJygoXFxkezEsM31cXC4pezN9XFxkezEsM30pKScgKyAvLyBPUiBpcCAodjQpIGFkZHJlc3MKCQkJJyhcXDpcXGQrKT8oXFwvWy1hLXpcXGQlXy5+K10qKSonICsgLy8gcG9ydCBhbmQgcGF0aAoJCQknKFxcP1s7JmEtelxcZCVfLn4rPS1dKik/JyArIC8vIHF1ZXJ5IHN0cmluZwoJCQknKFxcI1stYS16XFxkX10qKT8kJywgJ2knKTsgLy8gZnJhZ21lbnQgbG9jYXRvcgoJCXJldHVybiAhIXBhdHRlcm4udGVzdChzdHIpOwoJfQoKCV90b0pTKG8pIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKG8pID09PSAndW5kZWZpbmVkJykgcmV0dXJuICd1bmRlZmluZWQnOwoKCQkJcmV0dXJuIGBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShcYCR7dGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShvLCAodCxuKT0+ImZ1bmN0aW9uIj09PXR5cGVvZiBuP24udG9TdHJpbmcoKTpuKSl9XGApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pYDsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX3RvSlM6ICIgKyBleC50b1N0cmluZygpKTsKCQl9Cgl9CgoJX2F0b2IoYSkgewoJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7Cgl9CgoJX2J0b2EoYikgewoJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCX0KCglfYXR0cihlYSkgewoJCXRyeSB7CgkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXJldHVybiBudWxsOwoJCX0KCX0KCglfc3FsVHlwZShlYSwgZGJUeXBlKSB7CgkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJc3dpdGNoICh0eXBlKSB7CgkJCWNhc2UgIlN0cmluZyI6CgkJCWNhc2UgJyc6CgkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCWNhc2UgIlRleHQiOgoJCQljYXNlICJPYmplY3QiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30ke2RiVHlwZT09J3Bvc3RncmVzJz8nJzonKDQwMDApJ31gOwoJCQljYXNlICJCb29sIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JJVCgxKSc6J1RJTllJTlQnfWA7IC8vQklUCgkJCWNhc2UgIkRhdGUiOgoJCQkJcmV0dXJuIGAke2RiVHlwZT09J3Bvc3RncmVzJz8nVElNRVNUQU1QJzonREFURVRJTUUnfWA7CgkJCWNhc2UgIkludCI6CgkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQljYXNlICJMb25nIjoKCQkJCXJldHVybiAiQklHSU5UIjsKCQkJY2FzZSAiRW50aXR5IjoKCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJY2FzZSAiSW1hZ2UiOgoJCQljYXNlICJGaWxlIjoKCQkJCXJldHVybiBgJHtkYlR5cGU9PSdwb3N0Z3Jlcyc/J0JZVEVBJzoiQkxPQiJ9YDsKCQkJZGVmYXVsdDoKCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCX0KCX0KCglhc3luYyBpbXBvcnQobW9kdWxlLCBiQXN5bmMpIHsKCQlpZiAoQXJyYXkuaXNBcnJheShtb2R1bGUpKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBtb2R1bGUpIHsKCQkJCWF3YWl0IHRoaXMuaW1wb3J0KG0sIGJBc3luYyk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl0cnkgewoJCQlyZXR1cm4gYXdhaXQgaW1wb3J0KG1vZHVsZSk7CgkJfSBjYXRjaCAoZXgpIHt9CgkJdmFyIGpzID0gbnVsbDsKCQl0cnkgewoJCQlqcyA9IChhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IG1vZHVsZQoJCQl9KSkgfHwgKGF3YWl0ICQuYWpheCh7CgkJCQl1cmw6IHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgbW9kdWxlICsgIi5qcyIpLAoJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJfSkpOwoJCX0gY2F0Y2ggKGV4KSB7fQoJCWlmICghanMpIHsKCQkJanMgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zSFRNTFBhZ2VGaW5kIiwgbnVsbCwgewoJCQkJUGFnZTogbW9kdWxlLmluZGV4T2YoJy8nKSA+PSAwID8gbW9kdWxlIDogKENNU19ST09UICsgbW9kdWxlKQoJCQl9KTsKCQkJaWYgKGpzKSBqcyA9IGpzLlNjcmlwdDsKCQl9CgkJaWYgKCFqcykgcmV0dXJuIG51bGw7CgkJcmV0dXJuIGF3YWl0IHRoaXMucnVuU2NyaXB0KGpzLCBiQXN5bmMpOwoJfQoKCWFzeW5jIHJlcXVpcmUobGliTmFtZSwgaHJlZnMsIGxvYWRlcikgewoJCWxldCBfaHJlZnMgPSBbXTsKCQlpZiAoaHJlZnMgJiYgdGhpcy5ocmVmcykgewoJCQlfaHJlZnMgPSAoaHJlZnMubGVuZ3RoID4gdGhpcy5ocmVmcy5sZW5ndGgpID8gaHJlZnMgOiB0aGlzLmhyZWZzOwoJCX0gZWxzZSBpZiAoIXRoaXMuaHJlZnMpIHsKCQkJX2hyZWZzID0gaHJlZnM7CgkJfSBlbHNlIGlmICh0aGlzLmhyZWZzKSB7CgkJCV9ocmVmcyA9IHRoaXMuaHJlZnM7CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIF9ocmVmcy5maWx0ZXIobCA9PiBsLmxpYiA9PT0gbGliTmFtZSAmJiB0aGlzLl9pbmNsdWRlKGwpKSkgewoJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIF9ocmVmcywgbG9hZGVyKTsKCQkJfQoKCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJaWYgKGMpIHRoaXMuX2NzcyhjKTsKCQkJCX0KCQkJfQoKCQkJdmFyIG1vZHVsZXMgPSBbXTsKCQkJaWYgKGxvYWRlcikgewoJCQkJLy8gY29uc29sZS5sb2coImxvYWRlcigpWyIgKyBuLmxpYiArICJdOiAiLCB0eXBlb2Yobi5sb2FkKSk7CgkJCQlsZXQgbGRyID0gYXdhaXQgbG9hZGVyKG4pOwoJCQkJaWYgKGxkcikgbW9kdWxlcy5wdXNoKGxkcik7CgkJCX0KCgkJCWlmICh0eXBlb2Yobi5zcmMpID09PSAndW5kZWZpbmVkJyAmJiBuLnNjcmlwdCAmJiAhbW9kdWxlcy5sZW5ndGgpIHsKCQkJCWlmICh0eXBlb2Yobi5zY3JpcHQpID09PSAnZnVuY3Rpb24nKSBuLnNjcmlwdCA9IG4uc2NyaXB0KCk7CgkJCQltb2R1bGVzLnB1c2gocmV0ID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KG4uc2NyaXB0LCBuLm5vUnVuKSk7CgkJCX0KCgkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiAoQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pLmZpbHRlcihzID0+IHMpKSB7CgkJCQl0cnkgewoJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQlhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQocyk7CgkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgdGhpcy5pbXBvcnQocykpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKHMpID09PSAnc3RyaW5nJykgewoJCQkJCQlsZXQganNFeHQgPSAhKFsnanN0J10uc29tZShlID0+IHMuZW5kc1dpdGgoJy4nICsgZSkpKTsKCQkJCQkJaWYgKHR5cGVvZihXb3JrZXJHbG9iYWxTY29wZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkvLyBhIHdlYi13b3JrZXIKCQkJCQkJCWltcG9ydFNjcmlwdHMocyk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiYganNFeHQpIHsKCQkJCQkJCS8vIGRvY3VtZW50IHNob3VsZCBsb2FkIHRoZSBzY3JpcHQgd2hlbmV2ZXIgcG9zc2libGUKCQkJCQkJCS8qcmV0dXJuICovCgkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSByOwoJCQkJCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJCQkJCXNjcmlwdC5vbmVycm9yID0gcjsKCQkJCQkJCQlzY3JpcHQuYXN5bmMgPSBmYWxzZTsKCQkJCQkJCQlzY3JpcHQuc3JjID0gbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyk7CgkJCQkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogIiArIHMpOwoJCQkJCQkJCShkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmJvZHkpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQl9KSk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGZldGNoSW5qZWN0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJYXdhaXQgZmV0Y2hJbmplY3Qobi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocykpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihmZXRjaCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWxldCByZXMgPSBhd2FpdCBmZXRjaChuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSk7CgkJCQkJCQlpZiAocmVzLm9rKSB7CgkJCQkJCQkJaWYgKGpzRXh0IHx8IG4ubG9hZCkgbW9kdWxlcy5wdXNoKHJldCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGF3YWl0IHJlcy50ZXh0KCkpKTsKCQkJCQkJCQlpZiAoIWpzRXh0ICYmICFuLmxvYWQpIHJldCA9IGF3YWl0IHJlcy50ZXh0KCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjoiLCBleCwgcyk7CgkJCQl9CgkJCX0KCgkJCWlmIChuLmxvYWQpIHsKCQkJCXRyeSB7CgkJCQkJLy9jb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXTogY2FsbGluZyBsb2FkKCkiKTsKCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgbW9kdWxlcywgZXgpOwoJCQkJfQoJCQl9CgkJfQoJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIHBvc3RJbml0KCkgewoJCXRyeSB7CgkJCXdpbmRvdy5mcmFtZXNbMF0ucmVSZW5kZXIgPyB3aW5kb3cuZnJhbWVzWzBdLnJlUmVuZGVyKCkgOiBudWxsOwoJCX0gY2F0Y2ggKGV4KSB7fQoKCQl0cnkgewoJCQlsZXQgZXZlbnRzID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFdmVudHMiKTsKCQkJaWYgKCFldmVudHMgJiYgY29tcGFueS5FdmVudHMpIHsKCQkJCWV2ZW50cyA9IGF3YWl0IGNvbXBhbnkuRXZlbnRzKCk7CgkJCX0KCQkJKGV2ZW50cyB8fCBbXSkuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZvckVhY2goZXYgPT4gewoJCQkJJChldi5fcGF0aCwgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudCkub24oZXYuX2V2ZW50LCBldi5faGFuZGxlcik7CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7fQoJfQoKCWV4Y2VsVG9KU09OKGRhdGEsIHN0YXJ0LCBjb3VudCkgewoJCWlmICh0eXBlb2YoWExTWCkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CgkJdHJ5IHsKCQkJdmFyIHdvcmtib29rID0gWExTWC5yZWFkKGRhdGEsIHsKCQkJCXR5cGU6ICdiaW5hcnknLAoJCQkJc2hlZXRSb3dzOiAwIC8qc3RhcnQgKyAiLSIgKyAoc3RhcnQgKyBjb3VudCkqLwoJCQl9KTsKCQkJLy92YXIgcmFuZ2UgPSBYTFNYLnV0aWxzLmRlY29kZV9yYW5nZSh3b3JrYm9vay5TaGVldHNbd29ya2Jvb2suU2hlZXROYW1lc1swXV1bJyFyZWYnXSk7CgkJCXZhciBzaGVldCA9IHdvcmtib29rLlNoZWV0c1t3b3JrYm9vay5TaGVldE5hbWVzWzBdXTsKCQkJcmV0dXJuIFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCk7CgkJfSBjYXRjaCAoZSkgewoJCQkvL3Rocm93IGU7CgkJCWNvbnNvbGUubG9nKCJFUlJPUjoiLCBlKTsKCQkJcmV0dXJuIFtdOwoJCX0KCX0KCglhc3luYyBfdW56aXAoZmlsZSkgewoJCXZhciB6aXAgPSBuZXcgSlNaaXAoKTsKCQlsZXQgZiA9IGF3YWl0IHppcC5sb2FkKGZpbGUsIHsKCQkJYmFzZTY0OiB0cnVlCgkJfSkKCX0KCglhc3luYyBfemlwKGZpbGVzKSB7CgkJdmFyIHppcCA9IG5ldyBKU1ppcCgpOwoJCWZpbGVzLmZvckVhY2goZiA9PiB7CgkJCXppcC5maWxlKGYubmFtZSwgZi5maWxlKTsKCQl9KTsKCQlsZXQgcmV0ID0gYXdhaXQgemlwLmdlbmVyYXRlKHsKCQkJdHlwZTogJ2Jsb2InLAoJCQljb21wcmVzc2lvbjogIkRFRkxBVEUiCgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglVdGY4QXJyYXlUb1N0cihhcnJheSkgewoJCXZhciBvdXQsIGksIGxlbiwgYzsKCQl2YXIgY2hhcjIsIGNoYXIzOwoKCQlvdXQgPSAiIjsKCQlsZW4gPSBhcnJheS5sZW5ndGg7CgkJaSA9IDA7CgkJd2hpbGUgKGkgPCBsZW4pIHsKCQkJYyA9IGFycmF5W2krK107CgkJCXN3aXRjaCAoYyA+PiA0KSB7CgkJCQljYXNlIDA6CgkJCQljYXNlIDE6CgkJCQljYXNlIDI6CgkJCQljYXNlIDM6CgkJCQljYXNlIDQ6CgkJCQljYXNlIDU6CgkJCQljYXNlIDY6CgkJCQljYXNlIDc6CgkJCQkJLy8gMHh4eHh4eHgKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTI6CgkJCQljYXNlIDEzOgoJCQkJCS8vIDExMHggeHh4eCAgIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQlvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoKGMgJiAweDFGKSA8PCA2KSB8IChjaGFyMiAmIDB4M0YpKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgMTQ6CgkJCQkJLy8gMTExMCB4eHh4ICAxMHh4IHh4eHggIDEweHggeHh4eAoJCQkJCWNoYXIyID0gYXJyYXlbaSsrXTsKCQkJCQljaGFyMyA9IGFycmF5W2krK107CgkJCQkJb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgwRikgPDwgMTIpIHwKCQkJCQkJKChjaGFyMiAmIDB4M0YpIDw8IDYpIHwKCQkJCQkJKChjaGFyMyAmIDB4M0YpIDw8IDApKTsKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCglhc3luYyBfY29tcHJlc3Moc3RyKSB7CgkJY29uc3QgYnl0ZUFycmF5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN0cik7CgkJY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImd6aXAiKTsKCQljb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKCQl3cml0ZXIud3JpdGUoYnl0ZUFycmF5KTsKCQl3cml0ZXIuY2xvc2UoKTsKCQlyZXR1cm4gbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpCgoJCS8vIENvbnZlcnQgdGhlIHN0cmluZyB0byBhIGJ5dGUgc3RyZWFtLgoJCWNvbnN0IHN0cmVhbSA9IG5ldyBCbG9iKFtzdHJdKS5zdHJlYW0oKTsKCgkJLy8gQ3JlYXRlIGEgY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgY29tcHJlc3NlZFN0cmVhbSA9IHN0cmVhbS5waXBlVGhyb3VnaCgKCQkJbmV3IENvbXByZXNzaW9uU3RyZWFtKCJnemlwIikKCQkpOwoKCQkvLyBSZWFkIGFsbCB0aGUgYnl0ZXMgZnJvbSB0aGlzIHN0cmVhbS4KCQljb25zdCBjaHVua3MgPSBbXTsKCQlmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIGNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQlyZXR1cm4gYXdhaXQgbmV3IFVpbnQ4QXJyYXkoYXdhaXQgbmV3IEJsb2IoY2h1bmtzKS5hcnJheUJ1ZmZlcigpKTsKCX0KCglhc3luYyBfZGVjb21wcmVzcyhjb21wcmVzc2VkQnl0ZXMpIHsKCQkvLyBDb252ZXJ0IHRoZSBieXRlcyB0byBhIHN0cmVhbS4KCQljb25zdCBzdHJlYW0gPSBuZXcgQmxvYihbY29tcHJlc3NlZEJ5dGVzXSkuc3RyZWFtKCk7CgoJCS8vIENyZWF0ZSBhIGRlY29tcHJlc3NlZCBzdHJlYW0uCgkJY29uc3QgZGVjb21wcmVzc2VkU3RyZWFtID0gc3RyZWFtLnBpcGVUaHJvdWdoKAoJCQluZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZ3ppcCIpCgkJKTsKCgkJLy8gUmVhZCBhbGwgdGhlIGJ5dGVzIGZyb20gdGhpcyBzdHJlYW0uCgkJY29uc3QgY2h1bmtzID0gW107CgkJZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBkZWNvbXByZXNzZWRTdHJlYW0pIHsKCQkJY2h1bmtzLnB1c2goY2h1bmspOwoJCX0KCQljb25zdCBzdHJpbmdCeXRlcyA9IGF3YWl0IG5ldyBVaW50OEFycmF5KGF3YWl0IG5ldyBCbG9iKGNodW5rcykuYXJyYXlCdWZmZXIoKSk7CgoJCS8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgc3RyaW5nLgoJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoc3RyaW5nQnl0ZXMpOwoJfQoKCWFzeW5jIGRvd25sb2FkU1JDYWNoZShjb2RlLCBmaWxlbmFtZSkgewoJCS8vIHRvIGJlIG1vdmVkIG91dCBvZiB0aGlzIGNsYXNzCgkJY29kZSA9IGNvZGUgfHwgY29tcGFueS5Db2RlOwoJCWxldCBmaWxlcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kYWxsJywgbnVsbCwgewoJCQlDb2RlOiBjb2RlICsgJy0nLAoJCX0pOwoJCXJldHVybiBhd2FpdCB0aGlzLl96aXAoZmlsZXMubWFwKHIgPT4gKHsKCQkJbmFtZTogci5Db2RlLnJlcGxhY2UoY29kZSArICctJywgJycpICsgJy5qcycsCgkJCWZpbGU6IHIuUmVzdWx0CgkJfSkpLCBmaWxlbmFtZSB8fCAnc3JDYWNoZS56aXAnKTsKCX0KCglhc3luYyBfZ2V0QmxvY2soYmxvY2spIHsKCQl2YXIganMgPSBudWxsOwoJCXZhciBodG1sID0gbnVsbDsKCQl0aGlzLmJsb2Nrc1tibG9ja10gPSB7CgkJCWh0bWw6ICIiLAoJCQlvYmo6IG51bGwsCgkJfQoJCXRyeSB7CgkJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQkJbGV0IHAgPSBhd2FpdCB0aGlzLmFwaVNlcnZlci5fbmV3KCdIVE1MUGFnZScpLnBhZ2UodGhpcy5hcGlTZXJ2ZXIuU2NvcGUgKyBibG9jay5pbmRleE9mKCcvJykgPj0gMCA/IGJsb2NrIDogKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgJy9ibG9ja3MnICsgdGhpcy5tKCkgKyAiLyIgKyBibG9jaykpLmZpbmQoKTsKCQkJCWlmIChwKSB7CgkJCQkJaHRtbCA9IHAuYm9keSgpID8gcC5ib2R5KCkgOiAnJzsKCQkJCQlqcyA9IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogbnVsbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCFqcykganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUoewoJCQkJX2NvZGU6IGJsb2NrCgkJCX0sICJibG9ja3MiKTsKCgkJCWlmICghanMgJiYgd2luZG93LmJMb2NhbCkgewoJCQkJanMgPSBhd2FpdCBmZXRjaCh0aGlzLnJhbmRVUkwoImJsb2NrcyIgKyB0aGlzLm0oKSArICIvIiArIGJsb2NrICsgIi5qcyIpKTsKCQkJCWpzID0ganMub2sgPyAoYXdhaXQganMudGV4dCgpKSA6IG51bGw7CgkJCX0KCgkJCWlmIChqcykgewoJCQkJanMgPSBhd2FpdCB0aGlzLnJ1blNjcmlwdChqcyk7CgkJCQlpZiAodHlwZW9mKGpzKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YoanMuY29uc3RydWN0b3IpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIG9iaiA9IG5ldyBqcygpOwoJCQkJCQlpZiAob2JqICYmIG9iai5tYWluKSB7CgkJCQkJCQl0aGlzLmJsb2Nrc1tibG9ja10ub2JqID0gb2JqOwoJCQkJCQkJY29uc29sZS5sb2coIkNhbGxpbmcgIiArIGJsb2NrICsgIi5tYWluKCkiKTsKCQkJCQkJCWF3YWl0IG9iai5tYWluKCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCX0KCgkJaWYgKCFodG1sICYmIHdpbmRvdy5iTG9jYWwpIHsKCQkJaHRtbCA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgiYmxvY2tzIiArIHRoaXMubSgpICsgIi8iICsgYmxvY2sgKyAiLmh0bSIpKTsKCQkJaHRtbCA9IGh0bWwub2sgPyAoYXdhaXQgaHRtbC50ZXh0KCkpIDogJyc7CgkJfQoJCXRoaXMuYmxvY2tzW2Jsb2NrXS5odG1sID0gaHRtbDsKCgkJaWYgKGpzICYmICF0aGlzLmJsb2Nrc1tibG9ja10uaHRtbCAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3dbYmxvY2sgKyAiQ29tcG9uZW50Il0pIHsKCQkJdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgPSAiPCIgKyBibG9jayArICJDb21wb25lbnQvPiI7CgkJfQoJCXRoaXMuc3RlcCgpOwoJCWNvbnNvbGUubG9nKGJsb2NrICsgIiBsb2FkZWQiKTsKCQlyZXR1cm4gdGhpcy5ibG9ja3NbYmxvY2tdLmh0bWwgfHwgIiI7Cgl9CgoJYXN5bmMgX2xvYWRDb250ZW50KCkgewoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJtYWluIik7CgkJYXdhaXQgdGhpcy5fZ2V0QmxvY2soImhlYWRlciIpOwoJCWF3YWl0IHRoaXMuX2dldEJsb2NrKCJmb290ZXIiKTsKCQlhd2FpdCB0aGlzLl9nZXRCbG9jaygiY29udGVudCIpOwoJCXRoaXMuZnJvbUhhc2goKTsKCgkJd2luZG93LmxhbmcgPSB0aGlzLmhhc2gubGFuZyB8fCAodHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyA/IGNvbXBhbnkuTGFuZ3VhZ2UgOiBudWxsKSB8fCAnZW4nOwoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuR0FDb2RlKSB7CgkJCS8vIGdvb2dsZSBhbmFseXRpY3MKCQkJY29uc29sZS5sb2coImluY2x1ZGluZyBnb29nbGUgYW5hbHl0aWNzIik7CgkJCShmdW5jdGlvbihpLCBzLCBvLCBnLCByLCBhLCBtKSB7CgkJCQlpWydHb29nbGVBbmFseXRpY3NPYmplY3QnXSA9IHI7CgkJCQlpW3JdID0gaVtyXSB8fCBmdW5jdGlvbigpIHsKCQkJCQkoaVtyXS5xID0gaVtyXS5xIHx8IFtdKS5wdXNoKGFyZ3VtZW50cyk7CgkJCQl9LCBpW3JdLmwgPSAxICogbmV3IERhdGUoKTsKCQkJCWEgPSBzLmNyZWF0ZUVsZW1lbnQobyksCgkJCQkJbSA9IHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobylbMF07CgkJCQlhLmFzeW5jID0gMTsKCQkJCWEuc3JjID0gZzsKCQkJCW0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgbSk7CgkJCX0pKHdpbmRvdywgZG9jdW1lbnQsICdzY3JpcHQnLCAnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywgJ2dhJyk7CgkJCWdhKCdjcmVhdGUnLCBjb21wYW55LkdBQ29kZSwgJ2F1dG8nKTsKCQl9CgkJcmV0dXJuIHRoaXMuUmVuZGVyUGFnZSh7CgkJCV9jb2RlOiAodGhpcy5oYXNoLnBhZ2UgfHwgJ2luZGV4JykKCQl9KTsKCX0KCglhc3luYyBwcmVJbml0KCkgewoJCXdpbmRvdy5iTG9jYWwgPSBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJy9uYW1tb3VyLmNvbScpID4gLTEgJiYgIXdpbmRvdy5mcmFtZXMubGVuZ3RoOwoJCWlmICh0aGlzLmFwaVNlcnZlcikgewoJCQlhd2FpdCB0aGlzLnJlcXVpcmUoIk1vZHVsZXMiKTsKCQl9IGVsc2UgewoJCQlpZiAod2luZG93LmJMb2NhbCkgewoJCQkJdGhpcy5ocmVmcyA9IGF3YWl0IHRoaXMuaW1wb3J0KCIuLi8uLi8iICsgKHdpbmRvdy5iTG9jYWwgPyAiLi4vZW1zLyIgOiAiIikgKyAic2NyaXB0L21vZHVsZXMiKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaHJlZnMgPSBhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQkJCU5hbWU6ICdNb2R1bGVzJwoJCQkJfSk7CgkJCX0KCQkJYXdhaXQgdGhpcy5yZXF1aXJlKCdKUXVlcnknKTsKCQl9CgoJCXdpbmRvdy5fRnJFTUQgPSB0aGlzOwoJCXRoaXMuZnJvbUhhc2goKTsKCQkkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBhc3luYyAoKSA9PiB7CgkJCXRoaXMuZnJvbUhhc2goKTsKCQkJaWYgKHRoaXMuYWxsRGF0YSAmJiB0aGlzLmFsbERhdGEucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAmJiB0aGlzLmhhc2gucGFnZSAhPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZSAmJiB0aGlzLmVuZENhbGxlZCkgewoJCQkJaWYgKHdpbmRvdy5mcmFtZXMubGVuZ3RoKSB7CgkJCQkJLy8gZnJhbWUtYmFzZWQgdGVtcGxhdGUKCQkJCQlhd2FpdCB0aGlzLmluaXRET00oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIkZyRU1EOjpwcmVJbml0KCk6IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkLCBsb2FkaW5nIHBhZ2UgIiArIHRoaXMuaGFzaC5wYWdlKTsKCQkJCQlhd2FpdCB0aGlzLlJlbmRlclBhZ2UoewoJCQkJCQlfY29kZTogdGhpcy5oYXNoLnBhZ2UKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlhd2FpdCB0aGlzLnJlcXVpcmUoIlNjaGVtYSIpOwoJCS8vYXdhaXQgdGhpcy5yZXF1aXJlKCJEeW5hRm9ybSIpOyBjb21wYW55LlJlcXVpcmVkCgoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCWlmIChjb21wYW55Lk9uQmVmb3JlUmVxdWlyZSkgYXdhaXQgY29tcGFueS5PbkJlZm9yZVJlcXVpcmUoKTsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIGNvbXBhbnkuUmVxdWlyZWQgfHwgW10pIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsKTsKCQkJfQoJCX0KCgkJLy8gZmFpbHNhZmUKCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5Q2xhc3Nlcyhhd2FpdCB0aGlzLl9nZXRTdG9yZWRTY3JpcHQoewoJCQlOYW1lOiAiQ29udGVudCBNYW5hZ2VyIiwKCQkJRW5hYmxlZDogdHJ1ZSwKCQl9KSwgImNvbnRlbnRtYW5hZ2VyIik7CgoJCWF3YWl0IHRoaXMuX21hbmlmZXN0KCk7CgoJCWNvbnNvbGUubG9nKCJEb25lIExvYWRpbmciKTsKCX0KCglhc3luYyBfbWFuaWZlc3Qoc2NvcGUsIGpzb24pIHsKCQl0cnkgewoJCQlpZiAoIWpzb24pIHsKCQkJCWpzb24gPSBhd2FpdCB0aGlzLl9leHBvcnQoewoJCQkJCXRlbXBsYXRlOiAiTUFOSUZFU1QiCgkJCQl9LCBzY29wZSk7CgkJCX0KCQkJbGV0IGhyZWYgPSB0aGlzLnRvQmFzZTY0KG51bGwsIGpzb24sICdhcHBsaWNhdGlvbi9tYW5pZmVzdCtqc29uJywgdHJ1ZSk7CgkJCWlmICh0aGlzLl9tYW5Dc3MpIHsKCQkJCXRoaXMuX21hbkNzcy5hdHRyKCJocmVmIiwgaHJlZik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9tYW5Dc3MgPSB0aGlzLl9jc3MoaHJlZiwgJ21hbmlmZXN0Jyk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGxvYWRpbmcgbWFuaWZlc3QiLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9leHBvcnQodG1wLCBzY29wZSwgb3B0aW9ucyA9IHt9KSB7CgkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQlsZXQgdGVtcGxhdGUgPSB0bXAuY29udGVudCB8fCBhd2FpdCBmZXRjaChgJHt0bXAucGF0aHx8KCd0ZW1wbGF0ZXMnICsgdGhpcy5tKCkgKyAnLycpfSR7dG1wLnRlbXBsYXRlfS4ke3RtcC5leHR8fCdqc3QnfT9yYW5kPSR7TWF0aC5yYW5kb20oKX1gKTsKCQlsZXQgcmV0ID0gdGhpcy5faW5qZWN0KHRlbXBsYXRlLCB7CgkJCW9TY29wZTogdGhpcy5fX3Njb3BlKHNjb3BlKSwKCQkJbWU6IHdpbmRvdy5tZSwKCQkJc2NvcGUsCgkJCW9wdGlvbnMsCgkJfSwgb3B0aW9ucy5lbmdpbmUpOwoKCQlpZiAodGhpcy5fYmVhdXRpZnkpIHJldCA9IHRoaXMuX2JlYXV0aWZ5KHJldCwgdG1wLmxhbmd1YWdlKTsKCQlpZiAoIXRtcC5sYW5ndWFnZSkgewoJCQlyZXQgPSByZXQucmVwbGFjZSgvXlxzKiQoPzpcclxuP3xcbikvZ20sICcnKTsgLy8gcmVtb3ZlIGVtcHR5IGxpbmVzCgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgaW5pdERPTSgpIHsKCQl3aW5kb3cuX0ZyRU1EID0gdGhpczsKCQl3aW5kb3cuZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJdGhpcy5oYXNoLnBhZ2UgPSB0aGlzLmhhc2gucGFnZSB8fCAnaW5kZXgnOwoKCQl0cnkgewoJCQlhd2FpdCAoKGNvbXBhbnkgJiYgY29tcGFueS5PblBhZ2VMb2FkKSA/IGNvbXBhbnkuT25QYWdlTG9hZCA6IGFzeW5jICgpID0+IHt9KSgpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKCJGckVNRC5pbml0RE9NLk9uUGFnZUxvYWQiLCBleCk7CgkJfQoKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpIDwgMCAmJiAhd2luZG93LmZyYW1lc1swXS5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlsZXQgdXJsID0gJ3dlYnNpdGUvJyArIHRoaXMuaGFzaC5wYWdlICsgJy4nICsgKGNvbXBhbnkuZXh0ZW5zaW9uIHx8ICdodG0nKSArICc/cmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJd2luZG93LmRvY3VtZW50LmJvZHkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJCWxldCBodG1sID0gYXdhaXQgZmV0Y2godXJsKTsKCQkJaHRtbCA9IHRoaXMuX2luamVjdChodG1sLCB3aW5kb3cucGFyZW50KTsKCgkJCWNvbnN0IGRvbXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCWxldCBkb2MgPSBkb21wLnBhcnNlRnJvbVN0cmluZyhodG1sLCAidGV4dC9odG1sIik7CgkJCWF3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3MoZG9jKTsKCQkJY29uc29sZS5sb2coImh0bWwgYmluZGluZyBkb25lISIpOwoKCQkJaHRtbCA9IGRvYy5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwoJCQkvL2h0bWwgPSAndGVzdCc7CgoJCQkvL3dpbmRvdy5mcmFtZXNbMF0ubG9jYXRpb24gPSB1cmw7CgkJCXdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQud3JpdGUoaHRtbCk7CgkJfQoKCQlhd2FpdCB0aGlzLl9iaW5kS08oKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJYXN5bmMgX2JpbmRLTygpIHsKCQlpZiAoY29tcGFueS5SZXF1aXJlZC5pbmRleE9mKCdrbm9ja291dCcpID49IDApIHsKCQkJc2V0VGltZW91dChhc3luYyAoKSA9PiB7CgkJCQkvL2F3YWl0IHRoaXMuX2FwcGx5QmluZGluZ3Mod2luZG93LmZyYW1lc1swXS5kb2N1bWVudCwgdHJ1ZSk7CgoJCQkJa28uY2xlYW5Ob2RlKHdpbmRvdy5mcmFtZXNbMF0uZG9jdW1lbnQuYm9keSk7CgkJCQlrby5hcHBseUJpbmRpbmdzKHdpbmRvdywgd2luZG93LmZyYW1lc1swXS5kb2N1bWVudC5ib2R5KTsKCQkJCXdpbmRvdy5kb2N1bWVudC50aXRsZSA9IGNvbXBhbnkuTmFtZTsKCQkJCXdpbmRvdy5kb2N1bWVudC5ib2R5LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgkJCX0sIDMwMCk7CgkJfQoJfQoKCV9zZXQob2JqLCBwYXRoLCB2YWwpIHsKCQl2YXIgc3RyaW5nVG9QYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJCQkvLyBJZiB0aGUgcGF0aCBpc24ndCBhIHN0cmluZywgcmV0dXJuIGl0CgkJCWlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHJldHVybiBwYXRoOwoJCQkvLyBDcmVhdGUgbmV3IGFycmF5CgkJCXZhciBvdXRwdXQgPSBbXTsKCQkJLy8gU3BsaXQgdG8gYW4gYXJyYXkgd2l0aCBkb3Qgbm90YXRpb24KCQkJcGF0aC5zcGxpdCgnLicpLmZvckVhY2goZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKCQkJCS8vIFNwbGl0IHRvIGFuIGFycmF5IHdpdGggYnJhY2tldCBub3RhdGlvbgoJCQkJaXRlbS5zcGxpdCgvXFsoW159XSspXF0vZykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKCQkJCQkvLyBQdXNoIHRvIHRoZSBuZXcgYXJyYXkKCQkJCQlpZiAoa2V5Lmxlbmd0aCA+IDApIHsKCQkJCQkJb3V0cHV0LnB1c2goa2V5KTsKCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfTsKCQkvLyBDb252ZXJ0IHRoZSBwYXRoIHRvIGFuIGFycmF5IGlmIG5vdCBhbHJlYWR5CgkJcGF0aCA9IHN0cmluZ1RvUGF0aChwYXRoKTsKCQkvLyBDYWNoZSB0aGUgcGF0aCBsZW5ndGggYW5kIGN1cnJlbnQgc3BvdCBpbiB0aGUgb2JqZWN0CgkJdmFyIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwoJCXZhciBjdXJyZW50ID0gb2JqOwoJCS8vIExvb3AgdGhyb3VnaCB0aGUgcGF0aAoJCXBhdGguZm9yRWFjaChmdW5jdGlvbihrZXksIGluZGV4KSB7CgkJCS8vIENoZWNrIGlmIHRoZSBhc3NpZ25lZCBrZXkgc2hvdWwgYmUgYW4gYXJyYXkKCQkJdmFyIGlzQXJyYXkgPSBrZXkuc2xpY2UoLTIpID09PSAnW10nOwoJCQkvLyBJZiBzbywgZ2V0IHRoZSB0cnVlIGtleSBuYW1lIGJ5IHJlbW92aW5nIHRoZSB0cmFpbGluZyBbXQoJCQlrZXkgPSBpc0FycmF5ID8ga2V5LnNsaWNlKDAsIC0yKSA6IGtleTsKCQkJLy8gSWYgdGhlIGtleSBzaG91bGQgYmUgYW4gYXJyYXkgYW5kIGlzbid0LCBjcmVhdGUgYW4gYXJyYXkKCQkJaWYgKGlzQXJyYXkgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRba2V5XSkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCWN1cnJlbnRba2V5XSA9IFtdOwoJCQl9CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbG9vcCwgYXNzaWduIHRoZSB2YWx1ZQoJCQlpZiAoaW5kZXggPT09IGxlbmd0aCAtIDEpIHsKCQkJCS8vIElmIGl0J3MgYW4gYXJyYXksIHB1c2ggdGhlIHZhbHVlCgkJCQkvLyBPdGhlcndpc2UsIGFzc2lnbiBpdAoJCQkJaWYgKGlzQXJyYXkpIHsKCQkJCQljdXJyZW50W2tleV0ucHVzaCh2YWwpOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50W2tleV0gPSB2YWw7CgkJCQl9CgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB1cGRhdGUgdGhlIGN1cnJlbnQgcGxhY2UgaW4gdGhlIG9iamVjdAoJCQllbHNlIHsKCQkJCS8vIElmIHRoZSBrZXkgZG9lc24ndCBleGlzdCwgY3JlYXRlIGl0CgkJCQlpZiAoIWN1cnJlbnRba2V5XSkgewoJCQkJCWN1cnJlbnRba2V5XSA9IHt9OwoJCQkJfQoJCQkJLy8gVXBkYXRlIHRoZSBjdXJyZW50IHBsYWNlIGluIHRoZSBvYmplY3QKCQkJCWN1cnJlbnQgPSBjdXJyZW50W2tleV07CgkJCX0KCQl9KTsKCX0KCglfcGFnZUZpbHRlcihiKSB7CgkJaWYgKCFiLl9hY3RpdmUpIHJldHVybiBmYWxzZTsKCQlsZXQgcGFnZSA9IHR5cGVvZihfRnJFTUQuaGFzaC5wYWdlKSA9PT0gJ3VuZGVmaW5lZCcgPyAnaW5kZXgnIDogX0ZyRU1ELmhhc2gucGFnZTsKCQlpZiAodHlwZW9mKGIuX3BhZ2UpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoYi5fcGFnZS5fdXJsKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0cnVlOwoJCXJldHVybiBiLl9wYWdlLl91cmwgPT0gcGFnZTsKCX0KCglhc3luYyBfYXBwbHlCaW5kaW5ncyhkb2MgPSB3aW5kb3cuZnJhbWVzWzBdLmRvY3VtZW50LCBiQWZ0ZXIgPSBmYWxzZSkgewoJCXRoaXMuZnJvbUhhc2goKTsKCQlpZiAodGhpcy5oYXNoLm5vQmluZGluZykgcmV0dXJuOwoJCWxldCBiaW5kaW5ncyA9IGF3YWl0IHRoaXMucmVxdWlyZSgiQmluZGluZ3MiKTsKCQlpZiAoIWJpbmRpbmdzICYmIGNvbXBhbnkuQmluZGluZ3MpIHsKCQkJYmluZGluZ3MgPSBhd2FpdCBjb21wYW55LkJpbmRpbmdzKCk7CgkJfQoJCWJpbmRpbmdzID0gYmluZGluZ3MgfHwgW107CgoJCXNyLmdyb3VwQnkoYmluZGluZ3MuZmlsdGVyKHRoaXMuX3BhZ2VGaWx0ZXIpLmZpbHRlcihiID0+IGJBZnRlciA/IGIuX2FmdGVyIDogIWIuX2FmdGVyKSwgIl9wYXRoIikuZm9yRWFjaChwYiA9PiB7CgkJCXRyeSB7CgkJCQlsZXQgZSA9IGRvYy5ldmFsdWF0ZShwYi5rZXksIGRvYywgbnVsbCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsIG51bGwpLnNpbmdsZU5vZGVWYWx1ZTsKCQkJCWxldCBkX2JpbmQgPSB7fTsKCQkJCXBiLnZhbHVlcy5mb3JFYWNoKGIgPT4gewoJCQkJCXRoaXMuX3NldChkX2JpbmQsIGIuX2F0dHJpYnV0ZSwgYi5fY29kZSk7CgkJCQl9KTsKCQkJCSQoZSkuYXR0cigiZGF0YS1iaW5kIiwgSlNPTi5zdHJpbmdpZnkoZF9iaW5kKS5yZXBsYWNlKC8iL2csICcnKSk7CgkJCQkvL2NvbnNvbGUubG9nKHBiLmtleSwgZSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZyhwYi5rZXksIGV4KTsKCQkJfQoJCX0pOwoJfQoKCWFzeW5jIGluaXQoKSB7CgkJYXdhaXQgdGhpcy5wcmVJbml0KCk7CgkJYXdhaXQgdGhpcy5fbG9hZENvbnRlbnQoKTsKCQlhd2FpdCB0aGlzLnBvc3RJbml0KCk7Cgl9CgoJX3V1aWQoaWQsIGxlbikgewoJCWxldCByZXQgPSBudWxsOwoJCWlmIChpZCkgewoJCQlsZXQgaGMgPSBNYXRoLmFicyhOdW1iZXIodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzci5oYXNoQ29kZShpZCkgOiBpZC5sZW5ndGgpKTsKCQkJbGV0IGhzID0gaCA9PiBOdW1iZXIoU3RyaW5nKGgpLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIikpOwoJCQlsZXQgdSA9IGhzKGhzKGhjKSAqIGhzKGhjKSkudG9TdHJpbmcoMTYpOwoKCQkJcmV0ID0gdSArICcnICsgdSArICcnICsgdTsKCQkJaWYgKHJldC5sZW5ndGggPiAzMikgcmV0ID0gcmV0LnN1YnN0cmluZygwLCAzMik7CgkJfQoKCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdigpOwoKCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCk7CgoJCXJldHVybiByZXQucmVwbGFjZSgvXC0vZywgJycpOwoJfQoKCWFzeW5jIF9sb2FkRW50aXR5Q2xhc3NlcyhlYywgc2NvcGUpIHsKCQkvL3Njb3BlID0gdGhpcy5fX3Njb3BlTmFtZShzY29wZSk7CgkJbGV0IGVhcyA9IFtdOwoKCQlpZiAoZWMgJiYgZWMubGlicmFyeSAmJiAhQXJyYXkuaXNBcnJheShlYykgJiYgdGhpcy5zcigpLl8gJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWxldCBsY3MgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zR2VuZXJhdGVMYXllckNsYXNzIiwgbnVsbCwgZWMubGlicmFyeSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goYy5MYXllckF0dHJpYnV0ZXMsIChfLCBsYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiBsYS5OYW1lLAoJCQkJUGx1cmFsOiBsYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogbGEsCgkJCQlJc0Jvb2w6IGxhLk5hdGl2ZVR5cGUgPT0gImJvb2wiLAoJCQkJSXNTdHJpbmc6IGxhLk5hdGl2ZVR5cGUgPT0gInN0cmluZyIsCgkJCQlJc1RleHQ6IGxhLk5hdGl2ZVR5cGUgPT0gInRleHQiLAoJCQkJSXNMb25nOiBsYS5OYXRpdmVUeXBlID09ICJsb25nIiwKCQkJCUlzRmxvYXQ6IGxhLk5hdGl2ZVR5cGUgPT0gImZsb2F0IiwKCQkJCUlzSW50OiBsYS5OYXRpdmVUeXBlID09ICJpbnRlZ2VyIiwKCQkJCUlzRG91YmxlOiBsYS5OYXRpdmVUeXBlID09ICJkb3VibGUiLAoJCQkJSXNEYXRlOiBsYS5OYXRpdmVUeXBlID09ICJkYXRldGltZSIsCgkJCQlJc0ZpbGU6IGxhLk5hdGl2ZVR5cGUgPT0gImZpbGUiLAoJCQkJSXNJbWFnZTogbGEuTmF0aXZlVHlwZSA9PSAiaW1hZ2UiLAoJCQkJSXNPYmplY3Q6IGxhLk5hdGl2ZVR5cGUgPT0gIm9iamVjdCIsCgkJCQlFbnRpdHlDbGFzczogewoJCQkJCUlkOiBzci5oYXNoQ29kZShjLk5hbWUpLAoJCQkJCU5hbWU6IGMuTmFtZSwKCQkJCQlQbHVyYWw6IGMuTmFtZSArICJzIiwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQlSZW1hcms6ICIiLAoJCQkJCUNvbXBhbnk6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKGNvbXBhbnkuTmFtZSksCgkJCQkJCU5hbWU6IGNvbXBhbnkuTmFtZQoJCQkJCX0sCgkJCQkJR3JvdXA6IHsKCQkJCQkJSWQ6IHNyLmhhc2hDb2RlKCJNYWluIiksCgkJCQkJCU5hbWU6ICJNYWluIgoJCQkJCX0KCQkJCX0sCgkJCX0pKSk7CgkJCSQuZWFjaChsY3MsIChfLCBjKSA9PiAkLmVhY2goJC5ncmVwKGMuUmVsYXRpb25BdHRyaWJ1dGVzLCByYSA9PiAhcmEuSXNBcnJheSksIChfLCByYSkgPT4gZWFzLnB1c2goewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCUlkOiB0aGlzLl91dWlkKCksCgkJCQlOYW1lOiByYS5OYW1lLAoJCQkJUGx1cmFsOiByYS5OYW1lICsgInMiLAoJCQkJLy9MYXllckF0dHJpYnV0ZTogcmEsCgkJCQlJc0Jvb2w6IGZhbHNlLAoJCQkJSXNTdHJpbmc6IGZhbHNlLAoJCQkJSXNUZXh0OiBmYWxzZSwKCQkJCUlzTG9uZzogZmFsc2UsCgkJCQlJc0Zsb2F0OiBmYWxzZSwKCQkJCUlzSW50OiBmYWxzZSwKCQkJCUlzRG91YmxlOiBmYWxzZSwKCQkJCUlzRGF0ZTogZmFsc2UsCgkJCQlJc0ZpbGU6IGZhbHNlLAoJCQkJSXNJbWFnZTogZmFsc2UsCgkJCQlFbnRpdHlUeXBlOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKHJhLlJlbGF0aW9uQ2xhc3MuTmFtZSksCgkJCQkJTmFtZTogcmEuUmVsYXRpb25DbGFzcy5OYW1lLAoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJSWQ6IHNyLmhhc2hDb2RlKGMuTmFtZSksCgkJCQkJTmFtZTogYy5OYW1lLAoJCQkJCVBsdXJhbDogYy5OYW1lICsgInMiLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCVJlbWFyazogIiIsCgkJCQkJQ29tcGFueTogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoY29tcGFueS5OYW1lKSwKCQkJCQkJTmFtZTogY29tcGFueS5OYW1lCgkJCQkJfSwKCQkJCQlHcm91cDogewoJCQkJCQlJZDogc3IuaGFzaENvZGUoIk1haW4iKSwKCQkJCQkJTmFtZTogIk1haW4iCgkJCQkJfQoJCQkJfSwKCQkJfSkpKTsKCQl9IGVsc2UgaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5Db2RlICYmICFBcnJheS5pc0FycmF5KGVjKSAmJiB0aGlzLnNyKCkuXyAmJiB3aW5kb3cuYkxvY2FsKSB7CgkJCWVhcyA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlBdHRyaWJ1dGVGaW5kYWxsIiwgbnVsbCwgewoJCQkJVEhJUzogZWMgPyBbewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogZWMKCQkJCX0sIHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQlFbnRpdHlNb2R1bGU6IHsKCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJCQlDb21wYW5pZXM6IFt7CgkJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJCUVudGl0eUNsYXNzZXM6IFtlY10KCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSA6IFt7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJQ29tcGFueTogewoJCQkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJRW50aXR5TW9kdWxlOiB7CgkJCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCQkJQ29tcGFuaWVzOiBbewoJCQkJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUKCQkJCQkJCX1dCgkJCQkJCX0KCQkJCQl9CgkJCQl9XSwKCQkJfSk7CgkJfQoKCQl0aGlzLnN0ZXAoKTsKCgkJaWYgKCghZWFzIHx8ICFlYXMubGVuZ3RoKSAmJiAoIWVjIHx8ICFlYy5sZW5ndGgpKSB7CgkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eUNsYXNzZXMoIiArIHNjb3BlICsgIik6IGZhaWxlZCB0byBsb2FkIGNsYXNzZXMuLi4iKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiAoQXJyYXkuaXNBcnJheShlYykgPyBlYyA6IFtdKS5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUpKSBhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKG0sIGVjKTsKCgkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHx8IFtdOwoKCQlpZiAoIWVhcy5sZW5ndGgpIHsKCQkJLy8gY2xhc3NlcyBmcm9tIEpTT04gQXJyYXkKCQkJZWFzID0gZWFzLmNvbmNhdCguLi5yZXQubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzKSk7CgkJfQoKCQlyZXR1cm4gYXdhaXQgdGhpcy5fYnVpbGRDbGFzc2VzKHJldCwgc2NvcGUsIGVhcyk7Cgl9CgoJX21lbnVDbGFzc2VzKHNjb3BlKSB7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gW107CgoJCXJldHVybiB0aGlzLnNyKCkuZ3JvdXBCeShvU2NvcGUuRW50aXR5Q2xhc3NlcywgJ0VudGl0eU1vZHVsZScpLm1hcChnID0+ICh7CgkJCWxhYmVsOiAoZy5rZXkgPyBnLmtleS5OYW1lIDogbnVsbCkgfHwgJ01haW4nLAoJCQlzdWJNZW51czogdGhpcy5zcigpLmdyb3VwQnkoZy52YWx1ZXMsICdHcm91cCcpLm1hcChndiA9PiAoewoJCQkJbGFiZWw6IChndi5rZXkgPyBndi5rZXkuTmFtZSA6IG51bGwpIHx8ICdNYWluJywKCQkJCXN1Yk1lbnVzOiBndi52YWx1ZXMubWFwKGd2diA9PiAoewoJCQkJCWxhYmVsOiBndnYuTmFtZSwKCQkJCQljb2RlOiAnc3RvcmUnLAoJCQkJCWRhdGE6IGd2di5OYW1lCgkJCQl9KSkKCQkJfSkpCgkJfSkpOwoJfQoKCWFzeW5jIF9sb2FkU2NvcGUoZWMsIHNjb3BlKSB7CgkJdHJ5IHsKCQkJc2NvcGUgPSB0aGlzLl9fc2NvcGVOYW1lKHNjb3BlKTsKCQkJaWYgKHNjb3BlICE9PSAnd2luZG93Jykgd2luZG93W3Njb3BlXSA9IGF3YWl0IHRoaXMuX2xvYWRFbnRpdHlDbGFzc2VzKGVjLCBzY29wZSk7CgkJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoJCQlvU2NvcGUuaHJlZnMgPSBbLi4ubmV3IFNldChbLi4ubmV3IFNldCgob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLm1hcChjID0+IGMuVG9vbHMpLmZsYXQoKSldLm1hcCh0ID0+IHRoaXMuaHJlZnMuZmlsdGVyKG4gPT4gbi50b29scyAmJiAoIW4udG9vbHMubGVuZ3RoIHx8IG4udG9vbHMuaW5kZXhPZih0KSA+PSAwKSkpLmZsYXQoKSldOwoJCQlsZXQgbWMgPSAob1Njb3BlLkVudGl0eUNsYXNzZXMgfHwgW10pLmZpbmQoYyA9PiBjLklzTWFpbik7CgkJCWlmIChtYykgewoJCQkJdGhpcy5hcGlTZXJ2ZXIgPSBhd2FpdCBuZXcgb1Njb3BlW21jLk5hbWVdKCkuX3NlcnZlcih7CgkJCQkJbG9hZFRvb2xzOiB0cnVlLAoJCQkJCWluaXRTZWxmOiB0cnVlLAoJCQkJCWluaXROb2RlOiB0cnVlCgkJCQl9KTsKCQkJfQoKCQkJY29uc29sZS5sb2coIl9sb2FkU2NvcGUoIiArIHNjb3BlICsgIik6IGRvbmUhIik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coIl9sb2FkU2NvcGUoKTogc2NoZW1hIGV4Y2VwdGlvbiAiICsgZXgpOwoJCQlpZiAoZmFsc2UgJiYgdHlwZW9mKGNvbXBhbnkpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIGF3YWl0IHRoaXMuX2dldFN0b3JlZFNjcmlwdCh7CgkJCQlOYW1lOiBjb21wYW55LlNjaGVtYSB8fCBjb21wYW55LkNvZGUsCgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlLAoJCQl9KTsKCQl9Cgl9CgoJYXN5bmMgX2xvYWRFbnRpdHlNb2R1bGUobSwgZWMpIHsKCQlpZiAoIW0pIHJldHVybjsKCQlsZXQgbU5hbWUgPSBtLkVudGl0eU1vZHVsZSA/IG0uRW50aXR5TW9kdWxlLk5hbWUgOiBtLk5hbWU7CgkJKG0uRW50aXR5TW9kdWxlIHx8IG0pLkltcG9ydHMgPSAobS5FbnRpdHlNb2R1bGUgfHwgbSkuSW1wb3J0cyB8fCAwOwoJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBMb2FkaW5nICIgKyBtTmFtZSk7CgoJCWxldCBlYXMgPSBbXTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgZWFzID0gYXdhaXQgdGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eUF0dHJpYnV0ZUZpbmRhbGwiLCBudWxsLCB7CgkJCUFjdGl2ZTogdHJ1ZSwKCQkJRW50aXR5Q2xhc3M6IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVudGl0eU1vZHVsZTogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6IG1OYW1lCgkJCQl9CgkJCX0KCQl9KTsKCgkJaWYgKGVhcy5sZW5ndGgpIHsKCQkJKHRoaXNbImdyb3VwQnkiXSA/IHRoaXMgOiB0aGlzLnNyKCkpLmdyb3VwQnkoZWFzLCAiRW50aXR5Q2xhc3MiKS5mb3JFYWNoKGcgPT4gewoJCQkJZy5rZXkuRW50aXR5QXR0cmlidXRlcyA9IGcudmFsdWVzOwoJCQkJZy5rZXkuRW50aXR5TW9kdWxlID0gbTsKCQkJCWcudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5Q2xhc3MgPSBnLmtleSk7CgoJCQkJaWYgKGVjICYmIEFycmF5LmlzQXJyYXkoZWMpKSBlYy5wdXNoKGcua2V5KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJLy8gbm90IHN0b3JlZCBpbiBFTVMsIGNoZWNrIGlmIGF2YWlsYWJsZSBhcyBhIHN0b3JlZCBzY3JpcHQKCQkJdHJ5IHsKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IGFwaVNlcnZlciIsIHRoaXMuYXBpU2VydmVyKTsKCQkJCWxldCBtRUNzID0gYXdhaXQgdGhpcy5fZ2V0U3RvcmVkU2NyaXB0KHsKCQkJCQlOYW1lOiBtTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCX0pOwoJCQkJbUVDcyA9IG1FQ3MuZmlsdGVyKGMgPT4gKG0uRXhjbHVkZXMgfHwgW10pLmluZGV4T2YoYy5OYW1lKSA8IDApOwoKCQkJCW1FQ3MuZmlsdGVyKGMgPT4gIWMuRW50aXR5TW9kdWxlKS5mb3JFYWNoKGMgPT4gewoJCQkJCWMuRW50aXR5UnVsZXMgPSBjLkVudGl0eVJ1bGVzIHx8IFtdOwoJCQkJCWMuRW50aXR5UnVsZXMucHVzaCguLi4oKChtLkVudGl0eVJ1bGVzIHx8IHt9KVtjLk5hbWVdKSB8fCBbXSkpOwoJCQkJCWMuRW50aXR5TW9kdWxlID0gbTsKCQkJCX0pOwoJCQkJZGVsZXRlIG0uRW50aXR5UnVsZXM7CgkJCQllYy5wdXNoKC4uLm1FQ3MpOwoKCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IENsYXNzZXMiLCBlYy5tYXAoYyA9PiBjLkVudGl0eU1vZHVsZSkpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBkbSBvZiBlYy5maWx0ZXIoYyA9PiAhYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmICFjLkVudGl0eU1vZHVsZS5JZ25vcmUgJiYgYy5FbnRpdHlNb2R1bGUuTmFtZSAhPSBtTmFtZSkpIHsKCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBDYW5kaWRhdGUgbW9kdWxlIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQlpZiAoZWMuZmlsdGVyKGMgPT4gYy5OYW1lICYmIGMuRW50aXR5TW9kdWxlICYmIGMuRW50aXR5TW9kdWxlLk5hbWUgPT0gZG0uRW50aXR5TW9kdWxlLk5hbWUpLmxlbmd0aCkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBNb2R1bGUgYWxyZWFkeSBsb2FkZWQhIiwgZG0uRW50aXR5TW9kdWxlKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJCS8vY29uc29sZS5sb2coIl9sb2FkRW50aXR5TW9kdWxlKCk6IHJlY3Vyc2l2ZSBtb2R1bGUiLCBkbS5FbnRpdHlNb2R1bGUpOwoJCQkJCWlmIChkbS5FbnRpdHlNb2R1bGUpIHsKCQkJCQkJKGRtLkVudGl0eU1vZHVsZSB8fCBkbSkuSW1wb3J0cysrOwoJCQkJCQlhd2FpdCB0aGlzLl9sb2FkRW50aXR5TW9kdWxlKGRtLkVudGl0eU1vZHVsZSwgZWMpOwoJCQkJCX0KCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfbG9hZEVudGl0eU1vZHVsZSgpOiBGYWlsZWQgbG9hZGluZyBtb2R1bGUgIiArIG1OYW1lLCBleCk7CgkJCX0KCQl9Cgl9CgoJX2NvcnJlY3RDbGFzc2VzKGVjLCBlYXMpIHsKCQlsZXQgb0dyb3VwZXIgPSB0aGlzWyJncm91cEJ5Il0gPyB0aGlzIDogdGhpcy5zcigpOwoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAoQXJyYXkuaXNBcnJheShlYykgJiYgIShlYXMgfHwgW10pLmxlbmd0aCkgewoJCQllYyA9IGVjLmZpbHRlcihjID0+IGMuTmFtZSAmJiAodHlwZW9mKGMuQWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgYy5BY3RpdmUpKTsKCgkJCWVjLmZvckVhY2goYyA9PiB7CgkJCQljLklkID0gYy5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQljLlBsdXJhbCA9IGMuUGx1cmFsIHx8IChjLk5hbWUgKyAicyIpOwoJCQkJYy5fVG9TdHJpbmcgPSBjLl9Ub1N0cmluZyB8fCBjLk5hbWU7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzID0gYy5FbnRpdHlBdHRyaWJ1dGVzIHx8IFtdOwoKCQkJCWxldCBfYmFzZV8gPSBjLkVudGl0eUF0dHJpYnV0ZXMuZmluZChlYSA9PiBlYS5OYW1lID09ICdfX0JBU0VfXycpOwoJCQkJaWYgKF9iYXNlXykgewoJCQkJCWxldCBwcm9wTGlzdCA9IFsnSXNVbmlxdWUnLCAnQ29kZScsICdEZWZhdWx0JywgJ1ZhbHVlJywgJ1JlcXVpcmVkJywgJ0R1cGxpY2F0ZSddOwoJCQkJCXByb3BMaXN0LmZpbHRlcihwID0+IEFycmF5LmlzQXJyYXkoX2Jhc2VfW3BdKSkuZm9yRWFjaChwID0+IF9iYXNlX1twXSA9IE9iamVjdC5hc3NpZ24oe30sIC4uLl9iYXNlX1twXS5tYXAoX2EgPT4gKHsKCQkJCQkJW19hXTogdHJ1ZQoJCQkJCX0pKSkpOwoKCQkJCQlsZXQgYXR0TGlzdCA9IFt7CgkJCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJCQlJc0Jvb2w6IHRydWUsCgkJCQkJCURlZmF1bHQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQkJCUlzQm9vbDogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogdHJ1ZSwKCQkJCQl9LCB7CgkJCQkJCU5hbWU6ICJjb2RlIiwKCQkJCQkJSXNVbmlxdWU6IHRydWUsCgkJCQkJCUlzU3RyaW5nOiB0cnVlLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm9yZGVyIiwKCQkJCQkJSXNJbnQ6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAiZGF0ZSIsCgkJCQkJCUlzRGF0ZTogdHJ1ZSwKCQkJCQkJRGVmYXVsdDogJ25ldyBEYXRlKCknLAoJCQkJCX0sIHsKCQkJCQkJTmFtZTogIm5hbWUiLAoJCQkJCQlSZXF1aXJlZDogdHJ1ZSwKCQkJCQkJSXNTdHJpbmc6IHRydWUsCgkJCQkJfSwgewoJCQkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCQkJSXNUZXh0OiB0cnVlLAoJCQkJCX1dOwoJCQkJCWF0dExpc3QuZm9yRWFjaChhID0+IHByb3BMaXN0LmZpbHRlcihwID0+IF9iYXNlX1twXSkuZm9yRWFjaChwID0+IGFbcF0gPSBfYmFzZV9bcF1bYS5OYW1lXSkpOwoJCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGF0dExpc3QuY29uY2F0KGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuTmFtZSAhPT0gIl9fQkFTRV9fIikpOwoJCQkJfQoKCQkJCVsnRW50aXR5QXR0cmlidXRlcycsICdFbnRpdHlGaWVsZHMnXS5maWx0ZXIoZVR5cGUgPT4gY1tlVHlwZV0pLmZvckVhY2goZVR5cGUgPT4gY1tlVHlwZV0uZmlsdGVyKGVhID0+IGVhLkR1cGxpY2F0ZSkuZm9yRWFjaChlYSA9PiB7CgkJCQkJbGV0IHNlYSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5EdXBsaWNhdGUuc3BsaXQoJy4nKVswXSlbZVR5cGVdLmZpbmQoc2VhID0+IHNlYS5OYW1lID09IGVhLkR1cGxpY2F0ZS5zcGxpdCgnLicpWzFdKTsKCQkJCQlPYmplY3Qua2V5cyhzZWEpLmZpbHRlcihrID0+IFsiRW50aXR5Q2xhc3MiXS5pbmRleE9mKGspIDwgMCkuZm9yRWFjaChrID0+IHsKCQkJCQkJaWYgKGsgPT0gJ0RlZmF1bHQnICYmIHR5cGVvZihzZWFba10pID09PSAnc3RyaW5nJyAmJiAhc2VhW2tdLmluZGV4T2YoJy8qKmdlbmVyYXRlZCoqLycpKSByZXR1cm47CgkJCQkJCWVhW2tdID0gc2VhW2tdOwoJCQkJCX0pOwoJCQkJfSkpOwoKCQkJCWMuVHlwZWRBdHRyaWJ1dGVzID0gYy5UeXBlZEF0dHJpYnV0ZXMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMgPSBjLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtLk1ldGhvZFBhcmFtZXRlcnMgfHwgW107CgkJCQl9KTsKCgkJCQljLkVudGl0eUF0dHJpYnV0ZXMucHVzaCguLi5jLkVudGl0eU1ldGhvZHMubWFwKG0gPT4gbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+ICFwLklkKSkuZmxhdCgpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gdHlwZW9mKGVhLkFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8IGVhLkFjdGl2ZSk7CgkJCQljLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgIWVhLkVudGl0eVR5cGUuSWQpLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IGVjLmZpbmQoX2MgPT4gX2MuTmFtZSA9PSBlYS5FbnRpdHlUeXBlLk5hbWUpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcyA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gIWVhLkVudGl0eVR5cGUgfHwgKGVhLkVudGl0eVR5cGUgJiYgZWMuZmluZChfYyA9PiBfYy5OYW1lID09IGVhLkVudGl0eVR5cGUuTmFtZSkpKTsKCQkJCWMuRW50aXR5QXR0cmlidXRlcy5mb3JFYWNoKGVhID0+IHsKCQkJCQlpZiAoIWVhLk5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coYy5OYW1lICsgIiBoYXMgQXR0cmlidXRlIHdpdGhvdXQgTmFtZSIsIGVhKTsKCQkJCQl9CgkJCQkJZWEuSWQgPSBlYS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJZWEuX1RvU3RyaW5nID0gZWEuX1RvU3RyaW5nIHx8IGVhLk5hbWU7CgkJCQkJZWEuR3JvdXAgPSBlYS5Hcm91cCB8fCAiTWFpbiI7CgkJCQkJZWEuRW50aXR5Q2xhc3MgPSBjOwoJCQkJfSk7CgoJCQkJb0dyb3VwZXIuZ3JvdXBCeShjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQkJbGV0IG0gPSBtZWEua2V5OwoKCQkJCQltLkVudGl0eUNsYXNzID0gYzsKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMgPSBtZWEudmFsdWVzLmZpbHRlcih2ID0+IG0uUmVzcG9uc2VBdHRyaWJ1dGUgJiYgdi5JZCAhPSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKTsKCQkJCQltLlJlc3BvbnNlQXR0cmlidXRlID0gbWVhLnZhbHVlcy5maW5kKHYgPT4gbS5SZXNwb25zZUF0dHJpYnV0ZSAmJiB2LklkID09IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoKCQkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQkJbS5FbnRpdHlDbGFzcy5FbnRpdHlNZXRob2RzLnB1c2gobSk7CgkJCQl9KTsKCgkJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChtID0+IHsKCQkJCQltLklkID0gbS5JZCB8fCB0aGlzLl91dWlkKCk7CgkJCQkJbS5fVG9TdHJpbmcgPSBtLl9Ub1N0cmluZyB8fCBtLk5hbWU7CgoJCQkJCW0uRW50aXR5Q2xhc3MgPSBjOwoKCQkJCQltLk1ldGhvZFBhcmFtZXRlcnMuZm9yRWFjaChwID0+IHAuRW50aXR5TWV0aG9kID0gbSk7CgkJCQkJbS5NZXRob2RQYXJhbWV0ZXJzLmZpbHRlcihwID0+IHAuRW50aXR5VHlwZSAmJiAhcC5FbnRpdHlUeXBlLklkKS5mb3JFYWNoKHAgPT4gewoJCQkJCQlwLkVudGl0eVR5cGUgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gcC5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCX0pOwoKCQkJCQlpZiAoIW0uUmVzcG9uc2VBdHRyaWJ1dGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgY29uc29sZS5sb2coIl9jb3JyZWN0Q2xhc3NlcygpOiBJbnZhbGlkIFJlc3BvbnNlQXR0cmlidXRlIGZvciBtZXRob2QgIiArIG0uTmFtZSArICIuIERlZmF1bHRpbmcgdG8gb2JqZWN0IHJldHVybiAocmV0IiArIG0uTmFtZSArICIpIik7CgkJCQkJCW0uUmVzcG9uc2VBdHRyaWJ1dGUgPSB7CgkJCQkJCQlJc09iamVjdDogdHJ1ZSwKCQkJCQkJfTsKCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lID0gbS5SZXNwb25zZUF0dHJpYnV0ZS5OYW1lIHx8ICgicmV0IiArIG0uTmFtZSk7CgoJCQkJCWlmIChtLlJlc3BvbnNlQXR0cmlidXRlICYmIG0uUmVzcG9uc2VBdHRyaWJ1dGUuRW50aXR5VHlwZSkgewoJCQkJCQlsZXQgcmEgPSBlYy5maW5kKF9jID0+IF9jLk5hbWUgPT0gbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlLk5hbWUpOwoJCQkJCQlpZiAoIXJhKSB7CgkJCQkJCQljb25zb2xlLmxvZygiX2NvcnJlY3RDbGFzc2VzKCk6IEludmFsaWQgRW50aXR5VHlwZSBOYW1lPSIgKyBtLlJlc3BvbnNlQXR0cmlidXRlLkVudGl0eVR5cGUpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlUeXBlID0gcmE7CgkJCQkJCX0KCQkJCQl9CgkJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZS5FbnRpdHlNZXRob2QgPSBtOwoJCQkJfSk7CgoJCQkJYy5FbnRpdHlNZXRob2RzID0gdGhpcy5fdW5pcXVlKGMuRW50aXR5TWV0aG9kcyk7CgoJCQkJYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5Jc1N0cmluZyAmJiAhZWEuRW50aXR5TWV0aG9kICYmICFlYS5EZWZhdWx0ICYmIChlYS5SZXF1aXJlZCB8fCBlYS5Jc1VuaXF1ZSkpLmZvckVhY2goZWEgPT4gZWEuRGVmYXVsdCA9IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIocmEgPT4gIXJhLkVudGl0eU1ldGhvZCAmJiByYS5FbnRpdHlUeXBlICYmIChyYS5Jc1VuaXF1ZSB8fCByYS5SZXF1aXJlZCkpLm1hcChyYSA9PiBgLyoqZ2VuZXJhdGVkKiovKHRoaXMuJHtyYS5OYW1lfSgpP3RoaXMuJHtyYS5OYW1lfSgpLiR7ZWEuTmFtZX0oKTonbnVsbCcpYCkuam9pbihgICsgJy0nICsgYCkpOwoJCQl9KTsKCgkJCS8qb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4uZWMubWFwKGMgPT4gYy5FbnRpdHlBdHRyaWJ1dGVzLmZpbHRlcihlYSA9PiBlYS5FbnRpdHlUeXBlICYmICFlYS5FbnRpdHlNZXRob2QpKSksICdFbnRpdHlUeXBlJykuZm9yRWFjaChjdGEgPT4gewoJCQkJZWMuZmluZChjID0+IGMuSWQgPT0gY3RhLmtleS5JZCkuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCQkJfSk7Ki8KCgkJCXJldCA9IHRoaXMuX3VuaXF1ZShlYyk7CgkJfSBlbHNlIGlmICghZWMgfHwgIUFycmF5LmlzQXJyYXkoZWMpKSB7CgkJCXZhciBjbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlDbGFzcyIpOwoKCQkJdmFyIHRDbGFzc2VzID0gb0dyb3VwZXIuZ3JvdXBCeShlYXMsICJFbnRpdHlUeXBlIik7CgkJCWNsYXNzZXMuZm9yRWFjaChjID0+IHsKCQkJCWlmICghYy5rZXkpIHsKCQkJCQljb25zb2xlLmxvZygiRW1wdHkga2V5IiwgYyk7CgkJCQl9CgkJCQljLmtleS5FbnRpdHlBdHRyaWJ1dGVzID0gYy52YWx1ZXM7CgoJCQkJdmFyIHRhcyA9IHRDbGFzc2VzLmZpbmQodGMgPT4gdGMua2V5ICYmIGMua2V5ICYmIHRjLmtleS5JZCA9PT0gYy5rZXkuSWQpOwoJCQkJLy9jLmtleS5UeXBlZEF0dHJpYnV0ZXMgPSB0YXMgPyB0YXMudmFsdWVzIDogW107CgkJCQljLmtleS5FbnRpdHlNZXRob2RzID0gYy5rZXkuRW50aXR5TWV0aG9kcyB8fCBbXTsKCQkJfSk7CgkJCXJldCA9IGNsYXNzZXMubWFwKGEgPT4gYS5rZXkpOwoKCQkJb0dyb3VwZXIuZ3JvdXBCeShlYXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eU1ldGhvZCksICJFbnRpdHlNZXRob2QiKS5mb3JFYWNoKG1lYSA9PiB7CgkJCQlsZXQgbSA9IG1lYS5rZXk7CgoJCQkJbS5FbnRpdHlDbGFzcyA9IHJldC5maW5kKGMgPT4gYy5JZCA9PSBtLkVudGl0eUNsYXNzaWQpOwoJCQkJbS5NZXRob2RQYXJhbWV0ZXJzID0gbWVhLnZhbHVlcy5maWx0ZXIodiA9PiB2LklkICE9IG0uUmVzcG9uc2VBdHRyaWJ1dGUuSWQpOwoJCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IG1lYS52YWx1ZXMuZmlsdGVyKHYgPT4gdi5JZCA9PSBtLlJlc3BvbnNlQXR0cmlidXRlLklkKVswXTsKCgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgPSBtLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMgfHwgW107CgkJCQltLkVudGl0eUNsYXNzLkVudGl0eU1ldGhvZHMucHVzaChtKTsKCQkJfSk7CgkJfQoKCQlyZXQuZm9yRWFjaChjID0+IHsKCQkJYy5FbnRpdHlNZXRob2RzID0gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklnbm9yZSk7CgkJCWMuRW50aXR5RmllbGRzID0gKGMuRW50aXR5RmllbGRzIHx8IFtdKS5maWx0ZXIoZiA9PiAhZi5JZ25vcmUpOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLkVudGl0eUNsYXNzID0gYyk7CgkJfSk7CgoJCWxldCB0ckNsYXNzID0gcmV0LmZpbmQoYyA9PiBjLk5hbWUgPT0gIlRyYW5zYWN0aW9uIiAmJiBjLkVudGl0eU1vZHVsZSk7CgkJaWYgKHRyQ2xhc3MpIHJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlNZXRob2RzLmZpbHRlcihtID0+ICFtLklzU3luYyAmJiAhbS5SZXNwb25zZU1ldGhvZCkuZm9yRWFjaChtID0+IHsKCQkJbS5SZXNwb25zZU1ldGhvZCA9IHsKCQkJCU5hbWU6IG0uTmFtZSArICJSZXNwb25zZSIsCgkJCQlNZXRob2RQYXJhbWV0ZXJzOiBbewoJCQkJCU5hbWU6ICJ0cmFuc2FjdGlvbiIsCgkJCQkJRW50aXR5VHlwZTogdHJDbGFzcwoJCQkJfV0sCgkJCQlTY3JpcHQ6IGByZXR1cm4gYXdhaXQgdHJhbnNhY3Rpb24uY2xhc3MoIiR7Yy5OYW1lfSIpLm1ldGhvZCgiJHttLk5hbWV9IikuYXN5bmNSZXN1bHQoIiR7bS5SZXNwb25zZUF0dHJpYnV0ZT8uRW50aXR5VHlwZT8uTmFtZT8ucmVwbGFjZSgvIC9nLCAnXycpfSIsICR7bS5SZXNwb25zZUF0dHJpYnV0ZS5Jc0FycmF5PyJ0cnVlIjoiZmFsc2UifSlgLAoJCQkJUmVzcG9uc2VBdHRyaWJ1dGU6IG0uUmVzcG9uc2VBdHRyaWJ1dGUsCgkJCX07CgkJCWMuRW50aXR5TWV0aG9kcy5wdXNoKG0uUmVzcG9uc2VNZXRob2QpOwoKCQkJbS5SZXNwb25zZUF0dHJpYnV0ZSA9IHsKCQkJCU5hbWU6IGByZXQke20uTmFtZX1gLAoJCQkJRW50aXR5VHlwZTogdHJDbGFzcywKCQkJfQoJCX0pKTsKCgkJb0dyb3VwZXIuZ3JvdXBCeShbXS5jb25jYXQoLi4ucmV0Lm1hcChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5maWx0ZXIoZWEgPT4gZWEuRW50aXR5VHlwZSAmJiAhZWEuRW50aXR5TWV0aG9kKSkpLCAnRW50aXR5VHlwZScpLmZvckVhY2goY3RhID0+IHsKCQkJbGV0IF9jID0gcmV0LmZpbmQoYyA9PiBjLklkID09IGN0YS5rZXkuSWQgfHwgKGMuTmFtZSA9PSBjdGEua2V5Lk5hbWUgLyomJiBjLkVudGl0eU1vZHVsZSAmJiBjdGEua2V5LkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5OYW1lID09IGN0YS5rZXkuRW50aXR5TW9kdWxlLk5hbWUqLyApKTsKCQkJaWYgKCFfYykgewoJCQkJY29uc29sZS5sb2coIk5vIGNsYXNzIGZvdW5kIHRvIG1hdGNoICIgKyBjdGEua2V5Lk5hbWUpOwoJCQl9IGVsc2UgewoJCQkJX2MuVHlwZWRBdHRyaWJ1dGVzID0gY3RhLnZhbHVlczsKCgkJCQljdGEudmFsdWVzLmZvckVhY2goZWEgPT4gZWEuRW50aXR5VHlwZSA9IF9jKTsgLy8/Pz8KCQkJfQoJCX0pOwoKCQlpZiAocmV0ICYmIHJldC5sZW5ndGggJiYgIXJldC5maW5kKGMgPT4gYy5Jc01haW4pKSB7CgkJCXJldFswXS5Jc01haW4gPSB0cnVlOwoJCQlyZXRbMF0uT3JkZXIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKCQl9CgoJCWxldCBjUmFuayA9IChjLCBzb3VyY2VzID0gW10pID0+IHsKCQkJc291cmNlcy5wdXNoKGMuTmFtZSk7CgkJCXJldHVybiBjLkVudGl0eUF0dHJpYnV0ZXMuZmlsdGVyKGVhID0+IGVhLkVudGl0eVR5cGUgJiYgZWEuRW50aXR5VHlwZSAhPT0gYyAmJiBzb3VyY2VzLmluZGV4T2YoZWEuRW50aXR5VHlwZS5OYW1lKSA8IDApLm1hcChlYSA9PiBjUmFuayhlYS5FbnRpdHlUeXBlLCBzb3VyY2VzKSkuY29uY2F0KFsxXSkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpOwoJCX07CgoJCS8vIG9yZGVyIGJ5IG9yZGVyCgkJcmV0LmZvckVhY2goYyA9PiB7CgkJCWMuT3JkZXIgPSBjLk9yZGVyIHx8IDA7CgkJCWMuUmFuayA9IGNSYW5rKGMpOwoJCQljLkVudGl0eUF0dHJpYnV0ZXMuZm9yRWFjaChlYSA9PiBlYS5PcmRlciA9IGVhLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eU1ldGhvZHMuZm9yRWFjaChlbSA9PiBlbS5PcmRlciA9IGVtLk9yZGVyIHx8IDApOwoJCQljLkVudGl0eUZpZWxkcy5mb3JFYWNoKGVmID0+IGVmLk9yZGVyID0gZWYuT3JkZXIgfHwgMCk7CgkJfSk7CgkJcmV0LnNvcnQoKGEsIGIpID0+IGEuT3JkZXIgLSBiLk9yZGVyKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5QXR0cmlidXRlcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoJCXJldC5mb3JFYWNoKGMgPT4gYy5FbnRpdHlGaWVsZHMuc29ydCgoYSwgYikgPT4gYS5PcmRlciAtIGIuT3JkZXIpKTsKCQlyZXQuZm9yRWFjaChjID0+IGMuRW50aXR5TWV0aG9kcy5zb3J0KChhLCBiKSA9PiBhLk9yZGVyIC0gYi5PcmRlcikpOwoKCQlpZiAocmV0Lmxlbmd0aCkgewoJCQlbJ0RlYnVnJywgJ0NvbmZpZycsICdUZXN0JywgJ1Rvb2xzJywgJ01hcHBpbmdzJywgJ1JvdXRpbmcnLCAnVmFsaWRhdG9ycycsICdNZXRob2RSdWxlcycsICdFbnRpdHlSdWxlcyddLmZvckVhY2goYSA9PiB7CgkJCQlsZXQgbWNBID0gcmV0WzBdW2FdOwoJCQkJZGVsZXRlIHJldFswXVthXTsKCQkJCXJldC5mb3JFYWNoKGMgPT4gewoJCQkJCWNbYV0gPSBjW2FdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LltjLk5hbWVdIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0/LlsnKiddIHx8IGMuRW50aXR5TW9kdWxlPy5bYV0gfHwgbWNBPy5bYy5OYW1lXSB8fCBtY0E/LlsnKiddIHx8IG1jQSB8fCB7fTsKCQkJCQlpZiAoYS5lbmRzV2l0aCgncycpICYmICFBcnJheS5pc0FycmF5KGNbYV0pKSBjW2FdID0gT2JqZWN0LmtleXMoY1thXSk7CgkJCQl9KTsKCQkJfSk7CgoJCQlyZXQuZmlsdGVyKGMgPT4gIWMuSXNNYWluKS5mb3JFYWNoKGMgPT4gYy5Db25maWcgPSBPYmplY3QuYXNzaWduKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmV0LmZpbmQoX2MgPT4gX2MuSXNNYWluKS5Db25maWcpKSwgYy5Db25maWcpKTsKCgkJCXJldC5maWx0ZXIoYyA9PiBjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5FbnRpdHlNb2R1bGUpLmZvckVhY2goYyA9PiBjLkVudGl0eU1vZHVsZSA9IGMuRW50aXR5TW9kdWxlLkVudGl0eU1vZHVsZSk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCV9fc2NvcGVOYW1lKHNjb3BlKSB7CgkJcmV0dXJuIHNjb3BlIHx8ICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnID8gY29tcGFueS5TY29wZSA6IG51bGwpIHx8ICJ3aW5kb3ciOwoJfQoKCV9fc2NvcGUoc2NvcGUpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCXJldHVybiB0aGlzLnNyKCkuXyA/IHRoaXMuc3IoKS5fX3Njb3BlKHNjb3BlKSA6IHRoaXM7Cgl9CgoJYXN5bmMgX2J1aWxkQ2xhc3NlcyhyZXQsIHNjb3BlLCBlYXMpIHsKCQlzY29wZSA9IHRoaXMuX19zY29wZU5hbWUoc2NvcGUpOwoJCWxldCByU2NvcGUgPSB7CgkJCUVudGl0eUNsYXNzZXM6IHJldCwKCQkJRW50aXR5QXR0cmlidXRlczogZWFzLAoJCX07CgoJCXJTY29wZS5uTmFtZSA9IHJTY29wZS5uTmFtZSB8fCAoKG4sIGJBbGlhcykgPT4gKChiQWxpYXMgJiYgbi5FbnRpdHlNb2R1bGU/LkFsaWFzKSA/IG4uRW50aXR5TW9kdWxlPy5BbGlhcyArICcuJyA6ICcnKSArIG4/Lk5hbWU/LnJlcGxhY2UoLyAvZywgJ18nKSk7CgkJclNjb3BlLm5Db2RlID0gclNjb3BlLm5Db2RlIHx8IChuID0+IHsKCQkJaWYgKCFuKSByZXR1cm4gIiI7CgkJCWxldCByZXQgPSBuLk5hbWUgfHwgIiI7CgkJCWlmICh0eXBlb2Yobi5Db2RlKSA9PT0gInN0cmluZyIpIHsKCQkJCXJldCA9IG4uQ29kZTsKCQkJfSBlbHNlIGlmICh0eXBlb2Yobi5Db2RlKSA9PT0gIm9iamVjdCIpIHsKCQkJCWxldCBvID0gKG4uRW50aXR5Q2xhc3MgfHwgbik7CgkJCQlpZiAoby5Ub29sKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbC5OYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKG8uVG9vbHMubGVuZ3RoICYmIG8uVG9vbHNbMF0gJiYgby5Ub29sc1swXS50eXBlKSB7CgkJCQkJcmV0ID0gbi5Db2RlW28uVG9vbHNbMF0udHlwZS5uYW1lXSB8fCBuLk5hbWU7CgkJCQl9IGVsc2UgaWYgKE9iamVjdC5rZXlzKG4uQ29kZSkubGVuZ3RoKSB7CgkJCQkJcmV0ID0gbi5Db2RlW09iamVjdC5rZXlzKG4uQ29kZSlbMF1dOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuLk5hbWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJldC5yZXBsYWNlKC8gL2csICdfJyk7CgkJfSk7CgoJCWxldCBodG1sID0gYXdhaXQgdGhpcy5yZXF1aXJlKCJFbnRpdHlDbGFzcyIpOwoJCWZvciBhd2FpdCAoY29uc3QgbSBvZiBbLi4uKGh0bWwubWF0Y2hBbGwoLyg8JT0pLltcd1wtLl0rW1wuXShqcykoJT4pL2dtKSldKSBodG1sID0gaHRtbC5yZXBsYWNlKG1bMF0sIGF3YWl0IHRoaXMucmVxdWlyZShtWzBdLnJlcGxhY2UoIjwlPSIsICIiKS5yZXBsYWNlKCIlPiIsICIiKS5yZXBsYWNlKCcuanMnLCAnJykpKTsKCgkJdGhpcy5zdGVwKCk7CgoJCWxldCBfY29kZSA9ICcnOwoJCWZvciBhd2FpdCAoY29uc3QgYyBvZiByZXQpIHsKCQkJbGV0IGNvZGUgPSAiIjsKCQkJdHJ5IHsKCQkJCWNvZGUgPSB0aGlzLl9pbmplY3QoaHRtbCwgewoJCQkJCWFyQ2xhc3NlczogcmV0LAoJCQkJCWM6IGMsCgkJCQkJc2NvcGU6IHNjb3BlLAoJCQkJCW5OYW1lOiByU2NvcGUubk5hbWUsCgkJCQkJbkNvZGU6IHJTY29wZS5uQ29kZSwKCQkJCX0pICsgJ1xuJyArIHJTY29wZS5uTmFtZShjKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKCJfYnVpbGRDbGFzc2VzKCk6IF9pbmplY3QgZXhjZXB0aW9uOiAiICsgZXgpOwoJCQl9CgoJCQljb2RlID0gdGhpcy5fYmVhdXRpZnkoY29kZSwgImphdmFzY3JpcHQiKTsKCgkJCV9jb2RlID0gY29kZSArIGAKJHtzY29wZT8nd2luZG93Licrc2NvcGU6J3dpbmRvdyd9LiR7clNjb3BlLm5Db2RlKGMuRW50aXR5TW9kdWxlKXx8J3gnfS4ke3JTY29wZS5uTmFtZShjKX0gPSAke3JTY29wZS5uTmFtZShjKX07CmA7CgoJCQlsZXQgYWxpYXMgPSByU2NvcGU7CgkJCWlmIChjLkVudGl0eU1vZHVsZSAmJiBjLkVudGl0eU1vZHVsZS5BbGlhcykgYy5FbnRpdHlNb2R1bGUuQWxpYXMuc3BsaXQoJy4nKS5maWx0ZXIoYSA9PiBhKS5mb3JFYWNoKGEgPT4gYWxpYXMgPSAoYWxpYXNbYV0gPSBhbGlhc1thXSB8fCB7fSkpOwoKCQkJYWxpYXNbclNjb3BlLm5OYW1lKGMpXSA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KGNvZGUpOwoJCX0KCgkJcmV0dXJuIHJTY29wZTsKCX0KCglzcigpIHsKCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc3IpID8gd2luZG93LnNyIDogdGhpczsKCX0KCglfX3RpbWUobmFtZSA9ICJnbG9iYWwiKSB7CgkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZSgpOwoJCWlmICghb1Njb3BlKSByZXR1cm4gZDsKCQlvU2NvcGUuX190aW1lcyA9IG9TY29wZS5fX3RpbWVzIHx8IHt9OwoJCW9TY29wZS5fX3RpbWVzW25hbWVdID0gb1Njb3BlLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIG9TY29wZS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQlvU2NvcGUuX190aW1lc1tuYW1lXSA9IGQ7CgkJcmV0dXJuIChzICsgJ3MnKTsKCX0KCglfaW5jbHVkZShfaHJlZikgewoJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCX0KCglfY3NzKGxpbmssIHJlbCA9ICJzdHlsZXNoZWV0IikgewoJCWNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7CgkJbC5zZXRBdHRyaWJ1dGUoJ3JlbCcsIHJlbCk7CgkJbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBsaW5rKTsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGwpOwoJfQoKCXRvUERGKGZpbGVuYW1lLCBwYWdlcykgewoJCWlmICghcGFnZXMgfHwgIXBhZ2VzLmxlbmd0aCkgcGFnZXMgPSBbZG9jdW1lbnQuYm9keV07CgkJbGV0IHBkZiA9IG5ldyBqc1BERigncCcsICdtbScsICdhNCcpOwoJCXZhciBjYWxscyA9ICQubWFwKHBhZ2VzLCBwID0+IGh0bWwyY2FudmFzKHAsIHsKCQkJc2NhbGU6IDEKCQl9KSk7CgkJJC53aGVuKC4uLmNhbGxzKS50aGVuKCguLi5hckNhbnZhcykgPT4gewoJCQkkLmVhY2goYXJDYW52YXMsIChpLCBjKSA9PiB7CgkJCQlpZiAoaSkgcGRmLmFkZFBhZ2UoKTsKCQkJCXBkZi5hZGRJbWFnZShjLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyksICdQTkcnLCAwLCAwLCAyMDAsIDIwMCk7CgkJCX0pOwoJCQlwZGYuc2F2ZShmaWxlbmFtZSk7CgkJfSk7Cgl9CgoJc3RlcCgpIHsKCQl0cnkgewoJCQlpZiAoIWxvYWRpbmcubG9hZGVyKSB7CgkJCQkkKCJib2R5IikuYXBwZW5kKCI8Y2VudGVyPjxkaXYgaWQ9J3RvcExvYWRlcic+PC9kaXY+PC9jZW50ZXI+Iik7CgkJCQlsb2FkaW5nLmxvYWRlciA9ICQoIiN0b3BMb2FkZXIiKS5wZXJjZW50YWdlTG9hZGVyKHsKCQkJCQl3aWR0aDogMjU2LAoJCQkJCWhlaWdodDogMjU2LAoJCQkJCWNvbnRyb2xsYWJsZTogdHJ1ZSwKCQkJCQlwcm9ncmVzczogMCwKCQkJCQlvblByb2dyZXNzVXBkYXRlOiAodmFsKSA9PiB7CgkJCQkJCWxvYWRpbmcubG9hZGVyLnNldFZhbHVlKE1hdGgucm91bmQodmFsICogMTAwLjApKTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJLypjb25zb2xlLmxvZygiJUxPQURFUjogIiArIGUubWVzc2FnZSk7Ki8KCQl9CgkJdHJ5IHsKCQkJbG9hZGluZy5sb2FkZXIuc2V0UHJvZ3Jlc3MoKGxvYWRpbmcucG9zaXRpb24rKykgLyBsb2FkaW5nLnN0ZXBzKTsKCQkJLy9sb2FkaW5nLmxvYWRlci5zZXRWYWx1ZSgxMDAqbG9hZGluZy5wb3NpdGlvbi9sb2FkaW5nLnN0ZXBzICsgJyUnKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8qY29uc29sZS5sb2coIiVMT0FERVI6ICIgKyBlLm1lc3NhZ2UpOyovCgkJfQoJfQoKCV9hcHBseShvLCBmbiwgc2NvcGUgPSBbXSkgewoJCWZvciAobGV0IGkgaW4gbykgewoJCQlmbi5hcHBseSh0aGlzLCBbaSwgb1tpXSwgc2NvcGVdKTsKCQkJaWYgKG9baV0gIT09IG51bGwgJiYgdHlwZW9mIG9baV0gPT09ICJvYmplY3QiKSB7CgkJCQl0aGlzLl9hcHBseShvW2ldLCBmbiwgc2NvcGUuY29uY2F0KGkpKTsKCQkJfQoJCX0KCX0KCglzZXRVUkwodXJsKSB7CgkJaWYgKHRoaXMuYWxsRGF0YS5wYWdlKSBoaXN0b3J5LnB1c2hTdGF0ZSh7CgkJCV9jb2RlOiB0aGlzLmFsbERhdGEucGFnZS5fY29kZQoJCX0sIHRoaXMuYWxsRGF0YS5wYWdlLl90aXRsZSwgdGhpcy50b0hhc2goKSk7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gPT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb24gJiYgdHlwZW9mKHVybCkgPT09ICJvYmplY3QiKSB7CgkJCS8vIGluc2lkZSBhIHdpbmRvdwoJCQlsZXQgc1VSTCA9ICIiOwoJCQl0aGlzLl9hcHBseSh1cmwsIChrZXksIHZhbHVlLCBzY29wZSkgPT4gc1VSTCArPSAodHlwZW9mKHZhbHVlKSAhPT0gIm9iamVjdCIgPyAoc2NvcGUubWFwKHggPT4geCArICIuIikuam9pbignJykgKyBrZXkgKyAiPSIgKyB2YWx1ZSArICImIikgOiAiIikpOwoJCQl1cmwgPSBzVVJMOwoJCQkvL2NvbnNvbGUubG9nKCJzZXRVUkw6IHVybCIsIHVybCkKCQl9IGVsc2UgaWYgKHR5cGVvZih1cmwpID09PSAib2JqZWN0IikgewoJCQl0aGlzLlJlbmRlclBhZ2UoewoJCQkJX2NvZGU6IHVybC5wYWdlCgkJCX0sIHVybCk7CgkJfQoJCWxvY2F0aW9uLmhhc2ggPSAiIyIgKyB1cmw7Cgl9CgoJZnJvbUhhc2goKSB7CgkJdGhpcy5oYXNoID0ge307CgkJKGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2gpLnJlcGxhY2UoLyMvZywgIiYiKS5yZXBsYWNlKC9cPy9nLCAnJykuc3BsaXQoIiYiKS5maWx0ZXIoZSA9PiBlKS5mb3JFYWNoKGUgPT4gewoJCQl0cnkgewoJCQkJdGhpcy5oYXNoW2Uuc3BsaXQoIj0iKVswXV0gPSBlLnNwbGl0KCI9IilbMV07CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCX0pOwoJCXJldHVybiB0aGlzLmhhc2g7Cgl9CgoJdG9IYXNoKCkgewoJCXZhciByZXQgPSAiIyI7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmhhc2gpIHsKCQkJcmV0ICs9IHAgKyAiPSIgKyB0aGlzLmhhc2hbcF07CgkJfQoJCXJldHVybiByZXQ7Cgl9CgoJc3RyaXBIVE1MKGRpcnR5U3RyaW5nKSB7CgkJcmV0dXJuIGRpcnR5U3RyaW5nLnJlcGxhY2UoLzxbXj5dKj4vZywgIiIpOwoJfQoKCUVxdWFscyhhLCBiKSB7CgkJLy8gbnVsbCBhbmQgdW5kZWZpbmVkIGFyZSB0cmVhdGVkIGFzIHRoZSBzYW1lOiBlcXVhbAoJCXZhciBfYSA9IGEgfHwgbnVsbDsKCQl2YXIgX2IgPSBiIHx8IG51bGw7CgkJaWYgKF9hID09PSBfYikgcmV0dXJuIHRydWU7CgkJaWYgKCFfYSB8fCAhX2IpIHJldHVybiBmYWxzZTsgLy8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3QKCQkvLyBpZih0eXBlb2YgYSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGIgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7IC8vIG9uZSBpcyB1bmRlZmluZWQKCQlpZiAoKF9hLnRvRW50aXR5T2JqZWN0ICYmICFfYi50b0VudGl0eU9iamVjdCkgfHwgKF9iLnRvRW50aXR5T2JqZWN0ICYmICFfYS50b0VudGl0eU9iamVjdCkpIHJldHVybiBmYWxzZTsgLy8gYm90aCBzaG91bGQgYmUgZWl0aGVyIEVNUyBvciBub24gRU1TIG9iamVjdHMKCQkvL2NvbnNvbGUubG9nKCJFcXVhbHM6IGF0IHRoaXMgcG9pbnQ6IGE9IitfYSsiLCBiPSIrX2IpOwoJCS8vIHNhZmU6IGJvdGggZWl0aGVyIEVNUyBvciBub24gRU1TCgkJaWYgKF9hLnRvRW50aXR5T2JqZWN0KSByZXR1cm4gX2EuRXF1YWxzKF9iKTsgLy8gRU1TIGJ1bmRlbHMgdGhlIEVxdWFscyBmdW5jdGlvbnMKCQlpZiAoX2EuSWQgJiYgX2IuSWQgJiYgX2EuSWQgPT0gX2IuSWQpIHJldHVybiB0cnVlOwoJCXJldHVybiBmYWxzZTsKCX0KCglidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBuUGFyZW50KSB7CgkJLy8gZmluZCB0aGUgY2hpbGRyZW4gb2YgdGhlIG5QYXJlbnQgbm9kZQoJCXZhciBjaGlsZHJlbiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJOb2Rlcy5sZW5ndGg7IGkrKykgewoJCQl0cnkgewoJCQkJaWYgKG5QYXJlbnQpIHsKCQkJCQl0cnkgewoJCQkJCQkvL2NvbnNvbGUubG9nKCJOb2RlOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSArICIsIFBhcmVudDogIiArIG5QYXJlbnQuX25hbWUgKyAiLCBFcXVhbDogIiArIChhck5vZGVzW2ldW3NQYXJlbnRdLkVxdWFscyhuUGFyZW50KSkpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJLy9jb25zb2xlLmxvZygiV0hBVD8gIiArIG5QYXJlbnQuX25hbWUgKyAiLCAiICsgZS5tZXNzYWdlKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoYXJOb2Rlc1tpXVtzUGFyZW50XSA9PSBuUGFyZW50IHx8IChhck5vZGVzW2ldW3NQYXJlbnRdICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzICYmIGFyTm9kZXNbaV1bc1BhcmVudF0uRXF1YWxzKG5QYXJlbnQpKSB8fCAoYXJOb2Rlc1tpXVtzUGFyZW50XS5JZCAmJiBhck5vZGVzW2ldW3NQYXJlbnRdLklkID09IG5QYXJlbnQuSWQpKSB7CgkJCQkJLy9pZihuUGFyZW50KSBjb25zb2xlLmxvZygiZm91bmQgY2hpbGQgb2YgIiArIG5QYXJlbnQuX25hbWUgKyAiOiAiICsgYXJOb2Rlc1tpXS5fbmFtZSk7CgkJCQkJLy9pZighblBhcmVudCkgY29uc29sZS5sb2coImZvdW5kIHJvb3Qgbm9kZSA6ICIgKyBhck5vZGVzW2ldLl9uYW1lKTsKCQkJCQljaGlsZHJlbltjaGlsZHJlbi5sZW5ndGhdID0gYXJOb2Rlc1tpXTsKCQkJCX0KCQkJfSBjYXRjaCAoZSkgewoJCQkJLy9jb25zb2xlLmxvZygiaT0iICsgaSArICIsICIgKyBlLm1lc3NhZ2UpOwoJCQl9CgkJfQoJCWlmIChuUGFyZW50KSBuUGFyZW50W3NDaGlsZHJlbl0gPSBjaGlsZHJlbjsKCQlmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKCQkJLy9jb25zb2xlLmxvZygiQnVpbGRpbmcgc3VidHJlZSIpOwoJCQlidWlsZFRyZWUoYXJOb2Rlcywgc1BhcmVudCwgc0NoaWxkcmVuLCBjaGlsZHJlbltpXSk7CgkJfQoJfQoKCW0oKSB7CgkJLy9yZXR1cm4gKHRoaXMuaXNNb2JpbGUoKSA/ICIiIDogIi9kIik7CgkJcmV0dXJuICIvZCI7Cgl9CgoJaXNNb2JpbGUoKSB7CgkJLy9yZXR1cm4gdGhpcy5zcigpLmlzTW9iaWxlOwoJCXRyeSB7CgkJCWlmIChjb21wYW55LlJlc3BvbnNpdmUpIHJldHVybiBmYWxzZTsKCQl9IGNhdGNoIChlKSB7fQoJCXZhciBjaGVjayA9IGZhbHNlOwoJCSgoYSwgYikgPT4gewoJCQlpZiAoLyhhbmRyb2lkfGJiXGQrfG1lZWdvKS4rbW9iaWxlfGF2YW50Z298YmFkYVwvfGJsYWNrYmVycnl8YmxhemVyfGNvbXBhbHxlbGFpbmV8ZmVubmVjfGhpcHRvcHxpZW1vYmlsZXxpcChob25lfG9kKXxpcmlzfGtpbmRsZXxsZ2UgfG1hZW1vfG1pZHB8bW1wfG1vYmlsZS4rZmlyZWZveHxuZXRmcm9udHxvcGVyYSBtKG9ifGluKWl8cGFsbSggb3MpP3xwaG9uZXxwKGl4aXxyZSlcL3xwbHVja2VyfHBvY2tldHxwc3B8c2VyaWVzKDR8NikwfHN5bWJpYW58dHJlb3x1cFwuKGJyb3dzZXJ8bGluayl8dm9kYWZvbmV8d2FwfHdpbmRvd3MgY2V8eGRhfHhpaW5vL2kudGVzdChhKSB8fCAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pLnRlc3QoYS5zdWJzdHIoMCwgNCkpKSBjaGVjayA9IHRydWUKCQl9KShuYXZpZ2F0b3IudXNlckFnZW50IHx8IG5hdmlnYXRvci52ZW5kb3IgfHwgd2luZG93Lm9wZXJhKTsKCQlyZXR1cm4gY2hlY2s7Cgl9CgoJX2Vycm9yKG1zZywgZGVsYXkpIHsKCQlpZiAodHlwZW9mKG5vdHkpICE9PSAidW5kZWZpbmVkIikgewoJCQlub3R5KHsKCQkJCXRleHQ6IG1zZywKCQkJCXR5cGU6ICdlcnJvcicsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdFcnJvcic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCV9hbGVydChtc2csIGRlbGF5KSB7CgkJaWYgKHR5cGVvZihub3R5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbm90eSh7CgkJCQl0ZXh0OiBtc2csCgkJCQl0eXBlOiAnc3VjY2VzcycsCgkJCQl0aW1lb3V0OiBkZWxheQoJCQl9KTsKCQl9IGVsc2UgewoJCQkvLyB0aGUgZGVmYXVsdAoJCQkkKCI8ZGl2IHRpdGxlPSdJbmZvcm1hdGlvbic+PHA+IiArIG1zZyArICI8L3A+PC9kaXY+IikuZGlhbG9nKCk7CgkJfQoJfQoKCW15UmVwbGFjZShzLCBhckZyb20sIGFyVG8pIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyRnJvbS5sZW5ndGg7IGkrKykgewoJCQlzID0gcy5yZXBsYWNlKG5ldyBSZWdFeHAoYXJGcm9tW2ldLCAnZycpLCBhclRvW2ldKTsKCQl9CgkJcmV0dXJuIHM7Cgl9CgoJX2luamVjdChodG1sLCBkYXRhLCBlbmdpbmUpIHsKCQlpZiAoIWh0bWwpIHJldHVybiBodG1sOwoJCWlmICh0eXBlb2YoaHRtbCkgPT09ICdvYmplY3QnKSB7CgkJCXJldHVybiAkLmV4dGVuZCh7fSwgLi4uT2JqZWN0LmtleXMoaHRtbCkubWFwKGsgPT4gKHsKCQkJCVtrXTogdGhpcy5faW5qZWN0KGh0bWxba10sIGRhdGEpCgkJCX0pKSk7CgkJfQoJCWlmICh0eXBlb2YoaHRtbCkgIT09ICdzdHJpbmcnKSByZXR1cm4gaHRtbDsKCgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihqc29uYXRhKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGpzb25hdGEoaHRtbCkuZXZhbHVhdGUoZGF0YSk7CgkJCQl9IGNhdGNoIChfZXgpIHt9CgkJCX0KCgkJCWlmICh0eXBlb2YgRUpTICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnRUpTJykpIHsKCQkJCXJldHVybiBuZXcgRUpTKHsKCQkJCQl0ZXh0OiBodG1sCgkJCQl9KS5yZW5kZXIoZGF0YSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGRvVCAhPT0gJ3VuZGVmaW5lZCcgJiYgKHR5cGVvZihlbmdpbmUpID09PSAndW5kZWZpbmVkJyB8fCBlbmdpbmUgPT0gJ2RvVCcpKSB7CgkJCQlyZXR1cm4gZG9ULnRlbXBsYXRlKGh0bWwpKGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBfID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBfLnRlbXBsYXRlICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAndW5kZXJzY29yZScpKSB7CgkJCQlyZXR1cm4gXy50ZW1wbGF0ZShodG1sKShkYXRhKTsKCQkJfSBlbHNlIGlmICh0eXBlb2YgTXVzdGFjaGUgIT09ICd1bmRlZmluZWQnICYmICh0eXBlb2YoZW5naW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5naW5lID09ICdNdXN0YWNoZScpKSB7CgkJCQlyZXR1cm4gTXVzdGFjaGUucmVuZGVyKGh0bWwsIGRhdGEpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBIYW5kbGViYXJzICE9PSAndW5kZWZpbmVkJyAmJiAodHlwZW9mKGVuZ2luZSkgPT09ICd1bmRlZmluZWQnIHx8IGVuZ2luZSA9PSAnSGFuZGxlYmFycycpKSB7CgkJCQlyZXR1cm4gSGFuZGxlYmFycy5jb21waWxlKGh0bWwpLnRlbXBsYXRlKGRhdGEpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIGh0bWw7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZygiX2luamVjdCBFeGNlcHRpb246ICIsIGV4LCBkYXRhIC8qLCBodG1sKi8gKTsKCQkJcmV0dXJuIGh0bWw7CgkJfQoJfQoKCWFzeW5jIGVuZChmQ2FsbEJhY2ssIGRhdGEpIHsKCQlpZiAodGhpcy5lbmRDYWxsZWQpIHJldHVybjsKCQl0aGlzLmVuZENhbGxlZCA9IHRydWU7CgkJaWYgKCFkYXRhKSBkYXRhID0gd2luZG93LnBhZ2UuZGF0YSB8fCB7fTsKCQkvL2RhdGEucGFnZXMgPSB0aGlzLmFsbERhdGEucGFnZXM7CgkJLy9kYXRhLnBhZ2UgPSB0aGlzLmFsbERhdGEucGFnZTsKCQlhd2FpdCB0aGlzLmRvQ2FsbHMoKTsKCQlpZiAoZkNhbGxCYWNrKSB7CgkJCWF3YWl0IGZDYWxsQmFjaygpOwoJCX0KCQkvL2NvbnNvbGUubG9nKCJlbmQoKSB3aXRoIGRhdGEiLCBkYXRhKTsKCQl2YXIgc0hUTUwgPSB0aGlzLl9pbmplY3QodGhpcy5hbGxIVE1MLCBkYXRhKTsKCQl2YXIgb0NvbnRlbnQgPSAkKCdib2R5Jyk7CgkJaWYgKCF0aGlzLmlzTW9iaWxlKCkpIHsKCQkJb0NvbnRlbnQuaHRtbChzSFRNTCk7CgkJCS8vb0NvbnRlbnQuaGlkZSgpOwoJCQkvL29Db250ZW50LmZhZGVJbigxMDAwKTsKCQkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcpIGRvY3VtZW50LnRpdGxlID0gY29tcGFueS5OYW1lOwoJCX0gZWxzZSB7CgkJCXZhciBvUGFnZSA9ICQoc0hUTUwpOwoJCQlvUGFnZS5hcHBlbmRUbygkLm1vYmlsZS5wYWdlQ29udGFpbmVyKTsKCQkJdmFyIG9sZCA9IHRydWU7CgkJCXRoaXMuYWxsT3B0aW9ucyA9IHRoaXMuYWxsT3B0aW9ucyB8fCB7fTsKCQkJaWYgKG9sZCkgewoJCQkJdGhpcy5hbGxPcHRpb25zLmRhdGFVcmwgPSB0aGlzLmFsbERhdGEucGFnZS5fY29kZTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuYWN0aXZlUGFnZS5yZW1vdmUoKTsKCQkJCWlmICgkLm1vYmlsZSkgJC5tb2JpbGUuY2hhbmdlUGFnZShvUGFnZSwgdGhpcy5hbGxPcHRpb25zKTsKCQkJfSBlbHNlIHsKCQkJCSQoImRvY3VtZW50IikucGFnZWNvbnRhaW5lcigiZ2V0QWN0aXZlUGFnZSIpLnJlbW92ZSgpOwoJCQkJb1BhZ2UuZW5oYW5jZVdpdGhpbigpOwoJCQkJJCgiOm1vYmlsZS1wYWdlY29udGFpbmVyIikucGFnZWNvbnRhaW5lcigiY2hhbmdlIiwgJyMnICsgZGF0YS5wYWdlLl9jb2RlLCB0aGlzLmFsbE9wdGlvbnMpOwoJCQkJY29uc29sZS5sb2coInNob3dlZCIpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuY3NzKSB7CgkJCWlmICh0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5jc3MubW9iaWxlKSB7CgkJCQljb21wYW55LmNzcy5tb2JpbGUuZm9yRWFjaChtID0+IHRoaXMuX2NzcyhtKSk7CgkJCX0gZWxzZSBpZiAoIXRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmNzcy5kZXNrdG9wKSB7CgkJCQljb21wYW55LmNzcy5kZXNrdG9wLmZvckVhY2gobSA9PiB0aGlzLl9jc3MobSkpOwoJCQl9CgkJfQoJCWlmICh0eXBlb2YoY29tcGFueSkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkuanMpIHsKCQkJaWYgKHRoaXMuaXNNb2JpbGUoKSAmJiBjb21wYW55LmpzLm1vYmlsZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wYW55LmpzLm1vYmlsZS5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5tb2JpbGVbaV0pOwoJCQl9IGVsc2UgaWYgKCF0aGlzLmlzTW9iaWxlKCkgJiYgY29tcGFueS5qcy5kZXNrdG9wKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvbXBhbnkuanMuZGVza3RvcC5sZW5ndGg7IGkrKykgJC5nZXRTY3JpcHQoY29tcGFueS5qcy5kZXNrdG9wW2ldKTsKCQkJfQoJCX0KCgkJaWYgKHR5cGVvZihSZWFjdERPTSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmICh0eXBlb2YoTWFpbkNvbXBvbmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29tcG9uZW50Jyk7CgkJCQlpZiAoIWUpIHsKCQkJCQllID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJZS5zZXRBdHRyaWJ1dGUoImlkIiwgIm1haW5Db21wb25lbnQiKTsKCQkJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGUpOwoJCQkJfQoJCQkJUmVhY3RET00ucmVuZGVyKFJlYWN0LmNyZWF0ZUVsZW1lbnQoTWFpbkNvbXBvbmVudCwgbnVsbCksIGUpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihGb3JtQ29tcG9uZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCVJlYWN0RE9NLnJlbmRlcihSZWFjdC5jcmVhdGVFbGVtZW50KEZvcm1Db21wb25lbnQsIG51bGwpLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybUNvbXBvbmVudCcpKTsKCQkJfQoJCX0KCQlpZiAod2luZG93LkRGb3JtKSB7CgkJCXRyeSB7CgkJCQl3aW5kb3cuREZvcm0uaW5pdCgpOwoJCQkJd2luZG93LkRGb3JtLnBhcnNlKCk7CgkJCQl3aW5kb3cuREZvcm0uYmluZCgpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkRGb3JtIEZ1bmN0aW9ucyBmYWlsZWQiLCBleCk7CgkJCX0KCQl9CgkJaWYgKHR5cGVvZihjb21wYW55KSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueS5PblBhZ2VMb2FkKSB7CgkJCXRyeSB7CgkJCQlhd2FpdCBjb21wYW55Lk9uUGFnZUxvYWQoZGF0YSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQljb25zb2xlLmxvZygiRnJFTUQuZW5kLk9uUGFnZUxvYWQiLCBleCk7CgkJCX0KCQl9CgoJCWlmICh3aW5kb3cuREZvcm0pIHsKCQkJYXdhaXQgd2luZG93LkRGb3JtLl9lbmQoKTsKCQl9CgoJCXRyeSB7CgkJCS8vIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIHJlLWludm9rZSBhbGwgd2luZG93IGxvYWQgZXZlbnRzLgoJCQlsZXQgbG9hZGVycyA9IChqUXVlcnkuX2RhdGEgfHwgalF1ZXJ5LmRhdGEpKHdpbmRvdywgJ2V2ZW50cycpLmxvYWQgfHwgW107CgkJCWxvYWRlcnMuZm9yRWFjaChmID0+IGYuaGFuZGxlcigpKTsKCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJfQoKCQljb25zb2xlLmxvZygiUGFnZSBMb2FkZWQ6ICIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkpOwoJfQoKCV9jKG9iaiwgZkNhbGxCYWNrLCBzTWV0aG9kLCAuLi5hclJlc3QpIHsKCQl0aGlzLl9jYWxscy5zcGxpY2UoMCwgMCwgewoJCQlDYWxsYmFjazogZkNhbGxCYWNrLAoJCQlvYmo6IG9iaiwKCQkJTmFtZTogc01ldGhvZCwKCQkJYXJnczogYXJSZXN0LAoJCX0pOwoJfQoKCWFzeW5jIGRvQ2FsbHMoKSB7CgkJdGhpcy5fY2FsbHMucmV2ZXJzZSgpOwoJCXZhciBhckNhbGxzID0gW107CgkJJC5lYWNoKHRoaXMuX2NhbGxzLCAoXywgYykgPT4gewoJCQlpZiAoYy5OYW1lKSB7CgkJCQl2YXIgYXJncyA9IFtjLm9ial07CgkJCQlpZiAoYy5hcmdzLmxlbmd0aCkgYXJncyA9IGFyZ3MuY29uY2F0KGMuYXJncyk7CgkJCQlhckNhbGxzLnB1c2godGhpcy5zcigpLl8oYy5OYW1lLCBudWxsLCAuLi5hcmdzKSk7CgkJCX0gZWxzZSBpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgewoJCQkJYXJDYWxscy5wdXNoKHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJCUVudGl0eU9iamVjdDogKGMub2JqID8gYy5vYmoudG9FbnRpdHlPYmplY3QodHJ1ZSkgOiBudWxsKQoJCQkJfSkpOwoJCQl9CgkJfSk7CgkJcmV0dXJuICQud2hlbiguLi5hckNhbGxzKS50aGVuKCguLi5yZXQpID0+IHsKCQkJJC5lYWNoKHJldCwgKGksIHIpID0+IHsKCQkJCWlmIChyICYmIHIubGVuZ3RoICYmIHJbMF0uT3JkZXIpIHsKCQkJCQlyLnNvcnQoKGEsIGIpID0+IHsKCQkJCQkJaWYgKGEuT3JkZXIgPCBiLk9yZGVyKSByZXR1cm4gLTE7CgkJCQkJCWlmIChhLk9yZGVyID4gYi5PcmRlcikgcmV0dXJuIDE7CgkJCQkJCXJldHVybiAwOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHRoaXMuX2NhbGxzW2ldLkNhbGxiYWNrKSB0aGlzLl9jYWxsc1tpXS5DYWxsYmFjayhyKTsKCQkJfSk7CgkJfSkudGhlbigoKSA9PiB7CgkJCXRoaXMuX2NhbGxzID0gW107CgkJfSk7Cgl9CgoJX28oZkNhbGxCYWNrLCBvYmopIHsKCQl0aGlzLnN0ZXAoKTsKCQlpZiAodGhpcy5zcigpLl8gJiYgd2luZG93LmJMb2NhbCkgcmV0dXJuIHRoaXMuc3IoKS5fKCJlbXNGb3JtVmFsdWVzIiwgZkNhbGxCYWNrLCB7CgkJCUVudGl0eU9iamVjdDogKChvYmogJiYgb2JqLnRvRW50aXR5T2JqZWN0KSA/IG9iai50b0VudGl0eU9iamVjdCh0cnVlKSA6IG51bGwpCgkJfSk7Cgl9CgoJcmFuZFVSTCh1cmwgPSAnJykgewoJCXJldHVybiB1cmwgKyAiP19fcmFuZD0iICsgTWF0aC5yYW5kb20oKTsKCX0KCgl0b1NldHRpbmdzKHMsIG8pIHsKCQlyZXR1cm4gczsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKCFzW2ldLlBhcmVudCkge30KCQl9Cgl9CgoJZXh0VHlwZSh2KSB7CgkJcmV0dXJuICh7CgkJCWh0bWw6ICdodG1sJywKCQkJaHRtOiAnaHRtbCcsCgkJCXhtbDogJ2h0bWwnLAoJCQlqczogJ2phdmFzY3JpcHQnLAoJCQljczogJ2NzaGFycCcsCgkJCXB5OiAncHl0aG9uJywKCQkJanN4OiAnamF2YXNjcmlwdCcsCgkJfSBbdi5tYXRjaCgvXC5bXi5cXC86Kj8iPD58XHJcbl0rJC8pWzBdLnJlcGxhY2UoJy4nLCAnJyldIHx8ICJ0ZXh0Iik7Cgl9CgoJX2xvYWRpbmcob24gPSB0cnVlLCBpbnRlcnZhbCA9IDMwMCkgewoJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWlmIChvbikgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcyh7CgkJCQkJdGl0bGU6ICdMb2FkaW5nJywKCQkJCQltc2c6ICdMb2FkaW5nIGRhdGEuLi4nLAoJCQkJCWludGVydmFsOiBpbnRlcnZhbCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJC5tZXNzYWdlci5wcm9ncmVzcygnY2xvc2UnKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgcmV0dXJuIGZhbHNlOwoJfQoKCWFzeW5jIHJlbG9hZEVkaXRvcihlZGl0b3IsIGxvYWRlciwgZkRhdGEsIG9FbGVtZW50KSB7CgkJaWYgKCFlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCkgdGhpcy5fbG9hZGluZyh0cnVlLCBvRWxlbWVudCA/IG9FbGVtZW50LmludGVydmFsIDogbnVsbCk7CgkJdHJ5IHsKCQkJbGV0IHYgPSBhd2FpdCBsb2FkZXIoZkRhdGEsIG9FbGVtZW50LCBlZGl0b3IpOwoJCQllZGl0b3Iuc2Vzc2lvbi5sYXN0TG9hZGVkID0gc3Iuc2VydmVyRGF0ZSgpOwoJCQlsZXQgZGlmZiA9IDA7CgkJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZCAmJiBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIGRpZmYgPSBNYXRoLmFicyhlZGl0b3Iuc2Vzc2lvbi5sYXN0Q2hhbmdlZC5nZXRUaW1lKCkgLSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPiAwICYmIGRpZmYgPCAxMDApIHsKCQkJCS8vIGNvbnNvbGUubG9nKCJOb3QgY2hhbmdlZCBvbiB0aGUgc2VydmVyIik7CgkJCX0gZWxzZSB7CgkJCQkvLyBjb25zb2xlLmxvZygiU2VydmVyIGNoYW5nZSwgc2V0dGluZyB2YWx1ZSIsIGRpZmYpOwoJCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQ7CgkJCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSh2KTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMuX2Vycm9yKCJVbmFibGUgdG8gTG9hZCBmaWxlLlxuIiArIGV4KTsKCQl9CgkJdGhpcy5fbG9hZGluZyhmYWxzZSk7CgoJCWlmIChlZGl0b3Iuc2Vzc2lvbi5sYXN0U2F2ZWQpIHsKCQkJLy9hd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgMC41ICogNjAgKiAxMDAwKSk7CgkJCWF3YWl0IHRoaXMuX3dhaXQoMC41ICogNjAgKiAxMDAwKTsKCQkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgkJfQoJfQoKCWFzeW5jIE9wZW5FZGl0b3IoZSwgbGFuZ3VhZ2UgPSBvID0+ICJodG1sIiwgbG9hZGVyID0gbyA9PiB7fSwgc2F2ZXIgPSAodiwgbykgPT4ge30sIGZEYXRhLCBvRWxlbWVudCkgewoJCXZhciBlZGl0b3IgPSBhY2UuZWRpdChlKTsKCQlkZWxldGUgZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQ7CgoJCWVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpOwoJCS8vYWNlLmNvbmZpZy5zZXQoJ2Jhc2VQYXRoJywgJy9ub2RlX21vZHVsZXMvYWNlLWJ1aWxkcy9zcmMtbWluLW5vY29uZmxpY3QnKTsKCQllZGl0b3Iuc2Vzc2lvbi5zZXRWYWx1ZSgnJyk7CgoJCWVkaXRvci5zZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlLycgKyBsYW5ndWFnZShmRGF0YSkpOwoJCWVkaXRvci5vbigiY2hhbmdlIiwgZSA9PiB7CgkJCWxldCBkaWZmID0gTWF0aC5hYnMoZWRpdG9yLnNlc3Npb24ubGFzdExvYWRlZC5nZXRUaW1lKCkgLSBzci5zZXJ2ZXJEYXRlKCkuZ2V0VGltZSgpKTsKCQkJaWYgKGRpZmYgPCAxMDAgJiYgZS5zdGFydC5yb3cgPT0gMCAmJiBlLnN0YXJ0LmNvbHVtbiA9PSAwKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy8gY29uc29sZS5sb2coIkNoYW5nZWQgRXZlbnQiLCBkaWZmKTsKCQkJZWRpdG9yLnNlc3Npb24ubGFzdENoYW5nZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJfSk7CgkJYXdhaXQgdGhpcy5yZWxvYWRFZGl0b3IoZWRpdG9yLCBsb2FkZXIsIGZEYXRhLCBvRWxlbWVudCk7CgoJCWlmIChzYXZlcikgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoewoJCQluYW1lOiAnc2F2ZScsCgkJCWJpbmRLZXk6IHsKCQkJCXdpbjogIkN0cmwtUyIsCgkJCQltYWM6ICJDbWQtUyIKCQkJfSwKCQkJZXhlYzogYXN5bmMgZWRpdG9yID0+IHsKCQkJCXZhciB2YWx1ZSA9IHRoaXMuX2JlYXV0aWZ5KGVkaXRvci5nZXRWYWx1ZSgpLCBsYW5ndWFnZShmRGF0YSkpOwoJCQkJaWYgKHZhbHVlICE9IGVkaXRvci5zZXNzaW9uLmdldFZhbHVlKCkpIGVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHZhbHVlKTsKCQkJCWlmIChzYXZlcikgewoJCQkJCWlmICh0eXBlb2YoJC5tZXNzYWdlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCSQubWVzc2FnZXIucHJvZ3Jlc3MoewoJCQkJCQkJdGl0bGU6ICdQbGVhc2Ugd2FpdGluZycsCgkJCQkJCQltc2c6ICdTYXZpbmcgZGF0YS4uLicsCgkJCQkJCQlpbnRlcnZhbDogb0VsZW1lbnQgPyAob0VsZW1lbnQuaW50ZXJ2YWwgfHwgNjAwKSA6IDYwMCwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWF3YWl0IHNhdmVyKHZhbHVlLCBmRGF0YSk7CgkJCQkJCWVkaXRvci5sYXN0U2F2ZWQgPSBzci5zZXJ2ZXJEYXRlKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5fZXJyb3IoIlVuYWJsZSB0byBTYXZlIGZpbGUuXG4iICsgZXgpOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mKCQubWVzc2FnZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkkLm1lc3NhZ2VyLnByb2dyZXNzKCdjbG9zZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0pOwoJfQoKCV9iZWF1dGlmeSh2YWx1ZSwgdHlwZSkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoanNfYmVhdXRpZnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkiZTR4IjogZmFsc2UsCgkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQl9OwoKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAnZnVuY3Rpb24nKSB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CgkJCQl2YWx1ZSA9IHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CgkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCcsICdodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJdmFsdWUgPSBqc19iZWF1dGlmeSh2YWx1ZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9IGNhdGNoIChleCkge30KCQlyZXR1cm4gdmFsdWU7Cgl9CgoJX2xhbmcoY29kZSkgewoJCXdpbmRvdy5sYW5nID0gY29kZTsKCQl0aGlzLnNldFVSTCgicGFnZT0iICsgKHRoaXMuYWxsRGF0YS5wYWdlLl9jb2RlIHx8ICdpbmRleCcpKTsKCX0KCglzZWxlY3QyU1Iob1NlbGVjdCkgewoJCWxldCBzID0gJChvU2VsZWN0KTsKCQlsZXQgY2FsbHMgPSBbXTsKCQlpZiAodGhpcy5zZWxlY3QyVGVtcGxhdGUpIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNlbGVjdDJUZW1wbGF0ZSk7CgkJfSBlbHNlIHsKCQkJY2FsbHMucHVzaCh0aGlzLnNyKCkuR2V0KHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi9zZWxlY3QyLXRlbXBsYXRlLmh0bSIpKSk7CgkJfQoJCSQud2hlbiguLi5jYWxscykudGhlbigoLi4ucmV0KSA9PiB7CgkJCXRoaXMuc2VsZWN0MlRlbXBsYXRlID0gcmV0WzBdOwoJCQlzLnNlbGVjdDIoewoJCQkJYWpheDogewoJCQkJCXRyYW5zcG9ydDogKHBhcmFtcywgc3VjY2VzcywgZmFpbHVyZSkgPT4gewoJCQkJCQl2YXIgZkZpbHRlciA9IHRoaXMuc3IoKS5ydW5TY3JpcHQoIihvLCBzdGF0ZSkgPT4geyIgKyBzLmRhdGEoInNyX2ZpbHRlciIpICsgIn0iKTsKCQkJCQkJJC53aGVuKHRoaXMuc3IoKS5fKHMuZGF0YSgic3JfbWV0aG9kIiksIG51bGwsIGZGaWx0ZXIoe30sIHRoaXMuc3IoKS5ydW5TY3JpcHQocy5kYXRhKCJjX3N0YXRlIikpKSkpLnRoZW4ocmV0ID0+IHsKCQkJCQkJCXN1Y2Nlc3MoewoJCQkJCQkJCXBhZ2luYXRpb246IHsKCQkJCQkJCQkJbW9yZTogZmFsc2UKCQkJCQkJCQl9LAoJCQkJCQkJCXJlc3VsdHM6ICQubWFwKHJldCwgciA9PiB7CgkJCQkJCQkJCXIuaWQgPSByLklkOwoJCQkJCQkJCQlyLnRleHQgPSByLlRvU3RyaW5nOwoJCQkJCQkJCQlyZXR1cm4gcjsKCQkJCQkJCQl9KSwKCQkJCQkJCQl0b3RhbHM6IHJldC5sZW5ndGgKCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9LAoJCQkJdGVtcGxhdGVSZXN1bHQ6IChfZSwgX3MpID0+IHsKCQkJCQlyZXR1cm4gdGhpcy5faW5qZWN0KHRoaXMuc2VsZWN0MlRlbXBsYXRlLCB7CgkJCQkJCWRhdGE6IF9lCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCQlzLm9uKCJjaGFuZ2UiLCBlID0+IHsKCQkJCWNvbnNvbGUubG9nKGUudGFyZ2V0KTsKCQkJfSk7CgkJCXMub24oImNoYW5nZS5zZWxlY3QyIiwgZSA9PiB7CgkJCQkvL3ZhciBkYXRhID0gZS5wYXJhbXMuZGF0YTsKCQkJCXZhciBfcyA9ICQoZS50YXJnZXQpOwoJCQl9KTsKCQl9KTsKCX0KCglhc3luYyBwcmVDb21waWxlKHBhZ2UsIGxvY2F0aW9uKSB7CgkJaWYgKHR5cGVvZiBCYWJlbCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJCWlmICh0eXBlb2YgUmVhY3QgIT09ICJ1bmRlZmluZWQiKSB7CgkJCWxldCBqc3ggPSBudWxsOwoJCQl0cnkgewoJCQkJanN4ID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKChsb2NhdGlvbiB8fCAidGVtcGxhdGVzIikgKyB0aGlzLm0oKSArICIvIiArIChwYWdlLl9jb2RlIHx8IHBhZ2UpICsgIi5qc3giKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoanN4ID09PSBudWxsIHx8IGpzeCA9PT0gIiIpIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgkJCXZhciByZXMgPSBudWxsOwoJCQl0cnkgewoJCQkJcmVzID0gYXdhaXQgQmFiZWwudHJhbnNmb3JtKGpzeCwgewoJCQkJCXByZXNldHM6IFsnbGF0ZXN0JywgInJlYWN0Il0KCQkJCX0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJY29uc29sZS5sb2coIkJhYmVsIiwgZXgpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCQkJcmV0dXJuIHJlcy5jb2RlOwoJCX0KCX0KCglhc3luYyBfdnVlQ29tcG9uZW50KGNvZGUpIHsKCQlpZiAodHlwZW9mIFZ1ZSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoJfQoKCWFzeW5jIF9yZW5kZXIocGFnZSwgZGF0YSwgb3B0aW9ucykgewoJCWNvbnNvbGUubG9nKCJSZW5kZXJQYWdlIiwgcGFnZSwgZGF0YSk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBhZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0aGlzLnBhZ2VzW2ldLl9jb2RlID09IHBhZ2UuX2NvZGUgJiYgdGhpcy5wYWdlc1tpXS5fbGFuZ3VhZ2UgJiYgKHRoaXMucGFnZXNbaV0uX2xhbmd1YWdlID09ICh3aW5kb3cubGFuZyB8fCBjb21wYW55Lkxhbmd1YWdlIHx8ICJlbiIpKSkgewoJCQkJY29uc29sZS5sb2coKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIikpOwoJCQkJcGFnZSA9IHRoaXMucGFnZXNbaV07CgkJCQlicmVhazsKCQkJfQoJCX0KCQlpZiAoIXRoaXMuc3IoKS5iTG9jYWwgJiYgKHBhZ2UuQm9keSB8fCBwYWdlLnRvRW50aXR5T2JqZWN0KSkgewoJCQljb25zb2xlLmxvZygiUGFnZSAiICsgcGFnZS5fY29kZSArICIgYWxyZWFkeSBsb2FkZWQsIHNlcnZpbmcuLi4iKTsKCQkJLy8gZm91bmQgdGhlIHBhZ2UgYW5kIGl0IGlzIGFuIG9iamVjdAoJCQlpZiAoIXBhZ2UuU2NyaXB0KSB7CgkJCQlsZXQgZSA9IGF3YWl0IHRoaXMuZW5kKCk7CgkJCQlyZXR1cm4gZTsKCQkJfQoJCQlhd2FpdCB0aGlzLnJ1blNjcmlwdChwYWdlLlNjcmlwdCk7CgkJfQoJCWxldCByZXQgPSBudWxsOwoKCQlpZiAodGhpcy5hcGlTZXJ2ZXIpIHsKCQkJY29uc29sZS5sb2coIl9yZW5kZXIoKSB1c2luZyBhcGlTZXJ2ZXIiLCB0aGlzLmFwaVNlcnZlci5TY29wZSk7CgkJCWxldCBwID0gYXdhaXQgdGhpcy5hcGlTZXJ2ZXIuX25ldygnSFRNTFBhZ2UnKS5wYWdlKHRoaXMuYXBpU2VydmVyLlNjb3BlICsgIi90ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlKS5maW5kKCk7CgkJCWlmIChwKSByZXQgPSB7CgkJCQlTY3JpcHQ6IHAuc2NyaXB0KCkgPyBwLnNjcmlwdCgpIDogJycsCgkJCQlCb2R5OiBwLmJvZHkoKSA/IHAuYm9keSgpIDogJycsCgkJCQlfY29kZTogcGFnZS5fY29kZSwKCQkJfTsKCQl9CgoJCWlmICghcmV0KSByZXQgPSBhd2FpdCB0aGlzLl92dWVDb21wb25lbnQocGFnZS5fY29kZSk7CgkJaWYgKCFyZXQgJiYgdHlwZW9mKENNU19ST09UKSA9PT0gJ3N0cmluZycpIHsKCQkJcmV0ID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc0hUTUxQYWdlRmluZCIsIG51bGwsIHsKCQkJCVBhZ2U6IHBhZ2UuX2NvZGUuaW5kZXhPZignLycpID49IDAgPyBwYWdlLl9jb2RlIDogKENNU19ST09UICsgcGFnZS5fY29kZSkKCQkJfSk7CgkJfQoJCWlmIChyZXQpIHsKCQkJLy8gc3RvcmUgdG8gYXZvaWQgcmVkdW5kYW50IGxvYWRpbmcKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIENNUywgc2VydmluZy4uLiIpOwoJCQlwYWdlID0gcmV0OwoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gQ01TLCBsb29raW5nIGluIEVNUyIpOwoJCQl2YXIgZW9QYWdlID0gbnVsbDsKCQkJdHJ5IHsKCQkJCWVvUGFnZSA9IG5ldyBQYWdlKCkuY29kZShwYWdlLl9jb2RlLCAiPSIpOwoJCQkJaWYgKGVvUGFnZS5sYW5ndWFnZSkgZW9QYWdlLmxhbmd1YWdlKHdpbmRvdy5sYW5nIHx8IGNvbXBhbnkuTGFuZ3VhZ2UgfHwgImVuIiwgIj0iKTsKCQkJfSBjYXRjaCAoZSkgewoJCQkJY29uc29sZS5sb2coIkVNUyBkb2VzIG5vdCBoYXZlIGEgUGFnZSBjbGFzcywgZmFpbGluZyBvbiBwdXJwb3NlOiAiICsgZS5tZXNzYWdlKTsKCQkJfQoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKS5fICYmIHdpbmRvdy5iTG9jYWwpIHJldCA9IGF3YWl0IHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNGb3JtVmFsdWVzIiwgbnVsbCwgewoJCQkJRW50aXR5T2JqZWN0OiAoZW9QYWdlID8gZW9QYWdlLnRvRW50aXR5T2JqZWN0KHRydWUpIDogbnVsbCkKCQkJfSk7CgkJCWlmIChyZXQgJiYgcmV0Lmxlbmd0aCkgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGZvdW5kIGluIEVNUywgdHJ5aW5nIHRlbXBsYXRlcyIpOwoJCQkJcGFnZSA9IHJldFswXTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBub3QgZm91bmQgaW4gRU1TLCBzbyBnb2luZyBsb2NhbCIpOwoJCQl9CgoJCQlsZXQgaHRtbCA9IG51bGw7CgkJCXRyeSB7CgkJCQlodG1sID0gYXdhaXQgZmV0Y2godGhpcy5yYW5kVVJMKCJ0ZW1wbGF0ZXMiICsgdGhpcy5tKCkgKyAiLyIgKyBwYWdlLl9jb2RlICsgIi5odG0iKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoaHRtbCAmJiAhaHRtbC5zdGF0dXMpIHsKCQkJCWNvbnNvbGUubG9nKCJQYWdlICIgKyBwYWdlLl9jb2RlICsgIiBodG1sIHRlbXBsYXRlIGZvdW5kIiwgaHRtbCk7CgkJCQlwYWdlLkJvZHkgPSBodG1sOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIGhhcyBubyBodG1sIHRlbXBsYXRlIik7CgkJCQlpZiAoIXBhZ2UuQm9keSAmJiB0eXBlb2YoUmVhY3QpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoTWFpbkNvbXBvbmVudCkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJcGFnZS5Cb2R5ID0gIjxkaXYgaWQ9J2Zvcm1Db21wb25lbnQnLz4iOwoJCQkJfSBlbHNlIHsKCQkJCQlwYWdlLkJvZHkgPSBwYWdlLl9jb250ZW50IHx8ICI8IS0tIiArICgiUGFnZSAiICsgcGFnZS5fY29kZSArICIgZG9lcyBub3QgZXhpc3QiKSArICItLT4iOwoJCQkJfQoJCQl9CgoJCQlsZXQganMgPSBhd2FpdCB0aGlzLnByZUNvbXBpbGUocGFnZSk7CgkJCWlmICghanMpIHRyeSB7CgkJCQlqcyA9IGF3YWl0IGZldGNoKHRoaXMucmFuZFVSTCgidGVtcGxhdGVzIiArIHRoaXMubSgpICsgIi8iICsgcGFnZS5fY29kZSArICIuanMiKSk7CgkJCX0gY2F0Y2ggKGV4KSB7fQoJCQlpZiAoIWpzIHx8ICFqcy5vaykganMgPSBudWxsOwoJCQlpZiAoanMgJiYganMub2spIHBhZ2UuU2NyaXB0ID0gYXdhaXQganMudGV4dCgpOwoKCQkJY29uc29sZS5sb2coIlBhZ2UgIiArIHBhZ2UuX2NvZGUgKyAiIHNjcmlwdCBpcyIgKyAoanMgPyAnJyA6ICcgbm90JykgKyAiIHJldHJpZXZlZCIpOwoJCQl0aGlzLnN0ZXAoKTsKCQkJLy8gb25seSBjYWNoZSBwYWdlcyB0aGF0IGNvbWUgZnJvbSBFTVMKCQkJaWYgKHBhZ2UudG9FbnRpdHlPYmplY3QpIHRoaXMucGFnZXMucHVzaChwYWdlKTsKCQl9CgkJcGFnZS5kYXRhID0gZGF0YTsKCQlwYWdlLlNjcmlwdCA9IGF3YWl0IHRoaXMucnVuU2NyaXB0KHBhZ2UuU2NyaXB0KTsKCQkvL2NvbnNvbGUubG9nKCJwYWdlIEJvZHkiLCBwYWdlLl9ib2R5IHx8IHBhZ2UuQm9keSk7CgkJaWYgKHR5cGVvZihwYWdlLlNjcmlwdCkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mKHBhZ2UuU2NyaXB0LmNvbnN0cnVjdG9yKSA9PT0gImZ1bmN0aW9uIikgewoJCQl0cnkgewoJCQkJbGV0IG9iaiA9IG5ldyBwYWdlLlNjcmlwdChwYWdlLCBERm9ybSk7CgkJCQlwYWdlLmNvbXBvbmVudCA9IG9iajsKCQkJCWlmIChvYmogJiYgb2JqLm1haW4pIHsKCQkJCQljb25zb2xlLmxvZygiQ2FsbGluZyBwYWdlWyIgKyAocGFnZS5fY29kZSB8fCBwYWdlLlBhZ2UgfHwgcGFnZSkgKyAiXS5TY3JpcHQubWFpbigpIik7CgkJCQkJYXdhaXQgb2JqLm1haW4oKTsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJfQoJCX0KCQlyZXR1cm4gcGFnZTsKCX0KCglhc3luYyBSZW5kZXJQYWdlKHBhZ2UsIGRhdGEsIG9wdGlvbnMpIHsKCQlpZiAodHlwZW9mKFJlYWN0RE9NKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJZGVsZXRlIHdpbmRvdy5Gb3JtQ29tcG9uZW50OwoJCQkkKCIjZm9ybUNvbXBvbmVudCIpLmVtcHR5KCk7CgkJfQoJCXZhciBfcGFnZSA9IGF3YWl0IHRoaXMuX3JlbmRlcihwYWdlLCBkYXRhLCBvcHRpb25zKTsKCQlpZiAoIV9wYWdlKSByZXR1cm4gbnVsbDsKCQlpZiAodHlwZW9mKGdhKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJZ2EoJ3NlbmQnLCB7CgkJCQloaXRUeXBlOiAncGFnZXZpZXcnLAoJCQkJcGFnZTogJy8nICsgX3BhZ2UuX2NvZGUgKyAnLmR5bmFtaWMnLAoJCQkJdGl0bGU6IF9wYWdlLl90aXRsZQoJCQl9KTsKCQkJY29uc29sZS5sb2coIlNlbnQgR0EgaGl0IGZvciBwYWdlOiAiICsgKF9wYWdlLl9jb2RlIHx8IF9wYWdlLlBhZ2UgfHwgX3BhZ2UpKTsKCQl9CgkJd2luZG93LnBhZ2UgPSBfcGFnZTsKCQl0aGlzLmFsbEhUTUwgPSAodGhpcy5ibG9ja3MuaGVhZGVyLmh0bWwgfHwgJycpICsgKHRoaXMuYmxvY2tzLmNvbnRlbnQuaHRtbCB8fCBfcGFnZS5Cb2R5IHx8IF9wYWdlLl9ib2R5IHx8ICcnKSArICh0aGlzLmJsb2Nrcy5mb290ZXIuaHRtbCB8fCAnJyk7CgkJdGhpcy5hbGxEYXRhID0gewoJCQlzZXR0aW5nczogdGhpcy5zZXR0aW5ncywKCQkJcGFnZTogX3BhZ2UsCgkJCXBhZ2VzOiB0aGlzLnBhZ2VzCgkJfTsKCQl0aGlzLmFsbE9wdGlvbnMgPSBvcHRpb25zOwoKCQl0aGlzLmVuZENhbGxlZCA9IGZhbHNlOwoJCS8vdGhpcy5zZXRVUkwoInBhZ2U9IiArIF9wYWdlLl9jb2RlKTsKCQlhd2FpdCB0aGlzLmVuZChudWxsLCB3aW5kb3cucGFnZS5kYXRhIHx8IGRhdGEpOwoJfQoKCWFzeW5jIHJ1blNjcmlwdChqcywgYkFzeW5jKSB7CgkJaWYgKHR5cGVvZihqcykgIT09ICJzdHJpbmciKSByZXR1cm4ganM7CgoJCXRyeSB7CgkJCXJldHVybiBKU09OLnBhcnNlKHNDb2RlKTsKCQl9IGNhdGNoIChleCkge30KCgkJbGV0IHNDb2RlID0ganM7CgkJaWYgKHNDb2RlLmluZGV4T2YoJ2NsYXNzICcpID49IDAgJiYgIWJBc3luYykgewoJCQkvLyBhIGNsYXNzIGRlZmluaXRpb24sIGRvIG5vdCBlbmNsb3NlIGl0IGluIGEgZnVuY3Rpb24KCQl9IGVsc2UgewoJCQlpZiAoc0NvZGUuaW5kZXhPZigncmV0dXJuICcpICE9IDApIHsKCQkJCXNDb2RlID0gInJldHVybiAiICsgc0NvZGU7CgkJCX0KCQkJc0NvZGUgPSAiKGFzeW5jICgpID0+IHsiICsgc0NvZGUgKyAiXG59KSgpOyI7CgkJfQoKCQlpZiAodHlwZW9mKHNyKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJcmV0dXJuIGF3YWl0IHNyLnJ1blNjcmlwdChzQ29kZSk7CgkJfSBlbHNlIGlmIChmYWxzZSAmJiB0eXBlb2YoZG9jdW1lbnQpICE9PSAndW5kZWZpbmVkJykgewoJCQlsZXQgcmV0ID0gYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQlzY3JpcHQub25sb2FkID0gcjsKCQkJCXNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByOwoJCQkJc2NyaXB0Lm9uZXJyb3IgPSByOwoJCQkJc2NyaXB0LmFzeW5jID0gYkFzeW5jOwoJCQkJc2NyaXB0LnNyYyA9IGBkYXRhOnRleHQvamF2YXNjcmlwdDtiYXNlNjQsJHt0aGlzLl9idG9hKHNDb2RlKX1gOwoJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJfSk7CgkJCWNvbnNvbGUubG9nKHJldCwgc0NvZGUuc3Vic3RyaW5nKDAsIDIwKSk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGV2YWwoc0NvZGUpOwoJCX0KCX0KfTs=",
	"__keys": ["name"],
	"active": true,
	"enabled": true,
	"__trMap": [{
		"id": "0195716959d1704daa1ac3a831162918",
		"transform": "IDQpIHwgKGIyIA=="
	}, {
		"id": "0195716959d1704daa1ac42003f6df06",
		"transform": "IDIpIHwgKGIzIA=="
	}]
}
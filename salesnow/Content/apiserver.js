{
	"__id": "87141a52ce5bec79cc3256eef4e1de3fb465423b",
	"content": "aWYodHlwZW9mKGdsb2JhbCkhPT0idW5kZWZpbmVkIikgZ2xvYmFsLkZsYXR0ZWQgPSByZXF1aXJlKCdmbGF0dGVkJyk7CgpsZXQgX19nID0gdHlwZW9mKGdsb2JhbCk9PT0idW5kZWZpbmVkIj93aW5kb3c6Z2xvYmFsOwoKbGV0IHNhbGVzbm93ID0gewogICAgX19zY3JpcHQ6IHsKICAgICAgICBEYXRlOiBuZXcgRGF0ZSgnMjAyMy0wOC0xNVQxMzoyODowNS4wMDBaJyksCiAgICB9LAogICAgX19zZWNyZXQ6IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBJalpoWW1WbE5EYzVMVEV5TVdFdE5EYzBaQzFoWkRNeExXTmhOalkwT0dRM05UUTJNQ0k9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBfX21haW5DbGFzczogJ1VzZXInLAoKICAgIGhyZWZzOiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgVzNzaWJHbGlJam9pVEc5blNGUk5UQ0lzSW5OeVl5STZJbWgwZEhCek9pOHZZMlJ1TG1welpHVnNhWFp5TG01bGRDOXVjRzB2WTI5dWMyOXNaUzFzYjJjdGFIUnRiRUF5TGpBdU1pOWpiMjV6YjJ4bExXeHZaeTFvZEcxc0xtMXBiaTVxY3lJc0ltTmhZMmhsSWpwMGNuVmxMQ0owYjI5c2N5STZXMTBzSW14dllXUWlPaUp0YjJSMWJHVnpJRDArSUdSdlkzVnRaVzUwTG1kbGRFVnNaVzFsYm5SQ2VVbGtLRndpVEc5blNGUk5URndpS1NBL0lFTnZibk52YkdWTWIyZElWRTFNTG1OdmJtNWxZM1FvWkc5amRXMWxiblF1WjJWMFJXeGxiV1Z1ZEVKNVNXUW9YQ0pNYjJkSVZFMU1YQ0lwS1NBNklDY25JaXdpY21WeGRXbHlaWE1pT2x0ZGZTeDdJbXhwWWlJNklsTlJURXBUSWl3aWMzSmpJanBiSW1oMGRIQnpPaTh2WTJSdWFuTXVZMnh2ZFdSbWJHRnlaUzVqYjIwdllXcGhlQzlzYVdKekwzTnhiQzVxY3k4eExqZ3VNQzl6Y1d3dGQyRnpiUzV0YVc0dWFuTWlYU3dpWTJGamFHVWlPblJ5ZFdVc0lteHZZV1FpT2lKaGMzbHVZeUJ0YjJSMWJHVnpJRDArSUh0Y2NseHVYSFJjZEhkcGJtUnZkeTVUVVV3Z1BTQmhkMkZwZENCcGJtbDBVM0ZzU25Nb2UxeHlYRzVjZEZ4MFhIUnNiMk5oZEdWR2FXeGxPaUJtYVd4bElEMCtJR0JvZEhSd2N6b3ZMMk5rYm1wekxtTnNiM1ZrWm14aGNtVXVZMjl0TDJGcVlYZ3ZiR2xpY3k5emNXd3Vhbk12TVM0NExqQXZKSHRtYVd4bGZXQmNjbHh1WEhSY2RIMHBPMXh5WEc1Y2RIMGlMQ0owYjI5c2N5STZXeUpUY1d4RVFpSmRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVpHOTBMVzlpYW1WamRDSXNJbk55WXlJNkltaDBkSEJ6T2k4dlkyUnVMbXB6WkdWc2FYWnlMbTVsZEM5dWNHMHZaRzkwTFc5aWFtVmpkRUF5TGpFdU5DOXBibVJsZUM1dGFXNHVhbk1pTENKallXTm9aU0k2ZEhKMVpTd2lkRzl2YkhNaU9sdGRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVFYaHBiM01pTENKemNtTWlPaUpvZEhSd2N6b3ZMM1Z1Y0d0bkxtTnZiUzloZUdsdmN5OWthWE4wTDJGNGFXOXpMbTFwYmk1cWN5SXNJbU5oWTJobElqcDBjblZsTENKMGIyOXNjeUk2VzEwc0luSmxjWFZwY21WeklqcGJYWDFkYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCgoKICAgIF9fVG9vbHM6IFsKICAgIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBleUowZVhCbElqcDdJbTVoYldVaU9pSlRjV3hFUWlJc0luUjVjR1ZmVFdGd2NHbHVaM01pT2x0N0ltRmpkR2wyWlNJNlptRnNjMlVzSW1OdmJuUmxlSFFpT2lJb1hGeGlYRngzS3lraUxDSmpiR0Z6YzA1aGJXVWlPaUlvWEZ4aVhGeDNLeWtpTENKemIzVnlZMlVpT2lJb1hGeGlYRngzS3lraUxDSjBZWEpuWlhRaU9pSW9iWFFzSUhNcElEMCtJSE11ZEc5TWIzZGxja05oYzJVb0tTSXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxOeGJFUkNJbjE5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBlWEJsWDBOdmJtWnBaM01pT2x0ZGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaVpHRjBZV0poYzJVaUxDSjJZV3gxWlNJNklsd2lPbTFsYlc5eWVUcGNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWMyVnlkbVZ5SWl3aWRtRnNkV1VpT2lKY0lteHZZMkZzYUc5emRGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMWMyVnlibUZ0WlNJc0luWmhiSFZsSWpvaVhDSnliMjkwWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSW5KdmIzUmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVkzSmxZWFJsSWl3aWRtRnNkV1VpT2lJeUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alJXNTBhWFI1UVhSMGNtbGlkWFJsY3lJc0luWmhiSFZsSWpvaWRISjFaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMVI1Y0dWa1FYUjBjbWxpZFhSbGN5SXNJblpoYkhWbElqb2lkSEoxWlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkSGx3WlNJc0luWmhiSFZsSWpvaVhDSnpjV3hwZEdWY0lpSXNJbTV2WkdVaU9uc2lZMjlrWlNJNklqSmxaVGhqT0RnNE0yRmxOQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZabUZzYzJVc0luUjVjR1VpT25zaWJtRnRaU0k2SWs1dlpHVktVeUo5Zlgwc2V5SnVZVzFsSWpvaWRIbHdaU0lzSW5aaGJIVmxJam9pWENKemNXeHBkR1ZjSWlJc0ltNXZaR1VpT25zaVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcG1ZV3h6WlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVG05a1pVcFRJbjE5ZlN4N0ltNWhiV1VpT2lKMGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW5OeGJHbDBaVndpSW4xZExDSnVZVzFsSWpvaVUzRnNSRUlpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpUWVd4bGMwWnZjbU5sSWl3aWRIbHdaVjlEYjI1bWFXZHpJanBiZXlKdVlXMWxJam9pY21WemRDNTFjbXd1WjNGc0lpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3RwYm5OMFlXNWpaWDE5TG0xNUxuTmhiR1Z6Wm05eVkyVXVZMjl0TDNObGNuWnBZMlZ6TDJSaGRHRXZkbnQ3ZG1WeWMybHZibjE5TDJkeVlYQm9jV3hjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2ljbVZ6ZEM1MWNtd2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTJsdWMzUmhibU5sZlgwdWJYa3VjMkZzWlhObWIzSmpaUzVqYjIwdmMyVnlkbWxqWlhNdlpHRjBZUzkyZTN0MlpYSnphVzl1ZlgwdmMyOWlhbVZqZEhNdmUzdDBUbUZ0WlgxOUwzdDdTV1I5ZlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmVjBzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRIbHdaVjlOWVhCd2FXNW5jeUk2VzExOUxDSjBiMjlzWDBOdmJtWnBaM01pT2x0N0ltNWhiV1VpT2lKcGJuTjBZVzVqWlNJc0luWmhiSFZsSWpvaVhDSmtNM1l3TURBd01EQTRZMlkzZFdGaExXUmxkaTFsWkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUoyWlhKemFXOXVJaXdpYzJOeWFYQjBJam9pSnpVNExqQW5JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMFlXSnNaU0lzSW5OamNtbHdkQ0k2SW5ST1lXMWxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKSlpDSXNJbk5qY21sd2RDSTZJbDkwYUdsekxsOWZhV1FpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNklsTjVibU5GYm5ScGRIbEJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUowY25WbElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alZIbHdaV1JCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKbVlXeHpaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pWm1Gc2MyVWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbU5zYVdWdWRGOXBaQ0lzSW5aaGJIVmxJam9pWENJelRWWkhPV0pvYTNKT0xuUnpiVmRmY3k0MVZYRkhkM05yV1VjNE1HVm1abEUxWjFkRFpGZHhVRXg0WmtONGMySnViSGhmTUM0dVQzaFRRVVV1WkRGeldUTlJXSE5aZFVKaWVXWjNNekp0TW10MlNqVk1YQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG1Oc2FXVnVkRjl6WldOeVpYUWlMQ0oyWVd4MVpTSTZJbHdpUlVKRk9FTkVRVGRCTVRCQ05UUXlOME5HTmpRMk1FTXhRME14TmpVMk5VUkdNalV4TWtJM01VRXlOelV6UTBZNU4wWXhPVGN5UlVVek56ZzJSVFpEUlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNXNiMmRwYmlJc0luWmhiSFZsSWpvaVhDSm1ZV1JwUUc1aGJXMXZkWEl1WTI5dFhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSWl4WE1pNVRRMFkxUG5sS1V6aytJVGhjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liRzluYVc0dWNHRnpjM2R2Y21RaUxDSjJZV3gxWlNJNklsd2lQMFFuYUcxTlptRktORVJHZERVN2Exd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVvYjNOMElpd2lkbUZzZFdVaU9pSmNJbnQ3YVc1emRHRnVZMlY5ZlM1dGVTNXpZV3hsYzJadmNtTmxMbU52YlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNXpZMjl3WlNJc0luWmhiSFZsSWpvaVhDSm1kV3hzWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNWpiMjUwWlc1MFgzUjVjR1VpTENKMllXeDFaU0k2SWx3aVlYQndiR2xqWVhScGIyNHZlQzEzZDNjdFptOXliUzExY214bGJtTnZaR1ZrWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNW9aV0ZrWlhKeklpd2lkbUZzZFdVaU9pSmNJbnRjWEZ3aVFYVjBhQzFTWlhGMVpYTjBMVlI1Y0dWY1hGd2lPaUJjWEZ3aVRtRnRaV1F0VlhObGNseGNYQ0o5WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNWliMlI1SWl3aWRtRnNkV1VpT2lKY0luSmxjM0J2Ym5ObFgzUjVjR1U5WTI5a1pWOWpjbVZrWlc1MGFXRnNjeVpqYkdsbGJuUmZhV1E5ZTN0dllYVjBhQzVqYkdsbGJuUmZhV1I5ZlNaeVpXUnBjbVZqZEY5MWNtazllM3R2WVhWMGFDNXlaV1JwY21WamRDNTFjbWw5ZlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNWhkWFJvYjNKcGVtVXViV1YwYUc5a0lpd2lkbUZzZFdVaU9pSmNJbkJ2YzNSY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VZWFYwYUc5eWFYcGxMblZ5YVNJc0luWmhiSFZsSWpvaVhDSm9kSFJ3Y3pvdkwzdDdiMkYxZEdndWFHOXpkSDE5TDNObGNuWnBZMlZ6TDI5aGRYUm9NaTloZFhSb2IzSnBlbVUvY21WemNHOXVjMlZmZEhsd1pUMWpiMlJsSm1Oc2FXVnVkRjlwWkQxN2UyOWhkWFJvTG1Oc2FXVnVkRjlwWkgxOUpuTmpiM0JsUFh0N2IyRjFkR2d1YzJOdmNHVjlmU1p6ZEdGMFpUMTdlMjloZFhSb0xtRjFkR2h2Y21sNlpTNXpkR0YwWlgxOUpuSmxaR2x5WldOMFgzVnlhVDE3ZTI5aGRYUm9MbkpsWkdseVpXTjBMblZ5YVgxOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbkJ2YzNRdWRYSnBJaXdpZG1Gc2RXVWlPaUpjSW1oMGRIQnpPaTh2ZTN0dllYVjBhQzVvYjNOMGZYMHZjMlZ5ZG1salpYTXZiMkYxZEdneUwyRjFkR2h2Y21sNlpWd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzV5WldScGNtVmpkQzUxY21raUxDSjJZV3gxWlNJNklsd2lhSFIwY0hNNkx5OWhjbnBvYjNOd2FYUmhiQzVuYVhSb2RXSXVhVzh2YzJGc1pYTnViM2N2WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuSmxaR2x5WldOMExtTnZaR1VpTENKMllXeDFaU0k2SWx3aVkyOWtaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1eVpXUnBjbVZqZEM1emRHRjBaU0lzSW5aaGJIVmxJam9pWENKemRHRjBaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1MWMyVnlhVzVtYnk1MWNta2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTI5aGRYUm9MbWh2YzNSOWZTOTFjMlZ5YVc1bWIxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzUwYjJ0bGJpNTFjbWtpTENKMllXeDFaU0k2SWx3aWFIUjBjSE02THk5N2UyOWhkWFJvTG1odmMzUjlmUzl6WlhKMmFXTmxjeTl2WVhWMGFESXZkRzlyWlc1Y0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dVltOWtlU0lzSW5aaGJIVmxJam9pWENKbmNtRnVkRjkwZVhCbFBYdDdiMkYxZEdndWRHOXJaVzR1WjNKaGJuUmZkSGx3WlgxOUptTnZaR1U5ZTN0dllYVjBhQzVoZFhSb2IzSnBlbVV1WTI5a1pYMTlKbU5zYVdWdWRGOXBaRDE3ZTI5aGRYUm9MbU5zYVdWdWRGOXBaSDE5Sm1Oc2FXVnVkRjl6WldOeVpYUTllM3R2WVhWMGFDNWpiR2xsYm5SZmMyVmpjbVYwZlgwbWNtVmthWEpsWTNSZmRYSnBQWHQ3YjJGMWRHZ3VjbVZrYVhKbFkzUXVkWEpwZlgxY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dWJXVjBhRzlrSWl3aWRtRnNkV1VpT2lKY0lsQlBVMVJjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1WTI5dWRHVnVkRjkwZVhCbElpd2lkbUZzZFdVaU9pSmNJbUZ3Y0d4cFkyRjBhVzl1TDNndGQzZDNMV1p2Y20wdGRYSnNaVzVqYjJSbFpGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzUwYjJ0bGJpNW5jbUZ1ZEY5MGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW1GMWRHaHZjbWw2WVhScGIyNWZZMjlrWlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNTBiMnRsYmk1eVpYTndiMjV6WlM1MGIydGxibDkwZVhCbElpd2lkbUZzZFdVaU9pSmNJblJ2YTJWdVgzUjVjR1ZjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1Y21WemNHOXVjMlV1Wlhod2FYSmxjMTlwYmlJc0luWmhiSFZsSWpvaVhDSmxlSEJwY21WelgybHVYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG5SdmEyVnVMbkpsYzNCdmJuTmxMbUZqWTJWemMxOTBiMnRsYmlJc0luWmhiSFZsSWpvaVhDSmhZMk5sYzNOZmRHOXJaVzVjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1Y21WemNHOXVjMlV1Y21WbWNtVnphRjkwYjJ0bGJpSXNJblpoYkhWbElqb2lYQ0p5WldaeVpYTm9YM1J2YTJWdVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5WFN3aWJtRnRaU0k2SWxOaGJHVnpSbTl5WTJVaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ4ZlRXRndjR2x1WjNNaU9sdGRmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SjBlWEJsSWpwN0ltNWhiV1VpT2lKR2FXeGxVM2x6ZEdWdElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owZVhCbFgwTnZibVpwWjNNaU9sdGRMQ0owZVhCbFgwMWhjSEJwYm1keklqcGJYWDBzSW5SdmIyeGZRMjl1Wm1sbmN5STZXM3NpYm1GdFpTSTZJbkJoZEdndWNtVmhaQ0lzSW5aaGJIVmxJam9pWENKb2RIUndjem92TDJGeWVtaHZjM0JwZEdGc0xtZHBkR2gxWWk1cGJ5OWNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pWm1Gc2MyVWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5WFN3aWJtRnRaU0k2SWtacGJHVlRlWE4wWlcwaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ4ZlRXRndjR2x1WjNNaU9sdGRmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SjBlWEJsSWpwN0ltNWhiV1VpT2lKSGFYUklkV0lpTENKMGVYQmxYME52Ym1acFozTWlPbHQ3SW01aGJXVWlPaUoxY213aUxDSjJZV3gxWlNJNklsd2lhSFIwY0hNNkx5OWhjR2t1WjJsMGFIVmlMbU52YlM5eVpYQnZjeTk3ZTI5M2JtVnlmWDB2ZTN0eVpYQnZjMmwwYjNKNWZYMHZZMjl1ZEdWdWRITXZYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOVhTd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owZVhCbFgwMWhjSEJwYm1keklqcGJYWDBzSW5SdmIyeGZRMjl1Wm1sbmN5STZXM3NpYm1GdFpTSTZJbkpsY0c5emFYUnZjbmtpTENKMllXeDFaU0k2SWx3aVlYSjZhRzl6Y0dsMFlXd3VaMmwwYUhWaUxtbHZYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOTNibVZ5SWl3aWRtRnNkV1VpT2lKY0ltRnllbWh2YzNCcGRHRnNYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG1GalkyVnpjMTkwYjJ0bGJpSXNJbDl1YjJSbElqcDdJbU52Ym5SbGVIUWlPbnNpWTI5a1pTSTZJbVJsZGlKOWZTd2lkbUZzZFdVaU9pSmNJbWRwZEdoMVlsOXdZWFJmTVRGQlRFUlRWVnBSTUVaUFZ6VlRUbFJZTTI5cWIxOXZRbGxxUmpreVFXWnVUMnByVFhKSlZXOUllbTA1U1hoaFUwSlVUaloyTW5GdFdGWTVjMEpOYTBKWU0xUkpORkpOVERaR1NVRkZNMk5LTkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpqY21WaGRHVWlMQ0oyWVd4MVpTSTZJaklpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNklsTjVibU5GYm5ScGRIbEJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUowY25WbElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alZIbHdaV1JCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKbVlXeHpaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgxZExDSnVZVzFsSWpvaVIybDBTSFZpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBiMjlzWDAxaGNIQnBibWR6SWpwYlhYMD1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpTENKMGVYQmxYME52Ym1acFozTWlPbHQ3SW01aGJXVWlPaUp0WVhBdVUzUmhkR1V1WTI5a1pTSXNJblpoYkhWbElqb2lYQ0o3WEZ4Y0lqRmNYRndpT2lCY1hGd2lRVnhjWENJc0lGeGNYQ0l5WEZ4Y0lqb2dYRnhjSWtKY1hGd2lMQ0JjWEZ3aU0xeGNYQ0k2SUZ4Y1hDSkRYRnhjSW4xY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYldGd0xsQnlhVzl5YVhSNUxtTnZaR1VpTENKMllXeDFaU0k2SWx3aWUxeGNYQ0l4WEZ4Y0lqb2dYRnhjSWtOeWFYUnBZMkZzWEZ4Y0lpd2dYRnhjSWpKY1hGd2lPaUJjWEZ3aVNHbG5hRnhjWENJc0lGeGNYQ0l6WEZ4Y0lqb2dYRnhjSWsxbFpHbDFiVnhjWENJc0lGeGNYQ0kwWEZ4Y0lqb2dYRnhjSWt4dmQxeGNYQ0o5WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbkpsYzNSaGNHa3VkWEpzSWl3aWRtRnNkV1VpT2lKY0ltaDBkSEJ6T2k4dmUzdHBibk4wWVc1alpYMTlMbk5sY25acFkyVXRibTkzTG1OdmJTOWhjR2t2Ym05M0wzUmhZbXhsTDF3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmVjBzSW5SNWNHVmZUV0Z3Y0dsdVozTWlPbHQ3SW1OdmJuUmxlSFFpT2lJb1hGeGlYRngzS3lraUxDSmpiR0Z6YzA1aGJXVWlPaUlvWEZ4aVhGeDNLeWtpTENKemIzVnlZMlVpT2lJb1hGeGlYRngzS3lraUxDSjBZWEpuWlhRaU9pSW9iWFFzSUhNcElEMCtJSE11ZEc5TWIzZGxja05oYzJVb0tTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpZEhsd1pTSTZleUp1WVcxbElqb2lVMlZ5ZG1salpVNXZkeUo5ZlN4N0ltTnZiblJsZUhRaU9pSkZiblJwZEhsQmRIUnlhV0oxZEdVaUxDSmpiR0Z6YzA1aGJXVWlPaUplS0VsdVkybGtaVzUwZkZCeWIySnNaVzBwSkNJc0luTnZkWEpqWlNJNkltTnZaR1VpTENKMFlYSm5aWFFpT2lKdWRXMWlaWElpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNleUpqYjI1MFpYaDBJam9pUlc1MGFYUjVRWFIwY21saWRYUmxJaXdpWTJ4aGMzTk9ZVzFsSWpvaVhpaEpibU5wWkdWdWRIeFFjbTlpYkdWdEtTUWlMQ0p6YjNWeVkyVWlPaUp1WVcxbElpd2lkR0Z5WjJWMElqb2ljMmh2Y25SZlpHVnpZM0pwY0hScGIyNGlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc2V5SmpiMjUwWlhoMElqb2lSVzUwYVhSNVFYUjBjbWxpZFhSbElpd2lZMnhoYzNOT1lXMWxJam9pWGloSmJtTnBaR1Z1ZEh4UWNtOWliR1Z0S1NRaUxDSnpiM1Z5WTJVaU9pSnlaVzFoY21zaUxDSjBZWEpuWlhRaU9pSmtaWE5qY21sd2RHbHZiaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVTJWeWRtbGpaVTV2ZHlKOWZTeDdJbU52Ym5SbGVIUWlPaUpGYm5ScGRIbEJkSFJ5YVdKMWRHVWlMQ0pqYkdGemMwNWhiV1VpT2lKSmJtTnBaR1Z1ZENJc0luTnZkWEpqWlNJNkltTnZaR1VpTENKMFlYSm5aWFFpT2lKdWRXMWlaWElpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNleUpqYjI1MFpYaDBJam9pWGloZlpuSnZiVVJ2WTNWdFpXNTBmRjkwYjBSdlkzVnRaVzUwS1NRaUxDSmpiR0Z6YzA1aGJXVWlPaUplS0VsdVkybGtaVzUwZkZCeWIySnNaVzBwSkNJc0luTnZkWEpqWlNJNklsNG9jM1JoZEdWOGNISnBiM0pwZEhrcEpDSXNJbTkxZEVOdmJtUnBkR2x2YmlJNkluUjVjR1Z2WmlodlltcEdjbTl0S1QwOVBTZHZZbXBsWTNRbklpd2lhVzVEYjI1a2FYUnBiMjRpT2lKMGVYQmxiMllvYjJKcVJuSnZiVnRqYjJSbFhTazlQVDBuYzNSeWFXNW5KeUlzSW05MWRGTmpjbWx3ZENJNkltOWlhbFJ2VzJOdlpHVmRJRDBnWDNSb2FYTXVYMlpzYVhBb1gzUm9hWE11WDE5amIyNW1hV2NvSjIxaGNDNG5LMk52WkdWVWVYQmxLeWN1WTI5a1pTY3NJRzUxYkd3c0lIdDBiMjlzT2lCMGIyOXNmU2twVzI5aWFrWnliMjB1WTI5a1pTZ3BYU0lzSW1sdVUyTnlhWEIwSWpvaWIySnFWRzliWTI5a1pWMGdQU0I3WTI5a1pUb2dYM1JvYVhNdVgxOWpiMjVtYVdjb0oyMWhjQzRuSzJOdlpHVlVlWEJsS3ljdVkyOWtaU2NzSUc1MWJHd3NJSHQwYjI5c09pQjBiMjlzZlNsYmIySnFSbkp2YlZ0amIyUmxYVjE5SWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBlWEJsSWpwN0ltNWhiV1VpT2lKVFpYSjJhV05sVG05M0luMTlYU3dpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN3aWRHOXZiRjlOWVhCd2FXNW5jeUk2VzNzaVkyeGhjM05PWVcxbElqb2lWWE5sY2lJc0luUmhjbWRsZENJNkluVnpaWEpmYm1GdFpTSXNJbk52ZFhKalpTSTZJa2xrSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBiMjlzSWpwN0ltNWhiV1VpT2lKVFRrOVhUMDlDSW4xOUxIc2lZMnhoYzNOT1lXMWxJam9pVFc5a1pXeGZRMkYwWldkdmNua2lMQ0p6YjNWeVkyVWlPaUpOYjJSbGJGOURZWFJsWjI5eWVTSXNJblJoY21kbGRDSTZJbU50WkdKZmJXOWtaV3hmWTJGMFpXZHZjbmtpTENKamIyNTBaWGgwSWpvaVJXNTBhWFI1UTJ4aGMzTWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SdmIyd2lPbnNpYm1GdFpTSTZJbE5PVDFkUFQwSWlmWDBzZXlKamJHRnpjMDVoYldVaU9pSkJjM05sZENJc0luTnZkWEpqWlNJNklrRnpjMlYwSWl3aWRHRnlaMlYwSWpvaVlXeHRYMkZ6YzJWMElpd2lZMjl1ZEdWNGRDSTZJa1Z1ZEdsMGVVTnNZWE56SWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBiMjlzSWpwN0ltNWhiV1VpT2lKVFRrOVhUMDlDSW4xOUxIc2lZMnhoYzNOT1lXMWxJam9pVFc5a1pXeGZRMkYwWldkdmNua2lMQ0owWVhKblpYUWlPaUpoYzNObGRGOWpiR0Z6Y3lJc0luTnZkWEpqWlNJNkltTnNZWE56V3k1M1hTb2lMQ0p2ZFhSVFkzSnBjSFFpT2lKdlltcFVieTVoYzNObGRGOWpiR0Z6Y3lBOUlHOWlha1p5YjIxYlkyOWtaVjA3SWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBiMjlzSWpwN0ltNWhiV1VpT2lKVFRrOVhUMDlDSW4xOUxIc2lZMnhoYzNOT1lXMWxJam9pUVhOelpYUWlMQ0owWVhKblpYUWlPaUpwYm5OMFlXeHNYM04wWVhSMWN5SXNJbk52ZFhKalpTSTZJbk4wWVhSMWMxc3VkMTBxSWl3aWIzVjBVMk55YVhCMElqb2liMkpxVkc4dWFXNXpkR0ZzYkY5emRHRjBkWE1nUFNCdlltcEdjbTl0VzJOdlpHVmRPeUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRHOXZiQ0k2ZXlKdVlXMWxJam9pVTA1UFYwOVBRaUo5ZlN4N0ltTnNZWE56VG1GdFpTSTZJazF2WkdWc1gwTmhkR1ZuYjNKNUlpd2lkR0Z5WjJWMElqb2libUZ0WlNJc0luTnZkWEpqWlNJNkltNWhiV1VpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMndpT25zaWJtRnRaU0k2SWxOT1QxZFBUMElpZlgwc2V5SmpiR0Z6YzA1aGJXVWlPaUpOYjJSbGJGOURZWFJsWjI5eWVTSXNJblJoY21kbGRDSTZJbkJoY21WdWRGOWpZWFJsYjJkeWVTSXNJbk52ZFhKalpTSTZJbkJoY21WdWRDSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpZEc5dmJDSTZleUp1WVcxbElqb2lVMDVQVjA5UFFpSjlmU3g3SW1Oc1lYTnpUbUZ0WlNJNklrVjJaVzUwSWl3aWMyOTFjbU5sSWpvaWNtVmphWEJwWlc1MElpd2lkR0Z5WjJWMElqb2libTlrWlNJc0ltOTFkRk5qY21sd2RDSTZJaWRCVUVsVFJWSldSVkk2SnlBcklGOTBhR2x6TGxOamIzQmxJQ3NnSnpvbklDc2dLRjkwYUdsekxuSmxZMmx3YVdWdWRDZ3BJSHg4SUh0OUtTNWpiMlJsS0NraUxDSnBibE5qY21sd2RDSTZJbTlpYWk1dWIyUmxMbk53YkdsMEtDYzZKeWt1YkdWdVozUm9QVDB4UDI1MWJHdzZibVYzSUc5VFkyOXdaUzVPYjJSbEtDa3VZMjlrWlNodlltb3VibTlrWlM1emNHeHBkQ2duT2ljcFd6SmRLU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRHOXZiQ0k2ZXlKdVlXMWxJam9pVTA1UFYwOVBRaUo5ZlYwc0luUnZiMnhmUTI5dVptbG5jeUk2VzNzaWJtRnRaU0k2SW1sdWMzUmhibU5sSWl3aWRtRnNkV1VpT2lKY0ltUmxkakUzTURNd05Gd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMWMyVnlibUZ0WlNJc0luWmhiSFZsSWpvaVhDSjBkVjl1YjJSbGFuTmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pZEhKMVpTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pY0dGemMzZHZjbVFpTENKMllXeDFaU0k2SWx3aUtEaDRNMGRUUldwd1JrMHpUazF5VUZSZGNIbGJhMUk4YXpSUVpHcEpPVmN0TTBsb01paDZmU2s2TlNnb1hXSTJMazVRU3poMVBURS9RbDgwTnpFdFgxaHRXU3Q1VTIxQmUyTTBiaTByTEY1d2RsSXhWbk5VVUhFb0pGY3VjQ1E4VHp0WVAxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKemVYTmZjSEp2Y0dWeWRHbGxjeTVuYkdsa1pTNXplWE11WkdGMFpWOW1iM0p0WVhRaUxDSjJZV3gxWlNJNklsd2llWGw1ZVMxTlRTMWtaRndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnplWE5mY0hKdmNHVnlkR2xsY3k1bmJHbGtaUzV6ZVhNdWRHbHRaVjltYjNKdFlYUWlMQ0oyWVd4MVpTSTZJbHdpU0VnNmJXMDZjM05jSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2ljM2x6WDNCeWIzQmxjblJwWlhNdVoyeHBaR1V1YzNsekxtUmxabUYxYkhRdWRIb2lMQ0oyWVd4MVpTSTZJbHdpUlhWeWIzQmxMMEpsY214cGJsd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKamNtVmhkR1VpTENKMllXeDFaU0k2SWpJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbE41Ym1ORmJuUnBkSGxCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKMGNuVmxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKVGVXNWpWSGx3WldSQmRIUnlhV0oxZEdWeklpd2lkbUZzZFdVaU9pSm1ZV3h6WlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMWRMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBdLAoKfTsKCgoKZGVsZXRlIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJOwpzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSA9IGNsYXNzIEdlbmVyaWNTZXJ2aWNlQVBJIHsKCWFzeW5jIHNldEludGVydmFsKGZ1biwgbWludXRlcywgLi4uYXJncykgewoJCWxldCBmTmFtZSA9IGZ1bi50b1N0cmluZygpLnNwbGl0KCcpJylbMF0gKyAnKSc7CgkJdHJ5IHsKCQkJLy8gdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKTsKCgkJCXRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCk7CgkJCWxldCByZXQgPSBhd2FpdCBmdW4oLi4uYXJncy5jb25jYXQoW25ldyBEYXRlKCldKSk7CgoJCQl0aGlzLmxvZyhge0NhbGw6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApICsgYCwgTG9vcDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCkgKyAnfScsICdzZXRJbnRlcnZhbCcsIGZOYW1lKTsKCQkJaWYgKCFyZXQpIHsKCQkJCXRoaXMubG9nKGBkaWQgbm90IHJldHVybiB0cnVlLCBleGl0aW5nIGxvb3BlciAoJHt0aGlzLl9fdGltZShmTmFtZSl9KWAsICdzZXRJbnRlcnZhbCcsIGZOYW1lKTsKCQkJCXJldHVybjsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHRoaXMuX190aW1lKGZOYW1lKSwgJ3NldEludGVydmFsJywgZk5hbWUsIDIsIGV4KTsKCQkJY29uc29sZS50cmFjZSgpOwoJCX0KCQlpZiAoIU51bWJlcihtaW51dGVzKSkgewoJCQl0aGlzLmxvZyh0aGlzLl9fdGltZShmTmFtZSksICdzZXRJbnRlcnZhbCcsIGZOYW1lLCAwLCAiTm90IHJlcGVhdGluZy4gTWludXRlcyBpcyAiICsgbWludXRlcyk7CgkJCXJldHVybjsKCQl9CgkJYXdhaXQgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIG1pbnV0ZXMgKiA2MCAqIDEwMDApKTsKCQlhd2FpdCB0aGlzLnNldEludGVydmFsKGZ1biwgbWludXRlcywgLi4uYXJncyk7Cgl9CgoJYXN5bmMgX2V4ZWN1dGUoc2NvcGUsIG0sIGZSb3V0ZXIsIGZTY3JpcHQsIG9QYXJhbXMgPSB7fSkgewoJCWxldCBfX2JlZm9yZVJ1bGVzID0gb1BhcmFtcy5fX2JlZm9yZVJ1bGVzIHx8IFtdOwoJCWxldCBfX2FmdGVyUnVsZXMgPSBvUGFyYW1zLl9fYWZ0ZXJSdWxlcyB8fCBbXTsKCQlkZWxldGUgb1BhcmFtcy5fX2JlZm9yZVJ1bGVzOwoJCWRlbGV0ZSBvUGFyYW1zLl9fYWZ0ZXJSdWxlczsKCgkJX19iZWZvcmVSdWxlcy5jb25jYXQoX19hZnRlclJ1bGVzKS5mb3JFYWNoKHIgPT4gci5TY3JpcHQgPSB0aGlzLnJ1blNjcmlwdChgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIHNjb3BlLCBub2RlJHtPYmplY3Qua2V5cyhvUGFyYW1zKS5sZW5ndGg/JywgJzonJ30ke09iamVjdC5rZXlzKG9QYXJhbXMpLmpvaW4oJywnKX0pID0+IHske3IuU2NyaXB0fX1gKSk7CgoJCWxldCBsUGFyYW1zID0gT2JqZWN0LmVudHJpZXMob1BhcmFtcykubWFwKHggPT4geFsxXSk7CgkJbGV0IHJlc3VsdHMgPSBbXTsKCgkJaWYgKHRoaXMuRFNDb25uZWN0KSBhd2FpdCB0aGlzLkRTQ29ubmVjdCgpOwoKCQlsZXQgbm9kZXMgPSBbXTsKCQlpZiAoIXNjb3BlLl9ub2RlIHx8ICFmUm91dGVyKSB7CgkJCW5vZGVzLnB1c2gobnVsbCk7CgkJfSBlbHNlIHsKCQkJaWYgKHNjb3BlLl9ub2RlKSB7CgkJCQlpZiAoYXdhaXQgdGhpcy5fU2NyaXB0KGZSb3V0ZXIsIG0sICdSb3V0ZXInLCBzY29wZSwgc2NvcGUuX25vZGUsIC4uLmxQYXJhbXMpKSB7CgkJCQkJbm9kZXMucHVzaChzY29wZS5fbm9kZSk7CgkJCQl9CgoJCQkJdGhpcy5fZml4Tm9kZShzY29wZSk7CgoJCQkJaWYgKHNjb3BlLl9ub2RlLl9wYXJlbnQgJiYgKGF3YWl0IHRoaXMuX1NjcmlwdChmUm91dGVyLCBtLCAnUm91dGVyJywgc2NvcGUsIHNjb3BlLl9ub2RlLl9wYXJlbnQsIC4uLmxQYXJhbXMpKSkgewoJCQkJCS8vIHRoaXMubG9nKHNjb3BlLl9ub2RlLl9wYXJlbnQsICdfZXhlY3V0ZScsICdhZGRpbmcgcGFyZW50Jyk7CgkJCQkJbm9kZXMucHVzaChzY29wZS5fbm9kZS5fcGFyZW50KTsKCQkJCX0gZWxzZSBpZiAoc2NvcGUuRXZlbnQgJiYgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICE9PSAiRXZlbnQiKSB7CgkJCQkJLy8gbm9kZXMucHVzaChuZXcgc2NvcGUuTm9kZSgpKTsKCQkJCX0KCgkJCQl0aGlzLl9maXhOb2RlKHNjb3BlKTsKCQkJCWZvciBhd2FpdCAoY29uc3QgY24gb2Ygc2NvcGUuX25vZGUucGFyZW50X05vZGVzKCkpIHsKCQkJCQlpZiAoYXdhaXQgdGhpcy5fU2NyaXB0KGZSb3V0ZXIsIG0sICdTY3JpcHQnLCBzY29wZSwgY24sIC4uLmxQYXJhbXMpKSB7CgkJCQkJCS8vIHRoaXMubG9nKGNuLCAnX2V4ZWN1dGUnLCAnYWRkaW5nIGNoaWxkIG5vZGUnKTsKCQkJCQkJbm9kZXMucHVzaChjbik7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyByZW1vdmUgYW55IG51bGxzCgkJCW5vZGVzID0gbm9kZXMuZmxhdCgpLmZpbHRlcihuID0+IG4pOwoKCQkJaWYgKCFub2Rlcy5sZW5ndGgpIHsKCQkJCW5vZGVzLnB1c2goc2NvcGUuX25vZGUpOwoJCQl9CgoJCQkvLyB0aGlzLmxvZyhub2Rlcy5sZW5ndGgsICdfZXhlY3V0ZScsICdub2Rlcy5sZW5ndGgnKTsKCQl9CgoJCWZvciBhd2FpdCAoY29uc3QgbiBvZiBub2RlcykgewoJCQl0aGlzLl9maXhOb2RlKHNjb3BlKTsKCQkJbGV0IG5SZXQgPSBudWxsOwoJCQl0aGlzLmxvZyhgJHttfSBAICR7bj8uY29kZSgpIHx8ICdMT0NBTCd9YCwgJ19leGVjdXRlJywgYCR7dGhpcy5FbnRpdHlDbGFzcy5OYW1lfWApOwoJCQlpZiAoIW4gfHwgdGhpcy5fc2FtZU5vZGUoc2NvcGUuX25vZGUsIG4pKSB7CgkJCQkvLyBsb2NhbCBzY3JpcHQKCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2JlZm9yZVJ1bGVzKSB7CgkJCQkJYXdhaXQgdGhpcy5fU2NyaXB0KHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0JlZm9yZVJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7CgkJCQl9CgoJCQkJblJldCA9IGF3YWl0IHRoaXMuX1NjcmlwdChmU2NyaXB0LCBtLCAnU2NyaXB0Jywgc2NvcGUsIC4uLmxQYXJhbXMpOwoKCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBfX2FmdGVyUnVsZXMpIHsKCQkJCQlhd2FpdCB0aGlzLl9TY3JpcHQoci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQWZ0ZXJSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJblJldCA9IGF3YWl0IHRoaXMuX2ludm9rZU5vZGUobiwgbSwgb1BhcmFtcyk7CgkJCX0KCgkJCXJlc3VsdHMucHVzaCh7CgkJCQlub2RlOiBuLAoJCQkJcmV0OiBuUmV0CgkJCX0pOwoJCX0KCQkvLyB0aGlzLmxvZyhyZXN1bHRzLCAnX2V4ZWN1dGUnLCAnUmVzdWx0cycpOwoKCQlsZXQgZXJyb3JzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnJldCAmJiByLnJldC5fX2V4Y2VwdGlvbikgLyouZmlsdGVyKHIgPT4gIXRoaXMuX3NhbWVOb2RlKHNjb3BlLl9ub2RlLCByLm5vZGUpKSovIC5tYXAociA9PiAoewoJCQlub2RlOiByLm5vZGUgPyB7CgkJCQljb2RlOiByLm5vZGUuY29kZSgpLAoJCQkJYWRkcmVzczogci5ub2RlLmFkZHJlc3MoKQoJCQl9IDogbnVsbCwKCQkJX19leGNlcHRpb246IHIucmV0Ll9fZXhjZXB0aW9uCgkJfSkpOwoJCWlmIChlcnJvcnMubGVuZ3RoKSB7CgkJCXRoaXMubG9nKCJfZXhlY3V0ZSIsIG0sICJlcnJvcnMiLCAxLCBlcnJvcnMpOwoJCX0KCgkJcmV0dXJuIHJlc3VsdHM7Cgl9CgoJX3NhbWVOb2RlKG4xLCBuMikgewoJCWlmICh0eXBlb2YobjIpID09PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YobjEpICE9PSAidW5kZWZpbmVkIikgewoJCQluMiA9IG4xOwoJCQluMSA9IHRoaXM7CgkJfQoKCQlpZiAoIW4xIHx8ICFuMikgcmV0dXJuIGZhbHNlOwoKCQlpZiAodHlwZW9mKG4xLl9jb2RlKSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKG4yLl9jb2RlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBmYWxzZTsKCgkJaWYgKG4xLmNvbnN0cnVjdG9yLm5hbWUgIT0gIk5vZGUiIHx8IG4yLmNvbnN0cnVjdG9yLm5hbWUgIT0gIk5vZGUiKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmIChuMS5fY29kZV9jb29wIHx8IG4yLl9jb2RlX2Nvb3ApIHJldHVybiBmYWxzZTsKCgkJaWYgKG4xLl9jb2RlID09IG4yLl9jb2RlKSByZXR1cm4gdHJ1ZTsKCgkJcmV0dXJuIHRoaXMuRXF1YWxzKG4xLCBuMik7Cgl9CgoJX2ZpeE5vZGUoc2NvcGUpIHsKCQkvLyBvbiBOb2RlSlMgZm9yIHNvbWUgcmVhc29uLCBfbm9kZSBpcyBzb21ldGltZXMgYW4gYXJyYXkhCgkJdHJ5IHsKCQkJc2NvcGUgPSBzY29wZSB8fCB0aGlzLl9fc2NvcGUoKTsKCQkJaWYgKEFycmF5LmlzQXJyYXkoc2NvcGUuX25vZGUpKSBzY29wZS5fbm9kZSA9IHNjb3BlLl9ub2RlWzBdOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKCdfZml4Tm9kZScsIHR5cGVvZih0aGlzKSwgMSwgZXgsIHRoaXMuY29uc3RydWN0b3IubmFtZSk7CgkJfQoJfQoKCWxvZyhvYmosIG0sIHR5cGUsIGxldmVsLCAuLi5tc2cpIHsKCQl0cnkgewoJCQlsZXQgZGVidWcgPSB0aGlzLkRlYnVnOwoJCQlsZXQgbGV2ZWxzID0gWyJpbmZvIiwgIndhcm4iLCAiZXJyb3IiLCAiY3JpdGljYWwiXTsKCgkJCWRlYnVnID0gZGVidWcgfHwgT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAobGV2ZWxzLm1hcChsID0+IFtsLCAnKiddKSkpOwoKCQkJbGV0IGZ1bmN0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIC4uLmxldmVscy5tYXAobCA9PiAoewoJCQkJW2xdOiBkZWJ1Z1tsXSA/IGRlYnVnW2xdLnNwbGl0KCcsJykgOiBbXQoJCQl9KSkpOwoKCQkJbGV0IGNzcyA9ICdiYWNrZ3JvdW5kOiAjMDBmZjAwOyBjb2xvcjogIzAwODAwMCc7CgkJCWxldCBmZyA9ICdceDFiWzMybSc7CgkJCXN3aXRjaCAoTnVtYmVyKGxldmVsKSkgewoJCQkJY2FzZSAxOgoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjZmZmZjAwOyBjb2xvcjogIzAwMDA4MCc7CgkJCQkJZmcgPSAnXHgxYlszM20nOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAyOgoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7CgkJCQkJZmcgPSAnXHgxYlszMW0nOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAzOgoJCQkJCWNzcyA9ICdiYWNrZ3JvdW5kOiAjYjIyMjIyOyBjb2xvcjogI2ZmZmZmZic7CgkJCQkJZmcgPSAnXHgxYlszMW1bQ1JJVElDQUxdJzsKCQkJCQlicmVhazsKCQkJfQoKCQkJaWYgKGZ1bmN0aW9uc1tsZXZlbHNbTnVtYmVyKGxldmVsKSB8fCAwXV0uZXZlcnkoZiA9PiAhWycqLionLCAnKi4nICsgbSwgJyonLCBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLicgKyBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLionXS5pbmNsdWRlcyhmKSkpIHsKCQkJCS8vIGNvbnNvbGUubG9nKCdubyBtZXRob2QnLCBmdW5jdGlvbnMsIGZ1bmN0aW9uc1tsZXZlbHNbTnVtYmVyKGxldmVsKSB8fCAwXV0sIG0sIFsnKi4qJywgJyouJyArIG0sICcqJywgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4nICsgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4qJ10pOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQljb25zb2xlLmxvZyhmZyArICIlc1x4MWJbMG0iLCBgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke3RoaXMuRW50aXR5Q2xhc3MuTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOwoJCQl9IGVsc2UgewoJCQkJY29uc29sZS5sb2coYCVjICR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHt0aGlzLkVudGl0eUNsYXNzLk5hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgY3NzLCAuLi4odHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnID8gKG1zZyB8fCBbXSkgOiBbb2JqXS5jb25jYXQobXNnIHx8IFtdKSkpOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJY29uc29sZS5sb2coZXgpOwoJCQkvL3RoaXMubG9nKGV4LCBtLCB0eXBlLCAzKTsKCQl9Cgl9CgoJYXN5bmMgX1NjcmlwdChzY3JpcHQsIG0sIHR5cGUsIHNjb3BlLCAuLi5zZkFyZ3MpIHsKCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgoJCXJldHVybiBhd2FpdCAoYXN5bmMgKHR5cGUsIC4uLnNBcmdzKSA9PiB7CgkJCWxldCBsb2cgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKG9iaiwgbSwgdHlwZSwgMCwgLi4ubXNnKTsKCQkJbGV0IHdhcm4gPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKG9iaiwgbSwgdHlwZSwgMSwgLi4ubXNnKTsKCQkJbGV0IGVycm9yID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZyhvYmosIG0sIHR5cGUsIDIsIC4uLm1zZyk7CgoJCQl0cnkgewoJCQkJbGV0IHJldCA9IG51bGw7CgoJCQkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnc3RyaW5nJykgc2NyaXB0ID0gdGhpcy5ydW5TY3JpcHQoc2NyaXB0KTsKCQkJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IGF3YWl0IHNjcmlwdChsb2csIHdhcm4sIGVycm9yLCBzY29wZSwgbSwgLi4uc0FyZ3MpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoKTsKCQkJCXJldHVybiByZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJZXJyb3IoZXgsIDIsIC4uLnNBcmdzLCBzY3JpcHQpOwoJCQkJfSBlbHNlIHsKCQkJCQllcnJvcihleCwgMik7CgkJCQl9CgkJCX0KCQl9KSh0eXBlLCAuLi5zZkFyZ3MpOwoJfQp9OwoKCnNhbGVzbm93LlVzZXIgPSBjbGFzcyBVc2VyIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpmWVhWMGFHOXlhWHBsTG5WelpYSnVZVzFsSWpvaVptRmthU0lzSWw5aGRYUm9iM0pwZW1VdWNHRnpjM2R2Y21RaU9pSXhNak1pTENKZllYVjBhRzl5YVhwbExuUmxjM1JWYzJWeUlqcDdJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpWjJWdVpHVnlJanA3SW1OdlpHVWlPaUpOSWl3aWJtRnRaU0k2SWsxaGJHVWlmU3dpWTI5a1pTSTZJbVpoWkdraUxDSnVZVzFsSWpvaVJtRmthU0o5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInVzZXJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl91c2VybmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInBhc3N3b3JkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wYXNzd29yZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRlcGFydG1lbnQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RlcGFydG1lbnQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX21hbmFnZXJfRGVwYXJ0bWVudHMoKTsKCgkJdGhpcy5jbGVhcl9jYWxsZXJfSW5jaWRlbnRzKCk7CgoJCXRoaXMuY2xlYXJfY29udGFjdF9JbmNpZGVudHMoKTsKCgkJdGhpcy5jbGVhcl91c2VyX0dyb3VwX01lbWJlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJVc2VyIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9kZXBhcnRtZW50X3NldCAmJiB0aGlzLl9kZXBhcnRtZW50KSB0aGlzLl9kZXBhcnRtZW50LlRvb2wgPSB0b29sOwoKCQkvLyAodGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuY2FsbGVyX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXJuYW1lICoqLwoJdXNlcm5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl91c2VybmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInVzZXJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl91c2VybmFtZSAhPSB2KSB7CgkJCQl0aGlzLl91c2VybmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fdXNlcm5hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcm5hbWUpOwoJCX0KCX0KCgljbGVhcl91c2VybmFtZSgpIHsKCQl0aGlzLl91c2VybmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXJuYW1lID0gbnVsbDsKCQl0aGlzLl91c2VybmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcm5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXNzd29yZCAqKi8KCXBhc3N3b3JkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcGFzc3dvcmRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwYXNzd29yZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcGFzc3dvcmQgIT0gdikgewoJCQkJdGhpcy5fcGFzc3dvcmRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3Bhc3N3b3JkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3Bhc3N3b3JkKTsKCQl9Cgl9CgoJY2xlYXJfcGFzc3dvcmQoKSB7CgkJdGhpcy5fcGFzc3dvcmRfc2V0ID0gbnVsbDsKCQl0aGlzLl9wYXNzd29yZCA9IG51bGw7CgkJdGhpcy5fcGFzc3dvcmRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhc3N3b3JkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudCAqKi8KCWRlcGFydG1lbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGVwYXJ0bWVudCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzQ0ZmFlMWJkLTAwODQtNGM5Ni05NmUzLTg3NTg3ZWMxNjAxZCcgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0RlcGFydG1lbnQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjQ0ZmFlMWJkLTAwODQtNGM5Ni05NmUzLTg3NTg3ZWMxNjAxZCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJEZXBhcnRtZW50Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RlcGFydG1lbnQgIT0gdikgewoJCQkJdGhpcy5fZGVwYXJ0bWVudF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RlcGFydG1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2RlcGFydG1lbnQgPyB0aGlzLl9kZXBhcnRtZW50LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9kZXBhcnRtZW50X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9kZXBhcnRtZW50ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RlcGFydG1lbnQpOwoJCX0KCX0KCgljbGVhcl9kZXBhcnRtZW50KCkgewoJCXRoaXMuX2RlcGFydG1lbnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9kZXBhcnRtZW50ID0gbnVsbDsKCQl0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlcl9EZXBhcnRtZW50cyAqKi8KCW1hbmFnZXJfRGVwYXJ0bWVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzQ0ZmFlMWJkLTAwODQtNGM5Ni05NmUzLTg3NTg3ZWMxNjAxZCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRGVwYXJ0bWVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbWFuYWdlcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJtYW5hZ2VyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJEZXBhcnRtZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcl9EZXBhcnRtZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAibWFuYWdlciBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkRlcGFydG1lbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YubWFuYWdlcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzLnB1c2goLi4udik7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfbWFuYWdlcl9EZXBhcnRtZW50cygpIHsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyX0RlcGFydG1lbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyX0luY2lkZW50cyAqKi8KCWNhbGxlcl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NhbGxlcl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzg5MmI3ZjE1LTEyZmYtNDA5YS05ZDliLTU4NDMyMzdhYjNhNScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2NhbGxlcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXJfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYWxsZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2FsbGVyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2FsbGVyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9jYWxsZXJfSW5jaWRlbnRzKCkgewoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlcl9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250YWN0X0luY2lkZW50cyAqKi8KCWNvbnRhY3RfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jb250YWN0X0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODkyYjdmMTUtMTJmZi00MDlhLTlkOWItNTg0MzIzN2FiM2E1JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY29udGFjdF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY29udGFjdCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY29udGFjdCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNvbnRhY3QodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NvbnRhY3RfSW5jaWRlbnRzKCkgewoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3RfSW5jaWRlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcl9Hcm91cF9NZW1iZXJzICoqLwoJdXNlcl9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzkwMzI5ZDYyLTZkNmEtNGIxNS1iYTYxLWZkNWI3NmI3NjcxOScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll91c2VyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VzZXJfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAidXNlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcl9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ1c2VyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnVzZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzLnB1c2goLi4udik7CgkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3VzZXJfR3JvdXBfTWVtYmVycygpIHsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0ID0gbnVsbDsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyX0dyb3VwX01lbWJlcnMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl91c2VybmFtZV9zZXQsCgoJCQl0aGlzLl9wYXNzd29yZF9zZXQsCgoJCQl0aGlzLl9kZXBhcnRtZW50X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCwKCgkJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0LAoKCQkJdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0LAoKCQkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX3VzZXJuYW1lX3NldCA9IHRoaXMuX3VzZXJuYW1lX3NldDsKCQlyZXQuX3VzZXJuYW1lX2Nvb3AgPSB0aGlzLl91c2VybmFtZV9jb29wOwoJCXJldC51c2VybmFtZSA9IHRoaXMudXNlcm5hbWUoKSA/IHRoaXMudXNlcm5hbWUoKSA6IHRoaXMudXNlcm5hbWUoKTsKCgkJcmV0Ll9wYXNzd29yZF9zZXQgPSB0aGlzLl9wYXNzd29yZF9zZXQ7CgkJcmV0Ll9wYXNzd29yZF9jb29wID0gdGhpcy5fcGFzc3dvcmRfY29vcDsKCQlyZXQucGFzc3dvcmQgPSB0aGlzLnBhc3N3b3JkKCkgPyB0aGlzLnBhc3N3b3JkKCkgOiB0aGlzLnBhc3N3b3JkKCk7CgoJCXJldC5fZGVwYXJ0bWVudF9zZXQgPSB0aGlzLl9kZXBhcnRtZW50X3NldDsKCQlyZXQuX2RlcGFydG1lbnRfY29vcCA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQlyZXQuZGVwYXJ0bWVudCA9IHRoaXMuZGVwYXJ0bWVudCgpID8gdGhpcy5kZXBhcnRtZW50KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZGVwYXJ0bWVudCgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQubWFuYWdlcl9EZXBhcnRtZW50cyA9IHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNhbGxlcl9JbmNpZGVudHMgPSB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5jb250YWN0X0luY2lkZW50cyA9IHRoaXMuY29udGFjdF9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC51c2VyX0dyb3VwX01lbWJlcnMgPSB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkidXNlcm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJwYXNzd29yZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlpZiAoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiAhc2FsZXNub3cuX190b2tlbiAmJiB0aGlzLlRlc3RbJ19hdXRob3JpemUudXNlcm5hbWUnXSkgewoJCQl1c2VybmFtZSA9IHRoaXMuVGVzdFsnX2F1dGhvcml6ZS51c2VybmFtZSddOwoJCQlwYXNzd29yZCA9IHRoaXMuVGVzdFsnX2F1dGhvcml6ZS5wYXNzd29yZCddOwoJCX0KCgkJaWYgKGJTZXJ2ZXIpIHsKCQkJaWYgKHVzZXJuYW1lICYmICFzYWxlc25vdy5fdGVzdFVzZXIpIHsKCQkJCXNhbGVzbm93Ll90ZXN0VXNlciA9IGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2Zyb21Eb2N1bWVudCh0aGlzLlRlc3RbJ19hdXRob3JpemUudGVzdFVzZXInXSB8fCB7fSkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS5zdG9yZSgpOwoJCQl9CgkJCWxldCByZXQgPSBhd2FpdCB0aGlzLnVzZXJuYW1lKHVzZXJuYW1lLCAnPScpLnBhc3N3b3JkKHBhc3N3b3JkLCAnPScpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VydmVyOiAiICsgYlNlcnZlciArICIsIE9iajoiLCByZXQpOwoKCQkJaWYgKHJldCkgewoJCQkJaWYgKHR5cGVvZihqc29ud2VidG9rZW4pICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IGpzb253ZWJ0b2tlbi5zaWduKHJldC5fdG9Eb2N1bWVudCgpLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgewoJCQkJCQlleHBpcmVzSW46ICcxODAwcycKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShyZXQuX3RvRG9jdW1lbnQoKSkpOwoJCQkJfQoJCQl9CgoJCQlyZXQgPSB7CgkJCQlhY2Nlc3NfdG9rZW46IHJldCwKCQkJfTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VydmVyOiAiICsgYlNlcnZlciArICIsIHRva2VuOiAiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCWxldCBjbGllbnRfaWQgPSB0aGlzLl9fY29uZmlnKCdjbGllbnRfaWQnKTsKCQkJbGV0IGNsaWVudF9zZWNyZXQgPSB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKTsKCgkJCWlmICghdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIHNhbGVzbm93Ll9fdG9rZW4pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19hdXRob3JpemUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIHVzZXJuYW1lL3Bhc3N3b3JkIGFuZCB0b2tlbiBhbHJlYWR5IGV4aXN0cyIpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzYWxlc25vdy5fX3Rva2VuID0gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLmF1dGhvcml6ZSgpOwoKCQl9CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZGVwYXJ0bWVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZGVwYXJ0bWVudCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLmRlcGFydG1lbnRfVXNlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9zZXJ2ZXIob3B0aW9ucyA9IHt9KSB7CgkJaWYgKG9wdGlvbnMuY2xlYXJDb25zb2xlICYmIHR5cGVvZihjbGVhcikgIT09ICd1bmRlZmluZWQnKSBjbGVhcigpOwoKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHNhbGVzbm93LmhyZWZzKSB7CgkJCWZvciBhd2FpdCAoY29uc3QgbCBvZiBzYWxlc25vdy5ocmVmcy5tYXAobiA9PiBuLmxpYikpIHsKCQkJCWF3YWl0IHRoaXMucmVxdWlyZShsLCBzYWxlc25vdy5ocmVmcyk7CgkJCX0KCQl9CgoJCWxldCBzZWN1cmUgPSB0aGlzLl9fY29uZmlnKCdzZWN1cmUnKTsKCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIGdsb2JhbHMKCQkJdmFyIGdsb2JhbE1vZHVsZXMgPSB7CgkJCQlleHByZXNzOiAnZXhwcmVzcycsCgkJCQlodHRwczogJ2h0dHBzJywKCQkJCWh0dHA6ICdodHRwJywKCQkJCXNlbGZzaWduZWQ6ICdzZWxmc2lnbmVkJywKCQkJCXV0aWw6ICd1dGlsJywKCQkJCWNvcnM6ICdjb3JzJywKCQkJCWJvZHlQYXJzZXI6ICdib2R5LXBhcnNlcicsCgkJCQlheGlvczogJ2F4aW9zJywKCQkJCS8vY3J5cHRvOiAnY3J5cHRvJywKCQkJCW9zOiAnb3MnLAoJCQkJRG90T2JqZWN0OiAnZG90LW9iamVjdCcsCgoJCQkJbWluaW1pc3Q6ICdtaW5pbWlzdCcsCgoJCQkJZnM6ICdmcycsCgoJCQkJanNvbndlYnRva2VuOiAnanNvbndlYnRva2VuJywKCgkJCQlzcWxpdGU6ICdzcWxpdGUzJywKCQkJCW15c3FsOiAnbXlzcWwnLAoKCQkJfTsKCgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIm5wbSBpbnN0YWxsICIgKyBPYmplY3QudmFsdWVzKGdsb2JhbE1vZHVsZXMpLmpvaW4oJyAnKSk7CgkJCWxldCBtaXNzaW5nR2xvYmFsTW9kdWxlcyA9IE9iamVjdC5lbnRyaWVzKGdsb2JhbE1vZHVsZXMpLm1hcChlID0+IHsKCQkJCXRyeSB7CgkJCQkJZ2xvYmFsW2VbMF1dID0gcmVxdWlyZShlWzFdKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCQkJcmV0dXJuIGVbMV07CgkJCQl9CgkJCX0pLmZpbHRlcihlID0+IGUpOwoJCQlpZiAobWlzc2luZ0dsb2JhbE1vZHVsZXMubGVuZ3RoKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJucG0gaW5zdGFsbCAiICsgbWlzc2luZ0dsb2JhbE1vZHVsZXMuam9pbignICcpKTsKCQl9CgoJCWlmIChvcHRpb25zLmluaXRTZWxmKSB7CgkJCWlmICh0aGlzLmluaXQpIHsKCQkJCWF3YWl0IHRoaXMuX3dhaXQoNTAwKTsKCQkJCWlmIChvcHRpb25zLmxvYWRUb29scykgYXdhaXQgdGhpcy5fbG9hZFRvb2xzKG9wdGlvbnMuc2F2ZVRvb2xzKTsKCgkJCQlhd2FpdCB0aGlzLmluaXQoKTsKCgkJCQlsZXQgc3FsVG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQuX19kbWxTdGF0ZW1lbnRzKTsKCQkJCWlmIChvcHRpb25zLmNvcHlETUwgJiYgc3FsVG9vbCkgewoJCQkJCWxldCBkbWxzID0gc3FsVG9vbC5fX2RtbFN0YXRlbWVudHM7CgkJCQkJaWYgKHNxbFRvb2wudHlwZS5uYW1lID09ICdTcWxEQicpIGRtbHMgPSBbIC8qIkN1c3RvbWVycyIsICJPcmRlcnMiLCAiU2hpcHBpbmdzIiwgKi8gImRlbW8iXS5tYXAodCA9PiBgZHJvcCB0YWJsZSBpZiBleGlzdHMgJHt0fWApLmNvbmNhdChkbWxzKTsKCQkJCQlfRnJFTUQuX2NvcHlUZXh0VG9DbGlwYm9hcmQoZG1scy5qb2luKCc7XG4nKSk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIHJlZnJlc2ggc2NyaXB0CgkJdGhpcy5zZXRJbnRlcnZhbChhc3luYyAocykgPT4gewoJCQlzYWxlc25vdy5fX0NvbnRlbnQgPSBzYWxlc25vdy5fX0NvbnRlbnQgfHwgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5uYW1lKCdBUEkgU2VydmVyJykuY29kZSgnYXBpc2VydmVyJyk7CgkJCWxldCBjdCA9IGF3YWl0IHNhbGVzbm93Ll9fQ29udGVudC5maW5kKCk7CgkJCWlmICghY3QpIHJldHVybjsKCgkJCWlmICgoKGN0LmRhdGUoKS5nZXRUaW1lKCkgLSBzYWxlc25vdy5fX0NvbnRlbnQuZGF0ZSgpLmdldFRpbWUoKSkgLyAxMDAwKSA+IDUpIHsKCQkJCWF3YWl0IGN0LnN0b3JlKCk7CgoJCQkJc2FsZXNub3cuX19Db250ZW50LmRhdGUoY3QuZGF0ZSgpKTsKCQkJCXNhbGVzbm93Ll9fQ29udGVudC5jb250ZW50KG51bGwpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0sIDAuNSwgKHR5cGVvZihwcm9jZXNzKSAhPT0gJ3VuZGVmaW5lZCcgJiYgcHJvY2Vzcy5hcmd2LnNsaWNlKDIpLmxlbmd0aCkgPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMilbMF0gOiAnc2FsZXNub3cnKTsKCgkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQljb25zdCBhcHAgPSBleHByZXNzKCk7CgoJCQlhcHAudXNlKGNvcnMoKSk7CgoJCQlhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7CgkJCQlleHRlbmRlZDogdHJ1ZSwKCQkJCWxpbWl0OiAnNTBtYicKCQkJfSkpOwoJCQlhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7CgkJCQl2ZXJpZnk6IChyZXEsIHJlcywgYnVmKSA9PiByZXEucmF3Qm9keSA9IGJ1ZgoJCQl9KSk7CgoJCQlnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7CgkJCQljb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTsKCQkJCWNvbnN0IHRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07CgoJCQkJaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOwoKCQkJCWpzb253ZWJ0b2tlbi52ZXJpZnkodG9rZW4sIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCAoZXJyLCBvYmopID0+IHsKCQkJCQlpZiAoZXJyKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAzKTsKCgkJCQkJcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsKCQkJCQluZXh0KCk7CgkJCQl9KTsKCQkJfTsKCgkJCWFwcC5wb3N0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoJCQlhcHAuZ2V0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoKCQkJYXBwLnBvc3QoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7CgkJCWFwcC5nZXQoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKSB7CgkJCQlzYWxlc25vdy50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsKCQkJCQlzZXJ2aWNlOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JyksCgkJCQkJYXV0aDogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpID8gewoJCQkJCQl1c2VyOiB0aGlzLl9fY29uZmlnKCdlbWFpbC51c2VyJyksCgkJCQkJCXBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksCgkJCQkJfSA6IHVuZGVmaW5lZCwKCQkJCX0pOwoKCQkJCS8qCgkJCQlhd2FpdCBzYWxlc25vdy50cmFuc3BvcnRlci5zZW5kTWFpbCh7CgkJCQkgICAgZnJvbTogdGhpcy5fX2NvbmZpZygnZW1haWwuc2VuZGVyJyksCgkJCQkgICAgdG8sCgkJCQkgICAgc3ViamVjdCwKCQkJCSAgICB0ZXh0LAoJCQkJfSk7CgkJCQkqLwoJCQl9CgoJCQlsZXQgcG9ydCA9IHNhbGVzbm93Ll9ub2RlID8gKHNhbGVzbm93Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKSA6IDMwMDA7CgkJCWxldCBhZGRyZXNzID0gIjAuMC4wLjAiOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ0NPUlNQcm94eScpKSB7CgkJCQljb3JzX3Byb3h5LmNyZWF0ZVNlcnZlcih7CgkJCQkJb3JpZ2luV2hpdGVsaXN0OiBbXSwgLy8gQWxsb3cgYWxsIG9yaWdpbnMKCQkJCQlyZXF1aXJlSGVhZGVyOiBbJ29yaWdpbicsICd4LXJlcXVlc3RlZC13aXRoJ10sCgkJCQkJcmVtb3ZlSGVhZGVyczogWydjb29raWUnLCAnY29va2llMiddCgkJCQl9KS5saXN0ZW4oODAwMCwgYWRkcmVzcywgZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ1J1bm5pbmcgQ09SUyBBbnl3aGVyZSBvbiAnICsgYWRkcmVzcyArICc6JyArICc4MDAwJyk7CgkJCQl9KTsKCQkJfQoKCQkJbGV0IGxpc3RlbiA9IGFzeW5jICgpID0+IHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgYHNhbGVzbm93WyR7dGhpcy5pcEFkZHJlc3MoKX1dIGxpc3RlbmluZyBhdCBodHRwJHtzZWN1cmU/J3MnOicnfTovLyR7YWRkcmVzc306JHtwb3J0fWApOwoJCQlpZiAoc2VjdXJlKSB7CgkJCQlsZXQgY2VydCA9IG51bGw7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSkgewoJCQkJCWNlcnQgPSB7CgkJCQkJCXByaXZhdGU6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKSksCgkJCQkJCWNlcnQ6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUuY2VydCcpKSksCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJY2VydCA9IHNlbGZzaWduZWQuZ2VuZXJhdGUoW3sKCQkJCQkJbmFtZTogJ2NvbW1vbk5hbWUnLAoJCQkJCQl2YWx1ZTogJ25hbW1vdXIuY29tJwoJCQkJCX1dLCB7CgkJCQkJCWRheXM6IDM2NQoJCQkJCX0pOwoJCQkJfQoJCQkJZ2xvYmFsLmV4U2VydmVyID0gaHR0cHMuY3JlYXRlU2VydmVyKHsKCQkJCQlrZXk6IGNlcnQucHJpdmF0ZSwKCQkJCQljZXJ0OiBjZXJ0LmNlcnQKCQkJCX0sIGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7CgkJCX0gZWxzZSB7CgkJCQlnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApLmxpc3Rlbihwb3J0LCBhZGRyZXNzLCBsaXN0ZW4pOwoJCQl9CgkJfQoJfQoKCWFzeW5jIF9pbmJvdW5kQ2FsbChyZXEsIHJlcywgY05hbWUsIG1OYW1lKSB7CgkJbGV0IHJldCA9IHt9OwoJCXRyeSB7CgkJCXJldCA9IGF3YWl0IG5ldyBzYWxlc25vd1tyZXEucGFyYW1zLmNsYXNzIHx8IGNOYW1lXSgpLl9pbnZva2UocmVxLnBhcmFtcy5tZXRob2QgfHwgbU5hbWUsIHJlcS5ib2R5LCByZXEucXVlcnksIHJlcS5fX2F1dGhvcml6YXRpb24pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbmJvdW5kQ2FsbCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCXJldCA9IHsKCQkJCUV4Y2VwdGlvbjogIkV4Y2VwdGlvbjogIiArIGV4LAoJCQl9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmVxLnF1ZXJ5WyJqc29uIl0gIT0gInRydWUiICYmIHJlcS5ib2R5ICYmIHJlcS5ib2R5Ll9fZmxhdHRlZCkgcmV0ID0gewoJCQlfX2ZsYXR0ZWQ6IEZsYXR0ZWQuc3RyaW5naWZ5KHJldCkKCQl9OwoKCQlpZiAocmV0ICYmIHR5cGVvZihyZXQpID09PSAibnVtYmVyIikgcmV0ID0gcmV0LnRvU3RyaW5nKCk7CgkJcmVzLnNlbmQocmV0KTsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJpbml0IjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJhdXRob3JpemUiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Vc2VyLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImF1dGhvcml6ZSI6IHsKCgkJCQlzYWxlc25vdy5fX3Rva2VuID0gewoJCQkJCXRva2VuX3R5cGU6ICJCZWFyZXIiLAoJCQkJCWFjY2Vzc190b2tlbjogcmV0CgkJCQl9OwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbml0IjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJhdXRob3JpemUiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFVzZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBVc2VyLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJaWYgKHNhbGVzbm93LlRvb2xzICYmIHNhbGVzbm93LlRvb2xzLmxlbmd0aCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogVG9vbHMgYWxyZWFkeSBsb2FkZWRgKTsKCQkJcmV0dXJuIHNhbGVzbm93LlRvb2xzOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IExvYWRpbmcgdG9vbHMuLi5gKTsKCgkJZGVsZXRlIHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzOwoJCWRlbGV0ZSBzYWxlc25vdy5fX2NvbmZpZzsKCgkJbGV0IHRvb2xzID0gW3sKCQkJdHlwZTogewoJCQkJbmFtZTogIlNxbERCIiwKCQkJfSwKCQkJdG9vbF9Db25maWdzOiBbewoJCQkJbmFtZTogImNyZWF0ZSIsCgkJCQl2YWx1ZTogMywKCQkJfSwgewoJCQkJbmFtZTogInR5cGUiLAoJCQkJdmFsdWU6ICJzcWxpdGUiLAoJCQl9LCB7CgkJCQluYW1lOiAiU3luY0VudGl0eUF0dHJpYnV0ZXMiLAoJCQkJdmFsdWU6IHRydWUsCgkJCX0sIHsKCQkJCW5hbWU6ICJTeW5jVHlwZWRBdHRyaWJ1dGVzIiwKCQkJCXZhbHVlOiB0cnVlLAoJCQl9XQoJCX1dOwoKCQl0cnkgewoJCQlsZXQgZk5hbWUgPSAiQVBJU0VSVkVSX19sb2FkVG9vbHMuanNvbiI7CgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZnMuZXhpc3RzU3luYyhmTmFtZSkpIHRvb2xzID0gdGhpcy5ydW5TY3JpcHQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZk5hbWUpKSB8fCB0b29sczsKCQkJaWYgKHRoaXMuX19jb25maWcoImdpdGh1Yi50b29scyIpKSB0b29scyA9IHRoaXMucnVuU2NyaXB0KGF3YWl0IGF4aW9zLmdldCh0aGlzLl9fY29uZmlnKCJnaXRodWIudG9vbHMiKSArIGZOYW1lLCB7CgkJCQl2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1cyA8IDUwMAoJCQl9KS5kYXRhKSB8fCB0b29sczsKCgkJCWxldCB0RGF0YSA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkpIHREYXRhID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCB7CgkJCQlOYW1lOiBmTmFtZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUKCQkJfSk7CgkJCWlmICghdERhdGEpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBub3QgaW4gQ01TYCk7CgkJCX0gZWxzZSB7CgkJCQl0b29scyA9IHRoaXMucnVuU2NyaXB0KHREYXRhLlNjcmlwdCkgfHwgdG9vbHM7CgkJCX0KCgkJCXRvb2xzID0gc2FsZXNub3cuX19Ub29scyB8fCB0b29sczsKCQkJZGVsZXRlIHNhbGVzbm93Ll9fVG9vbHM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJfQoKCQl0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodC5hY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCAodHlwZW9mKHQuYWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgJiYgdC5hY3RpdmUpKS5mb3JFYWNoKHQgPT4gewoJCQl0Lm5hbWUgPSB0Lm5hbWUgfHwgdC50eXBlLm5hbWU7CgoJCQl0LmFjdGl2ZSA9IHR5cGVvZih0LmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gdC5hY3RpdmUgOiB0cnVlOwoJCQl0LmVuYWJsZWQgPSB0eXBlb2YodC5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LmVuYWJsZWQgOiB0cnVlOwoJCQl0LnR5cGUuYWN0aXZlID0gdHlwZW9mKHQudHlwZS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IHQudHlwZS5hY3RpdmUgOiB0cnVlOwoJCQl0LnR5cGUuZW5hYmxlZCA9IHR5cGVvZih0LnR5cGUuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gdC50eXBlLmVuYWJsZWQgOiB0cnVlOwoKCQkJdC50b29sX0NvbmZpZ3MgPSB0LnRvb2xfQ29uZmlncyB8fCBbXTsKCQkJdC50b29sX0NvbmZpZ3MuZm9yRWFjaChjID0+IHsKCQkJCWMuYWN0aXZlID0gdHlwZW9mKGMuYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmFjdGl2ZSA6IHRydWU7CgkJCQljLmVuYWJsZWQgPSB0eXBlb2YoYy5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmVuYWJsZWQgOiB0cnVlOwoJCQl9KTsKCgkJCXQudHlwZS50eXBlX0NvbmZpZ3MgPSB0LnR5cGUudHlwZV9Db25maWdzIHx8IFtdOwoJCQl0LnR5cGUudHlwZV9Db25maWdzLmZvckVhY2goYyA9PiB7CgkJCQljLmFjdGl2ZSA9IHR5cGVvZihjLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gYy5hY3RpdmUgOiB0cnVlOwoJCQkJYy5lbmFibGVkID0gdHlwZW9mKGMuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gYy5lbmFibGVkIDogdHJ1ZTsKCQkJfSk7CgoJCQl0LnR5cGUudHlwZV9NYXBwaW5ncyA9IHQudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdOwoJCQl0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gewoJCQkJbS5hY3RpdmUgPSB0eXBlb2YobS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IG0uYWN0aXZlIDogdHJ1ZTsKCQkJCW0uZW5hYmxlZCA9IHR5cGVvZihtLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IG0uZW5hYmxlZCA6IHRydWU7CgkJCQltLnR5cGUgPSB7CgkJCQkJbmFtZTogdC50eXBlLm5hbWUKCQkJCX07CgkJCX0pOwoKCQkJdC50b29sX01hcHBpbmdzID0gdC50b29sX01hcHBpbmdzIHx8IFtdOwoJCQl0LnRvb2xfTWFwcGluZ3MuZm9yRWFjaChtID0+IHsKCQkJCW0uYWN0aXZlID0gdHlwZW9mKG0uYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmFjdGl2ZSA6IHRydWU7CgkJCQltLmVuYWJsZWQgPSB0eXBlb2YobS5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmVuYWJsZWQgOiB0cnVlOwoJCQkJbS50b29sID0gewoJCQkJCW5hbWU6IHQubmFtZQoJCQkJfTsKCQkJfSk7CgkJfSk7CgkJdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJbE5PVDFkUFQwSWlMQ0pUWVd4bGMwWnZjbU5sSWl3aVIybDBTSFZpSWl3aVJtbHNaVk41YzNSbGJTSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KS5maW5kKF90ID0+ICh0eXBlb2YoX3QpID09PSAnc3RyaW5nJyA/IF90IDogX3QubmFtZSkgPT0gdC5uYW1lKSk7CgoJCXRvb2xzLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7CgkJCURvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpICE9PSAib2JqZWN0IikuY29uY2F0KERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSA9PT0gIm9iamVjdCIpLm1hcChjID0+IE9iamVjdC5rZXlzKGMudmFsdWUpLm1hcChuY29kZSA9PiB7CgkJCQlsZXQgX2MgPSB7CgkJCQkJbmFtZTogYy5uYW1lLAoJCQkJCXZhbHVlOiBjLnZhbHVlW25jb2RlXSwKCQkJCX07CgkJCQlpZiAobmNvZGUgIT0gImRlZmF1bHQiKSB7CgkJCQkJX2Mubm9kZSA9IHsKCQkJCQkJY29kZTogbmNvZGUsCgkJCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCQkJZW5hYmxlZDogZmFsc2UsIC8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMKCQkJCQkJdHlwZTogewoJCQkJCQkJbmFtZTogIk5vZGVKUyIsCgkJCQkJCX0KCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuIF9jOwoJCQl9KS5mbGF0KCkpLmZsYXQoKSksIHQpOwoJCQlEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5mb3JFYWNoKGMgPT4gYy52YWx1ZSA9IEpTT04uc3RyaW5naWZ5KGMudmFsdWUpKTsKCQl9KSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBhcmUgJHt0b29scy5sZW5ndGh9YCk7CgoJCXNhbGVzbm93LlRvb2xzID0gdG9vbHM7CgoJCXNhbGVzbm93LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zKS5mb3JFYWNoKHQgPT4gewoJCQl0LmF4aW9zID0gYXhpb3MuY3JlYXRlKCk7CgkJCXQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKGFzeW5jIGNvbmZpZyA9PiB7CgkJCQl0cnkgewoJCQkJCWNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307CgkJCQkJY29uZmlnLm1ldGEuY291bnRlciA9IDQ7CgoJCQkJCWxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pOwoJCQkJCWxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgYXV0aFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhvcml6ZS51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQsCgkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJfSk7CgkJCQkJaWYgKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKSA8IDApIHsKCQkJCQkJaWYgKCF0b2tlbiAmJiBzYWxlc25vdy5fbm9kZSkgewoJCQkJCQkJbGV0IGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgkJCQkJCQlsZXQgYXV0aE1ldGhvZCA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5tZXRob2QnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgoJCQkJCQkJaWYgKGF1dGhNZXRob2QpIHsKCQkJCQkJCQlsZXQgZmxvdyA9ICghYXV0aENvZGUgJiYgYXV0aE1ldGhvZCA9PSAncG9zdCcpID8gJ2F1dGhvcml6ZScgOiAndG9rZW4nOwoJCQkJCQkJCS8vIGdldCB0aGUgdG9rZW4KCQkJCQkJCQkvLyB0aGUgdG9rZW5VcmkgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQoJCQkJCQkJCXRva2VuVXJpID0gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS51cmlgLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQl9KTsKCQkJCQkJCQlsZXQgdGNvbmZpZyA9IHsKCQkJCQkJCQkJdXJsOiB0b2tlblVyaSwKCQkJCQkJCQkJbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0JywgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KSwKCQkJCQkJCQkJaGVhZGVyczogT2JqZWN0LmFzc2lnbih7CgkJCQkJCQkJCQkiQ29udGVudC1UeXBlIjogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5jb250ZW50X3R5cGVgLCAidGV4dC9qc29uIiwgewoJCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJCX0pLAoJCQkJCQkJCQkJIkF1dGhvcml6YXRpb24iOiAiQmFzaWMgIiArIHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7CgkJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQkJfSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHsKCQkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCQl9KSksCgkJCQkJCQkJCX0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHsKCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJfSkpLAoJCQkJCQkJCQlkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7CgkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCX0pLAoJCQkJCQkJCX07CgkJCQkJCQkJbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOwoJCQkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgIlRva2VuIGZldGNoZWQiLCBmbG93LCB0Y29uZmlnLCB0cmVzLmRhdGEpOwoJCQkJCQkJCVsnYWNjZXNzX3Rva2VuJywgJ3Rva2VuX3R5cGUnLCAnZXhwaXJlc19pbicsICdyZWZyZXNoX3Rva2VuJ10uZm9yRWFjaCh0YSA9PiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke3RhfWAsIG51bGwsIHsKCQkJCQkJCQkJdG9vbDogdCwKCQkJCQkJCQkJbm9kZTogc2FsZXNub3cuX25vZGUsCgkJCQkJCQkJCW5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KV0KCQkJCQkJCQl9KSk7CgkJCQkJCQkJdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQsCgkJCQkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKHRva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW5fdHlwZSIsICJCZWFyZXIiLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICsgIiAiICsgdG9rZW47CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDIsICJheGlvcy5yZXF1ZXN0IiwgZXgpOwoJCQkJfQoJCQkJcmV0dXJuIGNvbmZpZzsKCQkJfSwgYXN5bmMgZXJyb3IgPT4ge30pOwoJCQl0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gewoJCQkJcmV0dXJuIHJlc3BvbnNlOwoJCQl9LCBhc3luYyBlcnJvciA9PiB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsICJheGlvcyByZXNwb25zZSBlcnJvciIsIGVycm9yKTsKCQkJCXRyeSB7CgkJCQkJY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOwoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICYmIGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxICYmICFvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ICYmIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24uaW5kZXhPZih0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pKSA+IDApIHsKCQkJCQkJb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSA9IHRydWU7CgkJCQkJCS8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpCgoJCQkJCQlvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3R5cGUiLCAiQmVhcmVyIiwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSArICIgIiArIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7CgkJCQkJfQoJCQkJCXJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMiwgIlJlc3AgSW50ZXJjZXB0b3IiLCBleCwgZXJyb3IpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiRXhpdGluZyIpOwoJCXJldHVybiB0b29sczsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQl0cnkgewoJCQlpZiAodHlwZW9mKHN0cikgIT09ICdzdHJpbmcnKSByZXR1cm4gc3RyOwoJCQlsZXQgcmV4ID0gYCR7cHJlZml4fShbXiR7cG9zdGZpeH1dKykke3Bvc3RmaXh9YDsKCQkJKHN0ci5tYXRjaChuZXcgUmVnRXhwKHJleCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiBzdHIgPSBzdHIucmVwbGFjZShtLCBtID0+IGZ1bihtLnJlcGxhY2UocHJlZml4LCAnJykucmVwbGFjZShwb3N0Zml4LCAnJykpKSk7CgoJCQlyZXR1cm4gc3RyOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19wYXJhbWV0cml6ZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgdGhpcy5kZXBhcnRtZW50KCkpIHRoaXMuZGVwYXJ0bWVudCgpLl9fc3luY19vbihkKTsKCgkJCS8vIHRoaXMubWFuYWdlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmNhbGxlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmNvbnRhY3RfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy51c2VyX1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcih0aGlzLklkKQoKCQkJLnVzZXJuYW1lKHRoaXMudXNlcm5hbWUoKSwgdGhpcy5fdXNlcm5hbWVfY29vcCkKCgkJCS5wYXNzd29yZCh0aGlzLnBhc3N3b3JkKCksIHRoaXMuX3Bhc3N3b3JkX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudCh0aGlzLmRlcGFydG1lbnQoKSwgdGhpcy5fZGVwYXJ0bWVudF9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5tYW5hZ2VyX0RlcGFydG1lbnRzKHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpLCB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3ApCgoJCQkuY2FsbGVyX0luY2lkZW50cyh0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSwgdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wKQoKCQkJLmNvbnRhY3RfSW5jaWRlbnRzKHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSwgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCkKCgkJCS51c2VyX0dyb3VwX01lbWJlcnModGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSwgdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnVXNlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKa1pYQmhjblJ0Wlc1MElqb2lSR1Z3WVhKMGJXVnVkQ0o5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXRyeSB7CgkJCWlmIChBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSk7CgoJCQlsZXQgc0ZpZWxkID0gYlJldmVyc2UgPyAndGFyZ2V0JyA6ICdzb3VyY2UnOwoJCQlsZXQgc1NjcmlwdCA9IChiUmV2ZXJzZSA/ICdvdXQnIDogJ2luJykgKyAnU2NyaXB0JzsKCQkJbGV0IHNDb25kID0gKGJSZXZlcnNlID8gJ291dCcgOiAnaW4nKSArICdDb25kaXRpb24nOwoJCQlsZXQgdEZpZWxkID0gYlJldmVyc2UgPyAnc291cmNlJyA6ICd0YXJnZXQnOwoJCQlsZXQgdFNjcmlwdCA9IChiUmV2ZXJzZSA/ICdpbicgOiAnb3V0JykgKyAnU2NyaXB0JzsKCQkJbGV0IHRDb25kID0gKGJSZXZlcnNlID8gJ2luJyA6ICdvdXQnKSArICdDb25kaXRpb24nOwoKCQkJbGV0IF9tYXRjaCA9IChzLCByKSA9PiB7CgkJCQlsZXQgYW5zd2VyID0gcy5tYXRjaChuZXcgUmVnRXhwKHIsICdnJykpOwoJCQkJcmV0dXJuIHMgPT0gciB8fCAoKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKSA/IHRydWUgOiBmYWxzZSk7CgkJCX0KCgkJCWxldCB0ZXN0ID0gbSA9PiAoewoJCQkJdmFsaWQ6IG0uYWN0aXZlICYmIG0uZW5hYmxlZCwKCQkJCWNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLAoJCQkJY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwKCQkJCXNGaWVsZDogdHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJyB8fCBfbWF0Y2goY29kZSwgbVtzRmllbGRdKSwKCQkJCXNTY3JpcHQ6IHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pICE9PSAndW5kZWZpbmVkJywKCQkJCXRhcmdldDogKG1bdEZpZWxkXSB8fCBtW3RTY3JpcHRdKSAhPSBudWxsLAoJCQkJdGV4dDogY29kZSArICcsJyArIHNGaWVsZCArICcsJyArIHRGaWVsZCwKCQkJfSk7CgoJCQlsZXQgbXMgPSAodG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pOwoKCQkJbXMgPSBtcy5maWx0ZXIobSA9PiB0ZXN0KG0pLnZhbGlkICYmIHRlc3QobSkuY29udGV4dCAmJiB0ZXN0KG0pLmNsYXNzICYmICh0ZXN0KG0pLnNGaWVsZCB8fCB0ZXN0KG0pLnNTY3JpcHQpICYmIHRlc3QobSkudGFyZ2V0KS5zb3J0KG0gPT4gLW0ub3JkZXIpOwoJCQlpZiAobXMubGVuZ3RoKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2NsYXNzTmFtZX0uJHtjb2RlfWAsIHRoaXMuX2JlYXV0aWZ5KG1zLm1hcChtID0+ICh7CgkJCQltLAoJCQkJdGVzdDogdGVzdChtKQoJCQl9KSksICdqYXZhc2NyaXB0JykpOwoKCQkJbXMuZmlsdGVyKG0gPT4gbVtzRmllbGRdICYmIG1bdEZpZWxkXSkuZm9yRWFjaChtID0+IHsKCQkJCWlmIChtLmNvbnRleHQgPT0gJ0VudGl0eUNsYXNzJykge30gZWxzZSBpZiAodHlwZW9mKG1bdEZpZWxkXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkvLyByZXBsYWNlCgkJCQkJaWYgKHR5cGVvZihjb2RlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKG1bc0ZpZWxkXSwgJ2cnKSwgbVt0RmllbGRdKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkvL0RvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlpZiAodHlwZW9mKGNvZGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQljb2RlID0gbVt0RmllbGRdOwoJCQkJCX0gZWxzZSB7CgkJCQkJCURvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7CgkJCQkJfQoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7Y29udGV4dH1dLyR7Y2xhc3NOYW1lfS4ke2NvZGV9OiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7CgkJCX0pOwoJCQltcy5mb3JFYWNoKG0gPT4gewoKCQkJCWlmIChtW3RTY3JpcHRdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7bS5jb250ZXh0fV0vJHttLmNsYXNzTmFtZX0uJHtjb2RlfSgke3RTY3JpcHR9KTogJHttW3RTY3JpcHRdfWAsIG0pOwoJCQkJCXRoaXMuX1NjcmlwdChgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIHNjb3BlLCBtZXRob2QsIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgPT4ge2lmKAooKG9TY29wZSkgPT4gewogICAgbGV0IHJldCA9ICR7bVt0Q29uZF19OwogICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0pKHNhbGVzbm93KQopeyR7bVt0U2NyaXB0XX19fWAsIHRTY3JpcHQsICdNYXBwaW5nJywgc2FsZXNub3csIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCB0aGlzLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCQkJCX0KCgkJCX0pOwoKCQkJaWYgKHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybiBvYmpUbzsKCQkJfQoKCQkJcmV0dXJuIGNvZGU7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVXNlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJdHJ5IHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJCW9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7CgkJCW9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJ1VzZXInOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwgb3B0aW9ucy5fdGhpcy5Ub29sIHx8IHRoaXMuVG9vbDsKCQkJaWYgKHR5cGVvZihvcHRpb25zLnRvb2wpID09PSAnb2JqZWN0JyAmJiBvcHRpb25zLnRvb2wuY29uc3RydWN0b3IubmFtZSA9PSAnVG9vbCcpIG9wdGlvbnMudG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wubmFtZSgpKTsKCgkJCWlmICh0eXBlb2Yob3B0aW9ucy50b29sKSA9PT0gJ3N0cmluZycpIG9wdGlvbnMudG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdC50eXBlLm5hbWUgPT0gb3B0aW9ucy50b29sKTsKCQkJaWYgKHR5cGVvZihvcHRpb25zLnRvb2wpICE9PSAnb2JqZWN0JykgdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgb3B0aW9ucy50b29sKTsKCQkJaWYgKCFvcHRpb25zLnRvb2wpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIG5vdCBkZWZpbmVkIiwgb3B0aW9ucy5fdGhpcy5Ub29sLCBzYWxlc25vdy5Ub29scywgb3B0aW9ucy5fdGhpcy5Ub29scyk7CgkJCS8vb3B0aW9ucy5ub0NhY2hlID0gdHJ1ZTsKCQkJaWYgKCFvcHRpb25zLm5vQ2FjaGUpIHNhbGVzbm93Ll9fY29uZmlnID0gc2FsZXNub3cuX19jb25maWcgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQlyZXQgPSBudWxsOwoKCQkJCS8vIHVzZSBzY29wZSBjYWNoZSAoaW1wcm92ZXMgcGVyZm9ybWFuY2UpCgkJCQlpZiAoIW9wdGlvbnMubm9DYWNoZSAmJiBzYWxlc25vdy5fX2NvbmZpZy5oYXNPd25Qcm9wZXJ0eShgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gKSkgcmV0dXJuIHNhbGVzbm93Ll9fY29uZmlnW2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdOwoJCQl9CgoJCQkvLyB0b29sX0NvbmZpZ3MsIHR5cGVfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWlmIChvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MgfHwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncykgewoJCQkJbGV0IGNmcyA9IFtdLmNvbmNhdChvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MpOwoJCQkJbGV0IHRjb25mID0gY2ZzLmZpbHRlcihjID0+IGMgJiYgYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KGNmcy5maWx0ZXIoYyA9PiBjICYmIGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCQlpZiAodGNvbmZbMF0uc2NyaXB0KSB7CgkJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoJHtPYmplY3Qua2V5cyhvcHRpb25zKS5qb2luKCcsICcpfSkgPT4gJHt0Y29uZlswXS5zY3JpcHR9YCkoLi4uT2JqZWN0LnZhbHVlcyhvcHRpb25zKSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQkJCXRyeSB7CgkJCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJCQl9CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQkJaWYgKG9wdGlvbnMubm9kZSkgdGMubm9kZSA9IHsKCQkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJCX07CgkJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJCXRjLm5hbWUgPSBuOwoJCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJCShvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncykucHVzaCh0Yyk7CgkJCQkJfQoJCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gb3B0aW9ucy5fdGhpcy5Db25maWcgPyBvcHRpb25zLl90aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJcmV0ID0gdGhpcy5fcGFyYW1ldHJpemUocmV0LCBwID0+IHRoaXMuX19jb25maWcocCwgbnVsbCwgb3B0aW9ucykpOwoKCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAwLCBuLCByZXQsIG9wdGlvbnMpOwoJCQlpZiAoIW9wdGlvbnMubm9DYWNoZSkgc2FsZXNub3cuX19jb25maWdbYCR7b3B0aW9ucy5fY2xhc3N9LiR7b3B0aW9ucy50b29sLm5hbWV9LiR7bklEfS4ke259YF0gPSByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLl9jbGFzcywgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpbml0LgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluaXQoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbml0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluaXQiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5pbml0Jyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJdHlwZW9mKHdpbmRvdykgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnaW5pdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm90IHJ1bm5pbmcgaW4gYSBicm93c2VyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsZXQgY29kZSA9ICcxMjMnOwoJCQlpZiAodGhpcy5zcigpLmJMb2NhbCkgewoJCQkJbGV0IG8gPSBuZXcgb1Njb3BlLkluY2lkZW50KG51bGwsICdTTk9XT09CJykuX2Zyb21Eb2N1bWVudCh7CgkJCQkJbnVtYmVyOiAiSU5DMDAwOTAwOSIsCgkJCQkJc3RhdGU6ICIxIiwKCQkJCQlwcmlvcml0eTogIjQiLAoJCQkJCWRlc2NyaXB0aW9uOiAid2hhdCBpZiIKCQkJCX0sIHRydWUpOwoJCQkJLy9sb2coby5fdG9Eb2N1bWVudCgpKTtsb2coby5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQkJby5Ub29sID0gIlNhbGVzRm9yY2UiOwoKCQkJCWxldCBzID0gby5fdG9TRlF1ZXJ5KG51bGwsIG51bGwsIHRydWUpOwoJCQkJYXdhaXQgbmV3IG9TY29wZS5Db250ZW50KG51bGwsICdHaXRIdWInKS5uYW1lKGNvZGUpLmNvZGUoY29kZSkucmVtYXJrKHMpLmVuYWJsZWQodHJ1ZSkuc3RvcmUoKTsKCQkJfSBlbHNlIHsKCQkJCWxldCBsYXN0USA9IG51bGw7CgkJCQl0aGlzLnNldEludGVydmFsKGFzeW5jIGNxID0+IHsKCQkJCQljcSA9IGF3YWl0IGNxLmZpbmQoKTsKCQkJCQlpZiAoY3EuY29udGVudCgpICE9IGxhc3RRKSB7CgkJCQkJCWxhc3RRID0gY3EuY29udGVudCgpOwoJCQkJCQlsb2coIm5ldyBxdWVyeSIpOwoJCQkJCQlhd2FpdCBuZXcgb1Njb3BlLlVzZXIobnVsbCwgJ1NhbGVzRm9yY2UnKS5fcmVzdChudWxsLCBudWxsLCBsYXN0USwgbnVsbCwgewoJCQkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJaWYgKCFjcS5lbmFibGVkKCkpIGxvZygiRXhpdGluZyBRdWVyeSBsb29wIik7CgkJCQkJcmV0dXJuIGNxLmVuYWJsZWQoKTsKCQkJCX0sIDAuNSwgbmV3IG9TY29wZS5Db250ZW50KG51bGwsICdHaXRIdWInKS5jb2RlKGNvZGUpKTsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBhdXRob3JpemUuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgYXV0aG9yaXplKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiYXV0aG9yaXplIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuYXV0aG9yaXplJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3VzZXJuYW1lX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnVXNlcm5hbWUgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMiI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3Bhc3N3b3JkX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAyIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnUGFzc3dvcmQgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRob3JpemUnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gYXdhaXQgdGhpcy5fYXV0aG9yaXplKG51bGwsIG51bGwsIHRydWUpCgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJdHJ5IHsKCQkJbGV0IElkID0gdGhpcy5JZDsKCQkJbGV0IGNvbmZpZyA9IHsKCQkJCXVybDogdGhpcy5fX2NvbmZpZyhvcHRpb25zLnVybCB8fCAncmVzdGFwaS51cmwnLCBudWxsLCBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHsKCQkJCQl0TmFtZSwKCQkJCQlfdGhpczogdGhpcy5fdG9Eb2N1bWVudCh0cnVlKQoJCQkJfSkpLAoJCQkJbWV0aG9kOiBtZXRob2QgPyBtZXRob2QgOiAoZGF0YSA/ICJwb3N0IiA6ICJnZXQiKSwKCQkJCXBhcmFtczogcGFyYW1zLAoJCQkJaGVhZGVyczogewoJCQkJCSdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsCgkJCQl9LAoJCQkJZGF0YTogZGF0YSwKCQkJfTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3Jlc3QnLCAnRW50aXR5T2JqZWN0JywgMCwgY29uZmlnKTsKCQkJbGV0IHJldCA9IFtdOwoJCQlpZiAodGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpKSByZXQgPSAoYXdhaXQgdGhpcy5Ub29sLmF4aW9zKGNvbmZpZykpLmRhdGEucmVzdWx0OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcmVzdCcsICdFbnRpdHlPYmplY3QnLCAwLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcmVzdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypVc2VyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJInVzZXJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qVXNlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ1c2VybmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudXNlcm5hbWUodGFibGVbInVzZXJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhc3N3b3JkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5wYXNzd29yZCh0YWJsZVsicGFzc3dvcmQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGVwYXJ0bWVudCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGVwYXJ0bWVudCh0YWJsZVsiZGVwYXJ0bWVudCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJaWYgKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSkgewoJCQlpZiAoIXRoaXMuVG9vbC5kYikgdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwsICIgPD09U0tJUFBFRD09PiIpOwoJCQlyZXR1cm4gW107CgkJfQoKCQlpZiAoc3FsLmluZGV4T2YoJztcbicpID4gMCkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IHNxbFMgb2Ygc3FsLnNwbGl0KCc7XG4nKSkgewoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbFMudHJpbSgpKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbGV0IF9yZXNvbHZlID0gKF9yZXQsIF9zcWwpID0+IHsKCQkJCQlpZiAoX3NxbCAmJiBfc3FsLmluZGV4T2YoJ3NlbGVjdCcpKSB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goX3NxbCk7CgkJCQkJcmV0dXJuIHJlc29sdmUoX3JldCk7CgkJCQl9CgoJCQkJbGV0IGRiID0gdGhpcy5Ub29sLmRiOwoJCQkJbGV0IHR5cGUgPSB0aGlzLl9fY29uZmlnKCd0eXBlJyk7CgoJCQkJbGV0IGZ1biA9ICIiOwoKCQkJCS8vIFF1ZXJ5IGxpc3Qgb2Ygc3RhdGVtZW50IHN0YXJ0aW5nIGtleXdvcmRzICAgICAgICAKCQkJCWxldCBxTGlzdCA9IFsic2VsZWN0IiwgImluc2VydCIsICJ1cGRhdGUiLCAiZGVsZXRlIl07CgkJCQlpZiAodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UudHJhbnNhY3Rpb25zJywgdHJ1ZSkpIHsKCQkJCQlxTGlzdCA9IHFMaXN0LmNvbmNhdChbImJlZ2luIiwgInN0YXJ0IiwgImNvbW1pdCJdKTsKCQkJCX0KCQkJCWxldCBiUXVlcnkgPSBxTGlzdC5pbmRleE9mKHNxbC5zdWJzdHJpbmcoMCwgc3FsLmluZGV4T2YoJyAnKSkudHJpbSgpLnRvTG93ZXJDYXNlKCkpID49IDA7CgoJCQkJaWYgKGJRdWVyeSkgewoJCQkJCS8vIHF1ZXJ5CgkJCQkJaWYgKHR5cGUgPT0gJ215c3FsJykgZnVuID0gJ3F1ZXJ5JzsKCQkJCQlpZiAodHlwZSA9PSAnc3FsaXRlJykgZnVuID0gJ2FsbCc7CgkJCQl9IGVsc2UgewoJCQkJCS8vIERNTAoJCQkJCWlmICh0eXBlID09ICdteXNxbCcpIGZ1biA9ICdxdWVyeSc7CgkJCQkJaWYgKHR5cGUgPT0gJ3NxbGl0ZScpIGZ1biA9ICdydW4nOwoKCQkJCQl0aGlzLlRvb2wuZG1sQ2FjaGUgPSB0aGlzLlRvb2wuZG1sQ2FjaGUgfHwge307CgkJCQkJaWYgKHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldKSByZXR1cm4gX3Jlc29sdmUoMCk7CgkJCQkJdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0gPSBzcWw7CgkJCQl9CgkJCQlpZiAodHlwZSA9PSAnc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGZ1biA9ICIiOwoJCQkJaWYgKGZ1biAmJiAhZGJbZnVuXSkgZnVuID0gIiI7CgoJCQkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zcWwnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7dHlwZX0uJHtmdW59YCwgc3FsKTsKCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMucHVzaChzcWwpOwoKCQkJCWlmIChmdW4pIHsKCQkJCQlsZXQgcmV0ID0gZGJbZnVuXShzcWwsIFtdLCAoZXJyb3IsIHJvd3MpID0+IHsKCQkJCQkJaWYgKGVycm9yKSB7CgkJCQkJCQlyZWplY3QoZXJyb3IpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJX3Jlc29sdmUocm93cywgc3FsKTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfSBlbHNlIGlmICh0eXBlID09ICdzbm93Zmxha2UnKSB7CgkJCQkJdGhpcy5Ub29sLmRiLmV4ZWN1dGUoewoJCQkJCQlzcWxUZXh0OiBzcWwsCgkJCQkJCWNvbXBsZXRlOiBmdW5jdGlvbihlcnIsIHN0bXQsIHJvd3MpIHsKCQkJCQkJCWlmIChlcnIpIHsKCQkJCQkJCQlyZWplY3QoZXJyKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJX3Jlc29sdmUocm93cywgc3FsKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQkJfSBlbHNlIGlmICh0eXBlID09ICdzcWxpdGUnKSB7CgkJCQkJLy8gc3FsaXRlIGluIHRoZSBicm93c2VyCgkJCQkJdHJ5IHsKCQkJCQkJbGV0IHJldCA9IG51bGw7CgkJCQkJCXJldCA9IGRiLmV4ZWMoc3FsKTsKCQkJCQkJaWYgKCFyZXQgfHwgIXJldC5sZW5ndGgpIHJldHVybiBfcmVzb2x2ZShyZXQsIHNxbCk7CgoJCQkJCQlyZXQgPSByZXRbMF0udmFsdWVzLm1hcChyID0+IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKHJldFswXS5jb2x1bW5zLm1hcCgoYywgaSkgPT4gW2MsIHJbaV1dKSkpKTsKCQkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCQkJCQlfcmVzb2x2ZShyZXQsIHNxbCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJcmVqZWN0KGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zcWwnLCAnRW50aXR5T2JqZWN0JywgMiwgYApFUlJPUjoKJHtleH0KCldoaWxlIFNlbmRpbmcgUXVlcnkgCiR7c3FsfQpgKTsKCQl9CgoJCS8vdGhpcyBpcyBub3QgZW5vdWdoLiBXZSBzZWxlY3Qgb3V0ZXIgam9pbnMsIHNvIHN1Yi1hdHRyaWJ1dGVzIHdpbGwgYmUgYWxzbyBudWxsLiBFaXRoZXIgcmVjdXJzaXZlIG9yIHRvIGlnbm9yZSB3aGVuIHVzZWQsIGZvciBleGFtcGxlIHRocm91Z2ggX3RvRG9jdW1lbnQKCQlmYWxzZSAmJiByZXQuZm9yRWFjaChyID0+IHsKCQkJT2JqZWN0LmtleXMocikuZm9yRWFjaChrID0+IHsKCQkJCWlmIChyW2tdID09IG51bGwpIGRlbGV0ZSByW2tdOwoJCQl9KTsKCQl9KTsKCgkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOwoJCXJldHVybiByZXQ7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSB7CgoJCXRyeSB7CgkJCXJldHVybiBgc2FsZXNub3cvJHtfY2xhc3N9LyR7b2JqW2VhQ29kZV19LmpzYDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZmlsZU5hbWUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXRyeSB7CgkJCS8vIFRvRG86IHVzZSBfcmVzdCgpIGluc3RlYWQKCQkJbGV0IGNvbmZpZyA9IHsKCQkJCW1ldGhvZDogY29udGVudCA/ICdwdXQnIDogJ2dldCcsCgkJCQl1cmw6IHRoaXMuX19jb25maWcoJ3VybCcpICsgZmlsZSwKCQkJCWhlYWRlcnM6IHsKCQkJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL3ZuZC5naXRodWIranNvbicsCgkJCQkJJ1gtR2l0SHViLUFwaS1WZXJzaW9uJzogJzIwMjItMTEtMjgnLAoJCQkJfSwKCQkJfTsKCQkJaWYgKGNvbnRlbnQpIHsKCQkJCS8vIGZpcnN0IGdldCB0aGUgc2hhIG9mIHRoZSBmaWxlCgkJCQljb25maWcuZGF0YSA9IEpTT04uc3RyaW5naWZ5KHsKCQkJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgX2dpdGh1YigpIiwKCQkJCQlzaGE6IGNvbnRlbnRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoJCQkJCWNvbnRlbnQ6IGAke3RoaXMuX2J0b2EodHlwZW9mKGNvbnRlbnQpPT09J29iamVjdCc/SlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgJ1x0Jyk6Y29udGVudCl9YCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJY29uZmlnLnZhbGlkYXRlU3RhdHVzID0gc3RhdHVzID0+IHN0YXR1cyA8IDUwMDsKCQkJfQoJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmF4aW9zKGNvbmZpZyk7CgkJCXJldCA9IHJldCA/IHJldC5kYXRhIDogbnVsbDsKCQkJaWYgKCFyZXQpIHJldHVybiByZXQ7CgoJCQlyZXQgPSBjb250ZW50ID8gcmV0LmNvbnRlbnQgOiByZXQ7CgkJCWxldCBfdGhpcyA9IHJldC5jb250ZW50ID8gSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSkgOiB0aGlzOwoJCQlfdGhpc1t0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSByZXQuc2hhOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2dpdGh1YicsICdFbnRpdHlPYmplY3QnLCAwLCBmaWxlLCBjb25maWcubWV0aG9kLCBfdGhpcyk7CgkJCXJldHVybiBfdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZ2l0aHViJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJdXNlcm5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnRGVwYXJ0bWVudCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0RlcGFydG1lbnQnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJdXNlcm5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcGFzc3dvcmQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoInVzZXJuYW1lIiwgb2JqLCB0aGlzLnVzZXJuYW1lKCkpOwoKCQlfb3B0aW9ucygicGFzc3dvcmQiLCBvYmosIHRoaXMucGFzc3dvcmQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNjRjNDA1NjgtYWY4ZS00YTcyLWI4ZDEtMTFmN2M0MTcxNWQ3IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuZGVwYXJ0bWVudCgpIHx8ICh0aGlzLmRlcGFydG1lbnQoKQoKCQkJCSYmCgkJCQkhdGhpcy5kZXBhcnRtZW50KCkuZGVwYXJ0bWVudF9Vc2VycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiZGVwYXJ0bWVudCIsIG9iaiwgdGhpcy5kZXBhcnRtZW50KCkpOwoJCX0KCgkJX29wdGlvbnMoIm1hbmFnZXJfRGVwYXJ0bWVudHMiLCBvYmosIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpKTsKCgkJX29wdGlvbnMoImNhbGxlcl9JbmNpZGVudHMiLCBvYmosIHRoaXMuY2FsbGVyX0luY2lkZW50cygpKTsKCgkJX29wdGlvbnMoImNvbnRhY3RfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCkpOwoKCQlfb3B0aW9ucygidXNlcl9Hcm91cF9NZW1iZXJzIiwgb2JqLCB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndXNlcm5hbWUnLCAncGFzc3dvcmQnLCAnZGVwYXJ0bWVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbWFuYWdlcl9EZXBhcnRtZW50cycsICdjYWxsZXJfSW5jaWRlbnRzJywgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ3VzZXJfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VybmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXNzd29yZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudCIsIG9iaik7CgoJCV9vcHRpb25zKCJtYW5hZ2VyX0RlcGFydG1lbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImNhbGxlcl9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGFjdF9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygidXNlcl9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndXNlcm5hbWUnLCAncGFzc3dvcmQnLCAnZGVwYXJ0bWVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbWFuYWdlcl9EZXBhcnRtZW50cycsICdjYWxsZXJfSW5jaWRlbnRzJywgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ3VzZXJfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidXNlcm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdXNlcm5hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudXNlcm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicGFzc3dvcmQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcGFzc3dvcmRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucGFzc3dvcmQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGVwYXJ0bWVudCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kZXBhcnRtZW50X3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kZXBhcnRtZW50KCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy51c2VybmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucGFzc3dvcmQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRlcGFydG1lbnQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJdXNlcm5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnVzZXJuYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcGFzc3dvcmQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnBhc3N3b3JkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kZXBhcnRtZW50KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQkJZGVwYXJ0bWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJuYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy51c2VybmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucGFzc3dvcmQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBhc3N3b3JkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kZXBhcnRtZW50KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kZXBhcnRtZW50fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3VzZXJuYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fdXNlcm5hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3VzZXJuYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl91c2VybmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX3VzZXJuYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl91c2VybmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcGFzc3dvcmQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcGFzc3dvcmRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9wYXNzd29yZF9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fcGFzc3dvcmRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Bhc3N3b3JkX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fcGFzc3dvcmRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Bhc3N3b3JkX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGVwYXJ0bWVudF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoIm1hbmFnZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyptYW5hZ2VyX0RlcGFydG1lbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNhbGxlci5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNhbGxlcl9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiY29udGFjdC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qY29udGFjdF9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJ1c2VyLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnVzZXJfR3JvdXBfTWVtYmVycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudXNlcm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy51c2VybmFtZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wYXNzd29yZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnBhc3N3b3JkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRlcGFydG1lbnQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGVwYXJ0bWVudH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IG9iai5kZXBhcnRtZW50ID0gdi5fdG9QYXRocygpLAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5jYWxsZXJfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmoudXNlcl9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVXNlcikgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Vc2VyID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Vc2VyKCkKCgkJCQkJLmRlcGFydG1lbnQobmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKSkKCgkJCQkJLm1hbmFnZXJfRGVwYXJ0bWVudHMobmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKSkKCgkJCQkJLmNhbGxlcl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5jb250YWN0X0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLnVzZXJfR3JvdXBfTWVtYmVycyhuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQl0cnkgewoJCQlpZiAoIXRvb2wpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiVG9vbCBpcyBudWxsIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoIXRvb2wudHlwZSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJUb29sLnR5cGUgaXMgbnVsbCIsIHRvb2wsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0b29sLmRiKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiVG9vbCBhbHJlYWR5IGNvbm5lY3RlZCEiKTsKCQkJCXJldHVybjsKCQkJfSBlbHNlIGlmIChzYWxlc25vdy5fbm9kZSAmJiAvKnNhbGVzbm93Ll9ub2RlLl9wYXJlbnRfc2V0ICYmICovIHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpLl9zYW1lTm9kZShzYWxlc25vdy5fbm9kZS5wYXJlbnQoKSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiTm9kZSBoYXMgYSB2YWxpZCBwYXJlbnQsIG5vIGxvY2FsIFNRTCBwb3NzaWJsZSIpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0b29sLl9fZG1sU3RhdGVtZW50cyA9IHRvb2wuX19kbWxTdGF0ZW1lbnRzIHx8IFtdOwoKCQkJaWYgKHRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQl0b29sOiB0b29sCgkJCQkJfSldKSB7CgkJCQkJaWYgKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQl9KV0uRGF0YWJhc2UpIHsKCQkJCQkJdG9vbC5kYiA9IG5ldyBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHRvb2wpXS5EYXRhYmFzZSh0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSkgfHwgIi4vc2FsZXNub3cuZGIiKTsKCQkJCQl9IGVsc2UgaWYgKGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQl9KV0uY3JlYXRlQ29ubmVjdGlvbikgewoJCQkJCQl0b29sLmRiID0gZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0b29sCgkJCQkJCX0pXS5jcmVhdGVDb25uZWN0aW9uKHsKCQkJCQkJCWhvc3Q6IHRoaXMuX19jb25maWcoJ3NlcnZlcicsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSwKCQkJCQkJCXVzZXI6IHRoaXMuX19jb25maWcoJ3VzZXJuYW1lJywgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJCX0pLAoJCQkJCQkJcGFzc3dvcmQ6IHRoaXMuX19jb25maWcoJ3Bhc3N3b3JkJywgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJCX0pLAoJCQkJCQkJZGF0YWJhc2U6IHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJCX0pIHx8ICJzYWxlc25vdyIsCgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgPT09ICd1bmRlZmluZWQnICYmIHRoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7CgkJCQkJCXRvb2w6IHRvb2wKCQkJCQl9KSA9PT0gJ3NxbGl0ZScpIHsKCQkJCQkvLyBzcWxpdGUgaW4gYnJvd3NlcgoJCQkJCXRvb2wuZGIgPSBuZXcgU1FMLkRhdGFiYXNlKCk7CgkJCQl9CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCQlpZiAodG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJaWYgKHR5cGVvZih0b29sLnN5c19zY29wZSkgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJLy8gdG9vbC5zeXNfc2NvcGUgPSAoYXdhaXQgdGhpcy5fcmVzdCgic3lzX2FwcCIsIHtzeXNfc2NvcGU6IHRoaXMuX19jb25maWcoInNjb3BlIiwgbnVsbCwge3Rvb2w6IHRvb2x9KSB8fCAiZ2xvYmFsIn0pKVswXS5zeXNfaWQ7CgkJCQl9CgkJCQlpZiAodHlwZW9mKHRvb2wuc3lzX3Byb3BlcnRpZXMpID09PSAidW5kZWZpbmVkIikgewoJCQkJCS8vIGxvYWRpbmcgc29tZSBwbGF0Zm9ybSBzdHVmZgoJCQkJCXRvb2wuc3lzX3Byb3BlcnRpZXMgPSB7fTsKCQkJCQlsZXQgY29uZGl0aW9uID0gT2JqZWN0LmtleXModG9vbC5zeXNfcHJvcGVydGllcykuZmlsdGVyKGsgPT4gIXRvb2wuc3lzX3Byb3BlcnRpZXNba10pLmpvaW4oJywnKTsKCQkJCQlpZiAoY29uZGl0aW9uKSB7CgkJCQkJCShhd2FpdCB0aGlzLl9yZXN0KCJzeXNfcHJvcGVydGllcyIsIHsKCQkJCQkJCW5hbWU6ICJJTiIgKyBjb25kaXRpb24KCQkJCQkJfSkpLmZvckVhY2gociA9PiB0b29sLnN5c19wcm9wZXJ0aWVzW3IubmFtZV0gPSByLnZhbHVlKTsKCQkJCQl9CgkJCQl9CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCQlpZiAodG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCQlpZiAodG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7CgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiVXNlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQl1c2VybmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudXNlcm5hbWUgPSB2ID09IHF1ZXJ5LnVzZXJuYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3VzZXJuYW1lX3NldCAmJiAhcXVlcnkuX3VzZXJuYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VybmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl91c2VybmFtZV9zZXQgJiYgcXVlcnkuX3VzZXJuYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlcm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcGFzc3dvcmQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnBhc3N3b3JkID0gdiA9PSBxdWVyeS5wYXNzd29yZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wYXNzd29yZF9zZXQgJiYgIXF1ZXJ5Ll9wYXNzd29yZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFzc3dvcmQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcGFzc3dvcmRfc2V0ICYmIHF1ZXJ5Ll9wYXNzd29yZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhc3N3b3JkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRlcGFydG1lbnQgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmRlcGFydG1lbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgIXF1ZXJ5Ll9kZXBhcnRtZW50X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kZXBhcnRtZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHF1ZXJ5Ll9kZXBhcnRtZW50X3NldCkgfHwKCgkJCQkJCSh0aGlzLmRlcGFydG1lbnQoKSAmJiAhdGhpcy5kZXBhcnRtZW50KCkuX21hdGNoZXMocXVlcnkuZGVwYXJ0bWVudCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGVwYXJ0bWVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkubWFuYWdlcl9EZXBhcnRtZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2FsbGVyX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNhbGxlcl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jb250YWN0X0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNvbnRhY3RfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnVzZXJfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IHF1ZXJ5LnVzZXJfR3JvdXBfTWVtYmVycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZGVwYXJ0bWVudDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGRlcGFydG1lbnQiKTsKCQkJCQlvYmouZGVwYXJ0bWVudCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jYWxsZXJfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jb250YWN0X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnVzZXJfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fdXNlcm5hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcGFzc3dvcmRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGVwYXJ0bWVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5kZXBhcnRtZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2FsbGVyX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpIDogInVzZXJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3VzZXJuYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy51c2VybmFtZShyZWYpOwoKCQkJfSwKCgkJCXBhc3N3b3JkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpIDogInBhc3N3b3JkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Bhc3N3b3JkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5wYXNzd29yZChyZWYpOwoKCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSA6ICJkZXBhcnRtZW50IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RlcGFydG1lbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuZGVwYXJ0bWVudCgpIHx8IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5kZXBhcnRtZW50KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZGVwYXJ0bWVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogIm1hbmFnZXJfRGVwYXJ0bWVudHMiKSkgPT4gdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjYWxsZXJfSW5jaWRlbnRzIikpID0+IHRoaXMuY2FsbGVyX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY29udGFjdF9JbmNpZGVudHMiKSkgPT4gdGhpcy5jb250YWN0X0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogInVzZXJfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJInVzZXJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSA6ICJ1c2VybmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl91c2VybmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdXNlcm5hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwYXNzd29yZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkgOiAicGFzc3dvcmQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcGFzc3dvcmRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Bhc3N3b3JkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSA6ICJkZXBhcnRtZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGVwYXJ0bWVudF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogIm1hbmFnZXJfRGVwYXJ0bWVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY2FsbGVyX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpIDogImNvbnRhY3RfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAidXNlcl9Hcm91cF9NZW1iZXJzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAoZnVuLCBjYWxsQmFjaykgPT4gewoJCQkJaWYgKHRoaXMuc19FcnJvck1lc3NhZ2VzICYmIHRoaXMuc19FcnJvck1lc3NhZ2VzLmxlbmd0aCA+IDApIHsKCQkJCQlhbGVydCgKCQkJCQkJJ1RoZSBmb2xsb3dpbmcgZXJyb3JzIHdlcmUgZm91bmQgaW4geW91ciBkYXRhOlxuJyArCgkJCQkJCXRoaXMuc19FcnJvck1lc3NhZ2VzCgkJCQkJKTsKCQkJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcyA9ICcnOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoKCQkJCXRoaXMuYnVpbGRVUkwoKTsKCgkJCQlpZiAodHlwZW9mKGRvY3VtZW50KSAhPT0gInVuZGVmaW5lZCIpKAoJCQkJCXRoaXMuZkxvYWRpbmdTdGFydCB8fAoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoZG9jdW1lbnQuYm9keSkgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnd2FpdCc7CgkJCQkJfQoJCQkJKSgpOwoKCQkJCXZhciBhcmdzID0gQXJyYXkoKTsKCQkJCWZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJYXJnc1tpIC0gMl0gPSBhcmd1bWVudHNbaV07CgkJCQl9CgoJCQkJdmFyIHBvc3REYXRhID0gdGhpcy5wYXJhbShhcmdzKTsKCQkJCWlmIChmdW4uaW5kZXhPZignLicpIDwgMCkgewoJCQkJCWZ1biA9IHRoaXMuc3lzdGVtTmFtZSArICcuJyArIGZ1bjsKCQkJCX0gZWxzZSBpZiAoZnVuLmluZGV4T2YoJy4nKSA9PSAwKSB7CgkJCQkJLy8gYSBub24tbGF5ZXIgbWV0aG9kCgkJCQkJZnVuID0gZnVuLnN1YnN0cmluZygxKTsKCQkJCX0KCgkJCQlpZiAoY2FsbEJhY2sgJiYgdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQkvL3JldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgaENvZGUgPSB0aGlzLmhhc2hDb2RlKAoJCQkJCWZ1bi5zdWJzdHJpbmcoZnVuLmluZGV4T2YoJy4nKSArIDEpICsgcG9zdERhdGEKCQkJCSk7CgoJCQkJdGhpcy5DUk5MID0gdGhpcy5DUk5MIHx8ICJcbiI7CgkJCQlwb3N0RGF0YSArPQoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknPCEtLTxwaWQ+JyArCgkJCQkJaENvZGUgKwoJCQkJCSc8L3BpZD4tLT4nICsKCQkJCQl0aGlzLkNSTkw7CgoJCQkJaWYgKGZ1bi5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHRGaW5kJykgPCAwKSB7CgkJCQkJLy8gYXZvaWQgb3ZlcndyaXRlIG9mIGFzeW5jIGNhbGxzCgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gewoJCQkJCQlVUkw6IHRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCQkJUG9zdERhdGE6IHBvc3REYXRhLAoJCQkJCQlEYXRlOiBuZXcgRGF0ZSgpLAoJCQkJCQlDYWxsQmFjazogY2FsbEJhY2ssCgkJCQkJCUNvbXBhbnk6IHR5cGVvZiBjb21wYW55ICE9PSAndW5kZWZpbmVkJyAmJiBjb21wYW55ID8gewoJCQkJCQkJQ29kZTogY29tcGFueS5Db2RlLAoJCQkJCQl9IDogbnVsbCwKCQkJCQkJVGV4dFJlc3BvbnNlOiBudWxsLAoJCQkJCQloYXNoOiBoQ29kZSwKCQkJCQl9OwoJCQkJfQoKCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgIXRoaXMuYkxvY2FsKSB7CgkJCQkJLy8gbGl2ZQoJCQkJCXRyeSB7CgkJCQkJCXZhciBfdGhlVXJsID0KCQkJCQkJCSh0aGlzLlN0b3JlIHx8CgkJCQkJCQkJJy9zdG9yZS8nICsKCQkJCQkJCQkod2luZG93LmNvbXBhbnkgJiYgd2luZG93LmNvbXBhbnkuQ29kZSA/CgkJCQkJCQkJCXdpbmRvdy5jb21wYW55LkNvZGUgKyAnLycgOgoJCQkJCQkJCQknLycpKSArCgkJCQkJCQloQ29kZSArCgkJCQkJCQknLmpzP3JhbmQ9JyArCgkJCQkJCQlNYXRoLnJhbmRvbSgpOwoJCQkJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQoKTsKCQkJCQkJdmFyIHJlc3BvbnNlVGV4dCA9IG51bGw7CgkJCQkJCWlmICghcmVxdWVzdCkgewoJCQkJCQkJdHJ5IHsKCQkJCQkJCQlyZXNwb25zZVRleHQgPSBhd2FpdCAkLmdldChfdGhlVXJsKTsKCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmVzcG9uc2VUZXh0ID0gcmVxdWVzdC5UZXh0UmVzcG9uc2U7CgkJCQkJCX0KCQkJCQkJaWYgKCFyZXNwb25zZVRleHQpIHsKCQkJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQkJCSdMaXZlIE1vZGUsIG5vIHJlc3BvbnNlIHRleHQgZm9yICcgKwoJCQkJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdC5oYXNoICsKCQkJCQkJCQknIC0gJyArCgkJCQkJCQkJdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCB0aGlzLkFjdGl2ZVJlcXVlc3QuVVJMKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQl9CgoJCQkJCQl2YXIgX3JldCA9IG51bGw7CgkJCQkJCXZhciBfZXhjZXB0aW9uID0gbnVsbDsKCQkJCQkJdHJ5IHsKCQkJCQkJCV9yZXQgPSB0aGlzLnJ1blNSU2NyaXB0KHJlc3BvbnNlVGV4dCk7CgkJCQkJCQlfZXhjZXB0aW9uID0gX3JldC5fZXhjZXB0aW9uOwoJCQkJCQkJaWYgKF9yZXQuc2VydmVyX3RpbWUpIHsKCQkJCQkJCQlsZXQgdGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIF9yZXQuc2VydmVyX3RpbWUuZ2V0VGltZSgpOwoJCQkJCQkJCXRyeSB7CgkJCQkJCQkJCXdpbmRvdy50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJX2V4Y2VwdGlvbiA9IGU7CgkJCQkJCX0KCgkJCQkJCWlmICghX3JldCAmJiAhX2V4Y2VwdGlvbikgewoJCQkJCQkJcmV0dXJuIGF3YWl0IG51bGw7IC8vdGhpcy5kb0hlYWRsZXNzQ2FsbChjYWxsQmFjayk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvL3RoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJCQkJCXRyeSB7CgkJCQkJCQkJCWNhbGxCYWNrKAoJCQkJCQkJCQkJX3JldC5yZXQgfHwgKF9leGNlcHRpb24gPyByZXNwb25zZVRleHQgOiBudWxsKSwKCQkJCQkJCQkJCV9leGNlcHRpb24KCQkJCQkJCQkJKTsKCQkJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQkJCXRoaXMuU2hvd0Vycm9yKAoJCQkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsKCQkJCQkJCQkJCWNhbGxCYWNrICsKCQkJCQkJCQkJCSdcblxuJyArCgkJCQkJCQkJCQllLm1lc3NhZ2UKCQkJCQkJCQkJKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCQkoCgkJCQkJCQkJd2luZG93LnNyLmZMb2FkaW5nRW5kIHx8CgkJCQkJCQkJKCgpID0+IHsKCQkJCQkJCQkJdGhpcy5yZXNldEN1cnNvcigpOwoJCQkJCQkJCX0pCgkJCQkJCQkpKCk7CgkJCQkJCQlyZXR1cm4gKAoJCQkJCQkJCShfcmV0ID8gX3JldC5yZXQgOiBudWxsKSB8fAoJCQkJCQkJCShfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCWNvbnNvbGUubG9nKGUpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gKGFzeW5jICgpID0+IHsKCQkJCQkJLyp0cnkgewoJCQkJCQkJbGV0IHNjb3BlID0gZnVuLnNwbGl0KCcuJylbMF0ucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxICQyJykucmVwbGFjZSgnICcsICcnKS50b0xvd2VyQ2FzZSgpOwoJCQkJCQkJbGV0IGFwaSA9IGZ1bi5zcGxpdCgnLicpWzFdLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMSAkMicpLnNwbGl0KCcgJykuc2xpY2UoMSwgLTEpLmpvaW4oJycpLnJlcGxhY2UoJyAnLCAnJyk7CgkJCQkJCQlsZXQgZk5hbWUgPSBmdW4uc3BsaXQoJy4nKVsxXS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDEgJDInKS5zcGxpdCgnICcpLnNsaWNlKC0xKVswXS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ2ZpbmRhbGwnLCAnZmluZEFsbCcpOwoJCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3dbc2NvcGVdICYmIFsnaW5zZXJ0JywgJ2RlbGV0ZScsICd1cGRhdGUnLCAnZmluZCcsICdmaW5kQWxsJ10uaW5kZXhPZihmTmFtZSkgPiAtMSkgewoJCQkJCQkJCWxldCBzQ2FsbCA9IGBhd2FpdCBuZXcgJHtzY29wZX0uJHthcGl9KCkuJHtmTmFtZX0oLi4uYXJncylgOwoJCQkJCQkJCWxldCBvID0gbmV3IHdpbmRvd1tzY29wZV1bYXBpXSgpOwoJCQkJCQkJCU9iamVjdC5rZXlzKGFyZ3NbMF0pLmZpbHRlcihrID0+IGsgIT09ICJPUEVSQVRPUlMiKS5mb3JFYWNoKGsgPT4gewoJCQkJCQkJCQlvW2sucmVwbGFjZSgvKD86Xlx3fFtBLVpdfFxiXHd8XHMrKS9nLCAobWF0Y2gsIGluZGV4KSA9PiB7CgkJCQkJCQkJCQlpZiAoK21hdGNoID09PSAwKSByZXR1cm4gIiI7CgkJCQkJCQkJCQlyZXR1cm4gaW5kZXggPT09IDAgPyBtYXRjaC50b0xvd2VyQ2FzZSgpIDogbWF0Y2gudG9VcHBlckNhc2UoKTsKCQkJCQkJCQkJfSldKGFyZ3NbMF1ba10sIGFyZ3NbMF0uT1BFUkFUT1JTPy5ba10pOwoJCQkJCQkJCX0pOwoJCQkJCQkJCWNvbnNvbGUubG9nKHNDYWxsLCBvLl90b0RvY3VtZW50KCksIGFyZ3MpOwoJCQkJCQkJCS8vcmV0dXJuIGF3YWl0IG9bZk5hbWVdKCk7CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygiXygpIEV4Y2VwdGlvbjogIiArIGV4KTsKCQkJCQkJfSovCgoJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5zZW5kWE1MKAoJCQkJCQkJdGhpcy5zclVSTCArICcmbmFtZT0nICsgZnVuLAoJCQkJCQkJcG9zdERhdGEsCgkJCQkJCQljYWxsQmFjawoJCQkJCQkpOwoJCQkJCX0pKCk7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzclVSTCkgPT4gewoJCQkJaWYgKCFzclVSTCkgewoJCQkJCXRoaXMuc3JVUkwgPSB0aGlzLiRfUkVRVUVTVCgnc3InKTsKCQkJCQlpZiAoIXRoaXMuc3JVUkwpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCQkJbGV0IGlwID0gdGhpcy5pcEFkZHJlc3MoKTsKCQkJCQkJCWlmIChpcCAmJiAoaXAuc3RhcnRzV2l0aCgiMTgyLjE2OC4iKSB8fCBpcCA9PSAiMTkyLjE2OC4xLjI1MyIgfHwgaXAgPT0gJzE5NS4xMTIuMjE1LjIxOCcpKSB7CgkJCQkJCQkJdGhpcy5zclVSTCA9ICJodHRwOi8vMTgyLjE2OC43MC44MCI7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovL2Fyei5uYW1tb3VyLmNvbTo3MDgwIjsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQl0aGlzLnNyVVJMICs9ICcvbWV0aG9kL1NlcnZpY2VSb3V0ZXIuYXNoeCc7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLnNyVVJMID0gc3JVUkw7CgkJCQl9CgkJCQl0aGlzLnNyVVJMICs9ICc/c3J2ZXJzaW9uPTEnOwoJCQkJaWYgKHRoaXMuJF9SRVFVRVNUKCdnemlwJykpIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmZ3ppcD0nICsgdGhpcy4kX1JFUVVFU1QoJ2d6aXAnKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9dHJ1ZSc7CgkJCQl9CgkJCQlpZiAodGhpcy5iQ2FjaGUpIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmY2FjaGU9JyArIHRoaXMuYkNhY2hlOwoJCQkJfQoJCQkJaWYgKCF0aGlzLiRfUkVRVUVTVCgncmFuZCcsIHRoaXMuc3JVUkwpKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJnJhbmQ9JyArIE1hdGgucmFuZG9tKCk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuYkRlYnVnKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJkRFQlVHPXRydWUnOwoJCQkJfQoKCQkJCWlmICgKCQkJCQl0aGlzLmJBc3luYyAmJgoJCQkJCXRoaXMuYkxvY2FsICYmCgkJCQkJIXRoaXMuJF9SRVFVRVNUKCdhc3luYycsIHRoaXMuc3JVUkwpCgkJCQkpIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmYXN5bmM9dHJ1ZSc7CgkJCQkJaWYgKHRoaXMucnVuQWZ0ZXIpIHsKCQkJCQkJdGhpcy5zclVSTCArPSAnJnJ1bmFmdGVyPScgKyB0aGlzLnJ1bkFmdGVyOwoJCQkJCX0KCQkJCQl0aGlzLmJBc3luYyA9IGZhbHNlOwoJCQkJfQoKCQkJCS8vdGhpcy5TaG93RGVidWcoJ3RoaXMuc3JVUkw9JyArIHRoaXMuc3JVUkwpOwoKCQkJCXJldHVybiB0aGlzLnNyVVJMOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGtleSwgdXJsKSA9PiB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKCgkJCQlsZXQgcmV0ID0gdW5kZWZpbmVkOwoJCQkJaWYgKHVybCkgewoJCQkJCXRyeSB7CgkJCQkJCXJldCA9IG5ldyBVUkwodXJsKS5zZWFyY2hQYXJhbXMuZ2V0KGtleSk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnW1xcP3wmXScgKyBrZXkgKyAnPShbXiYjXSopJyk7CgkJCQkJCXZhciByZXN1bHRzID0gcmVnZXguZXhlYygnPycgKyB1cmwuc3BsaXQoJz8nKVsxXSk7CgkJCQkJCXJldCA9IChyZXN1bHRzID09PSBudWxsKSA/ICcnIDogZGVjb2RlVVJJQ29tcG9uZW50KHJlc3VsdHNbMV0ucmVwbGFjZSgvXCsvZywgJyAnKSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpLmdldChrZXkpOwoJCQkJfQoKCQkJCXJldHVybiByZXQgPT09IG51bGwgPyAnJyA6IHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYXJncykgPT4gewoJCQkJdGhpcy5DUk5MID0gdGhpcy5DUk5MIHx8ICJcbiI7CgkJCQl2YXIgcmV0ID0KCQkJCQknLyonICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSc8IVtDREFUQVsnICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSdQQVJBTUVURVJTJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknXV0+JyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknKi8nICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJzxwPicgKwoJCQkJCXRoaXMuQ1JOTDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewoJCQkJCXZhciB4bWwgPSB0aGlzLl90b1hNTChhcmdzW2ldKTsKCQkJCQlpZiAoZmFsc2UpIHsKCQkJCQkJLy8geG1sIGNvbnRhaW5zIGNoYXJhY3RlcnMgdGhhdCB3b3VsZCBub3QgYXJyaXZlIHByb3Blcmx5IGFuZCBzaG91bGQgYmUgY29udmVydGVkIHRvIGJhc2U2NAoJCQkJCQl4bWwgPSBidG9hKHhtbCk7CgkJCQkJfQoJCQkJCXJldCArPSAnPHAnICsgaSArICc+JyArIHRoaXMuQ1JOTCArIHhtbCArICcnICsgdGhpcy5DUk5MOwoJCQkJCXJldCArPSAnPC9wJyArIGkgKyAnPicgKyB0aGlzLkNSTkw7CgkJCQl9CgkJCQlyZXQgKz0gJzwvcD4nICsgdGhpcy5DUk5MOwoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBsZXZlbCkgPT4gewoJCQkJaWYgKCFsZXZlbCkgbGV2ZWwgPSAwOwoJCQkJdmFyIHMgPSAnJzsKCQkJCWlmIChvID09IG51bGwpIHJldHVybiBzOwoJCQkJc3dpdGNoICh0eXBlb2YgbykgewoJCQkJCWNhc2UgJ3N0cmluZyc6CgkJCQkJCXMgKz0gJzwhW0NEQVRBWycgKyBvICsgJ11dPic7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ251bWJlcic6CgkJCQkJY2FzZSAnYm9vbGVhbic6CgkJCQkJCXMgKz0gby50b1N0cmluZygpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICdvYmplY3QnOgoJCQkJCQkvLyBEYXRlCgkJCQkJCWlmICgKCQkJCQkJCW8uY29uc3RydWN0b3IgJiYKCQkJCQkJCW8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdmdW5jdGlvbiBEYXRlKCknKSA+IC0xICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLm5hbWUgPT0gIkRhdGUiCgkJCQkJCSkgewoJCQkJCQkJdmFyIHllYXIgPSBvLmdldFVUQ0Z1bGxZZWFyKCkudG9TdHJpbmcoKTsKCQkJCQkJCXZhciBtb250aCA9IChvLmdldFVUQ01vbnRoKCkgKyAxKS50b1N0cmluZygpOwoJCQkJCQkJbW9udGggPSBtb250aC5sZW5ndGggPT0gMSA/ICcwJyArIG1vbnRoIDogbW9udGg7CgkJCQkJCQl2YXIgZGF0ZSA9IG8uZ2V0VVRDRGF0ZSgpLnRvU3RyaW5nKCk7CgkJCQkJCQlkYXRlID0gZGF0ZS5sZW5ndGggPT0gMSA/ICcwJyArIGRhdGUgOiBkYXRlOwoJCQkJCQkJdmFyIGhvdXJzID0gby5nZXRVVENIb3VycygpLnRvU3RyaW5nKCk7CgkJCQkJCQlob3VycyA9IGhvdXJzLmxlbmd0aCA9PSAxID8gJzAnICsgaG91cnMgOiBob3VyczsKCQkJCQkJCXZhciBtaW51dGVzID0gby5nZXRVVENNaW51dGVzKCkudG9TdHJpbmcoKTsKCQkJCQkJCW1pbnV0ZXMgPSBtaW51dGVzLmxlbmd0aCA9PSAxID8gJzAnICsgbWludXRlcyA6IG1pbnV0ZXM7CgkJCQkJCQl2YXIgc2Vjb25kcyA9IG8uZ2V0VVRDU2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJCQlzZWNvbmRzID0gc2Vjb25kcy5sZW5ndGggPT0gMSA/ICcwJyArIHNlY29uZHMgOiBzZWNvbmRzOwoJCQkJCQkJdmFyIG1pbGxpc2Vjb25kcyA9IG8uZ2V0VVRDTWlsbGlzZWNvbmRzKCkudG9TdHJpbmcoKTsKCQkJCQkJCXZhciB0em1pbnV0ZXMgPSBNYXRoLmFicyhvLmdldFRpbWV6b25lT2Zmc2V0KCkpOwoJCQkJCQkJdmFyIHR6aG91cnMgPSAwOwoJCQkJCQkJd2hpbGUgKHR6bWludXRlcyA+PSA2MCkgewoJCQkJCQkJCXR6aG91cnMrKzsKCQkJCQkJCQl0em1pbnV0ZXMgLT0gNjA7CgkJCQkJCQl9CgkJCQkJCQl0em1pbnV0ZXMgPQoJCQkJCQkJCXR6bWludXRlcy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJCQknMCcgKyB0em1pbnV0ZXMudG9TdHJpbmcoKSA6CgkJCQkJCQkJdHptaW51dGVzLnRvU3RyaW5nKCk7CgkJCQkJCQl0emhvdXJzID0KCQkJCQkJCQl0emhvdXJzLnRvU3RyaW5nKCkubGVuZ3RoID09IDEgPwoJCQkJCQkJCScwJyArIHR6aG91cnMudG9TdHJpbmcoKSA6CgkJCQkJCQkJdHpob3Vycy50b1N0cmluZygpOwoJCQkJCQkJdmFyIHRpbWV6b25lID0KCQkJCQkJCQkoby5nZXRUaW1lem9uZU9mZnNldCgpIDwgMCA/ICcrJyA6ICctJykgKwoJCQkJCQkJCXR6aG91cnMgKwoJCQkJCQkJCSc6JyArCgkJCQkJCQkJdHptaW51dGVzOwoJCQkJCQkJLy9zICs9IHllYXIgKyAiLSIgKyBtb250aCArICItIiArIGRhdGUgKyAiVCIgKyBob3VycyArICI6IiArIG1pbnV0ZXMgKyAiOiIgKyBzZWNvbmRzICsgIi4iICsgbWlsbGlzZWNvbmRzICsgdGltZXpvbmU7CgkJCQkJCQlzICs9CgkJCQkJCQkJbW9udGggKwoJCQkJCQkJCScvJyArCgkJCQkJCQkJZGF0ZSArCgkJCQkJCQkJJy8nICsKCQkJCQkJCQl5ZWFyICsKCQkJCQkJCQknICcgKwoJCQkJCQkJCWhvdXJzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCW1pbnV0ZXMgKwoJCQkJCQkJCSc6JyArCgkJCQkJCQkJc2Vjb25kczsKCQkJCQkJfQoJCQkJCQkvLyBBcnJheQoJCQkJCQllbHNlIGlmICgKCQkJCQkJCW8uY29uc3RydWN0b3IgJiYKCQkJCQkJCW8uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdBcnJheSgpJykgPiAtMQoJCQkJCQkpIHsKCQkJCQkJCWZvciAodmFyIHAgaW4gbykgewoJCQkJCQkJCWlmIChwID09ICdPUEVSQVRPUlMnIHx8IHAgPT0gJ09SUycpIGNvbnRpbnVlOwoJCQkJCQkJCXMgKz0gJzxPYmplY3Q+JzsKCQkJCQkJCQlpZiAoIWlzTmFOKHApKSB7CgkJCQkJCQkJCS8vIGxpbmVhciBhcnJheQoJCQkJCQkJCQlpZiAob1twXSA9PSBudWxsKSB7CgkJCQkJCQkJCQkvLyBudWxsIGVudHJ5IGluIHRoZSBhcnJheQoJCQkJCQkJCQkJcyArPSAnPElkPjA8L0lkPic7CgkJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCQkvZnVuY3Rpb25ccysoXHcqKVxzKlwoL2dpLmV4ZWMoCgkJCQkJCQkJCQkJb1twXS5jb25zdHJ1Y3Rvci50b1N0cmluZygpCgkJCQkJCQkJCQkpOwoJCQkJCQkJCQkJdmFyIHR5cGUgPSBSZWdFeHAuJDE7CgkJCQkJCQkJCQlzd2l0Y2ggKHR5cGUpIHsKCQkJCQkJCQkJCQljYXNlICcnOgoJCQkJCQkJCQkJCQl0eXBlID0gdHlwZW9mIG9bcF07CgkJCQkJCQkJCQkJY2FzZSAnU3RyaW5nJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdzdHJpbmcnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCQljYXNlICdOdW1iZXInOgoJCQkJCQkJCQkJCQl0eXBlID0gJ2ludCc7CgkJCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQkJCWNhc2UgJ0Jvb2xlYW4nOgoJCQkJCQkJCQkJCQl0eXBlID0gJ2Jvb2wnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCQljYXNlICdEYXRlJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdEYXRlVGltZSc7CgkJCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQkJfQoJCQkJCQkJCQkJcyArPSB0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIGFzc29jaWF0aXZlIGFycmF5CgkJCQkJCQkJCXMgKz0KCQkJCQkJCQkJCSc8JyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJCQknPicgKwoJCQkJCQkJCQkJdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKykgKwoJCQkJCQkJCQkJJzwvJyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCSc+JzsKCQkJCQkJCQl9CgkJCQkJCQkJcyArPSAnPC9PYmplY3Q+JyArIHRoaXMuQ1JOTDsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQkvLyBPYmplY3Qgb3IgY3VzdG9tIGZ1bmN0aW9uCgkJCQkJCWVsc2UgewoJCQkJCQkJaWYgKG8gPT0gbnVsbCB8fCBvLklkID09IDApIHt9IGVsc2UgaWYgKGZhbHNlICYmIG8uSWQpIHsKCQkJCQkJCQkvLyB0aGlzIGlzIGNyZWF0aW5nIGEgcHJvYmxlbSwgYmV0dGVyIHNlbmQgYWxsIHRoZSBvYmplY3QKCQkJCQkJCQkvLyBkbyBub3Qgc2VuZCBvdGhlciBkYXRhIGlmIHdlIGhhdmUgYSB2YWx1ZSBmb3IgdGhlIElkCgkJCQkJCQkJcyArPSAnPElkPicgKyB0aGlzLl90b1hNTChvLklkLCBsZXZlbCsrKSArICc8L0lkPic7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWZvciAodmFyIHAgaW4gbykgewoJCQkJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJCQkJcyArPQoJCQkJCQkJCQkJJzwnICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJdGhpcy5jb29wKG8sIHApICsKCQkJCQkJCQkJCXRoaXMuT1IobywgcCkgKwoJCQkJCQkJCQkJJz4nICsKCQkJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQkJCSc8LycgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQknPic7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQkJcmV0dXJuIHM7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIHApID0+IHsKCQkJCWlmICghby5PUEVSQVRPUlMgfHwgIW8uT1BFUkFUT1JTW3BdKSB7CgkJCQkJcmV0dXJuICcnOwoJCQkJfQoJCQkJcmV0dXJuICgKCQkJCQkiIGNvb3A9JyIgKwoJCQkJCXRoaXMubXlSZXBsYWNlKG8uT1BFUkFUT1JTW3BdLCBbJzwnLCAnPiddLCBbJyZsdDsnLCAnJmd0OyddKSArCgkJCQkJIiciCgkJCQkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgcCkgPT4gewoJCQkJcmV0dXJuIG8uT1JTICYmIG8uT1JTW3BdID8KCQkJCQkiIE9SPSciICsKCQkJCQl0aGlzLm15UmVwbGFjZShvLk9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkJCSInIiA6CgkJCQkJJyc7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocywgZmMsIHJjKSA9PiB7CgkJCQlpZiAodHlwZW9mIHMgIT09ICdzdHJpbmcnKSByZXR1cm4gczsKCgkJCQl2YXIgcmV0ID0gJyc7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHMubGVuZ3RoOyBpKyspIHsKCQkJCQl2YXIgcnMgPSBzLmNoYXJBdChpKTsKCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IGZjLmxlbmd0aDsgaisrKSB7CgkJCQkJCWlmIChzLmNoYXJBdChpKSA9PSBmY1tqXSkgewoJCQkJCQkJcnMgPSBzLmNoYXJBdChpKS5yZXBsYWNlKGZjW2pdLCByY1tqXSk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0ICs9IHJzOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAodXJsLCBwb3N0RGF0YSwgY2FsbEJhY2spID0+IHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgIXdpbmRvdy5TUikgd2luZG93LlNSID0gdGhpczsKCgkJCQlpZiAoKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cualF1ZXJ5KSB8fCAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSkgewoJCQkJCWxldCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdChudWxsLCBudWxsLCBjYWxsQmFjayk7CgkJCQkJaWYgKHJlcXVlc3QpIHsKCQkJCQkJbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJNDQsCgkJCQkJCQljYWxsQmFjaywKCQkJCQkJCXJlcXVlc3QuVGV4dFJlc3BvbnNlLAoJCQkJCQkJdXJsCgkJCQkJCSk7CgkJCQkJCXJldHVybiBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJCQl9IGVsc2UgewoJCQkJCQkvLyBqcXVlcnkgY2FsbAoJCQkJCQl2YXIgYWpheCA9IHt9OwoJCQkJCQlpZiAodGhpcy5iUG9zdCB8fCBwb3N0RGF0YS5sZW5ndGggPiAodGhpcy5uTWF4VVJMTGVuZ3RoIHx8IDEwMCkpIHsKCQkJCQkJCWFqYXgudXJsID0gdXJsOwoJCQkJCQkJYWpheC50eXBlID0gJ1BPU1QnOwoJCQkJCQkJYWpheC5iZWZvcmVTZW5kID0gKHJlcXVlc3QpID0+IHsKCQkJCQkJCQlyZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoCgkJCQkJCQkJCSdDb250ZW50LVR5cGUnLAoJCQkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCQkJKTsKCQkJCQkJCX07CgkJCQkJCQlhamF4LmRhdGEgPQoJCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCQlwb3N0RGF0YTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWFqYXgudXJsID0gdXJsICsgJyZQT1NUQ09ERT0nICsgdGhpcy50b0hleChwb3N0RGF0YSk7CgkJCQkJCQlhamF4LnR5cGUgPSAnR0VUJzsKCQkJCQkJfQoKCQkJCQkJbGV0IHJldCA9IG51bGw7CgkJCQkJCWlmICh0eXBlb2YoalF1ZXJ5KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCXJldCA9IGF3YWl0ICQuYWpheChhamF4KTsKCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoYXhpb3MpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkJcmV0ID0gYXdhaXQgYXhpb3MoYWpheCk7CgkJCQkJCQlyZXQgPSByZXQuZGF0YTsKCQkJCQkJfQoJCQkJCQlyZXQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJCQl0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBjYWxsQmFjaywgcmV0LCB1cmwpCgkJCQkJCSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgeG1sSFRUUCA9IHRoaXMuZ2V0WG1sSFRUUCgpOwoJCQkJCWlmICgheG1sSFRUUCkgcmV0dXJuIGZhbHNlOwoJCQkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQkJCXdpbmRvdy54bWxIVFRQLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKHdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQkJCWlmICgkLndoZW4pIHsKCQkJCQkJCQkJJC53aGVuKAoJCQkJCQkJCQkJd2luZG93LlNSLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJCQl1cmwKCQkJCQkJCQkJCSkKCQkJCQkJCQkJKS50aGVuKChyZXN1bHQpID0+IHdpbmRvdy5TUi5wcm9jZXNzUmVzdWx0KHJlc3VsdCkpOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJCQkJd2luZG93LlNSLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJCQl1cmwKCQkJCQkJCQkJCSkKCQkJCQkJCQkJKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX07CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5iUG9zdCB8fCBwb3N0RGF0YS5sZW5ndGggPiB0aGlzLm5NYXhVUkxMZW5ndGgpIHsKCQkJCQkJd2luZG93LnhtbEhUVFAub3BlbignUE9TVCcsIHVybCwgY2FsbEJhY2sgIT0gbnVsbCk7CgkJCQkJCXdpbmRvdy54bWxIVFRQLnNldFJlcXVlc3RIZWFkZXIoCgkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCSdtdWx0aXBhcnQvZm9ybS1kYXRhOyBib3VuZGFyeT0tLS0tLS0tLS0tLS0tLScKCQkJCQkJKTsgLy8gZm9vbCBjcm9zcy1kb21haW4gY2hlY2tpbmcgaW4gY2hyb21lCgkJCQkJCXdpbmRvdy54bWxIVFRQLnNlbmQoCgkJCQkJCQknUE9TVERBVEE9XHJcbicgLyorICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJ1dGYtOFwiIHN0YW5kYWxvbmU9XCJ5ZXNcIj8+XHJcbiIqLyArCgkJCQkJCQlwb3N0RGF0YQoJCQkJCQkpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXhtbEhUVFAub3BlbigKCQkJCQkJCSdHRVQnLAoJCQkJCQkJdXJsICsgJyZQT1NUQ09ERT0nICsgdGhpcy50b0hleChwb3N0RGF0YSksCgkJCQkJCQljYWxsQmFjayAhPSBudWxsCgkJCQkJCSk7CgkJCQkJCXhtbEhUVFAuc2VuZChudWxsKTsKCQkJCQl9CgoJCQkJCWlmIChjYWxsQmFjayA9PSBudWxsICYmIHhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQkJCXZhciBfdXJsID0gdXJsICsgJyZQT1NUQ09ERT0nICsgdGhpcy50b0hleChwb3N0RGF0YSk7CgkJCQkJCWlmICgkLndoZW4pIHsKCQkJCQkJCXJldHVybiAkLndoZW4oCgkJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCXhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQlfdXJsCgkJCQkJCQkJKQoJCQkJCQkJKS50aGVuKChyZXN1bHQpID0+IHsKCQkJCQkJCQlyZXR1cm4gdGhpcy5wcm9jZXNzUmVzdWx0KHJlc3VsdCk7CgkJCQkJCQl9KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3VsdCgKCQkJCQkJCQl0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCQkJeG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJeG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCV91cmwKCQkJCQkJCQkpCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocmVhZHlTdGF0ZSwgY2FsbEJhY2ssIHJlc3BvbnNlVGV4dCwgdXJsKSA9PiB7CgkJCQlpZiAoWzQsIDQ0XS5pbmRleE9mKHJlYWR5U3RhdGUpID09IC0xKSByZXR1cm47CgoJCQkJdmFyIHNNZXRob2ROYW1lID0gdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCB1cmwpOwoKCQkJCXRyeSB7CgkJCQkJaWYgKHJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQlsZXQgcmVzID0gKGFzeW5jICgpID0+IHsKCQkJCQkJCXJldHVybiBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KG51bGwsIHJlc3BvbnNlVGV4dCk7CgkJCQkJCX0pKCk7CgkJCQkJfQoKCQkJCQkvL3JldCA9IG51bGw7CgkJCQkJLy9zZXJ2ZXJfdGltZSA9IG51bGw7CgkJCQkJLy9fZXhjZXB0aW9uID0gbnVsbDsKCQkJCQl2YXIgYlNjcmlwdEVycm9yID0gZmFsc2U7CgkJCQkJdmFyIF9yZXQgPSBudWxsOwoJCQkJCXRyeSB7CgkJCQkJCV9yZXQgPSB0aGlzLnJ1blNSU2NyaXB0KHJlc3BvbnNlVGV4dCk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB0aHJvdyBlOwoJCQkJCQliU2NyaXB0RXJyb3IgPSB0cnVlOwoJCQkJCX0KCgkJCQkJaWYgKF9yZXQgJiYgX3JldC5zZXJ2ZXJfdGltZSkgewoJCQkJCQlsZXQgdGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIF9yZXQuc2VydmVyX3RpbWUuZ2V0VGltZSgpOwoKCQkJCQkJdHJ5IHsKCQkJCQkJCXdpbmRvdy50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJZ2xvYmFsLnRpbWVEaWZmZXJlbmNlID0gdGQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmIChfcmV0ICYmIF9yZXQuX2V4Y2VwdGlvbikgewoJCQkJCQl0aGlzLlNob3dEZWJ1ZyhfZXhjZXB0aW9uLk1lc3NhZ2UpOwoJCQkJCX0KCgkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJdmFyIGNhbGxSZXQgPSBudWxsOwoJCQkJCQl0cnkgewoJCQkJCQkJY2FsbFJldCA9IGNhbGxCYWNrKF9yZXQucmV0LCBfcmV0Ll9leGNlcHRpb24pOwoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJCQknRXJyb3IgaW4gQ2FsbGJhY2s6XG5cbicgKyBjYWxsQmFjayArICdcblxuJyArIGUubWVzc2FnZQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCQlpZiAoCgkJCQkJCQl0eXBlb2YgX3JldC5tZXRob2RfbmFtZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCQkJCXR5cGVvZiBzTWV0aG9kTmFtZSAhPT0gJ3VuZGVmaW5lZCcgJiYKCQkJCQkJCXNNZXRob2ROYW1lICE9IF9yZXQubWV0aG9kX25hbWUKCQkJCQkJKSB7CgkJCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJCQknTWlzbWF0Y2ggaW4gTWV0aG9kIGJldHdlZW4gc2VydmVyIGFuZCBjbGllbnQ6XG5TZXJ2ZXIgTWV0aG9kIE5hbWU6ICcgKwoJCQkJCQkJCV9yZXQubWV0aG9kX25hbWUgKwoJCQkJCQkJCSdcbkNsaWVudCBNZXRob2QgTmFtZTogJyArCgkJCQkJCQkJc01ldGhvZE5hbWUKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQkJKAoJCQkJCQkJdGhpcy5mTG9hZGluZ0VuZCB8fAoJCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQkJd2luZG93LnNyLnJlc2V0Q3Vyc29yKCk7CgkJCQkJCQl9CgkJCQkJCSkoKTsKCgkJCQkJCXJldHVybiAoCgkJCQkJCQljYWxsUmV0IHx8IF9yZXQucmV0IHx8IChiU2NyaXB0RXJyb3IgPyByZXNwb25zZVRleHQgOiBudWxsKQoJCQkJCQkpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIpIHRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJcmV0dXJuIChfcmV0ID8gX3JldC5yZXQgOiBudWxsKSB8fCAoYlNjcmlwdEVycm9yID8gcmVzcG9uc2VUZXh0IDogbnVsbCk7CgkJCQkJfQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJdGhyb3cgZTsKCQkJCQl9CgkJCQkJdGhpcy5yZXNldEN1cnNvcigpOwoJCQkJCXRoaXMuU2hvd0Vycm9yKCdFcnJvciBpbiBjb2RlOiAnICsgZS5tZXNzYWdlICsgJ1xuJyArIHJlc3BvbnNlVGV4dCk7CgkJCQl9CgoJCQkJcmV0dXJuIG51bGw7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHJlcykgPT4gewoJCQkJaWYgKCFyZXMgfHwgIXJlcy5Db2RlIHx8ICFyZXMuU3RvcmVkTWV0aG9kKSB7CgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQlyZXR1cm4gcmVzOwoJCQkJfQoKCQkJCS8vIGZvciBzdXJlIGEgbWV0aG9kIHJlc3VsdCBmcm9tIGFuIGFzeW5jIGNhbGwKCQkJCWlmIChyZXMuUmVzdWx0KSB7CgkJCQkJLy8gd2UgZ290IGEgcmVzdWx0CgkJCQkJdmFyIF9fcmV0ID0gbnVsbDsKCQkJCQl0cnkgewoJCQkJCQlfX3JldCA9IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKDQsIG51bGwsIHJlcy5SZXN1bHQsIG51bGwpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJX19yZXQgPSByZXMuUmVzdWx0OwoJCQkJCX0KCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCXJldHVybiBfX3JldDsKCQkJCX0KCgkJCQl2YXIgdGltZW91dCA9IHJlcy5SdW5BZnRlciAtIHJlcy5EYXRlOwoJCQkJaWYgKHRpbWVvdXQgPD0gMCkgewoJCQkJCS8vIG5lZ2F0aXZlIHRpbWVvdXQgbWVhbnMgdGhhdCBpdCB3YXMgc3VwcG9zZWQgdG8gYmUgcnVuIGJ1dCBkaWQgbm90IGZvciBzb21lIHJlYXNvbiAoZGVsYXksIGZhaWx1cmUsIGV0Yy4uLikKCQkJCQkvLyBzYW1lIGRhdGUgYXMgcnVuYWZ0ZXIgbWVhbnMgdGhhdCB3ZSBhcmUgdXNpbmcgdGhlIGltbWVkaWF0ZSBhc3luYyBleGVjdXRpb24uIGkuZS4gdGhlcmUgaXMgbm8gbmVlZCBmb3IgdGhlIHJ1bm5lciB0aHJlYWQgdGFzawoJCQkJCXRpbWVvdXQgPSAzMDAwMDsKCQkJCX0gZWxzZSBpZiAodGltZW91dCA+IDUgKiA2MCAqIDEwMDApIHsKCQkJCQkvLyBtb3JlIHRoYW4gd2UgY2FuIHdhaXQsIHdlIHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgcmVzdWx0CgkJCQkJY29uc29sZS5sb2coCgkJCQkJCSdXZSBjYW5ub3Qgd2FpdCAnICsKCQkJCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQkJCQknIHNlY29uZHMuIFJldHVybmluZyByZXN1bHQuJwoJCQkJCSk7CgkJCQkJcmV0dXJuIHJlczsKCQkJCX0KCQkJCWNvbnNvbGUubG9nKAoJCQkJCSdNYWtpbmcgdGhlIG5leHQgY2FsbCBpbiAnICsKCQkJCQlNYXRoLmZsb29yKHRpbWVvdXQgLyAxMDAwKSArCgkJCQkJJyBzZWNvbmRzLicKCQkJCSk7CgoJCQkJYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dCkpOwoJCQkJaWYgKCF0aGlzLkFjdGl2ZVJlcXVlc3QpIHsKCQkJCQljb25zb2xlLmxvZygnTm8gQWN0aXZlUmVxdWVzdCwgZXhpdGluZy4uLicpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQkJdHJ5IHsKCQkJCQlsZXQgcmV0ID0gYXdhaXQgJC5hamF4KHsKCQkJCQkJdXJsOiAnL21ldGhvZC9hLmFzaHg/bmFtZT1Db250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kJnAwPXtDb2RlfScgKwoJCQkJCQkJcmVzLkNvZGUgKwoJCQkJCQkJJ3svQ29kZX17SWR9JyArCgkJCQkJCQlyZXMuSWQgKwoJCQkJCQkJJ3svSWR9JnJhbmQ9JyArCgkJCQkJCQlNYXRoLnJhbmRvbSgpLAoJCQkJCX0pOwoJCQkJCXJldCA9IHRoaXMucHJvY2Vzc1Jlc3BvbnNlKDQsIG51bGwsIHJldCwgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCk7CgkJCQkJcmV0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KHJldCk7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coJ3Byb2Nlc3NSZXN1bHQnLCBleCk7CgkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuXygnQ29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZCcsIG51bGwsIHsKCQkJCQkJQ29kZTogcmVzLkNvZGUsCgkJCQkJCUlkOiByZXMuSWQsCgkJCQkJfSk7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChkKSA9PiB7CgkJCQlsZXQgdGQgPSAwOwoJCQkJdHJ5IHsKCQkJCQl0ZCA9IHdpbmRvdy50aW1lRGlmZmVyZW5jZTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJdGQgPSBnbG9iYWwudGltZURpZmZlcmVuY2U7CgkJCQl9CgkJCQlyZXR1cm4gdGhpcy5hZGRNU2Vjb25kcyhkIHx8IG5ldyBEYXRlKCksIC10ZCk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBtcykgPT4gewoJCQkJcmV0dXJuIG5ldyBEYXRlKG8uZ2V0VGltZSgpICsgbXMpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWlmICghcykgcmV0dXJuIG51bGw7CgoJCQkJbGV0IGNMaW5lcyA9IHMuc3BsaXQoJ1xuJyk7CgkJCQl0cnkgewoJCQkJCWlmICh0eXBlb2YoZXNwcmltYSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWVzcHJpbWEucGFyc2UocywgewoJCQkJCQkJZXM2OiB0cnVlCgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJaWYgKGNMaW5lc1tleC5saW5lTnVtYmVyIC0gMV0uaW5kZXhPZignZm9yIGF3YWl0JykgPCAwKSB7CgkJCQkJCWNvbnNvbGUubG9nKCJydW5TY3JpcHQoKSAiICsgZXguZGVzY3JpcHRpb24sIGV4LmxpbmVOdW1iZXIsIGNMaW5lc1tleC5saW5lTnVtYmVyIC0gMV0pOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoKCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQl0cnkgewoJCQkJCQlpZiAod2luZG93Ll9jb250ZW50ICYmIHdpbmRvdy5fY29udGVudC5ldmFsKSB7CgkJCQkJCQl2YXIgb3V0cHV0ID0gd2luZG93Ll9jb250ZW50LmV2YWwocyk7CgkJCQkJCQlyZXR1cm4gb3V0cHV0OwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignRkYgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCQkJfQoJCQkJCXRyeSB7CgkJCQkJCWlmICh3aW5kb3cuZXhlY1NjcmlwdCkgewoJCQkJCQkJaWYgKHMuaW5kZXhPZignXHJcbicpID4gMCkgewoJCQkJCQkJCS8vIGEgbXVsdGktbGluZSBzdGF0ZW1lbnQKCQkJCQkJCQl3aW5kb3cuZXhlY1NjcmlwdChzKTsKCQkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJLy8gYSBzaW5nbGUtbGluZSBzdGF0ZW1lbnQKCQkJCQkJCQluZXdWID0gbnVsbDsKCQkJCQkJCQl2YXIgbmV3UyA9ICduZXdWID0gJyArIHM7CgkJCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQobmV3Uyk7CgkJCQkJCQkJcmV0dXJuIG5ld1Y7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCXRoaXMuU2hvd0Vycm9yKCdJRTYgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCQkJfQoKCQkJCQl0cnkgewoJCQkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJCQkvLyBhIG11bHRpLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCQkJdmFyIG5ld1MgPSAnbmV3ViA9ICcgKyBzOwoJCQkJCQkJCWV2YWwobmV3Uyk7CgkJCQkJCQkJcmV0dXJuIG5ld1Y7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCXRoaXMuU2hvd0Vycm9yKCdJRTcgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCQkJfQoKCQkJCQl0cnkgewoJCQkJCQl2YXIgZm4gPSBmdW5jdGlvbigpIHsKCQkJCQkJCXZhciByZXQgPSB3aW5kb3cuZXZhbC5jYWxsKHdpbmRvdywgcyk7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9OwoKCQkJCQkJcmV0dXJuIGZuKCk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignVEFHIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCQkJCX0KCgkJCQl0cnkgewoJCQkJCXMgPSBzLnJlcGxhY2UoL25ldyBEYXRlXCgwMDAxL2csICduZXcgRGF0ZSgxJyk7CgkJCQkJcmV0dXJuIGV2YWwocyk7CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJdGhpcy5TaG93RXJyb3IoJ0VWQUwgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCXJldHVybiB0aGlzLnJ1blNjcmlwdCgKCQkJCQknKCgpID0+IHsgdmFyIHJldCA9IG51bGw7ICcgKwoJCQkJCXMgKwoJCQkJCScgaWYodHlwZW9mKHdpbmRvdykhPT0idW5kZWZpbmVkIil7d2luZG93Lm1ldGhvZF9uYW1lID0gbWV0aG9kX25hbWU7IHdpbmRvdy5zZXJ2ZXJfdGltZSA9IHNlcnZlcl90aW1lOyB3aW5kb3cuX2V4Y2VwdGlvbiA9IHR5cGVvZihfZXhjZXB0aW9uKT09PSJ1bmRlZmluZWQiP251bGw6X2V4Y2VwdGlvbjsgd2luZG93LmV4ZWN1dGlvbl90aW1lID0gZXhlY3V0aW9uX3RpbWU7fSByZXR1cm4ge19leGNlcHRpb246IHR5cGVvZihfZXhjZXB0aW9uKT09PSJ1bmRlZmluZWQiP251bGw6X2V4Y2VwdGlvbiwgbWV0aG9kX25hbWU6IG1ldGhvZF9uYW1lLCBzZXJ2ZXJfdGltZTogc2VydmVyX3RpbWUsIGV4ZWN1dGlvbl90aW1lOiBleGVjdXRpb25fdGltZSwgcmV0OiByZXR9O30pKCk7JwoJCQkJKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQl2YXIgaGFzaCA9IDAsCgkJCQkJaSwKCQkJCQljaHIsCgkJCQkJbGVuOwoJCQkJaWYgKHMubGVuZ3RoID09IDApIHJldHVybiBoYXNoOwoJCQkJZm9yIChpID0gMCwgbGVuID0gcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJCQkJCWNociA9IHMuY2hhckNvZGVBdChpKTsKCQkJCQloYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hyOwoJCQkJCWhhc2ggfD0gMDsgLy8gQ29udmVydCB0byAzMmJpdCBpbnRlZ2VyCgkJCQl9CgkJCQlyZXR1cm4gaGFzaDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhciwgZmllbGQpID0+IHsKCQkJCWlmICghYXIgfHwgIWZpZWxkKSByZXR1cm4gbnVsbDsKCgkJCQl2YXIga2V5cyA9IFtdOwoJCQkJYXIuZm9yRWFjaChhID0+IHsKCQkJCQl2YXIga2V5ID0gbnVsbDsKCQkJCQlmaWVsZC5zcGxpdCgnLicpLmZvckVhY2goZiA9PiBrZXkgPSAoa2V5IHx8IGEpW2ZdKTsKCQkJCQlsZXQgayA9IGtleXMuZmluZChrID0+IHRoaXMuRXF1YWxzKGsua2V5LCBrZXkpKTsKCQkJCQlpZiAoaykgewoJCQkJCQlrLnZhbHVlcy5wdXNoKGEpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWtleXMucHVzaCh7CgkJCQkJCQlrZXk6IGtleSwKCQkJCQkJCXZhbHVlczogW2FdLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQkJCXJldHVybiBrZXlzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocywgYklnbm9yZURlYnVnKSA9PiB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJY29uc29sZS5sb2coIlNob3dEZWJ1ZzogIiArIHMpOwoJCQkJfQoJCQkJaWYgKHRoaXMuYkRlYnVnIHx8IGJJZ25vcmVEZWJ1ZykgdGhpcy5TaG93TWVzc2FnZShzKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAocmVxdWVzdCwgdGV4dHJlc3BvbnNlKSA9PiB7CgkJCQlpZiAoIXRoaXMuYkNhY2hlUmVzdWx0KSByZXR1cm47CgkJCQlyZXF1ZXN0ID0gcmVxdWVzdCB8fCB0aGlzLkFjdGl2ZVJlcXVlc3Q7CgoJCQkJaWYgKCFyZXF1ZXN0KSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICgKCQkJCQl0ZXh0cmVzcG9uc2UgJiYKCQkJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LkNvZGUgPSAnKSA+IC0xICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5SdW5BZnRlciA9ICcpID4gLTEgJiYKCQkJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LlJlc3VsdCA9ICIiJykgPiAtMQoJCQkJKSB7CgkJCQkJY29uc29sZS5sb2coJ3RleHRyZXNwb25zZSBjb250aWFucyBpbmNvbXBsZXRlIG1ldGhvZCByZXN1bHQnKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQl2YXIgc01ldGhvZCA9IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgcmVxdWVzdC5VUkwpOwoJCQkJc01ldGhvZCA9IHNNZXRob2Quc3Vic3RyaW5nKHNNZXRob2QubGFzdEluZGV4T2YoJy4nKSArIDEpOwoJCQkJdHJ5IHsKCQkJCQl2YXIgX3VzYWJsZSA9IChyKSA9PiB7CgkJCQkJCXZhciBpdGVtID0KCQkJCQkJCShyICYmCgkJCQkJCQkJci5oYXNoID09IHJlcXVlc3QuaGFzaCAmJgoJCQkJCQkJCShyLlVSTCA9PSByZXF1ZXN0LlVSTCB8fCB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHIuVVJMKSA9PSBzTWV0aG9kKSAmJgoJCQkJCQkJCXIuVGV4dFJlc3BvbnNlICYmCgkJCQkJCQkJKHR5cGVvZiByLkV4cGlyZXMgPT09ICd1bmRlZmluZWQnIHx8CgkJCQkJCQkJCW5ldyBEYXRlKHIuRXhwaXJlcykgPiBuZXcgRGF0ZSgpKSkgPwoJCQkJCQkJciA6CgkJCQkJCQludWxsOwoJCQkJCQlpZiAodGV4dHJlc3BvbnNlKSB7CgkJCQkJCQlpdGVtID0gaXRlbSB8fCByZXF1ZXN0OwoJCQkJCQkJaXRlbS5UZXh0UmVzcG9uc2UgPSB0ZXh0cmVzcG9uc2U7CgkJCQkJCQlpdGVtLkV4cGlyZXMgPSBuZXcgRGF0ZSgKCQkJCQkJCQluZXcgRGF0ZSgpLmdldFRpbWUoKSArCgkJCQkJCQkJcGFyc2VGbG9hdCgKCQkJCQkJCQkJdGhpcy5uQ2FjaGVFeHBpcmVIb3VycyB8fCB0aGlzLiRfUkVRVUVTVCgnbkNhY2hlRXhwaXJlSG91cnMnKSB8fCAxCgkJCQkJCQkJKSAqCgkJCQkJCQkJNjAgKgoJCQkJCQkJCTYwICoKCQkJCQkJCQkxMDAwCgkJCQkJCQkpOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9OwoKCQkJCQlpZiAoCgkJCQkJCXRoaXMuYkNhY2hlUmVzdWx0ID09ICdrdnN0b3JlJyAmJgoJCQkJCQl0eXBlb2Ygd2luZG93LmNvbXBhbnkucmVzdGlvZGJTZXR0aW5ncyAhPT0gJ3VuZGVmaW5lZCcKCQkJCQkpIHsKCQkJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQkJCXZhciByZXQgPSBjb21wYW55LnJlc3Rpb2RiU2V0dGluZ3MoKTsKCQkJCQkJCXJldC51cmwgKz0gJ2t2c3RvcmUnOwoJCQkJCQkJaWYgKHZhbHVlKSB7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIHVwZGF0ZSByZWNvcmQKCQkJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdQVVQnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdQT1NUJzsKCQkJCQkJCQl9CgkJCQkJCQkJcmV0LmRhdGEgPSBKU09OLnN0cmluZ2lmeSh7CgkJCQkJCQkJCWtleToga2V5LAoJCQkJCQkJCQl2YWx1ZTogSlNPTi5zdHJpbmdpZnkodmFsdWUsIG51bGwsIDQpLAoJCQkJCQkJCX0pOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJCQlyZXQudXJsICs9ICcvJyArIGlkOwoJCQkJCQkJCQlyZXQubWV0aG9kID0gJ0RFTEVURSc7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdHRVQnOwoJCQkJCQkJCQlyZXQudXJsICs9ICc/cT17ImtleSI6JyArIGtleSArICd9JzsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCQkvL2NvbnNvbGUubG9nKCdtZXRob2QnLCByZXQubWV0aG9kKTsKCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX07CgoJCQkJCQlsZXQgcmVjb3JkID0gYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoKSk7CgkJCQkJCWxldCByID0KCQkJCQkJCXJlY29yZCAmJiByZWNvcmQubGVuZ3RoID8KCQkJCQkJCUpTT04ucGFyc2UocmVjb3JkWzBdLnZhbHVlKSA6CgkJCQkJCQludWxsOwoJCQkJCQlsZXQgaXRlbSA9IF91c2FibGUocik7CgoJCQkJCQlpZiAoIWl0ZW0pIHsKCQkJCQkJCWlmIChyKSB7CgkJCQkJCQkJYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoLCBudWxsLCByZWNvcmRbMF0uX2lkKSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCQkJYXdhaXQgJC5hamF4KAoJCQkJCQkJCWFqYXgoaXRlbS5oYXNoLCBpdGVtLCByID8gcmVjb3JkWzBdLl9pZCA6IG51bGwpCgkJCQkJCQkpOwoJCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ3NyJykgewoJCQkJCQl2YXIgYWpheCA9IChrZXksIHZhbHVlLCBpZCkgPT4gewoJCQkJCQkJdmFyIG1ldGhvZCA9ICdGaW5kJzsKCQkJCQkJCXZhciByZXQgPSB7CgkJCQkJCQkJdXJsOiAnL21ldGhvZC9hLmFzaHg/bmFtZT1Db250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHQnLAoJCQkJCQkJCXByb2Nlc3NEYXRhOiBmYWxzZSwKCQkJCQkJCQl0eXBlOiAnUE9TVCcsCgkJCQkJCQl9OwoJCQkJCQkJaWYgKHZhbHVlKSB7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIHVwZGF0ZSByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ1VwZGF0ZSc7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJLy8gbmV3IHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnSW5zZXJ0JzsKCQkJCQkJCQl9CgkJCQkJCQkJcmV0LmJlZm9yZVNlbmQgPSAocmVxdWVzdCkgPT4gewoJCQkJCQkJCQlyZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoCgkJCQkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCQkJCSdtdWx0aXBhcnQvZm9ybS1kYXRhOyBib3VuZGFyeT0tLS0tLS0tLS0tLS0tLScKCQkJCQkJCQkJKTsKCQkJCQkJCQl9OwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlyZXQudHlwZSA9ICdHRVQnOwoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyBkZWxldGUgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdEZWxldGUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIGdldCByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ0ZpbmQnOwoJCQkJCQkJCX0KCQkJCQkJCQltZXRob2QgKz0KCQkJCQkJCQkJJyZwMD17Q29kZX0nICsKCQkJCQkJCQkJKGNvbXBhbnkgPyBjb21wYW55LkNvZGUgKyAnLScgOiAnJykgKwoJCQkJCQkJCQlrZXkgKwoJCQkJCQkJCQkney9Db2RlfSc7CgkJCQkJCQl9CgkJCQkJCQlyZXQudXJsICs9IG1ldGhvZDsKCQkJCQkJCWlmIChyZXQudHlwZSAhPSAnR0VUJykgewoJCQkJCQkJCWRlbGV0ZSBpdGVtLlBvc3REYXRhOyAvLyBiZWNhdXNlIHdlIGhhdmUgdGhlIGNhY2hlIGtleQoJCQkJCQkJCXZhciBwMCA9IHsKCQkJCQkJCQkJQ29kZTogKGNvbXBhbnkgPyBjb21wYW55LkNvZGUgKyAnLScgOiAnJykgKyBrZXksCgkJCQkJCQkJCUNvbXBsZXRlZDogbmV3IERhdGUoKSwKCQkJCQkJCQkJRGF0ZTogdGhpcy5BY3RpdmVSZXF1ZXN0ID8KCQkJCQkJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdC5EYXRlIDogbmV3IERhdGUoKSwKCQkJCQkJCQkJUmVzdWx0OiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeShpdGVtKSkpKSwgLy9pdGVtLlRleHRSZXNwb25zZSwKCQkJCQkJCQkJU3RvcmVkTWV0aG9kOiB7CgkJCQkJCQkJCQlOYW1lOiBzTWV0aG9kLAoJCQkJCQkJCQl9LAoJCQkJCQkJCX07CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCXAwLklkID0gaWQ7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5kYXRhID0KCQkJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJCQl0aGlzLnBhcmFtKFtwMF0pOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfTsKCgkJCQkJCWxldCByZWNvcmQgPSB0aGlzLnJ1blNjcmlwdCAvKnJ1blNSU2NyaXB0Ki8oCgkJCQkJCQknKCgpID0+IHsgdmFyIHJldCA9IG51bGw7ICcgKwoJCQkJCQkJKGF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCkpKSArCgkJCQkJCQkncmV0dXJuIHJldDt9KSgpOycKCQkJCQkJKTsKCQkJCQkJbGV0IHIgPSByZWNvcmQgPyBKU09OLnBhcnNlKHJlY29yZC5SZXN1bHQpIDogbnVsbDsKCQkJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlpZiAocikgewoJCQkJCQkJCXRyeSB7CgkJCQkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkLklkKSk7CgkJCQkJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCQkJYXdhaXQgJC5hamF4KAoJCQkJCQkJCWFqYXgoaXRlbS5oYXNoLCBpdGVtLCByICYmIHJlY29yZCA/IHJlY29yZC5JZCA6IG51bGwpCgkJCQkJCQkpOwoJCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2dpdGh1YicpIHsKCQkJCQkJaWYgKHJlcXVlc3QuVVJMLmluZGV4T2YoJ2Ntc01ldGhvZFJlc3VsdCcpID49IDApIHJldHVybiBudWxsOwoJCQkJCQlsZXQgcmVzID0gbnVsbDsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlcyA9IGF3YWl0ICQuYWpheCh7CgkJCQkJCQkJdXJsOiAnaHR0cHM6Ly9hcnpob3NwaXRhbC5naXRodWIuaW8vJyArCgkJCQkJCQkJCWNvbXBhbnkuU3RvcmUgKwoJCQkJCQkJCQknLycgKwoJCQkJCQkJCQlyZXF1ZXN0Lmhhc2ggKwoJCQkJCQkJCQknLmpzJywKCQkJCQkJCQlkYXRhVHlwZTogJ2pzb25wJywKCQkJCQkJCQlwcm9jZXNzUmVzdWx0OiBmYWxzZSwKCQkJCQkJCX0pOwoJCQkJCQkJcmV0dXJuIHsKCQkJCQkJCQlUZXh0UmVzcG9uc2U6IHJlcywKCQkJCQkJCX07CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygnRVJST1JTOicsIGV4KTsKCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQl9CgkJCQkJfSBlbHNlIGlmICh0aGlzLmJDYWNoZVJlc3VsdCA9PSAnbG9jYWwnKSB7CgkJCQkJCXZhciBzckNhY2hlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3NyQ2FjaGUnKTsKCQkJCQkJaWYgKHNyQ2FjaGUgPT0gbnVsbCkgewoJCQkJCQkJc3JDYWNoZSA9IHsKCQkJCQkJCQlSZXF1ZXN0czoge30sCgkJCQkJCQl9OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc3JDYWNoZSA9IEpTT04ucGFyc2Uoc3JDYWNoZSk7CgkJCQkJCX0KCgkJCQkJCXZhciByID0gc3JDYWNoZS5SZXF1ZXN0c1tyZXF1ZXN0Lmhhc2hdOwoJCQkJCQl2YXIgaXRlbSA9IF91c2FibGUocik7CgoJCQkJCQlpZiAoIWl0ZW0pIHsKCQkJCQkJCWRlbGV0ZSBzckNhY2hlLlJlcXVlc3RzW3JlcXVlc3QuaGFzaF07CgkJCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc3JDYWNoZScsIEpTT04uc3RyaW5naWZ5KHNyQ2FjaGUpKTsKCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQl9CgoJCQkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJCQlzckNhY2hlLlJlcXVlc3RzW2l0ZW0uaGFzaF0gPSBpdGVtOwoJCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZyhleCk7CgkJCQkJdGhyb3cgZXg7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCQkJdmFyIGFycjEgPSBbXTsKCQkJCWZvciAodmFyIG4gPSAwLCBsID0gcy5sZW5ndGg7IG4gPCBsOyBuKyspIHsKCQkJCQl2YXIgaGV4ID0gTnVtYmVyKHMuY2hhckNvZGVBdChuKSkudG9TdHJpbmcoMTYpOwoJCQkJCWFycjEucHVzaChoZXgpOwoJCQkJfQoJCQkJcmV0dXJuIGFycjEuam9pbignJyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJY29uc29sZS5sb2cocyk7CgkJCQlpZiAodGhpcy5iU2hvd0Vycm9ycykgdGhpcy5TaG93TWVzc2FnZShzKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobzEsIG8yKSA9PiB7CgkJCQlpZiAobzEgPT0gbzIpIHJldHVybiB0cnVlOwoKCQkJCWlmICgKCQkJCQlvMSAmJgoJCQkJCW8xLl9fT0JKRUNUSUQgJiYKCQkJCQlvMiAmJgoJCQkJCW8yLl9fT0JKRUNUSUQgJiYKCQkJCQlvMS5fX09CSkVDVElEID09IG8yLl9fT0JKRUNUSUQKCQkJCSkKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCWlmIChvMSAmJiBvMS5fX1JPV0lEICYmIG8yICYmIG8yLl9fUk9XSUQgJiYgbzEuX19ST1dJRCA9PSBvMi5fX1JPV0lEKQoJCQkJCXJldHVybiB0cnVlOwoJCQkJaWYgKG8xICYmIG8xLklkICYmIG8yICYmIG8yLklkICYmIG8xLklkID09IG8yLklkKSByZXR1cm4gdHJ1ZTsKCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKCkgPT4gewoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gbnVsbDsKCQkJCQlpZiAodHlwZW9mKGdsb2JhbCkgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZihnbG9iYWwub3MpID09PSAndW5kZWZpbmVkJykgewoJCQkJCQkvLyBjb25zb2xlLmxvZygiaXBBZGRyZXNzKCk6IEludmFsaWQgZ2xvYmFsIG9yIGdsb2JhbC5vcyBub3QgZGVmaW5lZCIpOwoJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQl9CgkJCQkJcmV0dXJuIFtdLmNvbmNhdCguLi5PYmplY3QudmFsdWVzKGdsb2JhbC5vcy5uZXR3b3JrSW50ZXJmYWNlcygpKSkuZmluZCgoZGV0YWlscykgPT4gZGV0YWlscy5mYW1pbHkgPT09ICdJUHY0JyAmJiAhZGV0YWlscy5pbnRlcm5hbCkuYWRkcmVzczsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coImlwQWRkcmVzcygpOiAiICsgZXgpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoZWEpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKGVhLkVudGl0eVR5cGUpIHJldHVybiAiRW50aXR5IjsKCQkJCQlyZXR1cm4gT2JqZWN0LmtleXMoZWEpLmZpbHRlcihrID0+ICFrLmluZGV4T2YoIklzIikgJiYgayAhPT0gIklzVW5pcXVlIikuZmluZChrID0+IGVhW2tdKS5yZXBsYWNlKCdJcycsICcnKTsKCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGEpID0+IHsKCQkJCXJldHVybiBhLmZpbHRlcigoYWcsIGkpID0+ICFhLmZpbmQoKF9hZywgX2kpID0+IF9hZy5OYW1lID09IGFnLk5hbWUgJiYgX2kgPiBpICYmIGkgPT0gX2kpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvYmopID0+IHsKCQkJCXJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrLCB2XSkgPT4gW3YsIGtdKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHNjb3BlLCBmaWxlbmFtZSkgPT4gewoJCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgoJCQkJbGV0IHMgPSB7CgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiAiQVBJU0VSVkVSOjoiICsgc2NvcGUsCgkJCQl9OwoJCQkJaWYgKG9TY29wZS5fX3NjcmlwdCAmJiBvU2NvcGUuX19zY3JpcHQuRGF0ZSkgewoJCQkJCXMuRGF0ZSA9IG9TY29wZS5fX3NjcmlwdC5EYXRlOwoJCQkJCXMuT1BFUkFUT1JTID0gewoJCQkJCQlEYXRlOiAiPiIKCQkJCQl9CgkJCQl9CgkJCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5zcigpLl8oYENvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmRgLCBudWxsLCBzKTsKCQkJCWlmIChzY3JpcHQgJiYgc2NyaXB0LlNjcmlwdCkgewoJCQkJCXNjcmlwdC5TY3JpcHQgPSB0aGlzLl9hdG9iKHNjcmlwdC5TY3JpcHQpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjb25zb2xlLmxvZygiX3JlZnJlc2hBUEk6IHNjcmlwdCBpcyBudWxsIik7CgkJCQkJcmV0dXJuIDE7CgkJCQl9CgoJCQkJaWYgKCFvU2NvcGUgfHwgIW9TY29wZS5fX3NjcmlwdCB8fCAoc2NyaXB0ICYmIHNjcmlwdC5TY3JpcHQgJiYgKChzY3JpcHQuRGF0ZS5nZXRUaW1lKCkgLSBvU2NvcGUuX19zY3JpcHQuRGF0ZS5nZXRUaW1lKCkpIC8gMTAwMCkgPiA1KSkgewoJCQkJCWlmIChmaWxlbmFtZSkgewoJCQkJCQljb25zb2xlLmxvZygiWyIgKyBzY29wZSArICJdIE5ldyBVcGRhdGVkIFZlcnNpb24sIG92ZXJ3cml0dGluZyAiICsgZmlsZW5hbWUsIHNjcmlwdC5EYXRlLCAob1Njb3BlICYmIG9TY29wZS5fX3NjcmlwdCkgPyBvU2NvcGUuX19zY3JpcHQuRGF0ZSA6IG51bGwpOwoJCQkJCX0KCgkJCQkJaWYgKGZpbGVuYW1lICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQlhd2FpdCBnbG9iYWwudXRpbC5wcm9taXNpZnkoZ2xvYmFsLmZzLndyaXRlRmlsZSkoZmlsZW5hbWUsIHNjcmlwdC5TY3JpcHQpOwoJCQkJCX0gZWxzZSBpZiAoZmlsZW5hbWUpIHsKCQkJCQkJYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc1NhdmVGaWxlQm9keScsIG51bGwsIGZpbGVuYW1lLCB0aGlzLl9idG9hKHNjcmlwdC5TY3JpcHQpKTsKCQkJCQl9CgoJCQkJCWlmICghb1Njb3BlKSByZXR1cm47CgkJCQkJb1Njb3BlLl9fc2NyaXB0ID0gc2NyaXB0OwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKQoJCQkJCQljb25zb2xlLmxvZyhgWyR7c2NvcGV9XSBTYW1lIG9yIG9sZGVyIHZlcnNpb24sIHNraXBwaW5nIHVwZGF0ZWAsIHNjcmlwdCA/IHNjcmlwdC5EYXRlIDogbnVsbCwgb1Njb3BlLl9fc2NyaXB0ID8gb1Njb3BlLl9fc2NyaXB0LkRhdGUgOiBudWxsKTsKCQkJCX0KCgkJCQlkZWxldGUgb1Njb3BlLl9fc2NyaXB0LlNjcmlwdDsKCQkJCXJldHVybiBvU2NvcGUuX19zY3JpcHQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHNjb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IGdsb2JhbCk7CgkJCQlpZiAoc2NvcGUpIHJldCA9IHJldFtzY29wZV07CgkJCQlyZXR1cm4gcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKCkgPT4gewoJCQkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlNSKSA/IHdpbmRvdy5TUiA6IHRoaXM7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGEpID0+IHsKCQkJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGIpID0+IHsKCQkJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobmFtZSA9ICJnbG9iYWwiKSA9PiB7CgkJCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQkJCXRoaXMuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCQkJdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IHRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQkJCXJldHVybiAocyArICdzJyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChtcykgPT4gewoJCQkJYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGVhLCBkYlR5cGUpID0+IHsKCQkJCWxldCB0eXBlID0gdHlwZW9mKGVhKSA9PT0gInN0cmluZyIgPyBlYSA6IHRoaXMuX2F0dHIoZWEpOwoJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJY2FzZSAiU3RyaW5nIjoKCQkJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQkJCWNhc2UgIlRleHQiOgoJCQkJCWNhc2UgIk9iamVjdCI6CgkJCQkJCXJldHVybiBgJHtkYlR5cGU9PSdzcWxpdGUnPydWQVJDSEFSJzonVEVYVCd9KDQwMDApYDsKCQkJCQljYXNlICJCb29sIjoKCQkJCQkJcmV0dXJuICJUSU5ZSU5UIjsgLy9CSVQKCQkJCQljYXNlICJEYXRlIjoKCQkJCQkJcmV0dXJuICJEQVRFVElNRSI7CgkJCQkJY2FzZSAiSW50IjoKCQkJCQkJcmV0dXJuICJJTlRFR0VSIjsKCQkJCQljYXNlICJMb25nIjoKCQkJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQkJCWNhc2UgIkVudGl0eSI6CgkJCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJCQljYXNlICJJbWFnZSI6CgkJCQkJY2FzZSAiRmlsZSI6CgkJCQkJCXJldHVybiAiQkxPQiI7CgkJCQkJZGVmYXVsdDoKCQkJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGlkLCBsZW4pID0+IHsKCQkJCWxldCByZXQgPSBudWxsOwoKCQkJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHY0KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2NCgpOwoKCQkJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQkJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCkucmVwbGFjZSgvXC0vZywgJycpOwoKCQkJCS8vbGV0IHBvb2wgPSAodGhpcy5fX3Njb3BlKCkuX191dWlkUG9vbCA9IHRoaXMuX19zY29wZSgpLl9fdXVpZFBvb2wgfHwgW10pOwoJCQkJLy9pZiAocG9vbC5maW5kKHUgPT4gdSA9PSByZXQpKSByZXR1cm4gdGhpcy5fdXVpZChpZCwgbGVuKTsKCQkJCS8vcG9vbC5wdXNoKHJldCk7CgoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAobGliTmFtZSwgaHJlZnMpID0+IHsKCQkJCWZvciBhd2FpdCAoY29uc3QgbiBvZiAoaHJlZnMgfHwgdGhpcy5ocmVmcykuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBocmVmcyk7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCQkJdGhpcy5fY3NzKGMpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXZhciBtb2R1bGVzID0gW107CgkJCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQkJCWxldCBfc2MgPSBhd2FpdCBzci5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcyk7CgkJCQkJCQkJYXdhaXQgc3IucnVuU2NyaXB0KF9zYy5TY3JpcHQpOwoJCQkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBpbXBvcnQocykpOwoJCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoJCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZigkLmFqYXgpICE9PSAndW5kZWZpbmVkJykgewoKCQkJCQkJCQlhd2FpdCAkLmFqYXgoewoJCQkJCQkJCQl1cmw6IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpLAoJCQkJCQkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCQkJCQkJCWNhY2hlOiBuLmNhY2hlID8gJ2ZvcmNlLWNhY2hlJyA6ICdkZWZhdWx0JwoJCQkJCQkJCX0pOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCQlzY3JpcHQub25sb2FkID0gKCkgPT4gcigpOwoJCQkJCQkJCQlzY3JpcHQuc3JjID0gczsKCQkJCQkJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjogIiArIGV4LCBzKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAobi5sb2FkKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIGV4KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChfaHJlZikgPT4gewoJCQkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCh2YWx1ZSwgdHlwZSkgPT4gewoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKGJlYXV0aWZpZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCQkJImU0eCI6IHRydWUsCgkJCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCQkJfTsKCQkJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQkJCXZhbHVlID0gYmVhdXRpZmllci5qcyh0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlLCBvcHRpb25zKTsKCQkJCQkJfSBlbHNlIGlmIChbJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQkJCXZhbHVlID0gYmVhdXRpZmllci5odG1sKHZhbHVlLCBvcHRpb25zKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieURlcGFydG1lbnQoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2RlcGFydG1lbnQiXSAmJiAoYVsiX2RlcGFydG1lbnQiXS5FcXVhbHMgPyBhWyJfZGVwYXJ0bWVudCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZGVwYXJ0bWVudCJdLCByKSkpIHsKCQkJCQlyLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMudXNlcm5hbWUodGhpcy51c2VybmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuZGVwYXJ0bWVudCgpICYmICEoYXdhaXQgdGhpcy5kZXBhcnRtZW50KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZGVwYXJ0bWVudCgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2FsbGVyX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5jb250YWN0X0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fdXNlcm5hbWVfc2V0KSB7CgoJCQkJCW9iai51c2VybmFtZSA9IHRoaXMudXNlcm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3Bhc3N3b3JkX3NldCkgewoKCQkJCQlvYmoucGFzc3dvcmQgPSB0aGlzLnBhc3N3b3JkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCkgewoKCQkJCQlvYmouZGVwYXJ0bWVudCA9IHRoaXMuX2RlcGFydG1lbnQuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiVXNlciIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQl0cnkgewoJCQlpZiAoZGVwdGggPiAxKSB7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgcmV0KSB7CgoJCQkJCWlmIChyLl9kZXBhcnRtZW50X3NldCkgewoJCQkJCQlyLmRlcGFydG1lbnQoYXdhaXQgci5fZGVwYXJ0bWVudC5maW5kKGRlcHRoIC0gMSkpOwoJCQkJCX0KCgkJCQkJci5tYW5hZ2VyX0RlcGFydG1lbnRzKGF3YWl0IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHIuVG9vbCkubWFuYWdlcihyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCQlyLmNhbGxlcl9JbmNpZGVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHIuVG9vbCkuY2FsbGVyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIuY29udGFjdF9JbmNpZGVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHIuVG9vbCkuY29udGFjdChyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCQlyLnVzZXJfR3JvdXBfTWVtYmVycyhhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHIuVG9vbCkudXNlcihyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCX0KCQkJfQoKCQkJbGV0IHJlZnMgPSBbXTsKCQkJaWYgKCFBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IFtyZXRdOwoKCQkJcmVmcy5wdXNoKC4uLnJldC5maWx0ZXIociA9PiByLkVudGl0eUNsYXNzKSk7CgkJCWZvciBhd2FpdCAoY29uc3QgbyBvZiAob2JqcyB8fCBbXSkpIHsKCQkJCWxldCBvZmEgPSBbXTsKCQkJCWlmIChvLl90b0VNU09iamVjdCkgewoJCQkJCW9mYSA9IGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkuZmluZEFsbChkZXB0aCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlvZmEgPSBhd2FpdCBvLmZpbmRBbGwoZGVwdGgpOwoJCQkJfQoJCQkJcmVmcy5wdXNoKC4uLm9mYSk7CgkJCX0KCQkJcmVmcyA9IHJlZnMuZmlsdGVyKHIgPT4gcik7CgkJCXJlZnMuZm9yRWFjaChyID0+IHsKCQkJCWZvciAodmFyIHAgaW4gcikgewoJCQkJCWlmIChwLnN0YXJ0c1dpdGgoJ18nKSAmJiByW3BdICYmIHJbcCArICJfc2V0Il0gJiYgcltwXS5JZCAmJiByZWZzLmZpbmQobyA9PiBvLklkID09IHJbcF0uSWQpKSB7CgkJCQkJCXJbcC5zdWJzdHJpbmcoMSldKHJlZnMuZmluZChvID0+IG8uSWQgPT0gcltwXS5JZCkpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19maW5kUmVmZXJlbmNlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCn07CgpzYWxlc25vdy5Db250ZW50ID0gY2xhc3MgQ29udGVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKR2FXeGxVM2x6ZEdWdElpd2lSMmwwU0hWaUlsMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvbnRlbnQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvbnRlbnQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkNvbnRlbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250ZW50ICoqLwoJY29udGVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvbnRlbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb250ZW50Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb250ZW50ICE9IHYpIHsKCQkJCXRoaXMuX2NvbnRlbnRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvbnRlbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvbnRlbnQpOwoJCX0KCX0KCgljbGVhcl9jb250ZW50KCkgewoJCXRoaXMuX2NvbnRlbnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250ZW50ID0gbnVsbDsKCQl0aGlzLl9jb250ZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250ZW50ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fY29udGVudF9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fY29udGVudF9zZXQgPSB0aGlzLl9jb250ZW50X3NldDsKCQlyZXQuX2NvbnRlbnRfY29vcCA9IHRoaXMuX2NvbnRlbnRfY29vcDsKCQlyZXQuY29udGVudCA9IHRoaXMuY29udGVudCgpID8gdGhpcy5jb250ZW50KCkgOiB0aGlzLmNvbnRlbnQoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiY29udGVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0NvbnRlbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuQ29udGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuQ29udGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgQ29udGVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYENvbnRlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJGaWxlU3lzdGVtIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29udGVudC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiQ29udGVudCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Db250ZW50KHRoaXMuSWQpCgoJCQkuY29udGVudCh0aGlzLmNvbnRlbnQoKSwgdGhpcy5fY29udGVudF9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdDb250ZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkNvbnRlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ0NvbnRlbnQnCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qQ29udGVudCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJjb250ZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypDb250ZW50Ki8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRlbnQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvbnRlbnQodGFibGVbImNvbnRlbnQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQl0cnkgewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJbGV0IHVyaSA9IHRoaXMuX19jb25maWcoYHBhdGguJHtjb250ZW50Pyd3cml0ZSc6J3JlYWQnfWAsICcuLycpICsgZmlsZTsKCQkJaWYgKHRoaXMuX19jb25maWcoJ2xpdmUnLCB0cnVlKSkgewoJCQkJaWYgKHR5cGVvZihjb250ZW50KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkvLyB3cml0ZQoJCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJcmV0ID0gZ2xvYmFsLmZzLndyaXRlRmlsZVN5bmModXJpLCBjb250ZW50KTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZmlsZXN5c3RlbScsICdFbnRpdHlPYmplY3QnLCAxLCAiQ2Fubm90IHdyaXRlIHRvIGZpbGUgc3lzdGVtIik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyByZWFkCgkJCQkJaWYgKHVyaS5zdGFydHNXaXRoKCdodHRwJykgJiYgdXJpLmluZGV4T2YoJzovLycpID4gMCkgewoJCQkJCQlyZXQgPSBhd2FpdCB0aGlzLlRvb2wuYXhpb3MuZ2V0KHVyaSk7CgkJCQkJfSBlbHNlIGlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJcmV0ID0gZ2xvYmFsLmZzLnJlYWRGaWxlU3luYyh1cmkpOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ZpbGVzeXN0ZW0nLCAnRW50aXR5T2JqZWN0JywgMCwgdXJpLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19maWxlc3lzdGVtJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbGVOYW1lKF9jbGFzcywgb2JqLCBlYUNvZGUpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQljb250ZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQljb250ZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiY29udGVudCIsIG9iaiwgdGhpcy5jb250ZW50KCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImQ5OWQ4M2Q1LTAzMDAtNDU0Zi04MGI2LWRmZWEwYjcwMzFhNiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnY29udGVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvbnRlbnQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkOTlkODNkNS0wMzAwLTQ1NGYtODBiNi1kZmVhMGI3MDMxYTYiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnY29udGVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb250ZW50IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvbnRlbnRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29udGVudCgpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJY29udGVudDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb250ZW50KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQljb250ZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29udGVudF9zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuQ29udGVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Db250ZW50ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkNvbnRlbnQiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJY29udGVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29udGVudCA9IHYgPT0gcXVlcnkuY29udGVudCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb250ZW50X3NldCAmJiAhcXVlcnkuX2NvbnRlbnRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRlbnQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29udGVudF9zZXQgJiYgcXVlcnkuX2NvbnRlbnRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250ZW50ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2NvbnRlbnRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWNvbnRlbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSA6ICJjb250ZW50IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvbnRlbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvbnRlbnQocmVmKTsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImNvbnRlbnQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkgOiAiY29udGVudCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb250ZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb250ZW50X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29udGVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Db250ZW50KG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkZpbGVTeXN0ZW0iKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbnRlbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCQlhd2FpdCB0aGlzLl9maWxlc3lzdGVtKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Db250ZW50LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCQlhd2FpdCB0aGlzLl9maWxlc3lzdGVtKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Db250ZW50LmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkZpbGVTeXN0ZW0iKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2ZpbGVzeXN0ZW0odGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5Db250ZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuRGVwYXJ0bWVudCA9IGNsYXNzIERlcGFydG1lbnQgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibWFuYWdlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkRlcGFydG1lbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMuX21hbmFnZXIpIHRoaXMuX21hbmFnZXIuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlciAqKi8KCW1hbmFnZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibWFuYWdlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNycgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX21hbmFnZXIgIT0gdikgewoJCQkJdGhpcy5fbWFuYWdlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX21hbmFnZXIgPyB0aGlzLl9tYW5hZ2VyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9tYW5hZ2VyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9tYW5hZ2VyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21hbmFnZXIpOwoJCX0KCX0KCgljbGVhcl9tYW5hZ2VyKCkgewoJCXRoaXMuX21hbmFnZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudF9Vc2VycyAqKi8KCWRlcGFydG1lbnRfVXNlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2RlcGFydG1lbnRfVXNlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNycgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZGVwYXJ0bWVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50X1VzZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJkZXBhcnRtZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJVc2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudF9Vc2VycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZGVwYXJ0bWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIlVzZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZGVwYXJ0bWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpIHsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2VycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50X1VzZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbWFuYWdlcl9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9tYW5hZ2VyX3NldCA9IHRoaXMuX21hbmFnZXJfc2V0OwoJCXJldC5fbWFuYWdlcl9jb29wID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCXJldC5tYW5hZ2VyID0gdGhpcy5tYW5hZ2VyKCkgPyB0aGlzLm1hbmFnZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5tYW5hZ2VyKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5kZXBhcnRtZW50X1VzZXJzID0gdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJtYW5hZ2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBtYW5hZ2VyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0RlcGFydG1lbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgRGVwYXJ0bWVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYERlcGFydG1lbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJEZXBhcnRtZW50Iik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fbWFuYWdlcl9zZXQgJiYgdGhpcy5tYW5hZ2VyKCkpIHRoaXMubWFuYWdlcigpLl9fc3luY19vbihkKTsKCgkJCS8vIHRoaXMuZGVwYXJ0bWVudF9EZXBhcnRtZW50cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQodGhpcy5JZCkKCgkJCS5tYW5hZ2VyKHRoaXMubWFuYWdlcigpLCB0aGlzLl9tYW5hZ2VyX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmRlcGFydG1lbnRfVXNlcnModGhpcy5kZXBhcnRtZW50X1VzZXJzKCksIHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdEZXBhcnRtZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp0WVc1aFoyVnlJam9pVlhObGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiRGVwYXJ0bWVudCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnRGVwYXJ0bWVudCcKCQl9LCBvcHRpb25zIHx8IHt9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qRGVwYXJ0bWVudCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypEZXBhcnRtZW50Ki8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm1hbmFnZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm1hbmFnZXIodGFibGVbIm1hbmFnZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0NGZhZTFiZC0wMDg0LTRjOTYtOTZlMy04NzU4N2VjMTYwMWQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5tYW5hZ2VyKCkgfHwgKHRoaXMubWFuYWdlcigpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqLCB0aGlzLm1hbmFnZXIoKSk7CgkJfQoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudF9Vc2VycyIsIG9iaiwgdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNDRmYWUxYmQtMDA4NC00Yzk2LTk2ZTMtODc1ODdlYzE2MDFkIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRlcGFydG1lbnRfVXNlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJtYW5hZ2VyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX21hbmFnZXJfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm1hbmFnZXIoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm1hbmFnZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJbWFuYWdlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5tYW5hZ2VyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1hbmFnZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1hbmFnZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX21hbmFnZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9tYW5hZ2VyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJkZXBhcnRtZW50LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qZGVwYXJ0bWVudF9Vc2VycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWFuYWdlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5tYW5hZ2VyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSkgPT4gb2JqLm1hbmFnZXIgPSB2Ll90b1BhdGhzKCksCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IG9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuRGVwYXJ0bWVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5EZXBhcnRtZW50ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkKCgkJCQkJLm1hbmFnZXIobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLmRlcGFydG1lbnRfVXNlcnMobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJEZXBhcnRtZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm1hbmFnZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lm1hbmFnZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbWFuYWdlcl9zZXQgJiYgIXF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tYW5hZ2VyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX21hbmFnZXJfc2V0ICYmIHF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCgkJCQkJCSh0aGlzLm1hbmFnZXIoKSAmJiAhdGhpcy5tYW5hZ2VyKCkuX21hdGNoZXMocXVlcnkubWFuYWdlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWFuYWdlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkuZGVwYXJ0bWVudF9Vc2VycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbWFuYWdlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIG1hbmFnZXIiKTsKCQkJCQlvYmoubWFuYWdlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZGVwYXJ0bWVudF9Vc2VycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fbWFuYWdlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5tYW5hZ2VyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX21hbmFnZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubWFuYWdlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5tYW5hZ2VyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgbWFuYWdlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnRfVXNlcnMiKSkgPT4gdGhpcy5kZXBhcnRtZW50X1VzZXJzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJIm1hbmFnZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkgOiAibWFuYWdlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX21hbmFnZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX21hbmFnZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50X0RlcGFydG1lbnRzJywgdW5kZWZpbmVkKSA6ICJkZXBhcnRtZW50X1VzZXJzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VXNlcihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfbWFuYWdlciJdICYmIChhWyJfbWFuYWdlciJdLkVxdWFscyA/IGFbIl9tYW5hZ2VyIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9tYW5hZ2VyIl0sIHIpKSkgewoJCQkJCXIuX21hbmFnZXJfRGVwYXJ0bWVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMubWFuYWdlcigpICYmICEoYXdhaXQgdGhpcy5tYW5hZ2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fbWFuYWdlcl9zZXQpIHsKCgkJCQkJb2JqLm1hbmFnZXIgPSB0aGlzLl9tYW5hZ2VyLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkRlcGFydG1lbnQiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Qcmlvcml0eSA9IGNsYXNzIFByaW9yaXR5IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfcHJpb3JpdHlfSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiUHJpb3JpdHkiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLnByaW9yaXR5X0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eV9JbmNpZGVudHMgKiovCglwcmlvcml0eV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODkyYjdmMTUtMTJmZi00MDlhLTlkOWItNTg0MzIzN2FiM2E1JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fcHJpb3JpdHlfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHlfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJwcmlvcml0eSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInByaW9yaXR5IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YucHJpb3JpdHkodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3ByaW9yaXR5X0luY2lkZW50cygpIHsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQucHJpb3JpdHlfSW5jaWRlbnRzID0gdGhpcy5wcmlvcml0eV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5X1ByaW9yaXR5cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Qcmlvcml0eS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFByaW9yaXR5Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgUHJpb3JpdHkuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlByaW9yaXR5Iik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnByaW9yaXR5X1ByaW9yaXR5cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlByaW9yaXR5KHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnByaW9yaXR5X0luY2lkZW50cyh0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLCB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdQcmlvcml0eSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJQcmlvcml0eSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnUHJpb3JpdHknCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qUHJpb3JpdHkqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qUHJpb3JpdHkqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjMjAyYmZjMC03ZTk4LTQzZDEtYWRjZC01MTM5ZGE3MTYyYzQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInByaW9yaXR5X0luY2lkZW50cyIsIG9iaiwgdGhpcy5wcmlvcml0eV9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydwcmlvcml0eV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjMjAyYmZjMC03ZTk4LTQzZDEtYWRjZC01MTM5ZGE3MTYyYzQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInByaW9yaXR5LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnByaW9yaXR5X0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eSgpCgoJCQkJCS5wcmlvcml0eV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiUHJpb3JpdHkiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5wcmlvcml0eV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5wcmlvcml0eV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5wcmlvcml0eV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gdGhpcy5wcmlvcml0eV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiUHJpb3JpdHkiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5SZWFzb24gPSBjbGFzcyBSZWFzb24gZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiUmVhc29uIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbl9JbmNpZGVudHMgKiovCgljbG9zZV9yZWFzb25fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc4OTJiN2YxNS0xMmZmLTQwOWEtOWQ5Yi01ODQzMjM3YWIzYTUnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jbG9zZV9yZWFzb25fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2xvc2VfcmVhc29uIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNsb3NlX3JlYXNvbiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNsb3NlX3JlYXNvbih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY2xvc2VfcmVhc29uX0luY2lkZW50cygpIHsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb25fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvUmVhc29uLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBSZWFzb24uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBSZWFzb24uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlJlYXNvbi4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiUmVhc29uIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLmNsb3NlX3JlYXNvbl9SZWFzb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuUmVhc29uKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmNsb3NlX3JlYXNvbl9JbmNpZGVudHModGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCksIHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdSZWFzb24nOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGUzMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiUmVhc29uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdSZWFzb24nCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qUmVhc29uKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKlJlYXNvbiovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjdhYTgxMTc1LWUxNTktNDE4MS04ZmE0LWNiNTMyMjE0OWE4YiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydjbG9zZV9yZWFzb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiN2FhODExNzUtZTE1OS00MTgxLThmYTQtY2I1MzIyMTQ5YThiIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydjbG9zZV9yZWFzb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNsb3NlX3JlYXNvbi5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNsb3NlX3JlYXNvbl9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IG9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUmVhc29uKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlJlYXNvbiA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuUmVhc29uKCkKCgkJCQkJLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiUmVhc29uIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbl9JbmNpZGVudHMiKSkgPT4gdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlJlYXNvbi5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiUmVhc29uIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24udXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlJlYXNvbi5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuU3ltcHRvbSA9IGNsYXNzIFN5bXB0b20gZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9zeW1wdG9tX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN5bXB0b20iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b21fSW5jaWRlbnRzICoqLwoJc3ltcHRvbV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc4OTJiN2YxNS0xMmZmLTQwOWEtOWQ5Yi01ODQzMjM3YWIzYTUnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9zeW1wdG9tX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc3ltcHRvbSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfc3ltcHRvbV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5zeW1wdG9tX0luY2lkZW50cyA9IHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9TeW1wdG9tLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN5bXB0b20uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBTeW1wdG9tLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiU3ltcHRvbSIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5zeW1wdG9tX1N5bXB0b21zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuU3ltcHRvbSh0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5zeW1wdG9tX0luY2lkZW50cyh0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCksIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnU3ltcHRvbSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJTeW1wdG9tIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdTeW1wdG9tJwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlN5bXB0b20qLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qU3ltcHRvbSovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjMzZmQ0MTk0LWE5MGEtNDgyZi05YTgxLWQzNzBjZjVlNDAxOCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInN5bXB0b21fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3ltcHRvbV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIzM2ZkNDE5NC1hOTBhLTQ4MmYtOWE4MS1kMzcwY2Y1ZTQwMTgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInN5bXB0b21fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N5bXB0b21fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJzeW1wdG9tLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypzeW1wdG9tX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuU3ltcHRvbSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TeW1wdG9tID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkKCgkJCQkJLnN5bXB0b21fSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlN5bXB0b20iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc3ltcHRvbV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpIDogInN5bXB0b21fSW5jaWRlbnRzIikpID0+IHRoaXMuc3ltcHRvbV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TeW1wdG9tLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIlN5bXB0b20iKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20udXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5JbmNpZGVudCA9IGNsYXNzIEluY2lkZW50IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImxvY2F0aW9uIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9sb2NhdGlvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImdyb3VwIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9ncm91cCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN0YXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zdGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN5bXB0b20iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3N5bXB0b20oKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbG9zZV9yZWFzb24iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2Nsb3NlX3JlYXNvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInByaW9yaXR5IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wcmlvcml0eSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNhbGxlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2FsbGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29udGFjdCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29udGFjdCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiSW5jaWRlbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2xvY2F0aW9uX3NldCAmJiB0aGlzLl9sb2NhdGlvbikgdGhpcy5fbG9jYXRpb24uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLl9ncm91cCkgdGhpcy5fZ3JvdXAuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3N0YXRlX3NldCAmJiB0aGlzLl9zdGF0ZSkgdGhpcy5fc3RhdGUuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3N5bXB0b21fc2V0ICYmIHRoaXMuX3N5bXB0b20pIHRoaXMuX3N5bXB0b20uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5fY2xvc2VfcmVhc29uKSB0aGlzLl9jbG9zZV9yZWFzb24uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3ByaW9yaXR5X3NldCAmJiB0aGlzLl9wcmlvcml0eSkgdGhpcy5fcHJpb3JpdHkuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2NhbGxlcl9zZXQgJiYgdGhpcy5fY2FsbGVyKSB0aGlzLl9jYWxsZXIuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuX2NvbnRhY3QpIHRoaXMuX2NvbnRhY3QuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbiAqKi8KCWxvY2F0aW9uKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbG9jYXRpb25fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJsb2NhdGlvbiIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2I2ZGNmYzEyLTNjNzktNGRiZC05Y2JlLWRhMmQ0ZjdhMjlmZCcgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0xvY2F0aW9uJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiYjZkY2ZjMTItM2M3OS00ZGJkLTljYmUtZGEyZDRmN2EyOWZkIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkxvY2F0aW9uIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2xvY2F0aW9uICE9IHYpIHsKCQkJCXRoaXMuX2xvY2F0aW9uX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb24nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2xvY2F0aW9uID8gdGhpcy5fbG9jYXRpb24uU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2xvY2F0aW9uX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9sb2NhdGlvbiA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9sb2NhdGlvbik7CgkJfQoJfQoKCWNsZWFyX2xvY2F0aW9uKCkgewoJCXRoaXMuX2xvY2F0aW9uX3NldCA9IG51bGw7CgkJdGhpcy5fbG9jYXRpb24gPSBudWxsOwoJCXRoaXMuX2xvY2F0aW9uX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbiAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoJZ3JvdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImdyb3VwIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNThhNTg0ZDEtYTIwNS00OGFmLThkYmYtMGZhNDc2YTAwN2E2JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI1OGE1ODRkMS1hMjA1LTQ4YWYtOGRiZi0wZmE0NzZhMDA3YTYiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiR3JvdXAiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZ3JvdXAgIT0gdikgewoJCQkJdGhpcy5fZ3JvdXBfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fZ3JvdXAgPyB0aGlzLl9ncm91cC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fZ3JvdXBfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2dyb3VwID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2dyb3VwKTsKCQl9Cgl9CgoJY2xlYXJfZ3JvdXAoKSB7CgkJdGhpcy5fZ3JvdXBfc2V0ID0gbnVsbDsKCQl0aGlzLl9ncm91cCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGUgKiovCglzdGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3N0YXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic3RhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc1MGRkNThiOC0xNWExLTQ5MjMtYTY2NC0xNGQ0MGRjOWE2OTgnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdTdGF0ZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdGF0ZScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjUwZGQ1OGI4LTE1YTEtNDkyMy1hNjY0LTE0ZDQwZGM5YTY5OCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJTdGF0ZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9zdGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9zdGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9zdGF0ZSA/IHRoaXMuX3N0YXRlLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9zdGF0ZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fc3RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fc3RhdGUpOwoJCX0KCX0KCgljbGVhcl9zdGF0ZSgpIHsKCQl0aGlzLl9zdGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX3N0YXRlID0gbnVsbDsKCQl0aGlzLl9zdGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzeW1wdG9tICoqLwoJc3ltcHRvbSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3N5bXB0b21fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJzeW1wdG9tIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMzNmZDQxOTQtYTkwYS00ODJmLTlhODEtZDM3MGNmNWU0MDE4JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnU3ltcHRvbScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzeW1wdG9tJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMzNmZDQxOTQtYTkwYS00ODJmLTlhODEtZDM3MGNmNWU0MDE4IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlN5bXB0b20iKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc3ltcHRvbSAhPSB2KSB7CgkJCQl0aGlzLl9zeW1wdG9tX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3ltcHRvbScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fc3ltcHRvbSA/IHRoaXMuX3N5bXB0b20uU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3N5bXB0b21fc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3N5bXB0b20gPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fc3ltcHRvbSk7CgkJfQoJfQoKCWNsZWFyX3N5bXB0b20oKSB7CgkJdGhpcy5fc3ltcHRvbV9zZXQgPSBudWxsOwoJCXRoaXMuX3N5bXB0b20gPSBudWxsOwoJCXRoaXMuX3N5bXB0b21fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b20gKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb24gKiovCgljbG9zZV9yZWFzb24odiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jbG9zZV9yZWFzb25fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjbG9zZV9yZWFzb24iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc3YWE4MTE3NS1lMTU5LTQxODEtOGZhNC1jYjUzMjIxNDlhOGInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdSZWFzb24nKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiN2FhODExNzUtZTE1OS00MTgxLThmYTQtY2I1MzIyMTQ5YThiIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlJlYXNvbiIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jbG9zZV9yZWFzb24gIT0gdikgewoJCQkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jbG9zZV9yZWFzb24gPyB0aGlzLl9jbG9zZV9yZWFzb24uU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY2xvc2VfcmVhc29uID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2Nsb3NlX3JlYXNvbik7CgkJfQoJfQoKCWNsZWFyX2Nsb3NlX3JlYXNvbigpIHsKCQl0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID0gbnVsbDsKCQl0aGlzLl9jbG9zZV9yZWFzb24gPSBudWxsOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xvc2VfcmVhc29uICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcHJpb3JpdHkgKiovCglwcmlvcml0eSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3ByaW9yaXR5X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicHJpb3JpdHkiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjMjAyYmZjMC03ZTk4LTQzZDEtYWRjZC01MTM5ZGE3MTYyYzQnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdQcmlvcml0eScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImMyMDJiZmMwLTdlOTgtNDNkMS1hZGNkLTUxMzlkYTcxNjJjNCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJQcmlvcml0eSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9wcmlvcml0eSAhPSB2KSB7CgkJCQl0aGlzLl9wcmlvcml0eV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5JywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9wcmlvcml0eSA/IHRoaXMuX3ByaW9yaXR5LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9wcmlvcml0eV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fcHJpb3JpdHkgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcHJpb3JpdHkpOwoJCX0KCX0KCgljbGVhcl9wcmlvcml0eSgpIHsKCQl0aGlzLl9wcmlvcml0eV9zZXQgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5ID0gbnVsbDsKCQl0aGlzLl9wcmlvcml0eV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcHJpb3JpdHkgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYWxsZXIgKiovCgljYWxsZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jYWxsZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjYWxsZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc2NGM0MDU2OC1hZjhlLTRhNzItYjhkMS0xMWY3YzQxNzE1ZDcnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdVc2VyJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NhbGxlciAhPSB2KSB7CgkJCQl0aGlzLl9jYWxsZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2NhbGxlciA/IHRoaXMuX2NhbGxlci5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY2FsbGVyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9jYWxsZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY2FsbGVyKTsKCQl9Cgl9CgoJY2xlYXJfY2FsbGVyKCkgewoJCXRoaXMuX2NhbGxlcl9zZXQgPSBudWxsOwoJCXRoaXMuX2NhbGxlciA9IG51bGw7CgkJdGhpcy5fY2FsbGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYWxsZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250YWN0ICoqLwoJY29udGFjdCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvbnRhY3RfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb250YWN0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNjRjNDA1NjgtYWY4ZS00YTcyLWI4ZDEtMTFmN2M0MTcxNWQ3JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNjRjNDA1NjgtYWY4ZS00YTcyLWI4ZDEtMTFmN2M0MTcxNWQ3IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29udGFjdCAhPSB2KSB7CgkJCQl0aGlzLl9jb250YWN0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY29udGFjdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY29udGFjdCA/IHRoaXMuX2NvbnRhY3QuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2NvbnRhY3Rfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2NvbnRhY3QgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29udGFjdCk7CgkJfQoJfQoKCWNsZWFyX2NvbnRhY3QoKSB7CgkJdGhpcy5fY29udGFjdF9zZXQgPSBudWxsOwoJCXRoaXMuX2NvbnRhY3QgPSBudWxsOwoJCXRoaXMuX2NvbnRhY3RfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3QgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9sb2NhdGlvbl9zZXQsCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl9zdGF0ZV9zZXQsCgoJCQl0aGlzLl9zeW1wdG9tX3NldCwKCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQsCgoJCQl0aGlzLl9wcmlvcml0eV9zZXQsCgoJCQl0aGlzLl9jYWxsZXJfc2V0LAoKCQkJdGhpcy5fY29udGFjdF9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fbG9jYXRpb25fc2V0ID0gdGhpcy5fbG9jYXRpb25fc2V0OwoJCXJldC5fbG9jYXRpb25fY29vcCA9IHRoaXMuX2xvY2F0aW9uX2Nvb3A7CgkJcmV0LmxvY2F0aW9uID0gdGhpcy5sb2NhdGlvbigpID8gdGhpcy5sb2NhdGlvbigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmxvY2F0aW9uKCk7CgoJCXJldC5fZ3JvdXBfc2V0ID0gdGhpcy5fZ3JvdXBfc2V0OwoJCXJldC5fZ3JvdXBfY29vcCA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJcmV0Lmdyb3VwID0gdGhpcy5ncm91cCgpID8gdGhpcy5ncm91cCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmdyb3VwKCk7CgoJCXJldC5fc3RhdGVfc2V0ID0gdGhpcy5fc3RhdGVfc2V0OwoJCXJldC5fc3RhdGVfY29vcCA9IHRoaXMuX3N0YXRlX2Nvb3A7CgkJcmV0LnN0YXRlID0gdGhpcy5zdGF0ZSgpID8gdGhpcy5zdGF0ZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnN0YXRlKCk7CgoJCXJldC5fc3ltcHRvbV9zZXQgPSB0aGlzLl9zeW1wdG9tX3NldDsKCQlyZXQuX3N5bXB0b21fY29vcCA9IHRoaXMuX3N5bXB0b21fY29vcDsKCQlyZXQuc3ltcHRvbSA9IHRoaXMuc3ltcHRvbSgpID8gdGhpcy5zeW1wdG9tKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuc3ltcHRvbSgpOwoKCQlyZXQuX2Nsb3NlX3JlYXNvbl9zZXQgPSB0aGlzLl9jbG9zZV9yZWFzb25fc2V0OwoJCXJldC5fY2xvc2VfcmVhc29uX2Nvb3AgPSB0aGlzLl9jbG9zZV9yZWFzb25fY29vcDsKCQlyZXQuY2xvc2VfcmVhc29uID0gdGhpcy5jbG9zZV9yZWFzb24oKSA/IHRoaXMuY2xvc2VfcmVhc29uKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY2xvc2VfcmVhc29uKCk7CgoJCXJldC5fcHJpb3JpdHlfc2V0ID0gdGhpcy5fcHJpb3JpdHlfc2V0OwoJCXJldC5fcHJpb3JpdHlfY29vcCA9IHRoaXMuX3ByaW9yaXR5X2Nvb3A7CgkJcmV0LnByaW9yaXR5ID0gdGhpcy5wcmlvcml0eSgpID8gdGhpcy5wcmlvcml0eSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnByaW9yaXR5KCk7CgoJCXJldC5fY2FsbGVyX3NldCA9IHRoaXMuX2NhbGxlcl9zZXQ7CgkJcmV0Ll9jYWxsZXJfY29vcCA9IHRoaXMuX2NhbGxlcl9jb29wOwoJCXJldC5jYWxsZXIgPSB0aGlzLmNhbGxlcigpID8gdGhpcy5jYWxsZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jYWxsZXIoKTsKCgkJcmV0Ll9jb250YWN0X3NldCA9IHRoaXMuX2NvbnRhY3Rfc2V0OwoJCXJldC5fY29udGFjdF9jb29wID0gdGhpcy5fY29udGFjdF9jb29wOwoJCXJldC5jb250YWN0ID0gdGhpcy5jb250YWN0KCkgPyB0aGlzLmNvbnRhY3QoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jb250YWN0KCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImxvY2F0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJzdGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInN5bXB0b20iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNsb3NlX3JlYXNvbiI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJwcmlvcml0eSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNhbGxlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAibG9jYXRpb24iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGxvY2F0aW9uJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpLmxvY2F0aW9uX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gImdyb3VwIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBncm91cCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuR3JvdXAoKS5ncm91cF9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJzdGF0ZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3Igc3RhdGUnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlN0YXRlKCkuc3RhdGVfSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAic3ltcHRvbSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3Igc3ltcHRvbScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuU3ltcHRvbSgpLnN5bXB0b21fSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiY2xvc2VfcmVhc29uIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjbG9zZV9yZWFzb24nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlJlYXNvbigpLmNsb3NlX3JlYXNvbl9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJwcmlvcml0eSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcHJpb3JpdHknLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KCkucHJpb3JpdHlfSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiY2FsbGVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjYWxsZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWxsZXJfSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiY29udGFjdCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgY29udGFjdCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVXNlcigpLmNvbnRhY3RfSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQkJZGF0YS5yZWFzb24gPSBkYXRhLnJlYXNvbiA/IGRhdGEucmVhc29uCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0luY2lkZW50LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgInRlc3RTeW5jIjogewoKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpblByb2dyZXNzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgInRlc3RTeW5jIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpblByb2dyZXNzIjogewoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMucmVhc29uKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgSW5jaWRlbnQuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBJbmNpZGVudC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiSW5jaWRlbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpKSB0aGlzLmxvY2F0aW9uKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkpIHRoaXMuZ3JvdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuc3RhdGUoKSkgdGhpcy5zdGF0ZSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSkgdGhpcy5zeW1wdG9tKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSkgdGhpcy5jbG9zZV9yZWFzb24oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMucHJpb3JpdHkoKSkgdGhpcy5wcmlvcml0eSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkpIHRoaXMuY2FsbGVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuY29udGFjdCgpKSB0aGlzLmNvbnRhY3QoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkluY2lkZW50KHRoaXMuSWQpCgoJCQkubG9jYXRpb24odGhpcy5sb2NhdGlvbigpLCB0aGlzLl9sb2NhdGlvbl9jb29wKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS5zdGF0ZSh0aGlzLnN0YXRlKCksIHRoaXMuX3N0YXRlX2Nvb3ApCgoJCQkuc3ltcHRvbSh0aGlzLnN5bXB0b20oKSwgdGhpcy5fc3ltcHRvbV9jb29wKQoKCQkJLmNsb3NlX3JlYXNvbih0aGlzLmNsb3NlX3JlYXNvbigpLCB0aGlzLl9jbG9zZV9yZWFzb25fY29vcCkKCgkJCS5wcmlvcml0eSh0aGlzLnByaW9yaXR5KCksIHRoaXMuX3ByaW9yaXR5X2Nvb3ApCgoJCQkuY2FsbGVyKHRoaXMuY2FsbGVyKCksIHRoaXMuX2NhbGxlcl9jb29wKQoKCQkJLmNvbnRhY3QodGhpcy5jb250YWN0KCksIHRoaXMuX2NvbnRhY3RfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnSW5jaWRlbnQnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnNiMk5oZEdsdmJpSTZJa3h2WTJGMGFXOXVJaXdpWjNKdmRYQWlPaUpIY205MWNDSXNJbk4wWVhSbElqb2lVM1JoZEdVaUxDSnplVzF3ZEc5dElqb2lVM2x0Y0hSdmJTSXNJbU5zYjNObFgzSmxZWE52YmlJNklsSmxZWE52YmlJc0luQnlhVzl5YVhSNUlqb2lVSEpwYjNKcGRIa2lMQ0pqWVd4c1pYSWlPaUpWYzJWeUlpd2lZMjl1ZEdGamRDSTZJbFZ6WlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiSW5jaWRlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ0luY2lkZW50JwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiB0ZXN0U3luYy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB0ZXN0U3luYygpIHsKCgkJbGV0IGFuc3dlciA9IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ0ZXN0U3luYyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0ZXN0U3luYyIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInRlc3RTeW5jIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQudGVzdFN5bmMnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rlc3RTeW5jJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbGV0IGluYyA9IGF3YWl0IG5ldyBvU2NvcGUuSW5jaWRlbnQoKS5udW1iZXIoIklOQzEyMzQiKS50aXRsZSgiVGVzdGluZyIpLmdyb3VwKG5ldyBvU2NvcGUuR3JvdXAoKS5uYW1lKCJHcm91cDEiKSkuc3RhdGUobmV3IG9TY29wZS5TdGF0ZSgpLm5hbWUoIkFzc2lnbmVkIikpLnByaW9yaXR5KG5ldyBvU2NvcGUuUHJpb3JpdHkoKS5uYW1lKCJIaWdoIikuY29kZSgiUDEiKSkuY2FsbGVyKG5ldyBvU2NvcGUuVXNlcigpLnVzZXJuYW1lKCJmYWRpIikubmFtZSgiRmFkaSIpKS5zdG9yZSgpOwoJCQlpbmMuVG9vbCA9ICJNb25nb0RCIjsKCQkJcmV0dXJuIGF3YWl0IGluYy5zdG9yZSgpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpblByb2dyZXNzLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluUHJvZ3Jlc3MocmVhc29uKSB7CgoJCWxldCBhbnN3ZXIgPSBmYWxzZTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5Qcm9ncmVzcyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpblByb2dyZXNzIiwgX25vZGUsIHJlYXNvbikgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5Qcm9ncmVzcyIsIHJlYXNvbikgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LmluUHJvZ3Jlc3MnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luUHJvZ3Jlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCXJlYXNvbjogcmVhc29uCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkluY2lkZW50Ki8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImxvY2F0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInN5bXB0b20iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjbG9zZV9yZWFzb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImNhbGxlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypJbmNpZGVudCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJsb2NhdGlvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubG9jYXRpb24odGFibGVbImxvY2F0aW9uIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ncm91cCh0YWJsZVsiZ3JvdXAiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3RhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnN0YXRlKHRhYmxlWyJzdGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzeW1wdG9tIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5zeW1wdG9tKHRhYmxlWyJzeW1wdG9tIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNsb3NlX3JlYXNvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2xvc2VfcmVhc29uKHRhYmxlWyJjbG9zZV9yZWFzb24iXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicHJpb3JpdHkiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnByaW9yaXR5KHRhYmxlWyJwcmlvcml0eSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjYWxsZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNhbGxlcih0YWJsZVsiY2FsbGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRhY3QiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvbnRhY3QodGFibGVbImNvbnRhY3QiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdMb2NhdGlvbicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0xvY2F0aW9uJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdHcm91cCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXN0YXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdTdGF0ZScsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1N0YXRlJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnU3ltcHRvbScsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1N5bXB0b20nLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnUmVhc29uJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnUmVhc29uJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXByaW9yaXR5OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdQcmlvcml0eScsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1ByaW9yaXR5JywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg5MmI3ZjE1LTEyZmYtNDA5YS05ZDliLTU4NDMyMzdhYjNhNSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMubG9jYXRpb24oKSB8fCAodGhpcy5sb2NhdGlvbigpCgoJCQkJJiYKCQkJCSF0aGlzLmxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaiwgdGhpcy5sb2NhdGlvbigpKTsKCQl9CgoJCWlmICghdGhpcy5ncm91cCgpIHx8ICh0aGlzLmdyb3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJncm91cCIsIG9iaiwgdGhpcy5ncm91cCgpKTsKCQl9CgoJCWlmICghdGhpcy5zdGF0ZSgpIHx8ICh0aGlzLnN0YXRlKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3RhdGUoKS5zdGF0ZV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInN0YXRlIiwgb2JqLCB0aGlzLnN0YXRlKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnN5bXB0b20oKSB8fCAodGhpcy5zeW1wdG9tKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3ltcHRvbSgpLnN5bXB0b21fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqLCB0aGlzLnN5bXB0b20oKSk7CgkJfQoKCQlpZiAoIXRoaXMuY2xvc2VfcmVhc29uKCkgfHwgKHRoaXMuY2xvc2VfcmVhc29uKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2xvc2VfcmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbigpKTsKCQl9CgoJCWlmICghdGhpcy5wcmlvcml0eSgpIHx8ICh0aGlzLnByaW9yaXR5KCkKCgkJCQkmJgoJCQkJIXRoaXMucHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInByaW9yaXR5Iiwgb2JqLCB0aGlzLnByaW9yaXR5KCkpOwoJCX0KCgkJaWYgKCF0aGlzLmNhbGxlcigpIHx8ICh0aGlzLmNhbGxlcigpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FsbGVyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImNhbGxlciIsIG9iaiwgdGhpcy5jYWxsZXIoKSk7CgkJfQoKCQlpZiAoIXRoaXMuY29udGFjdCgpIHx8ICh0aGlzLmNvbnRhY3QoKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY29udGFjdCgpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaiwgdGhpcy5jb250YWN0KCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbG9jYXRpb24nLCAnZ3JvdXAnLCAnc3RhdGUnLCAnc3ltcHRvbScsICdjbG9zZV9yZWFzb24nLCAncHJpb3JpdHknLCAnY2FsbGVyJywgJ2NvbnRhY3QnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg5MmI3ZjE1LTEyZmYtNDA5YS05ZDliLTU4NDMyMzdhYjNhNSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJzdGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqKTsKCgkJX29wdGlvbnMoImNsb3NlX3JlYXNvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJwcmlvcml0eSIsIG9iaik7CgoJCV9vcHRpb25zKCJjYWxsZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2xvY2F0aW9uJywgJ2dyb3VwJywgJ3N0YXRlJywgJ3N5bXB0b20nLCAnY2xvc2VfcmVhc29uJywgJ3ByaW9yaXR5JywgJ2NhbGxlcicsICdjb250YWN0JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImxvY2F0aW9uIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2xvY2F0aW9uX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5sb2NhdGlvbigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2dyb3VwX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5ncm91cCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInN0YXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3N0YXRlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zdGF0ZSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInN5bXB0b20iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc3ltcHRvbV9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuc3ltcHRvbSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xvc2VfcmVhc29uIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY2xvc2VfcmVhc29uKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInByaW9yaXR5IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3ByaW9yaXR5X3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5wcmlvcml0eSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNhbGxlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jYWxsZXJfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNhbGxlcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb250YWN0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvbnRhY3Rfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvbnRhY3QoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmxvY2F0aW9uKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnN0YXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnN5bXB0b20pIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jbG9zZV9yZWFzb24pIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnByaW9yaXR5KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNhbGxlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29udGFjdCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlsb2NhdGlvbjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubG9jYXRpb24ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZ3JvdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc3RhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnN5bXB0b20ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jbG9zZV9yZWFzb24ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucHJpb3JpdHkob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jYWxsZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvbnRhY3Qob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubG9jYXRpb24pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmxvY2F0aW9ufSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXB9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnN0YXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zdGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc3ltcHRvbSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc3ltcHRvbX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jbG9zZV9yZWFzb24pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNsb3NlX3JlYXNvbn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnByaW9yaXR5KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wcmlvcml0eX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2FsbGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jYWxsZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb250YWN0KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb250YWN0fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2xvY2F0aW9uX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fbG9jYXRpb25fY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc3RhdGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9zdGF0ZV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zeW1wdG9tX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2xvc2VfcmVhc29uX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcHJpb3JpdHlfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9wcmlvcml0eV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2FsbGVyX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fY2FsbGVyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvbnRhY3Rfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5sb2NhdGlvbikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubG9jYXRpb259YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnN0YXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5zdGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zeW1wdG9tKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnN5bXB0b219YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2xvc2VfcmVhc29uKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY2xvc2VfcmVhc29ufWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnByaW9yaXR5KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5wcmlvcml0eX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jYWxsZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jYWxsZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29udGFjdCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb250YWN0fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiBvYmoubG9jYXRpb24gPSB2Ll90b1BhdGhzKCksCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwID0gdi5fdG9QYXRocygpLAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IG9iai5zdGF0ZSA9IHYuX3RvUGF0aHMoKSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN5bXB0b20gPSB2Ll90b1BhdGhzKCksCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiBvYmouY2xvc2VfcmVhc29uID0gdi5fdG9QYXRocygpLAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IG9iai5wcmlvcml0eSA9IHYuX3RvUGF0aHMoKSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IG9iai5jYWxsZXIgPSB2Ll90b1BhdGhzKCksCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IG9iai5jb250YWN0ID0gdi5fdG9QYXRocygpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkluY2lkZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkluY2lkZW50ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpCgoJCQkJCS5sb2NhdGlvbihuZXcgc2FsZXNub3cuTG9jYXRpb24oKSkKCgkJCQkJLmdyb3VwKG5ldyBzYWxlc25vdy5Hcm91cCgpKQoKCQkJCQkuc3RhdGUobmV3IHNhbGVzbm93LlN0YXRlKCkpCgoJCQkJCS5zeW1wdG9tKG5ldyBzYWxlc25vdy5TeW1wdG9tKCkpCgoJCQkJCS5jbG9zZV9yZWFzb24obmV3IHNhbGVzbm93LlJlYXNvbigpKQoKCQkJCQkucHJpb3JpdHkobmV3IHNhbGVzbm93LlByaW9yaXR5KCkpCgoJCQkJCS5jYWxsZXIobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLmNvbnRhY3QobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJJbmNpZGVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlsb2NhdGlvbjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubG9jYXRpb24gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmxvY2F0aW9uKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2xvY2F0aW9uX3NldCAmJiAhcXVlcnkuX2xvY2F0aW9uX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5sb2NhdGlvbiA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9sb2NhdGlvbl9zZXQgJiYgcXVlcnkuX2xvY2F0aW9uX3NldCkgfHwKCgkJCQkJCSh0aGlzLmxvY2F0aW9uKCkgJiYgIXRoaXMubG9jYXRpb24oKS5fbWF0Y2hlcyhxdWVyeS5sb2NhdGlvbigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubG9jYXRpb24gPSBmYWxzZTsKCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmdyb3VwID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5ncm91cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ncm91cF9zZXQgJiYgIXF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZ3JvdXBfc2V0ICYmIHF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgoJCQkJCQkodGhpcy5ncm91cCgpICYmICF0aGlzLmdyb3VwKCkuX21hdGNoZXMocXVlcnkuZ3JvdXAoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zdGF0ZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuc3RhdGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc3RhdGVfc2V0ICYmICFxdWVyeS5fc3RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN0YXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3N0YXRlX3NldCAmJiBxdWVyeS5fc3RhdGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMuc3RhdGUoKSAmJiAhdGhpcy5zdGF0ZSgpLl9tYXRjaGVzKHF1ZXJ5LnN0YXRlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zdGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zeW1wdG9tID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5zeW1wdG9tKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3N5bXB0b21fc2V0ICYmICFxdWVyeS5fc3ltcHRvbV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3ltcHRvbSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zeW1wdG9tX3NldCAmJiBxdWVyeS5fc3ltcHRvbV9zZXQpIHx8CgoJCQkJCQkodGhpcy5zeW1wdG9tKCkgJiYgIXRoaXMuc3ltcHRvbSgpLl9tYXRjaGVzKHF1ZXJ5LnN5bXB0b20oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN5bXB0b20gPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmNsb3NlX3JlYXNvbigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jbG9zZV9yZWFzb25fc2V0ICYmICFxdWVyeS5fY2xvc2VfcmVhc29uX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbG9zZV9yZWFzb24gPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiBxdWVyeS5fY2xvc2VfcmVhc29uX3NldCkgfHwKCgkJCQkJCSh0aGlzLmNsb3NlX3JlYXNvbigpICYmICF0aGlzLmNsb3NlX3JlYXNvbigpLl9tYXRjaGVzKHF1ZXJ5LmNsb3NlX3JlYXNvbigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xvc2VfcmVhc29uID0gZmFsc2U7CgkJCQl9LAoKCQkJCXByaW9yaXR5OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wcmlvcml0eSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkucHJpb3JpdHkoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcHJpb3JpdHlfc2V0ICYmICFxdWVyeS5fcHJpb3JpdHlfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnByaW9yaXR5ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3ByaW9yaXR5X3NldCAmJiBxdWVyeS5fcHJpb3JpdHlfc2V0KSB8fAoKCQkJCQkJKHRoaXMucHJpb3JpdHkoKSAmJiAhdGhpcy5wcmlvcml0eSgpLl9tYXRjaGVzKHF1ZXJ5LnByaW9yaXR5KCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wcmlvcml0eSA9IGZhbHNlOwoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNhbGxlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY2FsbGVyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NhbGxlcl9zZXQgJiYgIXF1ZXJ5Ll9jYWxsZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhbGxlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jYWxsZXJfc2V0ICYmIHF1ZXJ5Ll9jYWxsZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMuY2FsbGVyKCkgJiYgIXRoaXMuY2FsbGVyKCkuX21hdGNoZXMocXVlcnkuY2FsbGVyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jYWxsZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29udGFjdDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29udGFjdCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY29udGFjdCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb250YWN0X3NldCAmJiAhcXVlcnkuX2NvbnRhY3Rfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRhY3QgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29udGFjdF9zZXQgJiYgcXVlcnkuX2NvbnRhY3Rfc2V0KSB8fAoKCQkJCQkJKHRoaXMuY29udGFjdCgpICYmICF0aGlzLmNvbnRhY3QoKS5fbWF0Y2hlcyhxdWVyeS5jb250YWN0KCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250YWN0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgbG9jYXRpb24iKTsKCQkJCQlvYmoubG9jYXRpb24gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGdyb3VwIik7CgkJCQkJb2JqLmdyb3VwID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzdGF0ZSIpOwoJCQkJCW9iai5zdGF0ZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzeW1wdG9tIik7CgkJCQkJb2JqLnN5bXB0b20gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjbG9zZV9yZWFzb24iKTsKCQkJCQlvYmouY2xvc2VfcmVhc29uID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBwcmlvcml0eSIpOwoJCQkJCW9iai5wcmlvcml0eSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNhbGxlciIpOwoJCQkJCW9iai5jYWxsZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgY29udGFjdCIpOwoJCQkJCW9iai5jb250YWN0ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fbG9jYXRpb25fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZ3JvdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc3RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc3ltcHRvbV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcHJpb3JpdHlfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2FsbGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvbnRhY3Rfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmxvY2F0aW9uKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmdyb3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnN0YXRlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuc3ltcHRvbShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY2xvc2VfcmVhc29uKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnByaW9yaXR5KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5jYWxsZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5jb250YWN0KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpIDogImxvY2F0aW9uIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2xvY2F0aW9uX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmxvY2F0aW9uKCkgfHwgbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5sb2NhdGlvbihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGxvY2F0aW9uIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9ncm91cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ncm91cCgpIHx8IG5ldyBzYWxlc25vdy5Hcm91cCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZ3JvdXAob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBncm91cCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgOiAic3RhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fc3RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuc3RhdGUoKSB8fCBuZXcgc2FsZXNub3cuU3RhdGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnN0YXRlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc3RhdGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3N5bXB0b21fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuc3ltcHRvbSgpIHx8IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5zeW1wdG9tKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc3ltcHRvbSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb24iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNsb3NlX3JlYXNvbigpIHx8IG5ldyBzYWxlc25vdy5SZWFzb24oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmNsb3NlX3JlYXNvbihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNsb3NlX3JlYXNvbiIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgOiAicHJpb3JpdHkiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcHJpb3JpdHlfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucHJpb3JpdHkoKSB8fCBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnByaW9yaXR5KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgcHJpb3JpdHkiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgOiAiY2FsbGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NhbGxlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5jYWxsZXIoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2FsbGVyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY2FsbGVyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgOiAiY29udGFjdCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb250YWN0X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNvbnRhY3QoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY29udGFjdChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNvbnRhY3QiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpIDogImxvY2F0aW9uIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbG9jYXRpb25fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpIDogInN0YXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N0YXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3ltcHRvbV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNsb3NlX3JlYXNvbiI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbiIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpIDogInByaW9yaXR5IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3ByaW9yaXR5X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgOiAiY2FsbGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY2FsbGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jYWxsZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpIDogImNvbnRhY3QiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jb250YWN0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieUxvY2F0aW9uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9sb2NhdGlvbiJdICYmIChhWyJfbG9jYXRpb24iXS5FcXVhbHMgPyBhWyJfbG9jYXRpb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2xvY2F0aW9uIl0sIHIpKSkgewoJCQkJCXIuX2xvY2F0aW9uX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5R3JvdXAoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2dyb3VwIl0gJiYgKGFbIl9ncm91cCJdLkVxdWFscyA/IGFbIl9ncm91cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZ3JvdXAiXSwgcikpKSB7CgkJCQkJci5fZ3JvdXBfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlTdGF0ZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfc3RhdGUiXSAmJiAoYVsiX3N0YXRlIl0uRXF1YWxzID8gYVsiX3N0YXRlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9zdGF0ZSJdLCByKSkpIHsKCQkJCQlyLl9zdGF0ZV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVN5bXB0b20oYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3N5bXB0b20iXSAmJiAoYVsiX3N5bXB0b20iXS5FcXVhbHMgPyBhWyJfc3ltcHRvbSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfc3ltcHRvbSJdLCByKSkpIHsKCQkJCQlyLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5UmVhc29uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jbG9zZV9yZWFzb24iXSAmJiAoYVsiX2Nsb3NlX3JlYXNvbiJdLkVxdWFscyA/IGFbIl9jbG9zZV9yZWFzb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2Nsb3NlX3JlYXNvbiJdLCByKSkpIHsKCQkJCQlyLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlQcmlvcml0eShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcHJpb3JpdHkiXSAmJiAoYVsiX3ByaW9yaXR5Il0uRXF1YWxzID8gYVsiX3ByaW9yaXR5Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wcmlvcml0eSJdLCByKSkpIHsKCQkJCQlyLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NhbGxlciJdICYmIChhWyJfY2FsbGVyIl0uRXF1YWxzID8gYVsiX2NhbGxlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY2FsbGVyIl0sIHIpKSkgewoJCQkJCXIuX2NhbGxlcl9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NvbnRhY3QiXSAmJiAoYVsiX2NvbnRhY3QiXS5FcXVhbHMgPyBhWyJfY29udGFjdCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY29udGFjdCJdLCByKSkpIHsKCQkJCQlyLl9jb250YWN0X0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fbG9jYXRpb25fc2V0ICYmIHRoaXMubG9jYXRpb24oKSAmJiAhKGF3YWl0IHRoaXMubG9jYXRpb24oKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9sb2NhdGlvbigpOwoKCQkJCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuZ3JvdXAoKSAmJiAhKGF3YWl0IHRoaXMuZ3JvdXAoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9ncm91cCgpOwoKCQkJCQlpZiAodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuc3RhdGUoKSAmJiAhKGF3YWl0IHRoaXMuc3RhdGUoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9zdGF0ZSgpOwoKCQkJCQlpZiAodGhpcy5fc3ltcHRvbV9zZXQgJiYgdGhpcy5zeW1wdG9tKCkgJiYgIShhd2FpdCB0aGlzLnN5bXB0b20oKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9zeW1wdG9tKCk7CgoJCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fc2V0ICYmIHRoaXMuY2xvc2VfcmVhc29uKCkgJiYgIShhd2FpdCB0aGlzLmNsb3NlX3JlYXNvbigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2Nsb3NlX3JlYXNvbigpOwoKCQkJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMucHJpb3JpdHkoKSAmJiAhKGF3YWl0IHRoaXMucHJpb3JpdHkoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9wcmlvcml0eSgpOwoKCQkJCQlpZiAodGhpcy5fY2FsbGVyX3NldCAmJiB0aGlzLmNhbGxlcigpICYmICEoYXdhaXQgdGhpcy5jYWxsZXIoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jYWxsZXIoKTsKCgkJCQkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuY29udGFjdCgpICYmICEoYXdhaXQgdGhpcy5jb250YWN0KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY29udGFjdCgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fbG9jYXRpb25fc2V0KSB7CgoJCQkJCW9iai5sb2NhdGlvbiA9IHRoaXMuX2xvY2F0aW9uLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZ3JvdXBfc2V0KSB7CgoJCQkJCW9iai5ncm91cCA9IHRoaXMuX2dyb3VwLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fc3RhdGVfc2V0KSB7CgoJCQkJCW9iai5zdGF0ZSA9IHRoaXMuX3N0YXRlLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fc3ltcHRvbV9zZXQpIHsKCgkJCQkJb2JqLnN5bXB0b20gPSB0aGlzLl9zeW1wdG9tLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX3NldCkgewoKCQkJCQlvYmouY2xvc2VfcmVhc29uID0gdGhpcy5fY2xvc2VfcmVhc29uLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0KSB7CgoJCQkJCW9iai5wcmlvcml0eSA9IHRoaXMuX3ByaW9yaXR5LklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY2FsbGVyX3NldCkgewoKCQkJCQlvYmouY2FsbGVyID0gdGhpcy5fY2FsbGVyLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29udGFjdF9zZXQpIHsKCgkJCQkJb2JqLmNvbnRhY3QgPSB0aGlzLl9jb250YWN0LklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkluY2lkZW50IikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuU3RhdGUgPSBjbGFzcyBTdGF0ZSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3N0YXRlX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN0YXRlIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5zdGF0ZV9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoJc3RhdGVfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9zdGF0ZV9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzg5MmI3ZjE1LTEyZmYtNDA5YS05ZDliLTU4NDMyMzdhYjNhNScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3N0YXRlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic3RhdGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGVfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdGF0ZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnN0YXRlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3N0YXRlX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9zdGF0ZV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnN0YXRlX0luY2lkZW50cyA9IHRoaXMuc3RhdGVfSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvU3RhdGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBTdGF0ZS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFN0YXRlLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJTdGF0ZSIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5zdGF0ZV9TdGF0ZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5TdGF0ZSh0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5zdGF0ZV9JbmNpZGVudHModGhpcy5zdGF0ZV9JbmNpZGVudHMoKSwgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnU3RhdGUnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGUzMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiU3RhdGUiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ1N0YXRlJwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlN0YXRlKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKlN0YXRlKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbGVOYW1lKF9jbGFzcywgb2JqLCBlYUNvZGUpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTBkZDU4YjgtMTVhMS00OTIzLWE2NjQtMTRkNDBkYzlhNjk4IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJzdGF0ZV9JbmNpZGVudHMiLCBvYmosIHRoaXMuc3RhdGVfSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3RhdGVfSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTBkZDU4YjgtMTVhMS00OTIzLWE2NjQtMTRkNDBkYzlhNjk4IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInN0YXRlX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzdGF0ZV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJLy8gTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJzdGF0ZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypzdGF0ZV9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TdGF0ZSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TdGF0ZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuU3RhdGUoKQoKCQkJCQkuc3RhdGVfSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlN0YXRlIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouc3RhdGVfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc3RhdGVfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouc3RhdGVfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnN0YXRlX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkgOiAic3RhdGVfSW5jaWRlbnRzIikpID0+IHRoaXMuc3RhdGVfSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkgOiAic3RhdGVfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zdGF0ZV9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIlN0YXRlIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuR3JvdXAgPSBjbGFzcyBHcm91cCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9ncm91cF9JbmNpZGVudHMoKTsKCgkJdGhpcy5jbGVhcl9ncm91cF9Hcm91cF9NZW1iZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiR3JvdXAiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLmdyb3VwX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3BlbkluY2lkZW50VGhyZWFzaG9sZCAqKi8KCW9wZW5JbmNpZGVudFRocmVhc2hvbGQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQgIT0gdikgewoJCQkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkKTsKCQl9Cgl9CgoJY2xlYXJfb3BlbkluY2lkZW50VGhyZWFzaG9sZCgpIHsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA9IG51bGw7CgkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IG51bGw7CgkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3BlbkluY2lkZW50VGhyZWFzaG9sZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX0luY2lkZW50cyAqKi8KCWdyb3VwX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fZ3JvdXBfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc4OTJiN2YxNS0xMmZmLTQwOWEtOWQ5Yi01ODQzMjM3YWIzYTUnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ncm91cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5ncm91cCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9ncm91cF9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZ3JvdXBfSW5jaWRlbnRzKCkgewoJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX0luY2lkZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX0dyb3VwX01lbWJlcnMgKiovCglncm91cF9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc5MDMyOWQ2Mi02ZDZhLTRiMTUtYmE2MS1mZDViNzZiNzY3MTknICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0dyb3VwIE1lbWJlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZ3JvdXBfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkdyb3VwX01lbWJlciIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lmdyb3VwKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ncm91cF9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0ID0gbnVsbDsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX0dyb3VwX01lbWJlcnMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0LAoKCQkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA9IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0OwoJCXJldC5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wID0gdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wOwoJCXJldC5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkgPyB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSA6IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQuZ3JvdXBfSW5jaWRlbnRzID0gdGhpcy5ncm91cF9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5ncm91cF9Hcm91cF9NZW1iZXJzID0gdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgR3JvdXAuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiR3JvdXAiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuR3JvdXAodGhpcy5JZCkKCgkJCS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpLCB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmdyb3VwX0luY2lkZW50cyh0aGlzLmdyb3VwX0luY2lkZW50cygpLCB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCkKCgkJCS5ncm91cF9Hcm91cF9NZW1iZXJzKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpLCB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnR3JvdXAnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGUzMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiR3JvdXAiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ0dyb3VwJwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qR3JvdXAqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkib3BlbkluY2lkZW50VGhyZWFzaG9sZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypHcm91cCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHRhYmxlWyJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbGVOYW1lKF9jbGFzcywgb2JqLCBlYUNvZGUpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygib3BlbkluY2lkZW50VGhyZWFzaG9sZCIsIG9iaiwgdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU4YTU4NGQxLWEyMDUtNDhhZi04ZGJmLTBmYTQ3NmEwMDdhNiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygiZ3JvdXBfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmdyb3VwX0luY2lkZW50cygpKTsKCgkJX29wdGlvbnMoImdyb3VwX0dyb3VwX01lbWJlcnMiLCBvYmosIHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZ3JvdXBfSW5jaWRlbnRzJywgJ2dyb3VwX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygib3BlbkluY2lkZW50VGhyZWFzaG9sZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU4YTU4NGQxLWEyMDUtNDhhZi04ZGJmLTBmYTQ3NmEwMDdhNiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cF9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygiZ3JvdXBfR3JvdXBfTWVtYmVycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX0luY2lkZW50cycsICdncm91cF9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3BlbkluY2lkZW50VGhyZWFzaG9sZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJncm91cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypncm91cF9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiZ3JvdXAuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICc9JyB8fCB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypncm91cF9Hcm91cF9NZW1iZXJzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouZ3JvdXBfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Hcm91cCgpCgoJCQkJCS5ncm91cF9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5ncm91cF9Hcm91cF9NZW1iZXJzKG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJHcm91cCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdiA9PSBxdWVyeS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ICYmICFxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiBxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ncm91cF9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkgOiAib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHJlZik7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9JbmNpZGVudHMiKSkgPT4gdGhpcy5ncm91cF9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Hcm91cF9NZW1iZXJzIikpID0+IHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkgOiAib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0KSB7CgoJCQkJCW9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiR3JvdXAiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Hcm91cF9NZW1iZXIgPSBjbGFzcyBHcm91cF9NZW1iZXIgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZ3JvdXAiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidXNlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdXNlcigpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkdyb3VwIE1lbWJlciIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fdXNlcl9zZXQgJiYgdGhpcy5fdXNlcikgdGhpcy5fdXNlci5Ub29sID0gdG9vbDsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoJZ3JvdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImdyb3VwIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNThhNTg0ZDEtYTIwNS00OGFmLThkYmYtMGZhNDc2YTAwN2E2JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI1OGE1ODRkMS1hMjA1LTQ4YWYtOGRiZi0wZmE0NzZhMDA3YTYiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiR3JvdXAiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZ3JvdXAgIT0gdikgewoJCQkJdGhpcy5fZ3JvdXBfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fZ3JvdXAgPyB0aGlzLl9ncm91cC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fZ3JvdXBfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2dyb3VwID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2dyb3VwKTsKCQl9Cgl9CgoJY2xlYXJfZ3JvdXAoKSB7CgkJdGhpcy5fZ3JvdXBfc2V0ID0gbnVsbDsKCQl0aGlzLl9ncm91cCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlciAqKi8KCXVzZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl91c2VyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidXNlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNycgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjY0YzQwNTY4LWFmOGUtNGE3Mi1iOGQxLTExZjdjNDE3MTVkNyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3VzZXIgIT0gdikgewoJCQkJdGhpcy5fdXNlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VzZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3VzZXIgPyB0aGlzLl91c2VyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl91c2VyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl91c2VyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3VzZXIpOwoJCX0KCX0KCgljbGVhcl91c2VyKCkgewoJCXRoaXMuX3VzZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl91c2VyID0gbnVsbDsKCQl0aGlzLl91c2VyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fZ3JvdXBfc2V0LAoKCQkJdGhpcy5fdXNlcl9zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9ncm91cF9zZXQgPSB0aGlzLl9ncm91cF9zZXQ7CgkJcmV0Ll9ncm91cF9jb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQlyZXQuZ3JvdXAgPSB0aGlzLmdyb3VwKCkgPyB0aGlzLmdyb3VwKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZ3JvdXAoKTsKCgkJcmV0Ll91c2VyX3NldCA9IHRoaXMuX3VzZXJfc2V0OwoJCXJldC5fdXNlcl9jb29wID0gdGhpcy5fdXNlcl9jb29wOwoJCXJldC51c2VyID0gdGhpcy51c2VyKCkgPyB0aGlzLnVzZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy51c2VyKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkidXNlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLmdyb3VwX0dyb3VwX01lbWJlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJ1c2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciB1c2VyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkudXNlcl9Hcm91cF9NZW1iZXJzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvR3JvdXBfTWVtYmVyLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiR3JvdXAgTWVtYmVyIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuZ3JvdXAoKSkgdGhpcy5ncm91cCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl91c2VyX3NldCAmJiB0aGlzLnVzZXIoKSkgdGhpcy51c2VyKCkuX19zeW5jX29uKGQpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIodGhpcy5JZCkKCgkJCS5ncm91cCh0aGlzLmdyb3VwKCksIHRoaXMuX2dyb3VwX2Nvb3ApCgoJCQkudXNlcih0aGlzLnVzZXIoKSwgdGhpcy5fdXNlcl9jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0dyb3VwX01lbWJlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKbmNtOTFjQ0k2SWtkeWIzVndJaXdpZFhObGNpSTZJbFZ6WlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiR3JvdXBfTWVtYmVyIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdHcm91cF9NZW1iZXInCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkdyb3VwX01lbWJlciovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkidXNlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypHcm91cF9NZW1iZXIqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmdyb3VwKHRhYmxlWyJncm91cCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ1c2VyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy51c2VyKHRhYmxlWyJ1c2VyIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdHcm91cCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiOTAzMjlkNjItNmQ2YS00YjE1LWJhNjEtZmQ1Yjc2Yjc2NzE5IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmdyb3VwKCkgfHwgKHRoaXMuZ3JvdXAoKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImdyb3VwIiwgb2JqLCB0aGlzLmdyb3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnVzZXIoKSB8fCAodGhpcy51c2VyKCkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLmNhbGxlcl9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLmNvbnRhY3RfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInVzZXIiLCBvYmosIHRoaXMudXNlcigpKTsKCQl9CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2dyb3VwJywgJ3VzZXInXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI5MDMyOWQ2Mi02ZDZhLTRiMTUtYmE2MS1mZDViNzZiNzY3MTkiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VyIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAndXNlciddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2dyb3VwX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5ncm91cCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdXNlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudXNlcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkgKyAiLmlkIl07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJZ3JvdXA6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmdyb3VwKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy51c2VyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXApIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy51c2VyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy51c2VyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdXNlcl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3VzZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5ncm91cH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy51c2VyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXJ9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cCA9IHYuX3RvUGF0aHMoKSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gb2JqLnVzZXIgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXBfTWVtYmVyKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwX01lbWJlciA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkKCgkJCQkJLmdyb3VwKG5ldyBzYWxlc25vdy5Hcm91cCgpKQoKCQkJCQkudXNlcihuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkdyb3VwIE1lbWJlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudXNlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudXNlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl91c2VyX3NldCAmJiAhcXVlcnkuX3VzZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdXNlcl9zZXQgJiYgcXVlcnkuX3VzZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMudXNlcigpICYmICF0aGlzLnVzZXIoKS5fbWF0Y2hlcyhxdWVyeS51c2VyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VyID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBncm91cCIpOwoJCQkJCW9iai5ncm91cCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXVzZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB1c2VyIik7CgkJCQkJb2JqLnVzZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9ncm91cF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl91c2VyX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmdyb3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudXNlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9ncm91cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ncm91cCgpIHx8IG5ldyBzYWxlc25vdy5Hcm91cCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZ3JvdXAob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBncm91cCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpIDogInVzZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdXNlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy51c2VyKCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnVzZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB1c2VyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2dyb3VwX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInVzZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkgOiAidXNlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3VzZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5R3JvdXAoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2dyb3VwIl0gJiYgKGFbIl9ncm91cCJdLkVxdWFscyA/IGFbIl9ncm91cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZ3JvdXAiXSwgcikpKSB7CgkJCQkJci5fZ3JvdXBfR3JvdXBfTWVtYmVycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5VXNlcihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdXNlciJdICYmIChhWyJfdXNlciJdLkVxdWFscyA/IGFbIl91c2VyIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl91c2VyIl0sIHIpKSkgewoJCQkJCXIuX3VzZXJfR3JvdXBfTWVtYmVycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5JZDsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5ncm91cCh0aGlzLmdyb3VwKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMudXNlcih0aGlzLnVzZXIoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpICYmICEoYXdhaXQgdGhpcy5ncm91cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCQkJCWlmICh0aGlzLl91c2VyX3NldCAmJiB0aGlzLnVzZXIoKSAmJiAhKGF3YWl0IHRoaXMudXNlcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3VzZXIoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9ncm91cF9zZXQpIHsKCgkJCQkJb2JqLmdyb3VwID0gdGhpcy5fZ3JvdXAuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl91c2VyX3NldCkgewoKCQkJCQlvYmoudXNlciA9IHRoaXMuX3VzZXIuSWQ7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJHcm91cF9NZW1iZXIiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Mb2NhdGlvbiA9IGNsYXNzIExvY2F0aW9uIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbG9jYXRpb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTG9jYXRpb24iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbl9JbmNpZGVudHMgKiovCglsb2NhdGlvbl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODkyYjdmMTUtMTJmZi00MDlhLTlkOWItNTg0MzIzN2FiM2E1JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbG9jYXRpb25fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJsb2NhdGlvbiBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImxvY2F0aW9uIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YubG9jYXRpb24odGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2xvY2F0aW9uX0luY2lkZW50cygpIHsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbl9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQubG9jYXRpb25fSW5jaWRlbnRzID0gdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Mb2NhdGlvbi8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYExvY2F0aW9uLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTG9jYXRpb24uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkxvY2F0aW9uIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLmxvY2F0aW9uX0xvY2F0aW9ucygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkxvY2F0aW9uKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmxvY2F0aW9uX0luY2lkZW50cyh0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpLCB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdMb2NhdGlvbic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJMb2NhdGlvbiI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnTG9jYXRpb24nCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qTG9jYXRpb24qLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qTG9jYXRpb24qLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiNmRjZmMxMi0zYzc5LTRkYmQtOWNiZS1kYTJkNGY3YTI5ZmQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImxvY2F0aW9uX0luY2lkZW50cyIsIG9iaiwgdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydsb2NhdGlvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiNmRjZmMxMi0zYzc5LTRkYmQtOWNiZS1kYTJkNGY3YTI5ZmQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygibG9jYXRpb25fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2xvY2F0aW9uX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImxvY2F0aW9uLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmxvY2F0aW9uX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSkgPT4gb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkxvY2F0aW9uKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkxvY2F0aW9uID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpCgoJCQkJCS5sb2NhdGlvbl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTG9jYXRpb24iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5sb2NhdGlvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5sb2NhdGlvbl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5sb2NhdGlvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSA6ICJsb2NhdGlvbl9JbmNpZGVudHMiKSkgPT4gdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSA6ICJsb2NhdGlvbl9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJMb2NhdGlvbiIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24udXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCgppZih0eXBlb2YobW9kdWxlKSE9PSJ1bmRlZmluZWQiKSBtb2R1bGUuZXhwb3J0cy5zYWxlc25vdyA9IHNhbGVzbm93OwoKKGFzeW5jICgpID0+IGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NlcnZlcih7aW5pdE5vZGU6IHRydWUsIGluaXRTZWxmOiB0cnVlLCBsb2FkVG9vbHM6IHRydWV9KSkoKTs=",
	"active": true,
	"enabled": true,
	"code": "apiserver",
	"date": "2023-08-15T13:28:05.375Z",
	"name": "API Server"
}
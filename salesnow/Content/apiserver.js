{
	"__id": "ee278291d22a88cd0017bc39d12edb5a84ee0fa3",
	"content": "aWYodHlwZW9mKGdsb2JhbCkhPT0idW5kZWZpbmVkIikgZ2xvYmFsLkZsYXR0ZWQgPSByZXF1aXJlKCdmbGF0dGVkJyk7CgpsZXQgX19nID0gdHlwZW9mKGdsb2JhbCk9PT0idW5kZWZpbmVkIj93aW5kb3c6Z2xvYmFsOwoKbGV0IHNhbGVzbm93ID0gewogICAgX19zY3JpcHQ6IHsKICAgICAgICBEYXRlOiBuZXcgRGF0ZSgnMjAyMy0wOC0xNlQwNDo1OTozMi4wMDBaJyksCiAgICB9LAogICAgX19zZWNyZXQ6IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBJbU5oWm1SbFlqaGhMVEJqT1RNdE5EUTNaaTA1WmpsaUxUSXhPREpsT1dGbU56TmtOeUk9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBfX21haW5DbGFzczogJ1VzZXInLAoKICAgIGhyZWZzOiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgVzNzaWJHbGlJam9pVEc5blNGUk5UQ0lzSW5OeVl5STZJbWgwZEhCek9pOHZZMlJ1TG1welpHVnNhWFp5TG01bGRDOXVjRzB2WTI5dWMyOXNaUzFzYjJjdGFIUnRiRUF5TGpBdU1pOWpiMjV6YjJ4bExXeHZaeTFvZEcxc0xtMXBiaTVxY3lJc0ltTmhZMmhsSWpwMGNuVmxMQ0owYjI5c2N5STZXMTBzSW14dllXUWlPaUp0YjJSMWJHVnpJRDArSUdSdlkzVnRaVzUwTG1kbGRFVnNaVzFsYm5SQ2VVbGtLRndpVEc5blNGUk5URndpS1NBL0lFTnZibk52YkdWTWIyZElWRTFNTG1OdmJtNWxZM1FvWkc5amRXMWxiblF1WjJWMFJXeGxiV1Z1ZEVKNVNXUW9YQ0pNYjJkSVZFMU1YQ0lwS1NBNklDY25JaXdpY21WeGRXbHlaWE1pT2x0ZGZTeDdJbXhwWWlJNklsTlJURXBUSWl3aWMzSmpJanBiSW1oMGRIQnpPaTh2WTJSdWFuTXVZMnh2ZFdSbWJHRnlaUzVqYjIwdllXcGhlQzlzYVdKekwzTnhiQzVxY3k4eExqZ3VNQzl6Y1d3dGQyRnpiUzV0YVc0dWFuTWlYU3dpWTJGamFHVWlPblJ5ZFdVc0lteHZZV1FpT2lKaGMzbHVZeUJ0YjJSMWJHVnpJRDArSUh0Y2NseHVYSFJjZEhkcGJtUnZkeTVUVVV3Z1BTQmhkMkZwZENCcGJtbDBVM0ZzU25Nb2UxeHlYRzVjZEZ4MFhIUnNiMk5oZEdWR2FXeGxPaUJtYVd4bElEMCtJR0JvZEhSd2N6b3ZMMk5rYm1wekxtTnNiM1ZrWm14aGNtVXVZMjl0TDJGcVlYZ3ZiR2xpY3k5emNXd3Vhbk12TVM0NExqQXZKSHRtYVd4bGZXQmNjbHh1WEhSY2RIMHBPMXh5WEc1Y2RIMGlMQ0owYjI5c2N5STZXeUpUY1d4RVFpSmRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVpHOTBMVzlpYW1WamRDSXNJbk55WXlJNkltaDBkSEJ6T2k4dlkyUnVMbXB6WkdWc2FYWnlMbTVsZEM5dWNHMHZaRzkwTFc5aWFtVmpkRUF5TGpFdU5DOXBibVJsZUM1dGFXNHVhbk1pTENKallXTm9aU0k2ZEhKMVpTd2lkRzl2YkhNaU9sdGRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVFYaHBiM01pTENKemNtTWlPaUpvZEhSd2N6b3ZMM1Z1Y0d0bkxtTnZiUzloZUdsdmN5OWthWE4wTDJGNGFXOXpMbTFwYmk1cWN5SXNJbU5oWTJobElqcDBjblZsTENKMGIyOXNjeUk2VzEwc0luSmxjWFZwY21WeklqcGJYWDFkYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCgoKICAgIF9fVG9vbHM6IFsKICAgIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBleUowZVhCbElqcDdJbTVoYldVaU9pSlRjV3hFUWlJc0luUjVjR1ZmVFdGd2NHbHVaM01pT2x0N0ltRmpkR2wyWlNJNlptRnNjMlVzSW1OdmJuUmxlSFFpT2lJb1hGeGlYRngzS3lraUxDSmpiR0Z6YzA1aGJXVWlPaUlvWEZ4aVhGeDNLeWtpTENKemIzVnlZMlVpT2lJb1hGeGlYRngzS3lraUxDSjBZWEpuWlhRaU9pSW9iWFFzSUhNcElEMCtJSE11ZEc5TWIzZGxja05oYzJVb0tTSXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxOeGJFUkNJbjE5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBlWEJsWDBOdmJtWnBaM01pT2x0ZGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaVpHRjBZV0poYzJVaUxDSjJZV3gxWlNJNklsd2lPbTFsYlc5eWVUcGNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWMyVnlkbVZ5SWl3aWRtRnNkV1VpT2lKY0lteHZZMkZzYUc5emRGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMWMyVnlibUZ0WlNJc0luWmhiSFZsSWpvaVhDSnliMjkwWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSW5KdmIzUmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVkzSmxZWFJsSWl3aWRtRnNkV1VpT2lJeUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alJXNTBhWFI1UVhSMGNtbGlkWFJsY3lJc0luWmhiSFZsSWpvaWRISjFaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMVI1Y0dWa1FYUjBjbWxpZFhSbGN5SXNJblpoYkhWbElqb2lkSEoxWlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkSGx3WlNJc0luWmhiSFZsSWpvaVhDSnpjV3hwZEdWY0lpSXNJbTV2WkdVaU9uc2lZMjlrWlNJNklqSmxaVGhqT0RnNE0yRmxOQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZabUZzYzJVc0luUjVjR1VpT25zaWJtRnRaU0k2SWs1dlpHVktVeUo5Zlgwc2V5SnVZVzFsSWpvaWRIbHdaU0lzSW5aaGJIVmxJam9pWENKemNXeHBkR1ZjSWlJc0ltNXZaR1VpT25zaVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcG1ZV3h6WlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVG05a1pVcFRJbjE5ZlN4N0ltNWhiV1VpT2lKMGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW5OeGJHbDBaVndpSW4xZExDSnVZVzFsSWpvaVUzRnNSRUlpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpUWVd4bGMwWnZjbU5sSWl3aWRIbHdaVjlEYjI1bWFXZHpJanBiZXlKdVlXMWxJam9pY21WemRDNTFjbXd1WjNGc0lpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3RwYm5OMFlXNWpaWDE5TG0xNUxuTmhiR1Z6Wm05eVkyVXVZMjl0TDNObGNuWnBZMlZ6TDJSaGRHRXZkbnQ3ZG1WeWMybHZibjE5TDJkeVlYQm9jV3hjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2ljbVZ6ZEM1MWNtd2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTJsdWMzUmhibU5sZlgwdWJYa3VjMkZzWlhObWIzSmpaUzVqYjIwdmMyVnlkbWxqWlhNdlpHRjBZUzkyZTN0MlpYSnphVzl1ZlgwdmMyOWlhbVZqZEhNdmUzdDBUbUZ0WlgxOUwzdDdTV1I5ZlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmVjBzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRIbHdaVjlOWVhCd2FXNW5jeUk2VzExOUxDSjBiMjlzWDBOdmJtWnBaM01pT2x0N0ltNWhiV1VpT2lKcGJuTjBZVzVqWlNJc0luWmhiSFZsSWpvaVhDSmtNM1l3TURBd01EQTRZMlkzZFdGaExXUmxkaTFsWkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUoyWlhKemFXOXVJaXdpYzJOeWFYQjBJam9pSnpVNExqQW5JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMFlXSnNaU0lzSW5OamNtbHdkQ0k2SW5ST1lXMWxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKSlpDSXNJbk5qY21sd2RDSTZJbDkwYUdsekxsOWZhV1FpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNklsTjVibU5GYm5ScGRIbEJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUowY25WbElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alZIbHdaV1JCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKbVlXeHpaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pWm1Gc2MyVWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbU5zYVdWdWRGOXBaQ0lzSW5aaGJIVmxJam9pWENJelRWWkhPV0pvYTNKT0xuUnpiVmRmY3k0MVZYRkhkM05yV1VjNE1HVm1abEUxWjFkRFpGZHhVRXg0WmtONGMySnViSGhmTUM0dVQzaFRRVVV1WkRGeldUTlJXSE5aZFVKaWVXWjNNekp0TW10MlNqVk1YQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG1Oc2FXVnVkRjl6WldOeVpYUWlMQ0oyWVd4MVpTSTZJbHdpUlVKRk9FTkVRVGRCTVRCQ05UUXlOME5HTmpRMk1FTXhRME14TmpVMk5VUkdNalV4TWtJM01VRXlOelV6UTBZNU4wWXhPVGN5UlVVek56ZzJSVFpEUlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNXNiMmRwYmlJc0luWmhiSFZsSWpvaVhDSm1ZV1JwUUc1aGJXMXZkWEl1WTI5dFhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSWl4WE1pNVRRMFkxUG5sS1V6aytJVGhjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liRzluYVc0dWNHRnpjM2R2Y21RaUxDSjJZV3gxWlNJNklsd2lQMFFuYUcxTlptRktORVJHZERVN2Exd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVvYjNOMElpd2lkbUZzZFdVaU9pSmNJbnQ3YVc1emRHRnVZMlY5ZlM1dGVTNXpZV3hsYzJadmNtTmxMbU52YlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNXpZMjl3WlNJc0luWmhiSFZsSWpvaVhDSm1kV3hzWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNWpiMjUwWlc1MFgzUjVjR1VpTENKMllXeDFaU0k2SWx3aVlYQndiR2xqWVhScGIyNHZlQzEzZDNjdFptOXliUzExY214bGJtTnZaR1ZrWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNW9aV0ZrWlhKeklpd2lkbUZzZFdVaU9pSmNJbnRjWEZ3aVFYVjBhQzFTWlhGMVpYTjBMVlI1Y0dWY1hGd2lPaUJjWEZ3aVRtRnRaV1F0VlhObGNseGNYQ0o5WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xtRjFkR2h2Y21sNlpTNWliMlI1SWl3aWRtRnNkV1VpT2lKY0luSmxjM0J2Ym5ObFgzUjVjR1U5WTI5a1pWOWpjbVZrWlc1MGFXRnNjeVpqYkdsbGJuUmZhV1E5ZTN0dllYVjBhQzVqYkdsbGJuUmZhV1I5ZlNaeVpXUnBjbVZqZEY5MWNtazllM3R2WVhWMGFDNXlaV1JwY21WamRDNTFjbWw5ZlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNWhkWFJvYjNKcGVtVXViV1YwYUc5a0lpd2lkbUZzZFdVaU9pSmNJbkJ2YzNSY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VZWFYwYUc5eWFYcGxMblZ5YVNJc0luWmhiSFZsSWpvaVhDSm9kSFJ3Y3pvdkwzdDdiMkYxZEdndWFHOXpkSDE5TDNObGNuWnBZMlZ6TDI5aGRYUm9NaTloZFhSb2IzSnBlbVUvY21WemNHOXVjMlZmZEhsd1pUMWpiMlJsSm1Oc2FXVnVkRjlwWkQxN2UyOWhkWFJvTG1Oc2FXVnVkRjlwWkgxOUpuTmpiM0JsUFh0N2IyRjFkR2d1YzJOdmNHVjlmU1p6ZEdGMFpUMTdlMjloZFhSb0xtRjFkR2h2Y21sNlpTNXpkR0YwWlgxOUpuSmxaR2x5WldOMFgzVnlhVDE3ZTI5aGRYUm9MbkpsWkdseVpXTjBMblZ5YVgxOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbkJ2YzNRdWRYSnBJaXdpZG1Gc2RXVWlPaUpjSW1oMGRIQnpPaTh2ZTN0dllYVjBhQzVvYjNOMGZYMHZjMlZ5ZG1salpYTXZiMkYxZEdneUwyRjFkR2h2Y21sNlpWd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzV5WldScGNtVmpkQzUxY21raUxDSjJZV3gxWlNJNklsd2lhSFIwY0hNNkx5OWhjbnBvYjNOd2FYUmhiQzVuYVhSb2RXSXVhVzh2YzJGc1pYTnViM2N2WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuSmxaR2x5WldOMExtTnZaR1VpTENKMllXeDFaU0k2SWx3aVkyOWtaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1eVpXUnBjbVZqZEM1emRHRjBaU0lzSW5aaGJIVmxJam9pWENKemRHRjBaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1MWMyVnlhVzVtYnk1MWNta2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTI5aGRYUm9MbWh2YzNSOWZTOTFjMlZ5YVc1bWIxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzUwYjJ0bGJpNTFjbWtpTENKMllXeDFaU0k2SWx3aWFIUjBjSE02THk5N2UyOWhkWFJvTG1odmMzUjlmUzl6WlhKMmFXTmxjeTl2WVhWMGFESXZkRzlyWlc1Y0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dVltOWtlU0lzSW5aaGJIVmxJam9pWENKbmNtRnVkRjkwZVhCbFBYdDdiMkYxZEdndWRHOXJaVzR1WjNKaGJuUmZkSGx3WlgxOUptTnZaR1U5ZTN0dllYVjBhQzVoZFhSb2IzSnBlbVV1WTI5a1pYMTlKbU5zYVdWdWRGOXBaRDE3ZTI5aGRYUm9MbU5zYVdWdWRGOXBaSDE5Sm1Oc2FXVnVkRjl6WldOeVpYUTllM3R2WVhWMGFDNWpiR2xsYm5SZmMyVmpjbVYwZlgwbWNtVmthWEpsWTNSZmRYSnBQWHQ3YjJGMWRHZ3VjbVZrYVhKbFkzUXVkWEpwZlgxY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dWJXVjBhRzlrSWl3aWRtRnNkV1VpT2lKY0lsQlBVMVJjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1WTI5dWRHVnVkRjkwZVhCbElpd2lkbUZzZFdVaU9pSmNJbUZ3Y0d4cFkyRjBhVzl1TDNndGQzZDNMV1p2Y20wdGRYSnNaVzVqYjJSbFpGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzUwYjJ0bGJpNW5jbUZ1ZEY5MGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW1GMWRHaHZjbWw2WVhScGIyNWZZMjlrWlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNTBiMnRsYmk1eVpYTndiMjV6WlM1MGIydGxibDkwZVhCbElpd2lkbUZzZFdVaU9pSmNJblJ2YTJWdVgzUjVjR1ZjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1Y21WemNHOXVjMlV1Wlhod2FYSmxjMTlwYmlJc0luWmhiSFZsSWpvaVhDSmxlSEJwY21WelgybHVYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG5SdmEyVnVMbkpsYzNCdmJuTmxMbUZqWTJWemMxOTBiMnRsYmlJc0luWmhiSFZsSWpvaVhDSmhZMk5sYzNOZmRHOXJaVzVjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRHOXJaVzR1Y21WemNHOXVjMlV1Y21WbWNtVnphRjkwYjJ0bGJpSXNJblpoYkhWbElqb2lYQ0p5WldaeVpYTm9YM1J2YTJWdVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5WFN3aWJtRnRaU0k2SWxOaGJHVnpSbTl5WTJVaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ4ZlRXRndjR2x1WjNNaU9sdGRmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SjBlWEJsSWpwN0ltNWhiV1VpT2lKR2FXeGxVM2x6ZEdWdElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owZVhCbFgwTnZibVpwWjNNaU9sdGRMQ0owZVhCbFgwMWhjSEJwYm1keklqcGJYWDBzSW5SdmIyeGZRMjl1Wm1sbmN5STZXM3NpYm1GdFpTSTZJbkJoZEdndWNtVmhaQ0lzSW5aaGJIVmxJam9pWENKb2RIUndjem92TDJGeWVtaHZjM0JwZEdGc0xtZHBkR2gxWWk1cGJ5OWNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pZEhKMVpTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDFkTENKdVlXMWxJam9pUm1sc1pWTjVjM1JsYlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkRzl2YkY5TllYQndhVzVuY3lJNlcxMTlgKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpIYVhSSWRXSWlMQ0owZVhCbFgwTnZibVpwWjNNaU9sdDdJbTVoYldVaU9pSjFjbXdpTENKMllXeDFaU0k2SWx3aWFIUjBjSE02THk5aGNHa3VaMmwwYUhWaUxtTnZiUzl5WlhCdmN5OTdlMjkzYm1WeWZYMHZlM3R5WlhCdmMybDBiM0o1ZlgwdlkyOXVkR1Z1ZEhNdlhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBlWEJsWDAxaGNIQnBibWR6SWpwYlhYMHNJblJ2YjJ4ZlEyOXVabWxuY3lJNlczc2libUZ0WlNJNkluSmxjRzl6YVhSdmNua2lMQ0oyWVd4MVpTSTZJbHdpWVhKNmFHOXpjR2wwWVd3dVoybDBhSFZpTG1sdlhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05M2JtVnlJaXdpZG1Gc2RXVWlPaUpjSW1GeWVtaHZjM0JwZEdGc1hDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbUZqWTJWemMxOTBiMnRsYmlJc0lsOXViMlJsSWpwN0ltTnZiblJsZUhRaU9uc2lZMjlrWlNJNkltUmxkaUo5ZlN3aWRtRnNkV1VpT2lKY0ltZHBkR2gxWWw5d1lYUmZNVEZCVEVSVFZWcFJNRVpQVnpWVFRsUllNMjlxYjE5dlFsbHFSamt5UVdadVQycHJUWEpKVlc5SWVtMDVTWGhoVTBKVVRqWjJNbkZ0V0ZZNWMwSk5hMEpZTTFSSk5GSk5URFpHU1VGRk0yTktORndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSmpjbVZoZEdVaUxDSjJZV3gxWlNJNklqSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SWxONWJtTkZiblJwZEhsQmRIUnlhV0oxZEdWeklpd2lkbUZzZFdVaU9pSjBjblZsSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSlRlVzVqVkhsd1pXUkJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUptWVd4elpTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDFkTENKdVlXMWxJam9pUjJsMFNIVmlJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKMGIyOXNYMDFoY0hCcGJtZHpJanBiWFgwPWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pLEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lMQ0owZVhCbFgwTnZibVpwWjNNaU9sdDdJbTVoYldVaU9pSnRZWEF1VTNSaGRHVXVZMjlrWlNJc0luWmhiSFZsSWpvaVhDSjdYRnhjSWpGY1hGd2lPaUJjWEZ3aVFWeGNYQ0lzSUZ4Y1hDSXlYRnhjSWpvZ1hGeGNJa0pjWEZ3aUxDQmNYRndpTTF4Y1hDSTZJRnhjWENKRFhGeGNJbjFjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liV0Z3TGxCeWFXOXlhWFI1TG1OdlpHVWlMQ0oyWVd4MVpTSTZJbHdpZTF4Y1hDSXhYRnhjSWpvZ1hGeGNJa055YVhScFkyRnNYRnhjSWl3Z1hGeGNJakpjWEZ3aU9pQmNYRndpU0dsbmFGeGNYQ0lzSUZ4Y1hDSXpYRnhjSWpvZ1hGeGNJazFsWkdsMWJWeGNYQ0lzSUZ4Y1hDSTBYRnhjSWpvZ1hGeGNJa3h2ZDF4Y1hDSjlYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkluSmxjM1JoY0drdWRYSnNJaXdpZG1Gc2RXVWlPaUpjSW1oMGRIQnpPaTh2ZTN0cGJuTjBZVzVqWlgxOUxuTmxjblpwWTJVdGJtOTNMbU52YlM5aGNHa3ZibTkzTDNSaFlteGxMMXdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZWMHNJblI1Y0dWZlRXRndjR2x1WjNNaU9sdDdJbU52Ym5SbGVIUWlPaUlvWEZ4aVhGeDNLeWtpTENKamJHRnpjMDVoYldVaU9pSW9YRnhpWEZ4M0t5a2lMQ0p6YjNWeVkyVWlPaUlvWEZ4aVhGeDNLeWtpTENKMFlYSm5aWFFpT2lJb2JYUXNJSE1wSUQwK0lITXVkRzlNYjNkbGNrTmhjMlVvS1NJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkSGx3WlNJNmV5SnVZVzFsSWpvaVUyVnlkbWxqWlU1dmR5SjlmU3g3SW1OdmJuUmxlSFFpT2lKRmJuUnBkSGxCZEhSeWFXSjFkR1VpTENKamJHRnpjMDVoYldVaU9pSmVLRWx1WTJsa1pXNTBmRkJ5YjJKc1pXMHBKQ0lzSW5OdmRYSmpaU0k2SW1OdlpHVWlMQ0owWVhKblpYUWlPaUp1ZFcxaVpYSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc2V5SmpiMjUwWlhoMElqb2lSVzUwYVhSNVFYUjBjbWxpZFhSbElpd2lZMnhoYzNOT1lXMWxJam9pWGloSmJtTnBaR1Z1ZEh4UWNtOWliR1Z0S1NRaUxDSnpiM1Z5WTJVaU9pSnVZVzFsSWl3aWRHRnlaMlYwSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzZXlKamIyNTBaWGgwSWpvaVJXNTBhWFI1UVhSMGNtbGlkWFJsSWl3aVkyeGhjM05PWVcxbElqb2lYaWhKYm1OcFpHVnVkSHhRY205aWJHVnRLU1FpTENKemIzVnlZMlVpT2lKeVpXMWhjbXNpTENKMFlYSm5aWFFpT2lKa1pYTmpjbWx3ZEdsdmJpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpZEhsd1pTSTZleUp1WVcxbElqb2lVMlZ5ZG1salpVNXZkeUo5ZlN4N0ltTnZiblJsZUhRaU9pSkZiblJwZEhsQmRIUnlhV0oxZEdVaUxDSmpiR0Z6YzA1aGJXVWlPaUpKYm1OcFpHVnVkQ0lzSW5OdmRYSmpaU0k2SW1OdlpHVWlMQ0owWVhKblpYUWlPaUp1ZFcxaVpYSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc2V5SmpiMjUwWlhoMElqb2lYaWhmWm5KdmJVUnZZM1Z0Wlc1MGZGOTBiMFJ2WTNWdFpXNTBLU1FpTENKamJHRnpjMDVoYldVaU9pSmVLRWx1WTJsa1pXNTBmRkJ5YjJKc1pXMHBKQ0lzSW5OdmRYSmpaU0k2SWw0b2MzUmhkR1Y4Y0hKcGIzSnBkSGtwSkNJc0ltOTFkRU52Ym1ScGRHbHZiaUk2SW5SNWNHVnZaaWh2WW1wR2NtOXRLVDA5UFNkdlltcGxZM1FuSWl3aWFXNURiMjVrYVhScGIyNGlPaUowZVhCbGIyWW9iMkpxUm5KdmJWdGpiMlJsWFNrOVBUMG5jM1J5YVc1bkp5SXNJbTkxZEZOamNtbHdkQ0k2SW05aWFsUnZXMk52WkdWZElEMGdYM1JvYVhNdVgyWnNhWEFvWDNSb2FYTXVYMTlqYjI1bWFXY29KMjFoY0M0bksyTnZaR1ZVZVhCbEt5Y3VZMjlrWlNjc0lHNTFiR3dzSUh0MGIyOXNPaUIwYjI5c2ZTa3BXMjlpYWtaeWIyMHVZMjlrWlNncFhTSXNJbWx1VTJOeWFYQjBJam9pYjJKcVZHOWJZMjlrWlYwZ1BTQjdZMjlrWlRvZ1gzUm9hWE11WDE5amIyNW1hV2NvSjIxaGNDNG5LMk52WkdWVWVYQmxLeWN1WTI5a1pTY3NJRzUxYkd3c0lIdDBiMjlzT2lCMGIyOXNmU2xiYjJKcVJuSnZiVnRqYjJSbFhWMTlJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKMGVYQmxJanA3SW01aGJXVWlPaUpUWlhKMmFXTmxUbTkzSW4xOVhTd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3dpZEc5dmJGOU5ZWEJ3YVc1bmN5STZXM3NpWTJ4aGMzTk9ZVzFsSWpvaVZYTmxjaUlzSW5SaGNtZGxkQ0k2SW5WelpYSmZibUZ0WlNJc0luTnZkWEpqWlNJNklrbGtJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKMGIyOXNJanA3SW01aGJXVWlPaUpUVGs5WFQwOUNJbjE5TEhzaVkyeGhjM05PWVcxbElqb2lUVzlrWld4ZlEyRjBaV2R2Y25raUxDSnpiM1Z5WTJVaU9pSk5iMlJsYkY5RFlYUmxaMjl5ZVNJc0luUmhjbWRsZENJNkltTnRaR0pmYlc5a1pXeGZZMkYwWldkdmNua2lMQ0pqYjI1MFpYaDBJam9pUlc1MGFYUjVRMnhoYzNNaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ3aU9uc2libUZ0WlNJNklsTk9UMWRQVDBJaWZYMHNleUpqYkdGemMwNWhiV1VpT2lKQmMzTmxkQ0lzSW5OdmRYSmpaU0k2SWtGemMyVjBJaXdpZEdGeVoyVjBJam9pWVd4dFgyRnpjMlYwSWl3aVkyOXVkR1Y0ZENJNklrVnVkR2wwZVVOc1lYTnpJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKMGIyOXNJanA3SW01aGJXVWlPaUpUVGs5WFQwOUNJbjE5TEhzaVkyeGhjM05PWVcxbElqb2lUVzlrWld4ZlEyRjBaV2R2Y25raUxDSjBZWEpuWlhRaU9pSmhjM05sZEY5amJHRnpjeUlzSW5OdmRYSmpaU0k2SW1Oc1lYTnpXeTUzWFNvaUxDSnZkWFJUWTNKcGNIUWlPaUp2WW1wVWJ5NWhjM05sZEY5amJHRnpjeUE5SUc5aWFrWnliMjFiWTI5a1pWMDdJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKMGIyOXNJanA3SW01aGJXVWlPaUpUVGs5WFQwOUNJbjE5TEhzaVkyeGhjM05PWVcxbElqb2lRWE56WlhRaUxDSjBZWEpuWlhRaU9pSnBibk4wWVd4c1gzTjBZWFIxY3lJc0luTnZkWEpqWlNJNkluTjBZWFIxYzFzdWQxMHFJaXdpYjNWMFUyTnlhWEIwSWpvaWIySnFWRzh1YVc1emRHRnNiRjl6ZEdGMGRYTWdQU0J2WW1wR2NtOXRXMk52WkdWZE95SXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpZEc5dmJDSTZleUp1WVcxbElqb2lVMDVQVjA5UFFpSjlmU3g3SW1Oc1lYTnpUbUZ0WlNJNklrMXZaR1ZzWDBOaGRHVm5iM0o1SWl3aWRHRnlaMlYwSWpvaWJtRnRaU0lzSW5OdmRYSmpaU0k2SW01aGJXVWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SdmIyd2lPbnNpYm1GdFpTSTZJbE5PVDFkUFQwSWlmWDBzZXlKamJHRnpjMDVoYldVaU9pSk5iMlJsYkY5RFlYUmxaMjl5ZVNJc0luUmhjbWRsZENJNkluQmhjbVZ1ZEY5allYUmxiMmR5ZVNJc0luTnZkWEpqWlNJNkluQmhjbVZ1ZENJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkRzl2YkNJNmV5SnVZVzFsSWpvaVUwNVBWMDlQUWlKOWZTeDdJbU5zWVhOelRtRnRaU0k2SWtWMlpXNTBJaXdpYzI5MWNtTmxJam9pY21WamFYQnBaVzUwSWl3aWRHRnlaMlYwSWpvaWJtOWtaU0lzSW05MWRGTmpjbWx3ZENJNklpZEJVRWxUUlZKV1JWSTZKeUFySUY5MGFHbHpMbE5qYjNCbElDc2dKem9uSUNzZ0tGOTBhR2x6TG5KbFkybHdhV1Z1ZENncElIeDhJSHQ5S1M1amIyUmxLQ2tpTENKcGJsTmpjbWx3ZENJNkltOWlhaTV1YjJSbExuTndiR2wwS0NjNkp5a3ViR1Z1WjNSb1BUMHhQMjUxYkd3NmJtVjNJRzlUWTI5d1pTNU9iMlJsS0NrdVkyOWtaU2h2WW1vdWJtOWtaUzV6Y0d4cGRDZ25PaWNwV3pKZEtTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpZEc5dmJDSTZleUp1WVcxbElqb2lVMDVQVjA5UFFpSjlmVjBzSW5SdmIyeGZRMjl1Wm1sbmN5STZXM3NpYm1GdFpTSTZJbWx1YzNSaGJtTmxJaXdpZG1Gc2RXVWlPaUpjSW1SbGRqRTNNRE13TkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUoxYzJWeWJtRnRaU0lzSW5aaGJIVmxJam9pWENKMGRWOXViMlJsYW5OY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYkdsMlpTSXNJblpoYkhWbElqb2lkSEoxWlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2ljR0Z6YzNkdmNtUWlMQ0oyWVd4MVpTSTZJbHdpS0RoNE0wZFRSV3B3UmswelRrMXlVRlJkY0hsYmExSThhelJRWkdwSk9WY3RNMGxvTWloNmZTazZOU2dvWFdJMkxrNVFTemgxUFRFL1FsODBOekV0WDFodFdTdDVVMjFCZTJNMGJpMHJMRjV3ZGxJeFZuTlVVSEVvSkZjdWNDUThUenRZUDF3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp6ZVhOZmNISnZjR1Z5ZEdsbGN5NW5iR2xrWlM1emVYTXVaR0YwWlY5bWIzSnRZWFFpTENKMllXeDFaU0k2SWx3aWVYbDVlUzFOVFMxa1pGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKemVYTmZjSEp2Y0dWeWRHbGxjeTVuYkdsa1pTNXplWE11ZEdsdFpWOW1iM0p0WVhRaUxDSjJZV3gxWlNJNklsd2lTRWc2YlcwNmMzTmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWMzbHpYM0J5YjNCbGNuUnBaWE11WjJ4cFpHVXVjM2x6TG1SbFptRjFiSFF1ZEhvaUxDSjJZV3gxWlNJNklsd2lSWFZ5YjNCbEwwSmxjbXhwYmx3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpqY21WaGRHVWlMQ0oyWVd4MVpTSTZJaklpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNklsTjVibU5GYm5ScGRIbEJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUowY25WbElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alZIbHdaV1JCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKbVlXeHpaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgxZExDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlgKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSwKICAgIF0sCgp9OwoKCgpkZWxldGUgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEk7CnNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJID0gY2xhc3MgR2VuZXJpY1NlcnZpY2VBUEkgewoJYXN5bmMgc2V0SW50ZXJ2YWwoZnVuLCBtaW51dGVzLCAuLi5hcmdzKSB7CgkJbGV0IGZOYW1lID0gZnVuLnRvU3RyaW5nKCkuc3BsaXQoJyknKVswXSArICcpJzsKCQl0cnkgewoJCQkvLyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApOwoKCQkJdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKTsKCQkJbGV0IHJldCA9IGF3YWl0IGZ1biguLi5hcmdzLmNvbmNhdChbbmV3IERhdGUoKV0pKTsKCgkJCXRoaXMubG9nKGB7Q2FsbDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCkgKyBgLCBMb29wOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKSArICd9JywgJ3NldEludGVydmFsJywgZk5hbWUpOwoJCQlpZiAoIXJldCkgewoJCQkJdGhpcy5sb2coYGRpZCBub3QgcmV0dXJuIHRydWUsIGV4aXRpbmcgbG9vcGVyICgke3RoaXMuX190aW1lKGZOYW1lKX0pYCwgJ3NldEludGVydmFsJywgZk5hbWUpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codGhpcy5fX3RpbWUoZk5hbWUpLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSwgMiwgZXgpOwoJCQljb25zb2xlLnRyYWNlKCk7CgkJfQoJCWlmICghTnVtYmVyKG1pbnV0ZXMpKSB7CgkJCXRoaXMubG9nKHRoaXMuX190aW1lKGZOYW1lKSwgJ3NldEludGVydmFsJywgZk5hbWUsIDAsICJOb3QgcmVwZWF0aW5nLiBNaW51dGVzIGlzICIgKyBtaW51dGVzKTsKCQkJcmV0dXJuOwoJCX0KCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgbWludXRlcyAqIDYwICogMTAwMCkpOwoJCWF3YWl0IHRoaXMuc2V0SW50ZXJ2YWwoZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsKCX0KCglhc3luYyBfZXhlY3V0ZShzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcyA9IHt9KSB7CgkJbGV0IF9fYmVmb3JlUnVsZXMgPSBvUGFyYW1zLl9fYmVmb3JlUnVsZXMgfHwgW107CgkJbGV0IF9fYWZ0ZXJSdWxlcyA9IG9QYXJhbXMuX19hZnRlclJ1bGVzIHx8IFtdOwoJCWRlbGV0ZSBvUGFyYW1zLl9fYmVmb3JlUnVsZXM7CgkJZGVsZXRlIG9QYXJhbXMuX19hZnRlclJ1bGVzOwoKCQlfX2JlZm9yZVJ1bGVzLmNvbmNhdChfX2FmdGVyUnVsZXMpLmZvckVhY2gociA9PiByLlNjcmlwdCA9IHRoaXMucnVuU2NyaXB0KGBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG5vZGUke09iamVjdC5rZXlzKG9QYXJhbXMpLmxlbmd0aD8nLCAnOicnfSR7T2JqZWN0LmtleXMob1BhcmFtcykuam9pbignLCcpfSkgPT4geyR7ci5TY3JpcHR9fWApKTsKCgkJbGV0IGxQYXJhbXMgPSBPYmplY3QuZW50cmllcyhvUGFyYW1zKS5tYXAoeCA9PiB4WzFdKTsKCQlsZXQgcmVzdWx0cyA9IFtdOwoKCQlpZiAodGhpcy5EU0Nvbm5lY3QpIGF3YWl0IHRoaXMuRFNDb25uZWN0KCk7CgoJCWxldCBub2RlcyA9IFtdOwoJCWlmICghc2NvcGUuX25vZGUgfHwgIWZSb3V0ZXIpIHsKCQkJbm9kZXMucHVzaChudWxsKTsKCQl9IGVsc2UgewoJCQlpZiAoc2NvcGUuX25vZGUpIHsKCQkJCWlmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1JvdXRlcicsIHNjb3BlLCBzY29wZS5fbm9kZSwgLi4ubFBhcmFtcykpIHsKCQkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlKTsKCQkJCX0KCgkJCQl0aGlzLl9maXhOb2RlKHNjb3BlKTsKCgkJCQlpZiAoc2NvcGUuX25vZGUuX3BhcmVudCAmJiAoYXdhaXQgdGhpcy5fU2NyaXB0KGZSb3V0ZXIsIG0sICdSb3V0ZXInLCBzY29wZSwgc2NvcGUuX25vZGUuX3BhcmVudCwgLi4ubFBhcmFtcykpKSB7CgkJCQkJLy8gdGhpcy5sb2coc2NvcGUuX25vZGUuX3BhcmVudCwgJ19leGVjdXRlJywgJ2FkZGluZyBwYXJlbnQnKTsKCQkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlLl9wYXJlbnQpOwoJCQkJfSBlbHNlIGlmIChzY29wZS5FdmVudCAmJiB0aGlzLkVudGl0eUNsYXNzLk5hbWUgIT09ICJFdmVudCIpIHsKCQkJCQkvLyBub2Rlcy5wdXNoKG5ldyBzY29wZS5Ob2RlKCkpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBjbiBvZiBzY29wZS5fbm9kZS5wYXJlbnRfTm9kZXMoKSkgewoJCQkJCWlmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1NjcmlwdCcsIHNjb3BlLCBjbiwgLi4ubFBhcmFtcykpIHsKCQkJCQkJLy8gdGhpcy5sb2coY24sICdfZXhlY3V0ZScsICdhZGRpbmcgY2hpbGQgbm9kZScpOwoJCQkJCQlub2Rlcy5wdXNoKGNuKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBhbnkgbnVsbHMKCQkJbm9kZXMgPSBub2Rlcy5mbGF0KCkuZmlsdGVyKG4gPT4gbik7CgoJCQlpZiAoIW5vZGVzLmxlbmd0aCkgewoJCQkJbm9kZXMucHVzaChzY29wZS5fbm9kZSk7CgkJCX0KCgkJCS8vIHRoaXMubG9nKG5vZGVzLmxlbmd0aCwgJ19leGVjdXRlJywgJ25vZGVzLmxlbmd0aCcpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIG5vZGVzKSB7CgkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoJCQlsZXQgblJldCA9IG51bGw7CgkJCXRoaXMubG9nKGAke219IEAgJHtuPy5jb2RlKCkgfHwgJ0xPQ0FMJ31gLCAnX2V4ZWN1dGUnLCBgJHt0aGlzLkVudGl0eUNsYXNzLk5hbWV9YCk7CgkJCWlmICghbiB8fCB0aGlzLl9zYW1lTm9kZShzY29wZS5fbm9kZSwgbikpIHsKCQkJCS8vIGxvY2FsIHNjcmlwdAoJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYmVmb3JlUnVsZXMpIHsKCQkJCQlhd2FpdCB0aGlzLl9TY3JpcHQoci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQmVmb3JlUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsKCQkJCX0KCgkJCQluUmV0ID0gYXdhaXQgdGhpcy5fU2NyaXB0KGZTY3JpcHQsIG0sICdTY3JpcHQnLCBzY29wZSwgLi4ubFBhcmFtcyk7CgoJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYWZ0ZXJSdWxlcykgewoJCQkJCWF3YWl0IHRoaXMuX1NjcmlwdChyLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdBZnRlclJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQluUmV0ID0gYXdhaXQgdGhpcy5faW52b2tlTm9kZShuLCBtLCBvUGFyYW1zKTsKCQkJfQoKCQkJcmVzdWx0cy5wdXNoKHsKCQkJCW5vZGU6IG4sCgkJCQlyZXQ6IG5SZXQKCQkJfSk7CgkJfQoJCS8vIHRoaXMubG9nKHJlc3VsdHMsICdfZXhlY3V0ZScsICdSZXN1bHRzJyk7CgoJCWxldCBlcnJvcnMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIucmV0ICYmIHIucmV0Ll9fZXhjZXB0aW9uKSAvKi5maWx0ZXIociA9PiAhdGhpcy5fc2FtZU5vZGUoc2NvcGUuX25vZGUsIHIubm9kZSkpKi8gLm1hcChyID0+ICh7CgkJCW5vZGU6IHIubm9kZSA/IHsKCQkJCWNvZGU6IHIubm9kZS5jb2RlKCksCgkJCQlhZGRyZXNzOiByLm5vZGUuYWRkcmVzcygpCgkJCX0gOiBudWxsLAoJCQlfX2V4Y2VwdGlvbjogci5yZXQuX19leGNlcHRpb24KCQl9KSk7CgkJaWYgKGVycm9ycy5sZW5ndGgpIHsKCQkJdGhpcy5sb2coIl9leGVjdXRlIiwgbSwgImVycm9ycyIsIDEsIGVycm9ycyk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0czsKCX0KCglfc2FtZU5vZGUobjEsIG4yKSB7CgkJaWYgKHR5cGVvZihuMikgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihuMSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW4yID0gbjE7CgkJCW4xID0gdGhpczsKCQl9CgoJCWlmICghbjEgfHwgIW4yKSByZXR1cm4gZmFsc2U7CgoJCWlmICh0eXBlb2YobjEuX2NvZGUpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YobjIuX2NvZGUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIGZhbHNlOwoKCQlpZiAobjEuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIgfHwgbjIuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKG4xLl9jb2RlX2Nvb3AgfHwgbjIuX2NvZGVfY29vcCkgcmV0dXJuIGZhbHNlOwoKCQlpZiAobjEuX2NvZGUgPT0gbjIuX2NvZGUpIHJldHVybiB0cnVlOwoKCQlyZXR1cm4gdGhpcy5FcXVhbHMobjEsIG4yKTsKCX0KCglfZml4Tm9kZShzY29wZSkgewoJCS8vIG9uIE5vZGVKUyBmb3Igc29tZSByZWFzb24sIF9ub2RlIGlzIHNvbWV0aW1lcyBhbiBhcnJheSEKCQl0cnkgewoJCQlzY29wZSA9IHNjb3BlIHx8IHRoaXMuX19zY29wZSgpOwoJCQlpZiAoQXJyYXkuaXNBcnJheShzY29wZS5fbm9kZSkpIHNjb3BlLl9ub2RlID0gc2NvcGUuX25vZGVbMF07CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2coJ19maXhOb2RlJywgdHlwZW9mKHRoaXMpLCAxLCBleCwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKTsKCQl9Cgl9CgoJbG9nKG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZykgewoJCXRyeSB7CgkJCWxldCBkZWJ1ZyA9IHRoaXMuRGVidWc7CgkJCWxldCBsZXZlbHMgPSBbImluZm8iLCAid2FybiIsICJlcnJvciIsICJjcml0aWNhbCJdOwoKCQkJZGVidWcgPSBkZWJ1ZyB8fCBPYmplY3QuZnJvbUVudHJpZXMobmV3IE1hcChsZXZlbHMubWFwKGwgPT4gW2wsICcqJ10pKSk7CgoJCQlsZXQgZnVuY3Rpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgLi4ubGV2ZWxzLm1hcChsID0+ICh7CgkJCQlbbF06IGRlYnVnW2xdID8gZGVidWdbbF0uc3BsaXQoJywnKSA6IFtdCgkJCX0pKSk7CgoJCQlsZXQgY3NzID0gJ2JhY2tncm91bmQ6ICMwMGZmMDA7IGNvbG9yOiAjMDA4MDAwJzsKCQkJbGV0IGZnID0gJ1x4MWJbMzJtJzsKCQkJc3dpdGNoIChOdW1iZXIobGV2ZWwpKSB7CgkJCQljYXNlIDE6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNmZmZmMDA7IGNvbG9yOiAjMDAwMDgwJzsKCQkJCQlmZyA9ICdceDFiWzMzbSc7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDI6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsKCQkJCQlmZyA9ICdceDFiWzMxbSc7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDM6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsKCQkJCQlmZyA9ICdceDFiWzMxbVtDUklUSUNBTF0nOwoJCQkJCWJyZWFrOwoJCQl9CgoJCQlpZiAoZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXS5ldmVyeShmID0+ICFbJyouKicsICcqLicgKyBtLCAnKicsIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuJyArIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuKiddLmluY2x1ZGVzKGYpKSkgewoJCQkJLy8gY29uc29sZS5sb2coJ25vIG1ldGhvZCcsIGZ1bmN0aW9ucywgZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXSwgbSwgWycqLionLCAnKi4nICsgbSwgJyonLCBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLicgKyBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLionXSk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWNvbnNvbGUubG9nKGZnICsgIiVzXHgxYlswbSIsIGAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7dGhpcy5FbnRpdHlDbGFzcy5OYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZyhgJWMgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke3RoaXMuRW50aXR5Q2xhc3MuTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCBjc3MsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJCS8vdGhpcy5sb2coZXgsIG0sIHR5cGUsIDMpOwoJCX0KCX0KCglhc3luYyBfU2NyaXB0KHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIC4uLnNmQXJncykgewoJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCgkJcmV0dXJuIGF3YWl0IChhc3luYyAodHlwZSwgLi4uc0FyZ3MpID0+IHsKCQkJbGV0IGxvZyA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAwLCAuLi5tc2cpOwoJCQlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAxLCAuLi5tc2cpOwoJCQlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKG9iaiwgbSwgdHlwZSwgMiwgLi4ubXNnKTsKCgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdzdHJpbmcnKSBzY3JpcHQgPSB0aGlzLnJ1blNjcmlwdChzY3JpcHQpOwoJCQkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gYXdhaXQgc2NyaXB0KGxvZywgd2FybiwgZXJyb3IsIHNjb3BlLCBtLCAuLi5zQXJncyk7CgkJCQl9CgoJCQkJdGhpcy5fZml4Tm9kZSgpOwoJCQkJcmV0dXJuIHJldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQllcnJvcihleCwgMiwgLi4uc0FyZ3MsIHNjcmlwdCk7CgkJCQl9IGVsc2UgewoJCQkJCWVycm9yKGV4LCAyKTsKCQkJCX0KCQkJfQoJCX0pKHR5cGUsIC4uLnNmQXJncyk7Cgl9Cn07CgoKc2FsZXNub3cuVXNlciA9IGNsYXNzIFVzZXIgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJc0tpNWZaMmwwYUhWaUluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmZZWFYwYUc5eWFYcGxMblZ6WlhKdVlXMWxJam9pWm1Ga2FTSXNJbDloZFhSb2IzSnBlbVV1Y0dGemMzZHZjbVFpT2lJeE1qTWlMQ0pmWVhWMGFHOXlhWHBsTG5SbGMzUlZjMlZ5SWpwN0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2laMlZ1WkdWeUlqcDdJbU52WkdVaU9pSk5JaXdpYm1GdFpTSTZJazFoYkdVaWZTd2lZMjlrWlNJNkltWmhaR2tpTENKdVlXMWxJam9pUm1Ga2FTSjlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidXNlcm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3VzZXJuYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGFzc3dvcmQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3Bhc3N3b3JkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGVwYXJ0bWVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbWFuYWdlcl9EZXBhcnRtZW50cygpOwoKCQl0aGlzLmNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKTsKCgkJdGhpcy5jbGVhcl9jb250YWN0X0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX3VzZXJfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlVzZXIiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuX2RlcGFydG1lbnQpIHRoaXMuX2RlcGFydG1lbnQuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5jYWxsZXJfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcm5hbWUgKiovCgl1c2VybmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJuYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidXNlcm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3VzZXJuYW1lICE9IHYpIHsKCQkJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl91c2VybmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl91c2VybmFtZSk7CgkJfQoJfQoKCWNsZWFyX3VzZXJuYW1lKCkgewoJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fdXNlcm5hbWUgPSBudWxsOwoJCXRoaXMuX3VzZXJuYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VybmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhc3N3b3JkICoqLwoJcGFzc3dvcmQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXNzd29yZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInBhc3N3b3JkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9wYXNzd29yZCAhPSB2KSB7CgkJCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcGFzc3dvcmQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGFzc3dvcmQpOwoJCX0KCX0KCgljbGVhcl9wYXNzd29yZCgpIHsKCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBudWxsOwoJCXRoaXMuX3Bhc3N3b3JkID0gbnVsbDsKCQl0aGlzLl9wYXNzd29yZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFzc3dvcmQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50ICoqLwoJZGVwYXJ0bWVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RlcGFydG1lbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkZXBhcnRtZW50Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMTZmOWYxZmUtNTU1My00Nzg1LThmNzAtYzhjODE1ZDYzMjY4JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRGVwYXJ0bWVudCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMTZmOWYxZmUtNTU1My00Nzg1LThmNzAtYzhjODE1ZDYzMjY4IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkRlcGFydG1lbnQiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGVwYXJ0bWVudCAhPSB2KSB7CgkJCQl0aGlzLl9kZXBhcnRtZW50X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fZGVwYXJ0bWVudCA/IHRoaXMuX2RlcGFydG1lbnQuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2RlcGFydG1lbnRfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2RlcGFydG1lbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGVwYXJ0bWVudCk7CgkJfQoJfQoKCWNsZWFyX2RlcGFydG1lbnQoKSB7CgkJdGhpcy5fZGVwYXJ0bWVudF9zZXQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlcGFydG1lbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyX0RlcGFydG1lbnRzICoqLwoJbWFuYWdlcl9EZXBhcnRtZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMTZmOWYxZmUtNTU1My00Nzg1LThmNzAtYzhjODE1ZDYzMjY4JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdEZXBhcnRtZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9tYW5hZ2VyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgIm1hbmFnZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkRlcGFydG1lbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJtYW5hZ2VyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRGVwYXJ0bWVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5tYW5hZ2VyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHMucHVzaCguLi52KTsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9tYW5hZ2VyX0RlcGFydG1lbnRzKCkgewoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1hbmFnZXJfRGVwYXJ0bWVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYWxsZXJfSW5jaWRlbnRzICoqLwoJY2FsbGVyX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fY2FsbGVyX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnYjNhMGIwMjAtOWMwMC00YmQwLWFkOTQtOTE2Mzg3OWI0ZGMwJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY2FsbGVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNhbGxlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXJfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYWxsZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5jYWxsZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2FsbGVyX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyX0luY2lkZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3RfSW5jaWRlbnRzICoqLwoJY29udGFjdF9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdiM2EwYjAyMC05YzAwLTRiZDAtYWQ5NC05MTYzODc5YjRkYzAnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jb250YWN0X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY29udGFjdCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY29udGFjdF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdF9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyX0dyb3VwX01lbWJlcnMgKiovCgl1c2VyX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMGU3N2Y3MjEtZjNiMS00NTExLThmNzYtNTA1ODY0NzNhMDYzJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3VzZXJfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcl9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ1c2VyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJHcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgInVzZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudXNlcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdXNlcl9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXJfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3VzZXJuYW1lX3NldCwKCgkJCXRoaXMuX3Bhc3N3b3JkX3NldCwKCgkJCXRoaXMuX2RlcGFydG1lbnRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0LAoKCQkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdXNlcm5hbWVfc2V0ID0gdGhpcy5fdXNlcm5hbWVfc2V0OwoJCXJldC5fdXNlcm5hbWVfY29vcCA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJcmV0LnVzZXJuYW1lID0gdGhpcy51c2VybmFtZSgpID8gdGhpcy51c2VybmFtZSgpIDogdGhpcy51c2VybmFtZSgpOwoKCQlyZXQuX3Bhc3N3b3JkX3NldCA9IHRoaXMuX3Bhc3N3b3JkX3NldDsKCQlyZXQuX3Bhc3N3b3JkX2Nvb3AgPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCXJldC5wYXNzd29yZCA9IHRoaXMucGFzc3dvcmQoKSA/IHRoaXMucGFzc3dvcmQoKSA6IHRoaXMucGFzc3dvcmQoKTsKCgkJcmV0Ll9kZXBhcnRtZW50X3NldCA9IHRoaXMuX2RlcGFydG1lbnRfc2V0OwoJCXJldC5fZGVwYXJ0bWVudF9jb29wID0gdGhpcy5fZGVwYXJ0bWVudF9jb29wOwoJCXJldC5kZXBhcnRtZW50ID0gdGhpcy5kZXBhcnRtZW50KCkgPyB0aGlzLmRlcGFydG1lbnQoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5kZXBhcnRtZW50KCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuY2FsbGVyX0luY2lkZW50cyA9IHRoaXMuY2FsbGVyX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNvbnRhY3RfSW5jaWRlbnRzID0gdGhpcy5jb250YWN0X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnVzZXJfR3JvdXBfTWVtYmVycyA9IHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCWlmICghdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmICFzYWxlc25vdy5fX3Rva2VuICYmIHRoaXMuVGVzdFsnX2F1dGhvcml6ZS51c2VybmFtZSddKSB7CgkJCXVzZXJuYW1lID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnVzZXJuYW1lJ107CgkJCXBhc3N3b3JkID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnBhc3N3b3JkJ107CgkJfQoKCQlpZiAoYlNlcnZlcikgewoJCQlpZiAodXNlcm5hbWUgJiYgIXNhbGVzbm93Ll90ZXN0VXNlcikgewoJCQkJc2FsZXNub3cuX3Rlc3RVc2VyID0gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZnJvbURvY3VtZW50KHRoaXMuVGVzdFsnX2F1dGhvcml6ZS50ZXN0VXNlciddIHx8IHt9KS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLnN0b3JlKCk7CgkJCX0KCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMudXNlcm5hbWUodXNlcm5hbWUsICc9JykucGFzc3dvcmQocGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgT2JqOiIsIHJldCk7CgoJCQlpZiAocmV0KSB7CgkJCQlpZiAodHlwZW9mKGpzb253ZWJ0b2tlbikgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0ganNvbndlYnRva2VuLnNpZ24ocmV0Ll90b0RvY3VtZW50KCksIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCB7CgkJCQkJCWV4cGlyZXNJbjogJzE4MDBzJwoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJldC5fdG9Eb2N1bWVudCgpKSk7CgkJCQl9CgkJCX0KCgkJCXJldCA9IHsKCQkJCWFjY2Vzc190b2tlbjogcmV0LAoJCQl9OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgdG9rZW46ICIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJbGV0IGNsaWVudF9pZCA9IHRoaXMuX19jb25maWcoJ2NsaWVudF9pZCcpOwoJCQlsZXQgY2xpZW50X3NlY3JldCA9IHRoaXMuX19jb25maWcoJ3NlY3JldCcpOwoKCQkJaWYgKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgc2FsZXNub3cuX190b2tlbikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gdXNlcm5hbWUvcGFzc3dvcmQgYW5kIHRva2VuIGFscmVhZHkgZXhpc3RzIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNhbGVzbm93Ll9fdG9rZW4gPSBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuYXV0aG9yaXplKCk7CgoJCX0KCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJkZXBhcnRtZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBkZXBhcnRtZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX3NlcnZlcihvcHRpb25zID0ge30pIHsKCQlpZiAob3B0aW9ucy5jbGVhckNvbnNvbGUgJiYgdHlwZW9mKGNsZWFyKSAhPT0gJ3VuZGVmaW5lZCcpIGNsZWFyKCk7CgoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgc2FsZXNub3cuaHJlZnMpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIHNhbGVzbm93LmhyZWZzLm1hcChuID0+IG4ubGliKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwsIHNhbGVzbm93LmhyZWZzKTsKCQkJfQoJCX0KCgkJbGV0IHNlY3VyZSA9IHRoaXMuX19jb25maWcoJ3NlY3VyZScpOwoJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gZ2xvYmFscwoJCQl2YXIgZ2xvYmFsTW9kdWxlcyA9IHsKCQkJCWV4cHJlc3M6ICdleHByZXNzJywKCQkJCWh0dHBzOiAnaHR0cHMnLAoJCQkJaHR0cDogJ2h0dHAnLAoJCQkJc2VsZnNpZ25lZDogJ3NlbGZzaWduZWQnLAoJCQkJdXRpbDogJ3V0aWwnLAoJCQkJY29yczogJ2NvcnMnLAoJCQkJYm9keVBhcnNlcjogJ2JvZHktcGFyc2VyJywKCQkJCWF4aW9zOiAnYXhpb3MnLAoJCQkJLy9jcnlwdG86ICdjcnlwdG8nLAoJCQkJb3M6ICdvcycsCgkJCQlEb3RPYmplY3Q6ICdkb3Qtb2JqZWN0JywKCgkJCQltaW5pbWlzdDogJ21pbmltaXN0JywKCgkJCQlmczogJ2ZzJywKCgkJCQlqc29ud2VidG9rZW46ICdqc29ud2VidG9rZW4nLAoKCQkJCXNxbGl0ZTogJ3NxbGl0ZTMnLAoJCQkJbXlzcWw6ICdteXNxbCcsCgoJCQl9OwoKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAwLCAibnBtIGluc3RhbGwgIiArIE9iamVjdC52YWx1ZXMoZ2xvYmFsTW9kdWxlcykuam9pbignICcpKTsKCQkJbGV0IG1pc3NpbmdHbG9iYWxNb2R1bGVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsTW9kdWxlcykubWFwKGUgPT4gewoJCQkJdHJ5IHsKCQkJCQlnbG9iYWxbZVswXV0gPSByZXF1aXJlKGVbMV0pOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJCQlyZXR1cm4gZVsxXTsKCQkJCX0KCQkJfSkuZmlsdGVyKGUgPT4gZSk7CgkJCWlmIChtaXNzaW5nR2xvYmFsTW9kdWxlcy5sZW5ndGgpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIm5wbSBpbnN0YWxsICIgKyBtaXNzaW5nR2xvYmFsTW9kdWxlcy5qb2luKCcgJykpOwoJCX0KCgkJaWYgKG9wdGlvbnMuaW5pdFNlbGYpIHsKCQkJaWYgKHRoaXMuaW5pdCkgewoJCQkJYXdhaXQgdGhpcy5fd2FpdCg1MDApOwoJCQkJaWYgKG9wdGlvbnMubG9hZFRvb2xzKSBhd2FpdCB0aGlzLl9sb2FkVG9vbHMob3B0aW9ucy5zYXZlVG9vbHMpOwoKCQkJCWF3YWl0IHRoaXMuaW5pdCgpOwoKCQkJCWxldCBzcWxUb29sID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5fX2RtbFN0YXRlbWVudHMpOwoJCQkJaWYgKG9wdGlvbnMuY29weURNTCAmJiBzcWxUb29sKSB7CgkJCQkJbGV0IGRtbHMgPSBzcWxUb29sLl9fZG1sU3RhdGVtZW50czsKCQkJCQlpZiAoc3FsVG9vbC50eXBlLm5hbWUgPT0gJ1NxbERCJykgZG1scyA9IFsgLyoiQ3VzdG9tZXJzIiwgIk9yZGVycyIsICJTaGlwcGluZ3MiLCAqLyAiZGVtbyJdLm1hcCh0ID0+IGBkcm9wIHRhYmxlIGlmIGV4aXN0cyAke3R9YCkuY29uY2F0KGRtbHMpOwoJCQkJCV9GckVNRC5fY29weVRleHRUb0NsaXBib2FyZChkbWxzLmpvaW4oJztcbicpKTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gcmVmcmVzaCBzY3JpcHQKCQl0aGlzLnNldEludGVydmFsKGFzeW5jIChzKSA9PiB7CgkJCXNhbGVzbm93Ll9fQ29udGVudCA9IHNhbGVzbm93Ll9fQ29udGVudCB8fCBuZXcgc2FsZXNub3cuQ29udGVudCgpLm5hbWUoJ0FQSSBTZXJ2ZXInKS5jb2RlKCdhcGlzZXJ2ZXInKTsKCQkJbGV0IGN0ID0gYXdhaXQgc2FsZXNub3cuX19Db250ZW50LmZpbmQoKTsKCQkJaWYgKCFjdCkgcmV0dXJuOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiY3QiLCBjdCk7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgImN0IiwgKChjdC5kYXRlKCkuZ2V0VGltZSgpIC0gc2FsZXNub3cuX19Db250ZW50LmRhdGUoKS5nZXRUaW1lKCkpLzEwMDApKTsKCQkJcmV0dXJuOwoJCQlpZiAoKChjdC5kYXRlKCkuZ2V0VGltZSgpIC0gc2FsZXNub3cuX19Db250ZW50LmRhdGUoKS5nZXRUaW1lKCkpIC8gMTAwMCkgPiA1KSB7CgkJCQlhd2FpdCBjdC5zdG9yZSgpOwoKCQkJCXNhbGVzbm93Ll9fQ29udGVudC5kYXRlKGN0LmRhdGUoKSk7CgkJCQlzYWxlc25vdy5fX0NvbnRlbnQuY29udGVudChudWxsKTsKCQkJfQoJCQkvL3JldHVybiB0cnVlOwoJCX0sIDAuNSwgKHR5cGVvZihwcm9jZXNzKSAhPT0gJ3VuZGVmaW5lZCcgJiYgcHJvY2Vzcy5hcmd2LnNsaWNlKDIpLmxlbmd0aCkgPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMilbMF0gOiAnc2FsZXNub3cnKTsKCgkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQljb25zdCBhcHAgPSBleHByZXNzKCk7CgoJCQlhcHAudXNlKGNvcnMoKSk7CgoJCQlhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7CgkJCQlleHRlbmRlZDogdHJ1ZSwKCQkJCWxpbWl0OiAnNTBtYicKCQkJfSkpOwoJCQlhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7CgkJCQl2ZXJpZnk6IChyZXEsIHJlcywgYnVmKSA9PiByZXEucmF3Qm9keSA9IGJ1ZgoJCQl9KSk7CgoJCQlnbG9iYWwuYXV0aGVudGljYXRlID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7CgkJCQljb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTsKCQkJCWNvbnN0IHRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07CgoJCQkJaWYgKHRva2VuID09IG51bGwpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpOwoKCQkJCWpzb253ZWJ0b2tlbi52ZXJpZnkodG9rZW4sIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCAoZXJyLCBvYmopID0+IHsKCQkJCQlpZiAoZXJyKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAzKTsKCgkJCQkJcmVxLl9fYXV0aG9yaXphdGlvbiA9IG9iajsKCQkJCQluZXh0KCk7CgkJCQl9KTsKCQkJfTsKCgkJCWFwcC5wb3N0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoJCQlhcHAuZ2V0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoKCQkJYXBwLnBvc3QoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7CgkJCWFwcC5nZXQoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKSB7CgkJCQlzYWxlc25vdy50cmFuc3BvcnRlciA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHsKCQkJCQlzZXJ2aWNlOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JyksCgkJCQkJYXV0aDogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpID8gewoJCQkJCQl1c2VyOiB0aGlzLl9fY29uZmlnKCdlbWFpbC51c2VyJyksCgkJCQkJCXBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksCgkJCQkJfSA6IHVuZGVmaW5lZCwKCQkJCX0pOwoKCQkJCS8qCgkJCQlhd2FpdCBzYWxlc25vdy50cmFuc3BvcnRlci5zZW5kTWFpbCh7CgkJCQkgICAgZnJvbTogdGhpcy5fX2NvbmZpZygnZW1haWwuc2VuZGVyJyksCgkJCQkgICAgdG8sCgkJCQkgICAgc3ViamVjdCwKCQkJCSAgICB0ZXh0LAoJCQkJfSk7CgkJCQkqLwoJCQl9CgoJCQlsZXQgcG9ydCA9IHNhbGVzbm93Ll9ub2RlID8gKHNhbGVzbm93Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKSA6IDMwMDA7CgkJCWxldCBhZGRyZXNzID0gIjAuMC4wLjAiOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ0NPUlNQcm94eScpKSB7CgkJCQljb3JzX3Byb3h5LmNyZWF0ZVNlcnZlcih7CgkJCQkJb3JpZ2luV2hpdGVsaXN0OiBbXSwgLy8gQWxsb3cgYWxsIG9yaWdpbnMKCQkJCQlyZXF1aXJlSGVhZGVyOiBbJ29yaWdpbicsICd4LXJlcXVlc3RlZC13aXRoJ10sCgkJCQkJcmVtb3ZlSGVhZGVyczogWydjb29raWUnLCAnY29va2llMiddCgkJCQl9KS5saXN0ZW4oODAwMCwgYWRkcmVzcywgZnVuY3Rpb24oKSB7CgkJCQkJY29uc29sZS5sb2coJ1J1bm5pbmcgQ09SUyBBbnl3aGVyZSBvbiAnICsgYWRkcmVzcyArICc6JyArICc4MDAwJyk7CgkJCQl9KTsKCQkJfQoKCQkJbGV0IGxpc3RlbiA9IGFzeW5jICgpID0+IHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgYHNhbGVzbm93WyR7dGhpcy5pcEFkZHJlc3MoKX1dIGxpc3RlbmluZyBhdCBodHRwJHtzZWN1cmU/J3MnOicnfTovLyR7YWRkcmVzc306JHtwb3J0fWApOwoJCQlpZiAoc2VjdXJlKSB7CgkJCQlsZXQgY2VydCA9IG51bGw7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSkgewoJCQkJCWNlcnQgPSB7CgkJCQkJCXByaXZhdGU6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUucHJpdmF0ZScpKSksCgkJCQkJCWNlcnQ6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUuY2VydCcpKSksCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJY2VydCA9IHNlbGZzaWduZWQuZ2VuZXJhdGUoW3sKCQkJCQkJbmFtZTogJ2NvbW1vbk5hbWUnLAoJCQkJCQl2YWx1ZTogJ25hbW1vdXIuY29tJwoJCQkJCX1dLCB7CgkJCQkJCWRheXM6IDM2NQoJCQkJCX0pOwoJCQkJfQoJCQkJZ2xvYmFsLmV4U2VydmVyID0gaHR0cHMuY3JlYXRlU2VydmVyKHsKCQkJCQlrZXk6IGNlcnQucHJpdmF0ZSwKCQkJCQljZXJ0OiBjZXJ0LmNlcnQKCQkJCX0sIGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7CgkJCX0gZWxzZSB7CgkJCQlnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApLmxpc3Rlbihwb3J0LCBhZGRyZXNzLCBsaXN0ZW4pOwoJCQl9CgkJfQoJfQoKCWFzeW5jIF9pbmJvdW5kQ2FsbChyZXEsIHJlcywgY05hbWUsIG1OYW1lKSB7CgkJbGV0IHJldCA9IHt9OwoJCXRyeSB7CgkJCXJldCA9IGF3YWl0IG5ldyBzYWxlc25vd1tyZXEucGFyYW1zLmNsYXNzIHx8IGNOYW1lXSgpLl9pbnZva2UocmVxLnBhcmFtcy5tZXRob2QgfHwgbU5hbWUsIHJlcS5ib2R5LCByZXEucXVlcnksIHJlcS5fX2F1dGhvcml6YXRpb24pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbmJvdW5kQ2FsbCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCXJldCA9IHsKCQkJCUV4Y2VwdGlvbjogIkV4Y2VwdGlvbjogIiArIGV4LAoJCQl9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmVxLnF1ZXJ5WyJqc29uIl0gIT0gInRydWUiICYmIHJlcS5ib2R5ICYmIHJlcS5ib2R5Ll9fZmxhdHRlZCkgcmV0ID0gewoJCQlfX2ZsYXR0ZWQ6IEZsYXR0ZWQuc3RyaW5naWZ5KHJldCkKCQl9OwoKCQlpZiAocmV0ICYmIHR5cGVvZihyZXQpID09PSAibnVtYmVyIikgcmV0ID0gcmV0LnRvU3RyaW5nKCk7CgkJcmVzLnNlbmQocmV0KTsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJpbml0IjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJhdXRob3JpemUiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Vc2VyLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImF1dGhvcml6ZSI6IHsKCgkJCQlzYWxlc25vdy5fX3Rva2VuID0gewoJCQkJCXRva2VuX3R5cGU6ICJCZWFyZXIiLAoJCQkJCWFjY2Vzc190b2tlbjogcmV0CgkJCQl9OwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbml0IjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJhdXRob3JpemUiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFVzZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBVc2VyLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJaWYgKHNhbGVzbm93LlRvb2xzICYmIHNhbGVzbm93LlRvb2xzLmxlbmd0aCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogVG9vbHMgYWxyZWFkeSBsb2FkZWRgKTsKCQkJcmV0dXJuIHNhbGVzbm93LlRvb2xzOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IExvYWRpbmcgdG9vbHMuLi5gKTsKCgkJZGVsZXRlIHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzOwoJCWRlbGV0ZSBzYWxlc25vdy5fX2NvbmZpZzsKCgkJbGV0IHRvb2xzID0gW3sKCQkJdHlwZTogewoJCQkJbmFtZTogIlNxbERCIiwKCQkJfSwKCQkJdG9vbF9Db25maWdzOiBbewoJCQkJbmFtZTogImNyZWF0ZSIsCgkJCQl2YWx1ZTogMywKCQkJfSwgewoJCQkJbmFtZTogInR5cGUiLAoJCQkJdmFsdWU6ICJzcWxpdGUiLAoJCQl9LCB7CgkJCQluYW1lOiAiU3luY0VudGl0eUF0dHJpYnV0ZXMiLAoJCQkJdmFsdWU6IHRydWUsCgkJCX0sIHsKCQkJCW5hbWU6ICJTeW5jVHlwZWRBdHRyaWJ1dGVzIiwKCQkJCXZhbHVlOiB0cnVlLAoJCQl9XQoJCX1dOwoKCQl0cnkgewoJCQlsZXQgZk5hbWUgPSAiQVBJU0VSVkVSX19sb2FkVG9vbHMuanNvbiI7CgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZnMuZXhpc3RzU3luYyhmTmFtZSkpIHRvb2xzID0gdGhpcy5ydW5TY3JpcHQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZk5hbWUpKSB8fCB0b29sczsKCQkJaWYgKHRoaXMuX19jb25maWcoImdpdGh1Yi50b29scyIpKSB0b29scyA9IHRoaXMucnVuU2NyaXB0KGF3YWl0IGF4aW9zLmdldCh0aGlzLl9fY29uZmlnKCJnaXRodWIudG9vbHMiKSArIGZOYW1lLCB7CgkJCQl2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1cyA8IDUwMAoJCQl9KS5kYXRhKSB8fCB0b29sczsKCgkJCWxldCB0RGF0YSA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkpIHREYXRhID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCB7CgkJCQlOYW1lOiBmTmFtZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUKCQkJfSk7CgkJCWlmICghdERhdGEpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBub3QgaW4gQ01TYCk7CgkJCX0gZWxzZSB7CgkJCQl0b29scyA9IHRoaXMucnVuU2NyaXB0KHREYXRhLlNjcmlwdCkgfHwgdG9vbHM7CgkJCX0KCgkJCXRvb2xzID0gc2FsZXNub3cuX19Ub29scyB8fCB0b29sczsKCQkJZGVsZXRlIHNhbGVzbm93Ll9fVG9vbHM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJfQoKCQl0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodC5hY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCAodHlwZW9mKHQuYWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgJiYgdC5hY3RpdmUpKS5mb3JFYWNoKHQgPT4gewoJCQl0Lm5hbWUgPSB0Lm5hbWUgfHwgdC50eXBlLm5hbWU7CgoJCQl0LmFjdGl2ZSA9IHR5cGVvZih0LmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gdC5hY3RpdmUgOiB0cnVlOwoJCQl0LmVuYWJsZWQgPSB0eXBlb2YodC5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LmVuYWJsZWQgOiB0cnVlOwoJCQl0LnR5cGUuYWN0aXZlID0gdHlwZW9mKHQudHlwZS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IHQudHlwZS5hY3RpdmUgOiB0cnVlOwoJCQl0LnR5cGUuZW5hYmxlZCA9IHR5cGVvZih0LnR5cGUuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gdC50eXBlLmVuYWJsZWQgOiB0cnVlOwoKCQkJdC50b29sX0NvbmZpZ3MgPSB0LnRvb2xfQ29uZmlncyB8fCBbXTsKCQkJdC50b29sX0NvbmZpZ3MuZm9yRWFjaChjID0+IHsKCQkJCWMuYWN0aXZlID0gdHlwZW9mKGMuYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmFjdGl2ZSA6IHRydWU7CgkJCQljLmVuYWJsZWQgPSB0eXBlb2YoYy5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmVuYWJsZWQgOiB0cnVlOwoJCQl9KTsKCgkJCXQudHlwZS50eXBlX0NvbmZpZ3MgPSB0LnR5cGUudHlwZV9Db25maWdzIHx8IFtdOwoJCQl0LnR5cGUudHlwZV9Db25maWdzLmZvckVhY2goYyA9PiB7CgkJCQljLmFjdGl2ZSA9IHR5cGVvZihjLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gYy5hY3RpdmUgOiB0cnVlOwoJCQkJYy5lbmFibGVkID0gdHlwZW9mKGMuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gYy5lbmFibGVkIDogdHJ1ZTsKCQkJfSk7CgoJCQl0LnR5cGUudHlwZV9NYXBwaW5ncyA9IHQudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdOwoJCQl0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gewoJCQkJbS5hY3RpdmUgPSB0eXBlb2YobS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IG0uYWN0aXZlIDogdHJ1ZTsKCQkJCW0uZW5hYmxlZCA9IHR5cGVvZihtLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IG0uZW5hYmxlZCA6IHRydWU7CgkJCQltLnR5cGUgPSB7CgkJCQkJbmFtZTogdC50eXBlLm5hbWUKCQkJCX07CgkJCX0pOwoKCQkJdC50b29sX01hcHBpbmdzID0gdC50b29sX01hcHBpbmdzIHx8IFtdOwoJCQl0LnRvb2xfTWFwcGluZ3MuZm9yRWFjaChtID0+IHsKCQkJCW0uYWN0aXZlID0gdHlwZW9mKG0uYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmFjdGl2ZSA6IHRydWU7CgkJCQltLmVuYWJsZWQgPSB0eXBlb2YobS5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmVuYWJsZWQgOiB0cnVlOwoJCQkJbS50b29sID0gewoJCQkJCW5hbWU6IHQubmFtZQoJCQkJfTsKCQkJfSk7CgkJfSk7CgkJdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJbE5PVDFkUFQwSWlMQ0pUWVd4bGMwWnZjbU5sSWl3aVIybDBTSFZpSWl3aVJtbHNaVk41YzNSbGJTSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KS5maW5kKF90ID0+ICh0eXBlb2YoX3QpID09PSAnc3RyaW5nJyA/IF90IDogX3QubmFtZSkgPT0gdC5uYW1lKSk7CgoJCXRvb2xzLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7CgkJCURvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpICE9PSAib2JqZWN0IikuY29uY2F0KERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSA9PT0gIm9iamVjdCIpLm1hcChjID0+IE9iamVjdC5rZXlzKGMudmFsdWUpLm1hcChuY29kZSA9PiB7CgkJCQlsZXQgX2MgPSB7CgkJCQkJbmFtZTogYy5uYW1lLAoJCQkJCXZhbHVlOiBjLnZhbHVlW25jb2RlXSwKCQkJCX07CgkJCQlpZiAobmNvZGUgIT0gImRlZmF1bHQiKSB7CgkJCQkJX2Mubm9kZSA9IHsKCQkJCQkJY29kZTogbmNvZGUsCgkJCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCQkJZW5hYmxlZDogZmFsc2UsIC8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMKCQkJCQkJdHlwZTogewoJCQkJCQkJbmFtZTogIk5vZGVKUyIsCgkJCQkJCX0KCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuIF9jOwoJCQl9KS5mbGF0KCkpLmZsYXQoKSksIHQpOwoJCQlEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5mb3JFYWNoKGMgPT4gYy52YWx1ZSA9IEpTT04uc3RyaW5naWZ5KGMudmFsdWUpKTsKCQl9KSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBhcmUgJHt0b29scy5sZW5ndGh9YCk7CgoJCXNhbGVzbm93LlRvb2xzID0gdG9vbHM7CgoJCXNhbGVzbm93LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zKS5mb3JFYWNoKHQgPT4gewoJCQl0LmF4aW9zID0gYXhpb3MuY3JlYXRlKCk7CgkJCXQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKGFzeW5jIGNvbmZpZyA9PiB7CgkJCQl0cnkgewoJCQkJCWNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307CgkJCQkJY29uZmlnLm1ldGEuY291bnRlciA9IDQ7CgoJCQkJCWxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pOwoJCQkJCWxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgYXV0aFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhvcml6ZS51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQsCgkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJfSk7CgkJCQkJaWYgKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKSA8IDApIHsKCQkJCQkJaWYgKCF0b2tlbiAmJiBzYWxlc25vdy5fbm9kZSkgewoJCQkJCQkJbGV0IGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgkJCQkJCQlsZXQgYXV0aE1ldGhvZCA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5tZXRob2QnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgoJCQkJCQkJaWYgKGF1dGhNZXRob2QpIHsKCQkJCQkJCQlsZXQgZmxvdyA9ICghYXV0aENvZGUgJiYgYXV0aE1ldGhvZCA9PSAncG9zdCcpID8gJ2F1dGhvcml6ZScgOiAndG9rZW4nOwoJCQkJCQkJCS8vIGdldCB0aGUgdG9rZW4KCQkJCQkJCQkvLyB0aGUgdG9rZW5VcmkgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQoJCQkJCQkJCXRva2VuVXJpID0gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS51cmlgLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQl9KTsKCQkJCQkJCQlsZXQgdGNvbmZpZyA9IHsKCQkJCQkJCQkJdXJsOiB0b2tlblVyaSwKCQkJCQkJCQkJbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0JywgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KSwKCQkJCQkJCQkJaGVhZGVyczogT2JqZWN0LmFzc2lnbih7CgkJCQkJCQkJCQkiQ29udGVudC1UeXBlIjogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5jb250ZW50X3R5cGVgLCAidGV4dC9qc29uIiwgewoJCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJCX0pLAoJCQkJCQkJCQkJIkF1dGhvcml6YXRpb24iOiAiQmFzaWMgIiArIHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7CgkJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQkJfSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHsKCQkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCQl9KSksCgkJCQkJCQkJCX0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHsKCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJfSkpLAoJCQkJCQkJCQlkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7CgkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCX0pLAoJCQkJCQkJCX07CgkJCQkJCQkJbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOwoJCQkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgIlRva2VuIGZldGNoZWQiLCBmbG93LCB0Y29uZmlnLCB0cmVzLmRhdGEpOwoJCQkJCQkJCVsnYWNjZXNzX3Rva2VuJywgJ3Rva2VuX3R5cGUnLCAnZXhwaXJlc19pbicsICdyZWZyZXNoX3Rva2VuJ10uZm9yRWFjaCh0YSA9PiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke3RhfWAsIG51bGwsIHsKCQkJCQkJCQkJdG9vbDogdCwKCQkJCQkJCQkJbm9kZTogc2FsZXNub3cuX25vZGUsCgkJCQkJCQkJCW5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KV0KCQkJCQkJCQl9KSk7CgkJCQkJCQkJdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQsCgkJCQkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKHRva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW5fdHlwZSIsICJCZWFyZXIiLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICsgIiAiICsgdG9rZW47CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDIsICJheGlvcy5yZXF1ZXN0IiwgZXgpOwoJCQkJfQoJCQkJcmV0dXJuIGNvbmZpZzsKCQkJfSwgYXN5bmMgZXJyb3IgPT4ge30pOwoJCQl0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gewoJCQkJcmV0dXJuIHJlc3BvbnNlOwoJCQl9LCBhc3luYyBlcnJvciA9PiB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsICJheGlvcyByZXNwb25zZSBlcnJvciIsIGVycm9yKTsKCQkJCXRyeSB7CgkJCQkJY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOwoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICYmIGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxICYmICFvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ICYmIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24uaW5kZXhPZih0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pKSA+IDApIHsKCQkJCQkJb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSA9IHRydWU7CgkJCQkJCS8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpCgoJCQkJCQlvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3R5cGUiLCAiQmVhcmVyIiwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSArICIgIiArIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7CgkJCQkJfQoJCQkJCXJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMiwgIlJlc3AgSW50ZXJjZXB0b3IiLCBleCwgZXJyb3IpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiRXhpdGluZyIpOwoJCXJldHVybiB0b29sczsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQl0cnkgewoJCQlpZiAodHlwZW9mKHN0cikgIT09ICdzdHJpbmcnKSByZXR1cm4gc3RyOwoJCQlsZXQgcmV4ID0gYCR7cHJlZml4fShbXiR7cG9zdGZpeH1dKykke3Bvc3RmaXh9YDsKCQkJKHN0ci5tYXRjaChuZXcgUmVnRXhwKHJleCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiBzdHIgPSBzdHIucmVwbGFjZShtLCBtID0+IGZ1bihtLnJlcGxhY2UocHJlZml4LCAnJykucmVwbGFjZShwb3N0Zml4LCAnJykpKSk7CgoJCQlyZXR1cm4gc3RyOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19wYXJhbWV0cml6ZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgdGhpcy5kZXBhcnRtZW50KCkpIHRoaXMuZGVwYXJ0bWVudCgpLl9fc3luY19vbihkKTsKCgkJCS8vIHRoaXMubWFuYWdlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmNhbGxlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmNvbnRhY3RfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy51c2VyX1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcih0aGlzLklkKQoKCQkJLnVzZXJuYW1lKHRoaXMudXNlcm5hbWUoKSwgdGhpcy5fdXNlcm5hbWVfY29vcCkKCgkJCS5wYXNzd29yZCh0aGlzLnBhc3N3b3JkKCksIHRoaXMuX3Bhc3N3b3JkX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudCh0aGlzLmRlcGFydG1lbnQoKSwgdGhpcy5fZGVwYXJ0bWVudF9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5tYW5hZ2VyX0RlcGFydG1lbnRzKHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpLCB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3ApCgoJCQkuY2FsbGVyX0luY2lkZW50cyh0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSwgdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wKQoKCQkJLmNvbnRhY3RfSW5jaWRlbnRzKHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSwgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCkKCgkJCS51c2VyX0dyb3VwX01lbWJlcnModGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSwgdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnVXNlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKa1pYQmhjblJ0Wlc1MElqb2lSR1Z3WVhKMGJXVnVkQ0o5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXRyeSB7CgkJCWlmIChBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSk7CgoJCQlsZXQgc0ZpZWxkID0gYlJldmVyc2UgPyAndGFyZ2V0JyA6ICdzb3VyY2UnOwoJCQlsZXQgc1NjcmlwdCA9IChiUmV2ZXJzZSA/ICdvdXQnIDogJ2luJykgKyAnU2NyaXB0JzsKCQkJbGV0IHNDb25kID0gKGJSZXZlcnNlID8gJ291dCcgOiAnaW4nKSArICdDb25kaXRpb24nOwoJCQlsZXQgdEZpZWxkID0gYlJldmVyc2UgPyAnc291cmNlJyA6ICd0YXJnZXQnOwoJCQlsZXQgdFNjcmlwdCA9IChiUmV2ZXJzZSA/ICdpbicgOiAnb3V0JykgKyAnU2NyaXB0JzsKCQkJbGV0IHRDb25kID0gKGJSZXZlcnNlID8gJ2luJyA6ICdvdXQnKSArICdDb25kaXRpb24nOwoKCQkJbGV0IF9tYXRjaCA9IChzLCByKSA9PiB7CgkJCQlsZXQgYW5zd2VyID0gcy5tYXRjaChuZXcgUmVnRXhwKHIsICdnJykpOwoJCQkJcmV0dXJuIHMgPT0gciB8fCAoKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKSA/IHRydWUgOiBmYWxzZSk7CgkJCX0KCgkJCWxldCB0ZXN0ID0gbSA9PiAoewoJCQkJdmFsaWQ6IG0uYWN0aXZlICYmIG0uZW5hYmxlZCwKCQkJCWNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLAoJCQkJY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwKCQkJCXNGaWVsZDogdHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJyB8fCBfbWF0Y2goY29kZSwgbVtzRmllbGRdKSwKCQkJCXNTY3JpcHQ6IHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pICE9PSAndW5kZWZpbmVkJywKCQkJCXRhcmdldDogKG1bdEZpZWxkXSB8fCBtW3RTY3JpcHRdKSAhPSBudWxsLAoJCQkJdGV4dDogY29kZSArICcsJyArIHNGaWVsZCArICcsJyArIHRGaWVsZCwKCQkJfSk7CgoJCQlsZXQgbXMgPSAodG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pOwoKCQkJbXMgPSBtcy5maWx0ZXIobSA9PiB0ZXN0KG0pLnZhbGlkICYmIHRlc3QobSkuY29udGV4dCAmJiB0ZXN0KG0pLmNsYXNzICYmICh0ZXN0KG0pLnNGaWVsZCB8fCB0ZXN0KG0pLnNTY3JpcHQpICYmIHRlc3QobSkudGFyZ2V0KS5zb3J0KG0gPT4gLW0ub3JkZXIpOwoJCQlpZiAobXMubGVuZ3RoKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2NsYXNzTmFtZX0uJHtjb2RlfWAsIHRoaXMuX2JlYXV0aWZ5KG1zLm1hcChtID0+ICh7CgkJCQltLAoJCQkJdGVzdDogdGVzdChtKQoJCQl9KSksICdqYXZhc2NyaXB0JykpOwoKCQkJbXMuZmlsdGVyKG0gPT4gbVtzRmllbGRdICYmIG1bdEZpZWxkXSkuZm9yRWFjaChtID0+IHsKCQkJCWlmIChtLmNvbnRleHQgPT0gJ0VudGl0eUNsYXNzJykge30gZWxzZSBpZiAodHlwZW9mKG1bdEZpZWxkXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkvLyByZXBsYWNlCgkJCQkJaWYgKHR5cGVvZihjb2RlKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKG1bc0ZpZWxkXSwgJ2cnKSwgbVt0RmllbGRdKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkvL0RvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlpZiAodHlwZW9mKGNvZGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQljb2RlID0gbVt0RmllbGRdOwoJCQkJCX0gZWxzZSB7CgkJCQkJCURvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7CgkJCQkJfQoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7Y29udGV4dH1dLyR7Y2xhc3NOYW1lfS4ke2NvZGV9OiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7CgkJCX0pOwoJCQltcy5mb3JFYWNoKG0gPT4gewoKCQkJCWlmIChtW3RTY3JpcHRdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7bS5jb250ZXh0fV0vJHttLmNsYXNzTmFtZX0uJHtjb2RlfSgke3RTY3JpcHR9KTogJHttW3RTY3JpcHRdfWAsIG0pOwoJCQkJCXRoaXMuX1NjcmlwdChgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIHNjb3BlLCBtZXRob2QsIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCBfdGhpcywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgPT4ge2lmKAooKG9TY29wZSkgPT4gewogICAgbGV0IHJldCA9ICR7bVt0Q29uZF19OwogICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0pKHNhbGVzbm93KQopeyR7bVt0U2NyaXB0XX19fWAsIHRTY3JpcHQsICdNYXBwaW5nJywgc2FsZXNub3csIG0sIG9iakZyb20sIG9ialRvLCBjb2RlLCB0aGlzLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCQkJCX0KCgkJCX0pOwoKCQkJaWYgKHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybiBvYmpUbzsKCQkJfQoKCQkJcmV0dXJuIGNvZGU7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVXNlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJdHJ5IHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJCW9wdGlvbnMuX3RoaXMgPSBvcHRpb25zLl90aGlzIHx8IHRoaXM7CgkJCW9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJ1VzZXInOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwgb3B0aW9ucy5fdGhpcy5Ub29sIHx8IHRoaXMuVG9vbDsKCQkJaWYgKHR5cGVvZihvcHRpb25zLnRvb2wpID09PSAnb2JqZWN0JyAmJiBvcHRpb25zLnRvb2wuY29uc3RydWN0b3IubmFtZSA9PSAnVG9vbCcpIG9wdGlvbnMudG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wubmFtZSgpKTsKCgkJCWlmICh0eXBlb2Yob3B0aW9ucy50b29sKSA9PT0gJ3N0cmluZycpIG9wdGlvbnMudG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdC50eXBlLm5hbWUgPT0gb3B0aW9ucy50b29sKTsKCQkJaWYgKHR5cGVvZihvcHRpb25zLnRvb2wpICE9PSAnb2JqZWN0JykgdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgb3B0aW9ucy50b29sKTsKCQkJaWYgKCFvcHRpb25zLnRvb2wpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIG5vdCBkZWZpbmVkIiwgb3B0aW9ucy5fdGhpcy5Ub29sLCBzYWxlc25vdy5Ub29scywgb3B0aW9ucy5fdGhpcy5Ub29scyk7CgkJCS8vb3B0aW9ucy5ub0NhY2hlID0gdHJ1ZTsKCQkJaWYgKCFvcHRpb25zLm5vQ2FjaGUpIHNhbGVzbm93Ll9fY29uZmlnID0gc2FsZXNub3cuX19jb25maWcgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQlyZXQgPSBudWxsOwoKCQkJCS8vIHVzZSBzY29wZSBjYWNoZSAoaW1wcm92ZXMgcGVyZm9ybWFuY2UpCgkJCQlpZiAoIW9wdGlvbnMubm9DYWNoZSAmJiBzYWxlc25vdy5fX2NvbmZpZy5oYXNPd25Qcm9wZXJ0eShgJHtvcHRpb25zLl9jbGFzc30uJHtvcHRpb25zLnRvb2wubmFtZX0uJHtuSUR9LiR7bn1gKSkgcmV0dXJuIHNhbGVzbm93Ll9fY29uZmlnW2Ake29wdGlvbnMuX2NsYXNzfS4ke29wdGlvbnMudG9vbC5uYW1lfS4ke25JRH0uJHtufWBdOwoJCQl9CgoJCQkvLyB0b29sX0NvbmZpZ3MsIHR5cGVfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWlmIChvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MgfHwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncykgewoJCQkJbGV0IGNmcyA9IFtdLmNvbmNhdChvcHRpb25zLnRvb2wudHlwZS50eXBlX0NvbmZpZ3MsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MpOwoJCQkJbGV0IHRjb25mID0gY2ZzLmZpbHRlcihjID0+IGMgJiYgYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KGNmcy5maWx0ZXIoYyA9PiBjICYmIGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCQlpZiAodGNvbmZbMF0uc2NyaXB0KSB7CgkJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoJHtPYmplY3Qua2V5cyhvcHRpb25zKS5qb2luKCcsICcpfSkgPT4gJHt0Y29uZlswXS5zY3JpcHR9YCkoLi4uT2JqZWN0LnZhbHVlcyhvcHRpb25zKSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQkJCXRyeSB7CgkJCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJCQl9CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQkJaWYgKG9wdGlvbnMubm9kZSkgdGMubm9kZSA9IHsKCQkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJCX07CgkJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJCXRjLm5hbWUgPSBuOwoJCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJCShvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncykucHVzaCh0Yyk7CgkJCQkJfQoJCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gb3B0aW9ucy5fdGhpcy5Db25maWcgPyBvcHRpb25zLl90aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJcmV0ID0gdGhpcy5fcGFyYW1ldHJpemUocmV0LCBwID0+IHRoaXMuX19jb25maWcocCwgbnVsbCwgb3B0aW9ucykpOwoKCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAwLCBuLCByZXQsIG9wdGlvbnMpOwoJCQlpZiAoIW9wdGlvbnMubm9DYWNoZSkgc2FsZXNub3cuX19jb25maWdbYCR7b3B0aW9ucy5fY2xhc3N9LiR7b3B0aW9ucy50b29sLm5hbWV9LiR7bklEfS4ke259YF0gPSByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLl9jbGFzcywgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpbml0LgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluaXQoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbml0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluaXQiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5pbml0Jyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJdHlwZW9mKHdpbmRvdykgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnaW5pdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm90IHJ1bm5pbmcgaW4gYSBicm93c2VyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsZXQgY29kZSA9ICcxMjMnOwoJCQlpZiAodGhpcy5zcigpLmJMb2NhbCkgewoJCQkJbGV0IG8gPSBuZXcgb1Njb3BlLkluY2lkZW50KG51bGwsICdTTk9XT09CJykuX2Zyb21Eb2N1bWVudCh7CgkJCQkJbnVtYmVyOiAiSU5DMDAwOTAwOSIsCgkJCQkJc3RhdGU6ICIxIiwKCQkJCQlwcmlvcml0eTogIjQiLAoJCQkJCWRlc2NyaXB0aW9uOiAid2hhdCBpZiIKCQkJCX0sIHRydWUpOwoJCQkJLy9sb2coby5fdG9Eb2N1bWVudCgpKTtsb2coby5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQkJby5Ub29sID0gIlNhbGVzRm9yY2UiOwoKCQkJCWxldCBzID0gby5fdG9TRlF1ZXJ5KG51bGwsIG51bGwsIHRydWUpOwoJCQkJLy9hd2FpdCBuZXcgb1Njb3BlLkNvbnRlbnQobnVsbCwgJ0dpdEh1YicpLm5hbWUoY29kZSkuY29kZShjb2RlKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5jb250ZW50KHMpLmVuYWJsZWQodHJ1ZSkuc3RvcmUoKTsKCQkJfSBlbHNlIHsKCQkJCWxldCBsYXN0USA9IG51bGw7CgkJCQl0aGlzLnNldEludGVydmFsKGFzeW5jIGNxID0+IHsKCQkJCQljcSA9IGF3YWl0IGNxLmZpbmQoKTsKCQkJCQlpZiAoY3EuY29udGVudCgpICE9IGxhc3RRKSB7CgkJCQkJCWxhc3RRID0gY3EuY29udGVudCgpOwoJCQkJCQlsb2coIm5ldyBxdWVyeSIpOwoJCQkJCQlhd2FpdCBuZXcgb1Njb3BlLlVzZXIobnVsbCwgJ1NhbGVzRm9yY2UnKS5fcmVzdChudWxsLCBudWxsLCBsYXN0USwgbnVsbCwgewoJCQkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJaWYgKCFjcS5lbmFibGVkKCkpIGxvZygiRXhpdGluZyBRdWVyeSBsb29wIik7CgkJCQkJcmV0dXJuIGNxLmVuYWJsZWQoKTsKCQkJCX0sIDAuNSwgbmV3IG9TY29wZS5Db250ZW50KG51bGwsICdHaXRIdWInKS5jb2RlKGNvZGUpKTsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBhdXRob3JpemUuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgYXV0aG9yaXplKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiYXV0aG9yaXplIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuYXV0aG9yaXplJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3VzZXJuYW1lX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnVXNlcm5hbWUgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMiI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3Bhc3N3b3JkX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAyIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnUGFzc3dvcmQgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRob3JpemUnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gYXdhaXQgdGhpcy5fYXV0aG9yaXplKG51bGwsIG51bGwsIHRydWUpCgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJdHJ5IHsKCQkJbGV0IElkID0gdGhpcy5JZDsKCQkJbGV0IGNvbmZpZyA9IHsKCQkJCXVybDogdGhpcy5fX2NvbmZpZyhvcHRpb25zLnVybCB8fCAncmVzdGFwaS51cmwnLCBudWxsLCBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHsKCQkJCQl0TmFtZSwKCQkJCQlfdGhpczogdGhpcy5fdG9Eb2N1bWVudCh0cnVlKQoJCQkJfSkpLAoJCQkJbWV0aG9kOiBtZXRob2QgPyBtZXRob2QgOiAoZGF0YSA/ICJwb3N0IiA6ICJnZXQiKSwKCQkJCXBhcmFtczogcGFyYW1zLAoJCQkJaGVhZGVyczogewoJCQkJCSdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsCgkJCQl9LAoJCQkJZGF0YTogZGF0YSwKCQkJfTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3Jlc3QnLCAnRW50aXR5T2JqZWN0JywgMCwgY29uZmlnKTsKCQkJbGV0IHJldCA9IFtdOwoJCQlpZiAodGhpcy5fX2NvbmZpZygnbGl2ZScsIHRydWUpKSByZXQgPSAoYXdhaXQgdGhpcy5Ub29sLmF4aW9zKGNvbmZpZykpLmRhdGEucmVzdWx0OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcmVzdCcsICdFbnRpdHlPYmplY3QnLCAwLCBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpKTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcmVzdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypVc2VyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJInVzZXJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qVXNlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ1c2VybmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudXNlcm5hbWUodGFibGVbInVzZXJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhc3N3b3JkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5wYXNzd29yZCh0YWJsZVsicGFzc3dvcmQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGVwYXJ0bWVudCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGVwYXJ0bWVudCh0YWJsZVsiZGVwYXJ0bWVudCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJaWYgKCF0aGlzLlRvb2wuZGIgfHwgIXNxbCB8fCAhc3FsLnRyaW0oKSkgewoJCQlpZiAoIXRoaXMuVG9vbC5kYikgdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwsICIgPD09U0tJUFBFRD09PiIpOwoJCQlyZXR1cm4gW107CgkJfQoKCQlpZiAoc3FsLmluZGV4T2YoJztcbicpID4gMCkgewoJCQlmb3IgYXdhaXQgKGNvbnN0IHNxbFMgb2Ygc3FsLnNwbGl0KCc7XG4nKSkgewoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbFMudHJpbSgpKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJbGV0IF9yZXNvbHZlID0gKF9yZXQsIF9zcWwpID0+IHsKCQkJCQlpZiAoX3NxbCAmJiBfc3FsLmluZGV4T2YoJ3NlbGVjdCcpKSB0aGlzLlRvb2wuX19kbWxTdGF0ZW1lbnRzLnB1c2goX3NxbCk7CgkJCQkJcmV0dXJuIHJlc29sdmUoX3JldCk7CgkJCQl9CgoJCQkJbGV0IGRiID0gdGhpcy5Ub29sLmRiOwoJCQkJbGV0IHR5cGUgPSB0aGlzLl9fY29uZmlnKCd0eXBlJyk7CgoJCQkJbGV0IGZ1biA9ICIiOwoKCQkJCS8vIFF1ZXJ5IGxpc3Qgb2Ygc3RhdGVtZW50IHN0YXJ0aW5nIGtleXdvcmRzICAgICAgICAKCQkJCWxldCBxTGlzdCA9IFsic2VsZWN0IiwgImluc2VydCIsICJ1cGRhdGUiLCAiZGVsZXRlIl07CgkJCQlpZiAodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UudHJhbnNhY3Rpb25zJywgdHJ1ZSkpIHsKCQkJCQlxTGlzdCA9IHFMaXN0LmNvbmNhdChbImJlZ2luIiwgInN0YXJ0IiwgImNvbW1pdCJdKTsKCQkJCX0KCQkJCWxldCBiUXVlcnkgPSBxTGlzdC5pbmRleE9mKHNxbC5zdWJzdHJpbmcoMCwgc3FsLmluZGV4T2YoJyAnKSkudHJpbSgpLnRvTG93ZXJDYXNlKCkpID49IDA7CgoJCQkJaWYgKGJRdWVyeSkgewoJCQkJCS8vIHF1ZXJ5CgkJCQkJaWYgKHR5cGUgPT0gJ215c3FsJykgZnVuID0gJ3F1ZXJ5JzsKCQkJCQlpZiAodHlwZSA9PSAnc3FsaXRlJykgZnVuID0gJ2FsbCc7CgkJCQl9IGVsc2UgewoJCQkJCS8vIERNTAoJCQkJCWlmICh0eXBlID09ICdteXNxbCcpIGZ1biA9ICdxdWVyeSc7CgkJCQkJaWYgKHR5cGUgPT0gJ3NxbGl0ZScpIGZ1biA9ICdydW4nOwoKCQkJCQl0aGlzLlRvb2wuZG1sQ2FjaGUgPSB0aGlzLlRvb2wuZG1sQ2FjaGUgfHwge307CgkJCQkJaWYgKHRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldKSByZXR1cm4gX3Jlc29sdmUoMCk7CgkJCQkJdGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0gPSBzcWw7CgkJCQl9CgkJCQlpZiAodHlwZSA9PSAnc3FsaXRlJyAmJiB0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIGZ1biA9ICIiOwoJCQkJaWYgKGZ1biAmJiAhZGJbZnVuXSkgZnVuID0gIiI7CgoJCQkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zcWwnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7dHlwZX0uJHtmdW59YCwgc3FsKTsKCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMucHVzaChzcWwpOwoKCQkJCWlmIChmdW4pIHsKCQkJCQlsZXQgcmV0ID0gZGJbZnVuXShzcWwsIFtdLCAoZXJyb3IsIHJvd3MpID0+IHsKCQkJCQkJaWYgKGVycm9yKSB7CgkJCQkJCQlyZWplY3QoZXJyb3IpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJX3Jlc29sdmUocm93cywgc3FsKTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfSBlbHNlIGlmICh0eXBlID09ICdzbm93Zmxha2UnKSB7CgkJCQkJdGhpcy5Ub29sLmRiLmV4ZWN1dGUoewoJCQkJCQlzcWxUZXh0OiBzcWwsCgkJCQkJCWNvbXBsZXRlOiBmdW5jdGlvbihlcnIsIHN0bXQsIHJvd3MpIHsKCQkJCQkJCWlmIChlcnIpIHsKCQkJCQkJCQlyZWplY3QoZXJyKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJX3Jlc29sdmUocm93cywgc3FsKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQkJfSBlbHNlIGlmICh0eXBlID09ICdzcWxpdGUnKSB7CgkJCQkJLy8gc3FsaXRlIGluIHRoZSBicm93c2VyCgkJCQkJdHJ5IHsKCQkJCQkJbGV0IHJldCA9IG51bGw7CgkJCQkJCXJldCA9IGRiLmV4ZWMoc3FsKTsKCQkJCQkJaWYgKCFyZXQgfHwgIXJldC5sZW5ndGgpIHJldHVybiBfcmVzb2x2ZShyZXQsIHNxbCk7CgoJCQkJCQlyZXQgPSByZXRbMF0udmFsdWVzLm1hcChyID0+IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKHJldFswXS5jb2x1bW5zLm1hcCgoYywgaSkgPT4gW2MsIHJbaV1dKSkpKTsKCQkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCQkJCQlfcmVzb2x2ZShyZXQsIHNxbCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJcmVqZWN0KGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zcWwnLCAnRW50aXR5T2JqZWN0JywgMiwgYApFUlJPUjoKJHtleH0KCldoaWxlIFNlbmRpbmcgUXVlcnkgCiR7c3FsfQpgKTsKCQl9CgoJCS8vdGhpcyBpcyBub3QgZW5vdWdoLiBXZSBzZWxlY3Qgb3V0ZXIgam9pbnMsIHNvIHN1Yi1hdHRyaWJ1dGVzIHdpbGwgYmUgYWxzbyBudWxsLiBFaXRoZXIgcmVjdXJzaXZlIG9yIHRvIGlnbm9yZSB3aGVuIHVzZWQsIGZvciBleGFtcGxlIHRocm91Z2ggX3RvRG9jdW1lbnQKCQlmYWxzZSAmJiByZXQuZm9yRWFjaChyID0+IHsKCQkJT2JqZWN0LmtleXMocikuZm9yRWFjaChrID0+IHsKCQkJCWlmIChyW2tdID09IG51bGwpIGRlbGV0ZSByW2tdOwoJCQl9KTsKCQl9KTsKCgkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOwoJCXJldHVybiByZXQ7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSB7CgoJCXRyeSB7CgkJCXJldHVybiBgc2FsZXNub3cvJHtfY2xhc3N9LyR7b2JqW2VhQ29kZV19LmpzYDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZmlsZU5hbWUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXRyeSB7CgkJCS8vIFRvRG86IHVzZSBfcmVzdCgpIGluc3RlYWQKCQkJbGV0IGNvbmZpZyA9IHsKCQkJCW1ldGhvZDogY29udGVudCA/ICdwdXQnIDogJ2dldCcsCgkJCQl1cmw6IHRoaXMuX19jb25maWcoJ3VybCcpICsgZmlsZSwKCQkJCWhlYWRlcnM6IHsKCQkJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL3ZuZC5naXRodWIranNvbicsCgkJCQkJJ1gtR2l0SHViLUFwaS1WZXJzaW9uJzogJzIwMjItMTEtMjgnLAoJCQkJfSwKCQkJfTsKCQkJaWYgKGNvbnRlbnQpIHsKCQkJCS8vIGZpcnN0IGdldCB0aGUgc2hhIG9mIHRoZSBmaWxlCgkJCQljb25maWcuZGF0YSA9IEpTT04uc3RyaW5naWZ5KHsKCQkJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgX2dpdGh1YigpIiwKCQkJCQlzaGE6IGNvbnRlbnRbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoJCQkJCWNvbnRlbnQ6IGAke3RoaXMuX2J0b2EodHlwZW9mKGNvbnRlbnQpPT09J29iamVjdCc/SlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgJ1x0Jyk6Y29udGVudCl9YCwKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJY29uZmlnLnZhbGlkYXRlU3RhdHVzID0gc3RhdHVzID0+IHN0YXR1cyA8IDUwMDsKCQkJfQoJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmF4aW9zKGNvbmZpZyk7CgkJCXJldCA9IHJldCA/IHJldC5kYXRhIDogbnVsbDsKCQkJaWYgKCFyZXQpIHJldHVybiByZXQ7CgoJCQlyZXQgPSBjb250ZW50ID8gcmV0LmNvbnRlbnQgOiByZXQ7CgkJCWxldCBfdGhpcyA9IHJldC5jb250ZW50ID8gSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSkgOiB7fTsKCQkJX3RoaXNbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gcmV0LnNoYTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19naXRodWInLCAnRW50aXR5T2JqZWN0JywgMCwgZmlsZSwgY29uZmlnLm1ldGhvZCwgX3RoaXMpOwoJCQlyZXR1cm4gX3RoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2dpdGh1YicsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcGFzc3dvcmQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0RlcGFydG1lbnQnLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdEZXBhcnRtZW50JywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXBhc3N3b3JkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJ1c2VybmFtZSIsIG9iaiwgdGhpcy51c2VybmFtZSgpKTsKCgkJX29wdGlvbnMoInBhc3N3b3JkIiwgb2JqLCB0aGlzLnBhc3N3b3JkKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjcwZmExNzJkLTM3NGItNDI5NS05NWUyLWMzMzVhM2QxZGVhMiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmRlcGFydG1lbnQoKSB8fCAodGhpcy5kZXBhcnRtZW50KCkKCgkJCQkmJgoJCQkJIXRoaXMuZGVwYXJ0bWVudCgpLmRlcGFydG1lbnRfVXNlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImRlcGFydG1lbnQiLCBvYmosIHRoaXMuZGVwYXJ0bWVudCgpKTsKCQl9CgoJCV9vcHRpb25zKCJtYW5hZ2VyX0RlcGFydG1lbnRzIiwgb2JqLCB0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSk7CgoJCV9vcHRpb25zKCJjYWxsZXJfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSk7CgoJCV9vcHRpb25zKCJjb250YWN0X0luY2lkZW50cyIsIG9iaiwgdGhpcy5jb250YWN0X0luY2lkZW50cygpKTsKCgkJX29wdGlvbnMoInVzZXJfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJywgJ2RlcGFydG1lbnQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnY2FsbGVyX0luY2lkZW50cycsICdjb250YWN0X0luY2lkZW50cycsICd1c2VyX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygidXNlcm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicGFzc3dvcmQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3MGZhMTcyZC0zNzRiLTQyOTUtOTVlMi1jMzM1YTNkMWRlYTIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImRlcGFydG1lbnQiLCBvYmopOwoKCQlfb3B0aW9ucygibWFuYWdlcl9EZXBhcnRtZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJjYWxsZXJfSW5jaWRlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvbnRhY3RfSW5jaWRlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoInVzZXJfR3JvdXBfTWVtYmVycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJywgJ2RlcGFydG1lbnQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnY2FsbGVyX0luY2lkZW50cycsICdjb250YWN0X0luY2lkZW50cycsICd1c2VyX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3VzZXJuYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnVzZXJuYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhc3N3b3JkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3Bhc3N3b3JkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnBhc3N3b3JkKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRlcGFydG1lbnQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGVwYXJ0bWVudCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudXNlcm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnBhc3N3b3JkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kZXBhcnRtZW50KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCXVzZXJuYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy51c2VybmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXBhc3N3b3JkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wYXNzd29yZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRlcGFydG1lbnQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGVwYXJ0bWVudChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJLy8gTnVsbDogdHJ1ZSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy51c2VybmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudXNlcm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBhc3N3b3JkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wYXNzd29yZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGVwYXJ0bWVudCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGVwYXJ0bWVudH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQl1c2VybmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VybmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX3VzZXJuYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl91c2VybmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fdXNlcm5hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl91c2VybmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fdXNlcm5hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXBhc3N3b3JkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Bhc3N3b3JkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fcGFzc3dvcmRfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3Bhc3N3b3JkX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9wYXNzd29yZF9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX3Bhc3N3b3JkX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9wYXNzd29yZF9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RlcGFydG1lbnRfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9kZXBhcnRtZW50X2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJtYW5hZ2VyLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qbWFuYWdlcl9EZXBhcnRtZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJjYWxsZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypjYWxsZXJfSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNvbnRhY3QuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNvbnRhY3RfSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgidXNlci5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyp1c2VyX0dyb3VwX01lbWJlcnMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXJuYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudXNlcm5hbWV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucGFzc3dvcmQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5wYXNzd29yZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kZXBhcnRtZW50KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRlcGFydG1lbnR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZGVwYXJ0bWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiBvYmouZGVwYXJ0bWVudCA9IHYuX3RvUGF0aHMoKSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLm1hbmFnZXJfRGVwYXJ0bWVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouY2FsbGVyX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNvbnRhY3RfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnVzZXJfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlVzZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVXNlciA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuVXNlcigpCgoJCQkJCS5kZXBhcnRtZW50KG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkpCgoJCQkJCS5tYW5hZ2VyX0RlcGFydG1lbnRzKG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkpCgoJCQkJCS5jYWxsZXJfSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuY29udGFjdF9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS51c2VyX0dyb3VwX01lbWJlcnMobmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJdHJ5IHsKCQkJaWYgKCF0b29sKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIlRvb2wgaXMgbnVsbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCF0b29sLnR5cGUpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiVG9vbC50eXBlIGlzIG51bGwiLCB0b29sLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJCXJldHVybjsKCQkJfSBlbHNlIGlmICh0eXBlb2YodG9vbC5kYikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgIlRvb2wgYWxyZWFkeSBjb25uZWN0ZWQhIik7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoc2FsZXNub3cuX25vZGUgJiYgLypzYWxlc25vdy5fbm9kZS5fcGFyZW50X3NldCAmJiAqLyBzYWxlc25vdy5fbm9kZS5wYXJlbnQoKS5fc2FtZU5vZGUoc2FsZXNub3cuX25vZGUucGFyZW50KCkpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vZGUgaGFzIGEgdmFsaWQgcGFyZW50LCBubyBsb2NhbCBTUUwgcG9zc2libGUiKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJdG9vbC5fX2RtbFN0YXRlbWVudHMgPSB0b29sLl9fZG1sU3RhdGVtZW50cyB8fCBbXTsKCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJdG9vbDogdG9vbAoJCQkJCX0pXSkgewoJCQkJCWlmIChnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSldLkRhdGFiYXNlKSB7CgkJCQkJCXRvb2wuZGIgPSBuZXcgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB0b29sKV0uRGF0YWJhc2UodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0b29sCgkJCQkJCX0pIHx8ICIuL3NhbGVzbm93LmRiIik7CgkJCQkJfSBlbHNlIGlmIChnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSldLmNyZWF0ZUNvbm5lY3Rpb24pIHsKCQkJCQkJdG9vbC5kYiA9IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQl9KV0uY3JlYXRlQ29ubmVjdGlvbih7CgkJCQkJCQlob3N0OiB0aGlzLl9fY29uZmlnKCdzZXJ2ZXInLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQkJfSksCgkJCQkJCQl1c2VyOiB0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSwKCQkJCQkJCXBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSwKCQkJCQkJCWRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSB8fCAic2FsZXNub3ciLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyAmJiB0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQl0b29sOiB0b29sCgkJCQkJfSkgPT09ICdzcWxpdGUnKSB7CgkJCQkJLy8gc3FsaXRlIGluIGJyb3dzZXIKCQkJCQl0b29sLmRiID0gbmV3IFNRTC5EYXRhYmFzZSgpOwoJCQkJfQoKCQkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsKCQkJfQoKCQkJaWYgKHRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCWlmICh0eXBlb2YodG9vbC5zeXNfc2NvcGUpID09PSAidW5kZWZpbmVkIikgewoJCQkJCS8vIHRvb2wuc3lzX3Njb3BlID0gKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19hcHAiLCB7c3lzX3Njb3BlOiB0aGlzLl9fY29uZmlnKCJzY29wZSIsIG51bGwsIHt0b29sOiB0b29sfSkgfHwgImdsb2JhbCJ9KSlbMF0uc3lzX2lkOwoJCQkJfQoJCQkJaWYgKHR5cGVvZih0b29sLnN5c19wcm9wZXJ0aWVzKSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkvLyBsb2FkaW5nIHNvbWUgcGxhdGZvcm0gc3R1ZmYKCQkJCQl0b29sLnN5c19wcm9wZXJ0aWVzID0ge307CgkJCQkJbGV0IGNvbmRpdGlvbiA9IE9iamVjdC5rZXlzKHRvb2wuc3lzX3Byb3BlcnRpZXMpLmZpbHRlcihrID0+ICF0b29sLnN5c19wcm9wZXJ0aWVzW2tdKS5qb2luKCcsJyk7CgkJCQkJaWYgKGNvbmRpdGlvbikgewoJCQkJCQkoYXdhaXQgdGhpcy5fcmVzdCgic3lzX3Byb3BlcnRpZXMiLCB7CgkJCQkJCQluYW1lOiAiSU4iICsgY29uZGl0aW9uCgkJCQkJCX0pKS5mb3JFYWNoKHIgPT4gdG9vbC5zeXNfcHJvcGVydGllc1tyLm5hbWVdID0gci52YWx1ZSk7CgkJCQkJfQoJCQkJfQoKCQkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsKCQkJfQoKCQkJaWYgKHRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsKCQkJfQoKCQkJaWYgKHRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlVzZXIiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJdXNlcm5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnVzZXJuYW1lID0gdiA9PSBxdWVyeS51c2VybmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl91c2VybmFtZV9zZXQgJiYgIXF1ZXJ5Ll91c2VybmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlcm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdXNlcm5hbWVfc2V0ICYmIHF1ZXJ5Ll91c2VybmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXJuYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBhc3N3b3JkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wYXNzd29yZCA9IHYgPT0gcXVlcnkucGFzc3dvcmQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGFzc3dvcmRfc2V0ICYmICFxdWVyeS5fcGFzc3dvcmRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhc3N3b3JkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3Bhc3N3b3JkX3NldCAmJiBxdWVyeS5fcGFzc3dvcmRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXNzd29yZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkZXBhcnRtZW50OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kZXBhcnRtZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5kZXBhcnRtZW50KCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmICFxdWVyeS5fZGVwYXJ0bWVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGVwYXJ0bWVudCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kZXBhcnRtZW50X3NldCAmJiBxdWVyeS5fZGVwYXJ0bWVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5kZXBhcnRtZW50KCkgJiYgIXRoaXMuZGVwYXJ0bWVudCgpLl9tYXRjaGVzKHF1ZXJ5LmRlcGFydG1lbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRlcGFydG1lbnQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5Lm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhbGxlcl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5jYWxsZXJfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5jb250YWN0X0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai51c2VyX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS51c2VyX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBkZXBhcnRtZW50Iik7CgkJCQkJb2JqLmRlcGFydG1lbnQgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm1hbmFnZXJfRGVwYXJ0bWVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2FsbGVyX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai51c2VyX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX3VzZXJuYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Bhc3N3b3JkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RlcGFydG1lbnRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlkZXBhcnRtZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZGVwYXJ0bWVudChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jb250YWN0X0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl1c2VybmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSA6ICJ1c2VybmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl91c2VybmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudXNlcm5hbWUocmVmKTsKCgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSA6ICJwYXNzd29yZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXNzd29yZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucGFzc3dvcmQocmVmKTsKCgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmRlcGFydG1lbnQoKSB8fCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZGVwYXJ0bWVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGRlcGFydG1lbnQiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY2FsbGVyX0luY2lkZW50cyIpKSA9PiB0aGlzLmNhbGxlcl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpIDogImNvbnRhY3RfSW5jaWRlbnRzIikpID0+IHRoaXMuY29udGFjdF9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJ1c2VyX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy51c2VyX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkgOiAidXNlcm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdXNlcm5hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFzc3dvcmQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpIDogInBhc3N3b3JkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3Bhc3N3b3JkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogImNhbGxlcl9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjb250YWN0X0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogInVzZXJfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKGZ1biwgY2FsbEJhY2spID0+IHsKCQkJCWlmICh0aGlzLnNfRXJyb3JNZXNzYWdlcyAmJiB0aGlzLnNfRXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKSB7CgkJCQkJYWxlcnQoCgkJCQkJCSdUaGUgZm9sbG93aW5nIGVycm9ycyB3ZXJlIGZvdW5kIGluIHlvdXIgZGF0YTpcbicgKwoJCQkJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcwoJCQkJCSk7CgkJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgPSAnJzsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQl0aGlzLmJ1aWxkVVJMKCk7CgoJCQkJaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICJ1bmRlZmluZWQiKSgKCQkJCQl0aGlzLmZMb2FkaW5nU3RhcnQgfHwKCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJaWYgKGRvY3VtZW50LmJvZHkpIGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3dhaXQnOwoJCQkJCX0KCQkJCSkoKTsKCgkJCQl2YXIgYXJncyA9IEFycmF5KCk7CgkJCQlmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJCWFyZ3NbaSAtIDJdID0gYXJndW1lbnRzW2ldOwoJCQkJfQoKCQkJCXZhciBwb3N0RGF0YSA9IHRoaXMucGFyYW0oYXJncyk7CgkJCQlpZiAoZnVuLmluZGV4T2YoJy4nKSA8IDApIHsKCQkJCQlmdW4gPSB0aGlzLnN5c3RlbU5hbWUgKyAnLicgKyBmdW47CgkJCQl9IGVsc2UgaWYgKGZ1bi5pbmRleE9mKCcuJykgPT0gMCkgewoJCQkJCS8vIGEgbm9uLWxheWVyIG1ldGhvZAoJCQkJCWZ1biA9IGZ1bi5zdWJzdHJpbmcoMSk7CgkJCQl9CgoJCQkJaWYgKGNhbGxCYWNrICYmIHRoaXMuQWN0aXZlUmVxdWVzdCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJLy9yZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIGhDb2RlID0gdGhpcy5oYXNoQ29kZSgKCQkJCQlmdW4uc3Vic3RyaW5nKGZ1bi5pbmRleE9mKCcuJykgKyAxKSArIHBvc3REYXRhCgkJCQkpOwoKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJcG9zdERhdGEgKz0KCQkJCQl0aGlzLkNSTkwgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJzwhLS08cGlkPicgKwoJCQkJCWhDb2RlICsKCQkJCQknPC9waWQ+LS0+JyArCgkJCQkJdGhpcy5DUk5MOwoKCQkJCWlmIChmdW4uaW5kZXhPZignY21zTWV0aG9kUmVzdWx0RmluZCcpIDwgMCkgewoJCQkJCS8vIGF2b2lkIG92ZXJ3cml0ZSBvZiBhc3luYyBjYWxscwoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IHsKCQkJCQkJVVJMOiB0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJCVBvc3REYXRhOiBwb3N0RGF0YSwKCQkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJQ2FsbEJhY2s6IGNhbGxCYWNrLAoJCQkJCQlDb21wYW55OiB0eXBlb2YgY29tcGFueSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueSA/IHsKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZSwKCQkJCQkJfSA6IG51bGwsCgkJCQkJCVRleHRSZXNwb25zZTogbnVsbCwKCQkJCQkJaGFzaDogaENvZGUsCgkJCQkJfTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF0aGlzLmJMb2NhbCkgewoJCQkJCS8vIGxpdmUKCQkJCQl0cnkgewoJCQkJCQl2YXIgX3RoZVVybCA9CgkJCQkJCQkodGhpcy5TdG9yZSB8fAoJCQkJCQkJCScvc3RvcmUvJyArCgkJCQkJCQkJKHdpbmRvdy5jb21wYW55ICYmIHdpbmRvdy5jb21wYW55LkNvZGUgPwoJCQkJCQkJCQl3aW5kb3cuY29tcGFueS5Db2RlICsgJy8nIDoKCQkJCQkJCQkJJy8nKSkgKwoJCQkJCQkJaENvZGUgKwoJCQkJCQkJJy5qcz9yYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKTsKCQkJCQkJbGV0IHJlcXVlc3QgPSBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KCk7CgkJCQkJCXZhciByZXNwb25zZVRleHQgPSBudWxsOwoJCQkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQkJCXRyeSB7CgkJCQkJCQkJcmVzcG9uc2VUZXh0ID0gYXdhaXQgJC5nZXQoX3RoZVVybCk7CgkJCQkJCQl9IGNhdGNoIChleCkge30KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJlc3BvbnNlVGV4dCA9IHJlcXVlc3QuVGV4dFJlc3BvbnNlOwoJCQkJCQl9CgkJCQkJCWlmICghcmVzcG9uc2VUZXh0KSB7CgkJCQkJCQljb25zb2xlLmxvZygKCQkJCQkJCQknTGl2ZSBNb2RlLCBubyByZXNwb25zZSB0ZXh0IGZvciAnICsKCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuaGFzaCArCgkJCQkJCQkJJyAtICcgKwoJCQkJCQkJCXRoaXMuJF9SRVFVRVNUKCduYW1lJywgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCkKCQkJCQkJCSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJdmFyIF9yZXQgPSBudWxsOwoJCQkJCQl2YXIgX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCQkJX2V4Y2VwdGlvbiA9IF9yZXQuX2V4Y2VwdGlvbjsKCQkJCQkJCWlmIChfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJCQlnbG9iYWwudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCV9leGNlcHRpb24gPSBlOwoJCQkJCQl9CgoJCQkJCQlpZiAoIV9yZXQgJiYgIV9leGNlcHRpb24pIHsKCQkJCQkJCXJldHVybiBhd2FpdCBudWxsOyAvL3RoaXMuZG9IZWFkbGVzc0NhbGwoY2FsbEJhY2spOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy90aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQljYWxsQmFjaygKCQkJCQkJCQkJCV9yZXQucmV0IHx8IChfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCksCgkJCQkJCQkJCQlfZXhjZXB0aW9uCgkJCQkJCQkJCSk7CgkJCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJCQkJCSdFcnJvciBpbiBDYWxsYmFjazpcblxuJyArCgkJCQkJCQkJCQljYWxsQmFjayArCgkJCQkJCQkJCQknXG5cbicgKwoJCQkJCQkJCQkJZS5tZXNzYWdlCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJKAoJCQkJCQkJCXdpbmRvdy5zci5mTG9hZGluZ0VuZCB8fAoJCQkJCQkJCSgoKSA9PiB7CgkJCQkJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJCQl9KQoJCQkJCQkJKSgpOwoJCQkJCQkJcmV0dXJuICgKCQkJCQkJCQkoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwKCQkJCQkJCQkoX2V4Y2VwdGlvbiA/IHJlc3BvbnNlVGV4dCA6IG51bGwpCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQljb25zb2xlLmxvZyhlKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIChhc3luYyAoKSA9PiB7CgkJCQkJCS8qdHJ5IHsKCQkJCQkJCWxldCBzY29wZSA9IGZ1bi5zcGxpdCgnLicpWzBdLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMSAkMicpLnJlcGxhY2UoJyAnLCAnJykudG9Mb3dlckNhc2UoKTsKCQkJCQkJCWxldCBhcGkgPSBmdW4uc3BsaXQoJy4nKVsxXS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDEgJDInKS5zcGxpdCgnICcpLnNsaWNlKDEsIC0xKS5qb2luKCcnKS5yZXBsYWNlKCcgJywgJycpOwoJCQkJCQkJbGV0IGZOYW1lID0gZnVuLnNwbGl0KCcuJylbMV0ucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxICQyJykuc3BsaXQoJyAnKS5zbGljZSgtMSlbMF0udG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdmaW5kYWxsJywgJ2ZpbmRBbGwnKTsKCQkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93W3Njb3BlXSAmJiBbJ2luc2VydCcsICdkZWxldGUnLCAndXBkYXRlJywgJ2ZpbmQnLCAnZmluZEFsbCddLmluZGV4T2YoZk5hbWUpID4gLTEpIHsKCQkJCQkJCQlsZXQgc0NhbGwgPSBgYXdhaXQgbmV3ICR7c2NvcGV9LiR7YXBpfSgpLiR7Zk5hbWV9KC4uLmFyZ3MpYDsKCQkJCQkJCQlsZXQgbyA9IG5ldyB3aW5kb3dbc2NvcGVdW2FwaV0oKTsKCQkJCQkJCQlPYmplY3Qua2V5cyhhcmdzWzBdKS5maWx0ZXIoayA9PiBrICE9PSAiT1BFUkFUT1JTIikuZm9yRWFjaChrID0+IHsKCQkJCQkJCQkJb1trLnJlcGxhY2UoLyg/Ol5cd3xbQS1aXXxcYlx3fFxzKykvZywgKG1hdGNoLCBpbmRleCkgPT4gewoJCQkJCQkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCQkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQkJCQkJCX0pXShhcmdzWzBdW2tdLCBhcmdzWzBdLk9QRVJBVE9SUz8uW2tdKTsKCQkJCQkJCQl9KTsKCQkJCQkJCQljb25zb2xlLmxvZyhzQ2FsbCwgby5fdG9Eb2N1bWVudCgpLCBhcmdzKTsKCQkJCQkJCQkvL3JldHVybiBhd2FpdCBvW2ZOYW1lXSgpOwoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coIl8oKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCQkJCX0qLwoKCQkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFhNTCgKCQkJCQkJCXRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCQkJCXBvc3REYXRhLAoJCQkJCQkJY2FsbEJhY2sKCQkJCQkJKTsKCQkJCQl9KSgpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoc3JVUkwpID0+IHsKCQkJCWlmICghc3JVUkwpIHsKCQkJCQl0aGlzLnNyVVJMID0gdGhpcy4kX1JFUVVFU1QoJ3NyJyk7CgkJCQkJaWYgKCF0aGlzLnNyVVJMKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCWxldCBpcCA9IHRoaXMuaXBBZGRyZXNzKCk7CgkJCQkJCQlpZiAoaXAgJiYgKGlwLnN0YXJ0c1dpdGgoIjE4Mi4xNjguIikgfHwgaXAgPT0gIjE5Mi4xNjguMS4yNTMiIHx8IGlwID09ICcxOTUuMTEyLjIxNS4yMTgnKSkgewoJCQkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovLzE4Mi4xNjguNzAuODAiOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQl0aGlzLnNyVVJMID0gImh0dHA6Ly9hcnoubmFtbW91ci5jb206NzA4MCI7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJdGhpcy5zclVSTCArPSAnL21ldGhvZC9TZXJ2aWNlUm91dGVyLmFzaHgnOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zclVSTCA9IHNyVVJMOwoJCQkJfQoJCQkJdGhpcy5zclVSTCArPSAnP3NydmVyc2lvbj0xJzsKCQkJCWlmICh0aGlzLiRfUkVRVUVTVCgnZ3ppcCcpKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9JyArIHRoaXMuJF9SRVFVRVNUKCdnemlwJyk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZnemlwPXRydWUnOwoJCQkJfQoJCQkJaWYgKHRoaXMuYkNhY2hlKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmNhY2hlPScgKyB0aGlzLmJDYWNoZTsKCQkJCX0KCQkJCWlmICghdGhpcy4kX1JFUVVFU1QoJ3JhbmQnLCB0aGlzLnNyVVJMKSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZyYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQkJfQoKCQkJCWlmICh0aGlzLmJEZWJ1ZykgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZERUJVRz10cnVlJzsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGhpcy5iQXN5bmMgJiYKCQkJCQl0aGlzLmJMb2NhbCAmJgoJCQkJCSF0aGlzLiRfUkVRVUVTVCgnYXN5bmMnLCB0aGlzLnNyVVJMKQoJCQkJKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmFzeW5jPXRydWUnOwoJCQkJCWlmICh0aGlzLnJ1bkFmdGVyKSB7CgkJCQkJCXRoaXMuc3JVUkwgKz0gJyZydW5hZnRlcj0nICsgdGhpcy5ydW5BZnRlcjsKCQkJCQl9CgkJCQkJdGhpcy5iQXN5bmMgPSBmYWxzZTsKCQkJCX0KCgkJCQkvL3RoaXMuU2hvd0RlYnVnKCd0aGlzLnNyVVJMPScgKyB0aGlzLnNyVVJMKTsKCgkJCQlyZXR1cm4gdGhpcy5zclVSTDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChrZXksIHVybCkgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgoJCQkJbGV0IHJldCA9IHVuZGVmaW5lZDsKCQkJCWlmICh1cmwpIHsKCQkJCQl0cnkgewoJCQkJCQlyZXQgPSBuZXcgVVJMKHVybCkuc2VhcmNoUGFyYW1zLmdldChrZXkpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1tcXD98Jl0nICsga2V5ICsgJz0oW14mI10qKScpOwoJCQkJCQl2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMoJz8nICsgdXJsLnNwbGl0KCc/JylbMV0pOwoJCQkJCQlyZXQgPSAocmVzdWx0cyA9PT0gbnVsbCkgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICcgJykpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoa2V5KTsKCQkJCX0KCgkJCQlyZXR1cm4gcmV0ID09PSBudWxsID8gJycgOiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGFyZ3MpID0+IHsKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJdmFyIHJldCA9CgkJCQkJJy8qJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknPCFbQ0RBVEFbJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknUEFSQU1FVEVSUycgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJ11dPicgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJyovJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSc8cD4nICsKCQkJCQl0aGlzLkNSTkw7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl2YXIgeG1sID0gdGhpcy5fdG9YTUwoYXJnc1tpXSk7CgkJCQkJaWYgKGZhbHNlKSB7CgkJCQkJCS8vIHhtbCBjb250YWlucyBjaGFyYWN0ZXJzIHRoYXQgd291bGQgbm90IGFycml2ZSBwcm9wZXJseSBhbmQgc2hvdWxkIGJlIGNvbnZlcnRlZCB0byBiYXNlNjQKCQkJCQkJeG1sID0gYnRvYSh4bWwpOwoJCQkJCX0KCQkJCQlyZXQgKz0gJzxwJyArIGkgKyAnPicgKyB0aGlzLkNSTkwgKyB4bWwgKyAnJyArIHRoaXMuQ1JOTDsKCQkJCQlyZXQgKz0gJzwvcCcgKyBpICsgJz4nICsgdGhpcy5DUk5MOwoJCQkJfQoJCQkJcmV0ICs9ICc8L3A+JyArIHRoaXMuQ1JOTDsKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbGV2ZWwpID0+IHsKCQkJCWlmICghbGV2ZWwpIGxldmVsID0gMDsKCQkJCXZhciBzID0gJyc7CgkJCQlpZiAobyA9PSBudWxsKSByZXR1cm4gczsKCQkJCXN3aXRjaCAodHlwZW9mIG8pIHsKCQkJCQljYXNlICdzdHJpbmcnOgoJCQkJCQlzICs9ICc8IVtDREFUQVsnICsgbyArICddXT4nOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICdudW1iZXInOgoJCQkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQkJCQlzICs9IG8udG9TdHJpbmcoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnb2JqZWN0JzoKCQkJCQkJLy8gRGF0ZQoJCQkJCQlpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSAmJgoJCQkJCQkJby5jb25zdHJ1Y3Rvci5uYW1lID09ICJEYXRlIgoJCQkJCQkpIHsKCQkJCQkJCXZhciB5ZWFyID0gby5nZXRVVENGdWxsWWVhcigpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgbW9udGggPSAoby5nZXRVVENNb250aCgpICsgMSkudG9TdHJpbmcoKTsKCQkJCQkJCW1vbnRoID0gbW9udGgubGVuZ3RoID09IDEgPyAnMCcgKyBtb250aCA6IG1vbnRoOwoJCQkJCQkJdmFyIGRhdGUgPSBvLmdldFVUQ0RhdGUoKS50b1N0cmluZygpOwoJCQkJCQkJZGF0ZSA9IGRhdGUubGVuZ3RoID09IDEgPyAnMCcgKyBkYXRlIDogZGF0ZTsKCQkJCQkJCXZhciBob3VycyA9IG8uZ2V0VVRDSG91cnMoKS50b1N0cmluZygpOwoJCQkJCQkJaG91cnMgPSBob3Vycy5sZW5ndGggPT0gMSA/ICcwJyArIGhvdXJzIDogaG91cnM7CgkJCQkJCQl2YXIgbWludXRlcyA9IG8uZ2V0VVRDTWludXRlcygpLnRvU3RyaW5nKCk7CgkJCQkJCQltaW51dGVzID0gbWludXRlcy5sZW5ndGggPT0gMSA/ICcwJyArIG1pbnV0ZXMgOiBtaW51dGVzOwoJCQkJCQkJdmFyIHNlY29uZHMgPSBvLmdldFVUQ1NlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCQkJc2Vjb25kcyA9IHNlY29uZHMubGVuZ3RoID09IDEgPyAnMCcgKyBzZWNvbmRzIDogc2Vjb25kczsKCQkJCQkJCXZhciBtaWxsaXNlY29uZHMgPSBvLmdldFVUQ01pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgdHptaW51dGVzID0gTWF0aC5hYnMoby5nZXRUaW1lem9uZU9mZnNldCgpKTsKCQkJCQkJCXZhciB0emhvdXJzID0gMDsKCQkJCQkJCXdoaWxlICh0em1pbnV0ZXMgPj0gNjApIHsKCQkJCQkJCQl0emhvdXJzKys7CgkJCQkJCQkJdHptaW51dGVzIC09IDYwOwoJCQkJCQkJfQoJCQkJCQkJdHptaW51dGVzID0KCQkJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCQkJJzAnICsgdHptaW51dGVzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6bWludXRlcy50b1N0cmluZygpOwoJCQkJCQkJdHpob3VycyA9CgkJCQkJCQkJdHpob3Vycy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJCQknMCcgKyB0emhvdXJzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6aG91cnMudG9TdHJpbmcoKTsKCQkJCQkJCXZhciB0aW1lem9uZSA9CgkJCQkJCQkJKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSA8IDAgPyAnKycgOiAnLScpICsKCQkJCQkJCQl0emhvdXJzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXR6bWludXRlczsKCQkJCQkJCS8vcyArPSB5ZWFyICsgIi0iICsgbW9udGggKyAiLSIgKyBkYXRlICsgIlQiICsgaG91cnMgKyAiOiIgKyBtaW51dGVzICsgIjoiICsgc2Vjb25kcyArICIuIiArIG1pbGxpc2Vjb25kcyArIHRpbWV6b25lOwoJCQkJCQkJcyArPQoJCQkJCQkJCW1vbnRoICsKCQkJCQkJCQknLycgKwoJCQkJCQkJCWRhdGUgKwoJCQkJCQkJCScvJyArCgkJCQkJCQkJeWVhciArCgkJCQkJCQkJJyAnICsKCQkJCQkJCQlob3VycyArCgkJCQkJCQkJJzonICsKCQkJCQkJCQltaW51dGVzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXNlY29uZHM7CgkJCQkJCX0KCQkJCQkJLy8gQXJyYXkKCQkJCQkJZWxzZSBpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEKCQkJCQkJKSB7CgkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJCQlzICs9ICc8T2JqZWN0Pic7CgkJCQkJCQkJaWYgKCFpc05hTihwKSkgewoJCQkJCQkJCQkvLyBsaW5lYXIgYXJyYXkKCQkJCQkJCQkJaWYgKG9bcF0gPT0gbnVsbCkgewoJCQkJCQkJCQkJLy8gbnVsbCBlbnRyeSBpbiB0aGUgYXJyYXkKCQkJCQkJCQkJCXMgKz0gJzxJZD4wPC9JZD4nOwoJCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkJL2Z1bmN0aW9uXHMrKFx3KilccypcKC9naS5leGVjKAoJCQkJCQkJCQkJCW9bcF0uY29uc3RydWN0b3IudG9TdHJpbmcoKQoJCQkJCQkJCQkJKTsKCQkJCQkJCQkJCXZhciB0eXBlID0gUmVnRXhwLiQxOwoJCQkJCQkJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJCQkJCQkJY2FzZSAnJzoKCQkJCQkJCQkJCQkJdHlwZSA9IHR5cGVvZiBvW3BdOwoJCQkJCQkJCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnc3RyaW5nJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnTnVtYmVyJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdpbnQnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCQljYXNlICdCb29sZWFuJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdib29sJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnRGF0ZSc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnRGF0ZVRpbWUnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCXMgKz0gdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKyk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBhc3NvY2lhdGl2ZSBhcnJheQoJCQkJCQkJCQlzICs9CgkJCQkJCQkJCQknPCcgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQl0aGlzLmNvb3AobywgcCkgKwoJCQkJCQkJCQkJJz4nICsKCQkJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQkJCSc8LycgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQknPic7CgkJCQkJCQkJfQoJCQkJCQkJCXMgKz0gJzwvT2JqZWN0PicgKyB0aGlzLkNSTkw7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJLy8gT2JqZWN0IG9yIGN1c3RvbSBmdW5jdGlvbgoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChvID09IG51bGwgfHwgby5JZCA9PSAwKSB7fSBlbHNlIGlmIChmYWxzZSAmJiBvLklkKSB7CgkJCQkJCQkJLy8gdGhpcyBpcyBjcmVhdGluZyBhIHByb2JsZW0sIGJldHRlciBzZW5kIGFsbCB0aGUgb2JqZWN0CgkJCQkJCQkJLy8gZG8gbm90IHNlbmQgb3RoZXIgZGF0YSBpZiB3ZSBoYXZlIGEgdmFsdWUgZm9yIHRoZSBJZAoJCQkJCQkJCXMgKz0gJzxJZD4nICsgdGhpcy5fdG9YTUwoby5JZCwgbGV2ZWwrKykgKyAnPC9JZD4nOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQkJaWYgKHAgPT0gJ09QRVJBVE9SUycgfHwgcCA9PSAnT1JTJykgY29udGludWU7CgkJCQkJCQkJCXMgKz0KCQkJCQkJCQkJCSc8JyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJCQl0aGlzLk9SKG8sIHApICsKCQkJCQkJCQkJCSc+JyArCgkJCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJCQknPC8nICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJJz4nOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCQkJCXJldHVybiBzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBwKSA9PiB7CgkJCQlpZiAoIW8uT1BFUkFUT1JTIHx8ICFvLk9QRVJBVE9SU1twXSkgewoJCQkJCXJldHVybiAnJzsKCQkJCX0KCQkJCXJldHVybiAoCgkJCQkJIiBjb29wPSciICsKCQkJCQl0aGlzLm15UmVwbGFjZShvLk9QRVJBVE9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkJCSInIgoJCQkJKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIHApID0+IHsKCQkJCXJldHVybiBvLk9SUyAmJiBvLk9SU1twXSA/CgkJCQkJIiBPUj0nIiArCgkJCQkJdGhpcy5teVJlcGxhY2Uoby5PUlNbcF0sIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pICsKCQkJCQkiJyIgOgoJCQkJCScnOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGZjLCByYykgPT4gewoJCQkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCQkJdmFyIHJldCA9ICcnOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIHJzID0gcy5jaGFyQXQoaSk7CgkJCQkJZm9yICh2YXIgaiA9IDA7IGogPCBmYy5sZW5ndGg7IGorKykgewoJCQkJCQlpZiAocy5jaGFyQXQoaSkgPT0gZmNbal0pIHsKCQkJCQkJCXJzID0gcy5jaGFyQXQoaSkucmVwbGFjZShmY1tqXSwgcmNbal0pOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldCArPSByczsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHVybCwgcG9zdERhdGEsIGNhbGxCYWNrKSA9PiB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF3aW5kb3cuU1IpIHdpbmRvdy5TUiA9IHRoaXM7CgoJCQkJaWYgKCh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmpRdWVyeSkgfHwgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoYXhpb3MpICE9PSAidW5kZWZpbmVkIikpIHsKCQkJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgbnVsbCwgY2FsbEJhY2spOwoJCQkJCWlmIChyZXF1ZXN0KSB7CgkJCQkJCWxldCByZXN1bHQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCTQ0LAoJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQlyZXF1ZXN0LlRleHRSZXNwb25zZSwKCQkJCQkJCXVybAoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KHJlc3VsdCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8ganF1ZXJ5IGNhbGwKCQkJCQkJdmFyIGFqYXggPSB7fTsKCQkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gKHRoaXMubk1heFVSTExlbmd0aCB8fCAxMDApKSB7CgkJCQkJCQlhamF4LnVybCA9IHVybDsKCQkJCQkJCWFqYXgudHlwZSA9ICdQT1NUJzsKCQkJCQkJCWFqYXguYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkJCSk7CgkJCQkJCQl9OwoJCQkJCQkJYWpheC5kYXRhID0KCQkJCQkJCQknUE9TVERBVEE9XHJcbicgLyorICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJ1dGYtOFwiIHN0YW5kYWxvbmU9XCJ5ZXNcIj8+XHJcbiIqLyArCgkJCQkJCQkJcG9zdERhdGE7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlhamF4LnVybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQkJYWpheC50eXBlID0gJ0dFVCc7CgkJCQkJCX0KCgkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQlpZiAodHlwZW9mKGpRdWVyeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCQlyZXQgPSBhd2FpdCAkLmFqYXgoYWpheCk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGF4aW9zKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCXJldCA9IGF3YWl0IGF4aW9zKGFqYXgpOwoJCQkJCQkJcmV0ID0gcmV0LmRhdGE7CgkJCQkJCX0KCQkJCQkJcmV0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgY2FsbEJhY2ssIHJldCwgdXJsKQoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIHhtbEhUVFAgPSB0aGlzLmdldFhtbEhUVFAoKTsKCQkJCQlpZiAoIXhtbEhUVFApIHJldHVybiBmYWxzZTsKCQkJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJCQl3aW5kb3cueG1sSFRUUC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJCQkJCWlmICh3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQkJCSQud2hlbigKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdChyZXN1bHQpKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQl3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdCgKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gdGhpcy5uTWF4VVJMTGVuZ3RoKSB7CgkJCQkJCXdpbmRvdy54bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIGNhbGxCYWNrICE9IG51bGwpOwoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCSk7IC8vIGZvb2wgY3Jvc3MtZG9tYWluIGNoZWNraW5nIGluIGNocm9tZQoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZW5kKAoJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJcG9zdERhdGEKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl4bWxIVFRQLm9wZW4oCgkJCQkJCQknR0VUJywKCQkJCQkJCXVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpLAoJCQkJCQkJY2FsbEJhY2sgIT0gbnVsbAoJCQkJCQkpOwoJCQkJCQl4bWxIVFRQLnNlbmQobnVsbCk7CgkJCQkJfQoKCQkJCQlpZiAoY2FsbEJhY2sgPT0gbnVsbCAmJiB4bWxIVFRQLnJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQl2YXIgX3VybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQlyZXR1cm4gJC53aGVuKAoJCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQl4bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJX3VybAoJCQkJCQkJCSkKCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB7CgkJCQkJCQkJcmV0dXJuIHRoaXMucHJvY2Vzc1Jlc3VsdChyZXN1bHQpOwoJCQkJCQkJfSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCXhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQlfdXJsCgkJCQkJCQkJKQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHJlYWR5U3RhdGUsIGNhbGxCYWNrLCByZXNwb25zZVRleHQsIHVybCkgPT4gewoJCQkJaWYgKFs0LCA0NF0uaW5kZXhPZihyZWFkeVN0YXRlKSA9PSAtMSkgcmV0dXJuOwoKCQkJCXZhciBzTWV0aG9kTmFtZSA9IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgdXJsKTsKCgkJCQl0cnkgewoJCQkJCWlmIChyZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJbGV0IHJlcyA9IChhc3luYyAoKSA9PiB7CgkJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdChudWxsLCByZXNwb25zZVRleHQpOwoJCQkJCQl9KSgpOwoJCQkJCX0KCgkJCQkJLy9yZXQgPSBudWxsOwoJCQkJCS8vc2VydmVyX3RpbWUgPSBudWxsOwoJCQkJCS8vX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJdmFyIGJTY3JpcHRFcnJvciA9IGZhbHNlOwoJCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCQl0cnkgewoJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgdGhyb3cgZTsKCQkJCQkJYlNjcmlwdEVycm9yID0gdHJ1ZTsKCQkJCQl9CgoJCQkJCWlmIChfcmV0ICYmIF9yZXQuc2VydmVyX3RpbWUpIHsKCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCgkJCQkJCXRyeSB7CgkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoX3JldCAmJiBfcmV0Ll9leGNlcHRpb24pIHsKCQkJCQkJdGhpcy5TaG93RGVidWcoX2V4Y2VwdGlvbi5NZXNzYWdlKTsKCQkJCQl9CgoJCQkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQkJCXZhciBjYWxsUmV0ID0gbnVsbDsKCQkJCQkJdHJ5IHsKCQkJCQkJCWNhbGxSZXQgPSBjYWxsQmFjayhfcmV0LnJldCwgX3JldC5fZXhjZXB0aW9uKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsgY2FsbEJhY2sgKyAnXG5cbicgKyBlLm1lc3NhZ2UKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQkJaWYgKAoJCQkJCQkJdHlwZW9mIF9yZXQubWV0aG9kX25hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQl0eXBlb2Ygc01ldGhvZE5hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQlzTWV0aG9kTmFtZSAhPSBfcmV0Lm1ldGhvZF9uYW1lCgkJCQkJCSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ01pc21hdGNoIGluIE1ldGhvZCBiZXR3ZWVuIHNlcnZlciBhbmQgY2xpZW50OlxuU2VydmVyIE1ldGhvZCBOYW1lOiAnICsKCQkJCQkJCQlfcmV0Lm1ldGhvZF9uYW1lICsKCQkJCQkJCQknXG5DbGllbnQgTWV0aG9kIE5hbWU6ICcgKwoJCQkJCQkJCXNNZXRob2ROYW1lCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJCSgKCQkJCQkJCXRoaXMuZkxvYWRpbmdFbmQgfHwKCQkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJCXdpbmRvdy5zci5yZXNldEN1cnNvcigpOwoJCQkJCQkJfQoJCQkJCQkpKCk7CgoJCQkJCQlyZXR1cm4gKAoJCQkJCQkJY2FsbFJldCB8fCBfcmV0LnJldCB8fCAoYlNjcmlwdEVycm9yID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB0aGlzLnJlc2V0Q3Vyc29yKCk7CgkJCQkJCXJldHVybiAoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXRocm93IGU7CgkJCQkJfQoJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQl0aGlzLlNob3dFcnJvcignRXJyb3IgaW4gY29kZTogJyArIGUubWVzc2FnZSArICdcbicgKyByZXNwb25zZVRleHQpOwoJCQkJfQoKCQkJCXJldHVybiBudWxsOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChyZXMpID0+IHsKCQkJCWlmICghcmVzIHx8ICFyZXMuQ29kZSB8fCAhcmVzLlN0b3JlZE1ldGhvZCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJcmV0dXJuIHJlczsKCQkJCX0KCgkJCQkvLyBmb3Igc3VyZSBhIG1ldGhvZCByZXN1bHQgZnJvbSBhbiBhc3luYyBjYWxsCgkJCQlpZiAocmVzLlJlc3VsdCkgewoJCQkJCS8vIHdlIGdvdCBhIHJlc3VsdAoJCQkJCXZhciBfX3JldCA9IG51bGw7CgkJCQkJdHJ5IHsKCQkJCQkJX19yZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXMuUmVzdWx0LCBudWxsKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCV9fcmV0ID0gcmVzLlJlc3VsdDsKCQkJCQl9CgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQlyZXR1cm4gX19yZXQ7CgkJCQl9CgoJCQkJdmFyIHRpbWVvdXQgPSByZXMuUnVuQWZ0ZXIgLSByZXMuRGF0ZTsKCQkJCWlmICh0aW1lb3V0IDw9IDApIHsKCQkJCQkvLyBuZWdhdGl2ZSB0aW1lb3V0IG1lYW5zIHRoYXQgaXQgd2FzIHN1cHBvc2VkIHRvIGJlIHJ1biBidXQgZGlkIG5vdCBmb3Igc29tZSByZWFzb24gKGRlbGF5LCBmYWlsdXJlLCBldGMuLi4pCgkJCQkJLy8gc2FtZSBkYXRlIGFzIHJ1bmFmdGVyIG1lYW5zIHRoYXQgd2UgYXJlIHVzaW5nIHRoZSBpbW1lZGlhdGUgYXN5bmMgZXhlY3V0aW9uLiBpLmUuIHRoZXJlIGlzIG5vIG5lZWQgZm9yIHRoZSBydW5uZXIgdGhyZWFkIHRhc2sKCQkJCQl0aW1lb3V0ID0gMzAwMDA7CgkJCQl9IGVsc2UgaWYgKHRpbWVvdXQgPiA1ICogNjAgKiAxMDAwKSB7CgkJCQkJLy8gbW9yZSB0aGFuIHdlIGNhbiB3YWl0LCB3ZSByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIHJlc3VsdAoJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQknV2UgY2Fubm90IHdhaXQgJyArCgkJCQkJCU1hdGguZmxvb3IodGltZW91dCAvIDEwMDApICsKCQkJCQkJJyBzZWNvbmRzLiBSZXR1cm5pbmcgcmVzdWx0LicKCQkJCQkpOwoJCQkJCXJldHVybiByZXM7CgkJCQl9CgkJCQljb25zb2xlLmxvZygKCQkJCQknTWFraW5nIHRoZSBuZXh0IGNhbGwgaW4gJyArCgkJCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQkJCScgc2Vjb25kcy4nCgkJCQkpOwoKCQkJCWF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpKTsKCQkJCWlmICghdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCQkJY29uc29sZS5sb2coJ05vIEFjdGl2ZVJlcXVlc3QsIGV4aXRpbmcuLi4nKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJCXRyeSB7CgkJCQkJbGV0IHJldCA9IGF3YWl0ICQuYWpheCh7CgkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZCZwMD17Q29kZX0nICsKCQkJCQkJCXJlcy5Db2RlICsKCQkJCQkJCSd7L0NvZGV9e0lkfScgKwoJCQkJCQkJcmVzLklkICsKCQkJCQkJCSd7L0lkfSZyYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKSwKCQkJCQl9KTsKCQkJCQlyZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXQsIHRoaXMuQWN0aXZlUmVxdWVzdC5VUkwpOwoJCQkJCXJldCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdChyZXQpOwoJCQkJCXJldHVybiByZXQ7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCdwcm9jZXNzUmVzdWx0JywgZXgpOwoJCQkJCXJldHVybiBhd2FpdCB0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQnLCBudWxsLCB7CgkJCQkJCUNvZGU6IHJlcy5Db2RlLAoJCQkJCQlJZDogcmVzLklkLAoJCQkJCX0pOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoZCkgPT4gewoJCQkJbGV0IHRkID0gMDsKCQkJCXRyeSB7CgkJCQkJdGQgPSB3aW5kb3cudGltZURpZmZlcmVuY2U7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRkID0gZ2xvYmFsLnRpbWVEaWZmZXJlbmNlOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXMuYWRkTVNlY29uZHMoZCB8fCBuZXcgRGF0ZSgpLCAtdGQpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbXMpID0+IHsKCQkJCXJldHVybiBuZXcgRGF0ZShvLmdldFRpbWUoKSArIG1zKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlpZiAoIXMpIHJldHVybiBudWxsOwoKCQkJCWxldCBjTGluZXMgPSBzLnNwbGl0KCdcbicpOwoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKGVzcHJpbWEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQllc3ByaW1hLnBhcnNlKHMsIHsKCQkJCQkJCWVzNjogdHJ1ZQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWlmIChjTGluZXNbZXgubGluZU51bWJlciAtIDFdLmluZGV4T2YoJ2ZvciBhd2FpdCcpIDwgMCkgewoJCQkJCQljb25zb2xlLmxvZygicnVuU2NyaXB0KCkgIiArIGV4LmRlc2NyaXB0aW9uLCBleC5saW5lTnVtYmVyLCBjTGluZXNbZXgubGluZU51bWJlciAtIDFdKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5fY29udGVudCAmJiB3aW5kb3cuX2NvbnRlbnQuZXZhbCkgewoJCQkJCQkJdmFyIG91dHB1dCA9IHdpbmRvdy5fY29udGVudC5ldmFsKHMpOwoJCQkJCQkJcmV0dXJuIG91dHB1dDsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ0ZGIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJCQkvLyBhIG11bHRpLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCQkJdmFyIG5ld1MgPSAnbmV3ViA9ICcgKyBzOwoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU2IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5leGVjU2NyaXB0KSB7CgkJCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KHMpOwoJCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkvLyBhIHNpbmdsZS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJCQlldmFsKG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU3IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJdmFyIGZuID0gZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgcmV0ID0gd2luZG93LmV2YWwuY2FsbCh3aW5kb3csIHMpOwoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfTsKCgkJCQkJCXJldHVybiBmbigpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ1RBRyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgkJCQl9CgoJCQkJdHJ5IHsKCQkJCQlzID0gcy5yZXBsYWNlKC9uZXcgRGF0ZVwoMDAwMS9nLCAnbmV3IERhdGUoMScpOwoJCQkJCXJldHVybiBldmFsKHMpOwoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXRoaXMuU2hvd0Vycm9yKCdFVkFMIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlyZXR1cm4gdGhpcy5ydW5TY3JpcHQoCgkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQlzICsKCQkJCQknIGlmKHR5cGVvZih3aW5kb3cpIT09InVuZGVmaW5lZCIpe3dpbmRvdy5tZXRob2RfbmFtZSA9IG1ldGhvZF9uYW1lOyB3aW5kb3cuc2VydmVyX3RpbWUgPSBzZXJ2ZXJfdGltZTsgd2luZG93Ll9leGNlcHRpb24gPSB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb247IHdpbmRvdy5leGVjdXRpb25fdGltZSA9IGV4ZWN1dGlvbl90aW1lO30gcmV0dXJuIHtfZXhjZXB0aW9uOiB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb24sIG1ldGhvZF9uYW1lOiBtZXRob2RfbmFtZSwgc2VydmVyX3RpbWU6IHNlcnZlcl90aW1lLCBleGVjdXRpb25fdGltZTogZXhlY3V0aW9uX3RpbWUsIHJldDogcmV0fTt9KSgpOycKCQkJCSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJdmFyIGhhc2ggPSAwLAoJCQkJCWksCgkJCQkJY2hyLAoJCQkJCWxlbjsKCQkJCWlmIChzLmxlbmd0aCA9PSAwKSByZXR1cm4gaGFzaDsKCQkJCWZvciAoaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQljaHIgPSBzLmNoYXJDb2RlQXQoaSk7CgkJCQkJaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIGNocjsKCQkJCQloYXNoIHw9IDA7IC8vIENvbnZlcnQgdG8gMzJiaXQgaW50ZWdlcgoJCQkJfQoJCQkJcmV0dXJuIGhhc2g7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYXIsIGZpZWxkKSA9PiB7CgkJCQlpZiAoIWFyIHx8ICFmaWVsZCkgcmV0dXJuIG51bGw7CgoJCQkJdmFyIGtleXMgPSBbXTsKCQkJCWFyLmZvckVhY2goYSA9PiB7CgkJCQkJdmFyIGtleSA9IG51bGw7CgkJCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCQkJaWYgKGspIHsKCQkJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlrZXlzLnB1c2goewoJCQkJCQkJa2V5OiBrZXksCgkJCQkJCQl2YWx1ZXM6IFthXSwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJCQlyZXR1cm4ga2V5czsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGJJZ25vcmVEZWJ1ZykgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCWNvbnNvbGUubG9nKCJTaG93RGVidWc6ICIgKyBzKTsKCQkJCX0KCQkJCWlmICh0aGlzLmJEZWJ1ZyB8fCBiSWdub3JlRGVidWcpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHJlcXVlc3QsIHRleHRyZXNwb25zZSkgPT4gewoJCQkJaWYgKCF0aGlzLmJDYWNoZVJlc3VsdCkgcmV0dXJuOwoJCQkJcmVxdWVzdCA9IHJlcXVlc3QgfHwgdGhpcy5BY3RpdmVSZXF1ZXN0OwoKCQkJCWlmICghcmVxdWVzdCkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGV4dHJlc3BvbnNlICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5Db2RlID0gJykgPiAtMSAmJgoJCQkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUnVuQWZ0ZXIgPSAnKSA+IC0xICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5SZXN1bHQgPSAiIicpID4gLTEKCQkJCSkgewoJCQkJCWNvbnNvbGUubG9nKCd0ZXh0cmVzcG9uc2UgY29udGlhbnMgaW5jb21wbGV0ZSBtZXRob2QgcmVzdWx0Jyk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJdmFyIHNNZXRob2QgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHJlcXVlc3QuVVJMKTsKCQkJCXNNZXRob2QgPSBzTWV0aG9kLnN1YnN0cmluZyhzTWV0aG9kLmxhc3RJbmRleE9mKCcuJykgKyAxKTsKCQkJCXRyeSB7CgkJCQkJdmFyIF91c2FibGUgPSAocikgPT4gewoJCQkJCQl2YXIgaXRlbSA9CgkJCQkJCQkociAmJgoJCQkJCQkJCXIuaGFzaCA9PSByZXF1ZXN0Lmhhc2ggJiYKCQkJCQkJCQkoci5VUkwgPT0gcmVxdWVzdC5VUkwgfHwgdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCByLlVSTCkgPT0gc01ldGhvZCkgJiYKCQkJCQkJCQlyLlRleHRSZXNwb25zZSAmJgoJCQkJCQkJCSh0eXBlb2Ygci5FeHBpcmVzID09PSAndW5kZWZpbmVkJyB8fAoJCQkJCQkJCQluZXcgRGF0ZShyLkV4cGlyZXMpID4gbmV3IERhdGUoKSkpID8KCQkJCQkJCXIgOgoJCQkJCQkJbnVsbDsKCQkJCQkJaWYgKHRleHRyZXNwb25zZSkgewoJCQkJCQkJaXRlbSA9IGl0ZW0gfHwgcmVxdWVzdDsKCQkJCQkJCWl0ZW0uVGV4dFJlc3BvbnNlID0gdGV4dHJlc3BvbnNlOwoJCQkJCQkJaXRlbS5FeHBpcmVzID0gbmV3IERhdGUoCgkJCQkJCQkJbmV3IERhdGUoKS5nZXRUaW1lKCkgKwoJCQkJCQkJCXBhcnNlRmxvYXQoCgkJCQkJCQkJCXRoaXMubkNhY2hlRXhwaXJlSG91cnMgfHwgdGhpcy4kX1JFUVVFU1QoJ25DYWNoZUV4cGlyZUhvdXJzJykgfHwgMQoJCQkJCQkJCSkgKgoJCQkJCQkJCTYwICoKCQkJCQkJCQk2MCAqCgkJCQkJCQkJMTAwMAoJCQkJCQkJKTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfTsKCgkJCQkJaWYgKAoJCQkJCQl0aGlzLmJDYWNoZVJlc3VsdCA9PSAna3ZzdG9yZScgJiYKCQkJCQkJdHlwZW9mIHdpbmRvdy5jb21wYW55LnJlc3Rpb2RiU2V0dGluZ3MgIT09ICd1bmRlZmluZWQnCgkJCQkJKSB7CgkJCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJCQl2YXIgcmV0ID0gY29tcGFueS5yZXN0aW9kYlNldHRpbmdzKCk7CgkJCQkJCQlyZXQudXJsICs9ICdrdnN0b3JlJzsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUFVUJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUE9TVCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5kYXRhID0gSlNPTi5zdHJpbmdpZnkoewoJCQkJCQkJCQlrZXk6IGtleSwKCQkJCQkJCQkJdmFsdWU6IEpTT04uc3RyaW5naWZ5KHZhbHVlLCBudWxsLCA0KSwKCQkJCQkJCQl9KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdERUxFVEUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnR0VUJzsKCQkJCQkJCQkJcmV0LnVybCArPSAnP3E9eyJrZXkiOicgKyBrZXkgKyAnfSc7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJLy9jb25zb2xlLmxvZygnbWV0aG9kJywgcmV0Lm1ldGhvZCk7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9OwoKCQkJCQkJbGV0IHJlY29yZCA9IGF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCkpOwoJCQkJCQlsZXQgciA9CgkJCQkJCQlyZWNvcmQgJiYgcmVjb3JkLmxlbmd0aCA/CgkJCQkJCQlKU09OLnBhcnNlKHJlY29yZFswXS52YWx1ZSkgOgoJCQkJCQkJbnVsbDsKCQkJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlpZiAocikgewoJCQkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkWzBdLl9pZCkpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciA/IHJlY29yZFswXS5faWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdzcicpIHsKCQkJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQkJCXZhciBtZXRob2QgPSAnRmluZCc7CgkJCQkJCQl2YXIgcmV0ID0gewoJCQkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0JywKCQkJCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJCQkJdHlwZTogJ1BPU1QnLAoJCQkJCQkJfTsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdVcGRhdGUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ0luc2VydCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5iZWZvcmVTZW5kID0gKHJlcXVlc3QpID0+IHsKCQkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCQkJCSk7CgkJCQkJCQkJfTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcmV0LnR5cGUgPSAnR0VUJzsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnRGVsZXRlJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBnZXQgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdGaW5kJzsKCQkJCQkJCQl9CgkJCQkJCQkJbWV0aG9kICs9CgkJCQkJCQkJCScmcDA9e0NvZGV9JyArCgkJCQkJCQkJCShjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsKCQkJCQkJCQkJa2V5ICsKCQkJCQkJCQkJJ3svQ29kZX0nOwoJCQkJCQkJfQoJCQkJCQkJcmV0LnVybCArPSBtZXRob2Q7CgkJCQkJCQlpZiAocmV0LnR5cGUgIT0gJ0dFVCcpIHsKCQkJCQkJCQlkZWxldGUgaXRlbS5Qb3N0RGF0YTsgLy8gYmVjYXVzZSB3ZSBoYXZlIHRoZSBjYWNoZSBrZXkKCQkJCQkJCQl2YXIgcDAgPSB7CgkJCQkJCQkJCUNvZGU6IChjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsga2V5LAoJCQkJCQkJCQlDb21wbGV0ZWQ6IG5ldyBEYXRlKCksCgkJCQkJCQkJCURhdGU6IHRoaXMuQWN0aXZlUmVxdWVzdCA/CgkJCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuRGF0ZSA6IG5ldyBEYXRlKCksCgkJCQkJCQkJCVJlc3VsdDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkoaXRlbSkpKSksIC8vaXRlbS5UZXh0UmVzcG9uc2UsCgkJCQkJCQkJCVN0b3JlZE1ldGhvZDogewoJCQkJCQkJCQkJTmFtZTogc01ldGhvZCwKCQkJCQkJCQkJfSwKCQkJCQkJCQl9OwoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQlwMC5JZCA9IGlkOwoJCQkJCQkJCX0KCQkJCQkJCQlyZXQuZGF0YSA9CgkJCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCQkJdGhpcy5wYXJhbShbcDBdKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX07CgoJCQkJCQlsZXQgcmVjb3JkID0gdGhpcy5ydW5TY3JpcHQgLypydW5TUlNjcmlwdCovKAoJCQkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQkJCShhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKSkgKwoJCQkJCQkJJ3JldHVybiByZXQ7fSkoKTsnCgkJCQkJCSk7CgkJCQkJCWxldCByID0gcmVjb3JkID8gSlNPTi5wYXJzZShyZWNvcmQuUmVzdWx0KSA6IG51bGw7CgkJCQkJCWxldCBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQkJCWlmICghaXRlbSkgewoJCQkJCQkJaWYgKHIpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZC5JZCkpOwoJCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciAmJiByZWNvcmQgPyByZWNvcmQuSWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdnaXRodWInKSB7CgkJCQkJCWlmIChyZXF1ZXN0LlVSTC5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHQnKSA+PSAwKSByZXR1cm4gbnVsbDsKCQkJCQkJbGV0IHJlcyA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXMgPSBhd2FpdCAkLmFqYXgoewoJCQkJCQkJCXVybDogJ2h0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvLycgKwoJCQkJCQkJCQljb21wYW55LlN0b3JlICsKCQkJCQkJCQkJJy8nICsKCQkJCQkJCQkJcmVxdWVzdC5oYXNoICsKCQkJCQkJCQkJJy5qcycsCgkJCQkJCQkJZGF0YVR5cGU6ICdqc29ucCcsCgkJCQkJCQkJcHJvY2Vzc1Jlc3VsdDogZmFsc2UsCgkJCQkJCQl9KTsKCQkJCQkJCXJldHVybiB7CgkJCQkJCQkJVGV4dFJlc3BvbnNlOiByZXMsCgkJCQkJCQl9OwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coJ0VSUk9SUzonLCBleCk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2xvY2FsJykgewoJCQkJCQl2YXIgc3JDYWNoZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzckNhY2hlJyk7CgkJCQkJCWlmIChzckNhY2hlID09IG51bGwpIHsKCQkJCQkJCXNyQ2FjaGUgPSB7CgkJCQkJCQkJUmVxdWVzdHM6IHt9LAoJCQkJCQkJfTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNyQ2FjaGUgPSBKU09OLnBhcnNlKHNyQ2FjaGUpOwoJCQkJCQl9CgoJCQkJCQl2YXIgciA9IHNyQ2FjaGUuUmVxdWVzdHNbcmVxdWVzdC5oYXNoXTsKCQkJCQkJdmFyIGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlkZWxldGUgc3JDYWNoZS5SZXF1ZXN0c1tyZXF1ZXN0Lmhhc2hdOwoJCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCQkJc3JDYWNoZS5SZXF1ZXN0c1tpdGVtLmhhc2hdID0gaXRlbTsKCQkJCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzckNhY2hlJywgSlNPTi5zdHJpbmdpZnkoc3JDYWNoZSkpOwoJCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCXRocm93IGV4OwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWlmICh0eXBlb2YgcyAhPT0gJ3N0cmluZycpIHJldHVybiBzOwoKCQkJCXZhciBhcnIxID0gW107CgkJCQlmb3IgKHZhciBuID0gMCwgbCA9IHMubGVuZ3RoOyBuIDwgbDsgbisrKSB7CgkJCQkJdmFyIGhleCA9IE51bWJlcihzLmNoYXJDb2RlQXQobikpLnRvU3RyaW5nKDE2KTsKCQkJCQlhcnIxLnB1c2goaGV4KTsKCQkJCX0KCQkJCXJldHVybiBhcnIxLmpvaW4oJycpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWNvbnNvbGUubG9nKHMpOwoJCQkJaWYgKHRoaXMuYlNob3dFcnJvcnMpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8xLCBvMikgPT4gewoJCQkJaWYgKG8xID09IG8yKSByZXR1cm4gdHJ1ZTsKCgkJCQlpZiAoCgkJCQkJbzEgJiYKCQkJCQlvMS5fX09CSkVDVElEICYmCgkJCQkJbzIgJiYKCQkJCQlvMi5fX09CSkVDVElEICYmCgkJCQkJbzEuX19PQkpFQ1RJRCA9PSBvMi5fX09CSkVDVElECgkJCQkpCgkJCQkJcmV0dXJuIHRydWU7CgkJCQlpZiAobzEgJiYgbzEuX19ST1dJRCAmJiBvMiAmJiBvMi5fX1JPV0lEICYmIG8xLl9fUk9XSUQgPT0gbzIuX19ST1dJRCkKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCWlmIChvMSAmJiBvMS5JZCAmJiBvMiAmJiBvMi5JZCAmJiBvMS5JZCA9PSBvMi5JZCkgcmV0dXJuIHRydWU7CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCgpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIG51bGw7CgkJCQkJaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoZ2xvYmFsLm9zKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJLy8gY29uc29sZS5sb2coImlwQWRkcmVzcygpOiBJbnZhbGlkIGdsb2JhbCBvciBnbG9iYWwub3Mgbm90IGRlZmluZWQiKTsKCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJfQoJCQkJCXJldHVybiBbXS5jb25jYXQoLi4uT2JqZWN0LnZhbHVlcyhnbG9iYWwub3MubmV0d29ya0ludGVyZmFjZXMoKSkpLmZpbmQoKGRldGFpbHMpID0+IGRldGFpbHMuZmFtaWx5ID09PSAnSVB2NCcgJiYgIWRldGFpbHMuaW50ZXJuYWwpLmFkZHJlc3M7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogIiArIGV4KTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGVhKSA9PiB7CgkJCQl0cnkgewoJCQkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhKSA9PiB7CgkJCQlyZXR1cm4gYS5maWx0ZXIoKGFnLCBpKSA9PiAhYS5maW5kKChfYWcsIF9pKSA9PiBfYWcuTmFtZSA9PSBhZy5OYW1lICYmIF9pID4gaSAmJiBpID09IF9pKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgob2JqKSA9PiB7CgkJCQlyZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKG9iaikubWFwKChbaywgdl0pID0+IFt2LCBrXSkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChzY29wZSwgZmlsZW5hbWUpID0+IHsKCQkJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoKCQkJCWxldCBzID0gewoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogIkFQSVNFUlZFUjo6IiArIHNjb3BlLAoJCQkJfTsKCQkJCWlmIChvU2NvcGUuX19zY3JpcHQgJiYgb1Njb3BlLl9fc2NyaXB0LkRhdGUpIHsKCQkJCQlzLkRhdGUgPSBvU2NvcGUuX19zY3JpcHQuRGF0ZTsKCQkJCQlzLk9QRVJBVE9SUyA9IHsKCQkJCQkJRGF0ZTogIj4iCgkJCQkJfQoJCQkJfQoJCQkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMuc3IoKS5fKGBDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kYCwgbnVsbCwgcyk7CgkJCQlpZiAoc2NyaXB0ICYmIHNjcmlwdC5TY3JpcHQpIHsKCQkJCQlzY3JpcHQuU2NyaXB0ID0gdGhpcy5fYXRvYihzY3JpcHQuU2NyaXB0KTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIl9yZWZyZXNoQVBJOiBzY3JpcHQgaXMgbnVsbCIpOwoJCQkJCXJldHVybiAxOwoJCQkJfQoKCQkJCWlmICghb1Njb3BlIHx8ICFvU2NvcGUuX19zY3JpcHQgfHwgKHNjcmlwdCAmJiBzY3JpcHQuU2NyaXB0ICYmICgoc2NyaXB0LkRhdGUuZ2V0VGltZSgpIC0gb1Njb3BlLl9fc2NyaXB0LkRhdGUuZ2V0VGltZSgpKSAvIDEwMDApID4gNSkpIHsKCQkJCQlpZiAoZmlsZW5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coIlsiICsgc2NvcGUgKyAiXSBOZXcgVXBkYXRlZCBWZXJzaW9uLCBvdmVyd3JpdHRpbmcgIiArIGZpbGVuYW1lLCBzY3JpcHQuRGF0ZSwgKG9TY29wZSAmJiBvU2NvcGUuX19zY3JpcHQpID8gb1Njb3BlLl9fc2NyaXB0LkRhdGUgOiBudWxsKTsKCQkJCQl9CgoJCQkJCWlmIChmaWxlbmFtZSAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJYXdhaXQgZ2xvYmFsLnV0aWwucHJvbWlzaWZ5KGdsb2JhbC5mcy53cml0ZUZpbGUpKGZpbGVuYW1lLCBzY3JpcHQuU2NyaXB0KTsKCQkJCQl9IGVsc2UgaWYgKGZpbGVuYW1lKSB7CgkJCQkJCWF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNTYXZlRmlsZUJvZHknLCBudWxsLCBmaWxlbmFtZSwgdGhpcy5fYnRvYShzY3JpcHQuU2NyaXB0KSk7CgkJCQkJfQoKCQkJCQlpZiAoIW9TY29wZSkgcmV0dXJuOwoJCQkJCW9TY29wZS5fX3NjcmlwdCA9IHNjcmlwdDsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykKCQkJCQkJY29uc29sZS5sb2coYFske3Njb3BlfV0gU2FtZSBvciBvbGRlciB2ZXJzaW9uLCBza2lwcGluZyB1cGRhdGVgLCBzY3JpcHQgPyBzY3JpcHQuRGF0ZSA6IG51bGwsIG9TY29wZS5fX3NjcmlwdCA/IG9TY29wZS5fX3NjcmlwdC5EYXRlIDogbnVsbCk7CgkJCQl9CgoJCQkJZGVsZXRlIG9TY29wZS5fX3NjcmlwdC5TY3JpcHQ7CgkJCQlyZXR1cm4gb1Njb3BlLl9fc2NyaXB0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzY29wZSkgPT4gewoJCQkJbGV0IHJldCA9ICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiBnbG9iYWwpOwoJCQkJaWYgKHNjb3BlKSByZXQgPSByZXRbc2NvcGVdOwoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCgpID0+IHsKCQkJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5TUikgPyB3aW5kb3cuU1IgOiB0aGlzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhKSA9PiB7CgkJCQlyZXR1cm4gdHlwZW9mKGF0b2IpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGEsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JykgOiBhdG9iKGEpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChiKSA9PiB7CgkJCQlyZXR1cm4gdHlwZW9mKGJ0b2EpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGIpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGIpKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG5hbWUgPSAiZ2xvYmFsIikgPT4gewoJCQkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzID0gdGhpcy5fX3Njb3BlKCkuX190aW1lcyB8fCB7fTsKCQkJCXRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCQkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIHRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCQkJdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IGQ7CgkJCQlyZXR1cm4gKHMgKyAncycpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAobXMpID0+IHsKCQkJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChlYSwgZGJUeXBlKSA9PiB7CgkJCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQkJCXN3aXRjaCAodHlwZSkgewoJCQkJCWNhc2UgIlN0cmluZyI6CgkJCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJCQljYXNlICJUZXh0IjoKCQkJCQljYXNlICJPYmplY3QiOgoJCQkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSg0MDAwKWA7CgkJCQkJY2FzZSAiQm9vbCI6CgkJCQkJCXJldHVybiAiVElOWUlOVCI7IC8vQklUCgkJCQkJY2FzZSAiRGF0ZSI6CgkJCQkJCXJldHVybiAiREFURVRJTUUiOwoJCQkJCWNhc2UgIkludCI6CgkJCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCQkJY2FzZSAiTG9uZyI6CgkJCQkJCXJldHVybiAiQklHSU5UIjsKCQkJCQljYXNlICJFbnRpdHkiOgoJCQkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCQkJY2FzZSAiSW1hZ2UiOgoJCQkJCWNhc2UgIkZpbGUiOgoJCQkJCQlyZXR1cm4gIkJMT0IiOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChpZCwgbGVuKSA9PiB7CgkJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCQkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2NCkgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdjQoKTsKCgkJCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpLnJlcGxhY2UoL1wtL2csICcnKTsKCgkJCQkvL2xldCBwb29sID0gKHRoaXMuX19zY29wZSgpLl9fdXVpZFBvb2wgPSB0aGlzLl9fc2NvcGUoKS5fX3V1aWRQb29sIHx8IFtdKTsKCQkJCS8vaWYgKHBvb2wuZmluZCh1ID0+IHUgPT0gcmV0KSkgcmV0dXJuIHRoaXMuX3V1aWQoaWQsIGxlbik7CgkJCQkvL3Bvb2wucHVzaChyZXQpOwoKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKGxpYk5hbWUsIGhyZWZzKSA9PiB7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgKGhyZWZzIHx8IHRoaXMuaHJlZnMpLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgaHJlZnMpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQkJCXRoaXMuX2NzcyhjKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkgewoJCQkJCQl0cnkgewoJCQkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJCQlsZXQgX3NjID0gYXdhaXQgc3IuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpOwoJCQkJCQkJCWF3YWl0IHNyLnJ1blNjcmlwdChfc2MuU2NyaXB0KTsKCQkJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgaW1wb3J0KHMpKTsKCQkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKCQpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoJC5hamF4KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCgkJCQkJCQkJYXdhaXQgJC5hamF4KHsKCQkJCQkJCQkJdXJsOiBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSwKCQkJCQkJCQkJZGF0YVR5cGU6ICJzY3JpcHQiLAoJCQkJCQkJCQljYWNoZTogbi5jYWNoZSA/ICdmb3JjZS1jYWNoZScgOiAnZGVmYXVsdCcKCQkJCQkJCQl9KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHIoKTsKCQkJCQkJCQkJc2NyaXB0LnNyYyA9IHM7CgkJCQkJCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246ICIgKyBleCwgcyk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKG4ubG9hZCkgewoJCQkJCQl0cnkgewoJCQkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBleCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoX2hyZWYpID0+IHsKCQkJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgodmFsdWUsIHR5cGUpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZihiZWF1dGlmaWVyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkJCSJlNHgiOiB0cnVlLAoJCQkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQkJCX07CgkJCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0J10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJCQl2YWx1ZSA9IGJlYXV0aWZpZXIuanModHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZSwgb3B0aW9ucyk7CgkJCQkJCX0gZWxzZSBpZiAoWydodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJCQl2YWx1ZSA9IGJlYXV0aWZpZXIuaHRtbCh2YWx1ZSwgb3B0aW9ucyk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkge30KCQkJCXJldHVybiB2YWx1ZTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlEZXBhcnRtZW50KGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9kZXBhcnRtZW50Il0gJiYgKGFbIl9kZXBhcnRtZW50Il0uRXF1YWxzID8gYVsiX2RlcGFydG1lbnQiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2RlcGFydG1lbnQiXSwgcikpKSB7CgkJCQkJci5fZGVwYXJ0bWVudF9Vc2Vycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLnVzZXJuYW1lKHRoaXMudXNlcm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCAmJiB0aGlzLmRlcGFydG1lbnQoKSAmJiAhKGF3YWl0IHRoaXMuZGVwYXJ0bWVudCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2RlcGFydG1lbnQoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX3VzZXJuYW1lX3NldCkgewoKCQkJCQlvYmoudXNlcm5hbWUgPSB0aGlzLnVzZXJuYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9wYXNzd29yZF9zZXQpIHsKCgkJCQkJb2JqLnBhc3N3b3JkID0gdGhpcy5wYXNzd29yZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9zZXQpIHsKCgkJCQkJb2JqLmRlcGFydG1lbnQgPSB0aGlzLl9kZXBhcnRtZW50LklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIlVzZXIiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJdHJ5IHsKCQkJaWYgKGRlcHRoID4gMSkgewoJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIHJldCkgewoKCQkJCQlpZiAoci5fZGVwYXJ0bWVudF9zZXQpIHsKCQkJCQkJci5kZXBhcnRtZW50KGF3YWl0IHIuX2RlcGFydG1lbnQuZmluZChkZXB0aCAtIDEpKTsKCQkJCQl9CgoJCQkJCXIubWFuYWdlcl9EZXBhcnRtZW50cyhhd2FpdCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCByLlRvb2wpLm1hbmFnZXIocikuZmluZEFsbChkZXB0aCAtIDEpKTsKCgkJCQkJci5jYWxsZXJfSW5jaWRlbnRzKGF3YWl0IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCByLlRvb2wpLmNhbGxlcihyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCQlyLmNvbnRhY3RfSW5jaWRlbnRzKGF3YWl0IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCByLlRvb2wpLmNvbnRhY3QocikuZmluZEFsbChkZXB0aCAtIDEpKTsKCgkJCQkJci51c2VyX0dyb3VwX01lbWJlcnMoYXdhaXQgbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcihudWxsLCByLlRvb2wpLnVzZXIocikuZmluZEFsbChkZXB0aCAtIDEpKTsKCgkJCQl9CgkJCX0KCgkJCWxldCByZWZzID0gW107CgkJCWlmICghQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSBbcmV0XTsKCgkJCXJlZnMucHVzaCguLi5yZXQuZmlsdGVyKHIgPT4gci5FbnRpdHlDbGFzcykpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IG8gb2YgKG9ianMgfHwgW10pKSB7CgkJCQlsZXQgb2ZhID0gW107CgkJCQlpZiAoby5fdG9FTVNPYmplY3QpIHsKCQkJCQlvZmEgPSBhd2FpdCB0aGlzLl9mcm9tRU1TVmFsdWVzKGF3YWl0IG8uX3RvRU1TT2JqZWN0KHRydWUsIHRydWUpLmZpbmRBbGwoZGVwdGgpKTsKCQkJCX0gZWxzZSB7CgkJCQkJb2ZhID0gYXdhaXQgby5maW5kQWxsKGRlcHRoKTsKCQkJCX0KCQkJCXJlZnMucHVzaCguLi5vZmEpOwoJCQl9CgkJCXJlZnMgPSByZWZzLmZpbHRlcihyID0+IHIpOwoJCQlyZWZzLmZvckVhY2gociA9PiB7CgkJCQlmb3IgKHZhciBwIGluIHIpIHsKCQkJCQlpZiAocC5zdGFydHNXaXRoKCdfJykgJiYgcltwXSAmJiByW3AgKyAiX3NldCJdICYmIHJbcF0uSWQgJiYgcmVmcy5maW5kKG8gPT4gby5JZCA9PSByW3BdLklkKSkgewoJCQkJCQlyW3Auc3Vic3RyaW5nKDEpXShyZWZzLmZpbmQobyA9PiBvLklkID09IHJbcF0uSWQpKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZmluZFJlZmVyZW5jZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9Cgp9OwoKc2FsZXNub3cuQ29udGVudCA9IGNsYXNzIENvbnRlbnQgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJc0tpNWZaMmwwYUhWaUluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SkdhV3hsVTNsemRHVnRJaXdpUjJsMFNIVmlJbDA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb250ZW50IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb250ZW50KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJDb250ZW50IiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGVudCAqKi8KCWNvbnRlbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb250ZW50X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29udGVudCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29udGVudCAhPSB2KSB7CgkJCQl0aGlzLl9jb250ZW50X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb250ZW50ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb250ZW50KTsKCQl9Cgl9CgoJY2xlYXJfY29udGVudCgpIHsKCQl0aGlzLl9jb250ZW50X3NldCA9IG51bGw7CgkJdGhpcy5fY29udGVudCA9IG51bGw7CgkJdGhpcy5fY29udGVudF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGVudCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2NvbnRlbnRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2NvbnRlbnRfc2V0ID0gdGhpcy5fY29udGVudF9zZXQ7CgkJcmV0Ll9jb250ZW50X2Nvb3AgPSB0aGlzLl9jb250ZW50X2Nvb3A7CgkJcmV0LmNvbnRlbnQgPSB0aGlzLmNvbnRlbnQoKSA/IHRoaXMuY29udGVudCgpIDogdGhpcy5jb250ZW50KCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImNvbnRlbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Db250ZW50LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkNvbnRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkNvbnRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYENvbnRlbnQuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBDb250ZW50Ll9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbnRlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkNvbnRlbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuQ29udGVudCh0aGlzLklkKQoKCQkJLmNvbnRlbnQodGhpcy5jb250ZW50KCksIHRoaXMuX2NvbnRlbnRfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnQ29udGVudCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJDb250ZW50IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdDb250ZW50JwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkNvbnRlbnQqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiY29udGVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qQ29udGVudCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb250ZW50IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb250ZW50KHRhYmxlWyJjb250ZW50Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJdHJ5IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWxldCB1cmkgPSB0aGlzLl9fY29uZmlnKGBwYXRoLiR7Y29udGVudD8nd3JpdGUnOidyZWFkJ31gLCAnLi8nKSArIGZpbGU7CgkJCWlmICh0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpIHsKCQkJCWlmICh0eXBlb2YoY29udGVudCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJLy8gd3JpdGUKCQkJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCXJldCA9IGdsb2JhbC5mcy53cml0ZUZpbGVTeW5jKHVyaSwgY29udGVudCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ZpbGVzeXN0ZW0nLCAnRW50aXR5T2JqZWN0JywgMSwgIkNhbm5vdCB3cml0ZSB0byBmaWxlIHN5c3RlbSIpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gcmVhZAoJCQkJCWlmICh1cmkuc3RhcnRzV2l0aCgnaHR0cCcpICYmIHVyaS5pbmRleE9mKCc6Ly8nKSA+IDApIHsKCQkJCQkJcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmF4aW9zLmdldCh1cmkpOwoJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCXJldCA9IGdsb2JhbC5mcy5yZWFkRmlsZVN5bmModXJpKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldCA9IEpTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuZGF0YS5jb250ZW50KSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZmlsZXN5c3RlbScsICdFbnRpdHlPYmplY3QnLCAwLCB1cmksIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ZpbGVzeXN0ZW0nLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWNvbnRlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWNvbnRlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJjb250ZW50Iiwgb2JqLCB0aGlzLmNvbnRlbnQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmEzNDgxY2ItZmFmZC00MDI0LTg2ZWYtNmE0ZTQyZWVlNmZhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydjb250ZW50JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGVudCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjJhMzQ4MWNiLWZhZmQtNDAyNC04NmVmLTZhNGU0MmVlZTZmYSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29udGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db250ZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbnRlbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydjb250ZW50JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRlbnQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29udGVudF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb250ZW50KCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQljb250ZW50OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvbnRlbnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWNvbnRlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb250ZW50X3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Db250ZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkNvbnRlbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJGaWxlU3lzdGVtIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiQ29udGVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQljb250ZW50OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb250ZW50ID0gdiA9PSBxdWVyeS5jb250ZW50KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvbnRlbnRfc2V0ICYmICFxdWVyeS5fY29udGVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGVudCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb250ZW50X3NldCAmJiBxdWVyeS5fY29udGVudF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRlbnQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fY29udGVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJY29udGVudDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRlbnQnLCB1bmRlZmluZWQpIDogImNvbnRlbnQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29udGVudF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29udGVudChyZWYpOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiY29udGVudCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250ZW50JywgdW5kZWZpbmVkKSA6ICJjb250ZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvbnRlbnRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvbnRlbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Db250ZW50LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkNvbnRlbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJGaWxlU3lzdGVtIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29udGVudC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJGaWxlU3lzdGVtIikgewoKCQkJCWF3YWl0IHRoaXMuX2ZpbGVzeXN0ZW0odGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbnRlbnQudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJGaWxlU3lzdGVtIikgewoKCQkJCWF3YWl0IHRoaXMuX2ZpbGVzeXN0ZW0odGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbnRlbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiRmlsZVN5c3RlbSIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZmlsZXN5c3RlbSh0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LkNvbnRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5EZXBhcnRtZW50ID0gY2xhc3MgRGVwYXJ0bWVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElzS2k1ZloybDBhSFZpSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJtYW5hZ2VyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9tYW5hZ2VyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9kZXBhcnRtZW50X1VzZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiRGVwYXJ0bWVudCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fbWFuYWdlcl9zZXQgJiYgdGhpcy5fbWFuYWdlcikgdGhpcy5fbWFuYWdlci5Ub29sID0gdG9vbDsKCgkJLy8gKHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyICoqLwoJbWFuYWdlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX21hbmFnZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJtYW5hZ2VyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbWFuYWdlciAhPSB2KSB7CgkJCQl0aGlzLl9tYW5hZ2VyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fbWFuYWdlciA/IHRoaXMuX21hbmFnZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX21hbmFnZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX21hbmFnZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbWFuYWdlcik7CgkJfQoJfQoKCWNsZWFyX21hbmFnZXIoKSB7CgkJdGhpcy5fbWFuYWdlcl9zZXQgPSBudWxsOwoJCXRoaXMuX21hbmFnZXIgPSBudWxsOwoJCXRoaXMuX21hbmFnZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1hbmFnZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50X1VzZXJzICoqLwoJZGVwYXJ0bWVudF9Vc2Vycyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fZGVwYXJ0bWVudF9Vc2VyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdVc2VyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9kZXBhcnRtZW50X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RlcGFydG1lbnRfVXNlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgImRlcGFydG1lbnQgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIlVzZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50X1VzZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJkZXBhcnRtZW50IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiVXNlciIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5kZXBhcnRtZW50KHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnMucHVzaCguLi52KTsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9kZXBhcnRtZW50X1VzZXJzKCkgewoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfc2V0ID0gbnVsbDsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlcGFydG1lbnRfVXNlcnMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9tYW5hZ2VyX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX21hbmFnZXJfc2V0ID0gdGhpcy5fbWFuYWdlcl9zZXQ7CgkJcmV0Ll9tYW5hZ2VyX2Nvb3AgPSB0aGlzLl9tYW5hZ2VyX2Nvb3A7CgkJcmV0Lm1hbmFnZXIgPSB0aGlzLm1hbmFnZXIoKSA/IHRoaXMubWFuYWdlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLm1hbmFnZXIoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LmRlcGFydG1lbnRfVXNlcnMgPSB0aGlzLmRlcGFydG1lbnRfVXNlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJIm1hbmFnZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50X0RlcGFydG1lbnRzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gIm1hbmFnZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIG1hbmFnZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvRGVwYXJ0bWVudC8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBEZXBhcnRtZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgRGVwYXJ0bWVudC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkRlcGFydG1lbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9tYW5hZ2VyX3NldCAmJiB0aGlzLm1hbmFnZXIoKSkgdGhpcy5tYW5hZ2VyKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5kZXBhcnRtZW50X0RlcGFydG1lbnRzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCh0aGlzLklkKQoKCQkJLm1hbmFnZXIodGhpcy5tYW5hZ2VyKCksIHRoaXMuX21hbmFnZXJfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0RlcGFydG1lbnQnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnRZVzVoWjJWeUlqb2lWWE5sY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJEZXBhcnRtZW50IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdEZXBhcnRtZW50JwoJCX0sIG9wdGlvbnMgfHwge30pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypEZXBhcnRtZW50Ki8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJIm1hbmFnZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkRlcGFydG1lbnQqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibWFuYWdlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubWFuYWdlcih0YWJsZVsibWFuYWdlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjE2ZjlmMWZlLTU1NTMtNDc4NS04ZjcwLWM4YzgxNWQ2MzI2OCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLm1hbmFnZXIoKSB8fCAodGhpcy5tYW5hZ2VyKCkKCgkJCQkmJgoJCQkJIXRoaXMubWFuYWdlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubWFuYWdlcigpLmNhbGxlcl9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubWFuYWdlcigpLmNvbnRhY3RfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoIm1hbmFnZXIiLCBvYmosIHRoaXMubWFuYWdlcigpKTsKCQl9CgoJCV9vcHRpb25zKCJkZXBhcnRtZW50X1VzZXJzIiwgb2JqLCB0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ21hbmFnZXInLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2RlcGFydG1lbnRfVXNlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIxNmY5ZjFmZS01NTUzLTQ3ODUtOGY3MC1jOGM4MTVkNjMyNjgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIm1hbmFnZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudF9Vc2VycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ21hbmFnZXInLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2RlcGFydG1lbnRfVXNlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm1hbmFnZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbWFuYWdlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubWFuYWdlcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWFuYWdlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQltYW5hZ2VyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm1hbmFnZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubWFuYWdlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubWFuYWdlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWFuYWdlcl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX21hbmFnZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImRlcGFydG1lbnQuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICc9JyB8fCB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypkZXBhcnRtZW50X1VzZXJzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5tYW5hZ2VyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm1hbmFnZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiBvYmoubWFuYWdlciA9IHYuX3RvUGF0aHMoKSwKCgkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50X0RlcGFydG1lbnRzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmRlcGFydG1lbnRfVXNlcnMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5EZXBhcnRtZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkRlcGFydG1lbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKQoKCQkJCQkubWFuYWdlcihuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuZGVwYXJ0bWVudF9Vc2VycyhuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkRlcGFydG1lbnQiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJbWFuYWdlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubWFuYWdlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubWFuYWdlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9tYW5hZ2VyX3NldCAmJiAhcXVlcnkuX21hbmFnZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm1hbmFnZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbWFuYWdlcl9zZXQgJiYgcXVlcnkuX21hbmFnZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMubWFuYWdlcigpICYmICF0aGlzLm1hbmFnZXIoKS5fbWF0Y2hlcyhxdWVyeS5tYW5hZ2VyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tYW5hZ2VyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmRlcGFydG1lbnRfVXNlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5kZXBhcnRtZW50X1VzZXJzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQltYW5hZ2VyOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgbWFuYWdlciIpOwoJCQkJCW9iai5tYW5hZ2VyID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9tYW5hZ2VyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbWFuYWdlcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLm1hbmFnZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5kZXBhcnRtZW50X1VzZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpIDogIm1hbmFnZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbWFuYWdlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5tYW5hZ2VyKCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLm1hbmFnZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBtYW5hZ2VyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudF9Vc2VycyIpKSA9PiB0aGlzLmRlcGFydG1lbnRfVXNlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkibWFuYWdlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbWFuYWdlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnRfVXNlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9tYW5hZ2VyIl0gJiYgKGFbIl9tYW5hZ2VyIl0uRXF1YWxzID8gYVsiX21hbmFnZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX21hbmFnZXIiXSwgcikpKSB7CgkJCQkJci5fbWFuYWdlcl9EZXBhcnRtZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fbWFuYWdlcl9zZXQgJiYgdGhpcy5tYW5hZ2VyKCkgJiYgIShhd2FpdCB0aGlzLm1hbmFnZXIoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9tYW5hZ2VyKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9tYW5hZ2VyX3NldCkgewoKCQkJCQlvYmoubWFuYWdlciA9IHRoaXMuX21hbmFnZXIuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiRGVwYXJ0bWVudCIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlByaW9yaXR5ID0gY2xhc3MgUHJpb3JpdHkgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJc0tpNWZaMmwwYUhWaUluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9wcmlvcml0eV9JbmNpZGVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJQcmlvcml0eSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCXByaW9yaXR5X0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdiM2EwYjAyMC05YzAwLTRiZDAtYWQ5NC05MTYzODc5YjRkYzAnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9wcmlvcml0eV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInByaW9yaXR5IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicHJpb3JpdHkgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5wcmlvcml0eSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcHJpb3JpdHlfSW5jaWRlbnRzKCkgewoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5wcmlvcml0eV9JbmNpZGVudHMgPSB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1ByaW9yaXR5LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgUHJpb3JpdHkuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBQcmlvcml0eS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eS5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiUHJpb3JpdHkiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMucHJpb3JpdHlfUHJpb3JpdHlzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuUHJpb3JpdHkodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkucHJpb3JpdHlfSW5jaWRlbnRzKHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCksIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1ByaW9yaXR5JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlByaW9yaXR5IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdQcmlvcml0eScKCQl9LCBvcHRpb25zIHx8IHt9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypQcmlvcml0eSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypQcmlvcml0eSovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU2YjE3MTFkLWY5ZTctNGU3Ni1iNzUwLTZlMjExMDZkNTA5MSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU2YjE3MTFkLWY5ZTctNGU3Ni1iNzUwLTZlMjExMDZkNTA5MSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJwcmlvcml0eV9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsncHJpb3JpdHlfSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5X1ByaW9yaXR5cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgicHJpb3JpdHkuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qcHJpb3JpdHlfSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiBvYmoucHJpb3JpdHlfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUHJpb3JpdHkpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUHJpb3JpdHkgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KCkKCgkJCQkJLnByaW9yaXR5X0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJQcmlvcml0eSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LnByaW9yaXR5X0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5wcmlvcml0eV9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpIDogInByaW9yaXR5X0luY2lkZW50cyIpKSA9PiB0aGlzLnByaW9yaXR5X0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpIDogInByaW9yaXR5X0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJQcmlvcml0eSIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlJlYXNvbiA9IGNsYXNzIFJlYXNvbiBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElzS2k1ZloybDBhSFZpSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJSZWFzb24iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xvc2VfcmVhc29uX0luY2lkZW50cyAqKi8KCWNsb3NlX3JlYXNvbl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2IzYTBiMDIwLTljMDAtNGJkMC1hZDk0LTkxNjM4NzliNGRjMCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2Nsb3NlX3JlYXNvbl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjbG9zZV9yZWFzb24gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2xvc2VfcmVhc29uIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2xvc2VfcmVhc29uKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkgewoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbl9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LmNsb3NlX3JlYXNvbl9JbmNpZGVudHMgPSB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9SZWFzb24vJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFJlYXNvbi5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFJlYXNvbi5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJSZWFzb24iKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuY2xvc2VfcmVhc29uX1JlYXNvbnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5SZWFzb24odGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSwgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1JlYXNvbic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJSZWFzb24iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ1JlYXNvbicKCQl9LCBvcHRpb25zIHx8IHt9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypSZWFzb24qLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qUmVhc29uKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbGVOYW1lKF9jbGFzcywgb2JqLCBlYUNvZGUpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiY2E2MWZiOGEtODY4ZS00NDkwLWFlZWMtZmFmNmNjNjI2M2IwIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImNsb3NlX3JlYXNvbl9JbmNpZGVudHMiLCBvYmosIHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjYTYxZmI4YS04NjhlLTQ0OTAtYWVlYy1mYWY2Y2M2MjYzYjAiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJLy8gTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiY2xvc2VfcmVhc29uLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qY2xvc2VfcmVhc29uX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5SZWFzb24pIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUmVhc29uID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5SZWFzb24oKQoKCQkJCQkuY2xvc2VfcmVhc29uX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJSZWFzb24iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uX0luY2lkZW50cyIpKSA9PiB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJSZWFzb24iKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlJlYXNvbi51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5TeW1wdG9tID0gY2xhc3MgU3ltcHRvbSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElzS2k1ZloybDBhSFZpSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3N5bXB0b21fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiU3ltcHRvbSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbV9JbmNpZGVudHMgKiovCglzeW1wdG9tX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fc3ltcHRvbV9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2IzYTBiMDIwLTljMDAtNGJkMC1hZDk0LTkxNjM4NzliNGRjMCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3N5bXB0b21fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3ltcHRvbV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInN5bXB0b20gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3ltcHRvbV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInN5bXB0b20gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5zeW1wdG9tKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9zeW1wdG9tX0luY2lkZW50cygpIHsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzeW1wdG9tX0luY2lkZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnN5bXB0b21fSW5jaWRlbnRzID0gdGhpcy5zeW1wdG9tX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1N5bXB0b20vJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgU3ltcHRvbS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFN5bXB0b20uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbS5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5TeW1wdG9tLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJTeW1wdG9tIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnN5bXB0b21fU3ltcHRvbXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5TeW1wdG9tKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnN5bXB0b21fSW5jaWRlbnRzKHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdTeW1wdG9tJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlN5bXB0b20iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ1N5bXB0b20nCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qU3ltcHRvbSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypTeW1wdG9tKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbGVOYW1lKF9jbGFzcywgb2JqLCBlYUNvZGUpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiN2QxNTM2OGEtNDk4OC00MGQ3LWEwYTEtMTBkYjM4N2UwMDU3IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygic3ltcHRvbV9JbmNpZGVudHMiLCBvYmosIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzeW1wdG9tX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjdkMTUzNjhhLTQ5ODgtNDBkNy1hMGExLTEwZGIzODdlMDA1NyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygic3ltcHRvbV9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3ltcHRvbV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJLy8gTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInN5bXB0b20uaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnN5bXB0b21fSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3ltcHRvbV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TeW1wdG9tKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN5bXB0b20gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlN5bXB0b20oKQoKCQkJCQkuc3ltcHRvbV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiU3ltcHRvbSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouc3ltcHRvbV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zeW1wdG9tX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouc3ltcHRvbV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5zeW1wdG9tX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkgOiAic3ltcHRvbV9JbmNpZGVudHMiKSkgPT4gdGhpcy5zeW1wdG9tX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpIDogInN5bXB0b21fSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiU3ltcHRvbSIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LkluY2lkZW50ID0gY2xhc3MgSW5jaWRlbnQgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJc0tpNWZaMmwwYUhWaUluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibG9jYXRpb24iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2xvY2F0aW9uKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZ3JvdXAiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic3RhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3N0YXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic3ltcHRvbSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfc3ltcHRvbSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNsb3NlX3JlYXNvbiIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2xvc2VfcmVhc29uKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicHJpb3JpdHkiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3ByaW9yaXR5KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY2FsbGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jYWxsZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb250YWN0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb250YWN0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJJbmNpZGVudCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fbG9jYXRpb25fc2V0ICYmIHRoaXMuX2xvY2F0aW9uKSB0aGlzLl9sb2NhdGlvbi5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuX3N0YXRlKSB0aGlzLl9zdGF0ZS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fc3ltcHRvbV9zZXQgJiYgdGhpcy5fc3ltcHRvbSkgdGhpcy5fc3ltcHRvbS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiB0aGlzLl9jbG9zZV9yZWFzb24pIHRoaXMuX2Nsb3NlX3JlYXNvbi5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMuX3ByaW9yaXR5KSB0aGlzLl9wcmlvcml0eS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY2FsbGVyX3NldCAmJiB0aGlzLl9jYWxsZXIpIHRoaXMuX2NhbGxlci5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY29udGFjdF9zZXQgJiYgdGhpcy5fY29udGFjdCkgdGhpcy5fY29udGFjdC5Ub29sID0gdG9vbDsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uICoqLwoJbG9jYXRpb24odiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9sb2NhdGlvbl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImxvY2F0aW9uIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMjRkMWM3ODgtNGZhZS00MDI5LTg4NWYtZGQ5MjM3NjhmNzFmJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTG9jYXRpb24nKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb24nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICIyNGQxYzc4OC00ZmFlLTQwMjktODg1Zi1kZDkyMzc2OGY3MWYiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTG9jYXRpb24iKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbG9jYXRpb24gIT0gdikgewoJCQkJdGhpcy5fbG9jYXRpb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fbG9jYXRpb24gPyB0aGlzLl9sb2NhdGlvbi5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbG9jYXRpb25fc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2xvY2F0aW9uID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2xvY2F0aW9uKTsKCQl9Cgl9CgoJY2xlYXJfbG9jYXRpb24oKSB7CgkJdGhpcy5fbG9jYXRpb25fc2V0ID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbiA9IG51bGw7CgkJdGhpcy5fbG9jYXRpb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4NTExNGExNy0zNmMwLTQyMDktYTM4MS01Mjg5NzFlMDZlZGYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjg1MTE0YTE3LTM2YzAtNDIwOS1hMzgxLTUyODk3MWUwNmVkZiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZSAqKi8KCXN0YXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc3RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJzdGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzc2MDYyZjU4LTk0ODktNDA4NC04NjIzLTY5Y2ZmMzI0NjI5OScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1N0YXRlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNzYwNjJmNTgtOTQ4OS00MDg0LTg2MjMtNjljZmYzMjQ2Mjk5IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlN0YXRlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3N0YXRlICE9IHYpIHsKCQkJCXRoaXMuX3N0YXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3N0YXRlID8gdGhpcy5fc3RhdGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3N0YXRlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9zdGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zdGF0ZSk7CgkJfQoJfQoKCWNsZWFyX3N0YXRlKCkgewoJCXRoaXMuX3N0YXRlX3NldCA9IG51bGw7CgkJdGhpcy5fc3RhdGUgPSBudWxsOwoJCXRoaXMuX3N0YXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b20gKiovCglzeW1wdG9tKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc3ltcHRvbV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInN5bXB0b20iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc3ZDE1MzY4YS00OTg4LTQwZDctYTBhMS0xMGRiMzg3ZTAwNTcnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdTeW1wdG9tJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b20nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI3ZDE1MzY4YS00OTg4LTQwZDctYTBhMS0xMGRiMzg3ZTAwNTciLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiU3ltcHRvbSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9zeW1wdG9tICE9IHYpIHsKCQkJCXRoaXMuX3N5bXB0b21fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzeW1wdG9tJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9zeW1wdG9tID8gdGhpcy5fc3ltcHRvbS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fc3ltcHRvbV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fc3ltcHRvbSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zeW1wdG9tKTsKCQl9Cgl9CgoJY2xlYXJfc3ltcHRvbSgpIHsKCQl0aGlzLl9zeW1wdG9tX3NldCA9IG51bGw7CgkJdGhpcy5fc3ltcHRvbSA9IG51bGw7CgkJdGhpcy5fc3ltcHRvbV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbiAqKi8KCWNsb3NlX3JlYXNvbih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNsb3NlX3JlYXNvbiIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2NhNjFmYjhhLTg2OGUtNDQ5MC1hZWVjLWZhZjZjYzYyNjNiMCcgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1JlYXNvbicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb24nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJjYTYxZmI4YS04NjhlLTQ0OTAtYWVlYy1mYWY2Y2M2MjYzYjAiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiUmVhc29uIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2Nsb3NlX3JlYXNvbiAhPSB2KSB7CgkJCQl0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb24nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2Nsb3NlX3JlYXNvbiA/IHRoaXMuX2Nsb3NlX3JlYXNvbi5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY2xvc2VfcmVhc29uX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9jbG9zZV9yZWFzb24gPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY2xvc2VfcmVhc29uKTsKCQl9Cgl9CgoJY2xlYXJfY2xvc2VfcmVhc29uKCkgewoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPSBudWxsOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbiA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb24gKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eSAqKi8KCXByaW9yaXR5KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcHJpb3JpdHlfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwcmlvcml0eSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzU2YjE3MTFkLWY5ZTctNGU3Ni1iNzUwLTZlMjExMDZkNTA5MScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1ByaW9yaXR5JykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNTZiMTcxMWQtZjllNy00ZTc2LWI3NTAtNmUyMTEwNmQ1MDkxIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlByaW9yaXR5Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3ByaW9yaXR5ICE9IHYpIHsKCQkJCXRoaXMuX3ByaW9yaXR5X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHknLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3ByaW9yaXR5ID8gdGhpcy5fcHJpb3JpdHkuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3ByaW9yaXR5X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9wcmlvcml0eSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9wcmlvcml0eSk7CgkJfQoJfQoKCWNsZWFyX3ByaW9yaXR5KCkgewoJCXRoaXMuX3ByaW9yaXR5X3NldCA9IG51bGw7CgkJdGhpcy5fcHJpb3JpdHkgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlciAqKi8KCWNhbGxlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NhbGxlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNhbGxlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzcwZmExNzJkLTM3NGItNDI5NS05NWUyLWMzMzVhM2QxZGVhMicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2FsbGVyICE9IHYpIHsKCQkJCXRoaXMuX2NhbGxlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY2FsbGVyID8gdGhpcy5fY2FsbGVyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jYWxsZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2NhbGxlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jYWxsZXIpOwoJCX0KCX0KCgljbGVhcl9jYWxsZXIoKSB7CgkJdGhpcy5fY2FsbGVyX3NldCA9IG51bGw7CgkJdGhpcy5fY2FsbGVyID0gbnVsbDsKCQl0aGlzLl9jYWxsZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3QgKiovCgljb250YWN0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29udGFjdF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvbnRhY3QiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc3MGZhMTcyZC0zNzRiLTQyOTUtOTVlMi1jMzM1YTNkMWRlYTInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdVc2VyJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3QnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI3MGZhMTcyZC0zNzRiLTQyOTUtOTVlMi1jMzM1YTNkMWRlYTIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVXNlciIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb250YWN0ICE9IHYpIHsKCQkJCXRoaXMuX2NvbnRhY3Rfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jb250YWN0ID8gdGhpcy5fY29udGFjdC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY29udGFjdF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY29udGFjdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb250YWN0KTsKCQl9Cgl9CgoJY2xlYXJfY29udGFjdCgpIHsKCQl0aGlzLl9jb250YWN0X3NldCA9IG51bGw7CgkJdGhpcy5fY29udGFjdCA9IG51bGw7CgkJdGhpcy5fY29udGFjdF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2xvY2F0aW9uX3NldCwKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX3N0YXRlX3NldCwKCgkJCXRoaXMuX3N5bXB0b21fc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCwKCgkJCXRoaXMuX3ByaW9yaXR5X3NldCwKCgkJCXRoaXMuX2NhbGxlcl9zZXQsCgoJCQl0aGlzLl9jb250YWN0X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9sb2NhdGlvbl9zZXQgPSB0aGlzLl9sb2NhdGlvbl9zZXQ7CgkJcmV0Ll9sb2NhdGlvbl9jb29wID0gdGhpcy5fbG9jYXRpb25fY29vcDsKCQlyZXQubG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uKCkgPyB0aGlzLmxvY2F0aW9uKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMubG9jYXRpb24oKTsKCgkJcmV0Ll9ncm91cF9zZXQgPSB0aGlzLl9ncm91cF9zZXQ7CgkJcmV0Ll9ncm91cF9jb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQlyZXQuZ3JvdXAgPSB0aGlzLmdyb3VwKCkgPyB0aGlzLmdyb3VwKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZ3JvdXAoKTsKCgkJcmV0Ll9zdGF0ZV9zZXQgPSB0aGlzLl9zdGF0ZV9zZXQ7CgkJcmV0Ll9zdGF0ZV9jb29wID0gdGhpcy5fc3RhdGVfY29vcDsKCQlyZXQuc3RhdGUgPSB0aGlzLnN0YXRlKCkgPyB0aGlzLnN0YXRlKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuc3RhdGUoKTsKCgkJcmV0Ll9zeW1wdG9tX3NldCA9IHRoaXMuX3N5bXB0b21fc2V0OwoJCXJldC5fc3ltcHRvbV9jb29wID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCXJldC5zeW1wdG9tID0gdGhpcy5zeW1wdG9tKCkgPyB0aGlzLnN5bXB0b20oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zeW1wdG9tKCk7CgoJCXJldC5fY2xvc2VfcmVhc29uX3NldCA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQ7CgkJcmV0Ll9jbG9zZV9yZWFzb25fY29vcCA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wOwoJCXJldC5jbG9zZV9yZWFzb24gPSB0aGlzLmNsb3NlX3JlYXNvbigpID8gdGhpcy5jbG9zZV9yZWFzb24oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jbG9zZV9yZWFzb24oKTsKCgkJcmV0Ll9wcmlvcml0eV9zZXQgPSB0aGlzLl9wcmlvcml0eV9zZXQ7CgkJcmV0Ll9wcmlvcml0eV9jb29wID0gdGhpcy5fcHJpb3JpdHlfY29vcDsKCQlyZXQucHJpb3JpdHkgPSB0aGlzLnByaW9yaXR5KCkgPyB0aGlzLnByaW9yaXR5KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMucHJpb3JpdHkoKTsKCgkJcmV0Ll9jYWxsZXJfc2V0ID0gdGhpcy5fY2FsbGVyX3NldDsKCQlyZXQuX2NhbGxlcl9jb29wID0gdGhpcy5fY2FsbGVyX2Nvb3A7CgkJcmV0LmNhbGxlciA9IHRoaXMuY2FsbGVyKCkgPyB0aGlzLmNhbGxlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNhbGxlcigpOwoKCQlyZXQuX2NvbnRhY3Rfc2V0ID0gdGhpcy5fY29udGFjdF9zZXQ7CgkJcmV0Ll9jb250YWN0X2Nvb3AgPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJcmV0LmNvbnRhY3QgPSB0aGlzLmNvbnRhY3QoKSA/IHRoaXMuY29udGFjdCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNvbnRhY3QoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInN0YXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2xvc2VfcmVhc29uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInByaW9yaXR5IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJsb2NhdGlvbiIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgbG9jYXRpb24nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLmdyb3VwX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInN0YXRlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzdGF0ZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuU3RhdGUoKS5zdGF0ZV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJzeW1wdG9tIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzeW1wdG9tJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjbG9zZV9yZWFzb24iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNsb3NlX3JlYXNvbicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInByaW9yaXR5IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBwcmlvcml0eScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjYWxsZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNhbGxlcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVXNlcigpLmNhbGxlcl9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjb250YWN0IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjb250YWN0Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuY29udGFjdF9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJCWNhc2UgInRlc3RTeW5jIjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJpblByb2dyZXNzIjogewoKCQkJCQlkYXRhLnJlYXNvbiA9IGRhdGEucmVhc29uID8gZGF0YS5yZWFzb24KCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvSW5jaWRlbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAidGVzdFN5bmMiOiB7CgoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluUHJvZ3Jlc3MiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAidGVzdFN5bmMiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluUHJvZ3Jlc3MiOiB7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5yZWFzb24pOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBJbmNpZGVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYEluY2lkZW50Ll9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJJbmNpZGVudCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX2xvY2F0aW9uX3NldCAmJiB0aGlzLmxvY2F0aW9uKCkpIHRoaXMubG9jYXRpb24oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuZ3JvdXAoKSkgdGhpcy5ncm91cCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zdGF0ZV9zZXQgJiYgdGhpcy5zdGF0ZSgpKSB0aGlzLnN0YXRlKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3N5bXB0b21fc2V0ICYmIHRoaXMuc3ltcHRvbSgpKSB0aGlzLnN5bXB0b20oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiB0aGlzLmNsb3NlX3JlYXNvbigpKSB0aGlzLmNsb3NlX3JlYXNvbigpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQgJiYgdGhpcy5wcmlvcml0eSgpKSB0aGlzLnByaW9yaXR5KCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2NhbGxlcl9zZXQgJiYgdGhpcy5jYWxsZXIoKSkgdGhpcy5jYWxsZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fY29udGFjdF9zZXQgJiYgdGhpcy5jb250YWN0KCkpIHRoaXMuY29udGFjdCgpLl9fc3luY19vbihkKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuSW5jaWRlbnQodGhpcy5JZCkKCgkJCS5sb2NhdGlvbih0aGlzLmxvY2F0aW9uKCksIHRoaXMuX2xvY2F0aW9uX2Nvb3ApCgoJCQkuZ3JvdXAodGhpcy5ncm91cCgpLCB0aGlzLl9ncm91cF9jb29wKQoKCQkJLnN0YXRlKHRoaXMuc3RhdGUoKSwgdGhpcy5fc3RhdGVfY29vcCkKCgkJCS5zeW1wdG9tKHRoaXMuc3ltcHRvbSgpLCB0aGlzLl9zeW1wdG9tX2Nvb3ApCgoJCQkuY2xvc2VfcmVhc29uKHRoaXMuY2xvc2VfcmVhc29uKCksIHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wKQoKCQkJLnByaW9yaXR5KHRoaXMucHJpb3JpdHkoKSwgdGhpcy5fcHJpb3JpdHlfY29vcCkKCgkJCS5jYWxsZXIodGhpcy5jYWxsZXIoKSwgdGhpcy5fY2FsbGVyX2Nvb3ApCgoJCQkuY29udGFjdCh0aGlzLmNvbnRhY3QoKSwgdGhpcy5fY29udGFjdF9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdJbmNpZGVudCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKc2IyTmhkR2x2YmlJNklreHZZMkYwYVc5dUlpd2laM0p2ZFhBaU9pSkhjbTkxY0NJc0luTjBZWFJsSWpvaVUzUmhkR1VpTENKemVXMXdkRzl0SWpvaVUzbHRjSFJ2YlNJc0ltTnNiM05sWDNKbFlYTnZiaUk2SWxKbFlYTnZiaUlzSW5CeWFXOXlhWFI1SWpvaVVISnBiM0pwZEhraUxDSmpZV3hzWlhJaU9pSlZjMlZ5SWl3aVkyOXVkR0ZqZENJNklsVnpaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJJbmNpZGVudCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnSW5jaWRlbnQnCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIHRlc3RTeW5jLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIHRlc3RTeW5jKCkgewoKCQlsZXQgYW5zd2VyID0gbmV3IHNhbGVzbm93LkluY2lkZW50KCk7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInRlc3RTeW5jIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInRlc3RTeW5jIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidGVzdFN5bmMiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC50ZXN0U3luYycpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndGVzdFN5bmMnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsZXQgaW5jID0gYXdhaXQgbmV3IG9TY29wZS5JbmNpZGVudCgpLm51bWJlcigiSU5DMTIzNCIpLnRpdGxlKCJUZXN0aW5nIikuZ3JvdXAobmV3IG9TY29wZS5Hcm91cCgpLm5hbWUoIkdyb3VwMSIpKS5zdGF0ZShuZXcgb1Njb3BlLlN0YXRlKCkubmFtZSgiQXNzaWduZWQiKSkucHJpb3JpdHkobmV3IG9TY29wZS5Qcmlvcml0eSgpLm5hbWUoIkhpZ2giKS5jb2RlKCJQMSIpKS5jYWxsZXIobmV3IG9TY29wZS5Vc2VyKCkudXNlcm5hbWUoImZhZGkiKS5uYW1lKCJGYWRpIikpLnN0b3JlKCk7CgkJCWluYy5Ub29sID0gIk1vbmdvREIiOwoJCQlyZXR1cm4gYXdhaXQgaW5jLnN0b3JlKCk7CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGluUHJvZ3Jlc3MuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgaW5Qcm9ncmVzcyhyZWFzb24pIHsKCgkJbGV0IGFuc3dlciA9IGZhbHNlOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpblByb2dyZXNzIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluUHJvZ3Jlc3MiLCBfbm9kZSwgcmVhc29uKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpblByb2dyZXNzIiwgcmVhc29uKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuaW5Qcm9ncmVzcycpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5Qcm9ncmVzcycsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJcmVhc29uOiByZWFzb24KCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qSW5jaWRlbnQqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJzdGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImNsb3NlX3JlYXNvbiI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJwcmlvcml0eSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkluY2lkZW50Ki8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImxvY2F0aW9uIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5sb2NhdGlvbih0YWJsZVsibG9jYXRpb24iXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmdyb3VwKHRhYmxlWyJncm91cCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzdGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc3RhdGUodGFibGVbInN0YXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInN5bXB0b20iKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnN5bXB0b20odGFibGVbInN5bXB0b20iXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xvc2VfcmVhc29uIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jbG9zZV9yZWFzb24odGFibGVbImNsb3NlX3JlYXNvbiJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJwcmlvcml0eSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucHJpb3JpdHkodGFibGVbInByaW9yaXR5Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNhbGxlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2FsbGVyKHRhYmxlWyJjYWxsZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29udGFjdCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29udGFjdCh0YWJsZVsiY29udGFjdCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0xvY2F0aW9uJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTG9jYXRpb24nLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnR3JvdXAnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1N0YXRlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnU3RhdGUnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdTeW1wdG9tJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnU3ltcHRvbScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdSZWFzb24nLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdSZWFzb24nLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1ByaW9yaXR5JywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnUHJpb3JpdHknLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHsKCQkJCQkJCXF1ZXJ5OiByZXQKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYjNhMGIwMjAtOWMwMC00YmQwLWFkOTQtOTE2Mzg3OWI0ZGMwIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5sb2NhdGlvbigpIHx8ICh0aGlzLmxvY2F0aW9uKCkKCgkJCQkmJgoJCQkJIXRoaXMubG9jYXRpb24oKS5sb2NhdGlvbl9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImxvY2F0aW9uIiwgb2JqLCB0aGlzLmxvY2F0aW9uKCkpOwoJCX0KCgkJaWYgKCF0aGlzLmdyb3VwKCkgfHwgKHRoaXMuZ3JvdXAoKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImdyb3VwIiwgb2JqLCB0aGlzLmdyb3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnN0YXRlKCkgfHwgKHRoaXMuc3RhdGUoKQoKCQkJCSYmCgkJCQkhdGhpcy5zdGF0ZSgpLnN0YXRlX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygic3RhdGUiLCBvYmosIHRoaXMuc3RhdGUoKSk7CgkJfQoKCQlpZiAoIXRoaXMuc3ltcHRvbSgpIHx8ICh0aGlzLnN5bXB0b20oKQoKCQkJCSYmCgkJCQkhdGhpcy5zeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInN5bXB0b20iLCBvYmosIHRoaXMuc3ltcHRvbSgpKTsKCQl9CgoJCWlmICghdGhpcy5jbG9zZV9yZWFzb24oKSB8fCAodGhpcy5jbG9zZV9yZWFzb24oKQoKCQkJCSYmCgkJCQkhdGhpcy5jbG9zZV9yZWFzb24oKS5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJjbG9zZV9yZWFzb24iLCBvYmosIHRoaXMuY2xvc2VfcmVhc29uKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnByaW9yaXR5KCkgfHwgKHRoaXMucHJpb3JpdHkoKQoKCQkJCSYmCgkJCQkhdGhpcy5wcmlvcml0eSgpLnByaW9yaXR5X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicHJpb3JpdHkiLCBvYmosIHRoaXMucHJpb3JpdHkoKSk7CgkJfQoKCQlpZiAoIXRoaXMuY2FsbGVyKCkgfHwgKHRoaXMuY2FsbGVyKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2FsbGVyKCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLmNvbnRhY3RfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2FsbGVyIiwgb2JqLCB0aGlzLmNhbGxlcigpKTsKCQl9CgoJCWlmICghdGhpcy5jb250YWN0KCkgfHwgKHRoaXMuY29udGFjdCgpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJjb250YWN0Iiwgb2JqLCB0aGlzLmNvbnRhY3QoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydsb2NhdGlvbicsICdncm91cCcsICdzdGF0ZScsICdzeW1wdG9tJywgJ2Nsb3NlX3JlYXNvbicsICdwcmlvcml0eScsICdjYWxsZXInLCAnY29udGFjdCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYjNhMGIwMjAtOWMwMC00YmQwLWFkOTQtOTE2Mzg3OWI0ZGMwIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImxvY2F0aW9uIiwgb2JqKTsKCgkJX29wdGlvbnMoImdyb3VwIiwgb2JqKTsKCgkJX29wdGlvbnMoInN0YXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoInN5bXB0b20iLCBvYmopOwoKCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uIiwgb2JqKTsKCgkJX29wdGlvbnMoInByaW9yaXR5Iiwgb2JqKTsKCgkJX29wdGlvbnMoImNhbGxlciIsIG9iaik7CgoJCV9vcHRpb25zKCJjb250YWN0Iiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbG9jYXRpb24nLCAnZ3JvdXAnLCAnc3RhdGUnLCAnc3ltcHRvbScsICdjbG9zZV9yZWFzb24nLCAncHJpb3JpdHknLCAnY2FsbGVyJywgJ2NvbnRhY3QnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibG9jYXRpb24iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbG9jYXRpb25fc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmxvY2F0aW9uKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZ3JvdXBfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmdyb3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3RhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc3RhdGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnN0YXRlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3ltcHRvbSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9zeW1wdG9tX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zeW1wdG9tKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbG9zZV9yZWFzb24iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jbG9zZV9yZWFzb24oKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicHJpb3JpdHkiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcHJpb3JpdHlfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnByaW9yaXR5KCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2FsbGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NhbGxlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY2FsbGVyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRhY3QiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29udGFjdF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29udGFjdCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubG9jYXRpb24pIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3RhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3ltcHRvbSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsb3NlX3JlYXNvbikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucHJpb3JpdHkpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2FsbGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb250YWN0KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWxvY2F0aW9uOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5sb2NhdGlvbihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWdyb3VwOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5ncm91cChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXN0YXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zdGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc3ltcHRvbShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNsb3NlX3JlYXNvbihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXByaW9yaXR5OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wcmlvcml0eShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNhbGxlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29udGFjdChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJLy8gTnVsbDogdHJ1ZSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5sb2NhdGlvbikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubG9jYXRpb259KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc3RhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnN0YXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zeW1wdG9tKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zeW1wdG9tfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNsb3NlX3JlYXNvbikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xvc2VfcmVhc29ufSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucHJpb3JpdHkpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnByaW9yaXR5fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jYWxsZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhbGxlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvbnRhY3QpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvbnRhY3R9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbG9jYXRpb25fc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9sb2NhdGlvbl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zdGF0ZV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3N0YXRlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3N5bXB0b21fc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9zeW1wdG9tX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jbG9zZV9yZWFzb25fc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jbG9zZV9yZWFzb25fY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9wcmlvcml0eV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3ByaW9yaXR5X2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jYWxsZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jYWxsZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29udGFjdF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2NvbnRhY3RfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmxvY2F0aW9uKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5sb2NhdGlvbn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ncm91cCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXB9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3RhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnN0YXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnN5bXB0b20pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc3ltcHRvbX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jbG9zZV9yZWFzb24pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jbG9zZV9yZWFzb259YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucHJpb3JpdHkpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnByaW9yaXR5fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNhbGxlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNhbGxlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb250YWN0KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvbnRhY3R9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IG9iai5sb2NhdGlvbiA9IHYuX3RvUGF0aHMoKSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiBvYmouZ3JvdXAgPSB2Ll90b1BhdGhzKCksCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN0YXRlID0gdi5fdG9QYXRocygpLAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiBvYmouc3ltcHRvbSA9IHYuX3RvUGF0aHMoKSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IG9iai5jbG9zZV9yZWFzb24gPSB2Ll90b1BhdGhzKCksCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gb2JqLnByaW9yaXR5ID0gdi5fdG9QYXRocygpLAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNhbGxlciA9IHYuX3RvUGF0aHMoKSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gb2JqLmNvbnRhY3QgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuSW5jaWRlbnQpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuSW5jaWRlbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LkluY2lkZW50KCkKCgkJCQkJLmxvY2F0aW9uKG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpKQoKCQkJCQkuZ3JvdXAobmV3IHNhbGVzbm93Lkdyb3VwKCkpCgoJCQkJCS5zdGF0ZShuZXcgc2FsZXNub3cuU3RhdGUoKSkKCgkJCQkJLnN5bXB0b20obmV3IHNhbGVzbm93LlN5bXB0b20oKSkKCgkJCQkJLmNsb3NlX3JlYXNvbihuZXcgc2FsZXNub3cuUmVhc29uKCkpCgoJCQkJCS5wcmlvcml0eShuZXcgc2FsZXNub3cuUHJpb3JpdHkoKSkKCgkJCQkJLmNhbGxlcihuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuY29udGFjdChuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkluY2lkZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWxvY2F0aW9uOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5sb2NhdGlvbiA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubG9jYXRpb24oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbG9jYXRpb25fc2V0ICYmICFxdWVyeS5fbG9jYXRpb25fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmxvY2F0aW9uID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2xvY2F0aW9uX3NldCAmJiBxdWVyeS5fbG9jYXRpb25fc2V0KSB8fAoKCQkJCQkJKHRoaXMubG9jYXRpb24oKSAmJiAhdGhpcy5sb2NhdGlvbigpLl9tYXRjaGVzKHF1ZXJ5LmxvY2F0aW9uKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5sb2NhdGlvbiA9IGZhbHNlOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnN0YXRlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5zdGF0ZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zdGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9zdGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3RhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc3RhdGVfc2V0ICYmIHF1ZXJ5Ll9zdGF0ZV9zZXQpIHx8CgoJCQkJCQkodGhpcy5zdGF0ZSgpICYmICF0aGlzLnN0YXRlKCkuX21hdGNoZXMocXVlcnkuc3RhdGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN0YXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnN5bXB0b20gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnN5bXB0b20oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc3ltcHRvbV9zZXQgJiYgIXF1ZXJ5Ll9zeW1wdG9tX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zeW1wdG9tID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3N5bXB0b21fc2V0ICYmIHF1ZXJ5Ll9zeW1wdG9tX3NldCkgfHwKCgkJCQkJCSh0aGlzLnN5bXB0b20oKSAmJiAhdGhpcy5zeW1wdG9tKCkuX21hdGNoZXMocXVlcnkuc3ltcHRvbSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3ltcHRvbSA9IGZhbHNlOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNsb3NlX3JlYXNvbiA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY2xvc2VfcmVhc29uKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgIXF1ZXJ5Ll9jbG9zZV9yZWFzb25fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsb3NlX3JlYXNvbiA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jbG9zZV9yZWFzb25fc2V0ICYmIHF1ZXJ5Ll9jbG9zZV9yZWFzb25fc2V0KSB8fAoKCQkJCQkJKHRoaXMuY2xvc2VfcmVhc29uKCkgJiYgIXRoaXMuY2xvc2VfcmVhc29uKCkuX21hdGNoZXMocXVlcnkuY2xvc2VfcmVhc29uKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbG9zZV9yZWFzb24gPSBmYWxzZTsKCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnByaW9yaXR5ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5wcmlvcml0eSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wcmlvcml0eV9zZXQgJiYgIXF1ZXJ5Ll9wcmlvcml0eV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucHJpb3JpdHkgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcHJpb3JpdHlfc2V0ICYmIHF1ZXJ5Ll9wcmlvcml0eV9zZXQpIHx8CgoJCQkJCQkodGhpcy5wcmlvcml0eSgpICYmICF0aGlzLnByaW9yaXR5KCkuX21hdGNoZXMocXVlcnkucHJpb3JpdHkoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnByaW9yaXR5ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY2FsbGVyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jYWxsZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2FsbGVyX3NldCAmJiAhcXVlcnkuX2NhbGxlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FsbGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NhbGxlcl9zZXQgJiYgcXVlcnkuX2NhbGxlcl9zZXQpIHx8CgoJCQkJCQkodGhpcy5jYWxsZXIoKSAmJiAhdGhpcy5jYWxsZXIoKS5fbWF0Y2hlcyhxdWVyeS5jYWxsZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhbGxlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb250YWN0ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jb250YWN0KCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvbnRhY3Rfc2V0ICYmICFxdWVyeS5fY29udGFjdF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGFjdCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb250YWN0X3NldCAmJiBxdWVyeS5fY29udGFjdF9zZXQpIHx8CgoJCQkJCQkodGhpcy5jb250YWN0KCkgJiYgIXRoaXMuY29udGFjdCgpLl9tYXRjaGVzKHF1ZXJ5LmNvbnRhY3QoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRhY3QgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb246IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBsb2NhdGlvbiIpOwoJCQkJCW9iai5sb2NhdGlvbiA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZ3JvdXAiKTsKCQkJCQlvYmouZ3JvdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHN0YXRlIik7CgkJCQkJb2JqLnN0YXRlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHN5bXB0b20iKTsKCQkJCQlvYmouc3ltcHRvbSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNsb3NlX3JlYXNvbiIpOwoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHByaW9yaXR5Iik7CgkJCQkJb2JqLnByaW9yaXR5ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgY2FsbGVyIik7CgkJCQkJb2JqLmNhbGxlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjb250YWN0Iik7CgkJCQkJb2JqLmNvbnRhY3QgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9sb2NhdGlvbl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9ncm91cF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zdGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zeW1wdG9tX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wcmlvcml0eV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jYWxsZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29udGFjdF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMubG9jYXRpb24ocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZ3JvdXAocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXN0YXRlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuc3RhdGUocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5zeW1wdG9tKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5jbG9zZV9yZWFzb24ocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXByaW9yaXR5OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucHJpb3JpdHkocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNhbGxlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJY29udGFjdDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNvbnRhY3QocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgOiAibG9jYXRpb24iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbG9jYXRpb25fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubG9jYXRpb24oKSB8fCBuZXcgc2FsZXNub3cuTG9jYXRpb24oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmxvY2F0aW9uKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgbG9jYXRpb24iLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lkdyb3VwKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ncm91cChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGdyb3VwIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSA6ICJzdGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zdGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zdGF0ZSgpIHx8IG5ldyBzYWxlc25vdy5TdGF0ZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuc3RhdGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBzdGF0ZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpIDogInN5bXB0b20iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fc3ltcHRvbV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zeW1wdG9tKCkgfHwgbmV3IHNhbGVzbm93LlN5bXB0b20oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnN5bXB0b20ob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBzeW1wdG9tIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbiIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jbG9zZV9yZWFzb25fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuY2xvc2VfcmVhc29uKCkgfHwgbmV3IHNhbGVzbm93LlJlYXNvbigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2xvc2VfcmVhc29uKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY2xvc2VfcmVhc29uIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wcmlvcml0eV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5wcmlvcml0eSgpIHx8IG5ldyBzYWxlc25vdy5Qcmlvcml0eSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMucHJpb3JpdHkob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBwcmlvcml0eSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSA6ICJjYWxsZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2FsbGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNhbGxlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5jYWxsZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBjYWxsZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSA6ICJjb250YWN0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvbnRhY3RfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuY29udGFjdCgpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5jb250YWN0KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY29udGFjdCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJsb2NhdGlvbiI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgOiAibG9jYXRpb24iKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbG9jYXRpb25fY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ncm91cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzdGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgOiAic3RhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9zdGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzeW1wdG9tIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpIDogInN5bXB0b20iKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9zeW1wdG9tX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zeW1wdG9tX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY2xvc2VfcmVhc29uIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbG9zZV9yZWFzb25fY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwcmlvcml0eSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgOiAicHJpb3JpdHkiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcHJpb3JpdHlfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjYWxsZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSA6ICJjYWxsZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jYWxsZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NhbGxlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgOiAiY29udGFjdCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2NvbnRhY3RfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvbnRhY3RfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5TG9jYXRpb24oYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2xvY2F0aW9uIl0gJiYgKGFbIl9sb2NhdGlvbiJdLkVxdWFscyA/IGFbIl9sb2NhdGlvbiJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfbG9jYXRpb24iXSwgcikpKSB7CgkJCQkJci5fbG9jYXRpb25fSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlHcm91cChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfZ3JvdXAiXSAmJiAoYVsiX2dyb3VwIl0uRXF1YWxzID8gYVsiX2dyb3VwIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ncm91cCJdLCByKSkpIHsKCQkJCQlyLl9ncm91cF9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVN0YXRlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9zdGF0ZSJdICYmIChhWyJfc3RhdGUiXS5FcXVhbHMgPyBhWyJfc3RhdGUiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3N0YXRlIl0sIHIpKSkgewoJCQkJCXIuX3N0YXRlX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5U3ltcHRvbShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfc3ltcHRvbSJdICYmIChhWyJfc3ltcHRvbSJdLkVxdWFscyA/IGFbIl9zeW1wdG9tIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9zeW1wdG9tIl0sIHIpKSkgewoJCQkJCXIuX3N5bXB0b21fSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlSZWFzb24oYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2Nsb3NlX3JlYXNvbiJdICYmIChhWyJfY2xvc2VfcmVhc29uIl0uRXF1YWxzID8gYVsiX2Nsb3NlX3JlYXNvbiJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY2xvc2VfcmVhc29uIl0sIHIpKSkgewoJCQkJCXIuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVByaW9yaXR5KGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9wcmlvcml0eSJdICYmIChhWyJfcHJpb3JpdHkiXS5FcXVhbHMgPyBhWyJfcHJpb3JpdHkiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3ByaW9yaXR5Il0sIHIpKSkgewoJCQkJCXIuX3ByaW9yaXR5X0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5VXNlcihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfY2FsbGVyIl0gJiYgKGFbIl9jYWxsZXIiXS5FcXVhbHMgPyBhWyJfY2FsbGVyIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9jYWxsZXIiXSwgcikpKSB7CgkJCQkJci5fY2FsbGVyX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5VXNlcihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfY29udGFjdCJdICYmIChhWyJfY29udGFjdCJdLkVxdWFscyA/IGFbIl9jb250YWN0Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9jb250YWN0Il0sIHIpKSkgewoJCQkJCXIuX2NvbnRhY3RfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAodGhpcy5fX2NvbmZpZygnc3RvcmUuZGlzYWJsZWQnKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0b3JpbmcgZGlzYWJsZWQiKTsKCQkJfSBlbHNlIGlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpICYmICEoYXdhaXQgdGhpcy5sb2NhdGlvbigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2xvY2F0aW9uKCk7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpICYmICEoYXdhaXQgdGhpcy5ncm91cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCQkJCWlmICh0aGlzLl9zdGF0ZV9zZXQgJiYgdGhpcy5zdGF0ZSgpICYmICEoYXdhaXQgdGhpcy5zdGF0ZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3N0YXRlKCk7CgoJCQkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSAmJiAhKGF3YWl0IHRoaXMuc3ltcHRvbSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3N5bXB0b20oKTsKCgkJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSAmJiAhKGF3YWl0IHRoaXMuY2xvc2VfcmVhc29uKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY2xvc2VfcmVhc29uKCk7CgoJCQkJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQgJiYgdGhpcy5wcmlvcml0eSgpICYmICEoYXdhaXQgdGhpcy5wcmlvcml0eSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3ByaW9yaXR5KCk7CgoJCQkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkgJiYgIShhd2FpdCB0aGlzLmNhbGxlcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2NhbGxlcigpOwoKCQkJCQlpZiAodGhpcy5fY29udGFjdF9zZXQgJiYgdGhpcy5jb250YWN0KCkgJiYgIShhd2FpdCB0aGlzLmNvbnRhY3QoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jb250YWN0KCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9LCBJZDpbJHt0aGlzLklkfV1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQpIHsKCgkJCQkJb2JqLmxvY2F0aW9uID0gdGhpcy5fbG9jYXRpb24uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9ncm91cF9zZXQpIHsKCgkJCQkJb2JqLmdyb3VwID0gdGhpcy5fZ3JvdXAuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zdGF0ZV9zZXQpIHsKCgkJCQkJb2JqLnN0YXRlID0gdGhpcy5fc3RhdGUuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCkgewoKCQkJCQlvYmouc3ltcHRvbSA9IHRoaXMuX3N5bXB0b20uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fc2V0KSB7CgoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB0aGlzLl9jbG9zZV9yZWFzb24uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQpIHsKCgkJCQkJb2JqLnByaW9yaXR5ID0gdGhpcy5fcHJpb3JpdHkuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jYWxsZXJfc2V0KSB7CgoJCQkJCW9iai5jYWxsZXIgPSB0aGlzLl9jYWxsZXIuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb250YWN0X3NldCkgewoKCQkJCQlvYmouY29udGFjdCA9IHRoaXMuX2NvbnRhY3QuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiSW5jaWRlbnQiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5TdGF0ZSA9IGNsYXNzIFN0YXRlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSXNLaTVmWjJsMGFIVmlJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfc3RhdGVfSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiU3RhdGUiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLnN0YXRlX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZV9JbmNpZGVudHMgKiovCglzdGF0ZV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3N0YXRlX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnYjNhMGIwMjAtOWMwMC00YmQwLWFkOTQtOTE2Mzg3OWI0ZGMwJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fc3RhdGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGVfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdGF0ZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdGF0ZV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0YXRlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc3RhdGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3N0YXRlX0luY2lkZW50cygpIHsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQuc3RhdGVfSW5jaWRlbnRzID0gdGhpcy5zdGF0ZV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9TdGF0ZS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN0YXRlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgU3RhdGUuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlN0YXRlIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnN0YXRlX1N0YXRlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlN0YXRlKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnN0YXRlX0luY2lkZW50cyh0aGlzLnN0YXRlX0luY2lkZW50cygpLCB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdTdGF0ZSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJTdGF0ZSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnU3RhdGUnCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qU3RhdGUqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qU3RhdGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3NjA2MmY1OC05NDg5LTQwODQtODYyMy02OWNmZjMyNDYyOTkiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInN0YXRlX0luY2lkZW50cyIsIG9iaiwgdGhpcy5zdGF0ZV9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzdGF0ZV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3NjA2MmY1OC05NDg5LTQwODQtODYyMy02OWNmZjMyNDYyOTkiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygic3RhdGVfSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N0YXRlX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXJldHVybiBfbyA/IF9xIDogX287Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkvLyBOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInN0YXRlLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnN0YXRlX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN0YXRlX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5TdGF0ZSgpCgoJCQkJCS5zdGF0ZV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiU3RhdGUiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zdGF0ZV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3RhdGVfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcsIHsKCQkJCQl0b29sOiBvYmouX190b29sCgkJCQl9KV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSA6ICJzdGF0ZV9JbmNpZGVudHMiKSkgPT4gdGhpcy5zdGF0ZV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSA6ICJzdGF0ZV9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnN0YXRlX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiU3RhdGUiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gW2F3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpKV07CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5maWx0ZXIociA9PiByKS5tYXAociA9PiBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Hcm91cCA9IGNsYXNzIEdyb3VwIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1zS2k1ZlptbHNaWE41YzNSbGJTd3FMbDl6WlhKMlpYSXNLaTVmWjJsMGFIVmlJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX2dyb3VwX0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX2dyb3VwX0dyb3VwX01lbWJlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJHcm91cCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoJb3BlbkluY2lkZW50VGhyZWFzaG9sZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCAhPSB2KSB7CgkJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQpOwoJCX0KCX0KCgljbGVhcl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkgewoJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoJZ3JvdXBfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ncm91cF9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2IzYTBiMDIwLTljMDAtNGJkMC1hZDk0LTkxNjM4NzliNGRjMCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2dyb3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lmdyb3VwKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2dyb3VwX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ncm91cF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCWdyb3VwX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzBlNzdmNzIxLWYzYjEtNDUxMS04Zjc2LTUwNTg2NDczYTA2MycgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ncm91cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZ3JvdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVycy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2dyb3VwX0dyb3VwX01lbWJlcnMoKSB7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQ7CgkJcmV0Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3A7CgkJcmV0Lm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSA/IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpIDogdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ncm91cF9JbmNpZGVudHMgPSB0aGlzLmdyb3VwX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0Lmdyb3VwX0dyb3VwX01lbWJlcnMgPSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCAiRXZlbnQgY2Fubm90IGJlIGRlZmluZWQgd2l0aG91dCB0aGUgRXZlbnQgY2xhc3MiKTsKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvR3JvdXAvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBHcm91cC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYEdyb3VwLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJHcm91cCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5ncm91cF9Hcm91cHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5ncm91cF9Hcm91cHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Hcm91cCh0aGlzLklkKQoKCQkJLm9wZW5JbmNpZGVudFRocmVhc2hvbGQodGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCksIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZ3JvdXBfSW5jaWRlbnRzKHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCksIHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wKQoKCQkJLmdyb3VwX0dyb3VwX01lbWJlcnModGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdHcm91cCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJHcm91cCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHsKCQkJX3RoaXM6IHRoaXMsCgkJCXRvb2w6IHRoaXMuVG9vbCwKCQkJX2NsYXNzOiAnR3JvdXAnCgkJfSwgb3B0aW9ucyB8fCB7fSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypHcm91cCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQodGFibGVbIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbnRlbnQoKS5fZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KTsKCgl9CgoJX2ZpbGVOYW1lKF9jbGFzcyA9IHRoaXMuX25Db2RlKCksIG9iaiA9IHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSksIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmlsZU5hbWUoX2NsYXNzLCBvYmosIGVhQ29kZSk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIiwgb2JqLCB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiODUxMTRhMTctMzZjMC00MjA5LWEzODEtNTI4OTcxZTA2ZWRmIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJncm91cF9JbmNpZGVudHMiLCBvYmosIHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkpOwoKCQlfb3B0aW9ucygiZ3JvdXBfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydncm91cF9JbmNpZGVudHMnLCAnZ3JvdXBfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiODUxMTRhMTctMzZjMC00MjA5LWEzODEtNTI4OTcxZTA2ZWRmIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImdyb3VwX0luY2lkZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJncm91cF9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZ3JvdXBfSW5jaWRlbnRzJywgJ2dyb3VwX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQlyZXR1cm4gX28gPyBfcSA6IF9vOwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9wZW5JbmNpZGVudFRocmVhc2hvbGR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImdyb3VwLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmdyb3VwX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJncm91cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICchPScgfHwgdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmdyb3VwX0dyb3VwX01lbWJlcnMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9wZW5JbmNpZGVudFRocmVhc2hvbGR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cF9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXApIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXAgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkKCgkJCQkJLmdyb3VwX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLmdyb3VwX0dyb3VwX01lbWJlcnMobmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkdyb3VwIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB2ID09IHF1ZXJ5Lm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgJiYgIXF1ZXJ5Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ICYmIHF1ZXJ5Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5Lmdyb3VwX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IHF1ZXJ5Lmdyb3VwX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmdyb3VwX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSA6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQocmVmKTsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0luY2lkZW50cyIpKSA9PiB0aGlzLmdyb3VwX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkib3BlbkluY2lkZW50VGhyZWFzaG9sZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSA6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Hcm91cF9NZW1iZXJzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIHRoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmdyb3VwX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHsKCgkJCQkJb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJHcm91cCIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yih0aGlzLl9maWxlTmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBbYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCkpXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0LmZpbHRlcihyID0+IHIpLm1hcChyID0+IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lkdyb3VwX01lbWJlciA9IGNsYXNzIEdyb3VwX01lbWJlciBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNc0tpNWZabWxzWlhONWMzUmxiU3dxTGw5elpYSjJaWElzS2k1ZloybDBhSFZpSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ1c2VyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl91c2VyKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiR3JvdXAgTWVtYmVyIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5fZ3JvdXApIHRoaXMuX2dyb3VwLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl91c2VyX3NldCAmJiB0aGlzLl91c2VyKSB0aGlzLl91c2VyLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4NTExNGExNy0zNmMwLTQyMDktYTM4MS01Mjg5NzFlMDZlZGYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjg1MTE0YTE3LTM2YzAtNDIwOS1hMzgxLTUyODk3MWUwNmVkZiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyICoqLwoJdXNlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ1c2VyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNzBmYTE3MmQtMzc0Yi00Mjk1LTk1ZTItYzMzNWEzZDFkZWEyIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdXNlciAhPSB2KSB7CgkJCQl0aGlzLl91c2VyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdXNlciA/IHRoaXMuX3VzZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3VzZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3VzZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcik7CgkJfQoJfQoKCWNsZWFyX3VzZXIoKSB7CgkJdGhpcy5fdXNlcl9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXIgPSBudWxsOwoJCXRoaXMuX3VzZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXIgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl91c2VyX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3VzZXJfc2V0ID0gdGhpcy5fdXNlcl9zZXQ7CgkJcmV0Ll91c2VyX2Nvb3AgPSB0aGlzLl91c2VyX2Nvb3A7CgkJcmV0LnVzZXIgPSB0aGlzLnVzZXIoKSA/IHRoaXMudXNlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnVzZXIoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJncm91cCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZ3JvdXAnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInVzZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHVzZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsICJFdmVudCBjYW5ub3QgYmUgZGVmaW5lZCB3aXRob3V0IHRoZSBFdmVudCBjbGFzcyIpOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Hcm91cF9NZW1iZXIvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEdyb3VwX01lbWJlci5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYEdyb3VwX01lbWJlci5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJHcm91cCBNZW1iZXIiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpKSB0aGlzLnVzZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcih0aGlzLklkKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS51c2VyKHRoaXMudXNlcigpLCB0aGlzLl91c2VyX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnR3JvdXBfTWVtYmVyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpuY205MWNDSTZJa2R5YjNWd0lpd2lkWE5sY2lJNklsVnpaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJHcm91cF9NZW1iZXIiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7CgkJCV90aGlzOiB0aGlzLAoJCQl0b29sOiB0aGlzLlRvb2wsCgkJCV9jbGFzczogJ0dyb3VwX01lbWJlcicKCQl9LCBvcHRpb25zIHx8IHt9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qR3JvdXBfTWVtYmVyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwX01lbWJlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZ3JvdXAodGFibGVbImdyb3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnVzZXIodGFibGVbInVzZXIiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Db250ZW50KCkuX2ZpbGVzeXN0ZW0oZmlsZSwgY29udGVudCk7CgoJfQoKCV9maWxlTmFtZShfY2xhc3MgPSB0aGlzLl9uQ29kZSgpLCBvYmogPSB0aGlzLl90b0RvY3VtZW50KHRydWUpLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnR3JvdXAnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogewoJCQkJCQkJcXVlcnk6IHJldAoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIwZTc3ZjcyMS1mM2IxLTQ1MTEtOGY3Ni01MDU4NjQ3M2EwNjMiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuZ3JvdXAoKSB8fCAodGhpcy5ncm91cCgpCgoJCQkJJiYKCQkJCSF0aGlzLmdyb3VwKCkuZ3JvdXBfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiZ3JvdXAiLCBvYmosIHRoaXMuZ3JvdXAoKSk7CgkJfQoKCQlpZiAoIXRoaXMudXNlcigpIHx8ICh0aGlzLnVzZXIoKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygidXNlciIsIG9iaiwgdGhpcy51c2VyKCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAndXNlciddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjBlNzdmNzIxLWYzYjEtNDUxMS04Zjc2LTUwNTg2NDczYTA2MyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImdyb3VwIiwgb2JqKTsKCgkJX29wdGlvbnMoInVzZXIiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydncm91cCcsICd1c2VyJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZ3JvdXBfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmdyb3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidXNlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl91c2VyX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy51c2VyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSArICIuaWQiXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudXNlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlncm91cDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZ3JvdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnVzZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXB9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZ3JvdXBfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VyX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fdXNlcl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudXNlcn1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwID0gdi5fdG9QYXRocygpLAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiBvYmoudXNlciA9IHYuX3RvUGF0aHMoKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXBfTWVtYmVyID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKQoKCQkJCQkuZ3JvdXAobmV3IHNhbGVzbm93Lkdyb3VwKCkpCgoJCQkJCS51c2VyKG5ldyBzYWxlc25vdy5Vc2VyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiR3JvdXAgTWVtYmVyIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5ncm91cCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuZ3JvdXAoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZ3JvdXBfc2V0ICYmICFxdWVyeS5fZ3JvdXBfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2dyb3VwX3NldCAmJiBxdWVyeS5fZ3JvdXBfc2V0KSB8fAoKCQkJCQkJKHRoaXMuZ3JvdXAoKSAmJiAhdGhpcy5ncm91cCgpLl9tYXRjaGVzKHF1ZXJ5Lmdyb3VwKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IGZhbHNlOwoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai51c2VyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS51c2VyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3VzZXJfc2V0ICYmICFxdWVyeS5fdXNlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl91c2VyX3NldCAmJiBxdWVyeS5fdXNlcl9zZXQpIHx8CgoJCQkJCQkodGhpcy51c2VyKCkgJiYgIXRoaXMudXNlcigpLl9tYXRjaGVzKHF1ZXJ5LnVzZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGdyb3VwIik7CgkJCQkJb2JqLmdyb3VwID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHVzZXIiKTsKCQkJCQlvYmoudXNlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2dyb3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3VzZXJfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZ3JvdXAocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXVzZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy51c2VyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnLCB7CgkJCQkJdG9vbDogb2JqLl9fdG9vbAoJCQkJfSldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lkdyb3VwKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ncm91cChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGdyb3VwIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkgOiAidXNlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl91c2VyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnVzZXIoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudXNlcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHVzZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidXNlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSA6ICJ1c2VyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdXNlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdXNlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlHcm91cChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfZ3JvdXAiXSAmJiAoYVsiX2dyb3VwIl0uRXF1YWxzID8gYVsiX2dyb3VwIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ncm91cCJdLCByKSkpIHsKCQkJCQlyLl9ncm91cF9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl91c2VyIl0gJiYgKGFbIl91c2VyIl0uRXF1YWxzID8gYVsiX3VzZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3VzZXIiXSwgcikpKSB7CgkJCQkJci5fdXNlcl9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLklkOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ3N0b3JlLmRpc2FibGVkJykpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdG9yaW5nIGRpc2FibGVkIik7CgkJCX0gZWxzZSBpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmdyb3VwKHRoaXMuZ3JvdXAoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VyKHRoaXMudXNlcigpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpICYmICEoYXdhaXQgdGhpcy51c2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdXNlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSwgSWQ6WyR7dGhpcy5JZH1dYCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCkgewoKCQkJCQlvYmouZ3JvdXAgPSB0aGlzLl9ncm91cC5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3VzZXJfc2V0KSB7CgoJCQkJCW9iai51c2VyID0gdGhpcy5fdXNlci5JZDsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkdyb3VwX01lbWJlciIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LkxvY2F0aW9uID0gY2xhc3MgTG9jYXRpb24gZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITXNLaTVmWm1sc1pYTjVjM1JsYlN3cUxsOXpaWEoyWlhJc0tpNWZaMmwwYUhWaUluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9sb2NhdGlvbl9JbmNpZGVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJMb2NhdGlvbiIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uX0luY2lkZW50cyAqKi8KCWxvY2F0aW9uX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdiM2EwYjAyMC05YzAwLTRiZDAtYWQ5NC05MTYzODc5YjRkYzAnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9sb2NhdGlvbl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImxvY2F0aW9uIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAibG9jYXRpb24gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5sb2NhdGlvbih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfbG9jYXRpb25fSW5jaWRlbnRzKCkgewoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uX0luY2lkZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5sb2NhdGlvbl9JbmNpZGVudHMgPSB0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgIkV2ZW50IGNhbm5vdCBiZSBkZWZpbmVkIHdpdGhvdXQgdGhlIEV2ZW50IGNsYXNzIik7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0xvY2F0aW9uLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTG9jYXRpb24uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBMb2NhdGlvbi5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbi5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTG9jYXRpb24iKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMubG9jYXRpb25fTG9jYXRpb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuTG9jYXRpb24odGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCksIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0xvY2F0aW9uJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkxvY2F0aW9uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oewoJCQlfdGhpczogdGhpcywKCQkJdG9vbDogdGhpcy5Ub29sLAoJCQlfY2xhc3M6ICdMb2NhdGlvbicKCQl9LCBvcHRpb25zIHx8IHt9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypMb2NhdGlvbiovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypMb2NhdGlvbiovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZmlsZXN5c3RlbShmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuQ29udGVudCgpLl9maWxlc3lzdGVtKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfZmlsZU5hbWUoX2NsYXNzID0gdGhpcy5fbkNvZGUoKSwgb2JqID0gdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9maWxlTmFtZShfY2xhc3MsIG9iaiwgZWFDb2RlKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiB7CgkJCQkJCQlxdWVyeTogcmV0CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjI0ZDFjNzg4LTRmYWUtNDAyOS04ODVmLWRkOTIzNzY4ZjcxZiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygibG9jYXRpb25fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2xvY2F0aW9uX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjI0ZDFjNzg4LTRmYWUtNDAyOS04ODVmLWRkOTIzNzY4ZjcxZiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJcmV0dXJuIF9vID8gX3EgOiBfbzsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCS8vIE51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgibG9jYXRpb24uaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qbG9jYXRpb25fSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiBvYmoubG9jYXRpb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24pIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkKCgkJCQkJLmxvY2F0aW9uX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJMb2NhdGlvbiIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmxvY2F0aW9uX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJywgewoJCQkJCXRvb2w6IG9iai5fX3Rvb2wKCQkJCX0pXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB0aGlzLmxvY2F0aW9uX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdzdG9yZS5kaXNhYmxlZCcpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAxLCAic3RvcmluZyBkaXNhYmxlZCIpOwoJCQl9IGVsc2UgaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCB0aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0sIElkOlske3RoaXMuSWR9XWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkxvY2F0aW9uIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKHRoaXMuX2ZpbGVOYW1lKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IFthd2FpdCB0aGlzLl9naXRodWIodGhpcy5fZmlsZU5hbWUoKSldOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQuZmlsdGVyKHIgPT4gcikubWFwKHIgPT4gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKCmlmKHR5cGVvZihtb2R1bGUpIT09InVuZGVmaW5lZCIpIG1vZHVsZS5leHBvcnRzLnNhbGVzbm93ID0gc2FsZXNub3c7CgooYXN5bmMgKCkgPT4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc2VydmVyKHtpbml0Tm9kZTogdHJ1ZSwgaW5pdFNlbGY6IHRydWUsIGxvYWRUb29sczogdHJ1ZX0pKSgpOw==",
	"active": true,
	"enabled": true,
	"code": "apiserver",
	"date": "2023-08-16T04:59:32.434Z",
	"name": "API Server"
}